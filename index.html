<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tati Manicure - Gerenciamento de Agendamentos</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #ff6b8b; /* Rosa mais feminino */
            --secondary-color: #ba68c8; /* Roxo suave */
            --background-color: #fce4ec; /* Rosa claro de fundo */
            --sidebar-bg: #ffffff;
            --sidebar-hover-bg: #f8bbd9; /* Rosa mais claro para hover */
            --text-color: #4a148c; /* Roxo escuro para texto */
            --success-color: #66bb6a; /* Verde suave */
            --info-color: #4fc3f7; /* Azul claro */
            --danger-color: #ef5350; /* Vermelho suave */
            --warning-color: #ffb74d; /* Laranja suave */
            --border-color: #f48fb1; /* Rosa para bordas */
            --shadow-color: rgba(255, 107, 139, 0.1); /* Sombra rosa */
        }

        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #fce4ec 0%, #f8bbd9 100%); /* Gradiente feminino */
            color: var(--text-color);
            display: flex;
            min-height: 100vh;
        }

        /* Estrutura do App */
        #login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            background: linear-gradient(135deg, #ff6b8b 0%, #ba68c8 100%); /* Gradiente rosa-roxo */
            min-height: 100vh;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><path fill="%23ffffff" opacity="0.1" d="M30,30 Q50,10 70,30 T90,50 Q70,90 50,70 T10,50 Q30,10 50,30 Z M40,40 Q50,35 60,40 T70,50 Q60,65 50,60 T30,50 Q40,35 50,40 Z"/></svg>');
            background-size: 150px;
        }

        .login-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(255, 107, 139, 0.3);
            text-align: center;
            width: 100%;
            max-width: 400px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .login-card h1 {
            color: var(--primary-color);
            margin-bottom: 30px;
            font-size: 1.8rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .login-icon {
            font-size: 80px;
            color: var(--primary-color);
            margin-bottom: 20px;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        #app-container {
            display: none;
            width: 100%;
            flex-direction: row;
        }

        /* Barra Lateral (Sidebar) */
        .sidebar {
            width: 250px;
            background: linear-gradient(180deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            box-shadow: 4px 0 15px var(--shadow-color);
            display: flex;
            flex-direction: column;
            padding: 20px 0;
            flex-shrink: 0;
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
            color: white;
            font-size: 1.6rem;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
            padding: 0 20px;
        }

        .sidebar ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar ul li a {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            text-decoration: none;
            color: white;
            transition: all 0.3s ease;
            font-weight: 500;
            border-left: 4px solid transparent;
        }

        .sidebar ul li a:hover,
        .sidebar ul li a.active {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border-left-color: white;
            transform: translateX(5px);
        }

        .sidebar ul li a .material-icons {
            margin-right: 10px;
            font-size: 20px;
        }

        .user-info {
            margin-top: auto;
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.3);
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .user-info p {
            margin: 0 0 10px 0;
            font-weight: bold;
            color: white;
        }

        /* Conteúdo Principal */
        .main-content {
            flex-grow: 1;
            padding: 30px;
            overflow-y: auto;
            background: var(--background-color);
        }

        .content-section {
            display: none;
            padding: 20px;
        }

        .content-section.active {
            display: block;
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }

        .section-header h2 {
            margin: 0;
            color: var(--text-color);
            font-size: 1.5rem;
        }
        
        /* Novas cores para Status de Pacote e Histórico */
        .status-package-paid {
             color: var(--success-color);
             font-weight: bold;
        }
        .status-package-pending {
            color: var(--warning-color);
            font-weight: bold;
        }
        .status-package-active {
            color: var(--primary-color);
            font-weight: bold;
        }
        .status-package-finalized {
            color: var(--danger-color);
            font-weight: bold;
        }

        /* Cartão (Card) */
        .card {
            background: rgba(255, 255, 255, 0.9);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px var(--shadow-color);
            margin-bottom: 20px;
            border: 1px solid rgba(255, 107, 139, 0.1);
            backdrop-filter: blur(10px);
        }
        
        /* NOVO V6: Abas dentro de uma seção */
        .tab-menu {
             display: flex;
             border-bottom: 3px solid var(--border-color);
             margin-bottom: 20px;
             border-radius: 10px 10px 0 0;
             overflow: hidden;
        }
        .tab-menu button {
             padding: 12px 20px;
             border: none;
             background: rgba(255, 255, 255, 0.7);
             cursor: pointer;
             font-size: 1rem;
             color: var(--secondary-color);
             border-bottom: 3px solid transparent;
             transition: all 0.3s ease;
             font-weight: bold;
             flex: 1;
        }
        .tab-menu button.active {
             color: var(--primary-color);
             border-bottom: 3px solid var(--primary-color);
             background: white;
        }
        .tab-menu button:hover {
             background: rgba(255, 255, 255, 0.9);
             color: var(--primary-color);
        }
        .tab-content {
             padding-top: 10px;
        }
        .tab-pane {
             display: none;
        }
        .tab-pane.active {
             display: block;
             animation: fadeIn 0.5s ease-in;
        }

        /* Formulários */
        .form-group {
            margin-bottom: 15px;
        }

        .form-row {
            display: flex;
            gap: 20px;
        }

        .form-row > div {
            flex: 1;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--text-color);
        }

        input[type="text"],
        input[type="number"],
        input[type="email"],
        input[type="tel"],
        input[type="date"],
        input[type="time"],
        textarea,
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.8);
        }

        /* Datalist input */
        input[list] {
            background-image: none;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="email"]:focus,
        input[type="tel"]:focus,
        input[type="date"]:focus,
        input[type="time"]:focus,
        textarea:focus,
        select:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(255, 107, 139, 0.2);
            background: white;
        }

        textarea {
            resize: vertical;
        }

        /* Botões */
        button, .btn {
            padding: 12px 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(255, 107, 139, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color) 0%, #4caf50 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(102, 187, 106, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary-color) 0%, #7b1fa2 100%);
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(186, 104, 200, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color) 0%, #d32f2f 100%);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(239, 83, 80, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color) 0%, #f57c00 100%);
            color: white;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(255, 183, 77, 0.4);
        }

        .btn-info {
            background: linear-gradient(135deg, var(--info-color) 0%, #0288d1 100%);
            color: white;
        }

        .btn-info:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(79, 195, 247, 0.4);
        }

        /* Tabelas */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 3px 10px var(--shadow-color);
        }

        .data-table thead tr {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            text-align: left;
        }

        .data-table th, .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table tbody tr:hover {
            background: rgba(255, 107, 139, 0.05);
            transform: scale(1.01);
            transition: all 0.2s ease;
        }

        .data-table td.action-buttons button {
            margin-right: 5px;
            padding: 6px 8px;
        }

        .data-table td.action-buttons {
            white-space: nowrap;
        }

        /* Notificação */
        #notification-bar {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            transform: translateY(-20px);
            z-index: 1000;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            font-weight: bold;
            backdrop-filter: blur(10px);
        }

        #notification-bar.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        #notification-bar.success { 
            background: linear-gradient(135deg, var(--success-color) 0%, #4caf50 100%); 
        }
        #notification-bar.error { 
            background: linear-gradient(135deg, var(--danger-color) 0%, #d32f2f 100%); 
        }
        #notification-bar.info { 
            background: linear-gradient(135deg, var(--info-color) 0%, #0288d1 100%); 
        }

        /* Utilitários */
        .flex-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .input-group {
            display: flex;
            gap: 10px;
        }
        
        .input-group input, .input-group select {
            flex-grow: 1;
        }

        .filter-row {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            margin-bottom: 20px;
        }
        .filter-row > div {
            flex: 1;
        }
        .filter-row button {
            flex-grow: 0;
            flex-shrink: 0;
            padding: 11px 15px;
        }
        
        /* NOVO V6: Estilos para a Tabela de Visão Diária */
        #tabela-visao-diaria {
             border: 2px solid var(--border-color);
             margin-top: 0;
             border-radius: 10px;
        }
        #tabela-visao-diaria thead tr {
             background: linear-gradient(135deg, var(--secondary-color) 0%, #7b1fa2 100%);
        }
        #tabela-visao-diaria td {
             height: 40px;
             font-size: 0.9rem;
             vertical-align: top;
        }
        .horario-celula {
             width: 80px;
             font-weight: bold;
             background: rgba(255, 107, 139, 0.1);
             color: var(--text-color);
             text-align: center;
             vertical-align: middle !important;
             border-right: 2px solid var(--border-color);
        }
        .agendamento-vago {
             background: rgba(102, 187, 106, 0.1);
             color: var(--success-color);
             font-weight: bold;
             font-style: italic;
             text-align: center;
             line-height: 40px;
        }
        .agendamento-vencido {
             background: rgba(239, 83, 80, 0.1);
             color: var(--danger-color);
             font-weight: bold;
             font-style: italic;
             text-align: center;
             line-height: 40px;
        }
        .agendamento-ocupado {
             background: rgba(255, 107, 139, 0.05);
             color: var(--text-color);
             font-weight: 500;
             padding: 5px 10px !important;
             vertical-align: middle !important;
             line-height: 1.2;
             border-left: 5px solid var(--primary-color);
             cursor: pointer;
        }
        .agendamento-ocupado strong {
             color: var(--primary-color);
             font-weight: bold;
        }
        
        /* Modal para usar pacote */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 2px solid var(--border-color);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }
        
        .modal-header h3 {
            margin: 0;
            color: var(--primary-color);
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--secondary-color);
            transition: all 0.3s ease;
        }
        
        .close-modal:hover {
            color: var(--primary-color);
            transform: scale(1.1);
        }
        
        /* --------------------------------------------------- */
        /* RESPONSIVIDADE MOBILE - MELHORIAS PARA VISÃO DIÁRIA */
        /* --------------------------------------------------- */
        @media (max-width: 768px) {
            
            /* Estrutura Principal */
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
                box-shadow: 0 0 10px var(--shadow-color);
            }

            .main-content {
                padding: 15px;
            }

            #app-container {
                flex-direction: column;
            }

            /* Navegação Horizontal */
            .sidebar ul {
                display: flex;
                flex-wrap: nowrap;
                overflow-x: auto;
                justify-content: flex-start;
                border-bottom: 2px solid rgba(255, 255, 255, 0.3);
            }

            .sidebar ul li {
                flex-shrink: 0;
                text-align: center;
            }

            .sidebar ul li a {
                justify-content: center;
                padding: 10px;
                flex-direction: column;
                font-size: 0.75rem;
                white-space: nowrap;
                border-left: none;
                border-bottom: 3px solid transparent;
            }

            .sidebar ul li a:hover,
            .sidebar ul li a.active {
                border-left: none;
                border-bottom: 3px solid white;
                transform: translateY(-2px);
            }

            .sidebar ul li a .material-icons {
                margin-right: 0;
                margin-bottom: 5px;
                font-size: 20px;
            }

            /* FIX: Botão Sair visível no celular */
            .user-info {
                display: block;
                padding: 10px 15px;
                border-top: none; 
                text-align: center; 
            }

            .user-info p {
                display: none;
            }

            .user-info button {
                width: 100%;
                margin-top: 10px; 
                font-size: 0.9rem;
            }
            
            /* 1. Correção de Formulários e Filtros (Empilhamento) */
            .form-row, .filter-row {
                flex-direction: column;
                gap: 0;
            }

            .form-row > div, 
            .filter-row > div {
                flex: 0 0 100% !important;
                width: 100%;
            }
            
            /* Ajusta margem para inputs empilhados */
            .form-group, .filter-row > div {
                margin-bottom: 10px;
            }
            
            .filter-row button {
                width: 100%;
                margin-top: 5px; 
                padding: 12px 15px !important;
            }
            
            /* MELHORIA: Visão Diária em Mobile */
            .table-responsive {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            #tabela-visao-diaria {
                width: 100%;
                min-width: 350px;
                font-size: 0.85rem;
            }
            
            #tabela-visao-diaria td {
                padding: 8px 5px !important;
                height: 35px;
                word-wrap: break-word;
                overflow: hidden;
            }
            
            .horario-celula {
                width: 60px;
                font-size: 0.8rem;
                padding: 5px !important;
            }
            
            .agendamento-ocupado {
                font-size: 0.8rem;
                line-height: 1.1;
                padding: 3px 5px !important;
                border-left: 3px solid var(--primary-color);
            }
            
            .agendamento-ocupado strong {
                font-size: 0.85rem;
            }
            
            .agendamento-vago,
            .agendamento-vencido {
                font-size: 0.8rem;
                line-height: 35px;
                padding: 0 5px;
            }
            
            /* Garantir que o conteúdo não ultrapasse os limites */
            #tabela-visao-diaria td:not(.horario-celula) {
                max-width: 200px;
                white-space: normal;
            }

            /* 2. Correção de Tabelas (Cartão-like View) */
            .data-table, .data-table tbody, .data-table td, .data-table tr {
                display: block;
            }

            .data-table thead {
                display: none;
            }

            .data-table tr {
                border: 2px solid var(--border-color);
                margin-bottom: 15px;
                border-radius: 10px;
                box-shadow: 0 2px 8px var(--shadow-color);
                padding: 10px;
            }

            .data-table td {
                border: none;
                position: relative;
                padding-left: 50% !important;
                text-align: right;
                white-space: normal;
                min-height: 40px;
            }

            /* Rótulo customizado (que usa o data-label do JS) */
            .data-table td::before {
                content: attr(data-label);
                position: absolute;
                left: 10px;
                width: 45%; 
                padding-right: 10px;
                white-space: nowrap;
                text-align: left;
                font-weight: bold;
                color: var(--primary-color);
            }
            
            /* FIX V6: Organização dos botões de ação em mobile */
            .data-table td.action-buttons {
                text-align: left;
                padding-left: 10px !important;
                display: flex; 
                flex-direction: column;
                gap: 5px;
            }
            
            .data-table td.action-buttons::before {
                content: ""; /* MELHORIA 1: Removido "Ações" */
                width: 100%; 
                margin-bottom: 5px;
                display: block;
            }
            
            .data-table td.action-buttons button {
                margin: 0;
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
                font-size: 0.9rem; 
                padding: 8px 5px;
            }
            
            /* Modal em mobile */
            .modal-content {
                width: 95%;
                padding: 15px;
            }
        }
    
/* ===== AJUSTES MÍNIMOS APLICADOS: manter todas as lógicas originais ===== */
/* 1) Forçar empilhamento dos botões da aba Agenda em mobile (retrato) */
@media (max-width: 768px) {
  .tab-menu {
    flex-direction: column !important;
    align-items: stretch !important;
    gap: 8px !important;
  }
  .tab-menu button, .tab-menu .tab-button {
    display: block !important;
    width: 100% !important;
    margin: 6px 0 !important;
    box-sizing: border-box !important;
  }
  /* remover transformações que podem esconder botões em mobile */
  .tab-menu button.active { transform: none !important; }
}

/* 2) Garantir que os botões de Ações não se sobreponham (desktop e mobile) */
.data-table td.action-buttons {
  display: flex !important;
  gap: 8px !important;
  align-items: center !important;
  justify-content: flex-end !important;
  flex-wrap: wrap !important;
  position: relative !important;
  z-index: 2 !important;
}
@media (max-width: 768px) {
  .data-table td.action-buttons {
    flex-direction: column !important;
    align-items: stretch !important;
    justify-content: flex-start !important;
  }
  .data-table td.action-buttons button {
    width: 100% !important;
    box-sizing: border-box !important;
  }
}
/* ===== FIM AJUSTES ===== */

/* MELHORIA 2: Estilização do valor do lucro */
.lucro-valor {
    font-size: 1.3rem;
    font-weight: bold;
    text-align: center;
    color: var(--success-color);
    padding: 10px 0;
}
</style>
</head>
<body>

    <div id="notification-bar"></div>

    <!-- Modal para usar pacote -->
    <div id="modal-usar-pacote" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Agendar Uso de Pacote</h3>
                <button class="close-modal">&times;</button>
            </div>
            <form id="form-usar-pacote">
                <input type="hidden" id="modal-pacote-id">
                <input type="hidden" id="modal-pacote-servico-id">
                <input type="hidden" id="modal-pacote-cliente-id">
                
                <div class="form-group">
                    <label for="modal-pacote-data">Data</label>
                    <input type="date" id="modal-pacote-data" required>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="modal-pacote-hora">Hora Início</label>
                        <input type="time" id="modal-pacote-hora" required>
                    </div>
                    <div class="form-group">
                        <label for="modal-pacote-hora-fim">Hora Fim</label>
                        <input type="time" id="modal-pacote-hora-fim" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="modal-pacote-procedimento">Procedimento Realizado</label>
                    <select id="modal-pacote-procedimento" required>
                        <option value="">Selecione o procedimento</option>
                        <option value="Pés" data-quantidade="1">Pés (1 procedimento)</option>
                        <option value="Mãos" data-quantidade="1">Mãos (1 procedimento)</option>
                        <option value="Pés e Mãos" data-quantidade="2">Pés e Mãos (2 procedimentos)</option>
                        <option value="Outro" data-quantidade="1">Outro (1 procedimento)</option>
                    </select>
                </div>
                
                <div class="form-group" id="group-outro-procedimento" style="display: none;">
                    <label for="modal-pacote-outro">Descreva o procedimento</label>
                    <input type="text" id="modal-pacote-outro" placeholder="Digite o procedimento realizado">
                </div>
                
                <div class="form-group">
                    <label for="modal-pacote-observacoes">Observações Adicionais</label>
                    <textarea id="modal-pacote-observacoes" rows="2" placeholder="Observações sobre o serviço..."></textarea>
                </div>
                
                <div class="flex-container">
                    <button type="submit" class="btn-success">
                        <span class="material-icons">check_circle</span> Confirmar Uso
                    </button>
                    <button type="button" class="btn-secondary" id="cancelar-usar-pacote">
                        <span class="material-icons">cancel</span> Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- NOVO: Modal para limpeza de dados -->
    <div id="modal-limpeza-dados" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Limpeza de Dados</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="form-group">
                <p><strong>Atenção:</strong> Esta ação não pode ser desfeita!</p>
                <label>
                    <input type="checkbox" id="confirmar-limpeza"> Confirmo que deseja prosseguir com a limpeza
                </label>
            </div>
            <div class="flex-container">
                <button type="button" class="btn-danger" id="btn-limpar-historico" disabled>
                    <span class="material-icons">delete_forever</span> Limpar Apenas Histórico
                </button>
                <button type="button" class="btn-danger" id="btn-limpar-tudo" disabled>
                    <span class="material-icons">delete_sweep</span> Limpar Tudo (exceto Clientes/Serviços)
                </button>
                <button type="button" class="btn-secondary" id="cancelar-limpeza">
                    <span class="material-icons">cancel</span> Cancelar
                </button>
            </div>
        </div>
    </div>

    <div id="login-container">
        <div class="login-card">
            <!-- MELHORIA 3: Ícone mais temático de manicure -->
            <div class="login-icon">
                <span class="material-icons">spa</span>
            </div>
            <h1>Tati Manicure - Acesso</h1>
            <form id="login-form">
                <div class="form-group">
                    <label for="loginSenha">Senha de Acesso</label>
                    <input type="password" id="loginSenha" required>
                </div>
                <button type="submit" class="btn-primary" style="width: 100%; margin-top: 10px;">
                    <span class="material-icons">login</span> Entrar
                </button>
            </form>
        </div>
    </div>

    <datalist id="clientes-datalist"></datalist>

    <div id="app-container">
        
        <aside class="sidebar">
            <div class="logo">TATI MANICURE APP</div>
            
            <ul>
                <li><a href="#" data-section="agenda" class="active"><span class="material-icons">calendar_today</span> Agenda</a></li>
                <li><a href="#" data-section="clientes"><span class="material-icons">people</span> Clientes</a></li>
                <li><a href="#" data-section="servicos"><span class="material-icons">local_offer</span> Serviços</a></li>
                <li><a href="#" data-section="historico"><span class="material-icons">history</span> Histórico/Lucros</a></li>
            </ul>

            <div class="user-info">
                <p id="userInfo">Olá, Tati!</p>
                <button id="logout-button" class="btn-danger" style="width: 100%;">
                    <span class="material-icons">logout</span> Sair
                </button>
            </div>
        </aside>

        <main class="main-content">

            <div id="agenda-section" class="content-section active">
                
                <div class="tab-menu">
                     <button class="tab-button active" onclick="showAgendaTab('pacotes-ativos', event)">Pacotes Ativos</button>
                     <button class="tab-button" onclick="showAgendaTab('novo-agendamento', event)">Novo Agendamento</button>
                     <button class="tab-button" onclick="showAgendaTab('lista-agendamentos', event)">Lista Agendamentos</button>
                     <button class="tab-button" onclick="showAgendaTab('visao-diaria', event)">Visão Diária</button>
                </div>
                
                <div class="tab-content">
                    
                    <div id="pacotes-ativos-pane" class="tab-pane active">
                         <div class="section-header"><h2>Gerenciamento de Pacotes Ativos</h2></div>
                         <div class="card">
                            <form id="pacote-inicio-form">
                                <h3>Iniciar Novo Pacote de Serviços</h3>
                                <div class="form-row">
                                    <div class="form-group" style="flex: 2;">
                                        <label for="pacote-cliente-id">Cliente</label>
                                        <select id="pacote-cliente-id" required></select>
                                    </div>
                                    <div class="form-group" style="flex: 2;">
                                        <label for="pacote-servico-id">Pacote (Serviços marcados como Pacote)</label>
                                        <select id="pacote-servico-id" required></select>
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label for="pacote-data-inicio">Data Início (Geralmente Hoje)</label>
                                        <input type="date" id="pacote-data-inicio" required>
                                    </div>
                                </div>

                                <div class="flex-container">
                                    <button type="submit" class="btn-primary">
                                        <span class="material-icons">add_box</span> Iniciar/Vender Pacote
                                    </button>
                                </div>
                            </form>
                            
                            <hr style="margin: 20px 0; border-color: var(--border-color);">

                            <h3>Pacotes Ativos e Utilização</h3>
                            <div style="max-height: 500px; overflow-y: auto;">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 20%;">Cliente</th>
                                            <th style="width: 25%;">Pacote (Total/Usado)</th>
                                            <th style="width: 15%;">Pagamento</th>
                                            <th style="width: 15%;">Vencimento</th>
                                            <th style="width: 200px;">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="lista-pacotes-ativos">
                                        <tr><td colspan="5" style="text-align: center;">Carregando pacotes ativos...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div id="novo-agendamento-pane" class="tab-pane">
                        <div class="section-header"><h2>Agendamento de Serviços Individuais (Não-Pacote)</h2></div>
                         <div class="card">
                            <form id="agendamento-form">
                                <input type="hidden" id="agendamento-id">
                                
                                <div class="form-row">
                                    <div class="form-group" style="flex: 2;">
                                        <label for="agenda-cliente-id">Cliente</label>
                                        <select id="agenda-cliente-id" required></select>
                                    </div>
                                    <div class="form-group" style="flex: 2;">
                                        <label for="agenda-servico-id">Serviço Individual/Promoção</label>
                                        <select id="agenda-servico-id" required></select>
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label for="agenda-data">Data</label>
                                        <input type="date" id="agenda-data" required>
                                    </div>
                                </div>

                                <div class="form-row">
                                     <div class="form-group" style="flex: 1;">
                                        <label for="agenda-hora">Hora Início</label>
                                        <input type="time" id="agenda-hora" required>
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label for="agenda-hora-fim">Hora Fim</label>
                                        <input type="time" id="agenda-hora-fim" required>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="agenda-observacoes">Observações</label>
                                    <textarea id="agenda-observacoes" rows="2"></textarea>
                                </div>

                                <div class="flex-container">
                                    <div>
                                        <!-- CORREÇÃO 1: Botões aparecendo corretamente -->
                                        <button type="submit" class="btn-success" id="btn-salvar-agendamento">
                                            <span class="material-icons">save</span> Salvar Agendamento
                                        </button>
                                        <button type="button" class="btn-secondary" onclick="resetAgendamentoForm()">
                                            <span class="material-icons">refresh</span> Limpar
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div id="lista-agendamentos-pane" class="tab-pane">
                         <div class="section-header">
                             <h3>Próximos Agendamentos Individuais (Ativos)</h3>
                         </div>
                         <div class="card">
                            <div class="filter-row">
                                <div style="flex-grow: 1.5;">
                                    <label for="filtro-agenda-data">Filtrar por Data</label>
                                    <input type="date" id="filtro-agenda-data" onchange="carregarAgendamentos()">
                                </div>
                                <div style="flex-grow: 3;">
                                    <label for="filtro-agenda-cliente">Filtrar por Cliente (Digite ou Selecione)</label>
                                    <input type="text" id="filtro-agenda-cliente" list="clientes-datalist" placeholder="Digite o nome do cliente..." onkeyup="filtrarAgendamentos()">
                                </div>
                                <button class="btn-secondary" onclick="resetFiltroAgenda()"><span class="material-icons">refresh</span> Resetar Filtro</button>
                            </div>

                            <div style="max-height: 500px; overflow-y: auto;">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 15%;">Data/Hora</th>
                                            <th style="width: 25%;">Cliente</th>
                                            <th style="width: 25%;">Serviço</th>
                                            <th>Status</th>
                                            <th style="width: 150px;">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="lista-agendamentos">
                                        <tr><td colspan="5" style="text-align: center;">Carregando agendamentos...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div id="visao-diaria-pane" class="tab-pane">
                        <div class="section-header">
                            <h2>Visão Diária da Agenda</h2>
                        </div>
                        <div class="card">
                            <div class="filter-row">
                                <div style="flex-grow: 1;">
                                    <label for="filtro-visao-diaria-data">Selecione a Data</label>
                                    <input type="date" id="filtro-visao-diaria-data" onchange="renderizarVisaoDiaria()">
                                </div>
                                <button class="btn-secondary" onclick="renderizarVisaoDiaria(true)"><span class="material-icons">today</span> Ver Hoje</button>
                            </div>

                            <div class="table-responsive">
                                <table class="data-table" id="tabela-visao-diaria">
                                    <thead>
                                        <tr>
                                            <th style="width: 100px;">Horário</th>
                                            <th>Detalhes do Agendamento</th>
                                        </tr>
                                    </thead>
                                    <tbody id="lista-visao-diaria">
                                        <tr><td colspan="2" style="text-align: center;">Selecione uma data para visualizar.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <div id="clientes-section" class="content-section">
                <div class="section-header"><h2>Cadastro de Clientes</h2></div>
                <div class="card">
                    <form id="cliente-form">
                        <input type="hidden" id="cliente-id">
                        <div class="form-row">
                            <div class="form-group" style="flex: 2;">
                                <label for="cliente-nome">Nome Completo</label>
                                <input type="text" id="cliente-nome" required>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label for="cliente-telefone">Telefone (Whatsapp)</label>
                                <input type="tel" id="cliente-telefone">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="cliente-email">E-mail (Opcional)</label>
                            <input type="email" id="cliente-email">
                        </div>
                        <div class="form-group">
                            <label for="cliente-endereco">Endereço (Opcional)</label>
                            <input type="text" id="cliente-endereco">
                        </div>
                        <div class="form-group">
                            <label for="cliente-observacoes">Observações (Alergias, Preferências)</label>
                            <textarea id="cliente-observacoes" rows="2"></textarea>
                        </div>
                        <div class="flex-container">
                            <div>
                                <button type="submit" class="btn-success" id="btn-salvar-cliente">
                                    <span class="material-icons">save</span> Salvar Cliente
                                </button>
                                <button type="button" class="btn-secondary" onclick="resetClienteForm()">
                                    <span class="material-icons">refresh</span> Limpar
                                </button>
                            </div>
                        </div>
                    </form>
                </div>

                <div class="section-header">
                    <h3>Lista de Clientes Cadastrados</h3>
                    <div class="input-group" style="width: 300px;">
                        <input type="text" id="filtro-clientes" list="clientes-datalist" placeholder="Filtrar por nome, tel ou endereço..." onkeyup="filtrarClientes()">
                    </div>
                </div>
                <div class="card">
                    <div style="max-height: 500px; overflow-y: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th style="width: 30%;">Nome</th>
                                    <th style="width: 20%;">Telefone</th>
                                    <th style="width: 30%;">Endereço</th>
                                    <th style="width: 150px;">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="lista-clientes">
                                <tr><td colspan="4" style="text-align: center;">Carregando clientes...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="servicos-section" class="content-section">
                <div class="section-header"><h2>Cadastro de Serviços/Pacotes</h2></div>
                <div class="card">
                    <form id="servico-form">
                        <input type="hidden" id="servico-id">
                        <div class="form-row">
                            <div class="form-group" style="flex: 2;">
                                <label for="servico-nome">Nome do Serviço</label>
                                <input type="text" id="servico-nome" required>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label for="servico-preco">Preço (R$)</label>
                                <input type="number" id="servico-preco" step="0.01" min="0" required value="0.00">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <label>
                                    <input type="checkbox" id="servico-isPacote"> É um **Pacote Mensal**?
                                </label>
                            </div>
                            <div class="form-group" id="group-quantidade-total" style="flex: 1; display: none;">
                                <label for="servico-quantidade-total">Total de Procedimentos no Pacote (ex: 6)</label>
                                <input type="number" id="servico-quantidade-total" min="1" value="1">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="servico-descricao">Descrição Detalhada (ex: 4 Mãos e 2 Pés)</label>
                            <textarea id="servico-descricao" rows="2"></textarea>
                        </div>
                        <div class="flex-container">
                            <div>
                                <button type="submit" class="btn-success" id="btn-salvar-servico">
                                    <span class="material-icons">save</span> Salvar Serviço
                                </button>
                                <button type="button" class="btn-secondary" onclick="resetServicoForm()">
                                    <span class="material-icons">refresh</span> Limpar
                                </button>
                            </div>
                        </div>
                    </form>
                </div>

                <div class="section-header">
                    <h3>Lista de Serviços e Preços</h3>
                </div>
                <div class="card">
                    <div style="max-height: 500px; overflow-y: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th style="width: 40%;">Serviço</th>
                                    <th style="width: 15%;">Tipo</th>
                                    <th style="width: 15%;">Total Proc.</th>
                                    <th style="width: 15%;">Preço</th>
                                    <th style="width: 150px;">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="lista-servicos">
                                <tr><td colspan="5" style="text-align: center;">Carregando serviços...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="historico-section" class="content-section">
                <div class="section-header">
                    <h2>Histórico de Agendamentos e Lucros Mensais</h2>
                    <!-- NOVO: Botão para limpeza de dados -->
                    <button class="btn-danger" onclick="abrirModalLimpeza()">
                        <span class="material-icons">delete_sweep</span> Limpeza de Dados
                    </button>
                </div>
                
                <div class="card" style="margin-bottom: 30px;">
                    <!-- MELHORIA 2: Título dinâmico corrigido -->
                    <h3 id="titulo-resumo-lucros">Resumo de Lucros</h3>
                    <table class="data-table" id="tabela-lucros-mensais">
                        <thead>
                            <tr>
                                <th style="width: 25%;">Mês/Ano</th>
                                <th style="width: 25%;">Total Agendamentos</th>
                                <th style="width: 25%;">Lucro Total (R$)</th>
                                <th style="width: 25%;">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="lista-lucros-mensais">
                            <tr><td colspan="4" style="text-align: center;">Carregando resumo financeiro...</td></tr>
                        </tbody>
                    </table>
                </div>

                <div class="section-header">
                    <h3>Histórico Completo</h3>
                </div>
                <div class="card">
                    <div class="filter-row">
                        <div style="flex-grow: 1;">
                            <label for="filtro-historico-mes">Filtrar por Mês</label>
                            <input type="month" id="filtro-historico-mes" onchange="renderizarHistorico()">
                        </div>
                        <div style="flex-grow: 2;">
                            <label for="filtro-historico-cliente">Filtrar Cliente</label>
                            <input type="text" id="filtro-historico-cliente" list="clientes-datalist" placeholder="Digite o nome do cliente..." onkeyup="filtrarHistoricoTabela()">
                        </div>
                        <button class="btn-secondary" onclick="resetFiltroHistorico()"><span class="material-icons">refresh</span> Resetar Filtro</button>
                    </div>
                    <div style="max-height: 500px; overflow-y: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th style="width: 15%;">Data/Hora</th>
                                    <th style="width: 25%;">Cliente</th>
                                    <th style="width: 25%;">Serviço</th>
                                    <th style="width: 10%;">Valor (R$)</th>
                                    <th style="width: 150px;">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="lista-historico">
                                <tr><td colspan="5" style="text-align: center;">Carregando histórico...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
        import { getDatabase, ref, onValue, push, set, update, remove, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

        // =================================================================
        // 1.1. CONFIGURAÇÃO FIREBASE E VARIÁVEIS GLOBAIS
        // =================================================================

        // Sua configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBatp6e1NzevurpB2yS8eGErgSYC_t2-Nc",
            authDomain: "tati-manicure.firebaseapp.com",
            databaseURL: "https://tati-manicure-default-rtdb.firebaseio.com",
            projectId: "tati-manicure",
            storageBucket: "tati-manicure.firebaseapp.com",
            messagingSenderId: "1061777323027",
            appId: "1:1061777323027:web:7b54e5fdbb7f06ee293be6",
            measurementId: "G-V3J5ZJ5XBT"
        };

        // Inicialização do Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Referências aos nós (listas/tabelas) do seu banco de dados
        const clientesRef = ref(db, 'clientes');
        const servicosRef = ref(db, 'servicos');
        const agendamentosRef = ref(db, 'agendamentos');
        const pacotesAtivosRef = ref(db, 'pacotes_ativos');
        
        const SENHA_UNICA = "tati123";

        // Caches de Dados
        let cacheClientes = {};
        let cacheServicos = {};
        let cachePacotes = {};
        let cacheAgendamentos = {};
        let agendamentosAtivos = [];
        let agendamentosHistorico = [];
        let pacotesAtivosList = [];
        let clientesDataList = [];

        // =================================================================
        // 1.2. FUNÇÕES DE UTILIDADE E UI GERAL
        // =================================================================

        // Função auxiliar para converter o snapshot do RTDB em um array de objetos
        function snapshotToArray(snapshot) {
            const arr = [];
            snapshot.forEach(childSnapshot => {
                const item = childSnapshot.val();
                item.id = childSnapshot.key;
                arr.push(item);
            });
            return arr;
        }

        // Função para formatar data e hora
        function formatarDataHora(dataHoraString) {
            const d = new Date(dataHoraString);
            return d.toLocaleDateString('pt-BR') + ' ' + d.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        }
        
        function formatarData(dataString) {
            const d = new Date(dataString);
            return d.toLocaleDateString('pt-BR');
        }

        // Função para formatar moeda
        function formatarMoeda(valor) {
            return parseFloat(valor).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        // Função para exibir notificações
        window.showNotification = function(message, type = 'info') {
            const bar = document.getElementById('notification-bar');
            bar.textContent = message;
            bar.className = `show ${type}`;
            setTimeout(() => {
                bar.className = '';
            }, 3000);
        }

        // Função para mudar a seção principal
        window.showSection = function(sectionId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
            
            // Atualiza o menu lateral
            document.querySelectorAll('.sidebar ul li a').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('data-section') === sectionId.replace('-section', '')) {
                    link.classList.add('active');
                }
            });

            // Lógica de carregamento específica por seção
            if (sectionId === 'agenda-section') {
                // Apenas garante que a aba ativa está carregando os dados corretos
                 const activePane = document.querySelector('#agenda-section .tab-pane.active');
                 if (activePane.id === 'lista-agendamentos-pane') carregarAgendamentos();
                 else if (activePane.id === 'pacotes-ativos-pane') carregarPacotesAtivos();
                 else if (activePane.id === 'visao-diaria-pane') renderizarVisaoDiaria();

            } else if (sectionId === 'historico-section') {
                renderizarHistorico();
            } else if (sectionId === 'clientes-section') {
                renderizarClientes();
            } else if (sectionId === 'servicos-section') {
                renderizarServicos();
            }
        }
        
        // Função para mudar a aba na seção Agenda
        window.showAgendaTab = function(paneId, event) {
            document.querySelectorAll('#agenda-section .tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });
            document.getElementById(paneId + '-pane').classList.add('active');

            document.querySelectorAll('#agenda-section .tab-button').forEach(button => {
                button.classList.remove('active');
            });
            if (event) {
                event.currentTarget.classList.add('active');
            } else {
                 // Caso seja chamado programaticamente
                 document.querySelector(`.tab-button[onclick*='${paneId}']`).classList.add('active');
            }
            

            if (paneId === 'lista-agendamentos' || paneId === 'novo-agendamento') {
                carregarAgendamentos(); // Garante que a lista de agendamentos esteja carregada
            } else if (paneId === 'visao-diaria') {
                document.getElementById('filtro-visao-diaria-data').value = new Date().toISOString().slice(0, 10);
                renderizarVisaoDiaria();
            } else if (paneId === 'pacotes-ativos') {
                carregarPacotesAtivos();
            }
        }

        // Lógica de Login - CORRIGIDA
        function showLogin() {
            document.getElementById('app-container').style.display = 'none';
            document.getElementById('login-container').style.display = 'flex';
        }
        
        function showApp() {
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('app-container').style.display = 'flex';
            // Carrega os dados iniciais do app
            showSection('agenda-section');
        }
        
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const senha = document.getElementById('loginSenha').value;
            
            if (senha === SENHA_UNICA) {
                 showApp();
                 showNotification('Login realizado com sucesso!', 'success');
            } else {
                 showNotification('Senha incorreta. Tente novamente.', 'error');
            }
        });
        
        document.getElementById('logout-button').addEventListener('click', () => {
            showLogin();
            showNotification('Sessão encerrada.', 'info');
        });

        // =================================================================
        // 2. FUNÇÕES DE CARREGAMENTO DE DADOS (RTDB LISTENER)
        // =================================================================
        
        // 2.1. Clientes
        function carregarClientes() {
            onValue(clientesRef, (snapshot) => {
                const clientes = snapshotToArray(snapshot);
                cacheClientes = {};
                clientesDataList = [];

                clientes.forEach(c => {
                    cacheClientes[c.id] = c;
                    clientesDataList.push({ id: c.id, nome: c.nome, telefone: c.telefone, endereco: c.endereco });
                });

                renderizarClientes();
                renderizarClienteDatalist();
                popularSelectClientes();
            }, { onlyOnce: false });
        }

        // 2.2. Serviços
        function carregarServicos() {
             onValue(servicosRef, (snapshot) => {
                const servicos = snapshotToArray(snapshot);
                cacheServicos = {};
                servicos.forEach(s => cacheServicos[s.id] = s);

                renderizarServicos();
                popularSelectServicos();
                popularSelectPacotes();
            }, { onlyOnce: false });
        }

        // 2.3. Pacotes Ativos
        function carregarPacotesAtivos() {
            onValue(pacotesAtivosRef, (snapshot) => {
                pacotesAtivosList = snapshotToArray(snapshot);
                pacotesAtivosList.sort((a, b) => new Date(a.dataVencimento) - new Date(b.dataVencimento));
                renderizarPacotesAtivos();
            }, { onlyOnce: false });
        }

        // 2.4. Agendamentos
        function carregarAgendamentos() {
            onValue(agendamentosRef, (snapshot) => {
                const allAgendamentos = snapshotToArray(snapshot);
                
                agendamentosAtivos = allAgendamentos.filter(a => a.status === 'ativo');
                agendamentosHistorico = allAgendamentos.filter(a => a.status !== 'ativo');
                
                // Salva todos em cache (usado principalmente para a reversão)
                cacheAgendamentos = {};
                allAgendamentos.forEach(a => cacheAgendamentos[a.id] = a);

                agendamentosAtivos.sort((a, b) => new Date(a.data) - new Date(b.data) || a.hora.localeCompare(b.hora));
                agendamentosHistorico.sort((a, b) => new Date(b.data) - new Date(a.data) || b.hora.localeCompare(a.hora));
                
                renderizarListaAgendamentos();
                // A visão diária e o histórico dependem destes dados, forçamos a atualização se a seção estiver ativa:
                if (document.getElementById('visao-diaria-pane').classList.contains('active')) renderizarVisaoDiaria(); 
                if (document.getElementById('historico-section').classList.contains('active')) renderizarHistorico();
            }, { onlyOnce: false });
        }
        
        // =================================================================
        // 3. FUNÇÕES CRUD: CLIENTES E SERVIÇOS
        // =================================================================
        
        // 3.1. Clientes
        document.getElementById('cliente-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('cliente-id').value;
            const cliente = {
                nome: document.getElementById('cliente-nome').value,
                telefone: document.getElementById('cliente-telefone').value || '',
                email: document.getElementById('cliente-email').value || '',
                endereco: document.getElementById('cliente-endereco').value || '',
                observacoes: document.getElementById('cliente-observacoes').value || ''
            };

            try {
                if (id) {
                    // Atualizar
                    await update(ref(db, 'clientes/' + id), cliente);
                    showNotification('Cliente atualizado com sucesso!', 'success');
                } else {
                    // Novo
                    await push(clientesRef, cliente);
                    showNotification('Cliente salvo com sucesso!', 'success');
                }
                resetClienteForm();
            } catch (error) {
                console.error("Erro ao salvar cliente:", error);
                showNotification('Erro ao salvar cliente: ' + error.message, 'error');
            }
        });

        window.editarCliente = function(id) {
            const cliente = cacheClientes[id];
            if (!cliente) return;
            document.getElementById('cliente-id').value = id;
            document.getElementById('cliente-nome').value = cliente.nome;
            document.getElementById('cliente-telefone').value = cliente.telefone;
            document.getElementById('cliente-email').value = cliente.email;
            document.getElementById('cliente-endereco').value = cliente.endereco;
            document.getElementById('cliente-observacoes').value = cliente.observacoes;
            document.getElementById('btn-salvar-cliente').innerHTML = '<span class="material-icons">edit</span> Atualizar Cliente';
            showNotification(`Editando cliente: ${cliente.nome}`, 'info');
        }

        window.excluirCliente = async function(id) {
            if (confirm('Tem certeza que deseja excluir este cliente e todos os agendamentos/pacotes associados? (Não se preocupe, o Firebase cuidará das dependências)')) {
                try {
                    // Nota: A exclusão em cascata deve ser feita no Firebase, aqui só removemos o registro do cliente.
                    await remove(ref(db, 'clientes/' + id));
                    showNotification('Cliente excluído com sucesso!', 'success');
                } catch (error) {
                    console.error("Erro ao excluir cliente:", error);
                    showNotification('Erro ao excluir cliente: ' + error.message, 'error');
                }
            }
        }

        window.resetClienteForm = function() {
            document.getElementById('cliente-form').reset();
            document.getElementById('cliente-id').value = '';
            document.getElementById('btn-salvar-cliente').innerHTML = '<span class="material-icons">save</span> Salvar Cliente';
        }

        // 3.2. Serviços
        // Lógica de Pacote: Mostra campo de quantidade se for pacote
        document.getElementById('servico-isPacote').addEventListener('change', (e) => {
            document.getElementById('group-quantidade-total').style.display = e.target.checked ? 'block' : 'none';
        });

        document.getElementById('servico-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('servico-id').value;
            const isPacote = document.getElementById('servico-isPacote').checked;

            const servico = {
                nome: document.getElementById('servico-nome').value,
                preco: parseFloat(document.getElementById('servico-preco').value),
                isPacote: isPacote,
                quantidadeTotal: isPacote ? parseInt(document.getElementById('servico-quantidade-total').value) : 1,
                descricao: document.getElementById('servico-descricao').value || ''
            };

            try {
                if (id) {
                    await update(ref(db, 'servicos/' + id), servico);
                    showNotification('Serviço/Pacote atualizado com sucesso!', 'success');
                } else {
                    await push(servicosRef, servico);
                    showNotification('Serviço/Pacote salvo com sucesso!', 'success');
                }
                resetServicoForm();
            } catch (error) {
                console.error("Erro ao salvar serviço:", error);
                showNotification('Erro ao salvar serviço: ' + error.message, 'error');
            }
        });

        window.editarServico = function(id) {
            const servico = cacheServicos[id];
            if (!servico) return;
            document.getElementById('servico-id').value = id;
            document.getElementById('servico-nome').value = servico.nome;
            document.getElementById('servico-preco').value = servico.preco;
            document.getElementById('servico-descricao').value = servico.descricao;
            document.getElementById('servico-isPacote').checked = servico.isPacote;
            
            // Lógica condicional para Pacote
            document.getElementById('group-quantidade-total').style.display = servico.isPacote ? 'block' : 'none';
            document.getElementById('servico-quantidade-total').value = servico.quantidadeTotal || 1;

            document.getElementById('btn-salvar-servico').innerHTML = '<span class="material-icons">edit</span> Atualizar Serviço';
            showNotification(`Editando serviço: ${servico.nome}`, 'info');
        }

        window.excluirServico = async function(id) {
            if (confirm('Tem certeza que deseja excluir este serviço/pacote?')) {
                try {
                    await remove(ref(db, 'servicos/' + id));
                    showNotification('Serviço/Pacote excluído com sucesso!', 'success');
                } catch (error) {
                    console.error("Erro ao excluir serviço:", error);
                    showNotification('Erro ao excluir serviço: ' + error.message, 'error');
                }
            }
        }

        window.resetServicoForm = function() {
            document.getElementById('servico-form').reset();
            document.getElementById('servico-id').value = '';
            document.getElementById('group-quantidade-total').style.display = 'none';
            document.getElementById('servico-quantidade-total').value = 1;
            document.getElementById('btn-salvar-servico').innerHTML = '<span class="material-icons">save</span> Salvar Serviço';
        }

        // =================================================================
        // 4. FUNÇÕES CRUD: PACOTES E AGENDAMENTOS
        // =================================================================

        // 4.1. Iniciar Pacote
        document.getElementById('pacote-inicio-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const clienteId = document.getElementById('pacote-cliente-id').value;
            const servicoId = document.getElementById('pacote-servico-id').value;
            const dataInicio = document.getElementById('pacote-data-inicio').value;
            
            const cliente = cacheClientes[clienteId];
            const servico = cacheServicos[servicoId];

            if (!cliente || !servico || !servico.isPacote) {
                showNotification('Dados inválidos ou serviço não é um pacote.', 'error');
                return;
            }
            
            // Adiciona 1 mês à data de início para o vencimento
            const dataVencimentoDate = new Date(dataInicio);
            dataVencimentoDate.setMonth(dataVencimentoDate.getMonth() + 1);

            const novoPacote = {
                clienteId: clienteId,
                clienteNome: cliente.nome,
                servicoId: servicoId,
                servicoNome: servico.nome,
                quantidadeTotal: servico.quantidadeTotal,
                quantidadeUsada: 0,
                dataInicio: dataInicio,
                dataVencimento: dataVencimentoDate.toISOString().slice(0, 10), 
                status: 'ativo',
                statusPagamento: 'pendente',
                valorTotal: servico.preco
            };

            try {
                await push(pacotesAtivosRef, novoPacote);
                showNotification(`Pacote ${servico.nome} iniciado para ${cliente.nome}!`, 'success');
                document.getElementById('pacote-inicio-form').reset();
                
                // Restaurar data atual
                document.getElementById('pacote-data-inicio').value = new Date().toISOString().slice(0, 10);
            } catch (error) {
                console.error("Erro ao iniciar pacote:", error);
                showNotification('Erro ao iniciar pacote: ' + error.message, 'error');
            }
        });

        // 4.2. Modal para usar pacote - CORREÇÃO 3: Horários em branco
        window.abrirModalUsarPacote = function(pacoteId, servicoId, clienteId) {
            document.getElementById('modal-pacote-id').value = pacoteId;
            document.getElementById('modal-pacote-servico-id').value = servicoId;
            document.getElementById('modal-pacote-cliente-id').value = clienteId;
            
            // CORREÇÃO 3: Horários em branco em vez de fixos
            const hoje = new Date().toISOString().slice(0, 10);
            document.getElementById('modal-pacote-data').value = hoje;
            document.getElementById('modal-pacote-hora').value = '';
            document.getElementById('modal-pacote-hora-fim').value = '';
            
            // Resetar campos
            document.getElementById('modal-pacote-procedimento').value = '';
            document.getElementById('modal-pacote-outro').value = '';
            document.getElementById('group-outro-procedimento').style.display = 'none';
            document.getElementById('modal-pacote-observacoes').value = '';
            
            // Mostrar modal
            document.getElementById('modal-usar-pacote').style.display = 'flex';
        }

        window.fecharModalUsarPacote = function() {
            document.getElementById('modal-usar-pacote').style.display = 'none';
            document.getElementById('form-usar-pacote').reset();
            document.getElementById('group-outro-procedimento').style.display = 'none';
        }

        // Mostrar campo "Outro" quando selecionado
        document.getElementById('modal-pacote-procedimento').addEventListener('change', function() {
            const groupOutro = document.getElementById('group-outro-procedimento');
            groupOutro.style.display = this.value === 'Outro' ? 'block' : 'none';
        });

        // Fechar modal ao clicar no X
        document.querySelector('.close-modal').addEventListener('click', fecharModalUsarPacote);
        document.getElementById('cancelar-usar-pacote').addEventListener('click', fecharModalUsarPacote);

        // Fechar modal ao clicar fora
        document.getElementById('modal-usar-pacote').addEventListener('click', function(e) {
            if (e.target === this) {
                fecharModalUsarPacote();
            }
        });

        // CORREÇÃO PRINCIPAL: Formulário de usar pacote - AGORA VAI PARA AGENDAMENTOS ATIVOS
        document.getElementById('form-usar-pacote').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const pacoteId = document.getElementById('modal-pacote-id').value;
            const servicoId = document.getElementById('modal-pacote-servico-id').value;
            const clienteId = document.getElementById('modal-pacote-cliente-id').value;
            const procedimento = document.getElementById('modal-pacote-procedimento').value;
            const outroProcedimento = document.getElementById('modal-pacote-outro').value;
            
            // Verificar conflito de horário para pacotes também
            const dataPacote = document.getElementById('modal-pacote-data').value;
            const horaInicioPacote = document.getElementById('modal-pacote-hora').value;
            const horaFimPacote = document.getElementById('modal-pacote-hora-fim').value;

            const conflitoPacote = verificarConflitoHorarioPacote(dataPacote, horaInicioPacote, horaFimPacote);
            if (conflitoPacote) {
                showNotification('Horário já reservado! Por favor, escolha outro horário.', 'error');
                return;
            }
            
            const pacote = pacotesAtivosList.find(p => p.id === pacoteId);
            const servico = cacheServicos[servicoId];
            const cliente = cacheClientes[clienteId];

            if (!pacote || !servico || !cliente) {
                showNotification('Dados do pacote não encontrados.', 'error');
                return;
            }

            if (pacote.quantidadeUsada >= pacote.quantidadeTotal) {
                showNotification('Este pacote já atingiu o limite de uso.', 'error');
                return;
            }

            if (!procedimento) {
                showNotification('Selecione o procedimento realizado.', 'error');
                return;
            }

            // Calcular quantidade a debitar
            const procedimentoSelect = document.getElementById('modal-pacote-procedimento');
            const selectedOption = procedimentoSelect.options[procedimentoSelect.selectedIndex];
            const quantidadeDebitar = parseInt(selectedOption.getAttribute('data-quantidade'));

            // Verificar se há procedimentos suficientes
            if (pacote.quantidadeUsada + quantidadeDebitar > pacote.quantidadeTotal) {
                showNotification(`Pacote não tem procedimentos suficientes. Restam ${pacote.quantidadeTotal - pacote.quantidadeUsada} procedimentos.`, 'error');
                return;
            }

            // Descrição do procedimento
            let descricaoProcedimento = procedimento;
            if (procedimento === 'Outro' && outroProcedimento) {
                descricaoProcedimento = outroProcedimento;
            }

            // CORREÇÃO: Agora cria agendamento com status "ativo" (não finalizado)
            const novoAgendamento = {
                clienteId: clienteId,
                clienteNome: cliente.nome,
                servicoId: servicoId,
                servicoNome: servico.nome,
                data: document.getElementById('modal-pacote-data').value,
                hora: document.getElementById('modal-pacote-hora').value,
                horaFim: document.getElementById('modal-pacote-hora-fim').value,
                observacoes: `Uso do Pacote: ${pacote.servicoNome} - ${descricaoProcedimento} (Debitado ${quantidadeDebitar} procedimento(s)) - ${document.getElementById('modal-pacote-observacoes').value || ''}`,
                valor: 0.00, // Valor é 0, pois já foi pago no pacote
                status: 'ativo', // CORREÇÃO: Agora fica ATIVO (não finalizado)
                tipo: 'pacote',
                pacoteId: pacoteId,
                procedimentoRealizado: descricaoProcedimento,
                quantidadeDebitada: quantidadeDebitar
            };
            
            // CORREÇÃO: Atualiza o uso do pacote imediatamente
            const novoUso = pacote.quantidadeUsada + quantidadeDebitar;

            try {
                // CORREÇÃO: Adiciona o agendamento nos ATIVOS (não no histórico)
                await push(agendamentosRef, novoAgendamento); 

                // CORREÇÃO: Atualiza o pacote imediatamente
                await update(ref(db, 'pacotes_ativos/' + pacoteId), {
                    quantidadeUsada: novoUso
                    // Status do pacote só muda quando finalizado na lista de agendamentos
                });

                showNotification(`Uso de Pacote agendado para ${cliente.nome}! Debitado ${quantidadeDebitar} procedimento(s). Agora aparecerá na lista de agendamentos ativos.`, 'success');
                fecharModalUsarPacote();
                
                // CORREÇÃO: Leva para a aba de agendamentos ativos
                showAgendaTab('lista-agendamentos');
            } catch (error) {
                console.error("Erro ao usar pacote:", error);
                showNotification('Erro ao registrar uso de pacote: ' + error.message, 'error');
            }
        });

        // 4.3. CORREÇÃO FINAL: Marcar Pacote como Pago - PACOTE SÓ FINALIZA QUANDO PAGO E PROCEDIMENTOS ESGOTADOS
        window.marcarPacotePago = async function(pacoteId) {
            if (confirm('Marcar este pacote como PAGO?')) {
                try {
                    const pacote = pacotesAtivosList.find(p => p.id === pacoteId);
                    
                    if (!pacote) {
                        showNotification('Pacote não encontrado.', 'error');
                        return;
                    }

                    // ATUALIZAÇÃO: Só marca como finalizado se os procedimentos estiverem esgotados
                    const novoStatus = pacote.quantidadeUsada >= pacote.quantidadeTotal ? 'finalizado' : 'ativo';

                    // 1. Atualizar status de pagamento do pacote e status se necessário
                    await update(ref(db, 'pacotes_ativos/' + pacoteId), {
                        statusPagamento: 'pago',
                        status: novoStatus
                    });

                    // 2. Registrar no histórico com o valor total do pacote
                    const historicoItem = {
                        clienteId: pacote.clienteId,
                        clienteNome: pacote.clienteNome,
                        servicoId: pacote.servicoId,
                        servicoNome: pacote.servicoNome,
                        data: pacote.dataInicio, // Data de início do pacote
                        hora: '00:00', // Hora padrão para pacotes
                        horaFim: '00:00',
                        valor: pacote.valorTotal,
                        status: 'pago',
                        tipo: 'pacote_pagamento',
                        pacoteId: pacoteId,
                        observacoes: `Pagamento do pacote ${pacote.servicoNome} - ${pacote.quantidadeUsada}/${pacote.quantidadeTotal} procedimentos utilizados`
                    };

                    await push(agendamentosRef, historicoItem);

                    showNotification('Pacote marcado como PAGO e registrado no histórico!', 'success');
                    
                } catch (error) {
                    console.error("Erro ao marcar pacote como pago:", error);
                    showNotification('Erro ao marcar pacote como pago: ' + error.message, 'error');
                }
            }
        }
        
        // 4.4. Salvar Agendamento (Individual) - COM VERIFICAÇÃO DE CONFLITO DE HORÁRIO
        document.getElementById('agendamento-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('agendamento-id').value;
            const clienteId = document.getElementById('agenda-cliente-id').value;
            const servicoId = document.getElementById('agenda-servico-id').value;
            const data = document.getElementById('agenda-data').value;
            const horaInicio = document.getElementById('agenda-hora').value;
            const horaFim = document.getElementById('agenda-hora-fim').value;
            
            const cliente = cacheClientes[clienteId];
            const servico = cacheServicos[servicoId];
            
            if (!cliente || !servico || servico.isPacote) {
                showNotification('Selecione um cliente e um serviço VÁLIDO (não-pacote).', 'error');
                return;
            }

            // Verificar conflito de horário para serviços individuais
            if (!id) { // Só verifica conflito para novos agendamentos
                const conflito = verificarConflitoHorario(data, horaInicio, horaFim);
                if (conflito) {
                    showNotification('Horário já reservado! Por favor, escolha outro horário.', 'error');
                    return;
                }
            }

            const agendamento = {
                clienteId: clienteId,
                clienteNome: cliente.nome,
                servicoId: servicoId,
                servicoNome: servico.nome,
                data: data,
                hora: horaInicio,
                horaFim: horaFim,
                observacoes: document.getElementById('agenda-observacoes').value || '',
                valor: servico.preco,
                status: 'ativo', // Novo agendamento é sempre ativo
                tipo: 'individual'
            };

            try {
                if (id) {
                    await update(ref(db, 'agendamentos/' + id), agendamento);
                    showNotification('Agendamento atualizado com sucesso!', 'success');
                } else {
                    await push(agendamentosRef, agendamento);
                    showNotification('Agendamento salvo com sucesso!', 'success');
                }
                resetAgendamentoForm();
            } catch (error) {
                console.error("Erro ao salvar agendamento:", error);
                showNotification('Erro ao salvar agendamento: ' + error.message, 'error');
            }
        });

        window.editarAgendamento = function(id) {
            const agendamento = agendamentosAtivos.find(a => a.id === id);
            if (!agendamento) return;
            
            document.getElementById('agendamento-id').value = id;
            document.getElementById('agenda-cliente-id').value = agendamento.clienteId;
            document.getElementById('agenda-servico-id').value = agendamento.servicoId;
            document.getElementById('agenda-data').value = agendamento.data;
            document.getElementById('agenda-hora').value = agendamento.hora;
            document.getElementById('agenda-hora-fim').value = agendamento.horaFim;
            document.getElementById('agenda-observacoes').value = agendamento.observacoes;
            
            document.getElementById('btn-salvar-agendamento').innerHTML = '<span class="material-icons">edit</span> Atualizar Agendamento';
            showAgendaTab('novo-agendamento'); // Leva para a aba de edição
            showNotification(`Editando agendamento para: ${agendamento.clienteNome}`, 'info');
        }
        
        // NOVO: Função auxiliar para verificar conflitos de horário
        function verificarConflitoHorario(data, horaInicio, horaFim, idExcluir = null) {
            return agendamentosAtivos.some(a => 
                a.data === data && 
                a.id !== idExcluir && // Não verifica o próprio agendamento em edição
                ((horaInicio >= a.hora && horaInicio < a.horaFim) ||
                 (horaFim > a.hora && horaFim <= a.horaFim) ||
                 (horaInicio <= a.hora && horaFim >= a.horaFim))
            );
        }

        // NOVO: Função para verificar conflito também para pacotes
        function verificarConflitoHorarioPacote(data, horaInicio, horaFim) {
            // Busca em TODOS os agendamentos (ativos e históricos de pacotes/finalizados do dia)
            const todosAgendamentosDoDia = [
                ...agendamentosAtivos.filter(a => a.data === data),
                ...agendamentosHistorico.filter(a => a.data === data && (a.tipo === 'pacote' || a.status === 'finalizado'))
            ];
            
            return todosAgendamentosDoDia.some(a => 
                ((horaInicio >= a.hora && horaInicio < a.horaFim) ||
                 (horaFim > a.hora && horaFim <= a.horaFim) ||
                 (horaInicio <= a.hora && horaFim >= a.horaFim))
            );
        }
        
        // CORREÇÃO: Finalizar Agendamento - AGORA FUNCIONA TANTO PARA INDIVIDUAIS QUANTO PARA PACOTES
        window.finalizarAgendamento = async function(id) {
            const agendamento = agendamentosAtivos.find(a => a.id === id);
            if (!agendamento) return;

            if (confirm(`Finalizar agendamento para ${agendamento.clienteNome} (${agendamento.servicoNome})?`)) {
                try {
                    // CORREÇÃO: Para pacotes, também finaliza o pacote se todos os procedimentos foram usados
                    if (agendamento.tipo === 'pacote' && agendamento.pacoteId) {
                        const pacote = pacotesAtivosList.find(p => p.id === agendamento.pacoteId);
                        if (pacote && pacote.quantidadeUsada >= pacote.quantidadeTotal && pacote.statusPagamento === 'pago') {
                            await update(ref(db, 'pacotes_ativos/' + agendamento.pacoteId), {
                                status: 'finalizado'
                            });
                        }
                    }

                    // Muda o status para 'finalizado' - vai para o histórico
                    await update(ref(db, 'agendamentos/' + id), {
                        status: 'finalizado'
                    });
                    
                    showNotification('Agendamento finalizado! Agora aparece no histórico.', 'success');
                } catch (error) {
                    showNotification('Erro ao finalizar agendamento: ' + error.message, 'error');
                }
            }
        }

        // MELHORIA 1: Cancelamento de Pacotes na Visão Diária e Histórico
        window.cancelarAgendamento = async function(id) {
            const agendamento = agendamentosAtivos.find(a => a.id === id);
            if (!agendamento) return;

            if (confirm(`Cancelar agendamento para ${agendamento.clienteNome} (${agendamento.servicoNome})?`)) {
                try {
                    await update(ref(db, 'agendamentos/' + id), {
                        status: 'cancelado' // Manda para o histórico
                    });
                    
                    // NOVO: Se for um pacote, também remove da Visão Diária imediatamente
                    if (agendamento.tipo === 'pacote') {
                        // Força atualização da Visão Diária
                        if (document.getElementById('visao-diaria-pane').classList.contains('active')) {
                            renderizarVisaoDiaria();
                        }
                    }
                    
                    showNotification('Agendamento cancelado e enviado para Histórico!', 'info');
                } catch (error) {
                    showNotification('Erro ao cancelar agendamento: ' + error.message, 'error');
                }
            }
        }
        
        window.resetAgendamentoForm = function() {
             document.getElementById('agendamento-form').reset();
             document.getElementById('agendamento-id').value = '';
             document.getElementById('btn-salvar-agendamento').innerHTML = '<span class="material-icons">save</span> Salvar Agendamento';
             
             // Restaurar data e hora padrão
             const hoje = new Date().toISOString().slice(0, 10);
             document.getElementById('agenda-data').value = hoje;
             document.getElementById('agenda-hora').value = '09:00';
             document.getElementById('agenda-hora-fim').value = '10:00';
        }

        // =================================================================
        // 5. FUNÇÕES DE RENDERIZAÇÃO
        // =================================================================

        // 5.1. RENDERIZAR DROPDOWNS
        function popularSelectClientes() {
            const selects = [
                document.getElementById('pacote-cliente-id'), 
                document.getElementById('agenda-cliente-id')
            ];

            selects.forEach(select => {
                const selectedValue = select.value;
                select.innerHTML = '<option value="">Selecione um Cliente</option>';
                clientesDataList.forEach(c => {
                    const option = document.createElement('option');
                    option.value = c.id;
                    option.textContent = c.nome;
                    select.appendChild(option);
                });
                select.value = selectedValue; // Tenta manter a seleção
            });
        }
        
        function popularSelectServicos() {
             const select = document.getElementById('agenda-servico-id');
             const selectedValue = select.value;
             select.innerHTML = '<option value="">Selecione um Serviço</option>';
             Object.values(cacheServicos).filter(s => !s.isPacote).forEach(s => {
                 const option = document.createElement('option');
                 option.value = s.id;
                 option.textContent = `${s.nome} (${formatarMoeda(s.preco)})`;
                 select.appendChild(option);
             });
             select.value = selectedValue;
        }
        
        function popularSelectPacotes() {
             const select = document.getElementById('pacote-servico-id');
             const selectedValue = select.value;
             select.innerHTML = '<option value="">Selecione um Pacote</option>';
             Object.values(cacheServicos).filter(s => s.isPacote).forEach(s => {
                 const option = document.createElement('option');
                 option.value = s.id;
                 option.textContent = `${s.nome} (${s.quantidadeTotal}x - ${formatarMoeda(s.preco)})`;
                 select.appendChild(option);
             });
             select.value = selectedValue;
        }

        function renderizarClienteDatalist() {
            const datalist = document.getElementById('clientes-datalist');
            datalist.innerHTML = '';
            clientesDataList.forEach(c => {
                const option = document.createElement('option');
                option.value = c.nome;
                datalist.appendChild(option);
            });
        }

        // 5.2. RENDERIZAR CLIENTES (Tabela) - CORREÇÃO 2: Ações não cobrindo botão Editar
        function renderizarClientes() {
            const tabela = document.getElementById('lista-clientes');
            const filtro = document.getElementById('filtro-clientes').value.toLowerCase();
            tabela.innerHTML = '';
            
            const clientesFiltrados = clientesDataList.filter(c => 
                c.nome.toLowerCase().includes(filtro) || 
                c.telefone.includes(filtro) || 
                (c.endereco && c.endereco.toLowerCase().includes(filtro))
            );

            if (clientesFiltrados.length === 0) {
                 tabela.innerHTML = '<tr><td colspan="4" style="text-align: center;">Nenhum cliente encontrado.</td></tr>';
                 return;
            }

            clientesFiltrados.forEach(c => {
                const clienteCompleto = cacheClientes[c.id];
                const row = tabela.insertRow();
                row.dataset.clienteId = c.id; 
                row.dataset.clienteNome = c.nome.toLowerCase(); 

                // Nome
                let nomeCell = row.insertCell();
                nomeCell.textContent = c.nome;
                nomeCell.setAttribute('data-label', 'Nome');

                // Telefone
                let telCell = row.insertCell();
                telCell.textContent = c.telefone;
                telCell.setAttribute('data-label', 'Telefone');

                // Endereço (em vez de Email)
                let enderecoCell = row.insertCell();
                enderecoCell.textContent = clienteCompleto.endereco || '';
                enderecoCell.setAttribute('data-label', 'Endereço');

                // Ações - CORREÇÃO 2: Melhor organização dos botões
                let actionCell = row.insertCell();
                actionCell.classList.add('action-buttons');
                actionCell.setAttribute('data-label', ''); // MELHORIA 1: Removido "Ações"
                actionCell.innerHTML = `
                    <button class="btn-warning" onclick="editarCliente('${c.id}')"><span class="material-icons">edit</span> Editar</button>
                    <button class="btn-danger" onclick="excluirCliente('${c.id}')"><span class="material-icons">delete</span> Excluir</button>
                `;
            });
        }
        
        window.filtrarClientes = function() {
            renderizarClientes();
        }

        // 5.3. RENDERIZAR SERVIÇOS (Tabela) - MANTIDO IGUAL
        function renderizarServicos() {
            const tabela = document.getElementById('lista-servicos');
            tabela.innerHTML = '';
            const servicos = Object.values(cacheServicos).sort((a, b) => a.nome.localeCompare(b.nome));

            if (servicos.length === 0) {
                 tabela.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nenhum serviço cadastrado.</td></tr>';
                 return;
            }
            
            servicos.forEach(s => {
                const row = tabela.insertRow();

                // Serviço
                let nomeCell = row.insertCell();
                nomeCell.textContent = s.nome;
                nomeCell.setAttribute('data-label', 'Serviço');

                // Tipo
                let tipoCell = row.insertCell();
                tipoCell.textContent = s.isPacote ? 'Pacote' : 'Individual';
                tipoCell.setAttribute('data-label', 'Tipo');

                // Total Proc.
                let qtdCell = row.insertCell();
                qtdCell.textContent = s.isPacote ? `${s.quantidadeTotal}x` : '-';
                qtdCell.setAttribute('data-label', 'Total Proc.');

                // Preço
                let precoCell = row.insertCell();
                precoCell.textContent = formatarMoeda(s.preco);
                precoCell.setAttribute('data-label', 'Preço');

                // Ações
                let actionCell = row.insertCell();
                actionCell.classList.add('action-buttons');
                actionCell.setAttribute('data-label', ''); // MELHORIA 1: Removido "Ações"
                actionCell.innerHTML = `
                    <button class="btn-warning" onclick="editarServico('${s.id}')"><span class="material-icons">edit</span> Editar</button>
                    <button class="btn-danger" onclick="excluirServico('${s.id}')"><span class="material-icons">delete</span> Excluir</button>
                `;
            });
        }

        // 5.4. RENDERIZAR PACOTES ATIVOS (Tabela) - CORREÇÃO: MOSTRAR TODOS OS PACOTES ATIVOS (NÃO SÓ OS NÃO PAGOS)
        function renderizarPacotesAtivos() {
            const tabela = document.getElementById('lista-pacotes-ativos');
            tabela.innerHTML = '';

            // CORREÇÃO: Mostrar TODOS os pacotes que não estão finalizados (ativos independente do pagamento)
            const pacotesAtivos = pacotesAtivosList.filter(p => p.status === 'ativo');
            
            if (pacotesAtivos.length === 0) {
                 tabela.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nenhum pacote ativo.</td></tr>';
                 return;
            }

            pacotesAtivos.forEach(p => {
                const row = tabela.insertRow();
                
                // Cliente
                let clienteCell = row.insertCell();
                clienteCell.textContent = p.clienteNome;
                clienteCell.setAttribute('data-label', 'Cliente');

                // Pacote (Total/Usado)
                let pacoteCell = row.insertCell();
                pacoteCell.textContent = `${p.servicoNome} (${p.quantidadeUsada}/${p.quantidadeTotal})`;
                pacoteCell.setAttribute('data-label', 'Pacote');

                // Pagamento
                let pagamentoCell = row.insertCell();
                const statusPagamento = p.statusPagamento === 'pago' ? 
                    `<span class="status-package-paid">PAGO (${formatarMoeda(p.valorTotal)})</span>` : 
                    `<span class="status-package-pending">PENDENTE (${formatarMoeda(p.valorTotal)})</span>`;
                pagamentoCell.innerHTML = statusPagamento;
                pagamentoCell.setAttribute('data-label', 'Pagamento');

                // Vencimento
                let vencimentoCell = row.insertCell();
                const dataVencimento = new Date(p.dataVencimento);
                const hoje = new Date();
                let statusVencimento = formatarData(p.dataVencimento);
                if (dataVencimento < hoje) {
                     statusVencimento = `<span class="status-package-finalized">VENCIDO (${statusVencimento})</span>`;
                } else {
                     statusVencimento = `<span class="status-package-active">Ativo até (${statusVencimento})</span>`;
                }
                vencimentoCell.innerHTML = statusVencimento;
                vencimentoCell.setAttribute('data-label', 'Vencimento');

                // Ações
                let actionCell = row.insertCell();
                actionCell.classList.add('action-buttons');
                actionCell.setAttribute('data-label', ''); // MELHORIA 1: Removido "Ações"
                
                let actionButtons = '';
                
                // Botão Usar Pacote - só aparece se ainda houver procedimentos disponíveis
                if (p.quantidadeUsada < p.quantidadeTotal) {
                     actionButtons += `<button class="btn-primary" onclick="abrirModalUsarPacote('${p.id}', '${p.servicoId}', '${p.clienteId}')">
                         <span class="material-icons">event_available</span> Usar Pacote
                     </button>`;
                } else {
                     actionButtons += `<button class="btn-secondary" disabled><span class="material-icons">event_busy</span> Esgotado</button>`;
                }
                
                // Botão Marcar Pago - só aparece se não estiver pago
                if (p.statusPagamento !== 'pago') {
                     actionButtons += `<button class="btn-success" onclick="marcarPacotePago('${p.id}')">
                         <span class="material-icons">payments</span> Marcar Pago
                     </button>`;
                }

                actionCell.innerHTML = actionButtons;
            });
        }
        
        // 5.5. RENDERIZAR LISTA DE AGENDAMENTOS (Tabela) - CORREÇÃO: MOSTRAR PACOTES TAMBÉM
        window.carregarAgendamentos = function() {
            renderizarListaAgendamentos();
        }
        
        function renderizarListaAgendamentos() {
            const tabela = document.getElementById('lista-agendamentos');
            const filtroData = document.getElementById('filtro-agenda-data').value;
            const filtroClienteNome = document.getElementById('filtro-agenda-cliente').value.toLowerCase();
            tabela.innerHTML = '';
            
            let agendamentosFiltrados = agendamentosAtivos;
            
            if (filtroData) {
                 agendamentosFiltrados = agendamentosFiltrados.filter(a => a.data === filtroData);
            }
            if (filtroClienteNome) {
                 agendamentosFiltrados = agendamentosFiltrados.filter(a => a.clienteNome.toLowerCase().includes(filtroClienteNome));
            }
            
            if (agendamentosFiltrados.length === 0) {
                 tabela.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nenhum agendamento ativo encontrado.</td></tr>';
                 return;
            }

            agendamentosFiltrados.forEach(a => {
                const row = tabela.insertRow();

                // Data/Hora
                let dataHoraCell = row.insertCell();
                dataHoraCell.textContent = `${formatarData(a.data)} às ${a.hora}`;
                dataHoraCell.setAttribute('data-label', 'Data/Hora');

                // Cliente
                let clienteCell = row.insertCell();
                clienteCell.textContent = a.clienteNome;
                clienteCell.setAttribute('data-label', 'Cliente');

                // Serviço
                let servicoCell = row.insertCell();
                let servicoTexto = a.servicoNome;
                if (a.tipo === 'pacote') {
                    servicoTexto += ' (Pacote)';
                }
                servicoCell.textContent = servicoTexto;
                servicoCell.setAttribute('data-label', 'Serviço');
                
                // Status
                let statusCell = row.insertCell();
                statusCell.textContent = a.status;
                statusCell.setAttribute('data-label', 'Status');

                // Ações
                let actionCell = row.insertCell();
                actionCell.classList.add('action-buttons');
                actionCell.setAttribute('data-label', ''); // MELHORIA 1: Removido "Ações"
                actionCell.innerHTML = `
                    <button class="btn-success" onclick="finalizarAgendamento('${a.id}')"><span class="material-icons">done_all</span> Finalizar</button>
                    <button class="btn-warning" onclick="editarAgendamento('${a.id}')"><span class="material-icons">edit</span> Editar</button>
                    <button class="btn-danger" onclick="cancelarAgendamento('${a.id}')"><span class="material-icons">close</span> Cancelar</button>
                `;
            });
        }
        
        window.filtrarAgendamentos = function() {
            renderizarListaAgendamentos();
        }

        window.resetFiltroAgenda = function() {
            document.getElementById('filtro-agenda-data').value = ''; 
            document.getElementById('filtro-agenda-cliente').value = '';
            renderizarListaAgendamentos();
        }
        
        // 5.6. RENDERIZAR VISÃO DIÁRIA (Tabela de horários) - CORREÇÃO 5: "Vencido" em vez de "Horário Vencido"
        window.renderizarVisaoDiaria = function(today = false) {
            const dataInput = document.getElementById('filtro-visao-diaria-data');
            if (today) {
                dataInput.value = new Date().toISOString().slice(0, 10);
            }
            const dataSelecionada = dataInput.value;
            const tabelaBody = document.getElementById('lista-visao-diaria');
            tabelaBody.innerHTML = '';

            if (!dataSelecionada) {
                 tabelaBody.innerHTML = '<tr><td colspan="2" style="text-align: center;">Selecione uma data para visualizar.</td></tr>';
                 return;
            }

            // Buscar TODOS os agendamentos para a data selecionada (ativos, finalizados e pacotes)
            const agendamentosDoDia = [
                ...agendamentosAtivos.filter(a => a.data === dataSelecionada),
                ...agendamentosHistorico.filter(a => a.data === dataSelecionada && (a.tipo === 'pacote' || a.status === 'finalizado'))
            ];

            // Geração de horários (a cada 30 minutos, das 07:00 às 22:00)
            const horarios = [];
            for (let h = 7; h <= 21; h++) {
                horarios.push(`${String(h).padStart(2, '0')}:00`);
                if (h < 21) horarios.push(`${String(h).padStart(2, '0')}:30`);
            }
            horarios.push('22:00');
            
            const agora = new Date();
            const dataAtual = agora.toISOString().slice(0, 10);
            const horaAtual = agora.toTimeString().slice(0, 5);
            
            horarios.forEach(horario => {
                const row = tabelaBody.insertRow();
                const horarioCell = row.insertCell();
                horarioCell.textContent = horario;
                horarioCell.classList.add('horario-celula');
                
                const detalhesCell = row.insertCell();
                detalhesCell.setAttribute('data-label', 'Agendamento');
                
                const agendamentoNoHorario = agendamentosDoDia.find(a => a.hora <= horario && a.horaFim > horario);

                if (agendamentoNoHorario) {
                    detalhesCell.classList.add('agendamento-ocupado');
                    
                    // Informações específicas para pacotes
                    let infoExtra = '';
                    if (agendamentoNoHorario.tipo === 'pacote') {
                        infoExtra = `<br><em>Procedimento: ${agendamentoNoHorario.procedimentoRealizado || 'Pacote'}</em>`;
                    }
                    
                    const tipoTexto = agendamentoNoHorario.tipo === 'pacote' ? ' (Pacote)' : 
                                    agendamentoNoHorario.status === 'finalizado' ? ' (Finalizado)' : '';
                    
                    detalhesCell.innerHTML = `
                        <strong>${agendamentoNoHorario.clienteNome}</strong>
                        <br>${agendamentoNoHorario.servicoNome}${tipoTexto}
                        <br>${agendamentoNoHorario.hora} - ${agendamentoNoHorario.horaFim}
                        ${infoExtra}
                    `;
                    
                    if (agendamentoNoHorario.status === 'ativo') {
                        detalhesCell.onclick = () => editarAgendamento(agendamentoNoHorario.id);
                    } else {
                        detalhesCell.style.cursor = 'default';
                    }
                } else {
                    // Verificar se é um horário que já passou
                    if (dataSelecionada === dataAtual && horario < horaAtual) {
                        detalhesCell.classList.add('agendamento-vencido');
                        // CORREÇÃO 5: "Vencido" em vez de "Horário Vencido"
                        detalhesCell.textContent = 'Vencido';
                    } else {
                        detalhesCell.classList.add('agendamento-vago');
                        detalhesCell.textContent = 'Livre';
                    }
                }
            });
        }
        
        // 5.7. RENDERIZAR HISTÓRICO E LUCROS - CORREÇÃO PRINCIPAL: Resumo mostra mês selecionado e conta todos os itens
        window.renderizarHistorico = function() {
            // 5.7.1. Lucros Mensais - CORREÇÃO PRINCIPAL: Mostrar mês selecionado e contar todos os itens
            const listaLucrosMensais = document.getElementById('lista-lucros-mensais');
            const filtroMes = document.getElementById('filtro-historico-mes').value;
            listaLucrosMensais.innerHTML = '';

            // MELHORIA 2: Título dinâmico corrigido
            const tituloResumo = document.getElementById('titulo-resumo-lucros');
            if (filtroMes) {
                const mes = new Date(filtroMes + '-01').toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
                tituloResumo.textContent = `Resumo de Lucros - ${mes}`;
            } else {
                tituloResumo.textContent = 'Resumo de Lucros - Todos os Meses';
            }
            
            // CORREÇÃO PRINCIPAL: Calcular lucros considerando o filtro de mês selecionado
            const lucrosPorMes = agendamentosHistorico.reduce((acc, a) => {
                // CORREÇÃO: Incluir pacotes pagos e agendamentos finalizados
                if ((a.status === 'finalizado' && a.tipo === 'individual') || 
                    (a.tipo === 'pacote_pagamento')) {
                    
                    const mesAno = a.data.substring(0, 7);
                    
                    // CORREÇÃO: Aplicar filtro de mês aqui também
                    if (filtroMes && mesAno !== filtroMes) {
                        return acc;
                    }
                    
                    acc[mesAno] = acc[mesAno] || { totalAgendamentos: 0, lucroTotal: 0 };
                    
                    if (a.tipo === 'pacote_pagamento') {
                        acc[mesAno].lucroTotal += a.valor || 0;
                    } else {
                        acc[mesAno].totalAgendamentos++;
                        acc[mesAno].lucroTotal += a.valor || 0;
                    }
                }
                return acc;
            }, {});

            // Aplicar filtro de mês se existir - CORREÇÃO: Já foi aplicado acima
            let mesesParaExibir = Object.keys(lucrosPorMes);
            
            const mesesOrdenados = mesesParaExibir.sort().reverse();
            
            if (mesesOrdenados.length === 0) {
                listaLucrosMensais.innerHTML = '<tr><td colspan="4" style="text-align: center;">Nenhum lucro registrado.</td></tr>';
            } else {
                 mesesOrdenados.forEach(mesAno => {
                     const mes = new Date(mesAno + '-01').toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
                     const lucro = lucrosPorMes[mesAno];
                     const row = listaLucrosMensais.insertRow();
                     row.insertCell().textContent = mes;
                     
                     // CORREÇÃO PRINCIPAL: Contar todos os agendamentos do mês filtrado
                     row.insertCell().textContent = lucro.totalAgendamentos;
                     
                     // MELHORIA 2: Estilização melhorada do valor do lucro
                     let lucroCell = row.insertCell();
                     lucroCell.innerHTML = `<div class="lucro-valor">${formatarMoeda(lucro.lucroTotal)}</div>`;
                     
                     // REMOVIDO: Botão "Ver Detalhes"
                     let acoesCell = row.insertCell();
                     acoesCell.innerHTML = ''; // Vazio
                 });
            }

            // 5.7.2. Histórico Completo - CORREÇÃO: APLICAR FILTRO DE MÊS TAMBÉM AQUI
            const listaHistorico = document.getElementById('lista-historico');
            const filtroCliente = document.getElementById('filtro-historico-cliente').value.toLowerCase();
            listaHistorico.innerHTML = '';

            let historicoFiltrado = agendamentosHistorico;
            
            // Aplicar filtro de mês
            if (filtroMes) {
                 historicoFiltrado = historicoFiltrado.filter(a => a.data.startsWith(filtroMes));
            }
            
            // Aplicar filtro de cliente
            if (filtroCliente) {
                historicoFiltrado = historicoFiltrado.filter(a => a.clienteNome.toLowerCase().includes(filtroCliente));
            }
            
            // CORREÇÃO PRINCIPAL: Contar todos os itens do histórico filtrado para o resumo
            if (filtroMes) {
                const totalItensHistorico = historicoFiltrado.length;
                // Atualizar o total de agendamentos no resumo para o mês selecionado
                const mesResumo = new Date(filtroMes + '-01').toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
                tituloResumo.textContent = `Resumo de Lucros - ${mesResumo}`;
                
                // Se não encontrou dados no cálculo anterior, cria um registro para o mês
                if (mesesOrdenados.length === 0 && totalItensHistorico > 0) {
                    const row = listaLucrosMensais.insertRow();
                    row.insertCell().textContent = mesResumo;
                    row.insertCell().textContent = totalItensHistorico;
                    
                    // Calcular lucro total para este mês
                    const lucroTotalMes = historicoFiltrado.reduce((total, a) => {
                        if ((a.status === 'finalizado' && a.tipo === 'individual') || a.tipo === 'pacote_pagamento') {
                            return total + (a.valor || 0);
                        }
                        return total;
                    }, 0);
                    
                    let lucroCell = row.insertCell();
                    lucroCell.innerHTML = `<div class="lucro-valor">${formatarMoeda(lucroTotalMes)}</div>`;
                    
                    let acoesCell = row.insertCell();
                    acoesCell.innerHTML = '';
                }
            }
            
            if (historicoFiltrado.length === 0) {
                 listaHistorico.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nenhum agendamento no histórico.</td></tr>';
                 return;
            }

            historicoFiltrado.forEach(a => {
                 const row = listaHistorico.insertRow();
                 row.dataset.agendamentoId = a.id; 
                 row.dataset.clienteNome = a.clienteNome.toLowerCase(); 
                 
                 // Data/Hora
                 let dataHoraCell = row.insertCell();
                 dataHoraCell.textContent = `${formatarData(a.data)} às ${a.hora}`;
                 dataHoraCell.setAttribute('data-label', 'Data/Hora');
                 
                 // Cliente
                 let clienteCell = row.insertCell();
                 clienteCell.textContent = a.clienteNome;
                 clienteCell.setAttribute('data-label', 'Cliente');

                 // Serviço
                 let servicoCell = row.insertCell();
                 let servicoTexto = a.servicoNome;
                 if (a.tipo === 'pacote') {
                     servicoTexto += ' (Uso de Pacote)';
                     if (a.procedimentoRealizado) {
                         servicoTexto += ` - ${a.procedimentoRealizado}`;
                     }
                 } else if (a.tipo === 'pacote_pagamento') {
                     servicoTexto += ' (Pagamento de Pacote)';
                 } else if (a.status === 'cancelado') {
                      servicoTexto += ' (Cancelado)';
                 }
                 servicoCell.textContent = servicoTexto;
                 servicoCell.setAttribute('data-label', 'Serviço');

                 // Valor
                 let valorCell = row.insertCell();
                 valorCell.textContent = formatarMoeda(a.valor);
                 valorCell.setAttribute('data-label', 'Valor (R$)');

                 // Ações
                 let actionCell = row.insertCell();
                 actionCell.classList.add('action-buttons');
                 actionCell.setAttribute('data-label', ''); // MELHORIA 1: Removido "Ações"
                 
                 let statusClass = 'btn-secondary';
                 let statusIcon = 'info';

                 if (a.status === 'finalizado' || a.tipo === 'pacote_pagamento') {
                     statusClass = 'btn-success';
                     statusIcon = 'check';
                 } else if (a.status === 'cancelado') {
                      statusClass = 'btn-danger';
                      statusIcon = 'close';
                 }

                 actionCell.innerHTML = `
                     <button class="${statusClass}" disabled><span class="material-icons">${statusIcon}</span> ${a.status.toUpperCase()}</button>
                     <button class="btn-warning" onclick="reverterHistorico('${a.id}')"><span class="material-icons">undo</span> Reverter</button>
                 `;
            });
        }
        
        // REMOVIDO: função aplicarFiltroHistoricoMes (não é mais necessária)
        
        // 6. FUNÇÃO DE REVERSÃO DE HISTÓRICO - MANTIDO IGUAL
        window.reverterHistorico = async function(agendamentoId) {
            const agendamento = cacheAgendamentos[agendamentoId];
            if (!agendamento) {
                showNotification('Agendamento não encontrado para reversão.', 'error');
                return;
            }

            if (confirm(`Tem certeza que deseja reverter o agendamento de ${agendamento.clienteNome} (${agendamento.servicoNome}) para ATIVO? Isso também reverterá o uso do pacote, se for o caso.`)) {
                
                try {
                    // 1. Reverter Status do Agendamento para 'ativo'
                    await update(ref(db, 'agendamentos/' + agendamentoId), {
                        status: 'ativo'
                    });
                    
                    // 2. Se for agendamento de pacote, reverter uso do pacote
                    if (agendamento.tipo === 'pacote' && agendamento.pacoteId) {
                        onValue(ref(db, 'pacotes_ativos/' + agendamento.pacoteId), async (snapshot) => {
                            const pacote = snapshot.val();
                            if (pacote) {
                                const novoUso = Math.max(0, pacote.quantidadeUsada - (agendamento.quantidadeDebitada || 1));
                                await update(ref(db, 'pacotes_ativos/' + agendamento.pacoteId), {
                                    quantidadeUsada: novoUso,
                                    status: 'ativo'
                                });
                            }
                        }, { onlyOnce: true });
                    }

                    showNotification('Agendamento revertido para Ativo!', 'success');
                } catch (error) {
                     console.error("Erro ao reverter agendamento:", error);
                     showNotification('Erro ao reverter: ' + error.message, 'error');
                }
            }
        }
        
        // 6.2. FILTRAR HISTÓRICO NA TABELA - MANTIDO IGUAL
        window.filtrarHistoricoTabela = function() {
             const filtro = document.getElementById('filtro-historico-cliente').value.toLowerCase();
             const listaHistorico = document.getElementById('lista-historico');
             const linhas = listaHistorico.getElementsByTagName('tr');

             for (let i = 0; i < linhas.length; i++) {
                 const row = linhas[i];
                 if (!row.dataset.clienteNome) continue; 
                
                 if (row.dataset.clienteNome.includes(filtro)) {
                     row.style.display = "";
                 } else {
                     row.style.display = "none";
                 }
             }
        }
        
        // 6.3. RESETAR FILTRO DO HISTÓRICO - MANTIDO IGUAL
        window.resetFiltroHistorico = function() {
            document.getElementById('filtro-historico-mes').value = ''; 
            document.getElementById('filtro-historico-cliente').value = '';
            renderizarHistorico();
        }
        
        // =================================================================
        // 7. NOVAS FUNÇÕES: LIMPEZA DE DADOS
        // =================================================================

        // 7.1. Modal de Limpeza de Dados
        window.abrirModalLimpeza = function() {
            document.getElementById('modal-limpeza-dados').style.display = 'flex';
            document.getElementById('confirmar-limpeza').checked = false;
            document.getElementById('btn-limpar-historico').disabled = true;
            document.getElementById('btn-limpar-tudo').disabled = true;
        }

        window.fecharModalLimpeza = function() {
            document.getElementById('modal-limpeza-dados').style.display = 'none';
        }

        // Habilitar botões quando confirmado
        document.getElementById('confirmar-limpeza').addEventListener('change', function() {
            const enabled = this.checked;
            document.getElementById('btn-limpar-historico').disabled = !enabled;
            document.getElementById('btn-limpar-tudo').disabled = !enabled;
        });

        // Fechar modal
        document.querySelectorAll('#modal-limpeza-dados .close-modal, #cancelar-limpeza').forEach(btn => {
            btn.addEventListener('click', fecharModalLimpeza);
        });

        // Fechar modal ao clicar fora
        document.getElementById('modal-limpeza-dados').addEventListener('click', function(e) {
            if (e.target === this) {
                fecharModalLimpeza();
            }
        });

        // 7.2. Limpar Apenas Histórico
        document.getElementById('btn-limpar-historico').addEventListener('click', async function() {
            if (!confirm('Tem certeza que deseja limpar TODO o histórico? Esta ação não pode ser desfeita!')) {
                return;
            }

            try {
                // Buscar todos os agendamentos do histórico
                const historicoRef = query(agendamentosRef, orderByChild('status'));
                const snapshot = await new Promise(resolve => onValue(historicoRef, resolve, { onlyOnce: true }));
                
                const updates = {};
                snapshot.forEach(childSnapshot => {
                    const agendamento = childSnapshot.val();
                    if (agendamento.status !== 'ativo') {
                        updates[childSnapshot.key] = null; // Remove do banco
                    }
                });

                // Executar remoção em lote
                await update(ref(db, 'agendamentos'), updates);
                
                showNotification('Histórico limpo com sucesso!', 'success');
                fecharModalLimpeza();
                
            } catch (error) {
                console.error("Erro ao limpar histórico:", error);
                showNotification('Erro ao limpar histórico: ' + error.message, 'error');
            }
        });

        // 7.3. Limpar Tudo (exceto Clientes e Serviços)
        document.getElementById('btn-limpar-tudo').addEventListener('click', async function() {
            if (!confirm('Tem certeza que deseja limpar TODOS os agendamentos e pacotes? Clientes e serviços serão mantidos. Esta ação não pode ser desfeita!')) {
                return;
            }

            try {
                // Limpar agendamentos
                await remove(agendamentosRef);
                
                // Limpar pacotes ativos
                await remove(pacotesAtivosRef);
                
                showNotification('Todos os dados foram limpos!', 'success');
                fecharModalLimpeza();
                
            } catch (error) {
                console.error("Erro ao limpar dados:", error);
                showNotification('Erro ao limpar dados: ' + error.message, 'error');
            }
        });

        // ----------------------------------------------------------------------------------
        // INICIALIZAÇÃO
        // ----------------------------------------------------------------------------------
        document.addEventListener('DOMContentLoaded', () => {
             // Mostra a tela de login ao carregar a página
            showLogin();
            
            // Inicia os listeners de dados
            carregarClientes();
            carregarServicos();
            carregarAgendamentos(); 
            carregarPacotesAtivos(); 
            
            // Configura a data de hoje para os inputs de data
            const today = new Date().toISOString().slice(0, 10);
            document.getElementById('agenda-data').value = today;
            document.getElementById('pacote-data-inicio').value = today;
            document.getElementById('filtro-visao-diaria-data').value = today;

            // Associa a função showSection aos links da sidebar
            document.querySelectorAll('.sidebar ul li a').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    showSection(this.getAttribute('data-section') + '-section');
                });
            });
            
        });
    </script>

<!-- ===== SCRIPT DE AJUSTE (não altera lógicas existentes) ===== -->
<script>
(function(){
  // Garantir que os botões da aba Agenda acionem a função corretamente e fiquem visíveis
  function ensureTabButtons() {
    const tabMenu = document.querySelector('.tab-menu');
    if (!tabMenu) return;
    tabMenu.style.flexWrap = 'nowrap';
    // ensure class names exist
    Array.from(tabMenu.querySelectorAll('button')).forEach(btn => {
      btn.classList.add('tab-button');
      btn.style.display = 'block';
    });
  }

  // Reaplicar quando a página for carregada e quando o tamanho da tela mudar
  document.addEventListener('DOMContentLoaded', ensureTabButtons);
  window.addEventListener('resize', ensureTabButtons);

  // Em alguns navegadores o onchange="renderizarHistorico()" já está setado; reafirmamos o listener sem sobrescrever a função
  document.addEventListener('DOMContentLoaded', function(){
    const filtro = document.getElementById('filtro-historico-mes');
    if (filtro) {
      // remove duplicatas de listeners simples (caso já exista)
      filtro.removeEventListener('change', window.renderizarHistorico);
      filtro.addEventListener('change', function(){ try { if (typeof window.renderizarHistorico === 'function') window.renderizarHistorico(); } catch(e){console.error(e);} });
    }
  });
})();
</script>
<!-- ===== FIM DO SCRIPT DE AJUSTE ===== -->
</body>
</html>
