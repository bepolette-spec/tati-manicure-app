<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tati Manicure - Gerenciamento de Agendamentos</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <style>
        :root {
            --primary-color: #ff8c6b; /* Cor de Destaque (Salmão/Coral) */
            --secondary-color: #6c757d; /* Cinza para secundários */
            --background-color: #f4f7f6; /* Fundo Suave */
            --sidebar-bg: #ffffff;
            --sidebar-hover-bg: #fff0eb; /* Fundo mais claro para hover */
            --text-color: #343a40; /* Texto Principal (Escuro) */
            --success-color: #28a745;
            --info-color: #17a2b8;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --border-color: #e9ecef;
            --shadow-color: rgba(0, 0, 0, 0.05);
        }

        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            min-height: 100vh;
        }

        /* Estrutura do App */
        #login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            background-color: var(--primary-color);
            min-height: 100vh;
        }

        .login-card {
            background: var(--sidebar-bg);
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 15px var(--shadow-color);
            text-align: center;
            width: 100%;
            max-width: 400px;
        }

        .login-card h1 {
            color: var(--primary-color);
            margin-bottom: 30px;
            font-size: 1.8rem;
        }

        #app-container {
            display: none; /* Escondido por padrão, mostrado após o login */
            width: 100%;
        }

        /* Barra Lateral (Sidebar) */
        .sidebar {
            width: 250px;
            background-color: var(--sidebar-bg);
            box-shadow: 2px 0 5px var(--shadow-color);
            display: flex;
            flex-direction: column;
            padding: 20px 0;
            flex-shrink: 0;
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
            color: var(--primary-color);
            font-size: 1.6rem;
            font-weight: bold;
        }

        .sidebar ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar ul li a {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            text-decoration: none;
            color: var(--text-color);
            transition: background-color 0.2s, color 0.2s;
            font-weight: 500;
        }

        .sidebar ul li a:hover,
        .sidebar ul li a.active {
            background-color: var(--sidebar-hover-bg);
            color: var(--primary-color);
        }

        .sidebar ul li a .material-icons {
            margin-right: 10px;
            font-size: 20px;
        }

        .user-info {
            margin-top: auto;
            padding: 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .user-info p {
            margin: 0 0 10px 0;
            font-weight: bold;
        }

        /* Conteúdo Principal */
        .main-content {
            flex-grow: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .content-section {
            display: none;
            padding: 20px;
        }

        .content-section.active {
            display: block;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .section-header h2 {
            margin: 0;
            color: var(--text-color);
            font-size: 1.5rem;
        }
        
        /* Novas cores para Status de Pacote e Histórico */
        .status-package-paid {
             color: var(--success-color);
             font-weight: bold;
        }
        .status-package-pending {
            color: var(--warning-color);
            font-weight: bold;
        }
        .status-package-active {
            color: var(--primary-color);
            font-weight: bold;
        }
        .status-package-finalized {
            color: var(--danger-color);
            font-weight: bold;
        }

        /* Cartão (Card) */
        .card {
            background: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 4px var(--shadow-color);
            margin-bottom: 20px;
        }
        
        /* NOVO V6: Abas dentro de uma seção */
        .tab-menu {
             display: flex;
             border-bottom: 2px solid var(--border-color);
             margin-bottom: 20px;
        }
        .tab-menu button {
             padding: 10px 20px;
             border: none;
             background: transparent;
             cursor: pointer;
             font-size: 1rem;
             color: var(--secondary-color);
             border-bottom: 2px solid transparent;
             transition: border-color 0.2s, color 0.2s;
             font-weight: bold;
        }
        .tab-menu button.active {
             color: var(--primary-color);
             border-bottom: 2px solid var(--primary-color);
        }
        .tab-content {
             padding-top: 10px;
        }
        .tab-pane {
             display: none;
        }
        .tab-pane.active {
             display: block;
        }

        /* Formulários */
        .form-group {
            margin-bottom: 15px;
        }

        .form-row {
            display: flex;
            gap: 20px;
        }

        .form-row > div {
            flex: 1;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 0.95rem;
        }

        input[type="text"],
        input[type="number"],
        input[type="email"],
        input[type="tel"],
        input[type="date"],
        input[type="time"],
        textarea,
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        /* Datalist input */
        input[list] {
            /* Estilo para garantir que o input datalist se pareça com um campo normal */
            background-image: none;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="email"]:focus,
        input[type="tel"]:focus,
        input[type="date"]:focus,
        input[type="time"]:focus,
        textarea:focus,
        select:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        textarea {
            resize: vertical;
        }

        /* Botões */
        button, .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: background-color 0.2s, opacity 0.2s;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #e57a5e;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #218838;
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: var(--text-color);
        }

        .btn-warning:hover {
            background-color: #ffb547;
        }


        /* Tabelas */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table thead tr {
            background-color: var(--primary-color);
            color: white;
            text-align: left;
        }

        .data-table th, .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table tbody tr:hover {
            background-color: var(--sidebar-hover-bg);
        }

        .data-table td.action-buttons button {
            margin-right: 5px;
            padding: 6px 8px;
        }

        .data-table td.action-buttons {
            white-space: nowrap;
        }

        /* Notificação */
        #notification-bar {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s, transform 0.3s;
            transform: translateY(-20px);
            z-index: 1000;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            font-weight: bold;
        }

        #notification-bar.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        #notification-bar.success { background-color: var(--success-color); }
        #notification-bar.error { background-color: var(--danger-color); }
        #notification-bar.info { background-color: var(--info-color); }

        /* Utilitários */
        .flex-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .input-group {
            display: flex;
            gap: 10px;
        }
        
        .input-group input, .input-group select {
            flex-grow: 1;
        }

        .filter-row {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            margin-bottom: 20px;
        }
        .filter-row > div {
            flex: 1;
        }
        .filter-row button {
            flex-grow: 0;
            flex-shrink: 0;
            padding: 9px 15px; /* Ajuste para alinhar com o input */
        }
        
        /* NOVO V6: Estilos para a Tabela de Visão Diária */
        #tabela-visao-diaria {
             border: 1px solid var(--border-color);
             margin-top: 0;
        }
        #tabela-visao-diaria thead tr {
             background-color: var(--secondary-color);
        }
        #tabela-visao-diaria td {
             height: 40px; /* Altura padrão para cada intervalo de 30 min */
             font-size: 0.9rem;
             vertical-align: top;
        }
        .horario-celula {
             width: 80px;
             font-weight: bold;
             background-color: var(--sidebar-hover-bg);
             color: var(--text-color);
             text-align: center;
             vertical-align: middle !important;
             border-right: 1px solid var(--border-color);
        }
        .agendamento-vago {
             background-color: #f7fff7; /* Verde clarinho */
             color: var(--success-color);
             font-weight: bold;
             font-style: italic;
             text-align: center;
             line-height: 40px;
        }
        .agendamento-ocupado {
             background-color: #fff0eb; /* Fundo do hover de sidebar, suave */
             color: var(--text-color);
             font-weight: 500;
             padding: 5px 10px !important;
             vertical-align: middle !important;
             line-height: 1.2;
             border-left: 5px solid var(--primary-color);
             cursor: pointer;
        }
        .agendamento-ocupado strong {
             color: var(--primary-color);
             font-weight: bold;
        }
        
        /* --------------------------------------------------- */
        /* RESPONSIVIDADE MOBILE (Mobile First - Portrait Mode)*/
        /* --------------------------------------------------- */
        @media (max-width: 768px) {
            
            /* Estrutura Principal */
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
                box-shadow: 0 0 5px var(--shadow-color);
            }

            .main-content {
                padding: 15px;
            }

            #app-container {
                flex-direction: column;
            }

            /* Navegação Horizontal */
            .sidebar ul {
                display: flex;
                flex-wrap: nowrap; /* Tenta manter em uma linha, mas permite rolagem */
                overflow-x: auto;
                justify-content: flex-start;
                border-bottom: 1px solid var(--border-color);
            }

            .sidebar ul li {
                flex-shrink: 0; /* Impede que os itens encolham */
                text-align: center;
            }

            .sidebar ul li a {
                justify-content: center;
                padding: 10px;
                flex-direction: column;
                font-size: 0.75rem;
                white-space: nowrap;
            }

            .sidebar ul li a .material-icons {
                margin-right: 0;
                margin-bottom: 5px;
                font-size: 20px;
            }

            /* FIX: Botão Sair visível no celular */
            .user-info {
                display: block;
                padding: 10px 15px;
                border-top: none; 
                text-align: center; 
            }

            .user-info p {
                display: none; /* Esconde o texto "Olá, Tati!" para economizar espaço */
            }

            .user-info button {
                width: 100%;
                margin-top: 10px; 
                font-size: 0.9rem;
            }
            
            /* 1. Correção de Formulários e Filtros (Empilhamento) */
            .form-row, .filter-row {
                flex-direction: column;
                gap: 0; /* Remove gap quando empilha */
            }

            .form-row > div, 
            .filter-row > div {
                flex: 0 0 100% !important; /* Força largura total */
                width: 100%;
            }
            
            /* Ajusta margem para inputs empilhados */
            .form-group, .filter-row > div {
                margin-bottom: 10px;
            }
            
            .filter-row button {
                width: 100%;
                margin-top: 5px; 
                padding: 10px 15px !important;
            }
            
            /* V6: Ajuste para a Tabela de Visão Diária */
            .table-responsive {
                 overflow-x: auto;
            }
            #tabela-visao-diaria {
                 width: 100%;
                 min-width: 300px; /* Garante que não fique muito esmagada */
            }
            #tabela-visao-diaria td {
                 padding: 5px 10px !important;
            }

            /* 2. Correção de Tabelas (Cartão-like View) */
            .data-table, .data-table tbody, .data-table td, .data-table tr {
                display: block; /* Força elementos da tabela a empilhar */
            }

            .data-table thead {
                display: none; /* Esconde o cabeçalho original */
            }

            .data-table tr {
                border: 1px solid var(--border-color);
                margin-bottom: 15px;
                border-radius: 8px;
                box-shadow: 0 1px 3px var(--shadow-color);
                padding: 10px;
            }

            .data-table td {
                border: none;
                position: relative;
                padding-left: 50% !important; /* Espaço para o rótulo */
                text-align: right; /* Alinha o valor à direita */
                white-space: normal; /* Permite quebras de linha */
                min-height: 40px;
            }

            /* Rótulo customizado (que usa o data-label do JS) */
            .data-table td::before {
                content: attr(data-label);
                position: absolute;
                left: 10px;
                width: 45%; 
                padding-right: 10px;
                white-space: nowrap;
                text-align: left;
                font-weight: bold;
                color: var(--primary-color);
            }
            
            /* FIX V6: Organização dos botões de ação em mobile */
            /* Garante que o rótulo "Ações" não sobreponha o primeiro botão */
            .data-table td.action-buttons {
                text-align: left;
                padding-left: 10px !important;
                display: flex; 
                flex-direction: column; /* Empilha os botões */
                gap: 5px;
            }
            
            .data-table td.action-buttons::before {
                content: "Ações";
                width: 100%; 
                margin-bottom: 5px;
                display: block;
            }
            
            .data-table td.action-buttons button {
                margin: 0;
                width: 100%; /* Ocupa a largura toda */
                max-width: 100%;
                box-sizing: border-box;
                font-size: 0.9rem; 
                padding: 8px 5px;
            }
        }
    </style>
</head>
<body>

    <div id="notification-bar"></div>

    <div id="login-container">
        <div class="login-card">
            <h1>Tati Manicure - Acesso</h1>
            <form id="login-form">
                <div class="form-group">
                    <label for="loginSenha">Senha de Acesso</label>
                    <input type="password" id="loginSenha" required>
                </div>
                <button type="submit" class="btn-primary" style="width: 100%; margin-top: 10px;">
                    <span class="material-icons">login</span> Entrar
                </button>
            </form>
        </div>
    </div>

    <datalist id="clientes-datalist"></datalist>

    <div id="app-container">
        
        <aside class="sidebar">
            <div class="logo">TATI MANICURE APP</div>
            
            <ul>
                <li><a href="#" data-section="agenda" class="active"><span class="material-icons">calendar_today</span> Agenda</a></li>
                <li><a href="#" data-section="clientes"><span class="material-icons">people</span> Clientes</a></li>
                <li><a href="#" data-section="servicos"><span class="material-icons">local_offer</span> Serviços</a></li>
                <li><a href="#" data-section="historico"><span class="material-icons">history</span> Histórico/Lucros</a></li>
            </ul>

            
            <div class="user-info">
                <p id="userInfo">Olá, Tati!</p>
                <button id="logout-button" class="btn-danger" style="width: 100%;">
                    <span class="material-icons">logout</span> Sair
                </button>
            </div>
        </aside>

        <main class="main-content">
            
            <div id="agenda-section" class="content-section active">
                
                <div class="tab-menu">
                    <button class="tab-button active" onclick="showAgendaTab('pacotes-ativos')">Pacotes Ativos</button>
                    <button class="tab-button" onclick="showAgendaTab('novo-agendamento')">Novo Agendamento</button>
                    <button class="tab-button" onclick="showAgendaTab('lista-agendamentos')">Lista Agendamentos</button>
                    <button class="tab-button" onclick="showAgendaTab('visao-diaria')">Visão Diária</button>
                </div>

                <div class="tab-content">
                    
                    <div id="pacotes-ativos-pane" class="tab-pane active">
                        <div class="section-header"><h2>Gerenciamento de Pacotes Ativos</h2></div>
                        <div class="card">
                            <form id="pacote-inicio-form">
                                <h3>Iniciar Novo Pacote de Serviços</h3>
                                <div class="form-row">
                                    <div class="form-group" style="flex: 2;">
                                        <label for="pacote-cliente-id">Cliente</label>
                                        <select id="pacote-cliente-id" required></select>
                                    </div>
                                    <div class="form-group" style="flex: 2;">
                                        <label for="pacote-servico-id">Pacote (Serviços marcados como Pacote)</label>
                                        <select id="pacote-servico-id" required></select>
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label for="pacote-data-inicio">Data Início (Geralmente Hoje)</label>
                                        <input type="date" id="pacote-data-inicio" required>
                                    </div>
                                </div>
                                <div class="flex-container">
                                    <button type="submit" class="btn-primary">
                                        <span class="material-icons">add_box</span> Iniciar/Vender Pacote
                                    </button>
                                </div>
                            </form>

                            <hr style="margin: 20px 0;">

                            <h3>Pacotes Ativos e Utilização</h3>
                            <div style="max-height: 500px; overflow-y: auto;">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 20%;">Cliente</th>
                                            <th style="width: 25%;">Pacote (Total/Usado)</th>
                                            <th style="width: 15%;">Pagamento</th>
                                            <th style="width: 15%;">Vencimento</th>
                                            <th style="width: 200px;">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="lista-pacotes-ativos">
                                        <tr><td colspan="5" style="text-align: center;">Carregando pacotes ativos...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div id="novo-agendamento-pane" class="tab-pane">
                        <div class="section-header"><h2>Agendamento de Serviços Individuais (Não-Pacote)</h2></div>
                        <div class="card">
                            <form id="agendamento-form">
                                <input type="hidden" id="agendamento-id">
                                <input type="hidden" id="agendamento-pacote-id"> <div class="form-row">
                                    <div class="form-group" style="flex: 2;">
                                        <label for="agenda-cliente-id">Cliente</label>
                                        <select id="agenda-cliente-id" required></select>
                                    </div>
                                    <div class="form-group" style="flex: 2;">
                                        <label for="agenda-servico-id">Serviço Individual/Pacote</label>
                                        <select id="agenda-servico-id" required></select>
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label for="agenda-data">Data</label>
                                        <input type="date" id="agenda-data" required>
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="form-group" style="flex: 1;">
                                        <label for="agenda-hora">Hora Início</label>
                                        <input type="time" id="agenda-hora" required>
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label for="agenda-hora-fim">Hora Fim</label>
                                        <input type="time" id="agenda-hora-fim" required>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="agenda-observacoes">Observações</label>
                                    <textarea id="agenda-observacoes" rows="2"></textarea>
                                </div>

                                <div class="flex-container">
                                    <div>
                                        <button type="submit" class="btn-success" id="btn-salvar-agendamento">
                                            <span class="material-icons">save</span> Salvar Agendamento
                                        </button>
                                        <button type="button" class="btn-secondary" onclick="resetAgendamentoForm()">
                                            <span class="material-icons">refresh</span> Limpar
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div id="lista-agendamentos-pane" class="tab-pane">
                        <div class="section-header">
                            <h3>Próximos Agendamentos (Ativos)</h3>
                        </div>
                        <div class="card">
                            <div class="filter-row">
                                <div style="flex-grow: 1.5;">
                                    <label for="filtro-agenda-data">Filtrar por Data</label>
                                    <input type="date" id="filtro-agenda-data" onchange="carregarAgendamentos()">
                                </div>
                                <div style="flex-grow: 3;">
                                    <label for="filtro-agenda-cliente">Filtrar por Cliente (Digite ou Selecione)</label>
                                    <input type="text" id="filtro-agenda-cliente" list="clientes-datalist" placeholder="Digite o nome do cliente..." onkeyup="filtrarAgendamentos()">
                                </div>
                                <button class="btn-secondary" onclick="resetFiltroAgenda()"><span class="material-icons">refresh</span> Resetar Filtro</button>
                            </div>
                            <div style="max-height: 500px; overflow-y: auto;">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 15%;">Data/Hora</th>
                                            <th style="width: 25%;">Cliente</th>
                                            <th style="width: 25%;">Serviço</th>
                                            <th>Status</th>
                                            <th style="width: 150px;">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="lista-agendamentos">
                                        <tr><td colspan="5" style="text-align: center;">Carregando agendamentos...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div id="visao-diaria-pane" class="tab-pane">
                        <div class="section-header">
                            <h2>Visão Diária da Agenda</h2>
                        </div>
                        <div class="card">
                            <div class="filter-row">
                                <div style="flex-grow: 1;">
                                    <label for="filtro-visao-diaria-data">Selecione a Data</label>
                                    <input type="date" id="filtro-visao-diaria-data" onchange="renderizarVisaoDiaria()">
                                </div>
                                <button class="btn-secondary" onclick="renderizarVisaoDiaria(today)"><span class="material-icons">today</span> Ver Hoje</button>
                            </div>
                            <div class="table-responsive">
                                <table class="data-table" id="tabela-visao-diaria">
                                    <thead>
                                        <tr>
                                            <th style="width: 100px;">Horário</th>
                                            <th>Detalhes do Agendamento</th>
                                        </tr>
                                    </thead>
                                    <tbody id="lista-visao-diaria">
                                        <tr><td colspan="2" style="text-align: center;">Selecione uma data para visualizar.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="clientes-section" class="content-section">
                <div class="section-header"><h2>Cadastro de Clientes</h2></div>
                <div class="card">
                    <form id="cliente-form">
                        <input type="hidden" id="cliente-id">
                        
                        <div class="form-row">
                            <div class="form-group" style="flex: 2;">
                                <label for="cliente-nome">Nome Completo</label>
                                <input type="text" id="cliente-nome" required>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label for="cliente-telefone">Telefone (Whatsapp)</label>
                                <input type="tel" id="cliente-telefone">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="cliente-email">E-mail (Opcional)</label>
                            <input type="email" id="cliente-email">
                        </div>
                        
                        <div class="form-group">
                            <label for="cliente-endereco">Endereço (Opcional)</label>
                            <input type="text" id="cliente-endereco">
                        </div>

                        <div class="form-group">
                            <label for="cliente-observacoes">Observações (Alergias, Preferências)</label>
                            <textarea id="cliente-observacoes" rows="2"></textarea>
                        </div>
                        
                        <div class="flex-container">
                            <div>
                                <button type="submit" class="btn-success" id="btn-salvar-cliente">
                                    <span class="material-icons">save</span> Salvar Cliente
                                </button>
                                <button type="button" class="btn-secondary" onclick="resetClienteForm()">
                                    <span class="material-icons">refresh</span> Limpar
                                </button>
                            </div>
                        </div>
                    </form>
                </div>

                <div class="section-header">
                    <h3>Lista de Clientes Cadastrados</h3>
                    <div class="input-group" style="width: 300px;">
                        <input type="text" id="filtro-cliente" placeholder="Filtrar por nome..." onkeyup="filtrarClientes()">
                        <button class="btn-secondary" onclick="document.getElementById('filtro-cliente').value = ''; filtrarClientes();"><span class="material-icons">refresh</span></button>
                    </div>
                </div>
                <div class="card" style="padding: 15px;">
                    <div style="max-height: 500px; overflow-y: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th style="width: 25%;">Nome</th>
                                    <th style="width: 20%;">Telefone</th>
                                    <th style="width: 30%;">Observações</th>
                                    <th style="width: 150px;">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="lista-clientes">
                                <tr><td colspan="4" style="text-align: center;">Carregando clientes...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="servicos-section" class="content-section">
                <div class="section-header"><h2>Cadastro de Serviços/Pacotes</h2></div>
                <div class="card">
                    <form id="servico-form">
                        <input type="hidden" id="servico-id">
                        
                        <div class="form-row">
                            <div class="form-group" style="flex: 2;">
                                <label for="servico-nome">Nome do Serviço/Pacote</label>
                                <input type="text" id="servico-nome" required>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label for="servico-valor">Valor (R$)</label>
                                <input type="number" id="servico-valor" step="0.01" min="0" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <label for="servico-duracao">Duração (minutos)</label>
                                <input type="number" id="servico-duracao" min="15" step="15" required>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label for="servico-tipo">Tipo</label>
                                <select id="servico-tipo" required onchange="togglePacoteFields()">
                                    <option value="individual">Serviço Individual</option>
                                    <option value="pacote">Pacote de Serviços</option>
                                </select>
                            </div>
                        </div>
                        
                        <div id="pacote-fields" style="display: none;">
                            <div class="form-row">
                                <div class="form-group" style="flex: 1;">
                                    <label for="servico-quantidade-total">Quantidade Total de Usos</label>
                                    <input type="number" id="servico-quantidade-total" min="1" required>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label for="servico-validade">Validade (dias, ex: 90)</label>
                                    <input type="number" id="servico-validade" min="1" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="servico-observacoes-pacote">Serviços Inclusos/Observações do Pacote</label>
                                <textarea id="servico-observacoes-pacote" rows="2"></textarea>
                            </div>
                        </div>
                        
                        <div class="flex-container">
                            <div>
                                <button type="submit" class="btn-success" id="btn-salvar-servico">
                                    <span class="material-icons">save</span> Salvar Serviço
                                </button>
                                <button type="button" class="btn-secondary" onclick="resetServicoForm()">
                                    <span class="material-icons">refresh</span> Limpar
                                </button>
                            </div>
                        </div>
                    </form>
                </div>

                <div class="section-header"><h3>Lista de Serviços/Pacotes</h3></div>
                <div class="card" style="padding: 15px;">
                    <div style="max-height: 500px; overflow-y: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th style="width: 30%;">Nome/Tipo</th>
                                    <th style="width: 15%;">Valor (R$)</th>
                                    <th style="width: 15%;">Duração (min)</th>
                                    <th style="width: 25%;">Detalhes do Pacote</th>
                                    <th style="width: 150px;">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="lista-servicos">
                                <tr><td colspan="5" style="text-align: center;">Carregando serviços...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="historico-section" class="content-section">
                <div class="section-header"><h2>Histórico e Lucros</h2></div>
                <div class="card">
                    <div class="filter-row">
                        <div style="flex-grow: 1;">
                            <label for="filtro-historico-mes">Filtrar por Mês/Ano</label>
                            <input type="month" id="filtro-historico-mes" onchange="renderizarHistorico()">
                        </div>
                        <div style="flex-grow: 3;">
                            <label for="filtro-historico-cliente">Filtrar por Cliente (Digite ou Selecione)</label>
                            <input type="text" id="filtro-historico-cliente" list="clientes-datalist" placeholder="Digite o nome do cliente..." onkeyup="filtrarHistoricoTabela()">
                        </div>
                        <button class="btn-secondary" onclick="resetFiltroHistorico()"><span class="material-icons">refresh</span> Resetar Filtro</button>
                    </div>

                    <h3>Resumo do Mês/Filtro: <span id="resumo-lucros" style="color: var(--success-color);">R$ 0,00</span></h3>
                    
                    <div style="max-height: 500px; overflow-y: auto; margin-top: 15px;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th style="width: 15%;">Data</th>
                                    <th style="width: 25%;">Cliente</th>
                                    <th style="width: 35%;">Serviço/Transação</th>
                                    <th style="width: 15%;">Valor (R$)</th>
                                    <th style="width: 100px;">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="lista-historico">
                                <tr><td colspan="5" style="text-align: center;">Carregando histórico...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        // CONFIGURAÇÃO DO FIREBASE
        // **IMPORTANTE**: Substitua com suas próprias credenciais!
        const firebaseConfig = {
             apiKey: "SUA_API_KEY",
             authDomain: "SEU_AUTH_DOMAIN",
             databaseURL: "SUA_DATABASE_URL", // Geralmente o nome do seu projeto
             projectId: "SEU_PROJECT_ID",
             storageBucket: "SEU_STORAGE_BUCKET",
             messagingSenderId: "SEU_MESSAGING_SENDER_ID",
             appId: "SEU_APP_ID"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        // Variáveis Globais de Dados
        let allClientes = {};
        let allServicos = {};
        let allPacotesAtivos = {};
        let allAgendamentos = {};
        let agendamentosAtivos = [];

        // SENHA DE ACESSO
        const senhaAcesso = "tati123"; 

        // Data de hoje em formato YYYY-MM-DD
        const today = new Date().toISOString().split('T')[0];

        // ----------------------------------------------------------------------------------
        // FUNÇÕES DE UTILIDADE
        // ----------------------------------------------------------------------------------

        function showNotification(message, type = 'info') {
            const bar = document.getElementById('notification-bar');
            bar.textContent = message;
            bar.className = 'show ' + type;
            setTimeout(() => {
                bar.className = bar.className.replace('show', '');
            }, 3000);
        }

        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
            
            document.querySelectorAll('.sidebar ul li a').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector(`[data-section="${sectionId.replace('-section', '')}"]`).classList.add('active');

            // Carregamento de dados inicial para a seção
            if (sectionId === 'agenda-section') {
                const activeTab = document.querySelector('#agenda-section .tab-button.active');
                if (activeTab && activeTab.onclick) activeTab.onclick(); // Recarrega a aba ativa da Agenda
            } else if (sectionId === 'clientes-section') {
                carregarClientes();
            } else if (sectionId === 'servicos-section') {
                carregarServicos();
            } else if (sectionId === 'historico-section') {
                renderizarHistorico();
            }
        }
        
        function showAgendaTab(tabName) {
            document.querySelectorAll('#agenda-section .tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('#agenda-section .tab-pane').forEach(pane => pane.classList.remove('active'));
            
            document.querySelector(`#agenda-section .tab-button[onclick*="'${tabName}'"]`).classList.add('active');
            document.getElementById(`${tabName}-pane`).classList.add('active');
            
            // Carregar dados específicos da aba
            if (tabName === 'pacotes-ativos') {
                carregarPacotesAtivos();
            } else if (tabName === 'novo-agendamento') {
                resetAgendamentoForm(); // Garante o formulário limpo
                popularDropdownsAgendamento(); 
            } else if (tabName === 'lista-agendamentos') {
                carregarAgendamentos();
            } else if (tabName === 'visao-diaria') {
                document.getElementById('filtro-visao-diaria-data').value = today;
                renderizarVisaoDiaria(today);
            }
        }

        // ----------------------------------------------------------------------------------
        // FIREBASE LISTENERS (Carregamento de Dados)
        // ----------------------------------------------------------------------------------
        
        // 1. Clientes
        db.ref('clientes').on('value', (snapshot) => {
            allClientes = snapshot.val() || {};
            // Populando Datalist e Dropdowns
            const datalist = document.getElementById('clientes-datalist');
            datalist.innerHTML = '';
            const selectClientePacote = document.getElementById('pacote-cliente-id');
            const selectClienteAgenda = document.getElementById('agenda-cliente-id');
            selectClientePacote.innerHTML = '<option value="">Selecione o Cliente</option>';
            selectClienteAgenda.innerHTML = '<option value="">Selecione o Cliente</option>';

            Object.keys(allClientes).forEach(id => {
                const cliente = allClientes[id];
                const optionDatalist = document.createElement('option');
                optionDatalist.value = cliente.nome;
                datalist.appendChild(optionDatalist);

                const optionSelectPacote = new Option(cliente.nome, id);
                selectClientePacote.appendChild(optionSelectPacote);

                const optionSelectAgenda = new Option(cliente.nome, id);
                selectClienteAgenda.appendChild(optionSelectAgenda);
            });
            carregarClientes();
        });

        // 2. Serviços
        db.ref('servicos').on('value', (snapshot) => {
            allServicos = snapshot.val() || {};
            
            // Populando Dropdowns
            const selectServicoPacote = document.getElementById('pacote-servico-id');
            const selectServicoAgenda = document.getElementById('agenda-servico-id');
            selectServicoPacote.innerHTML = '<option value="">Selecione o Pacote</option>';
            selectServicoAgenda.innerHTML = '<option value="">Selecione o Serviço</option>';

            Object.keys(allServicos).forEach(id => {
                const servico = allServicos[id];
                if (servico.tipo === 'pacote') {
                    const optionPacote = new Option(`${servico.nome} (Total: ${servico.quantidadeTotal} usos)`, id);
                    selectServicoPacote.appendChild(optionPacote);
                } else {
                    const optionIndividual = new Option(`${servico.nome} (R$ ${parseFloat(servico.valor).toFixed(2)})`, id);
                    selectServicoAgenda.appendChild(optionIndividual);
                }
            });
            carregarServicos();
        });

        // 3. Pacotes Ativos
        db.ref('pacotes_ativos').on('value', (snapshot) => {
            allPacotesAtivos = snapshot.val() || {};
            if (document.getElementById('pacotes-ativos-pane').classList.contains('active')) {
                renderizarPacotesAtivos();
            }
            // Não precisa de carregarPacotesAtivos() aqui, pois renderizarPacotesAtivos() é chamado se a aba estiver ativa.
        });

        // 4. Agendamentos (Listener centralizado para Agenda e Histórico)
        db.ref('agendamentos').on('value', (snapshot) => {
            allAgendamentos = snapshot.val() || {};
            
            // Separa agendamentos ativos para a tela de agenda
            agendamentosAtivos = Object.keys(allAgendamentos)
                .map(id => ({ id, ...allAgendamentos[id] }))
                .filter(a => a.status === 'ativo');

            // Recarregar o que estiver visível
            if (document.getElementById('lista-agendamentos-pane').classList.contains('active')) {
                carregarAgendamentos();
            }
            if (document.getElementById('visao-diaria-pane').classList.contains('active')) {
                 renderizarVisaoDiaria(document.getElementById('filtro-visao-diaria-data').value || today);
            }
            if (document.getElementById('historico-section').classList.contains('active')) {
                renderizarHistorico();
            }
        });
        
        // Função auxiliar para popular dropdowns (chamada no listener de clientes e serviços)
        function popularDropdownsAgendamento() {
             // Esta função é chamada apenas para garantir que a dropdowns de cliente/serviço estão populadas
             // O trabalho pesado é feito nos listeners do Firebase
        }


        // ----------------------------------------------------------------------------------
        // 1. CLIENTES (CRUD)
        // ----------------------------------------------------------------------------------

        // 1.1. SALVAR CLIENTE
        document.getElementById('cliente-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const clienteId = document.getElementById('cliente-id').value;
            const nome = document.getElementById('cliente-nome').value.trim();
            const telefone = document.getElementById('cliente-telefone').value.trim();
            const email = document.getElementById('cliente-email').value.trim();
            const endereco = document.getElementById('cliente-endereco').value.trim();
            const observacoes = document.getElementById('cliente-observacoes').value.trim();
            
            const novoCliente = { nome, telefone, email, endereco, observacoes };
            
            if (clienteId) {
                // EDIÇÃO
                db.ref('clientes/' + clienteId).update(novoCliente)
                    .then(() => {
                        showNotification('Cliente atualizado com sucesso!', 'success');
                        resetClienteForm();
                    })
                    .catch(error => showNotification('Erro ao atualizar cliente: ' + error.message, 'error'));
            } else {
                // CADASTRO
                db.ref('clientes').push(novoCliente)
                    .then(() => {
                        showNotification('Cliente cadastrado com sucesso!', 'success');
                        resetClienteForm();
                    })
                    .catch(error => showNotification('Erro ao cadastrar cliente: ' + error.message, 'error'));
            }
        });
        
        // 1.2. RESETAR FORMULÁRIO DE CLIENTE
        window.resetClienteForm = function() {
            document.getElementById('cliente-form').reset();
            document.getElementById('cliente-id').value = '';
            document.getElementById('btn-salvar-cliente').innerHTML = '<span class="material-icons">save</span> Salvar Cliente';
            document.getElementById('btn-salvar-cliente').classList.remove('btn-warning');
            document.getElementById('btn-salvar-cliente').classList.add('btn-success');
        }
        
        // 1.3. CARREGAR/RENDERIZAR CLIENTES NA TABELA
        function carregarClientes() {
            const lista = document.getElementById('lista-clientes');
            lista.innerHTML = '';
            
            const clientesArray = Object.keys(allClientes).map(id => ({ id, ...allClientes[id] }));
            
            if (clientesArray.length === 0) {
                lista.innerHTML = '<tr><td colspan="4" style="text-align: center;">Nenhum cliente cadastrado.</td></tr>';
                return;
            }

            clientesArray.forEach(cliente => {
                const row = lista.insertRow();
                row.dataset.clienteNome = cliente.nome.toLowerCase(); // Para o filtro

                row.innerHTML = `
                    <td data-label="Nome">${cliente.nome}</td>
                    <td data-label="Telefone">${cliente.telefone || 'N/A'}</td>
                    <td data-label="Obs">${cliente.observacoes.substring(0, 50) + (cliente.observacoes.length > 50 ? '...' : '') || 'N/A'}</td>
                    <td class="action-buttons" data-label="Ações">
                        <button class="btn-warning" onclick="editarCliente('${cliente.id}')"><span class="material-icons">edit</span> Editar</button>
                        <button class="btn-danger" onclick="excluirCliente('${cliente.id}')"><span class="material-icons">delete</span> Excluir</button>
                    </td>
                `;
            });
            filtrarClientes(); // Aplica o filtro se já houver texto
        }
        
        // 1.4. EDITAR CLIENTE
        window.editarCliente = function(clienteId) {
            const cliente = allClientes[clienteId];
            if (cliente) {
                document.getElementById('cliente-id').value = clienteId;
                document.getElementById('cliente-nome').value = cliente.nome;
                document.getElementById('cliente-telefone').value = cliente.telefone;
                document.getElementById('cliente-email').value = cliente.email;
                document.getElementById('cliente-endereco').value = cliente.endereco;
                document.getElementById('cliente-observacoes').value = cliente.observacoes;
                
                document.getElementById('btn-salvar-cliente').innerHTML = '<span class="material-icons">save</span> Salvar Edição';
                document.getElementById('btn-salvar-cliente').classList.remove('btn-success');
                document.getElementById('btn-salvar-cliente').classList.add('btn-warning');
                showNotification(`Editando cliente: ${cliente.nome}`, 'info');
            }
        }
        
        // 1.5. EXCLUIR CLIENTE
        window.excluirCliente = function(clienteId) {
            const cliente = allClientes[clienteId];
            if (confirm(`Tem certeza que deseja EXCLUIR o cliente ${cliente.nome}? Isso também apagará seus pacotes e agendamentos.`)) {
                // Exclui o cliente
                db.ref('clientes/' + clienteId).remove()
                    .then(() => {
                        showNotification('Cliente excluído com sucesso!', 'success');
                        
                        // Rotina de limpeza: Excluir agendamentos/pacotes relacionados (opcional, mas recomendado)
                        // A limpeza será feita no backend, aqui apenas notificamos.
                        // Em um app real, o banco de dados deveria cuidar da integridade referencial.
                    })
                    .catch(error => showNotification('Erro ao excluir cliente: ' + error.message, 'error'));
            }
        }
        
        // 1.6. FILTRAR CLIENTES NA TABELA
        window.filtrarClientes = function() {
             const filtro = document.getElementById('filtro-cliente').value.toLowerCase();
             const listaClientes = document.getElementById('lista-clientes');
             const linhas = listaClientes.getElementsByTagName('tr');

             for (let i = 0; i < linhas.length; i++) {
                 const row = linhas[i];
                 if (!row.dataset.clienteNome) continue; 

                 const clienteNome = row.dataset.clienteNome;
                
                 if (clienteNome.includes(filtro)) {
                     row.style.display = ""; // Mostra a linha
                 } else {
                     row.style.display = "none"; // Esconde a linha
                 }
             }
        }


        // ----------------------------------------------------------------------------------
        // 2. SERVIÇOS (CRUD)
        // ----------------------------------------------------------------------------------
        
        // 2.1. TOGGLE CAMPOS DE PACOTE
        window.togglePacoteFields = function() {
            const tipo = document.getElementById('servico-tipo').value;
            const pacoteFields = document.getElementById('pacote-fields');
            const quantidadeInput = document.getElementById('servico-quantidade-total');
            const validadeInput = document.getElementById('servico-validade');

            if (tipo === 'pacote') {
                pacoteFields.style.display = 'block';
                quantidadeInput.setAttribute('required', 'required');
                validadeInput.setAttribute('required', 'required');
            } else {
                pacoteFields.style.display = 'none';
                quantidadeInput.removeAttribute('required');
                validadeInput.removeAttribute('required');
                // Limpar valores para evitar salvamento de dados de pacote em serviço individual
                quantidadeInput.value = '';
                validadeInput.value = '';
                document.getElementById('servico-observacoes-pacote').value = '';
            }
        }

        // 2.2. SALVAR SERVIÇO/PACOTE
        document.getElementById('servico-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const servicoId = document.getElementById('servico-id').value;
            const nome = document.getElementById('servico-nome').value.trim();
            const valor = parseFloat(document.getElementById('servico-valor').value).toFixed(2);
            const duracao = parseInt(document.getElementById('servico-duracao').value);
            const tipo = document.getElementById('servico-tipo').value;
            
            let novoServico = { nome, valor, duracao, tipo };

            if (tipo === 'pacote') {
                const quantidadeTotal = parseInt(document.getElementById('servico-quantidade-total').value);
                const validade = parseInt(document.getElementById('servico-validade').value);
                const observacoesPacote = document.getElementById('servico-observacoes-pacote').value.trim();
                novoServico = { ...novoServico, quantidadeTotal, validade, observacoesPacote };
            }

            if (servicoId) {
                // EDIÇÃO
                db.ref('servicos/' + servicoId).update(novoServico)
                    .then(() => {
                        showNotification('Serviço/Pacote atualizado com sucesso!', 'success');
                        resetServicoForm();
                    })
                    .catch(error => showNotification('Erro ao atualizar serviço: ' + error.message, 'error'));
            } else {
                // CADASTRO
                db.ref('servicos').push(novoServico)
                    .then(() => {
                        showNotification('Serviço/Pacote cadastrado com sucesso!', 'success');
                        resetServicoForm();
                    })
                    .catch(error => showNotification('Erro ao cadastrar serviço: ' + error.message, 'error'));
            }
        });
        
        // 2.3. RESETAR FORMULÁRIO DE SERVIÇO/PACOTE
        window.resetServicoForm = function() {
            document.getElementById('servico-form').reset();
            document.getElementById('servico-id').value = '';
            document.getElementById('servico-tipo').value = 'individual';
            togglePacoteFields();
            document.getElementById('btn-salvar-servico').innerHTML = '<span class="material-icons">save</span> Salvar Serviço';
            document.getElementById('btn-salvar-servico').classList.remove('btn-warning');
            document.getElementById('btn-salvar-servico').classList.add('btn-success');
        }

        // 2.4. CARREGAR/RENDERIZAR SERVIÇOS NA TABELA
        function carregarServicos() {
            const lista = document.getElementById('lista-servicos');
            lista.innerHTML = '';
            
            const servicosArray = Object.keys(allServicos).map(id => ({ id, ...allServicos[id] }));
            
            if (servicosArray.length === 0) {
                lista.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nenhum serviço/pacote cadastrado.</td></tr>';
                return;
            }

            servicosArray.forEach(servico => {
                const tipoDisplay = servico.tipo === 'pacote' ? 
                    `<span style="color: var(--info-color); font-weight: bold;">Pacote</span>` : 
                    'Serviço Individual';
                
                const detalhesPacote = servico.tipo === 'pacote' ? 
                    `${servico.quantidadeTotal} usos | Validade: ${servico.validade} dias` : 
                    'N/A';

                const row = lista.insertRow();
                row.innerHTML = `
                    <td data-label="Nome/Tipo">${servico.nome} (${tipoDisplay})</td>
                    <td data-label="Valor">R$ ${parseFloat(servico.valor).toFixed(2)}</td>
                    <td data-label="Duração">${servico.duracao}</td>
                    <td data-label="Detalhes">${detalhesPacote}</td>
                    <td class="action-buttons" data-label="Ações">
                        <button class="btn-warning" onclick="editarServico('${servico.id}')"><span class="material-icons">edit</span> Editar</button>
                        <button class="btn-danger" onclick="excluirServico('${servico.id}')"><span class="material-icons">delete</span> Excluir</button>
                    </td>
                `;
            });
        }
        
        // 2.5. EDITAR SERVIÇO/PACOTE
        window.editarServico = function(servicoId) {
            const servico = allServicos[servicoId];
            if (servico) {
                document.getElementById('servico-id').value = servicoId;
                document.getElementById('servico-nome').value = servico.nome;
                document.getElementById('servico-valor').value = parseFloat(servico.valor);
                document.getElementById('servico-duracao').value = servico.duracao;
                document.getElementById('servico-tipo').value = servico.tipo;
                
                togglePacoteFields(); // Chama para mostrar/esconder campos

                if (servico.tipo === 'pacote') {
                    document.getElementById('servico-quantidade-total').value = servico.quantidadeTotal;
                    document.getElementById('servico-validade').value = servico.validade;
                    document.getElementById('servico-observacoes-pacote').value = servico.observacoesPacote || '';
                }
                
                document.getElementById('btn-salvar-servico').innerHTML = '<span class="material-icons">save</span> Salvar Edição';
                document.getElementById('btn-salvar-servico').classList.remove('btn-success');
                document.getElementById('btn-salvar-servico').classList.add('btn-warning');
                showNotification(`Editando serviço: ${servico.nome}`, 'info');
            }
        }
        
        // 2.6. EXCLUIR SERVIÇO/PACOTE
        window.excluirServico = function(servicoId) {
            const servico = allServicos[servicoId];
            if (confirm(`Tem certeza que deseja EXCLUIR o Serviço/Pacote ${servico.nome}?`)) {
                db.ref('servicos/' + servicoId).remove()
                    .then(() => {
                        showNotification('Serviço/Pacote excluído com sucesso!', 'success');
                    })
                    .catch(error => showNotification('Erro ao excluir serviço: ' + error.message, 'error'));
            }
        }


        // ----------------------------------------------------------------------------------
        // 3. PACOTES ATIVOS (VENDER, USAR, MARCAR PAGO)
        // ----------------------------------------------------------------------------------

        // 3.1. INICIAR NOVO PACOTE (VENDER)
        document.getElementById('pacote-inicio-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const clienteId = document.getElementById('pacote-cliente-id').value;
            const servicoId = document.getElementById('pacote-servico-id').value;
            const dataInicio = document.getElementById('pacote-data-inicio').value;
            
            const cliente = allClientes[clienteId];
            const pacoteServico = allServicos[servicoId];

            if (!cliente || !pacoteServico || pacoteServico.tipo !== 'pacote') {
                showNotification('Erro: Seleção de cliente ou pacote inválida.', 'error');
                return;
            }
            
            // Calcula a data de vencimento
            const dataVencimento = new Date(dataInicio);
            dataVencimento.setDate(dataVencimento.getDate() + parseInt(pacoteServico.validade));
            const dataVencimentoStr = dataVencimento.toISOString().split('T')[0];
            
            const novoPacoteAtivo = {
                clienteId: clienteId,
                clienteNome: cliente.nome,
                servicoId: servicoId,
                servicoNome: pacoteServico.nome,
                dataInicio: dataInicio,
                dataVencimento: dataVencimentoStr,
                quantidadeTotal: pacoteServico.quantidadeTotal,
                quantidadeUsada: 0,
                valorTotal: parseFloat(pacoteServico.valor),
                statusPacote: 'ativo',
                statusPagamento: 'pendente' // Novo campo para rastrear pagamento
            };

            db.ref('pacotes_ativos').push(novoPacoteAtivo)
                .then(() => {
                    showNotification(`Pacote ${pacoteServico.nome} iniciado para ${cliente.nome}!`, 'success');
                    document.getElementById('pacote-inicio-form').reset();
                })
                .catch(error => showNotification('Erro ao iniciar pacote: ' + error.message, 'error'));
        });
        
        // 3.2. RENDERIZAR PACOTES ATIVOS NA TABELA
        function renderizarPacotesAtivos() {
            const lista = document.getElementById('lista-pacotes-ativos');
            lista.innerHTML = '';

            const pacotesArray = Object.keys(allPacotesAtivos).map(id => ({ id, ...allPacotesAtivos[id] }));
            
            if (pacotesArray.length === 0) {
                lista.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nenhum pacote ativo.</td></tr>';
                return;
            }
            
            const hoje = new Date(today);

            pacotesArray.sort((a, b) => new Date(a.dataVencimento) - new Date(b.dataVencimento)).forEach(pacote => {
                const vencimento = new Date(pacote.dataVencimento);
                const diasRestantes = Math.ceil((vencimento - hoje) / (1000 * 60 * 60 * 24));
                const vencido = diasRestantes < 0;

                let statusPagamento = '';
                if (pacote.statusPagamento === 'pago') {
                    statusPagamento = `<span class="status-package-paid">Pago</span>`;
                } else {
                    statusPagamento = `<span class="status-package-pending">Pendente (R$ ${pacote.valorTotal.toFixed(2)})</span>`;
                }
                
                const statusUsos = pacote.quantidadeUsada >= pacote.quantidadeTotal ? 
                    `<span class="status-package-finalized">${pacote.quantidadeTotal}/${pacote.quantidadeUsada} (Finalizado)</span>` :
                    `${pacote.quantidadeUsada}/${pacote.quantidadeTotal} usos`;

                let statusVencimento = `Venc. ${pacote.dataVencimento}`;
                if (vencido) {
                    statusVencimento += ` (<span class="status-package-finalized">Vencido!</span>)`;
                } else if (diasRestantes <= 30) {
                    statusVencimento += ` (<span class="status-package-pending">${diasRestantes} dias</span>)`;
                }
                
                const podeUsar = pacote.quantidadeUsada < pacote.quantidadeTotal && !vencido;
                const podePagar = pacote.statusPagamento === 'pendente';

                const row = lista.insertRow();
                row.innerHTML = `
                    <td data-label="Cliente">${pacote.clienteNome}</td>
                    <td data-label="Pacote">${pacote.servicoNome}<br>${statusUsos}</td>
                    <td data-label="Pagamento">${statusPagamento}</td>
                    <td data-label="Vencimento">${statusVencimento}</td>
                    <td class="action-buttons" data-label="Ações">
                        ${podeUsar ? 
                            `<button class="btn-warning" onclick="iniciarUsoPacote('${pacote.id}', '${pacote.clienteId}')"><span class="material-icons">check</span> Usar Pacote</button>` : 
                            `<button class="btn-secondary" disabled title="Pacote finalizado ou vencido."><span class="material-icons">block</span> Usar Pacote</button>`
                        }
                        ${podePagar ? 
                            `<button class="btn-success" onclick="marcarPacotePago('${pacote.id}')"><span class="material-icons">paid</span> Marcar Pago</button>` : 
                            `<button class="btn-secondary" disabled title="Pagamento já registrado."><span class="material-icons">paid</span> Pago</button>`
                        }
                        <button class="btn-danger" onclick="excluirPacoteAtivo('${pacote.id}', '${pacote.clienteNome}')"><span class="material-icons">delete</span> Excluir</button>
                    </td>
                `;
            });
        }
        
        // 3.3. **NOVA FUNÇÃO** INICIAR USO DO PACOTE (Redireciona para Novo Agendamento)
        window.iniciarUsoPacote = function(pacoteId, clienteId) {
            // 1. Limpa o formulário e muda para a aba Novo Agendamento
            resetAgendamentoForm(); 
            showAgendaTab('novo-agendamento');
            
            // 2. Define o ID do Pacote no campo oculto
            document.getElementById('agendamento-pacote-id').value = pacoteId;
            
            // 3. Pré-preenche Cliente e Serviço do Pacote
            const pacote = allPacotesAtivos[pacoteId];
            if (pacote) {
                document.getElementById('agenda-cliente-id').value = pacote.clienteId;
                document.getElementById('agenda-servico-id').value = pacote.servicoId; // O servicoId do pacote é usado
                
                // Desabilita seleção para forçar integridade
                document.getElementById('agenda-cliente-id').disabled = true;
                document.getElementById('agenda-servico-id').disabled = true;

                showNotification(`Agendando uso do pacote "${pacote.servicoNome}" para ${pacote.clienteNome}. Preencha data e hora.`, 'info');
                
                // Atualiza o texto do botão
                document.getElementById('btn-salvar-agendamento').innerHTML = '<span class="material-icons">save</span> Agendar Uso do Pacote';
            } else {
                showNotification('Erro: Pacote ativo não encontrado.', 'error');
            }
        }
        
        // 3.4. **NOVA FUNÇÃO** MARCAR PACOTE PAGO (Cria registro de lucro)
        window.marcarPacotePago = async function(pacoteId) {
            if (!confirm('Confirmar que o pacote foi PAGO e registrar o lucro total?')) return;

            const pacote = allPacotesAtivos[pacoteId];

            try {
                // 1. Atualiza o status no nó pacotes_ativos
                await db.ref('pacotes_ativos/' + pacoteId).update({
                    statusPagamento: 'pago',
                    dataPagamento: new Date().toISOString().split('T')[0]
                });

                // 2. **NOVO**: Cria um registro de Transação/Pagamento em 'agendamentos' para rastrear lucro (Item 3b)
                const newAgendamentoRef = db.ref('agendamentos').push();
                const dataPagamento = new Date().toISOString().split('T')[0];
                
                await newAgendamentoRef.set({
                    clienteId: pacote.clienteId,
                    clienteNome: pacote.clienteNome,
                    servicoNome: `Pagamento do Pacote: ${pacote.servicoNome}`, // Nome descritivo
                    servicoId: pacote.servicoId, 
                    tipo: 'pagamento_pacote', // TIPO ESPECIAL para cálculo de lucro
                    pacoteId: pacoteId, 
                    valor: pacote.valorTotal, // VALOR TOTAL DO PACOTE
                    data: dataPagamento,
                    hora: '00:00', 
                    horaFim: '00:00',
                    observacoes: `Registro de Pagamento de Pacote R$ ${pacote.valorTotal.toFixed(2)}.`,
                    status: 'finalizado', // Deve ser 'finalizado' para contar no Histórico/Lucro
                    dataFinalizacao: dataPagamento
                });
                // FIM DO NOVO REGISTRO DE PAGAMENTO

                showNotification('Pagamento do Pacote registrado com sucesso! Lucro contabilizado.', 'success');
                carregarPacotesAtivos(); 
                renderizarHistorico();
                
            } catch (error) {
                showNotification('Erro ao registrar pagamento: ' + error.message, 'error');
            }
        }
        
        // 3.5. EXCLUIR PACOTE ATIVO
        window.excluirPacoteAtivo = function(pacoteId, clienteNome) {
            if (confirm(`Tem certeza que deseja EXCLUIR o pacote ativo de ${clienteNome}?`)) {
                db.ref('pacotes_ativos/' + pacoteId).remove()
                    .then(() => {
                        showNotification('Pacote ativo excluído com sucesso!', 'success');
                        // Nota: Agendamentos de uso vinculados ao pacote devem ser tratados manualmente se necessário,
                        // mas para simplificar, removemos apenas o registro de pacote ativo.
                    })
                    .catch(error => showNotification('Erro ao excluir pacote ativo: ' + error.message, 'error'));
            }
        }


        // ----------------------------------------------------------------------------------
        // 4. AGENDAMENTOS (CRUD)
        // ----------------------------------------------------------------------------------

        // 4.1. SALVAR AGENDAMENTO (Cria ou Edita)
        document.getElementById('agendamento-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const agendamentoId = document.getElementById('agendamento-id').value;
            const pacoteId = document.getElementById('agendamento-pacote-id').value; // NOVO: Pega o ID do pacote (se houver)

            const clienteId = document.getElementById('agenda-cliente-id').value;
            const servicoId = document.getElementById('agenda-servico-id').value;
            const data = document.getElementById('agenda-data').value;
            const hora = document.getElementById('agenda-hora').value;
            const horaFim = document.getElementById('agenda-hora-fim').value;
            const observacoes = document.getElementById('agenda-observacoes').value.trim();
            
            const cliente = allClientes[clienteId];
            const servico = allServicos[servicoId];
            
            if (!cliente || !servico) {
                 showNotification('Erro: Cliente ou Serviço inválido.', 'error');
                 return;
            }

            // Determine the type and value of the appointment (NOVA LÓGICA)
            let agendamentoTipo = 'individual';
            let agendamentoValor = parseFloat(servico.valor);

            if (pacoteId) { // Se for um uso de pacote (Item 3a)
                agendamentoTipo = 'pacote';
                agendamentoValor = 0.00; // Pacote não tem valor individual por uso
            }

            const novoAgendamento = {
                clienteId,
                clienteNome: cliente.nome,
                servicoId,
                servicoNome: servico.nome,
                tipo: agendamentoTipo, // Use o tipo determinado
                pacoteId: pacoteId || null, // Novo: Link para pacote se aplicável
                valor: agendamentoValor, // Use o valor determinado (0.00 se pacote)
                data,
                hora,
                horaFim,
                observacoes,
                status: 'ativo' // Agendamento recém-criado/editado é sempre ativo
            };
            
            if (agendamentoId) {
                // EDIÇÃO
                db.ref('agendamentos/' + agendamentoId).update(novoAgendamento)
                    .then(() => {
                        showNotification('Agendamento atualizado com sucesso!', 'success');
                        resetAgendamentoForm();
                        // Volta para a lista
                        showAgendaTab('lista-agendamentos'); 
                    })
                    .catch(error => showNotification('Erro ao atualizar agendamento: ' + error.message, 'error'));
            } else {
                // CADASTRO
                db.ref('agendamentos').push(novoAgendamento)
                    .then(() => {
                        showNotification('Agendamento salvo com sucesso!', 'success');
                        resetAgendamentoForm();
                        // Volta para a lista
                        showAgendaTab('lista-agendamentos'); 
                    })
                    .catch(error => showNotification('Erro ao salvar agendamento: ' + error.message, 'error'));
            }
        });
        
        // 4.2. RESETAR FORMULÁRIO DE AGENDAMENTO
        window.resetAgendamentoForm = function() {
            document.getElementById('agendamento-form').reset();
            document.getElementById('agendamento-id').value = '';
            document.getElementById('agendamento-pacote-id').value = ''; // NOVO: Limpa o ID do pacote
            document.getElementById('agenda-cliente-id').disabled = false; // NOVO: Reabilita os campos
            document.getElementById('agenda-servico-id').disabled = false; // NOVO: Reabilita os campos
            
            // Botão
            document.getElementById('btn-salvar-agendamento').innerHTML = '<span class="material-icons">save</span> Salvar Agendamento';
            document.getElementById('btn-salvar-agendamento').classList.remove('btn-warning');
            document.getElementById('btn-salvar-agendamento').classList.add('btn-success');
        }
        
        // 4.3. CARREGAR/RENDERIZAR AGENDAMENTOS NA TABELA (ATIVOS)
        function carregarAgendamentos() {
            const lista = document.getElementById('lista-agendamentos');
            lista.innerHTML = '';
            
            const dataFiltro = document.getElementById('filtro-agenda-data').value;
            
            let agendamentosFiltrados = agendamentosAtivos;

            if (dataFiltro) {
                agendamentosFiltrados = agendamentosFiltrados.filter(a => a.data === dataFiltro);
            }
            
            // Ordenar por data e hora
            agendamentosFiltrados.sort((a, b) => {
                 if (a.data !== b.data) {
                     return new Date(a.data) - new Date(b.data);
                 }
                 return a.hora.localeCompare(b.hora);
            });
            
            if (agendamentosFiltrados.length === 0) {
                lista.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nenhum agendamento ativo encontrado.</td></tr>';
                return;
            }

            agendamentosFiltrados.forEach(agendamento => {
                const tipoDisplay = agendamento.tipo === 'pacote' ? 
                    `<span style="color: var(--primary-color); font-weight: bold;">Uso de Pacote (R$ 0,00)</span>` : 
                    `Serviço Individual (R$ ${agendamento.valor.toFixed(2)})`;
                    
                const row = lista.insertRow();
                row.dataset.clienteNome = agendamento.clienteNome.toLowerCase();
                
                row.innerHTML = `
                    <td data-label="Data/Hora">${new Date(agendamento.data).toLocaleDateString()} ${agendamento.hora} - ${agendamento.horaFim}</td>
                    <td data-label="Cliente">${agendamento.clienteNome}</td>
                    <td data-label="Serviço">${agendamento.servicoNome}<br>${tipoDisplay}</td>
                    <td data-label="Status"><span style="color: var(--primary-color); font-weight: bold;">Ativo</span></td>
                    <td class="action-buttons" data-label="Ações">
                        <button class="btn-success" onclick="finalizarAgendamento('${agendamento.id}')"><span class="material-icons">check_circle</span> Finalizar</button>
                        <button class="btn-warning" onclick="editarAgendamento('${agendamento.id}')"><span class="material-icons">edit</span> Editar</button>
                        <button class="btn-danger" onclick="excluirAgendamento('${agendamento.id}')"><span class="material-icons">delete</span> Excluir</button>
                    </td>
                `;
            });
            filtrarAgendamentos(); // Aplica o filtro de cliente
        }
        
        // 4.4. FILTRAR AGENDAMENTOS NA TABELA
        window.filtrarAgendamentos = function() {
             const filtro = document.getElementById('filtro-agenda-cliente').value.toLowerCase();
             const listaAgendamentos = document.getElementById('lista-agendamentos');
             const linhas = listaAgendamentos.getElementsByTagName('tr');

             for (let i = 0; i < linhas.length; i++) {
                 const row = linhas[i];
                 if (!row.dataset.clienteNome) continue; 

                 const clienteNome = row.dataset.clienteNome;
                
                 if (clienteNome.includes(filtro)) {
                     row.style.display = ""; // Mostra a linha
                 } else {
                     row.style.display = "none"; // Esconde a linha
                 }
             }
        }
        
        // 4.5. RESETAR FILTRO DE AGENDAMENTOS
        window.resetFiltroAgenda = function() {
            document.getElementById('filtro-agenda-data').value = ''; 
            document.getElementById('filtro-agenda-cliente').value = '';
            carregarAgendamentos();
        }

        // 4.6. EDITAR AGENDAMENTO
        window.editarAgendamento = function(agendamentoId) {
            const agendamento = allAgendamentos[agendamentoId];
            if (agendamento) {
                // 1. Muda para a aba de Novo Agendamento
                showAgendaTab('novo-agendamento'); 

                // 2. Preenche o formulário
                document.getElementById('agendamento-id').value = agendamentoId;
                document.getElementById('agendamento-pacote-id').value = agendamento.pacoteId || ''; // NOVO: Carrega o ID do pacote se houver
                document.getElementById('agenda-cliente-id').value = agendamento.clienteId;
                document.getElementById('agenda-servico-id').value = agendamento.servicoId;
                document.getElementById('agenda-data').value = agendamento.data;
                document.getElementById('agenda-hora').value = agendamento.hora;
                document.getElementById('agenda-hora-fim').value = agendamento.horaFim;
                document.getElementById('agenda-observacoes').value = agendamento.observacoes;
                
                // 3. Desabilita campos de cliente/serviço se for pacote para manter a integridade
                if (agendamento.pacoteId) {
                    document.getElementById('agenda-cliente-id').disabled = true;
                    document.getElementById('agenda-servico-id').disabled = true;
                    document.getElementById('btn-salvar-agendamento').innerHTML = '<span class="material-icons">save</span> Salvar Edição do Uso do Pacote';
                } else {
                    document.getElementById('agenda-cliente-id').disabled = false;
                    document.getElementById('agenda-servico-id').disabled = false;
                    document.getElementById('btn-salvar-agendamento').innerHTML = '<span class="material-icons">save</span> Salvar Edição';
                }
                
                // 4. Atualiza o botão para indicar edição
                document.getElementById('btn-salvar-agendamento').classList.remove('btn-success');
                document.getElementById('btn-salvar-agendamento').classList.add('btn-warning');
                showNotification(`Editando agendamento: ${agendamento.servicoNome} para ${agendamento.clienteNome}`, 'info');
            }
        }

        // 4.7. EXCLUIR AGENDAMENTO
        window.excluirAgendamento = function(agendamentoId) {
            const agendamento = allAgendamentos[agendamentoId];
            if (confirm(`Tem certeza que deseja EXCLUIR o agendamento de ${agendamento.clienteNome} (${agendamento.servicoNome})?`)) {
                db.ref('agendamentos/' + agendamentoId).remove()
                    .then(() => {
                        showNotification('Agendamento excluído com sucesso!', 'success');
                    })
                    .catch(error => showNotification('Erro ao excluir agendamento: ' + error.message, 'error'));
            }
        }
        
        // 4.8. FINALIZAR AGENDAMENTO (MOVE PARA HISTÓRICO E ATUALIZA PACOTE)
        window.finalizarAgendamento = async function(agendamentoId) {
            if (!confirm('Confirmar a FINALIZAÇÃO deste agendamento? Ele será movido para o Histórico/Lucros.')) return;
            
            try {
                // 1. Atualiza o status do agendamento para 'finalizado'
                await db.ref('agendamentos/' + agendamentoId).update({
                    status: 'finalizado',
                    dataFinalizacao: new Date().toISOString().split('T')[0] // Data de hoje
                });

                const agendamento = allAgendamentos[agendamentoId];
                
                // 2. **NOVO**: Lidar com o Incremento de Uso do Pacote (Item 3a)
                if (agendamento && agendamento.pacoteId) {
                    const pacoteId = agendamento.pacoteId;
                    const pacoteRef = db.ref('pacotes_ativos/' + pacoteId);
                    const pacoteSnapshot = await pacoteRef.once('value');
                    const pacote = pacoteSnapshot.val();
                    
                    if (pacote) {
                        const novaQuantidadeUsada = (pacote.quantidadeUsada || 0) + 1;
                        let updateData = {
                            quantidadeUsada: novaQuantidadeUsada,
                        };
                        
                        // Verifica se o pacote foi finalizado
                        if (novaQuantidadeUsada >= pacote.quantidadeTotal) {
                            updateData.statusPacote = 'finalizado';
                            showNotification(`Pacote do cliente ${agendamento.clienteNome} FINALIZADO!`, 'info');
                        }
                        
                        await pacoteRef.update(updateData);
                        showNotification('Uso do pacote contabilizado com sucesso!', 'success');
                    }
                }
                // FIM DO TRATAMENTO DE PACOTE

                showNotification('Agendamento finalizado com sucesso e movido para Histórico!', 'success');
                // Não precisa chamar carregarAgendamentos() e carregarPacotesAtivos() aqui, pois os listeners do Firebase farão isso
                
            } catch (error) {
                showNotification('Erro ao finalizar agendamento: ' + error.message, 'error');
            }
        }
        
        // ----------------------------------------------------------------------------------
        // 5. VISÃO DIÁRIA DA AGENDA
        // ----------------------------------------------------------------------------------

        // 5.1. VERIFICA SE O HORÁRIO ESTÁ OCUPADO
        function isTimeSlotOccupied(horario, agendamentosDoDia) {
            const [horaSlot, minutoSlot] = horario.split(':').map(Number);
            
            for (const agendamento of agendamentosDoDia) {
                const [horaInicio, minutoInicio] = agendamento.hora.split(':').map(Number);
                const [horaFim, minutoFim] = agendamento.horaFim.split(':').map(Number);
                
                const inicioMinutos = horaInicio * 60 + minutoInicio;
                const fimMinutos = horaFim * 60 + minutoFim;
                const slotMinutos = horaSlot * 60 + minutoSlot;
                const slotFimMinutos = slotMinutos + 30; // O slot dura 30 minutos

                // Verifica se o slot se sobrepõe ao agendamento
                // (Slot começa antes do agendamento terminar E Slot termina depois do agendamento começar)
                if (slotMinutos < fimMinutos && slotFimMinutos > inicioMinutos) {
                    return agendamento; // Retorna o agendamento que ocupa o slot
                }
            }
            return null;
        }

        // 5.2. RENDERIZAR VISÃO DIÁRIA
        window.renderizarVisaoDiaria = function(data = null) {
            const lista = document.getElementById('lista-visao-diaria');
            const inputData = document.getElementById('filtro-visao-diaria-data');
            
            const dataSelecionada = data || inputData.value;
            inputData.value = dataSelecionada; // Garante que o input reflita a data

            if (!dataSelecionada) {
                lista.innerHTML = '<tr><td colspan="2" style="text-align: center;">Selecione uma data para visualizar.</td></tr>';
                return;
            }
            
            lista.innerHTML = '';
            
            // Filtra agendamentos ATIVOS do dia (Inclui usos de Pacote, Item 6b)
            const agendamentosDoDia = agendamentosAtivos.filter(a => a.data === dataSelecionada);

            // Geração de horários (Item 6a: 07:00 até 22:00)
            let horarios = [];
            for (let h = 7; h <= 21; h++) {
                horarios.push(`${String(h).padStart(2, '0')}:00`);
                if (h < 21) { // Garante que 21:30 é o último slot
                    horarios.push(`${String(h).padStart(2, '0')}:30`);
                }
            }
            
            horarios.forEach(horario => {
                const row = lista.insertRow();
                const ocupacao = isTimeSlotOccupied(horario, agendamentosDoDia);
                
                row.innerHTML = `<td class="horario-celula">${horario}</td>`;
                
                const detalhesCell = row.insertCell();
                detalhesCell.dataset.label = "Detalhes";

                if (ocupacao) {
                    const tipo = ocupacao.tipo === 'pacote' ? 
                        `<span style="color: var(--info-color);">Uso de Pacote</span>` : 
                        `<span style="color: var(--success-color);">Serviço Individual</span>`;

                    detalhesCell.classList.add('agendamento-ocupado');
                    detalhesCell.title = `Clique para editar o agendamento de ${ocupacao.clienteNome}.`;
                    detalhesCell.setAttribute('onclick', `editarAgendamento('${ocupacao.id}')`);
                    
                    detalhesCell.innerHTML = `
                        <strong>${ocupacao.clienteNome}</strong> - ${ocupacao.servicoNome}<br>
                        ${tipo} | ${ocupacao.hora} - ${ocupacao.horaFim}
                    `;
                } else {
                    detalhesCell.classList.add('agendamento-vago');
                    detalhesCell.textContent = 'LIVRE';
                }
            });
        }
        
        // ----------------------------------------------------------------------------------
        // 6. HISTÓRICO / LUCROS
        // ----------------------------------------------------------------------------------
        
        // 6.1. RENDERIZAR HISTÓRICO E CALCULAR LUCRO
        window.renderizarHistorico = function() {
            const lista = document.getElementById('lista-historico');
            lista.innerHTML = '';
            
            const filtroMes = document.getElementById('filtro-historico-mes').value; // Formato YYYY-MM
            let lucroTotal = 0;

            // Filtra agendamentos finalizados. **NOVO**: Inclui apenas Individual e Pagamento de Pacote (Item 3b)
            const historicoFiltrado = Object.keys(allAgendamentos)
                .map(id => ({ id, ...allAgendamentos[id] }))
                .filter(a => a.status === 'finalizado' && (a.tipo === 'individual' || a.tipo === 'pagamento_pacote'))
                .filter(a => {
                    if (!filtroMes) return true;
                    // Compara YYYY-MM da dataFinalizacao ou data (para pagamentos de pacote)
                    return a.dataFinalizacao && a.dataFinalizacao.startsWith(filtroMes) || (a.data && a.data.startsWith(filtroMes));
                })
                .sort((a, b) => new Date(b.dataFinalizacao || b.data) - new Date(a.dataFinalizacao || a.data)); // Ordena pela data mais recente

            if (historicoFiltrado.length === 0) {
                lista.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nenhum histórico encontrado para o filtro.</td></tr>';
                document.getElementById('resumo-lucros').textContent = 'R$ 0,00';
                return;
            }

            historicoFiltrado.forEach(agendamento => {
                const dataDisplay = agendamento.dataFinalizacao ? new Date(agendamento.dataFinalizacao).toLocaleDateString() : new Date(agendamento.data).toLocaleDateString();
                const valor = parseFloat(agendamento.valor || 0);
                lucroTotal += valor;

                const tipoLucro = agendamento.tipo === 'pagamento_pacote' ? 
                    `<span style="color: var(--success-color); font-weight: bold;">Pagamento Pacote</span>` : 
                    'Serviço Individual';
                
                // Botão para reverter só deve aparecer em agendamentos individuais/pacotes, não na transação de pagamento
                const acaoReverter = agendamento.tipo !== 'pagamento_pacote' ? 
                    `<button class="btn-info" onclick="reverterFinalizacao('${agendamento.id}')"><span class="material-icons">undo</span> Reverter</button>` :
                    `<button class="btn-secondary" disabled title="Transação de Pagamento."><span class="material-icons">paid</span> Transação</button>`;

                const row = lista.insertRow();
                row.dataset.clienteNome = agendamento.clienteNome.toLowerCase();

                row.innerHTML = `
                    <td data-label="Data">${dataDisplay}</td>
                    <td data-label="Cliente">${agendamento.clienteNome}</td>
                    <td data-label="Serviço">${agendamento.servicoNome}<br>(${tipoLucro})</td>
                    <td data-label="Valor"><span style="color: var(--success-color); font-weight: bold;">R$ ${valor.toFixed(2)}</span></td>
                    <td class="action-buttons" data-label="Ações">
                        ${acaoReverter}
                    </td>
                `;
            });

            document.getElementById('resumo-lucros').textContent = `R$ ${lucroTotal.toFixed(2)}`;
            filtrarHistoricoTabela(); // Aplica o filtro de cliente
        }
        
        // 6.2. FILTRAR HISTÓRICO NA TABELA
        window.filtrarHistoricoTabela = function() {
             const filtro = document.getElementById('filtro-historico-cliente').value.toLowerCase();
             const listaHistorico = document.getElementById('lista-historico');
             const linhas = listaHistorico.getElementsByTagName('tr');

             for (let i = 0; i < linhas.length; i++) {
                 const row = linhas[i];
                 if (!row.dataset.clienteNome) continue; 

                 const clienteNome = row.dataset.clienteNome;
                
                 if (clienteNome.includes(filtro)) {
                     row.style.display = ""; // Mostra a linha
                 } else {
                     row.style.display = "none"; // Esconde a linha
                 }
             }
        }
        
        // 6.3. RESETAR FILTRO DO HISTÓRICO
        window.resetFiltroHistorico = function() {
            document.getElementById('filtro-historico-mes').value = ''; 
            document.getElementById('filtro-historico-cliente').value = '';
            renderizarHistorico();
        }

        // 6.4. REVERTER FINALIZAÇÃO (Move de volta para Ativo)
        window.reverterFinalizacao = async function(agendamentoId) {
            const agendamento = allAgendamentos[agendamentoId];
            if (!confirm(`Tem certeza que deseja REVERTER a finalização do agendamento de ${agendamento.clienteNome}? Ele voltará para a lista de Agendamentos Ativos.`)) return;

            try {
                 // 1. Atualiza o status do agendamento para 'ativo'
                 await db.ref('agendamentos/' + agendamentoId).update({
                     status: 'ativo',
                     dataFinalizacao: null
                 });

                 // 2. **NOVO**: Reverte o incremento de uso do pacote (se for um uso de pacote)
                 if (agendamento && agendamento.pacoteId && agendamento.tipo === 'pacote') {
                    const pacoteId = agendamento.pacoteId;
                    const pacoteRef = db.ref('pacotes_ativos/' + pacoteId);
                    const pacoteSnapshot = await pacoteRef.once('value');
                    const pacote = pacoteSnapshot.val();
                    
                    if (pacote) {
                        const novaQuantidadeUsada = Math.max(0, (pacote.quantidadeUsada || 0) - 1); // Garante que não é negativo
                        let updateData = {
                            quantidadeUsada: novaQuantidadeUsada,
                        };
                        
                        // Reativa o pacote se ele estava finalizado
                        if (pacote.statusPacote === 'finalizado') {
                             updateData.statusPacote = 'ativo';
                        }
                        
                        await pacoteRef.update(updateData);
                        showNotification('Uso do pacote revertido com sucesso!', 'info');
                    }
                 }
                 
                 showNotification('Agendamento revertido para ATIVO com sucesso!', 'success');
                 // O listener de agendamentos fará o recarregamento do histórico e lista de ativos
                 
            } catch (error) {
                 showNotification('Erro ao reverter: ' + error.message, 'error');
            }
        }


        // ----------------------------------------------------------------------------------
        // CONTROLES DE LOGIN
        // ----------------------------------------------------------------------------------
        
        function showLogin() {
            document.getElementById('app-container').style.display = 'none';
            document.getElementById('login-container').style.display = 'flex';
        }
        
        function showApp() {
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('app-container').style.display = 'flex';
            // Carrega os dados iniciais do app
            showSection('agenda-section');
        }
        
        document.getElementById('login-form').addEventListener('submit', (e) => {
    e.preventDefault();
    const senha = document.getElementById('loginSenha').value;
    
    if (senha === senhaAcesso) {
         showApp();
         // A notificação de sucesso foi removida temporariamente
    } else {
         // A notificação de erro foi removida temporariamente
    }
});
        
        document.getElementById('logout-button').addEventListener('click', () => {
            showLogin();
            showNotification('Sessão encerrada.', 'info');
        });


        // ----------------------------------------------------------------------------------
        // INICIALIZAÇÃO
        // ----------------------------------------------------------------------------------
        document.addEventListener('DOMContentLoaded', () => {
             // Mostra a tela de login ao carregar a página
            showLogin();
        });
    </script>
</body>
</html>



