<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tati Manicure - Gerenciamento de Agendamentos</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #ff8c6b; /* Cor de Destaque (Salmão/Coral) */
            --secondary-color: #6c757d; /* Cinza para secundários */
            --background-color: #f4f7f6; /* Fundo Suave */
            --sidebar-bg: #ffffff;
            --sidebar-hover-bg: #fff0eb; /* Fundo mais claro para hover */
            --text-color: #343a40; /* Texto Principal (Escuro) */
            --success-color: #28a745;
            --info-color: #17a2b8;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --border-color: #e9ecef;
            --shadow-color: rgba(0, 0, 0, 0.05);
        }

        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            min-height: 100vh;
        }

        /* Estrutura do App */
        #login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            background-color: var(--primary-color);
            min-height: 100vh;
        }

        .login-card {
            background: var(--sidebar-bg);
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 15px var(--shadow-color);
            text-align: center;
            width: 100%;
            max-width: 400px;
        }

        .login-card h1 {
            color: var(--primary-color);
            margin-bottom: 30px;
            font-size: 1.8rem;
        }

        #app-container {
            display: none; /* Escondido por padrão, mostrado após o login */
            width: 100%;
            /* display: flex; REMOVIDO PARA SER ATIVADO VIA JS APÓS LOGIN */
        }

        /* Barra Lateral (Sidebar) */
        .sidebar {
            width: 250px;
            background-color: var(--sidebar-bg);
            box-shadow: 2px 0 5px var(--shadow-color);
            display: flex;
            flex-direction: column;
            padding: 20px 0;
            flex-shrink: 0;
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
            color: var(--primary-color);
            font-size: 1.6rem;
            font-weight: bold;
        }

        .sidebar ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar ul li a {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            text-decoration: none;
            color: var(--text-color);
            transition: background-color 0.2s, color 0.2s;
            font-weight: 500;
        }

        .sidebar ul li a:hover,
        .sidebar ul li a.active {
            background-color: var(--sidebar-hover-bg);
            color: var(--primary-color);
        }

        .sidebar ul li a .material-icons {
            margin-right: 10px;
            font-size: 20px;
        }

        .user-info {
            margin-top: auto;
            padding: 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .user-info p {
            margin: 0 0 10px 0;
            font-weight: bold;
        }

        /* Conteúdo Principal */
        .main-content {
            flex-grow: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .content-section {
            display: none;
            padding: 20px;
        }

        .content-section.active {
            display: block;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .section-header h2 {
            margin: 0;
            color: var(--text-color);
            font-size: 1.5rem;
        }
        
        /* Novas cores para Status de Pacote e Histórico */
        .status-package-paid {
             color: var(--success-color);
             font-weight: bold;
        }
        .status-package-pending {
            color: var(--warning-color);
            font-weight: bold;
        }
        .status-package-active {
            color: var(--primary-color);
            font-weight: bold;
        }
        .status-package-finalized {
            color: var(--danger-color);
            font-weight: bold;
        }
        
        /* Status do Agendamento */
        .status-pago {
            color: var(--success-color);
            font-weight: bold;
        }
        .status-pendente {
            color: var(--warning-color);
            font-weight: bold;
        }
        
        /* Cartão (Card) */
        .card {
            background: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 4px var(--shadow-color);
            margin-bottom: 20px;
        }
        
        /* BEM-VINDA (IMAGEM) - MELHORIA 1 */
        #welcome-banner {
            background: url('https://i.imgur.com/k9D7X4S.jpg') center center / cover no-repeat; /* Placeholder de Manicure */
            height: 150px;
            border-radius: 8px;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2rem;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        /* NOVO V6: Abas dentro de uma seção */
        .tab-menu {
             display: flex;
             border-bottom: 2px solid var(--border-color);
             margin-bottom: 20px;
             overflow-x: auto; /* Para mobile */
             flex-wrap: nowrap;
        }
        .tab-menu button {
             padding: 10px 20px;
             border: none;
             background: transparent;
             cursor: pointer;
             font-size: 1rem;
             color: var(--secondary-color);
             border-bottom: 2px solid transparent;
             transition: border-color 0.2s, color 0.2s;
             font-weight: bold;
             flex-shrink: 0; /* Para mobile */
        }
        .tab-menu button.active {
             color: var(--primary-color);
             border-bottom: 2px solid var(--primary-color);
        }
        .tab-content {
             padding-top: 10px;
        }
        .tab-pane {
             display: none;
        }
        .tab-pane.active {
             display: block;
        }

        /* Formulários */
        .form-group {
            margin-bottom: 15px;
        }

        .form-row {
            display: flex;
            gap: 20px;
        }

        .form-row > div {
            flex: 1;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 0.95rem;
        }

        input[type="text"],
        input[type="number"],
        input[type="email"],
        input[type="tel"],
        input[type="date"],
        input[type="time"],
        textarea,
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        /* Datalist input */
        input[list] {
            background-image: none;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="email"]:focus,
        input[type="tel"]:focus,
        input[type="date"]:focus,
        input[type="time"]:focus,
        textarea:focus,
        select:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        textarea {
            resize: vertical;
        }

        /* Botões */
        button, .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: background-color 0.2s, opacity 0.2s;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #e57a5e;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #218838;
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: var(--text-color);
        }

        .btn-warning:hover {
            background-color: #ffb547;
        }


        /* Tabelas */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table thead tr {
            background-color: var(--primary-color);
            color: white;
            text-align: left;
        }

        .data-table th, .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table tbody tr:hover {
            background-color: var(--sidebar-hover-bg);
        }

        .data-table td.action-buttons button {
            margin-right: 5px;
            padding: 6px 8px;
        }

        .data-table td.action-buttons {
            white-space: nowrap;
        }

        /* Notificação */
        #notification-bar {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s, transform 0.3s;
            transform: translateY(-20px);
            z-index: 1000;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            font-weight: bold;
        }

        #notification-bar.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        #notification-bar.success { background-color: var(--success-color); }
        #notification-bar.error { background-color: var(--danger-color); }
        #notification-bar.info { background-color: var(--info-color); }

        /* Utilitários */
        .flex-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .input-group {
            display: flex;
            gap: 10px;
        }
        
        .input-group input, .input-group select {
            flex-grow: 1;
        }

        .filter-row {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            margin-bottom: 20px;
        }
        .filter-row > div {
            flex: 1;
        }
        .filter-row button {
            flex-grow: 0;
            flex-shrink: 0;
            padding: 9px 15px; /* Ajuste para alinhar com o input */
        }
        
        /* NOVO V7: Estilos para a Tabela de Visão Diária */
        .table-responsive {
            overflow-x: auto;
        }
        #tabela-visao-diaria {
             border: 1px solid var(--border-color);
             margin-top: 0;
             min-width: 450px; /* Garante que os detalhes não fiquem esmagados */
        }
        #tabela-visao-diaria thead tr {
             background-color: var(--secondary-color);
        }
        #tabela-visao-diaria td {
             height: 40px;
             font-size: 0.9rem;
             vertical-align: top;
        }
        .horario-celula {
             width: 80px;
             font-weight: bold;
             background-color: var(--sidebar-hover-bg);
             color: var(--text-color);
             text-align: center;
             vertical-align: middle !important;
             border-right: 1px solid var(--border-color);
        }
        .agendamento-vago {
             background-color: #f7fff7; /* Verde clarinho */
             color: var(--success-color);
             font-weight: bold;
             font-style: italic;
             text-align: center;
             line-height: 40px;
        }
        .agendamento-ocupado {
             background-color: #fff0eb; /* Fundo do hover de sidebar, suave */
             color: var(--text-color);
             font-weight: 500;
             padding: 5px 10px !important;
             vertical-align: middle !important;
             line-height: 1.2;
             border-left: 5px solid var(--primary-color);
             cursor: pointer;
        }
        .agendamento-ocupado.pacote-session {
            border-left: 5px solid var(--info-color);
        }
        .agendamento-ocupado strong {
             color: var(--primary-color);
             font-weight: bold;
        }
        .agendamento-ocupado.pacote-session strong {
             color: var(--info-color);
        }

        
        /* --------------------------------------------------- */
        /* RESPONSIVIDADE MOBILE (Mobile First - Portrait Mode)*/
        /* --------------------------------------------------- */
        @media (max-width: 768px) {
            
            /* Estrutura Principal */
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
                box-shadow: 0 0 5px var(--shadow-color);
            }

            .main-content {
                padding: 15px;
            }

            #app-container {
                flex-direction: column;
            }

            /* Navegação Horizontal */
            .sidebar ul {
                display: flex;
                flex-wrap: nowrap;
                overflow-x: auto;
                justify-content: flex-start;
                border-bottom: 1px solid var(--border-color);
            }

            .sidebar ul li {
                flex-shrink: 0; /* Impede que os itens encolham */
                text-align: center;
            }

            .sidebar ul li a {
                justify-content: center;
                padding: 10px;
                flex-direction: column;
                font-size: 0.75rem;
                white-space: nowrap;
            }

            .sidebar ul li a .material-icons {
                margin-right: 0;
                margin-bottom: 5px;
                font-size: 20px;
            }

            /* FIX: Botão Sair visível no celular */
            .user-info {
                display: block;
                padding: 10px 15px;
                border-top: none; 
                text-align: center; 
            }

            .user-info p {
                display: none; /* Esconde o texto "Olá, Tati!" para economizar espaço */
            }

            .user-info button {
                width: 100%;
                margin-top: 10px; 
                font-size: 0.9rem;
            }
            
            /* 1. Correção de Formulários e Filtros (Empilhamento) */
            .form-row, .filter-row {
                flex-direction: column;
                gap: 0; /* Remove gap quando empilha */
            }

            .form-row > div, 
            .filter-row > div {
                flex: 0 0 100% !important; /* Força largura total */
                width: 100%;
            }
            
            /* Ajusta margem para inputs empilhados */
            .form-group, .filter-row > div {
                margin-bottom: 10px;
            }
            
            .filter-row button {
                width: 100%;
                margin-top: 5px; 
                padding: 10px 15px !important;
            }
            
            /* V6: Ajuste para a Tabela de Visão Diária */
            .table-responsive {
                 overflow-x: auto;
            }
            #tabela-visao-diaria {
                 width: 100%;
                 min-width: 400px; /* Garante que não fique muito esmagada */
            }
            #tabela-visao-diaria td {
                 padding: 5px 10px !important;
            }

            /* 2. Correção de Tabelas (Cartão-like View) */
            .data-table, .data-table tbody, .data-table td, .data-table tr {
                display: block; /* Força elementos da tabela a empilhar */
            }

            .data-table thead {
                display: none; /* Esconde o cabeçalho original */
            }

            .data-table tr {
                border: 1px solid var(--border-color);
                margin-bottom: 15px;
                border-radius: 8px;
                box-shadow: 0 1px 3px var(--shadow-color);
                padding: 10px;
            }

            .data-table td {
                border: none;
                position: relative;
                padding-left: 50% !important; /* Espaço para o rótulo */
                text-align: right; /* Alinha o valor à direita */
                white-space: normal; /* Permite quebras de linha */
                min-height: 40px;
            }

            /* Rótulo customizado (que usa o data-label do JS) */
            .data-table td::before {
                content: attr(data-label);
                position: absolute;
                left: 10px;
                width: 45%; 
                padding-right: 10px;
                white-space: nowrap;
                text-align: left;
                font-weight: bold;
                color: var(--primary-color);
            }
            
            /* FIX V6: Organização dos botões de ação em mobile */
            .data-table td.action-buttons {
                text-align: left;
                padding-left: 10px !important;
                display: flex; 
                flex-direction: column; /* Empilha os botões */
                gap: 5px;
            }
            
            .data-table td.action-buttons::before {
                content: "Ações";
                width: 100%; 
                margin-bottom: 5px;
                display: block;
            }
            
            .data-table td.action-buttons button {
                margin: 0;
                width: 100%; /* Ocupa a largura toda */
                max-width: 100%;
                box-sizing: border-box;
                font-size: 0.9rem; 
                padding: 8px 5px;
            }
        }
        
        /* Modal Style */
        .modal {
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            display: none;
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 90%;
            max-width: 400px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-button:hover,
        .close-button:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <div id="notification-bar"></div>

    <div id="usarPacoteModal" class="modal">
      <div class="modal-content">
        <span class="close-button" onclick="closeModal('usarPacoteModal')">&times;</span>
        <h3>Registrar Uso do Pacote</h3>
        <p>Cliente: <strong id="modal-pacote-cliente-nome"></strong></p>
        <p>Pacote: <strong id="modal-pacote-servico-nome"></strong></p>
        
        <form id="pacote-uso-form">
            <input type="hidden" id="modal-pacote-id">
            
            <div class="form-group">
                <label for="pacote-uso-data">Data</label>
                <input type="date" id="pacote-uso-data" required>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="pacote-uso-hora-inicio">Hora Início</label>
                    <input type="time" id="pacote-uso-hora-inicio" required>
                </div>
                <div class="form-group">
                    <label for="pacote-uso-hora-fim">Hora Fim</label>
                    <input type="time" id="pacote-uso-hora-fim" required>
                </div>
            </div>
            
            <button type="submit" class="btn-primary" style="width: 100%;">
                <span class="material-icons">check_circle</span> Registrar Uso
            </button>
        </form>
      </div>
    </div>

    <div id="login-container">
        <div class="login-card">
            <h1>Tati Manicure - Acesso</h1>
            <form id="login-form">
                <div class="form-group">
                    <label for="loginSenha">Senha de Acesso</label>
                    <input type="password" id="loginSenha" required>
                </div>
                <button type="submit" class="btn-primary" style="width: 100%; margin-top: 10px;">
                    <span class="material-icons">login</span> Entrar
                </button>
            </form>
        </div>
    </div>

    <datalist id="clientes-datalist"></datalist>

    <div id="app-container">
        
        <aside class="sidebar">
            <div class="logo">TATI MANICURE APP</div>
            
            <ul>
                <li><a href="#" data-section="agenda" class="active"><span class="material-icons">calendar_today</span> Agenda</a></li>
                <li><a href="#" data-section="clientes"><span class="material-icons">people</span> Clientes</a></li>
                <li><a href="#" data-section="servicos"><span class="material-icons">local_offer</span> Serviços</a></li>
                <li><a href="#" data-section="historico"><span class="material-icons">history</span> Histórico/Lucros</a></li>
            </ul>

            <div class="user-info">
                <p id="userInfo">Olá, Tati!</p>
                <button id="logout-button" class="btn-danger" style="width: 100%;">
                    <span class="material-icons">logout</span> Sair
                </button>
            </div>
        </aside>

        <main class="main-content">
            
            <div id="welcome-banner">
                <span>Bem-Vinda, Tati! Sua Agenda Digital.</span>
            </div>

            <div id="agenda-section" class="content-section active">
                
                <div class="tab-menu">
                    <button class="tab-button active" onclick="showAgendaTab('pacotes-ativos', event)">Pacotes Ativos</button>
                    <button class="tab-button" onclick="showAgendaTab('novo-agendamento', event)">Novo Agendamento</button>
                    <button class="tab-button" onclick="showAgendaTab('lista-agendamentos', event)">Lista Agendamentos</button>
                    <button class="tab-button" onclick="showAgendaTab('visao-diaria', event)">Visão Diária</button>
                </div>
                
                <div class="tab-content">
                    
                    <div id="pacotes-ativos-pane" class="tab-pane active">
                        <div class="section-header"><h2>Gerenciamento de Pacotes Ativos</h2></div>
                        
                        <div class="card">
                            <form id="pacote-inicio-form">
                                <h3>Iniciar Novo Pacote de Serviços</h3>
                                <div class="form-row">
                                    <div class="form-group" style="flex: 2;">
                                        <label for="pacote-cliente-id">Cliente</label>
                                        <select id="pacote-cliente-id" required></select>
                                    </div>
                                    <div class="form-group" style="flex: 2;">
                                        <label for="pacote-servico-id">Pacote (Serviços marcados como Pacote)</label>
                                        <select id="pacote-servico-id" required></select>
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label for="pacote-data-inicio">Data Início (Geralmente Hoje)</label>
                                        <input type="date" id="pacote-data-inicio" required>
                                    </div>
                                </div>

                                <div class="flex-container">
                                    <button type="submit" class="btn-primary">
                                        <span class="material-icons">add_box</span> Iniciar/Vender Pacote
                                    </button>
                                </div>
                            </form>
                            
                            <hr style="margin: 20px 0;">

                            <h3>Pacotes Ativos e Utilização</h3>
                            <div style="max-height: 500px; overflow-y: auto;">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 20%;">Cliente</th>
                                            <th style="width: 25%;">Pacote (Total/Usado)</th>
                                            <th style="width: 15%;">Pagamento</th>
                                            <th style="width: 15%;">Vencimento</th>
                                            <th style="width: 200px;">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="lista-pacotes-ativos">
                                        <tr><td colspan="5" style="text-align: center;">Carregando pacotes ativos...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div id="novo-agendamento-pane" class="tab-pane">
                        <div class="section-header"><h2>Agendamento de Serviços Individuais (Não-Pacote)</h2></div>
                        <div class="card">
                            <form id="agendamento-form">
                                <input type="hidden" id="agendamento-id">
                                
                                <div class="form-row">
                                    <div class="form-group" style="flex: 2;">
                                        <label for="agenda-cliente-id">Cliente</label>
                                        <select id="agenda-cliente-id" required></select>
                                    </div>
                                    <div class="form-group" style="flex: 2;">
                                        <label for="agenda-servico-id">Serviço Individual/Promoção</label>
                                        <select id="agenda-servico-id" required></select>
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label for="agenda-data">Data</label>
                                        <input type="date" id="agenda-data" required>
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="form-group" style="flex: 1;">
                                        <label for="agenda-hora">Hora Início</label>
                                        <input type="time" id="agenda-hora" required>
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label for="agenda-hora-fim">Hora Fim</label>
                                        <input type="time" id="agenda-hora-fim" required>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="agenda-observacoes">Observações</label>
                                    <textarea id="agenda-observacoes" rows="2"></textarea>
                                </div>

                                <div class="flex-container">
                                    <div>
                                        <button type="submit" class="btn-success" id="btn-salvar-agendamento">
                                            <span class="material-icons">save</span> Salvar Agendamento
                                        </button>
                                        <button type="button" class="btn-secondary" onclick="resetAgendamentoForm()">
                                            <span class="material-icons">refresh</span> Limpar
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <div id="lista-agendamentos-pane" class="tab-pane">
                        <div class="section-header">
                            <h3>Próximos Agendamentos Individuais (Ativos)</h3>
                        </div>
                        <div class="card">
                            <div class="filter-row">
                                <div style="flex-grow: 1.5;">
                                    <label for="filtro-agenda-data">Filtrar por Data</label>
                                    <input type="date" id="filtro-agenda-data" onchange="carregarAgendamentos()">
                                </div>
                                <div style="flex-grow: 3;">
                                    <label for="filtro-agenda-cliente">Filtrar por Cliente (Digite ou Selecione)</label>
                                    <input type="text" id="filtro-agenda-cliente" list="clientes-datalist" placeholder="Digite o nome do cliente..." onkeyup="filtrarAgendamentos()">
                                </div>
                                <button class="btn-secondary" onclick="resetFiltroAgenda()"><span class="material-icons">refresh</span> Resetar Filtro</button>
                            </div>
                            <div style="max-height: 500px; overflow-y: auto;">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 15%;">Data/Hora</th>
                                            <th style="width: 25%;">Cliente</th>
                                            <th style="width: 25%;">Serviço</th>
                                            <th>Status</th>
                                            <th style="width: 150px;">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="lista-agendamentos">
                                        <tr><td colspan="5" style="text-align: center;">Carregando agendamentos...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div id="visao-diaria-pane" class="tab-pane">
                        <div class="section-header">
                            <h2>Visão Diária da Agenda</h2>
                        </div>
                        <div class="card">
                            <div class="filter-row">
                                <div style="flex-grow: 1;">
                                    <label for="filtro-visao-diaria-data">Selecione a Data</label>
                                    <input type="date" id="filtro-visao-diaria-data" onchange="renderizarVisaoDiaria()">
                                </div>
                                <button class="btn-secondary" onclick="renderizarVisaoDiaria(true)"><span class="material-icons">today</span> Ver Hoje</button>
                            </div>
                            <div class="table-responsive">
                                <table class="data-table" id="tabela-visao-diaria">
                                    <thead>
                                        <tr>
                                            <th style="width: 100px;">Horário</th>
                                            <th>Detalhes do Agendamento</th>
                                        </tr>
                                    </thead>
                                    <tbody id="lista-visao-diaria">
                                        <tr><td colspan="2" style="text-align: center;">Selecione uma data para visualizar.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                </div>
            </div>

            <div id="clientes-section" class="content-section">
                <div class="section-header"><h2>Cadastro de Clientes</h2></div>
                <div class="card">
                    <form id="cliente-form">
                        <input type="hidden" id="cliente-id">
                        <div class="form-row">
                            <div class="form-group" style="flex: 2;">
                                <label for="cliente-nome">Nome Completo</label>
                                <input type="text" id="cliente-nome" required>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label for="cliente-telefone">Telefone (Whatsapp)</label>
                                <input type="tel" id="cliente-telefone">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="cliente-email">E-mail (Opcional)</label>
                            <input type="email" id="cliente-email">
                        </div>
                        <div class="form-group">
                            <label for="cliente-endereco">Endereço (Opcional)</label>
                            <input type="text" id="cliente-endereco">
                        </div>
                        <div class="form-group">
                            <label for="cliente-observacoes">Observações (Alergias, Preferências)</label>
                            <textarea id="cliente-observacoes" rows="2"></textarea>
                        </div>
                        <div class="flex-container">
                            <div>
                                <button type="submit" class="btn-success" id="btn-salvar-cliente">
                                    <span class="material-icons">save</span> Salvar Cliente
                                </button>
                                <button type="button" class="btn-secondary" onclick="resetClienteForm()">
                                    <span class="material-icons">refresh</span> Limpar
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="section-header">
                    <h3>Lista de Clientes Cadastrados</h3>
                    <div class="input-group" style="width: 300px;">
                        <input type="text" id="filtro-clientes" list="clientes-datalist" placeholder="Filtrar por nome, tel ou email..." onkeyup="filtrarClientes()">
                    </div>
                </div>
                <div class="card">
                    <div style="max-height: 500px; overflow-y: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th style="width: 30%;">Nome</th>
                                    <th style="width: 20%;">Telefone</th>
                                    <th style="width: 30%;">E-mail</th>
                                    <th style="width: 150px;">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="lista-clientes">
                                <tr><td colspan="4" style="text-align: center;">Carregando clientes...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="servicos-section" class="content-section">
                <div class="section-header"><h2>Cadastro de Serviços/Pacotes</h2></div>
                <div class="card">
                    <form id="servico-form">
                        <input type="hidden" id="servico-id">
                        <div class="form-row">
                            <div class="form-group" style="flex: 2;">
                                <label for="servico-nome">Nome do Serviço</label>
                                <input type="text" id="servico-nome" required>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label for="servico-preco">Preço (R$)</label>
                                <input type="number" id="servico-preco" step="0.01" min="0" required value="0.00">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <label>
                                    <input type="checkbox" id="servico-isPacote"> É um **Pacote Mensal**?
                                </label>
                            </div>
                            <div class="form-group" id="group-quantidade-total" style="flex: 1; display: none;">
                                <label for="servico-quantidade-total">Total de Procedimentos no Pacote (ex: 6)</label>
                                <input type="number" id="servico-quantidade-total" min="1" value="1">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="servico-descricao">Descrição Detalhada (ex: 4 Mãos e 2 Pés)</label>
                            <textarea id="servico-descricao" rows="2"></textarea>
                        </div>
                        <div class="flex-container">
                            <div>
                                <button type="submit" class="btn-success" id="btn-salvar-servico">
                                    <span class="material-icons">save</span> Salvar Serviço
                                </button>
                                <button type="button" class="btn-secondary" onclick="resetServicoForm()">
                                    <span class="material-icons">refresh</span> Limpar
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="section-header">
                    <h3>Lista de Serviços e Preços</h3>
                </div>
                <div class="card">
                    <div style="max-height: 500px; overflow-y: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th style="width: 40%;">Serviço</th>
                                    <th style="width: 15%;">Tipo</th>
                                    <th style="width: 15%;">Total Proc.</th>
                                    <th style="width: 15%;">Preço</th>
                                    <th style="width: 150px;">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="lista-servicos">
                                <tr><td colspan="5" style="text-align: center;">Carregando serviços...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="historico-section" class="content-section">
                <div class="section-header"><h2>Histórico de Agendamentos e Lucros Mensais</h2></div>
                <div class="card" style="margin-bottom: 30px;">
                    <h3>Resumo de Lucros</h3>
                    <table class="data-table" id="tabela-lucros-mensais">
                        <thead>
                            <tr>
                                <th style="width: 25%;">Mês/Ano</th>
                                <th style="width: 25%;">Total Agendamentos</th>
                                <th style="width: 25%;">Lucro Total (R$)</th>
                                <th style="width: 25%;">Detalhes</th>
                            </tr>
                        </thead>
                        <tbody id="lista-lucros-mensais">
                            <tr><td colspan="4" style="text-align: center;">Carregando resumo financeiro...</td></tr>
                        </tbody>
                    </table>
                </div>

                <div class="section-header">
                    <h3>Histórico Completo</h3>
                </div>
                <div class="card">
                    <div class="filter-row">
                        <div style="flex-grow: 1;">
                            <label for="filtro-historico-mes">Filtrar por Mês (Lucros)</label>
                            <input type="month" id="filtro-historico-mes" onchange="renderizarHistorico()">
                        </div>
                        <div style="flex-grow: 2;">
                            <label for="filtro-historico-cliente">Filtrar Cliente</label>
                            <input type="text" id="filtro-historico-cliente" list="clientes-datalist" placeholder="Digite o nome do cliente..." onkeyup="filtrarHistoricoTabela()">
                        </div>
                        <button class="btn-secondary" onclick="resetFiltroHistorico()"><span class="material-icons">refresh</span> Resetar Filtro</button>
                    </div>
                    <div style="max-height: 500px; overflow-y: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th style="width: 15%;">Data/Hora</th>
                                    <th style="width: 25%;">Cliente</th>
                                    <th style="width: 25%;">Serviço</th>
                                    <th style="width: 10%;">Valor (R$)</th>
                                    <th style="width: 150px;">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="lista-historico">
                                <tr><td colspan="5" style="text-align: center;">Carregando histórico...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
        import { getDatabase, ref, onValue, push, set, update, remove, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

        // ==================================================================================
        // CONFIGURAÇÃO FIREBASE E VARIÁVEIS GLOBAIS
        // ==================================================================================
        
        // **IMPORTANTE**: Substitua com a sua configuração real do Firebase
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            databaseURL: "https://YOUR_PROJECT_ID-default-rtdb.firebaseio.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        
        // Inicializa o Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // NÓS DO BANCO DE DADOS
        const DB_NODES = {
            CLIENTES: 'clientes',
            SERVICOS: 'servicos',
            AGENDAMENTOS: 'agendamentos', // Agendamentos Individuais
            PACOTES_ATIVOS: 'pacotes_ativos',
            PACOTE_SESSOES: 'pacote_sessoes', // Novo: Uso de Pacotes
            HISTORICO: 'historico', // Recebe Agendamentos Pagos e Pagamento de Pacotes
            LOGIN: 'login' // Nó para a senha de acesso
        };

        // Dados Locais (Caches)
        let clientes = {};
        let servicos = {};
        let agendamentosIndividuais = {};
        let pacotesAtivos = {};
        let pacoteSessoes = {};
        let historicoCompleto = {};

        // Variável da Senha
        const SENHA_DE_ACESSO = "tati123"; // Senha default se não estiver no Firebase

        // ==================================================================================
        // FUNÇÕES DE UTILIDADE
        // ==================================================================================

        function showNotification(message, type = 'info', duration = 3000) {
            const bar = document.getElementById('notification-bar');
            bar.textContent = message;
            bar.className = `notification show ${type}`;
            setTimeout(() => {
                bar.classList.remove('show');
            }, duration);
        }

        function formatarMoeda(valor) {
            return parseFloat(valor).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        function formatarData(data) {
            if (!data) return '';
            const [year, month, day] = data.split('-');
            return `${day}/${month}/${year}`;
        }

        function getHoje() {
            return new Date().toISOString().slice(0, 10);
        }

        // ==================================================================================
        // CONTROLE DE SEÇÕES E TABS
        // ==================================================================================

        function showLogin() {
            document.getElementById('login-container').style.display = 'flex';
            document.getElementById('app-container').style.display = 'none';
        }

        function showApp() {
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('app-container').style.display = 'flex';
            
            // Inicializa a Visão Diária para a data atual
            const hoje = getHoje();
            document.getElementById('filtro-visao-diaria-data').value = hoje;
            renderizarVisaoDiaria();
            
            // Tenta carregar a seção 'agenda' (pacotes ativos) por padrão
            showSection('agenda-section');
        }

        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');

            document.querySelectorAll('.sidebar ul li a').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector(`.sidebar ul li a[data-section="${sectionId.replace('-section', '')}"]`).classList.add('active');
            
            // Ações específicas ao mudar de seção
            if (sectionId === 'agenda-section') {
                // Ao entrar em agenda, garante que a primeira tab (pacotes ativos) está ativa e renderiza
                showAgendaTab('pacotes-ativos');
            } else if (sectionId === 'historico-section') {
                renderizarHistorico();
            }
        }

        function showAgendaTab(tabId, event) {
            if (event) event.preventDefault();

            document.querySelectorAll('#agenda-section .tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });
            document.getElementById(tabId + '-pane').classList.add('active');

            document.querySelectorAll('#agenda-section .tab-button').forEach(button => {
                button.classList.remove('active');
            });
            if (event) {
                 event.currentTarget.classList.add('active');
            } else {
                 document.querySelector(`#agenda-section button[onclick*='${tabId}']`).classList.add('active');
            }
            
            if (tabId === 'visao-diaria') {
                renderizarVisaoDiaria();
            } else if (tabId === 'lista-agendamentos') {
                 carregarAgendamentos(); // Garante que a lista de agendamentos individuais está atualizada
            } else if (tabId === 'pacotes-ativos') {
                 carregarPacotesAtivos(); // Garante que a lista de pacotes está atualizada
            }
        }

        function openModal(modalId, pacoteId = null) {
             const modal = document.getElementById(modalId);
             modal.style.display = 'block';
             if (pacoteId) {
                 document.getElementById('modal-pacote-id').value = pacoteId;
                 const pacote = pacotesAtivos[pacoteId];
                 if (pacote) {
                     document.getElementById('modal-pacote-cliente-nome').textContent = pacote.clienteNome;
                     document.getElementById('modal-pacote-servico-nome').textContent = pacote.servicoNome;
                     document.getElementById('pacote-uso-data').value = getHoje();
                 }
             }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // ==================================================================================
        // LÓGICA DE AUTENTICAÇÃO
        // ==================================================================================

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const senhaInput = document.getElementById('loginSenha').value;

            // Busca a senha no Firebase (se existir)
            const loginRef = ref(database, DB_NODES.LOGIN);
            onValue(loginRef, (snapshot) => {
                const data = snapshot.val();
                let senhaCorreta = SENHA_DE_ACESSO; // Default
                if (data && data.senha) {
                    senhaCorreta = data.senha;
                }

                if (senhaInput === senhaCorreta) {
                    showApp();
                    showNotification('Login realizado com sucesso!', 'success');
                } else {
                    showNotification('Senha incorreta.', 'error');
                }
            }, { onlyOnce: true });
        });

        document.getElementById('logout-button').addEventListener('click', showLogin);

        // ==================================================================================
        // CLIENTES (CRUD e Filtro)
        // ==================================================================================

        const clientesRef = ref(database, DB_NODES.CLIENTES);

        function carregarClientes() {
            onValue(clientesRef, (snapshot) => {
                clientes = {};
                const datalist = document.getElementById('clientes-datalist');
                datalist.innerHTML = ''; // Limpa antes de carregar

                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        const cliente = childSnapshot.val();
                        cliente.id = childSnapshot.key;
                        clientes[cliente.id] = cliente;
                        
                        // Popula Datalist para filtros
                        const option = document.createElement('option');
                        option.value = cliente.nome;
                        datalist.appendChild(option);
                    });
                }
                renderizarClientes();
                popularSelectsClientes();
                // A carregarClientes() é essencial para carregarAgendamentos/Pacotes
            });
        }

        document.getElementById('cliente-form').addEventListener('submit', (e) => {
            e.preventDefault();
            salvarCliente();
        });

        function salvarCliente() {
            const id = document.getElementById('cliente-id').value;
            const nome = document.getElementById('cliente-nome').value;
            const telefone = document.getElementById('cliente-telefone').value;
            const email = document.getElementById('cliente-email').value;
            const endereco = document.getElementById('cliente-endereco').value;
            const observacoes = document.getElementById('cliente-observacoes').value;

            const clienteData = { nome, telefone, email, endereco, observacoes };

            if (id) {
                // Edição
                update(ref(database, `${DB_NODES.CLIENTES}/${id}`), clienteData)
                    .then(() => {
                        showNotification('Cliente atualizado com sucesso!', 'success');
                        resetClienteForm();
                    })
                    .catch(error => showNotification('Erro ao atualizar cliente: ' + error.message, 'error'));
            } else {
                // Novo Cadastro
                push(clientesRef, clienteData)
                    .then(() => {
                        showNotification('Cliente salvo com sucesso!', 'success');
                        resetClienteForm();
                    })
                    .catch(error => showNotification('Erro ao salvar cliente: ' + error.message, 'error'));
            }
        }

        function renderizarClientes(filtro = '') {
            const tbody = document.getElementById('lista-clientes');
            tbody.innerHTML = '';
            const clientesArray = Object.values(clientes);

            const filteredClientes = clientesArray.filter(cliente => 
                cliente.nome.toLowerCase().includes(filtro) ||
                (cliente.telefone && cliente.telefone.includes(filtro)) ||
                (cliente.email && cliente.email.toLowerCase().includes(filtro))
            );

            if (filteredClientes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">Nenhum cliente encontrado.</td></tr>';
                return;
            }

            filteredClientes.forEach(cliente => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td data-label="Nome">${cliente.nome}</td>
                    <td data-label="Telefone">${cliente.telefone || '-'}</td>
                    <td data-label="E-mail">${cliente.email || '-'}</td>
                    <td data-label="Ações" class="action-buttons">
                        <button class="btn-warning" onclick="editCliente('${cliente.id}')"><span class="material-icons">edit</span> Editar</button>
                        <button class="btn-danger" onclick="deleteCliente('${cliente.id}', '${cliente.nome}')"><span class="material-icons">delete</span> Excluir</button>
                    </td>
                `;
            });
        }

        function editCliente(id) {
            const cliente = clientes[id];
            if (!cliente) return;

            document.getElementById('cliente-id').value = id;
            document.getElementById('cliente-nome').value = cliente.nome;
            document.getElementById('cliente-telefone').value = cliente.telefone || '';
            document.getElementById('cliente-email').value = cliente.email || '';
            document.getElementById('cliente-endereco').value = cliente.endereco || '';
            document.getElementById('cliente-observacoes').value = cliente.observacoes || '';
            document.getElementById('btn-salvar-cliente').innerHTML = '<span class="material-icons">update</span> Atualizar Cliente';
        }

        function deleteCliente(id, nome) {
            if (confirm(`Tem certeza que deseja excluir o cliente ${nome}?`)) {
                remove(ref(database, `${DB_NODES.CLIENTES}/${id}`))
                    .then(() => showNotification('Cliente excluído com sucesso!', 'success'))
                    .catch(error => showNotification('Erro ao excluir cliente: ' + error.message, 'error'));
            }
        }

        function resetClienteForm() {
            document.getElementById('cliente-form').reset();
            document.getElementById('cliente-id').value = '';
            document.getElementById('btn-salvar-cliente').innerHTML = '<span class="material-icons">save</span> Salvar Cliente';
        }
        
        function filtrarClientes() {
            const filtro = document.getElementById('filtro-clientes').value.toLowerCase();
            renderizarClientes(filtro);
        }

        function popularSelectsClientes() {
            const selects = ['pacote-cliente-id', 'agenda-cliente-id'];
            
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (!select) return;
                select.innerHTML = '<option value="" disabled selected>Selecione um cliente...</option>';
                
                Object.values(clientes).forEach(cliente => {
                    const option = document.createElement('option');
                    option.value = cliente.id;
                    option.textContent = cliente.nome;
                    select.appendChild(option);
                });
            });
        }


        // ==================================================================================
        // SERVIÇOS/PACOTES (CRUD)
        // ==================================================================================

        const servicosRef = ref(database, DB_NODES.SERVICOS);

        function carregarServicos() {
            onValue(servicosRef, (snapshot) => {
                servicos = {};
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        const servico = childSnapshot.val();
                        servico.id = childSnapshot.key;
                        servicos[servico.id] = servico;
                    });
                }
                renderizarServicos();
                popularSelectsServicos();
            });
        }

        document.getElementById('servico-form').addEventListener('submit', (e) => {
            e.preventDefault();
            salvarServico();
        });
        
        document.getElementById('servico-isPacote').addEventListener('change', (e) => {
             document.getElementById('group-quantidade-total').style.display = e.target.checked ? 'block' : 'none';
        });

        function salvarServico() {
            const id = document.getElementById('servico-id').value;
            const nome = document.getElementById('servico-nome').value;
            const preco = parseFloat(document.getElementById('servico-preco').value);
            const isPacote = document.getElementById('servico-isPacote').checked;
            const quantidadeTotal = isPacote ? parseInt(document.getElementById('servico-quantidade-total').value) : 1;
            const descricao = document.getElementById('servico-descricao').value;

            if (isPacote && quantidadeTotal < 1) {
                showNotification('Pacotes devem ter no mínimo 1 procedimento.', 'warning');
                return;
            }

            const servicoData = { nome, preco, isPacote, quantidadeTotal, descricao };
            
            const dbRef = id ? ref(database, `${DB_NODES.SERVICOS}/${id}`) : push(servicosRef);

            set(dbRef, servicoData)
                .then(() => {
                    showNotification(`Serviço/Pacote ${id ? 'atualizado' : 'salvo'} com sucesso!`, 'success');
                    resetServicoForm();
                })
                .catch(error => showNotification('Erro ao salvar serviço/pacote: ' + error.message, 'error'));
        }

        function renderizarServicos() {
            const tbody = document.getElementById('lista-servicos');
            tbody.innerHTML = '';
            
            if (Object.keys(servicos).length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nenhum serviço ou pacote cadastrado.</td></tr>';
                return;
            }

            Object.values(servicos).forEach(servico => {
                const tipo = servico.isPacote ? 'Pacote' : 'Individual';
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td data-label="Serviço">${servico.nome}</td>
                    <td data-label="Tipo">${tipo}</td>
                    <td data-label="Total Proc.">${servico.isPacote ? servico.quantidadeTotal : '-'}</td>
                    <td data-label="Preço">${formatarMoeda(servico.preco)}</td>
                    <td data-label="Ações" class="action-buttons">
                        <button class="btn-warning" onclick="editServico('${servico.id}')"><span class="material-icons">edit</span> Editar</button>
                        <button class="btn-danger" onclick="deleteServico('${servico.id}', '${servico.nome}')"><span class="material-icons">delete</span> Excluir</button>
                    </td>
                `;
            });
        }

        function editServico(id) {
            const servico = servicos[id];
            if (!servico) return;

            document.getElementById('servico-id').value = id;
            document.getElementById('servico-nome').value = servico.nome;
            document.getElementById('servico-preco').value = servico.preco;
            document.getElementById('servico-descricao').value = servico.descricao || '';
            document.getElementById('servico-isPacote').checked = servico.isPacote || false;
            
            // Lógica do Pacote
            document.getElementById('group-quantidade-total').style.display = servico.isPacote ? 'block' : 'none';
            document.getElementById('servico-quantidade-total').value = servico.quantidadeTotal || 1;
            
            document.getElementById('btn-salvar-servico').innerHTML = '<span class="material-icons">update</span> Atualizar Serviço';
        }

        function deleteServico(id, nome) {
            if (confirm(`Tem certeza que deseja excluir o serviço/pacote ${nome}?`)) {
                remove(ref(database, `${DB_NODES.SERVICOS}/${id}`))
                    .then(() => showNotification('Serviço/Pacote excluído com sucesso!', 'success'))
                    .catch(error => showNotification('Erro ao excluir serviço/pacote: ' + error.message, 'error'));
            }
        }

        function resetServicoForm() {
            document.getElementById('servico-form').reset();
            document.getElementById('servico-id').value = '';
            document.getElementById('group-quantidade-total').style.display = 'none';
            document.getElementById('btn-salvar-servico').innerHTML = '<span class="material-icons">save</span> Salvar Serviço';
        }

        function popularSelectsServicos() {
            const selectAgendamento = document.getElementById('agenda-servico-id');
            const selectPacote = document.getElementById('pacote-servico-id');
            
            selectAgendamento.innerHTML = '<option value="" disabled selected>Selecione um serviço individual...</option>';
            selectPacote.innerHTML = '<option value="" disabled selected>Selecione um pacote...</option>';

            Object.values(servicos).forEach(servico => {
                const option = document.createElement('option');
                option.value = servico.id;
                option.textContent = `${servico.nome} (${formatarMoeda(servico.preco)})`;
                
                if (servico.isPacote) {
                    selectPacote.appendChild(option);
                } else {
                    selectAgendamento.appendChild(option);
                }
            });
        }


        // ==================================================================================
        // AGENDAMENTOS INDIVIDUAIS (CRUD e Listagem)
        // ==================================================================================

        const agendamentosRef = query(ref(database, DB_NODES.AGENDAMENTOS), orderByChild('data'));

        function carregarAgendamentos() {
            onValue(agendamentosRef, (snapshot) => {
                agendamentosIndividuais = {};
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        const agendamento = childSnapshot.val();
                        agendamento.id = childSnapshot.key;
                        agendamentosIndividuais[agendamento.id] = agendamento;
                    });
                }
                renderizarAgendamentos();
            });
        }

        document.getElementById('agendamento-form').addEventListener('submit', (e) => {
            e.preventDefault();
            salvarAgendamento();
        });

        function salvarAgendamento() {
            const id = document.getElementById('agendamento-id').value;
            const clienteId = document.getElementById('agenda-cliente-id').value;
            const servicoId = document.getElementById('agenda-servico-id').value;
            const data = document.getElementById('agenda-data').value;
            const hora = document.getElementById('agenda-hora').value;
            const horaFim = document.getElementById('agenda-hora-fim').value;
            const observacoes = document.getElementById('agenda-observacoes').value;
            
            if (!clienteId || !servicoId || !data || !hora || !horaFim) {
                 showNotification('Preencha todos os campos obrigatórios (Cliente, Serviço, Data e Hora).', 'warning');
                 return;
            }

            const cliente = clientes[clienteId];
            const servico = servicos[servicoId];
            
            if (!cliente || !servico) {
                showNotification('Cliente ou Serviço inválido.', 'error');
                return;
            }
            
            // Status: 'agendado' (inicial), 'realizado', 'cancelado'
            const agendamentoData = {
                clienteId,
                clienteNome: cliente.nome,
                servicoId,
                servicoNome: servico.nome,
                data,
                hora, // Hora Início
                horaFim,
                preco: servico.preco,
                observacoes,
                status: 'agendado', 
                pago: false,
                tipo: 'Individual'
            };

            const dbRef = id ? ref(database, `${DB_NODES.AGENDAMENTOS}/${id}`) : push(ref(database, DB_NODES.AGENDAMENTOS));

            set(dbRef, agendamentoData)
                .then(() => {
                    showNotification(`Agendamento ${id ? 'atualizado' : 'salvo'} com sucesso!`, 'success');
                    resetAgendamentoForm();
                })
                .catch(error => showNotification('Erro ao salvar agendamento: ' + error.message, 'error'));
        }

        function renderizarAgendamentos(filtroData = null, filtroCliente = '') {
            const tbody = document.getElementById('lista-agendamentos');
            tbody.innerHTML = '';
            
            const hoje = getHoje();
            let agendamentosArray = Object.values(agendamentosIndividuais);
            
            // 1. Filtrar
            if (filtroData) {
                 agendamentosArray = agendamentosArray.filter(a => a.data === filtroData);
            } else {
                 // Por padrão, só mostra agendamentos futuros
                 agendamentosArray = agendamentosArray.filter(a => a.data >= hoje && a.status === 'agendado');
            }
            
            if (filtroCliente) {
                 agendamentosArray = agendamentosArray.filter(a => a.clienteNome.toLowerCase().includes(filtroCliente.toLowerCase()));
            }
            
            // 2. Ordenar por Data e Hora
            agendamentosArray.sort((a, b) => {
                 if (a.data !== b.data) return a.data.localeCompare(b.data);
                 return a.hora.localeCompare(b.hora);
            });


            if (agendamentosArray.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nenhum agendamento ativo encontrado.</td></tr>';
                return;
            }

            // 3. Renderizar
            agendamentosArray.forEach(agendamento => {
                const statusClass = agendamento.pago ? 'status-pago' : 'status-pendente';
                const statusText = agendamento.pago ? 'Pago' : 'Pendente';
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td data-label="Data/Hora">${formatarData(agendamento.data)} às ${agendamento.hora}</td>
                    <td data-label="Cliente"><strong>${agendamento.clienteNome}</strong></td>
                    <td data-label="Serviço">${agendamento.servicoNome}</td>
                    <td data-label="Status"><span class="${statusClass}">${statusText}</span></td>
                    <td data-label="Ações" class="action-buttons">
                        <button class="btn-info" onclick="marcarAgendamentoPago('${agendamento.id}', ${agendamento.preco})"><span class="material-icons">payments</span> Marcar Pago</button>
                        <button class="btn-warning" onclick="editAgendamento('${agendamento.id}')"><span class="material-icons">edit</span> Editar</button>
                        <button class="btn-danger" onclick="deleteAgendamento('${agendamento.id}', '${agendamento.clienteNome}')"><span class="material-icons">delete</span> Excluir</button>
                    </td>
                `;
            });
        }
        
        function marcarAgendamentoPago(agendamentoId, preco) {
             const agendamento = agendamentosIndividuais[agendamentoId];
             if (!agendamento) return;
             
             if (agendamento.pago) {
                 showNotification('Este agendamento já foi marcado como pago!', 'info');
                 return;
             }
             
             // 1. Atualiza o status do agendamento
             const updateData = { pago: true, status: 'realizado' };
             update(ref(database, `${DB_NODES.AGENDAMENTOS}/${agendamentoId}`), updateData)
                .then(() => {
                    // 2. Lança o valor no Histórico/Lucros (NÓ HISTORICO)
                    const historicoData = {
                        data: agendamento.data,
                        clienteNome: agendamento.clienteNome,
                        descricao: agendamento.servicoNome,
                        valor: preco,
                        tipo: 'Agendamento Individual',
                        agendamentoId: agendamentoId
                    };
                    return push(ref(database, DB_NODES.HISTORICO), historicoData);
                })
                .then(() => {
                    showNotification(`Agendamento de ${agendamento.clienteNome} marcado como PAGO e Lucro contabilizado!`, 'success');
                })
                .catch(error => showNotification('Erro ao marcar como pago/contabilizar: ' + error.message, 'error'));
        }

        function resetAgendamentoForm() {
            document.getElementById('agendamento-form').reset();
            document.getElementById('agendamento-id').value = '';
            document.getElementById('agenda-data').value = getHoje();
            document.getElementById('btn-salvar-agendamento').innerHTML = '<span class="material-icons">save</span> Salvar Agendamento';
        }
        
        function filtrarAgendamentos() {
            const data = document.getElementById('filtro-agenda-data').value;
            const cliente = document.getElementById('filtro-agenda-cliente').value;
            renderizarAgendamentos(data, cliente);
        }
        
        function resetFiltroAgenda() {
             document.getElementById('filtro-agenda-data').value = '';
             document.getElementById('filtro-agenda-cliente').value = '';
             carregarAgendamentos();
        }

        function editAgendamento(id) {
             const agendamento = agendamentosIndividuais[id];
             if (!agendamento) return;

             showAgendaTab('novo-agendamento'); // Mudar para a aba de formulário

             document.getElementById('agendamento-id').value = id;
             document.getElementById('agenda-cliente-id').value = agendamento.clienteId;
             document.getElementById('agenda-servico-id').value = agendamento.servicoId;
             document.getElementById('agenda-data').value = agendamento.data;
             document.getElementById('agenda-hora').value = agendamento.hora;
             document.getElementById('agenda-hora-fim').value = agendamento.horaFim;
             document.getElementById('agenda-observacoes').value = agendamento.observacoes || '';
             
             document.getElementById('btn-salvar-agendamento').innerHTML = '<span class="material-icons">update</span> Atualizar Agendamento';
        }
        
        function deleteAgendamento(id, nome) {
             if (confirm(`Tem certeza que deseja excluir o agendamento de ${nome}?`)) {
                 remove(ref(database, `${DB_NODES.AGENDAMENTOS}/${id}`))
                     .then(() => showNotification('Agendamento excluído com sucesso!', 'success'))
                     .catch(error => showNotification('Erro ao excluir agendamento: ' + error.message, 'error'));
             }
        }


        // ==================================================================================
        // PACOTES ATIVOS (CRUD e Lógica de Uso - Melhoria 3)
        // ==================================================================================

        const pacotesAtivosRef = query(ref(database, DB_NODES.PACOTES_ATIVOS), orderByChild('dataInicio'));
        const pacoteSessoesRef = ref(database, DB_NODES.PACOTE_SESSOES);

        function carregarPacotesAtivos() {
            onValue(pacotesAtivosRef, (snapshot) => {
                pacotesAtivos = {};
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        const pacote = childSnapshot.val();
                        pacote.id = childSnapshot.key;
                        pacotesAtivos[pacote.id] = pacote;
                        
                        // Garante que o contador está inicializado
                        if (typeof pacote.quantidadeUsada === 'undefined') {
                            pacote.quantidadeUsada = 0;
                        }
                    });
                }
                // Carrega as sessões de pacote para calcular o uso
                carregarSessoesPacotes(); 
            });
        }
        
        // Carrega as sessões de uso dos pacotes e atualiza a contagem
        function carregarSessoesPacotes() {
             onValue(pacoteSessoesRef, (snapshot) => {
                 pacoteSessoes = {};
                 const usoPorPacote = {};
                 if (snapshot.exists()) {
                      snapshot.forEach((childSnapshot) => {
                         const sessao = childSnapshot.val();
                         sessao.id = childSnapshot.key;
                         pacoteSessoes[sessao.id] = sessao;
                         
                         // Conta o uso para o pacote ativo
                         usoPorPacote[sessao.pacoteAtivoId] = (usoPorPacote[sessao.pacoteAtivoId] || 0) + 1;
                      });
                 }
                 
                 // Atualiza a quantidadeUsada em pacotesAtivos (cache)
                 Object.keys(pacotesAtivos).forEach(pacoteId => {
                     pacotesAtivos[pacoteId].quantidadeUsada = usoPorPacote[pacoteId] || 0;
                 });
                 
                 renderizarPacotesAtivos();
                 renderizarVisaoDiaria(); // Renderiza novamente com as sessões carregadas
             });
        }

        document.getElementById('pacote-inicio-form').addEventListener('submit', (e) => {
            e.preventDefault();
            iniciarPacote();
        });

        function iniciarPacote() {
            const clienteId = document.getElementById('pacote-cliente-id').value;
            const servicoId = document.getElementById('pacote-servico-id').value;
            const dataInicio = document.getElementById('pacote-data-inicio').value;

            if (!clienteId || !servicoId || !dataInicio) {
                 showNotification('Preencha todos os campos para iniciar o pacote.', 'warning');
                 return;
            }

            const cliente = clientes[clienteId];
            const servico = servicos[servicoId]; // O serviço é um pacote
            
            if (!cliente || !servico || !servico.isPacote) {
                showNotification('Seleção inválida de Cliente ou Pacote.', 'error');
                return;
            }
            
            const dataVencimento = new Date(dataInicio);
            // Vencimento padrão: 30 dias após o início
            dataVencimento.setDate(dataVencimento.getDate() + 30);
            
            const pacoteData = {
                clienteId,
                clienteNome: cliente.nome,
                servicoId,
                servicoNome: servico.nome,
                precoTotal: servico.preco,
                quantidadeTotal: servico.quantidadeTotal,
                quantidadeUsada: 0,
                dataInicio,
                dataVencimento: dataVencimento.toISOString().slice(0, 10),
                pago: false, // Inicia como não pago
                status: 'ativo'
            };

            push(ref(database, DB_NODES.PACOTES_ATIVOS), pacoteData)
                .then(() => {
                    showNotification('Pacote iniciado com sucesso! Lembre-se de marcá-lo como pago.', 'success');
                    document.getElementById('pacote-inicio-form').reset();
                    document.getElementById('pacote-data-inicio').value = getHoje();
                })
                .catch(error => showNotification('Erro ao iniciar pacote: ' + error.message, 'error'));
        }

        function renderizarPacotesAtivos() {
            const tbody = document.getElementById('lista-pacotes-ativos');
            tbody.innerHTML = '';
            
            if (Object.keys(pacotesAtivos).length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nenhum pacote ativo encontrado.</td></tr>';
                return;
            }

            Object.values(pacotesAtivos).forEach(pacote => {
                const isFinalizado = pacote.quantidadeUsada >= pacote.quantidadeTotal;
                const status = isFinalizado ? 'finalizado' : (new Date(pacote.dataVencimento) < new Date(getHoje()) ? 'vencido' : 'ativo');
                
                let statusPagamento = '';
                if (pacote.pago) {
                    statusPagamento = `<span class="status-package-paid">PAGO</span>`;
                } else {
                    statusPagamento = `<span class="status-package-pending">PENDENTE</span>`;
                }

                const row = tbody.insertRow();
                row.innerHTML = `
                    <td data-label="Cliente">${pacote.clienteNome}</td>
                    <td data-label="Pacote (Total/Usado)">
                        <strong>${pacote.servicoNome}</strong><br>
                        ${pacote.quantidadeUsada} de ${pacote.quantidadeTotal} usados
                        <span class="${isFinalizado ? 'status-package-finalized' : 'status-package-active'}">(${isFinalizado ? 'FINALIZADO' : 'ATIVO'})</span>
                    </td>
                    <td data-label="Pagamento">${statusPagamento}</td>
                    <td data-label="Vencimento">${formatarData(pacote.dataVencimento)}</td>
                    <td data-label="Ações" class="action-buttons">
                        ${!isFinalizado ? 
                            `<button class="btn-primary" onclick="openModal('usarPacoteModal', '${pacote.id}')"><span class="material-icons">task_alt</span> Usar Pacote</button>` 
                            : ''}
                        
                        ${!pacote.pago ? 
                            `<button class="btn-success" onclick="marcarPacotePago('${pacote.id}', ${pacote.precoTotal})"><span class="material-icons">paid</span> Marcar Pago</button>` 
                            : ''}
                        
                        <button class="btn-danger" onclick="deletePacoteAtivo('${pacote.id}', '${pacote.clienteNome}')"><span class="material-icons">delete</span> Excluir</button>
                    </td>
                `;
            });
        }
        
        // ** MELHORIA 3 - LÓGICA DE PAGAMENTO DO PACOTE NO HISTÓRICO **
        function marcarPacotePago(pacoteId, precoTotal) {
             const pacote = pacotesAtivos[pacoteId];
             if (!pacote) return;
             
             if (pacote.pago) {
                 showNotification('Este pacote já foi marcado como pago!', 'info');
                 return;
             }
             
             // 1. Atualiza o status do pacote ativo
             const updateData = { pago: true };
             update(ref(database, `${DB_NODES.PACOTES_ATIVOS}/${pacoteId}`), updateData)
                .then(() => {
                    // 2. Lança o valor total no Histórico/Lucros (NÓ HISTORICO)
                    const historicoData = {
                        data: getHoje(), // Data do pagamento (hoje)
                        clienteNome: pacote.clienteNome,
                        descricao: `Pagamento Pacote: ${pacote.servicoNome}`,
                        valor: precoTotal,
                        tipo: 'Pacote (Pagamento Total)',
                        pacoteId: pacoteId
                    };
                    return push(ref(database, DB_NODES.HISTORICO), historicoData);
                })
                .then(() => {
                    showNotification(`Pacote de ${pacote.clienteNome} marcado como PAGO e Lucro total (${formatarMoeda(precoTotal)}) contabilizado!`, 'success');
                })
                .catch(error => showNotification('Erro ao marcar como pago/contabilizar: ' + error.message, 'error'));
        }

        function deletePacoteAtivo(id, nome) {
             if (confirm(`Tem certeza que deseja excluir o pacote ativo de ${nome}? Isso não exclui as sessões já utilizadas.`)) {
                 remove(ref(database, `${DB_NODES.PACOTES_ATIVOS}/${id}`))
                     .then(() => showNotification('Pacote ativo excluído com sucesso!', 'success'))
                     .catch(error => showNotification('Erro ao excluir pacote ativo: ' + error.message, 'error'));
             }
        }
        
        // ** MELHORIA 3 - LÓGICA DE USO DE PACOTE (SESSÃO) **
        document.getElementById('pacote-uso-form').addEventListener('submit', (e) => {
             e.preventDefault();
             iniciarSessaoPacote();
        });

        function iniciarSessaoPacote() {
             const pacoteAtivoId = document.getElementById('modal-pacote-id').value;
             const data = document.getElementById('pacote-uso-data').value;
             const horaInicio = document.getElementById('pacote-uso-hora-inicio').value;
             const horaFim = document.getElementById('pacote-uso-hora-fim').value;
             
             if (!data || !horaInicio || !horaFim) {
                 showNotification('Preencha todos os campos de Data e Hora para registrar a sessão.', 'warning');
                 return;
             }
             
             const pacote = pacotesAtivos[pacoteAtivoId];
             if (!pacote) {
                 showNotification('Pacote ativo não encontrado.', 'error');
                 return;
             }
             
             if (pacote.quantidadeUsada >= pacote.quantidadeTotal) {
                 showNotification('Este pacote já foi totalmente utilizado!', 'error');
                 closeModal('usarPacoteModal');
                 return;
             }
             
             // 1. Cria o registro da sessão de uso
             const sessaoData = {
                 pacoteAtivoId,
                 clienteId: pacote.clienteId,
                 clienteNome: pacote.clienteNome,
                 servicoNome: pacote.servicoNome,
                 data,
                 hora: horaInicio,
                 horaFim,
                 preco: 0, // Valor zero para a sessão individual
                 status: 'realizado',
                 tipo: 'Pacote Session'
             };

             push(pacoteSessoesRef, sessaoData)
                 .then((newRef) => {
                      // 2. Lança o valor ZERO no Histórico (para registro)
                      const historicoData = {
                         data: data,
                         clienteNome: pacote.clienteNome,
                         descricao: `Uso de Pacote: ${pacote.servicoNome}`,
                         valor: 0,
                         tipo: 'Pacote Session',
                         sessaoId: newRef.key
                      };
                      return push(ref(database, DB_NODES.HISTORICO), historicoData);
                 })
                 .then(() => {
                     showNotification('Uso de pacote registrado com sucesso! (Valor: R$ 0,00)', 'success');
                     closeModal('usarPacoteModal');
                     document.getElementById('pacote-uso-form').reset();
                     // carregarSessoesPacotes() será chamado pelo listener, atualizando a lista
                 })
                 .catch(error => showNotification('Erro ao registrar uso de pacote: ' + error.message, 'error'));
        }


        // ==================================================================================
        // VISÃO DIÁRIA DA AGENDA (Melhoria 6)
        // ==================================================================================
        
        // ** MELHORIA 6 - GERA HORÁRIOS (07:00 ÀS 22:00, 30 min) **
        function gerarHorarios() {
            const horarios = [];
            // Começa às 7:00 (7 * 60 = 420 minutos)
            // Termina até 22:00 (1320 minutos), o último slot de início é 21:30 (1320 - 30)
            const minutosFim = 22 * 60; 
            
            for (let minutos = 7 * 60; minutos < minutosFim; minutos += 30) {
                const hora = Math.floor(minutos / 60);
                const minuto = minutos % 60;
                const horaFormatada = String(hora).padStart(2, '0');
                const minutoFormatado = String(minuto).padStart(2, '0');
                const horario = `${horaFormatada}:${minutoFormatado}`;
                horarios.push(horario);
            }
            return horarios;
        }


        function renderizarVisaoDiaria(usarDataDeHoje = false) {
             const hoje = getHoje();
             let dataSelecionada = document.getElementById('filtro-visao-diaria-data').value;
             
             if (usarDataDeHoje || !dataSelecionada) {
                  dataSelecionada = hoje;
                  document.getElementById('filtro-visao-diaria-data').value = hoje;
             }

             const tbody = document.getElementById('lista-visao-diaria');
             tbody.innerHTML = '';
             
             if (!dataSelecionada) {
                  tbody.innerHTML = '<tr><td colspan="2" style="text-align: center;">Selecione uma data para visualizar.</td></tr>';
                  return;
             }
             
             const horarios = gerarHorarios();
             const agendamentosDoDia = {};
             
             // Função para adicionar agendamentos ao mapa de horários
             function adicionarAgendamento(agendamento, tipo) {
                 const horaInicio = agendamento.hora;
                 const horaFim = agendamento.horaFim; 
                 // Cria uma chave única de 30 em 30 min (ex: "07:00", "07:30")
                 const inicioMin = (parseInt(horaInicio.substring(0, 2)) * 60) + parseInt(horaInicio.substring(3, 5));
                 const fimMin = (parseInt(horaFim.substring(0, 2)) * 60) + parseInt(horaFim.substring(3, 5));
                 
                 for (let min = inicioMin; min < fimMin; min += 30) {
                     const hora = Math.floor(min / 60);
                     const minuto = min % 60;
                     const chave = `${String(hora).padStart(2, '0')}:${String(minuto).padStart(2, '0')}`;
                     
                     // Adiciona o agendamento apenas se a hora de início for a mesma da chave do horário,
                     // para evitar duplicação em slots de 30 min
                     if (chave === horaInicio) {
                          agendamentosDoDia[chave] = { agendamento, tipo };
                     } else if (!agendamentosDoDia[chave]) {
                          // Preenche os blocos intermediários para marcar como ocupado
                          agendamentosDoDia[chave] = { agendamento, tipo, continua: true };
                     }
                 }
             }

             // 1. Filtra Agendamentos Individuais (AGENDAMENTOS)
             Object.values(agendamentosIndividuais).filter(a => a.data === dataSelecionada).forEach(a => {
                  adicionarAgendamento(a, 'Individual');
             });
             
             // 2. Filtra Sessões de Pacotes (PACOTE_SESSOES) - MELHORIA 6
             Object.values(pacoteSessoes).filter(s => s.data === dataSelecionada).forEach(s => {
                  adicionarAgendamento(s, 'Pacote');
             });
             
             // 3. Renderiza
             let lastAgendamento = null;
             
             horarios.forEach(horario => {
                 const agendamentoInfo = agendamentosDoDia[horario];
                 const row = tbody.insertRow();
                 row.style.height = '40px'; // Altura padrão
                 
                 row.innerHTML = `<td class="horario-celula">${horario}</td>`;
                 
                 if (agendamentoInfo && agendamentoInfo.agendamento) {
                      const { agendamento, tipo, continua } = agendamentoInfo;
                      
                      // Verifica se é o início de um novo agendamento ou se continua um anterior
                      if (!continua) {
                          const isPackage = tipo === 'Pacote';
                          const statusClass = isPackage ? 'agendamento-ocupado pacote-session' : 'agendamento-ocupado';
                          const nomeServico = isPackage ? `[Pacote] ${agendamento.servicoNome}` : agendamento.servicoNome;
                          
                          // Calcula quantas linhas (30min) o agendamento ocupa
                          const inicioMin = (parseInt(agendamento.hora.substring(0, 2)) * 60) + parseInt(agendamento.hora.substring(3, 5));
                          const fimMin = (parseInt(agendamento.horaFim.substring(0, 2)) * 60) + parseInt(agendamento.horaFim.substring(3, 5));
                          const rowSpan = Math.ceil((fimMin - inicioMin) / 30);
                          
                          row.innerHTML += `
                              <td rowspan="${rowSpan}" class="${statusClass}">
                                  <strong>${agendamento.clienteNome}</strong><br>
                                  <span>${nomeServico} | Término: ${agendamento.horaFim}</span>
                              </td>
                          `;
                          lastAgendamento = agendamento.id;
                      } else {
                          // É um slot intermediário, não adiciona célula para ser coberto pelo rowspan
                          lastAgendamento = agendamento.id;
                          return; // Não adiciona a linha/célula 'Detalhes'
                      }

                 } else {
                      row.innerHTML += `<td class="agendamento-vago">VAGO</td>`;
                      lastAgendamento = null;
                 }
                 
             });
             
             if (horarios.length === 0) {
                 tbody.innerHTML = '<tr><td colspan="2" style="text-align: center;">Não foi possível gerar horários.</td></tr>';
             }
        }


        // ==================================================================================
        // HISTÓRICO/LUCROS (Listagem e Resumo)
        // ==================================================================================

        const historicoRef = query(ref(database, DB_NODES.HISTORICO), orderByChild('data'));

        function carregarHistorico() {
            onValue(historicoRef, (snapshot) => {
                historicoCompleto = {};
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        const registro = childSnapshot.val();
                        registro.id = childSnapshot.key;
                        historicoCompleto[registro.id] = registro;
                    });
                }
                renderizarHistorico();
            });
        }

        function renderizarHistorico() {
             const mesFiltro = document.getElementById('filtro-historico-mes').value;
             const tbodyHistorico = document.getElementById('lista-historico');
             const tbodyLucros = document.getElementById('lista-lucros-mensais');
             tbodyHistorico.innerHTML = '';
             tbodyLucros.innerHTML = '';

             let historicoArray = Object.values(historicoCompleto);
             const resumoMensal = {};
             let lucroTotalGeral = 0;
             let totalAgendamentosGeral = 0;

             // 1. Filtrar e Calcular Resumo Mensal
             historicoArray = historicoArray.sort((a, b) => b.data.localeCompare(a.data)); // Mais recente primeiro

             historicoArray.forEach(reg => {
                 const mesAno = reg.data.substring(0, 7); // YYYY-MM
                 const valor = reg.valor || 0;

                 lucroTotalGeral += valor;

                 if (!resumoMensal[mesAno]) {
                     resumoMensal[mesAno] = { totalLucro: 0, totalAgendamentos: 0, data: mesAno };
                 }

                 resumoMensal[mesAno].totalLucro += valor;
                 resumoMensal[mesAno].totalAgendamentos += 1;
                 
                 // 2. Renderizar Histórico Completo
                 if (!mesFiltro || mesFiltro === mesAno) {
                     const row = tbodyHistorico.insertRow();
                     row.innerHTML = `
                         <td data-label="Data">${formatarData(reg.data)}</td>
                         <td data-label="Cliente"><strong>${reg.clienteNome}</strong></td>
                         <td data-label="Descrição">${reg.descricao}</td>
                         <td data-label="Valor (R$)" style="font-weight: bold;">${formatarMoeda(reg.valor)}</td>
                         <td data-label="Tipo">${reg.tipo}</td>
                     `;
                 }
             });

             if (tbodyHistorico.innerHTML === '') {
                 tbodyHistorico.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nenhum registro de histórico encontrado para este período.</td></tr>';
             }
             
             // 3. Renderizar Resumo Mensal
             const resumoArray = Object.values(resumoMensal).sort((a, b) => b.data.localeCompare(a.data));
             
             if (resumoArray.length === 0) {
                 tbodyLucros.innerHTML = '<tr><td colspan="4" style="text-align: center;">Nenhum resumo financeiro disponível.</td></tr>';
                 return;
             }

             resumoArray.forEach(resumo => {
                 const mesFormatado = new Date(resumo.data + '-01').toLocaleString('pt-BR', { month: 'long', year: 'numeric' });
                 const row = tbodyLucros.insertRow();
                 row.innerHTML = `
                     <td data-label="Mês/Ano">${mesFormatado.charAt(0).toUpperCase() + mesFormatado.slice(1)}</td>
                     <td data-label="Total Agendamentos" style="text-align: center;">${resumo.totalAgendamentos}</td>
                     <td data-label="Lucro Total (R$)" style="font-weight: bold;">${formatarMoeda(resumo.totalLucro)}</td>
                     <td data-label="Detalhes"><button class="btn-info" onclick="aplicarFiltroMesHistorico('${resumo.data}')"><span class="material-icons">search</span> Detalhes</button></td>
                 `;
             });
        }
        
        function aplicarFiltroMesHistorico(mesAno) {
             document.getElementById('filtro-historico-mes').value = mesAno;
             renderizarHistorico();
             // Scroll para a tabela de histórico
             document.getElementById('lista-historico').scrollIntoView({ behavior: 'smooth' });
        }

        function filtrarHistoricoTabela() {
             const filtro = document.getElementById('filtro-historico-cliente').value.toLowerCase();
             // Renderização é feita em `renderizarHistorico`, mas precisamos de um filtro adicional na tabela.
             // Para simplificar, vou apenas usar um filtro JS na tabela já renderizada.
             const rows = document.getElementById('lista-historico').querySelectorAll('tr');
             rows.forEach(row => {
                 const clienteCell = row.querySelector('td[data-label="Cliente"]');
                 if (clienteCell) {
                     if (clienteCell.textContent.toLowerCase().includes(filtro)) {
                         row.style.display = '';
                     } else {
                         row.style.display = 'none';
                     }
                 }
             });
        }
        
        function resetFiltroHistorico() {
            document.getElementById('filtro-historico-mes').value = ''; 
            document.getElementById('filtro-historico-cliente').value = '';
            renderizarHistorico();
        }
        
        // ==================================================================================
        // INICIALIZAÇÃO
        // ==================================================================================
        document.addEventListener('DOMContentLoaded', () => {
             // Mostra a tela de login ao carregar a página
            showLogin();
            
            // Inicia os listeners de dados
            carregarClientes();
            carregarServicos();
            carregarAgendamentos(); 
            carregarHistorico();
            // carregarPacotesAtivos chama carregarSessoesPacotes
            carregarPacotesAtivos(); 
            
            // Configura a data de hoje para os inputs de data
            const today = getHoje();
            document.getElementById('agenda-data').value = today;
            document.getElementById('pacote-data-inicio').value = today;
            document.getElementById('filtro-visao-diaria-data').value = today;

            // Associa a função showSection aos links da sidebar
            document.querySelectorAll('.sidebar ul li a').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    showSection(this.getAttribute('data-section') + '-section');
                });
            });
            
             // Inicializa a lógica de Pacote/Serviço (esconde o campo de quantidade total por padrão)
            document.getElementById('group-quantidade-total').style.display = 'none';
            
        });
    </script>
</body>
</html>
