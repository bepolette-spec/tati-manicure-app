<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tati Manicure - Gerenciamento de Agendamentos</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
    
    <style>
        /* --- Variáveis de Cor (Tema Manicure/Beleza) --- */
        :root {
            --primary-color: #ff69b4; /* Rosa Choque/Hot Pink (Cor Principal) */
            --secondary-color: #4b4b4b; /* Cinza Escuro (Texto Principal) */
            --success-color: #28a745; 
            --danger-color: #dc3545; 
            --warning-color: #ffc107; 
            --info-color: #17a2b8; 
            --bg-color: #f8f9fa; /* Fundo Branco Suave */
            --sidebar-bg-color: #ffffff; /* Fundo da Sidebar Branco */
            --sidebar-text-color: #343a40; /* Texto Escuro na Sidebar */
            --sidebar-hover-bg: #ffe0f5; /* Hover Rosa Claro */
            --card-bg-color: #ffffff;
            --text-color: #343a3f; 
            --border-color: #e0e0e0; 
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.05); 
            --input-border: #ced4da; 
            --input-focus-border: var(--primary-color);
        }

        /* --- Estilos Gerais (Adaptados) --- */
        body { font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; margin: 0; padding: 0; background-color: var(--bg-color); color: var(--text-color); font-size: 16px; }
        h1, h2, h3 { color: var(--secondary-color); margin-top: 0; margin-bottom: 20px; }
        
        /* Sidebar: Adicionando propriedades de responsividade */
        .sidebar { 
            width: 250px; 
            background-color: var(--sidebar-bg-color); 
            color: var(--sidebar-text-color); 
            padding: 20px 0; 
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.05); 
            flex-shrink: 0; 
            transition: transform 0.3s ease-in-out; 
        }
        
        /* Estilos de menu */
        .sidebar h2 { text-align: center; color: var(--primary-color); margin-bottom: 30px; font-size: 1.8rem; border-bottom: 1px solid rgba(0, 0, 0, 0.05); padding-bottom: 20px; }
        .sidebar ul { list-style: none; padding: 0; margin: 0; }
        .sidebar ul li a { display: flex; align-items: center; padding: 12px 20px; color: var(--sidebar-text-color); transition: background-color 0.3s ease; font-size: 1.1rem; text-decoration: none; }
        .sidebar ul li a .material-icons { margin-right: 10px; color: var(--primary-color); }
        .sidebar ul li a:hover, .sidebar ul li a.active { background-color: var(--sidebar-hover-bg); border-left: 5px solid var(--primary-color); padding-left: 15px; font-weight: 600; }
        
        /* Conteúdo Principal */
        .main-content { flex-grow: 1; padding: 30px; overflow-y: auto; }
        .content-section { display: none; }
        .content-section.active { display: block; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid var(--primary-color); }
        .card { background-color: var(--card-bg-color); border-radius: 8px; box-shadow: var(--shadow); padding: 25px; margin-bottom: 25px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; }
        select, input, textarea { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid var(--input-border); border-radius: 6px; box-sizing: border-box; font-size: 1rem; }
        button { padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 1rem; transition: background-color 0.3s ease, transform 0.1s ease; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: #e04a99; transform: translateY(-1px); }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-secondary { background-color: var(--secondary-color); color: white; }
        .form-row { display: flex; gap: 15px; }
        .form-row > div { flex: 1; }
        
        /* Login */
        #login-container { display: flex; justify-content: center; align-items: center; width: 100vw; height: 100vh; background-color: var(--sidebar-hover-bg); }
        #login-card { width: 100%; max-width: 400px; padding: 40px; }
        #login-card h2 { text-align: center; font-size: 2rem; color: var(--primary-color); }
        
        /* Estrutura do App */
        #app-container { display: none; width: 100%; height: 100vh; }
        .app-flex { display: flex; height: 100%; }
        
        /* Header */
        #header { display: flex; justify-content: flex-end; align-items: center; padding: 10px 30px; background-color: white; border-bottom: 1px solid var(--border-color); }

        /* Estilos de Tabela */
        .data-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .data-table th, .data-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .data-table th { background-color: var(--sidebar-hover-bg); color: var(--secondary-color); font-weight: 600; }
        .data-table tr:hover { background-color: #f1f1f1; }
        .action-buttons button { margin-right: 5px; padding: 8px 12px; font-size: 0.9rem; }

        /* Notificações */
        .notification { visibility: hidden; min-width: 250px; background-color: var(--secondary-color); color: #fff; text-align: center; border-radius: 4px; padding: 16px; position: fixed; z-index: 1000; bottom: 30px; left: 50%; transform: translateX(-50%); opacity: 0; transition: opacity 0.3s, visibility 0.3s; }
        .notification.show { visibility: visible; opacity: 1; }
        .notification.success { background-color: var(--success-color); }
        .notification.error { background-color: var(--danger-color); }
        .notification.info { background-color: var(--info-color); }
        
        /* NOVO: Estilo para o botão de menu (hambúrguer) */
        #menu-toggle {
            display: none; 
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 110; 
            background: var(--primary-color);
            color: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            padding: 0;
            justify-content: center;
            align-items: center;
            box-shadow: var(--shadow);
        }
        
        /* NOVO: Media Query para responsividade (Celulares e Tablets pequenos) */
        @media (max-width: 768px) {
            .app-flex {
                display: block; /* Desativa o flexbox */
            }

            /* Configura a sidebar para mobile */
            .sidebar { 
                transform: translateX(-100%); /* Esconde a sidebar */
                position: fixed; 
                height: 100%;
                z-index: 100;
                width: 220px; /* Largura menor no mobile */
            }
            .sidebar.open {
                transform: translateX(0); /* Mostra a sidebar */
            }
            .sidebar h2 {
                display: none; /* Esconde o título da sidebar */
            }

            /* Mostra o botão de menu */
            #menu-toggle {
                display: flex; 
            }
            
            /* Ajusta o header para que o botão Sair não fique em cima do botão Menu */
            #header {
                justify-content: flex-end; 
                padding: 10px 15px;
                position: fixed;
                width: 100%;
                top: 0;
                box-sizing: border-box;
                z-index: 90;
            }
            
            /* Ajusta o conteúdo principal para respeitar o header fixo */
            .main-content {
                padding: 20px; 
                padding-top: 60px; /* Espaço para o header */
            }
        }
    </style>
</head>
<body>

    <button id="menu-toggle" class="btn-primary" type="button">
        <span class="material-icons">menu</span>
    </button>

    <div id="notification-bar" class="notification"></div>

    <div id="login-container">
        <div id="login-card" class="card">
            <h2>Bem-vinda, Tati!</h2>
            <p style="text-align: center; color: var(--secondary-color);">Acesse o sistema de agendamentos.</p>
            <form id="login-form">
                <label for="loginSenha">Senha Única:</label>
                <input type="password" id="loginSenha" required placeholder="Digite a sua senha de acesso">
                <button type="submit" class="btn-primary" style="width: 100%;">
                    <span class="material-icons">lock_open</span> Entrar
                </button>
            </form>
        </div>
    </div>

    <div id="app-container">
        <div class="app-flex">
            <aside id="sidebar" class="sidebar">
                <h2>Tati Manicure</h2>
                <nav>
                    <ul>
                        <li><a href="#" data-section="agenda" class="active"><span class="material-icons">calendar_today</span> Agenda</a></li>
                        <li><a href="#" data-section="clientes"><span class="material-icons">groups</span> Clientes</a></li>
                        <li><a href="#" data-section="servicos"><span class="material-icons">nail_polish</span> Serviços & Preços</a></li>
                        <li><a href="#" data-section="historico"><span class="material-icons">history</span> Histórico & Lucros</a></li>
                        <li><a href="#" data-section="admin"><span class="material-icons">settings</span> Configurações</a></li>
                    </ul>
                </nav>
            </aside>

            <div style="display: flex; flex-direction: column; width: 100%;">
                <header id="header">
                    <div style="display: flex; align-items: center;">
                        <p id="userInfo" style="margin-right: 20px; font-weight: 500; color: var(--secondary-color);">Olá, Tati!</p>
                        <button id="logout-button" class="btn-danger"><span class="material-icons">logout</span> Sair</button>
                    </div>
                </header>
                <main class="main-content">
                    
                    <section id="agenda-section" class="content-section active">
                        <div class="section-header">
                            <h2>Novo Agendamento</h2>
                            <button class="btn-primary" onclick="resetAgendamentoForm()"><span class="material-icons">add_alarm</span> Agendar Horário</button>
                        </div>

                        <div class="card">
                            <form id="agendamento-form">
                                <input type="hidden" id="agendamento-id">
                                <div class="form-row">
                                    <div>
                                        <label for="agenda-data">Data:</label>
                                        <input type="date" id="agenda-data" required>
                                    </div>
                                    <div>
                                        <label for="agenda-hora">Hora:</label>
                                        <input type="time" id="agenda-hora" required>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div>
                                        <label for="agenda-cliente-id">Cliente:</label>
                                        <select id="agenda-cliente-id" required>
                                            <option value="">-- Selecione o Cliente --</option>
                                            </select>
                                    </div>
                                    <div>
                                        <label for="agenda-servico-id">Serviço/Pacote:</label>
                                        <select id="agenda-servico-id" required>
                                            <option value="">-- Selecione o Serviço --</option>
                                            </select>
                                    </div>
                                </div>
                                
                                <label for="agenda-observacoes">Observações do Agendamento:</label>
                                <textarea id="agenda-observacoes" rows="2" placeholder="Ex: Atraso, confirmação de cor, etc."></textarea>

                                <button type="submit" class="btn-success" id="btn-salvar-agendamento"><span class="material-icons">save</span> Salvar Agendamento</button>
                                <button type="button" class="btn-secondary" onclick="resetAgendamentoForm()"><span class="material-icons">close</span> Cancelar</button>
                            </form>
                        </div>
                        
                        <div class="section-header" style="margin-top: 30px;">
                            <h3>Próximos Agendamentos</h3>
                        </div>

                        <div class="card">
                            <div style="max-height: 500px; overflow-y: auto;">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 15%;">Data/Hora</th>
                                            <th style="width: 25%;">Cliente</th>
                                            <th style="width: 25%;">Serviço</th>
                                            <th>Status</th>
                                            <th style="width: 150px;">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="lista-agendamentos">
                                        </tbody>
                                </table>
                            </div>
                        </div>
                    </section>
                    
                    <section id="clientes-section" class="content-section">
                        <div class="section-header">
                            <h2>Cadastro de Clientes</h2>
                            <button class="btn-primary" onclick="resetClienteForm()"><span class="material-icons">person_add</span> Novo Cliente</button>
                        </div>

                        <div class="card">
                            <form id="cliente-form">
                                <input type="hidden" id="cliente-id">
                                <div class="form-row">
                                    <div>
                                        <label for="cliente-nome">Nome Completo:</label>
                                        <input type="text" id="cliente-nome" required>
                                    </div>
                                    <div>
                                        <label for="cliente-telefone">Telefone:</label>
                                        <input type="tel" id="cliente-telefone" placeholder="(99) 99999-9999" required>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div>
                                        <label for="cliente-email">E-mail:</label>
                                        <input type="email" id="cliente-email" placeholder="email@exemplo.com">
                                    </div>
                                    <div>
                                        <label for="cliente-endereco">Endereço:</label>
                                        <input type="text" id="cliente-endereco" placeholder="Rua, Número, Bairro">
                                    </div>
                                </div>
                                <label for="cliente-observacoes">Observações:</label>
                                <textarea id="cliente-observacoes" rows="3" placeholder="Alergias, preferências ou informações importantes..."></textarea>

                                <button type="submit" class="btn-success" id="btn-salvar-cliente"><span class="material-icons">save</span> Salvar Cliente</button>
                                <button type="button" class="btn-secondary" onclick="resetClienteForm()"><span class="material-icons">close</span> Cancelar</button>
                            </form>
                        </div>
                        
                        <div class="section-header" style="margin-top: 30px;">
                            <h3>Lista de Clientes Cadastrados</h3>
                        </div>

                        <div class="card">
                            <input type="text" id="filtro-clientes" onkeyup="filtrarClientes()" placeholder="Filtrar por nome, telefone ou email...">
                            <div style="max-height: 500px; overflow-y: auto;">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Nome</th>
                                            <th>Telefone</th>
                                            <th>E-mail</th>
                                            <th style="width: 150px;">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="lista-clientes">
                                        </tbody>
                                </table>
                            </div>
                        </div>
                    </section>
                    
                    <section id="servicos-section" class="content-section">
                        <div class="section-header">
                            <h2>Cadastro de Serviços & Promoções</h2>
                            <button class="btn-primary" onclick="resetServicoForm()"><span class="material-icons">add_circle</span> Novo Serviço/Pacote</button>
                        </div>

                        <div class="card">
                            <form id="servico-form">
                                <input type="hidden" id="servico-id">
                                <div class="form-row">
                                    <div>
                                        <label for="servico-nome">Nome do Serviço/Pacote:</label>
                                        <input type="text" id="servico-nome" required>
                                    </div>
                                    <div>
                                        <label for="servico-preco">Preço (R$):</label>
                                        <input type="number" id="servico-preco" step="0.01" min="0" required placeholder="Ex: 40.00">
                                    </div>
                                </div>
                                
                                <label for="servico-descricao">Descrição:</label>
                                <textarea id="servico-descricao" rows="2" placeholder="Ex: Mãos simples, Pacote Mãos e Pés, ou descrição do pacote de desconto."></textarea>
                                
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
                                    <input type="checkbox" id="servico-isPacote" style="width: auto; margin: 0;">
                                    <label for="servico-isPacote" style="margin: 0; font-weight: normal;">Marcar como **Pacote de Serviço** ou **Promoção**?</label>
                                </div>

                                <button type="submit" class="btn-success" id="btn-salvar-servico"><span class="material-icons">save</span> Salvar Serviço</button>
                                <button type="button" class="btn-secondary" onclick="resetServicoForm()"><span class="material-icons">close</span> Cancelar</button>
                            </form>
                        </div>
                        
                        <div class="section-header" style="margin-top: 30px;">
                            <h3>Lista de Serviços e Pacotes Cadastrados</h3>
                        </div>

                        <div class="card">
                            <div style="max-height: 500px; overflow-y: auto;">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 30%;">Nome</th>
                                            <th>Tipo</th>
                                            <th>Preço (R$)</th>
                                            <th style="width: 150px;">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="lista-servicos">
                                        </tbody>
                                </table>
                            </div>
                        </div>
                    </section>

                    <section id="historico-section" class="content-section">
                        <div class="section-header"><h2>Histórico de Atendimentos & Lucros</h2></div>
                        <div class="card">Aguardando desenvolvimento...</div>
                    </section>

                    <section id="admin-section" class="content-section">
                        <div class="section-header"><h2>Configurações do Sistema</h2></div>
                        <div class="card">Aguardando desenvolvimento...</div>
                    </section>

                </main>
            </div>
        </div>
    </div>

    <script type="module">
        // =================================================================
        //                 1. CONFIGURAÇÃO FIREBASE
        // =================================================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
        import { getDatabase, ref, onValue, push, set, update, remove } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";
        
        // Sua configuração do Firebase (dados enviados por você)
        const firebaseConfig = {
          apiKey: "AIzaSyBatp6e1NzevurpB2yS8eGErgSYC_t2-Nc",
          authDomain: "tati-manicure.firebaseapp.com",
          databaseURL: "https://tati-manicure-default-rtdb.firebaseio.com",
          projectId: "tati-manicure",
          storageBucket: "tati-manicure.firebasestorage.app",
          messagingSenderId: "1061777323027",
          appId: "1:1061777323027:web:7b54e5fdbb7f06ee293be6",
          measurementId: "G-V3J5ZJ5XBT"
        };

        // Inicialização do Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app); 
        
        // Referências aos nós (listas/tabelas) do seu banco de dados
        const clientesRef = ref(db, 'clientes');
        const servicosRef = ref(db, 'servicos'); 
        const agendamentosRef = ref(db, 'agendamentos'); 

        // Senha de Acesso Única (Modelo Simples)
        const SENHA_UNICA = "tati123"; // **ATUALIZE ESTA SENHA!**
        
        // =================================================================
        //                 1.1. CONFIGURAÇÃO EMAILJS
        // =================================================================
        // ⚠️ ATENÇÃO: COLOQUE AS SUAS CHAVES DO EMAILJS AQUI!
        const EMAILJS_USER_ID = "[COLOQUE SUA CHAVE AQUI]"; 
        const EMAILJS_SERVICE_ID = "[COLOQUE SUA CHAVE AQUI]";
        const EMAILJS_TEMPLATE_ID = "[COLOQUE SUA CHAVE AQUI]";
        
        // Inicializa o EmailJS com seu User ID
        if (typeof emailjs !== 'undefined') {
            emailjs.init(EMAILJS_USER_ID);
        } else {
             console.error("EmailJS não carregou. Verifique o link no <head>.");
        }


        // =================================================================
        //                 2. LÓGICA DE LOGIN E NAVEGAÇÃO
        // =================================================================
        
        const loginContainer = document.getElementById('login-container');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const logoutButton = document.getElementById('logout-button');
        const navLinks = document.querySelectorAll('.sidebar ul li a');
        const contentSections = document.querySelectorAll('.content-section');
        const userInfoDisplay = document.getElementById('userInfo');
        
        // NOVO: Referências para os novos elementos de Responsividade
        const menuToggle = document.getElementById('menu-toggle');
        const sidebar = document.getElementById('sidebar');

        function showApp(userName = 'Tati') {
            loginContainer.style.display = 'none';
            appContainer.style.display = 'block';
            userInfoDisplay.textContent = `Olá, ${userName}!`;
            // Força a carga inicial das listas ao entrar no app
            carregarClientes(); 
            carregarServicos(); 
            popularSelects(); // Inicializa os SELECTs da Agenda
            carregarAgendamentos(); // Carrega os agendamentos iniciais
        }

        function showLogin() {
            loginContainer.style.display = 'flex';
            appContainer.style.display = 'none';
        }

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const senha = document.getElementById('loginSenha').value;

            if (senha === SENHA_UNICA) {
                showApp();
                showNotification(`Acesso liberado! Bem-vinda.`, 'success');
            } else {
                showNotification('Senha incorreta.', 'error');
            }
            document.getElementById('loginSenha').value = '';
        });

        logoutButton.addEventListener('click', () => {
            showLogin();
            showNotification('Você saiu do sistema.', 'info');
        });

        // Lógica de Responsividade (Menu Hambúrguer)
        menuToggle.addEventListener('click', () => {
            sidebar.classList.toggle('open');
        });

        // Navegação entre Telas
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetSectionId = e.currentTarget.getAttribute('data-section');

                // Recarrega as listas quando as abas são clicadas
                if (targetSectionId === 'clientes') { carregarClientes(); }
                if (targetSectionId === 'servicos') { carregarServicos(); }
                if (targetSectionId === 'agenda') { 
                    popularSelects(); 
                    carregarAgendamentos(); 
                }

                navLinks.forEach(l => l.classList.remove('active'));
                contentSections.forEach(s => s.classList.remove('active'));

                e.currentTarget.classList.add('active');
                document.getElementById(`${targetSectionId}-section`).classList.add('active');
                
                // NOVO: Fecha a sidebar no mobile após clicar em um link
                if (window.innerWidth <= 768) {
                    sidebar.classList.remove('open');
                }
            });
        });
        
        // Função de Notificação
        function showNotification(message, type = 'success') {
             const notificationBar = document.getElementById('notification-bar');
             notificationBar.textContent = message;
             notificationBar.className = `notification ${type} show`;
             setTimeout(() => { notificationBar.classList.remove('show'); }, 3000);
        }

        // =================================================================
        //              3. CRUD DE CLIENTES (NÓ: 'clientes')
        // =================================================================

        const clienteForm = document.getElementById('cliente-form');
        const listaClientes = document.getElementById('lista-clientes');
        const btnSalvarCliente = document.getElementById('btn-salvar-cliente');

        window.resetClienteForm = function() {
            clienteForm.reset();
            document.getElementById('cliente-id').value = '';
            btnSalvarCliente.innerHTML = '<span class="material-icons">save</span> Salvar Cliente';
            btnSalvarCliente.classList.replace('btn-secondary', 'btn-success');
        }

        // 3.1. SALVAR/ATUALIZAR CLIENTE
        clienteForm.addEventListener('submit', (e) => {
            e.preventDefault();

            const id = document.getElementById('cliente-id').value;
            const novoCliente = {
                nome: document.getElementById('cliente-nome').value,
                telefone: document.getElementById('cliente-telefone').value,
                // O email pode ser opcional (vazio)
                email: document.getElementById('cliente-email').value, 
                endereco: document.getElementById('cliente-endereco').value,
                observacoes: document.getElementById('cliente-observacoes').value
            };

            if (id) {
                update(ref(db, `clientes/${id}`), novoCliente)
                    .then(() => {
                        showNotification('Cliente atualizado com sucesso!', 'success');
                        resetClienteForm();
                    })
                    .catch(error => {
                        showNotification('Erro ao atualizar cliente: ' + error.message, 'error');
                    });
            } else {
                push(clientesRef, novoCliente)
                    .then(() => {
                        showNotification('Cliente cadastrado com sucesso!', 'success');
                        resetClienteForm();
                    })
                    .catch(error => {
                        showNotification('Erro ao cadastrar cliente: ' + error.message, 'error');
                    });
            }
        });

        // 3.2. CARREGAR CLIENTES DO FIREBASE
        function carregarClientes() {
            onValue(clientesRef, (snapshot) => {
                const clientes = snapshot.val();
                listaClientes.innerHTML = '';
                const clientesArray = [];

                if (clientes) {
                    for (let id in clientes) {
                        clientesArray.push({ id, ...clientes[id] });
                    }
                    
                    clientesArray.sort((a, b) => a.nome.localeCompare(b.nome));

                    clientesArray.forEach(cliente => {
                        const row = listaClientes.insertRow();
                        row.dataset.clienteData = JSON.stringify(cliente); 
                        
                        row.insertCell().textContent = cliente.nome;
                        row.insertCell().textContent = cliente.telefone;
                        row.insertCell().textContent = cliente.email;
                        
                        const acoesCell = row.insertCell();
                        acoesCell.className = 'action-buttons';
                        
                        const btnEditar = document.createElement('button');
                        btnEditar.innerHTML = '<span class="material-icons" style="font-size: 18px;">edit</span>';
                        btnEditar.className = 'btn-secondary';
                        btnEditar.title = 'Editar';
                        btnEditar.onclick = () => editarCliente(cliente);
                        acoesCell.appendChild(btnEditar);
                        
                        const btnExcluir = document.createElement('button');
                        btnExcluir.innerHTML = '<span class="material-icons" style="font-size: 18px;">delete</span>';
                        btnExcluir.className = 'btn-danger';
                        btnExcluir.title = 'Excluir';
                        btnExcluir.onclick = () => confirmarExclusao(cliente.id, cliente.nome);
                        acoesCell.appendChild(btnExcluir);
                    });
                } else {
                    listaClientes.innerHTML = '<tr><td colspan="4" style="text-align: center;">Nenhum cliente cadastrado.</td></tr>';
                }
            });
        }

        // 3.3. PREENCHER FORMULÁRIO PARA EDIÇÃO
        function editarCliente(cliente) {
            document.getElementById('cliente-id').value = cliente.id;
            document.getElementById('cliente-nome').value = cliente.nome;
            document.getElementById('cliente-telefone').value = cliente.telefone;
            document.getElementById('cliente-email').value = cliente.email;
            document.getElementById('cliente-endereco').value = cliente.endereco;
            document.getElementById('cliente-observacoes').value = cliente.observacoes;

            btnSalvarCliente.innerHTML = '<span class="material-icons">update</span> Atualizar Cliente';
            btnSalvarCliente.classList.replace('btn-success', 'btn-secondary');

            document.getElementById('clientes-section').classList.add('active');
            navLinks.forEach(l => l.classList.remove('active'));
            document.querySelector('[data-section="clientes"]').classList.add('active');
            
            document.getElementById('clientes-section').scrollIntoView({ behavior: 'smooth' });
        }

        // 3.4. EXCLUIR CLIENTE
        function confirmarExclusao(id, nome) {
            if (confirm(`Tem certeza que deseja excluir o cliente "${nome}"? Esta ação não pode ser desfeita.`)) {
                remove(ref(db, `clientes/${id}`))
                    .then(() => {
                        showNotification(`Cliente "${nome}" excluído com sucesso.`, 'danger');
                    })
                    .catch(error => {
                        showNotification('Erro ao excluir cliente: ' + error.message, 'error');
                    });
            }
        }
        
        // 3.5. FILTRAR CLIENTES NA TABELA (Busca Local)
        window.filtrarClientes = function() {
            const filtro = document.getElementById('filtro-clientes').value.toLowerCase();
            const linhas = listaClientes.getElementsByTagName('tr');

            for (let i = 0; i < linhas.length; i++) {
                const row = linhas[i];
                if (row.cells.length < 4) continue; 
                
                const clienteData = JSON.parse(row.dataset.clienteData);
                const nome = clienteData.nome.toLowerCase();
                const telefone = clienteData.telefone.toLowerCase();
                const email = clienteData.email.toLowerCase();

                if (nome.includes(filtro) || telefone.includes(filtro) || email.includes(filtro)) {
                    row.style.display = "";
                } else {
                    row.style.display = "none";
                }
            }
        }

        // =================================================================
        //              4. CRUD DE SERVIÇOS (NÓ: 'servicos')
        // =================================================================

        const servicoForm = document.getElementById('servico-form');
        const listaServicos = document.getElementById('lista-servicos');
        const btnSalvarServico = document.getElementById('btn-salvar-servico');

        // Função para Resetar/Limpar o Formulário de Serviços
        window.resetServicoForm = function() {
            servicoForm.reset();
            document.getElementById('servico-id').value = '';
            btnSalvarServico.innerHTML = '<span class="material-icons">save</span> Salvar Serviço';
            btnSalvarServico.classList.replace('btn-secondary', 'btn-success');
        }

        // 4.1. SALVAR/ATUALIZAR SERVIÇO
        servicoForm.addEventListener('submit', (e) => {
            e.preventDefault();

            const id = document.getElementById('servico-id').value;
            const novoServico = {
                nome: document.getElementById('servico-nome').value,
                descricao: document.getElementById('servico-descricao').value,
                preco: parseFloat(document.getElementById('servico-preco').value).toFixed(2), // Garante formato de moeda
                isPacote: document.getElementById('servico-isPacote').checked
            };

            if (id) {
                // Modo Edição (Atualizar)
                update(ref(db, `servicos/${id}`), novoServico)
                    .then(() => {
                        showNotification('Serviço/Pacote atualizado com sucesso!', 'success');
                        resetServicoForm();
                    })
                    .catch(error => {
                        showNotification('Erro ao atualizar serviço: ' + error.message, 'error');
                    });
            } else {
                // Modo Cadastro (Novo)
                push(servicosRef, novoServico)
                    .then(() => {
                        showNotification('Serviço/Pacote cadastrado com sucesso!', 'success');
                        resetServicoForm();
                    })
                    .catch(error => {
                        showNotification('Erro ao cadastrar serviço: ' + error.message, 'error');
                    });
            }
        });

        // 4.2. CARREGAR SERVIÇOS DO FIREBASE
        function carregarServicos() {
            onValue(servicosRef, (snapshot) => {
                const servicos = snapshot.val();
                listaServicos.innerHTML = '';
                const servicosArray = [];

                if (servicos) {
                    for (let id in servicos) {
                        servicosArray.push({ id, ...servicos[id] });
                    }
                    
                    // Ordena por nome
                    servicosArray.sort((a, b) => a.nome.localeCompare(b.nome));

                    servicosArray.forEach(servico => {
                        const row = listaServicos.insertRow();
                        
                        row.insertCell().textContent = servico.nome;
                        
                        const tipoCell = row.insertCell();
                        if (servico.isPacote) {
                            tipoCell.innerHTML = '<strong style="color: var(--primary-color);">Pacote/Promoção</strong>';
                        } else {
                            tipoCell.textContent = 'Serviço Único';
                        }

                        row.insertCell().textContent = `R$ ${parseFloat(servico.preco).toFixed(2).replace('.', ',')}`;
                        
                        const acoesCell = row.insertCell();
                        acoesCell.className = 'action-buttons';
                        
                        // Botão Editar
                        const btnEditar = document.createElement('button');
                        btnEditar.innerHTML = '<span class="material-icons" style="font-size: 18px;">edit</span>';
                        btnEditar.className = 'btn-secondary';
                        btnEditar.title = 'Editar';
                        btnEditar.onclick = () => editarServico(servico);
                        acoesCell.appendChild(btnEditar);
                        
                        // Botão Excluir
                        const btnExcluir = document.createElement('button');
                        btnExcluir.innerHTML = '<span class="material-icons" style="font-size: 18px;">delete</span>';
                        btnExcluir.className = 'btn-danger';
                        btnExcluir.title = 'Excluir';
                        btnExcluir.onclick = () => confirmarExclusaoServico(servico.id, servico.nome);
                        acoesCell.appendChild(btnExcluir);
                    });
                } else {
                    listaServicos.innerHTML = '<tr><td colspan="4" style="text-align: center;">Nenhum serviço ou pacote cadastrado.</td></tr>';
                }
            });
        }

        // 4.3. PREENCHER FORMULÁRIO PARA EDIÇÃO
        function editarServico(servico) {
            document.getElementById('servico-id').value = servico.id;
            document.getElementById('servico-nome').value = servico.nome;
            document.getElementById('servico-descricao').value = servico.descricao;
            document.getElementById('servico-preco').value = servico.preco;
            // Garante que o checkbox seja preenchido corretamente
            document.getElementById('servico-isPacote').checked = servico.isPacote === true; 

            // Atualiza o botão para refletir a ação de edição
            btnSalvarServico.innerHTML = '<span class="material-icons">update</span> Atualizar Serviço';
            btnSalvarServico.classList.replace('btn-success', 'btn-secondary');

            // Troca para a aba de Serviços se necessário
            document.querySelector('[data-section="servicos"]').click();
            
            // Rola a página para o topo do formulário
            document.getElementById('servicos-section').scrollIntoView({ behavior: 'smooth' });
        }

        // 4.4. EXCLUIR SERVIÇO
        function confirmarExclusaoServico(id, nome) {
            if (confirm(`Tem certeza que deseja excluir o serviço/pacote "${nome}"? Esta ação não pode ser desfeita.`)) {
                remove(ref(db, `servicos/${id}`))
                    .then(() => {
                        showNotification(`Serviço/Pacote "${nome}" excluído com sucesso.`, 'danger');
                    })
                    .catch(error => {
                        showNotification('Erro ao excluir serviço: ' + error.message, 'error');
                    });
            }
        }

        // =================================================================
        //              5. CRUD DE AGENDAMENTOS (NÓ: 'agendamentos')
        // =================================================================

        const agendamentoForm = document.getElementById('agendamento-form');
        const listaAgendamentos = document.getElementById('lista-agendamentos');
        const btnSalvarAgendamento = document.getElementById('btn-salvar-agendamento');
        const selectCliente = document.getElementById('agenda-cliente-id');
        const selectServico = document.getElementById('agenda-servico-id');

        // Objeto para armazenar clientes e serviços em memória para referência rápida
        let clientesCache = {};
        let servicosCache = {};

        // 5.0. FUNÇÃO PARA POPULAR OS SELECTS
        function popularSelects() {
            // 5.0.1. Popular Clientes
            onValue(clientesRef, (snapshot) => {
                clientesCache = {};
                selectCliente.innerHTML = '<option value="">-- Selecione o Cliente --</option>';
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        const cliente = childSnapshot.val();
                        cliente.id = childSnapshot.key;
                        clientesCache[cliente.id] = cliente;
                        const option = new Option(cliente.nome, cliente.id);
                        selectCliente.appendChild(option);
                    });
                }
            });

            // 5.0.2. Popular Serviços
            onValue(servicosRef, (snapshot) => {
                servicosCache = {};
                selectServico.innerHTML = '<option value="">-- Selecione o Serviço --</option>';
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        const servico = childSnapshot.val();
                        servico.id = childSnapshot.key;
                        servicosCache[servico.id] = servico;
                        const nomeServico = servico.isPacote ? `[Pacote] ${servico.nome}` : servico.nome;
                        const option = new Option(`${nomeServico} (R$ ${parseFloat(servico.preco).toFixed(2).replace('.', ',')})`, servico.id);
                        selectServico.appendChild(option);
                    });
                }
            });
        }

        // Inicializa a carga dos selects ao carregar o app
        popularSelects();

        // Função para Resetar/Limpar o Formulário de Agendamento
        window.resetAgendamentoForm = function() {
            agendamentoForm.reset();
            document.getElementById('agendamento-id').value = '';
            btnSalvarAgendamento.innerHTML = '<span class="material-icons">save</span> Salvar Agendamento';
            btnSalvarAgendamento.classList.replace('btn-secondary', 'btn-success');
        }

        // 5.1. SALVAR/ATUALIZAR AGENDAMENTO
        agendamentoForm.addEventListener('submit', (e) => {
            e.preventDefault();

            const clienteId = document.getElementById('agenda-cliente-id').value;
            const servicoId = document.getElementById('agenda-servico-id').value;

            // Validação simples
            if (!clienteId || !servicoId) {
                 showNotification('Por favor, selecione um Cliente e um Serviço.', 'error');
                 return;
            }

            const id = document.getElementById('agendamento-id').value;
            const clienteInfo = clientesCache[clienteId] || { nome: 'Cliente Desconhecido', email: '' };
            const servicoInfo = servicosCache[servicoId] || { nome: 'Serviço Desconhecido', preco: 0 };
            
            const novoAgendamento = {
                data: document.getElementById('agenda-data').value,
                hora: document.getElementById('agenda-hora').value,
                clienteId: clienteId,
                servicoId: servicoId,
                clienteNome: clienteInfo.nome, 
                servicoNome: servicoInfo.nome,
                preco: servicoInfo.preco,
                observacoes: document.getElementById('agenda-observacoes').value,
                status: 'Agendado' 
            };

            if (id) {
                // MODO EDIÇÃO
                update(ref(db, `agendamentos/${id}`), novoAgendamento)
                    .then(() => {
                        showNotification('Agendamento atualizado com sucesso!', 'success');
                        resetAgendamentoForm();
                    })
                    .catch(error => {
                        showNotification('Erro ao atualizar agendamento: ' + error.message, 'error');
                    });
            } else {
                // MODO CADASTRO (NOVO)
                push(agendamentosRef, novoAgendamento)
                    .then(() => {
                        // 5.1.1. Lógica de Envio de E-mail de Confirmação
                        const clienteEmail = clienteInfo.email;

                        if (clienteEmail && clienteEmail.trim() !== '') {
                             // E-mail cadastrado, tenta enviar
                            const dataFormatada = novoAgendamento.data.split('-').reverse().join('/');
                            const agendamentoDataHora = `${dataFormatada} às ${novoAgendamento.hora.substring(0, 5)}`;
                            const servicoPreco = `R$ ${parseFloat(novoAgendamento.preco).toFixed(2).replace('.', ',')}`;

                            sendEmailConfirmation({
                                to: clienteEmail,
                                cliente_nome: novoAgendamento.clienteNome, // Chaves usadas no Template do EmailJS
                                data_hora: agendamentoDataHora,
                                servico_nome: novoAgendamento.servicoNome,
                                servico_preco: servicoPreco
                            });
                            
                        } else {
                            // Sem e-mail cadastrado, apenas notifica que salvou
                             showNotification('Agendamento salvo com sucesso! (Cliente sem e-mail cadastrado)', 'info');
                        }
                        
                        resetAgendamentoForm();
                    })
                    .catch(error => {
                        showNotification('Erro ao salvar agendamento: ' + error.message, 'error');
                    });
            }
        });
        
        // 5.2. CARREGAR AGENDAMENTOS
        function carregarAgendamentos() {
            onValue(agendamentosRef, (snapshot) => {
                const agendamentos = snapshot.val();
                listaAgendamentos.innerHTML = '';
                const agendamentosArray = [];

                if (agendamentos) {
                    for (let id in agendamentos) {
                        agendamentosArray.push({ id, ...agendamentos[id] });
                    }
                    
                    // Ordena por data e hora (do mais próximo ao mais distante)
                    agendamentosArray.sort((a, b) => {
                        const dateTimeA = new Date(`${a.data}T${a.hora}`);
                        const dateTimeB = new Date(`${b.data}T${b.hora}`);
                        return dateTimeA - dateTimeB;
                    });

                    agendamentosArray.forEach(agendamento => {
                        const row = listaAgendamentos.insertRow();
                        
                        // Formatação da Data e Hora
                        const dataFormatada = agendamento.data.split('-').reverse().join('/');
                        row.insertCell().innerHTML = `<strong>${dataFormatada}</strong> às ${agendamento.hora.substring(0, 5)}`;
                        
                        // Cliente e Serviço
                        row.insertCell().textContent = agendamento.clienteNome;
                        
                        const nomeServicoCompleto = (servicosCache[agendamento.servicoId] && servicosCache[agendamento.servicoId].isPacote) ? 
                            `[Pacote] ${agendamento.servicoNome}` : agendamento.servicoNome;
                            
                        row.insertCell().textContent = `${nomeServicoCompleto} (R$ ${parseFloat(agendamento.preco).toFixed(2).replace('.', ',')})`;

                        // Status
                        const statusCell = row.insertCell();
                        statusCell.textContent = agendamento.status;
                        // Adicionando um estilo simples para o status
                        if (agendamento.status === 'Agendado') {
                            statusCell.style.fontWeight = 'bold';
                            statusCell.style.color = '#17a2b8'; // Cor de info
                        }
                        
                        const acoesCell = row.insertCell();
                        acoesCell.className = 'action-buttons';
                        
                        // Botão Editar
                        const btnEditar = document.createElement('button');
                        btnEditar.innerHTML = '<span class="material-icons" style="font-size: 18px;">edit</span>';
                        btnEditar.className = 'btn-secondary';
                        btnEditar.title = 'Editar';
                        btnEditar.onclick = () => editarAgendamento(agendamento);
                        acoesCell.appendChild(btnEditar);
                        
                        // Botão Excluir
                        const btnExcluir = document.createElement('button');
                        btnExcluir.innerHTML = '<span class="material-icons" style="font-size: 18px;">delete</span>';
                        btnExcluir.className = 'btn-danger';
                        btnExcluir.title = 'Excluir';
                        btnExcluir.onclick = () => confirmarExclusaoAgendamento(agendamento.id, agendamento.clienteNome);
                        acoesCell.appendChild(btnExcluir);
                    });
                } else {
                    listaAgendamentos.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nenhum agendamento futuro cadastrado.</td></tr>';
                }
            });
        }
        // Força a carga dos agendamentos ao entrar na página
        carregarAgendamentos();

        // 5.3. PREENCHER FORMULÁRIO PARA EDIÇÃO
        function editarAgendamento(agendamento) {
            document.getElementById('agendamento-id').value = agendamento.id;
            document.getElementById('agenda-data').value = agendamento.data;
            document.getElementById('agenda-hora').value = agendamento.hora;
            document.getElementById('agenda-cliente-id').value = agendamento.clienteId;
            document.getElementById('agenda-servico-id').value = agendamento.servicoId;
            document.getElementById('agenda-observacoes').value = agendamento.observacoes;

            btnSalvarAgendamento.innerHTML = '<span class="material-icons">update</span> Atualizar Agendamento';
            btnSalvarAgendamento.classList.replace('btn-success', 'btn-secondary');

            // Rola a página para o topo do formulário
            document.getElementById('agenda-section').scrollIntoView({ behavior: 'smooth' });
        }

        // 5.4. EXCLUIR AGENDAMENTO
        function confirmarExclusaoAgendamento(id, nomeCliente) {
            if (confirm(`Tem certeza que deseja excluir o agendamento do cliente "${nomeCliente}"? Esta ação não pode ser desfeita.`)) {
                remove(ref(db, `agendamentos/${id}`))
                    .then(() => {
                        showNotification(`Agendamento de "${nomeCliente}" excluído com sucesso.`, 'danger');
                    })
                    .catch(error => {
                        showNotification('Erro ao excluir agendamento: ' + error.message, 'error');
                    });
            }
        }
        
        // 5.5. LÓGICA DE ENVIO DE E-MAIL (Usando EmailJS)
        function sendEmailConfirmation(templateParams) {
            if (!EMAILJS_USER_ID || !EMAILJS_SERVICE_ID || !EMAILJS_TEMPLATE_ID) {
                console.error("Chaves do EmailJS ausentes. Não é possível enviar e-mail.");
                showNotification('Agendamento salvo. ERRO: Chaves do EmailJS ausentes.', 'warning');
                return;
            }

            emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams)
                .then((response) => {
                   console.log('E-mail enviado com sucesso!', response.status, response.text);
                   showNotification('Agendamento salvo e e-mail de confirmação enviado!', 'success');
                }, (error) => {
                   console.error('Falha ao enviar e-mail:', error);
                   showNotification('Agendamento salvo. ERRO ao enviar e-mail. Tente novamente.', 'error');
                });
        }
        
    </script>
</body>
</html>
