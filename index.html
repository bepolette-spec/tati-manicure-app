<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tati Manicure - Gerenciamento de Agendamentos</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #ff8c6b; /* Cor de Destaque (Salmão/Coral) */
            --secondary-color: #6c757d; /* Cinza para secundários */
            --background-color: #f4f7f6; /* Fundo Suave */
            --sidebar-bg: #ffffff;
            --sidebar-hover-bg: #fff0eb; /* Fundo mais claro para hover */
            --text-color: #343a40; /* Texto Principal (Escuro) */
            --success-color: #28a745;
            --info-color: #17a2b8;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --border-color: #e9ecef;
            --shadow-color: rgba(0, 0, 0, 0.05);
        }

        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            min-height: 100vh;
        }

        /* Estrutura do App */
        #login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            background-color: var(--primary-color);
            min-height: 100vh;
        }

        .login-card {
            background: var(--sidebar-bg);
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 15px var(--shadow-color);
            text-align: center;
            width: 100%;
            max-width: 400px;
        }

        .login-card h1 {
            color: var(--primary-color);
            margin-bottom: 30px;
            font-size: 1.8rem;
        }

        #app-container {
            display: none; /* Escondido por padrão, mostrado após o login */
            width: 100%;
        }

        /* Barra Lateral (Sidebar) */
        .sidebar {
            width: 250px;
            background-color: var(--sidebar-bg);
            box-shadow: 2px 0 5px var(--shadow-color);
            display: flex;
            flex-direction: column;
            padding: 20px 0;
            flex-shrink: 0;
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
            color: var(--primary-color);
            font-size: 1.6rem;
            font-weight: bold;
        }

        .sidebar ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar ul li a {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            text-decoration: none;
            color: var(--text-color);
            transition: background-color 0.2s, color 0.2s;
            font-weight: 500;
        }

        .sidebar ul li a:hover,
        .sidebar ul li a.active {
            background-color: var(--sidebar-hover-bg);
            color: var(--primary-color);
        }

        .sidebar ul li a .material-icons {
            margin-right: 10px;
            font-size: 20px;
        }

        .user-info {
            margin-top: auto;
            padding: 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .user-info p {
            margin: 0 0 10px 0;
            font-weight: bold;
        }

        /* Conteúdo Principal */
        .main-content {
            flex-grow: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .content-section {
            display: none;
            padding: 20px;
        }

        .content-section.active {
            display: block;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .section-header h2 {
            margin: 0;
            color: var(--text-color);
            font-size: 1.5rem;
        }
        
        /* Novas cores para Status de Pacote e Histórico */
        .status-package-paid {
             color: var(--success-color);
             font-weight: bold;
        }
        .status-package-pending {
            color: var(--secondary-color);
            font-weight: bold;
        }
        .status-package-active {
            color: var(--primary-color);
            font-weight: bold;
        }
        .status-package-finalized {
            color: var(--danger-color);
            font-weight: bold;
        }
        .status-package-warning {
             color: var(--warning-color);
             font-weight: bold;
        }


        /* Cartão (Card) */
        .card {
            background: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 4px var(--shadow-color);
            margin-bottom: 20px;
        }
        
        /* NOVO V6: Abas dentro de uma seção */
        .tab-menu {
             display: flex;
             border-bottom: 2px solid var(--border-color);
             margin-bottom: 20px;
        }
        .tab-menu button {
             padding: 10px 20px;
             border: none;
             background: transparent;
             cursor: pointer;
             font-size: 1rem;
             color: var(--secondary-color);
             border-bottom: 2px solid transparent;
             transition: border-color 0.2s, color 0.2s;
             font-weight: bold;
        }
        .tab-menu button.active {
             color: var(--primary-color);
             border-bottom: 2px solid var(--primary-color);
        }
        .tab-content {
             padding-top: 10px;
        }
        .tab-pane {
             display: none;
        }
        .tab-pane.active {
             display: block;
        }

        /* Formulários */
        .form-group {
            margin-bottom: 15px;
        }

        .form-row {
            display: flex;
            gap: 20px;
        }

        .form-row > div {
            flex: 1;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 0.95rem;
        }

        input[type="text"],
        input[type="number"],
        input[type="email"],
        input[type="tel"],
        input[type="date"],
        input[type="time"],
        textarea,
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        /* Datalist input */
        input[list] {
            /* Estilo para garantir que o input datalist se pareça com um campo normal */
            background-image: none;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="email"]:focus,
        input[type="tel"]:focus,
        input[type="date"]:focus,
        input[type="time"]:focus,
        textarea:focus,
        select:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        textarea {
            resize: vertical;
        }

        /* Botões */
        button, .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: background-color 0.2s, opacity 0.2s;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #e57a5e;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #218838;
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: var(--text-color);
        }

        .btn-warning:hover {
            background-color: #ffb547;
        }


        /* Tabelas */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table thead tr {
            background-color: var(--primary-color);
            color: white;
            text-align: left;
        }

        .data-table th, .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table tbody tr:hover {
            background-color: var(--sidebar-hover-bg);
        }

        .data-table td.action-buttons button {
            margin-right: 5px;
            padding: 6px 8px;
        }

        .data-table td.action-buttons {
            white-space: nowrap;
        }

        /* Notificação */
        #notification-bar {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s, transform 0.3s;
            transform: translateY(-20px);
            z-index: 1000;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            font-weight: bold;
        }

        #notification-bar.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        #notification-bar.success { background-color: var(--success-color); }
        #notification-bar.error { background-color: var(--danger-color); }
        #notification-bar.info { background-color: var(--info-color); }

        /* Utilitários */
        .flex-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .input-group {
            display: flex;
            gap: 10px;
        }
        
        .input-group input, .input-group select {
            flex-grow: 1;
        }

        .filter-row {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            margin-bottom: 20px;
        }
        .filter-row > div {
            flex: 1;
        }
        .filter-row button {
            flex-grow: 0;
            flex-shrink: 0;
            padding: 9px 15px; /* Ajuste para alinhar com o input */
        }
        
        /* NOVO V6: Estilos para a Tabela de Visão Diária */
        #tabela-visao-diaria {
             border: 1px solid var(--border-color);
             margin-top: 0;
        }
        #tabela-visao-diaria thead tr {
             background-color: var(--secondary-color);
        }
        #tabela-visao-diaria td {
             height: 40px; /* Altura padrão para cada intervalo de 30 min */
             font-size: 0.9rem;
             vertical-align: top;
        }
        .horario-celula {
             width: 80px;
             font-weight: bold;
             background-color: var(--sidebar-hover-bg);
             color: var(--text-color);
             text-align: center;
             vertical-align: middle !important;
             border-right: 1px solid var(--border-color);
        }
        .agendamento-vago {
             background-color: #f7fff7; /* Verde clarinho */
             color: var(--success-color);
             font-weight: bold;
             font-style: italic;
             text-align: center;
             line-height: 40px;
        }
        .agendamento-ocupado {
             background-color: #fff0eb; /* Fundo do hover de sidebar, suave */
             color: var(--text-color);
             font-weight: 500;
             padding: 5px 10px !important;
             vertical-align: middle !important;
             line-height: 1.2;
             border-left: 5px solid var(--primary-color);
             cursor: pointer;
        }
        .agendamento-ocupado strong {
             color: var(--primary-color);
             font-weight: bold;
        }
        
        /* --------------------------------------------------- */
        /* RESPONSIVIDADE MOBILE (Mobile First - Portrait Mode)*/
        /* --------------------------------------------------- */
        @media (max-width: 768px) {
            
            /* Estrutura Principal */
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
                box-shadow: 0 0 5px var(--shadow-color);
            }

            .main-content {
                padding: 15px;
            }

            #app-container {
                flex-direction: column;
            }

            /* Navegação Horizontal */
            .sidebar ul {
                display: flex;
                flex-wrap: nowrap; /* Tenta manter em uma linha, mas permite rolagem */
                overflow-x: auto;
                justify-content: flex-start;
                border-bottom: 1px solid var(--border-color);
            }

            .sidebar ul li {
                flex-shrink: 0; /* Impede que os itens encolham */
                text-align: center;
            }

            .sidebar ul li a {
                justify-content: center;
                padding: 10px;
                flex-direction: column;
                font-size: 0.75rem;
                white-space: nowrap;
            }

            .sidebar ul li a .material-icons {
                margin-right: 0;
                margin-bottom: 5px;
                font-size: 20px;
            }

            /* FIX: Botão Sair visível no celular */
            .user-info {
                display: block;
                padding: 10px 15px;
                border-top: none; 
                text-align: center; 
            }

            .user-info p {
                display: none; /* Esconde o texto "Olá, Tati!" para economizar espaço */
            }

            .user-info button {
                width: 100%;
                margin-top: 10px; 
                font-size: 0.9rem;
            }
            
            /* 1. Correção de Formulários e Filtros (Empilhamento) */
            .form-row, .filter-row {
                flex-direction: column;
                gap: 0; /* Remove gap quando empilha */
            }

            .form-row > div, 
            .filter-row > div {
                flex: 0 0 100% !important; /* Força largura total */
                width: 100%;
            }
            
            /* Ajusta margem para inputs empilhados */
            .form-group, .filter-row > div {
                margin-bottom: 10px;
            }
            
            .filter-row button {
                width: 100%;
                margin-top: 5px; 
                padding: 10px 15px !important;
            }
            
            /* V6: Ajuste para a Tabela de Visão Diária */
            .table-responsive {
                 overflow-x: auto;
            }
            #tabela-visao-diaria {
                 width: 100%;
                 min-width: 300px; /* Garante que não fique muito esmagada */
            }
            #tabela-visao-diaria td {
                 padding: 5px 10px !important;
            }

            /* 2. Correção de Tabelas (Cartão-like View) */
            .data-table, .data-table tbody, .data-table td, .data-table tr {
                display: block; /* Força elementos da tabela a empilhar */
            }

            .data-table thead {
                display: none; /* Esconde o cabeçalho original */
            }

            .data-table tr {
                border: 1px solid var(--border-color);
                margin-bottom: 15px;
                border-radius: 8px;
                box-shadow: 0 1px 3px var(--shadow-color);
                padding: 10px;
            }

            .data-table td {
                border: none;
                position: relative;
                padding-left: 50% !important; /* Espaço para o rótulo */
                text-align: right; /* Alinha o valor à direita */
                white-space: normal; /* Permite quebras de linha */
                min-height: 40px;
            }

            /* Rótulo customizado (que usa o data-label do JS) */
            .data-table td::before {
                content: attr(data-label);
                position: absolute;
                left: 10px;
                width: 45%; 
                padding-right: 10px;
                white-space: nowrap;
                text-align: left;
                font-weight: bold;
                color: var(--primary-color);
            }
            
            /* FIX V6: Organização dos botões de ação em mobile */
            /* Garante que o rótulo "Ações" não sobreponha o primeiro botão */
            .data-table td.action-buttons {
                text-align: left;
                padding-left: 10px !important;
                display: flex; 
                flex-direction: column; /* Empilha os botões */
                gap: 5px;
            }
            
            .data-table td.action-buttons::before {
                content: "Ações";
                width: 100%; 
                margin-bottom: 5px;
                display: block;
            }
            
            .data-table td.action-buttons button {
                margin: 0;
                width: 100%; /* Ocupa a largura toda */
                max-width: 100%;
                box-sizing: border-box;
                font-size: 0.9rem; 
                padding: 8px 5px;
            }
        }
    </style>
</head>
<body>

    <div id="notification-bar"></div>

    <div id="login-container">
        <div class="login-card">
            <h1>Tati Manicure - Acesso</h1>
            <form id="login-form">
                <div class="form-group">
                    <label for="loginSenha">Senha de Acesso</label>
                    <input type="password" id="loginSenha" required>
                </div>
                <button type="submit" class="btn-primary" style="width: 100%; margin-top: 10px;">
                    <span class="material-icons">login</span> Entrar
                </button>
            </form>
        </div>
    </div>

    <datalist id="clientes-datalist"></datalist>

    <div id="app-container">
        
        <aside class="sidebar">
            <div class="logo">TATI MANICURE APP</div>
            
            <ul>
                <li><a href="#" data-section="agenda" class="active"><span class="material-icons">calendar_today</span> Agenda</a></li>
                <li><a href="#" data-section="clientes"><span class="material-icons">people</span> Clientes</a></li>
                <li><a href="#" data-section="servicos"><span class="material-icons">local_offer</span> Serviços</a></li>
                <li><a href="#" data-section="historico"><span class="material-icons">history</span> Histórico/Lucros</a></li>
            </ul>

            <div class="user-info">
                <p id="userInfo">Olá, Tati!</p>
                <button id="logout-button" class="btn-danger" style="width: 100%;">
                    <span class="material-icons">logout</span> Sair
                </button>
            </div>
        </aside>

        <main class="main-content">

            <div id="agenda-section" class="content-section active">
                
                <div class="tab-menu">
                     <button class="tab-button active" onclick="showAgendaTab('pacotes-ativos', event)">Pacotes Ativos</button>
                     <button class="tab-button" onclick="showAgendaTab('novo-agendamento', event)">Novo Agendamento</button>
                     <button class="tab-button" onclick="showAgendaTab('lista-agendamentos', event)">Lista Agendamentos</button>
                     <button class="tab-button" onclick="showAgendaTab('visao-diaria', event)">Visão Diária</button>
                </div>
                
                <div class="tab-content">
                    
                    <div id="pacotes-ativos-pane" class="tab-pane active">
                         <div class="section-header"><h2>Gerenciamento de Pacotes Ativos</h2></div>
                         <div class="card">
                            <form id="pacote-inicio-form">
                                <h3>Iniciar Novo Pacote de Serviços</h3>
                                <div class="form-row">
                                    <div class="form-group" style="flex: 2;">
                                        <label for="pacote-cliente-id">Cliente</label>
                                        <select id="pacote-cliente-id" required></select>
                                    </div>
                                    <div class="form-group" style="flex: 2;">
                                        <label for="pacote-servico-id">Pacote (Serviços marcados como Pacote)</label>
                                        <select id="pacote-servico-id" required></select>
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label for="pacote-data-inicio">Data Início (Geralmente Hoje)</label>
                                        <input type="date" id="pacote-data-inicio" required>
                                    </div>
                                </div>

                                <div class="flex-container">
                                    <button type="submit" class="btn-primary">
                                         <span class="material-icons">add_box</span> Iniciar/Vender Pacote
                                    </button>
                                </div>
                            </form>
                            
                            <hr style="margin: 20px 0;">

                            <h3>Pacotes Ativos e Utilização</h3>
                            <div style="max-height: 500px; overflow-y: auto;">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 20%;">Cliente</th>
                                            <th style="width: 25%;">Pacote (Total/Usado)</th>
                                            <th style="width: 15%;">Pagamento</th>
                                            <th style="width: 15%;">Vencimento</th>
                                            <th style="width: 200px;">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="lista-pacotes-ativos">
                                        <tr><td colspan="5" style="text-align: center;">Carregando pacotes ativos...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div id="novo-agendamento-pane" class="tab-pane">
                        <div class="section-header"><h2>Agendamento de Serviços Individuais (Não-Pacote)</h2></div>
                         <div class="card">
                            <form id="agendamento-form">
                                <input type="hidden" id="agendamento-id">
                                
                                <div class="form-row">
                                    <div class="form-group" style="flex: 2;">
                                        <label for="agenda-cliente-id">Cliente</label>
                                        <select id="agenda-cliente-id" required></select>
                                    </div>
                                    <div class="form-group" style="flex: 2;">
                                        <label for="agenda-servico-id">Serviço Individual/Promoção</label>
                                        <select id="agenda-servico-id" required></select>
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label for="agenda-data">Data</label>
                                        <input type="date" id="agenda-data" required>
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="form-group" style="flex: 1;">
                                        <label for="agenda-hora">Hora Início</label>
                                        <input type="time" id="agenda-hora" required>
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label for="agenda-hora-fim">Hora Fim</label>
                                        <input type="time" id="agenda-hora-fim" required>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="agenda-observacoes">Observações</label>
                                    <textarea id="agenda-observacoes" rows="2"></textarea>
                                </div>

                                <div class="flex-container">
                                    <div>
                                        <button type="submit" class="btn-success" id="btn-salvar-agendamento">
                                            <span class="material-icons">save</span> Salvar Agendamento
                                        </button>
                                        <button type="button" class="btn-secondary" onclick="resetAgendamentoForm()">
                                            <span class="material-icons">refresh</span> Limpar
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div id="lista-agendamentos-pane" class="tab-pane">
                         <div class="section-header">
                             <h3>Próximos Agendamentos (Ativos e Aguardando Finalização)</h3>
                         </div>
                         <div class="card">
                            <div class="filter-row">
                                <div style="flex-grow: 1.5;">
                                    <label for="filtro-agenda-data">Filtrar por Data</label>
                                    <input type="date" id="filtro-agenda-data" onchange="carregarAgendamentos()">
                                </div>
                                <div style="flex-grow: 3;">
                                    <label for="filtro-agenda-cliente">Filtrar por Cliente (Digite ou Selecione)</label>
                                    <input type="text" id="filtro-agenda-cliente" list="clientes-datalist" placeholder="Digite o nome do cliente..." onkeyup="filtrarAgendamentos()">
                                </div>
                                <button class="btn-secondary" onclick="resetFiltroAgenda()"><span class="material-icons">refresh</span> Resetar Filtro</button>
                            </div>

                            <div style="max-height: 500px; overflow-y: auto;">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 15%;">Data/Hora</th>
                                            <th style="width: 25%;">Cliente</th>
                                            <th style="width: 25%;">Serviço</th>
                                            <th>Status</th>
                                            <th style="width: 150px;">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="lista-agendamentos">
                                        <tr><td colspan="5" style="text-align: center;">Carregando agendamentos...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div id="visao-diaria-pane" class="tab-pane">
                        <div class="section-header">
                            <h2>Visão Diária da Agenda</h2>
                        </div>
                        <div class="card">
                            <div class="filter-row">
                                <div style="flex-grow: 1;">
                                    <label for="filtro-visao-diaria-data">Selecione a Data</label>
                                    <input type="date" id="filtro-visao-diaria-data" onchange="renderizarVisaoDiaria()">
                                </div>
                                <button class="btn-secondary" onclick="renderizarVisaoDiaria(true)"><span class="material-icons">today</span> Ver Hoje</button>
                            </div>

                            <div class="table-responsive">
                                <table class="data-table" id="tabela-visao-diaria">
                                    <thead>
                                        <tr>
                                            <th style="width: 100px;">Horário</th>
                                            <th>Detalhes do Agendamento</th>
                                        </tr>
                                    </thead>
                                    <tbody id="lista-visao-diaria">
                                        <tr><td colspan="2" style="text-align: center;">Selecione uma data para visualizar.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <div id="clientes-section" class="content-section">
                <div class="section-header"><h2>Cadastro de Clientes</h2></div>
                <div class="card">
                    <form id="cliente-form">
                        <input type="hidden" id="cliente-id">
                        <div class="form-row">
                            <div class="form-group" style="flex: 2;">
                                <label for="cliente-nome">Nome Completo</label>
                                <input type="text" id="cliente-nome" required>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label for="cliente-telefone">Telefone (Whatsapp)</label>
                                <input type="tel" id="cliente-telefone">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="cliente-email">E-mail (Opcional)</label>
                            <input type="email" id="cliente-email">
                        </div>
                        <div class="form-group">
                            <label for="cliente-endereco">Endereço (Opcional)</label>
                            <input type="text" id="cliente-endereco">
                        </div>
                        <div class="form-group">
                            <label for="cliente-observacoes">Observações (Alergias, Preferências)</label>
                            <textarea id="cliente-observacoes" rows="2"></textarea>
                        </div>
                        <div class="flex-container">
                            <div>
                                <button type="submit" class="btn-success" id="btn-salvar-cliente">
                                    <span class="material-icons">save</span> Salvar Cliente
                                </button>
                                <button type="button" class="btn-secondary" onclick="resetClienteForm()">
                                    <span class="material-icons">refresh</span> Limpar
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="section-header">
                    <h3>Lista de Clientes Cadastrados</h3>
                    <div class="input-group" style="width: 300px;">
                        <input type="text" id="filtro-clientes" list="clientes-datalist" placeholder="Filtrar por nome, tel ou email..." onkeyup="filtrarClientes()">
                    </div>
                </div>
                <div class="card">
                    <div style="max-height: 500px; overflow-y: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th style="width: 30%;">Nome</th>
                                    <th style="width: 20%;">Telefone</th>
                                    <th style="width: 30%;">E-mail</th>
                                    <th style="width: 150px;">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="lista-clientes">
                                <tr><td colspan="4" style="text-align: center;">Carregando clientes...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="servicos-section" class="content-section">
                <div class="section-header"><h2>Cadastro de Serviços/Pacotes</h2></div>
                <div class="card">
                    <form id="servico-form">
                        <input type="hidden" id="servico-id">
                        <div class="form-row">
                            <div class="form-group" style="flex: 2;">
                                <label for="servico-nome">Nome do Serviço</label>
                                <input type="text" id="servico-nome" required>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label for="servico-preco">Preço (R$)</label>
                                <input type="number" id="servico-preco" step="0.01" min="0" required value="0.00">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <label>
                                    <input type="checkbox" id="servico-isPacote"> É um **Pacote Mensal**?
                                </label>
                            </div>
                            <div class="form-group" id="group-quantidade-total" style="flex: 1; display: none;">
                                <label for="servico-quantidade-total">Total de Procedimentos no Pacote (ex: 6)</label>
                                <input type="number" id="servico-quantidade-total" min="1" value="1">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="servico-descricao">Descrição Detalhada (ex: 4 Mãos e 2 Pés)</label>
                            <textarea id="servico-descricao" rows="2"></textarea>
                        </div>
                        <div class="flex-container">
                            <div>
                                <button type="submit" class="btn-success" id="btn-salvar-servico">
                                    <span class="material-icons">save</span> Salvar Serviço
                                </button>
                                <button type="button" class="btn-secondary" onclick="resetServicoForm()">
                                    <span class="material-icons">refresh</span> Limpar
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="section-header">
                    <h3>Lista de Serviços e Preços</h3>
                </div>
                <div class="card">
                    <div style="max-height: 500px; overflow-y: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th style="width: 40%;">Serviço</th>
                                    <th style="width: 15%;">Tipo</th>
                                    <th style="width: 15%;">Total Proc.</th>
                                    <th style="width: 15%;">Preço</th>
                                    <th style="width: 150px;">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="lista-servicos">
                                <tr><td colspan="5" style="text-align: center;">Carregando serviços...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="historico-section" class="content-section">
                <div class="section-header"><h2>Histórico de Agendamentos e Lucros Mensais</h2></div>
                <div class="card" style="margin-bottom: 30px;">
                    <h3>Resumo de Lucros (Todos os Meses)</h3> 
                    <table class="data-table" id="tabela-lucros-mensais">
                        <thead>
                            <tr>
                                <th style="width: 25%;">Mês/Ano</th>
                                <th style="width: 25%;">Total Agendamentos</th>
                                <th style="width: 25%;">Lucro Total (R$)</th>
                                <th style="width: 25%;">Detalhes</th>
                            </tr>
                        </thead>
                        <tbody id="lista-lucros-mensais">
                            <tr><td colspan="4" style="text-align: center;">Carregando resumo financeiro...</td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="section-header">
                    <h3>Histórico Completo (Agendamentos Finalizados)</h3>
                </div>
                <div class="card">
                    <div class="filter-row">
                        <div style="flex-grow: 1;">
                            <label for="filtro-historico-mes">Filtrar por Mês (Lucros)</label>
                            <input type="month" id="filtro-historico-mes" onchange="renderizarHistorico()">
                        </div>
                        <div style="flex-grow: 2;">
                            <label for="filtro-historico-cliente">Filtrar Cliente</label>
                            <input type="text" id="filtro-historico-cliente" list="clientes-datalist" placeholder="Digite o nome do cliente..." onkeyup="filtrarHistoricoTabela()">
                        </div>
                        <button class="btn-secondary" onclick="resetFiltroHistorico()"><span class="material-icons">refresh</span> Resetar Filtro</button>
                    </div>
                    <div style="max-height: 500px; overflow-y: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th style="width: 15%;">Data/Hora</th>
                                    <th style="width: 25%;">Cliente</th>
                                    <th style="width: 25%;">Serviço</th>
                                    <th style="width: 10%;">Valor (R$)</th>
                                    <th style="width: 150px;">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="lista-historico">
                                <tr><td colspan="5" style="text-align: center;">Carregando histórico...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
        import { getDatabase, ref, onValue, push, set, update, remove, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

        // =================================================================
        // 1.1. CONFIGURAÇÃO FIREBASE E VARIÁVEIS GLOBAIS
        // =================================================================
        // Sua configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBatp6e1NzevurpB2yS8eGErgSYC_t2-Nc",
            authDomain: "tati-manicure.firebaseapp.com",
            databaseURL: "https://tati-manicure-default-rtdb.firebaseio.com", // Confirme se este é o URL correto do seu Realtime Database
            projectId: "tati-manicure",
            storageBucket: "tati-manicure.firebaseapp.com",
            messagingSenderId: "1061777323027",
            appId: "1:1061777323027:web:7b54e5fdbb7f06ee293be6",
            measurementId: "G-V3J5ZJ5XBT"
        };

        // Inicialização do Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Referências aos nós (listas/tabelas) do seu banco de dados
        const clientesRef = ref(db, 'clientes');
        const servicosRef = ref(db, 'servicos');
        const agendamentosRef = ref(db, 'agendamentos');
        const pacotesAtivosRef = ref(db, 'pacotes_ativos');
        
        const SENHA_UNICA = "tati123";

        // Caches de Dados
        let cacheClientes = {};
        let cacheServicos = {};
        let cachePacotes = {};
        let cacheAgendamentos = {}; // Adicionado para uso na reversão
        
        let agendamentosAtivos = [];
        let agendamentosHistorico = [];
        let pacotesAtivosList = [];
        let clientesDataList = [];

        // =================================================================
        // 1.2. FUNÇÕES DE UTILIDADE E UI GERAL
        // =================================================================

        // Função auxiliar para converter o snapshot do RTDB em um array de objetos
        function snapshotToArray(snapshot) {
            const arr = [];
            snapshot.forEach(childSnapshot => {
                const item = childSnapshot.val();
                item.id = childSnapshot.key;
                arr.push(item);
            });
            return arr;
        }

        // Função para formatar data e hora
        function formatarDataHora(dataHoraString) {
            const d = new Date(dataHoraString);
            return d.toLocaleDateString('pt-BR') + ' ' + d.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        }

        function formatarData(dataString) {
            const d = new Date(dataString);
            return d.toLocaleDateString('pt-BR');
        }

        // Função para formatar moeda
        function formatarMoeda(valor) {
            return parseFloat(valor).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        // Função para exibir notificações
        window.showNotification = function(message, type = 'info') {
            const bar = document.getElementById('notification-bar');
            bar.textContent = message;
            bar.className = `show ${type}`;
            setTimeout(() => {
                bar.className = '';
            }, 3000);
        }

        // Função para mudar a seção principal
        window.showSection = function(sectionId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');

            // Atualiza o menu lateral
            document.querySelectorAll('.sidebar ul li a').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('data-section') === sectionId.replace('-section', '')) {
                    link.classList.add('active');
                }
            });

            // Lógica de carregamento específica por seção
            if (sectionId === 'agenda-section') {
                // Apenas garante que a aba ativa está carregando os dados corretos
                const activePane = document.querySelector('#agenda-section .tab-pane.active');
                if (activePane.id === 'lista-agendamentos-pane') carregarAgendamentos();
                else if (activePane.id === 'pacotes-ativos-pane') carregarPacotesAtivos();
                else if (activePane.id === 'visao-diaria-pane') renderizarVisaoDiaria();
            } else if (sectionId === 'historico-section') {
                renderizarHistorico();
            } else if (sectionId === 'clientes-section') {
                renderizarClientes();
            } else if (sectionId === 'servicos-section') {
                renderizarServicos();
            }
        }

        // Função para mudar a aba na seção Agenda
        window.showAgendaTab = function(paneId, event) {
            document.querySelectorAll('#agenda-section .tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });
            document.getElementById(paneId + '-pane').classList.add('active');

            document.querySelectorAll('#agenda-section .tab-button').forEach(button => {
                button.classList.remove('active');
            });
            if (event) {
                event.currentTarget.classList.add('active');
            } else {
                // Caso seja chamado programaticamente
                document.querySelector(`.tab-button[onclick*='${paneId}']`).classList.add('active');
            }

            if (paneId === 'lista-agendamentos' || paneId === 'novo-agendamento') {
                carregarAgendamentos(); // Garante que a lista de agendamentos esteja carregada
            } else if (paneId === 'visao-diaria') {
                document.getElementById('filtro-visao-diaria-data').value = new Date().toISOString().slice(0, 10);
                renderizarVisaoDiaria();
            } else if (paneId === 'pacotes-ativos') {
                carregarPacotesAtivos();
            }
        }

        // Lógica de Login
        const senhaAcesso = SENHA_UNICA;

        function showLogin() {
            document.getElementById('app-container').style.display = 'none';
            document.getElementById('login-container').style.display = 'flex';
        }

        function showApp() {
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('app-container').style.display = 'flex';
            // Carrega os dados iniciais do app
            showSection('agenda-section');
        }

        // =================================================================
        // 2. FUNÇÕES DE CARREGAMENTO DE DADOS (RTDB LISTENER)
        // =================================================================

        // 2.1. Clientes
        function carregarClientes() {
            onValue(clientesRef, (snapshot) => {
                clientesDataList = snapshotToArray(snapshot);
                cacheClientes = clientesDataList.reduce((acc, cli) => {
                    acc[cli.id] = cli;
                    return acc;
                }, {});
                
                renderizarClientes();
                atualizarDatalistClientes();
                // Atualiza as listas de seleção de cliente
                popularSelectClientes(document.getElementById('agenda-cliente-id'));
                popularSelectClientes(document.getElementById('pacote-cliente-id'));

                showNotification('Clientes atualizados com sucesso.', 'info');
            }, (error) => {
                console.error("Erro ao carregar clientes:", error);
                showNotification('Erro ao carregar clientes.', 'error');
            });
        }

        function atualizarDatalistClientes() {
            const datalist = document.getElementById('clientes-datalist');
            datalist.innerHTML = '';
            clientesDataList.forEach(cliente => {
                const option = document.createElement('option');
                option.value = cliente.nome;
                option.setAttribute('data-id', cliente.id);
                datalist.appendChild(option);
            });
        }

        function popularSelectClientes(selectElement) {
             selectElement.innerHTML = '<option value="" disabled selected>Selecione um cliente</option>';
             clientesDataList.forEach(cliente => {
                 const option = document.createElement('option');
                 option.value = cliente.id;
                 option.textContent = cliente.nome;
                 selectElement.appendChild(option);
             });
        }
        
        // 2.2. Serviços
        function carregarServicos() {
             onValue(servicosRef, (snapshot) => {
                const servicosList = snapshotToArray(snapshot);
                cacheServicos = servicosList.reduce((acc, svc) => {
                    acc[svc.id] = svc;
                    return acc;
                }, {});
                
                renderizarServicos();
                
                // Atualiza as listas de seleção de serviço (Agenda - Individual)
                popularSelectServicos(document.getElementById('agenda-servico-id'), false);
                // Atualiza as listas de seleção de serviço (Pacote)
                popularSelectServicos(document.getElementById('pacote-servico-id'), true);
                
                showNotification('Serviços atualizados com sucesso.', 'info');
            }, (error) => {
                console.error("Erro ao carregar serviços:", error);
                showNotification('Erro ao carregar serviços.', 'error');
            });
        }

        function popularSelectServicos(selectElement, isPacote) {
             selectElement.innerHTML = '<option value="" disabled selected>Selecione um serviço</option>';
             Object.values(cacheServicos).filter(svc => !!svc.isPacote === isPacote)
                 .forEach(servico => {
                 const option = document.createElement('option');
                 option.value = servico.id;
                 option.textContent = `${servico.nome} (${formatarMoeda(servico.preco)})`;
                 selectElement.appendChild(option);
             });
        }
        
        // 2.3. Pacotes Ativos
        function carregarPacotesAtivos() {
             onValue(pacotesAtivosRef, (snapshot) => {
                pacotesAtivosList = snapshotToArray(snapshot);
                cachePacotes = pacotesAtivosList.reduce((acc, pkg) => {
                    acc[pkg.id] = pkg;
                    return acc;
                }, {});
                
                renderizarPacotesAtivos();
                showNotification('Pacotes ativos atualizados.', 'info');
            }, (error) => {
                console.error("Erro ao carregar pacotes ativos:", error);
                showNotification('Erro ao carregar pacotes ativos.', 'error');
            });
        }
        
        // 2.4. Agendamentos
        function carregarAgendamentos() {
            // Consulta o Realtime Database para agendamentos
            onValue(agendamentosRef, (snapshot) => {
                const agendamentosList = snapshotToArray(snapshot).sort((a, b) => new Date(a.dataHora) - new Date(b.dataHora));
                
                // Caches para acesso rápido
                cacheAgendamentos = agendamentosList.reduce((acc, agd) => {
                    acc[agd.id] = agd;
                    return acc;
                }, {});

                // Agendamentos ativos: Aqueles que NÃO estão finalizados. (Melhoria 1)
                agendamentosAtivos = agendamentosList.filter(a => !a.isFinalizado);
                
                // Agendamentos Histórico: Aqueles que ESTÃO finalizados. (Melhoria 1)
                agendamentosHistorico = agendamentosList.filter(a => a.isFinalizado);
                
                // Renderiza a lista se a aba estiver ativa
                const listaAgendamentosPane = document.getElementById('lista-agendamentos-pane');
                if (listaAgendamentosPane && listaAgendamentosPane.classList.contains('active')) {
                    filtrarAgendamentos();
                }
                
                // Renderiza a visão diária se a aba estiver ativa
                const visaoDiariaPane = document.getElementById('visao-diaria-pane');
                if (visaoDiariaPane && visaoDiariaPane.classList.contains('active')) {
                    renderizarVisaoDiaria();
                }
                
                // Renderiza o histórico se a aba estiver ativa
                const historicoSection = document.getElementById('historico-section');
                if (historicoSection && historicoSection.classList.contains('active')) {
                    renderizarHistorico();
                }

                showNotification('Agendamentos atualizados com sucesso.', 'info');
            }, (error) => {
                console.error("Erro ao carregar agendamentos:", error);
                showNotification('Erro ao carregar agendamentos.', 'error');
            });
        }

        // =================================================================
        // 3. FUNÇÕES CRUD (AGENDAMENTO)
        // =================================================================

        // 3.1. Salvar/Atualizar Agendamento
        document.getElementById('agendamento-form').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const agendamentoId = document.getElementById('agendamento-id').value;
            const clienteId = document.getElementById('agenda-cliente-id').value;
            const servicoId = document.getElementById('agenda-servico-id').value;
            const data = document.getElementById('agenda-data').value;
            const hora = document.getElementById('agenda-hora').value;
            const horaFim = document.getElementById('agenda-hora-fim').value;
            const observacoes = document.getElementById('agenda-observacoes').value;
            
            // Verifica se o cliente e o serviço existem
            if (!clienteId || !servicoId) {
                showNotification('Selecione um cliente e um serviço válidos.', 'error');
                return;
            }

            const clienteNome = cacheClientes[clienteId]?.nome || 'Desconhecido';
            const servico = cacheServicos[servicoId];

            if (!servico) {
                 showNotification('Serviço inválido.', 'error');
                 return;
            }

            const agendamentoData = {
                clienteId: clienteId,
                clienteNome: clienteNome,
                servicoId: servicoId,
                servicoNome: servico.nome,
                preco: servico.preco, // O valor do serviço individual
                dataHora: `${data}T${hora}:00`,
                dataHoraFim: `${data}T${horaFim}:00`,
                observacoes: observacoes,
                isPacote: false, // Agendamento individual
                isFinalizado: false, // MELHORIA 1: Novo campo
                dataCriacao: new Date().toISOString()
            };

            const refToSave = agendamentoId ? ref(db, `agendamentos/${agendamentoId}`) : push(agendamentosRef);
            
            set(refToSave, agendamentoData)
                .then(() => {
                    showNotification(`Agendamento de ${clienteNome} salvo com sucesso!`, 'success');
                    resetAgendamentoForm();
                    // Muda para a lista de agendamentos após salvar
                    showAgendaTab('lista-agendamentos'); 
                })
                .catch(error => {
                    console.error("Erro ao salvar agendamento:", error);
                    showNotification('Erro ao salvar agendamento.', 'error');
                });
        });

        // 3.2. Deletar Agendamento (Usado para Cancelar)
        window.deletarAgendamento = function(id, nomeCliente) {
            if (confirm(`Tem certeza que deseja DELETAR/CANCELAR o agendamento de ${nomeCliente}? Este agendamento NÃO aparecerá mais no histórico.`)) {
                remove(ref(db, `agendamentos/${id}`))
                    .then(() => {
                        showNotification(`Agendamento de ${nomeCliente} deletado/cancelado.`, 'info');
                    })
                    .catch(error => {
                        console.error("Erro ao deletar agendamento:", error);
                        showNotification('Erro ao deletar agendamento.', 'error');
                    });
            }
        }
        
        // 3.3. Marcar Agendamento como Finalizado (MELHORIA 1: Nova função)
        window.finalizarAgendamento = function(id, nomeCliente) {
            if (confirm(`Tem certeza que deseja FINALIZAR o agendamento de ${nomeCliente}? Ele será movido para o Histórico Completo.`)) {
                 update(ref(db, `agendamentos/${id}`), { isFinalizado: true })
                    .then(() => {
                        showNotification(`Agendamento de ${nomeCliente} finalizado e movido para o histórico.`, 'success');
                        // O listener de carregarAgendamentos irá renderizar a UI
                    })
                    .catch(error => {
                        console.error("Erro ao finalizar agendamento:", error);
                        showNotification('Erro ao finalizar agendamento.', 'error');
                    });
            }
        }

        // 3.4. Editar Agendamento (Preenche o formulário)
        window.editarAgendamento = function(id) {
             const agendamento = cacheAgendamentos[id];
             if (!agendamento) return;
             
             // 1. Muda para a aba de novo agendamento
             showAgendaTab('novo-agendamento');
             
             // 2. Preenche o formulário
             document.getElementById('agendamento-id').value = id;
             
             // Popula os selects (garantindo que o cliente e serviço estejam visíveis)
             document.getElementById('agenda-cliente-id').value = agendamento.clienteId;
             document.getElementById('agenda-servico-id').value = agendamento.servicoId;

             // Extrai data e hora
             const dataHora = new Date(agendamento.dataHora);
             const dataHoraFim = new Date(agendamento.dataHoraFim);
             
             document.getElementById('agenda-data').value = agendamento.dataHora.slice(0, 10);
             document.getElementById('agenda-hora').value = dataHora.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', hour12: false });
             document.getElementById('agenda-hora-fim').value = dataHoraFim.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', hour12: false });
             document.getElementById('agenda-observacoes').value = agendamento.observacoes || '';
             
             // 3. Altera texto do botão
             document.getElementById('btn-salvar-agendamento').textContent = 'Atualizar Agendamento';
             document.getElementById('btn-salvar-agendamento').prepend(document.createElement('span')).className = 'material-icons';
             document.getElementById('btn-salvar-agendamento').firstChild.textContent = 'update';
        }

        // 3.5. Limpar Formulário de Agendamento
        window.resetAgendamentoForm = function() {
            document.getElementById('agendamento-form').reset();
            document.getElementById('agendamento-id').value = '';
             // Resetar os selects para a opção padrão
             document.getElementById('agenda-cliente-id').selectedIndex = 0;
             document.getElementById('agenda-servico-id').selectedIndex = 0;
            
            // Configura a data de hoje
            document.getElementById('agenda-data').value = new Date().toISOString().slice(0, 10);

            // Restaura texto do botão
             document.getElementById('btn-salvar-agendamento').textContent = 'Salvar Agendamento';
             document.getElementById('btn-salvar-agendamento').prepend(document.createElement('span')).className = 'material-icons';
             document.getElementById('btn-salvar-agendamento').firstChild.textContent = 'save';
        }

        // =================================================================
        // 4. FUNÇÕES CRUD (CLIENTE)
        // =================================================================

        // 4.1. Salvar/Atualizar Cliente
        document.getElementById('cliente-form').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const clienteId = document.getElementById('cliente-id').value;
            const clienteData = {
                nome: document.getElementById('cliente-nome').value,
                telefone: document.getElementById('cliente-telefone').value,
                email: document.getElementById('cliente-email').value,
                endereco: document.getElementById('cliente-endereco').value,
                observacoes: document.getElementById('cliente-observacoes').value,
            };

            const refToSave = clienteId ? ref(db, `clientes/${clienteId}`) : push(clientesRef);
            
            set(refToSave, clienteData)
                .then(() => {
                    showNotification(`Cliente ${clienteData.nome} salvo com sucesso!`, 'success');
                    resetClienteForm();
                })
                .catch(error => {
                    console.error("Erro ao salvar cliente:", error);
                    showNotification('Erro ao salvar cliente.', 'error');
                });
        });

        // 4.2. Deletar Cliente
        window.deletarCliente = function(id, nome) {
            if (confirm(`Tem certeza que deseja deletar o cliente ${nome}? Todos os agendamentos e pacotes ligados a ele não serão excluídos, mas aparecerão como "Cliente Desconhecido".`)) {
                remove(ref(db, `clientes/${id}`))
                    .then(() => {
                        showNotification(`Cliente ${nome} deletado.`, 'info');
                    })
                    .catch(error => {
                        console.error("Erro ao deletar cliente:", error);
                        showNotification('Erro ao deletar cliente.', 'error');
                    });
            }
        }
        
        // 4.3. Editar Cliente (Preenche o formulário)
        window.editarCliente = function(id) {
             const cliente = cacheClientes[id];
             if (!cliente) return;
             
             document.getElementById('cliente-id').value = id;
             document.getElementById('cliente-nome').value = cliente.nome;
             document.getElementById('cliente-telefone').value = cliente.telefone || '';
             document.getElementById('cliente-email').value = cliente.email || '';
             document.getElementById('cliente-endereco').value = cliente.endereco || '';
             document.getElementById('cliente-observacoes').value = cliente.observacoes || '';
             
             document.getElementById('btn-salvar-cliente').textContent = 'Atualizar Cliente';
             document.getElementById('btn-salvar-cliente').prepend(document.createElement('span')).className = 'material-icons';
             document.getElementById('btn-salvar-cliente').firstChild.textContent = 'update';
        }

        // 4.4. Limpar Formulário de Cliente
        window.resetClienteForm = function() {
            document.getElementById('cliente-form').reset();
            document.getElementById('cliente-id').value = '';
            
            document.getElementById('btn-salvar-cliente').textContent = 'Salvar Cliente';
             document.getElementById('btn-salvar-cliente').prepend(document.createElement('span')).className = 'material-icons';
             document.getElementById('btn-salvar-cliente').firstChild.textContent = 'save';
        }

        // =================================================================
        // 5. FUNÇÕES CRUD (SERVIÇO)
        // =================================================================

        // 5.1. Listener para alternar campos de Pacote
        document.getElementById('servico-isPacote').addEventListener('change', (e) => {
            const group = document.getElementById('group-quantidade-total');
            if (e.target.checked) {
                group.style.display = 'block';
                document.getElementById('servico-quantidade-total').required = true;
            } else {
                group.style.display = 'none';
                document.getElementById('servico-quantidade-total').required = false;
            }
        });

        // 5.2. Salvar/Atualizar Serviço
        document.getElementById('servico-form').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const servicoId = document.getElementById('servico-id').value;
            const isPacote = document.getElementById('servico-isPacote').checked;
            
            const servicoData = {
                nome: document.getElementById('servico-nome').value,
                preco: parseFloat(document.getElementById('servico-preco').value),
                descricao: document.getElementById('servico-descricao').value,
                isPacote: isPacote,
                quantidadeTotal: isPacote ? parseInt(document.getElementById('servico-quantidade-total').value) : null,
            };

            const refToSave = servicoId ? ref(db, `servicos/${servicoId}`) : push(servicosRef);
            
            set(refToSave, servicoData)
                .then(() => {
                    showNotification(`Serviço ${servicoData.nome} salvo com sucesso!`, 'success');
                    resetServicoForm();
                })
                .catch(error => {
                    console.error("Erro ao salvar serviço:", error);
                    showNotification('Erro ao salvar serviço.', 'error');
                });
        });

        // 5.3. Deletar Serviço
        window.deletarServico = function(id, nome) {
            if (confirm(`Tem certeza que deseja deletar o serviço/pacote ${nome}?`)) {
                remove(ref(db, `servicos/${id}`))
                    .then(() => {
                        showNotification(`Serviço ${nome} deletado.`, 'info');
                    })
                    .catch(error => {
                        console.error("Erro ao deletar serviço:", error);
                        showNotification('Erro ao deletar serviço.', 'error');
                    });
            }
        }
        
        // 5.4. Editar Serviço (Preenche o formulário)
        window.editarServico = function(id) {
             const servico = cacheServicos[id];
             if (!servico) return;
             
             document.getElementById('servico-id').value = id;
             document.getElementById('servico-nome').value = servico.nome;
             document.getElementById('servico-preco').value = servico.preco;
             document.getElementById('servico-descricao').value = servico.descricao || '';
             
             const isPacoteInput = document.getElementById('servico-isPacote');
             isPacoteInput.checked = servico.isPacote || false;
             
             const groupQtde = document.getElementById('group-quantidade-total');
             if (servico.isPacote) {
                 groupQtde.style.display = 'block';
                 document.getElementById('servico-quantidade-total').value = servico.quantidadeTotal || 1;
                 document.getElementById('servico-quantidade-total').required = true;
             } else {
                 groupQtde.style.display = 'none';
                 document.getElementById('servico-quantidade-total').required = false;
             }
             
             document.getElementById('btn-salvar-servico').textContent = 'Atualizar Serviço';
             document.getElementById('btn-salvar-servico').prepend(document.createElement('span')).className = 'material-icons';
             document.getElementById('btn-salvar-servico').firstChild.textContent = 'update';
        }

        // 5.5. Limpar Formulário de Serviço
        window.resetServicoForm = function() {
            document.getElementById('servico-form').reset();
            document.getElementById('servico-id').value = '';
            document.getElementById('group-quantidade-total').style.display = 'none';
            document.getElementById('servico-quantidade-total').required = false;
            
            document.getElementById('btn-salvar-servico').textContent = 'Salvar Serviço';
             document.getElementById('btn-salvar-servico').prepend(document.createElement('span')).className = 'material-icons';
             document.getElementById('btn-salvar-servico').firstChild.textContent = 'save';
        }

        // =================================================================
        // 6. FUNÇÕES CRUD (PACOTES ATIVOS)
        // =================================================================
        
        // 6.1. Iniciar Novo Pacote
        document.getElementById('pacote-inicio-form').addEventListener('submit', (e) => {
             e.preventDefault();
             
             const clienteId = document.getElementById('pacote-cliente-id').value;
             const servicoId = document.getElementById('pacote-servico-id').value;
             const dataInicio = document.getElementById('pacote-data-inicio').value;
             
             const cliente = cacheClientes[clienteId];
             const pacoteServico = cacheServicos[servicoId];
             
             if (!cliente || !pacoteServico) {
                 showNotification('Selecione um cliente e um pacote válidos.', 'error');
                 return;
             }
             
             if (!pacoteServico.isPacote) {
                 showNotification('O serviço selecionado não é um pacote.', 'error');
                 return;
             }

             // Verifica se o cliente já tem este pacote ativo (opcional, mas bom)
             const pacoteExistente = pacotesAtivosList.find(p => p.clienteId === clienteId && p.servicoId === servicoId && p.status === 'ativo');
             if (pacoteExistente) {
                 showNotification('Este cliente já possui este pacote ativo.', 'warning');
                 return;
             }
             
             const novoPacoteData = {
                 clienteId: clienteId,
                 clienteNome: cliente.nome,
                 servicoId: servicoId,
                 servicoNome: pacoteServico.nome,
                 precoTotal: pacoteServico.preco,
                 quantidadeTotal: pacoteServico.quantidadeTotal,
                 quantidadeUsada: 0,
                 dataInicio: dataInicio,
                 dataCriacao: new Date().toISOString(),
                 status: 'ativo', // ativo, pendente_pagamento, finalizado
                 statusPagamento: 'pendente' // pendente, pago
             };
             
             push(pacotesAtivosRef, novoPacoteData)
                 .then(() => {
                     showNotification(`Pacote ${pacoteServico.nome} iniciado para ${cliente.nome}.`, 'success');
                     document.getElementById('pacote-inicio-form').reset();
                     document.getElementById('pacote-data-inicio').value = new Date().toISOString().slice(0, 10);
                 })
                 .catch(error => {
                     console.error("Erro ao iniciar pacote:", error);
                     showNotification('Erro ao iniciar pacote.', 'error');
                 });
        });
        
        // 6.2. Usar Serviço do Pacote (Adiciona agendamento e atualiza contagem)
        window.usarPacote = function(pacoteId, clienteNome, servicoNome) {
            const pacote = cachePacotes[pacoteId];
            if (!pacote) return;
            
            if (pacote.quantidadeUsada >= pacote.quantidadeTotal) {
                 showNotification('Todos os serviços deste pacote já foram utilizados.', 'error');
                 return;
            }
            
            // 1. Cria um Agendamento ligado ao pacote
            const now = new Date();
            const dataAtual = now.toISOString().slice(0, 10);
            const horaAtual = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', hour12: false });
            
            // Estima o fim em 30 minutos, o usuário deve ajustar no histórico se quiser
            const horaFimEstimada = new Date(now.getTime() + 30 * 60000).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', hour12: false });
            
            const agendamentoData = {
                clienteId: pacote.clienteId,
                clienteNome: pacote.clienteNome,
                servicoId: pacote.servicoId, // ID do Pacote
                servicoNome: `${pacote.servicoNome} (Uso do Pacote)`,
                preco: 0, // O serviço do pacote é R$ 0,00 no agendamento individual
                dataHora: `${dataAtual}T${horaAtual}:00`,
                dataHoraFim: `${dataAtual}T${horaFimEstimada}:00`,
                observacoes: `Procedimento do Pacote (Uso ${pacote.quantidadeUsada + 1}/${pacote.quantidadeTotal}).`,
                isPacote: true,
                pacoteId: pacoteId,
                isFinalizado: false, // MELHORIA 1: Novo campo
                dataCriacao: now.toISOString()
            };

            const agendamentoRefToSave = push(agendamentosRef);
            
            set(agendamentoRefToSave, agendamentoData)
                 .then(() => {
                    // 2. Atualiza a contagem de uso do Pacote
                    const novaQtdeUsada = pacote.quantidadeUsada + 1;
                    const novoStatus = novaQtdeUsada >= pacote.quantidadeTotal ? 'finalizado' : 'ativo';

                    const updates = {
                         quantidadeUsada: novaQtdeUsada,
                         status: novoStatus
                    };
                    
                    return update(ref(db, `pacotes_ativos/${pacoteId}`), updates);
                 })
                 .then(() => {
                     showNotification(`Uso ${pacote.quantidadeUsada + 1} de ${servicoNome} registrado para ${clienteNome}.`, 'success');
                 })
                 .catch(error => {
                     console.error("Erro ao usar pacote:", error);
                     showNotification('Erro ao registrar uso do pacote.', 'error');
                 });
        }
        
        // 6.3. Marcar Pagamento do Pacote
        window.marcarPagamentoPacote = function(pacoteId, clienteNome, status) {
             const novoStatus = status === 'pago' ? 'pendente' : 'pago';
             const updates = { statusPagamento: novoStatus };
             
             update(ref(db, `pacotes_ativos/${pacoteId}`), updates)
                 .then(() => {
                     showNotification(`Pagamento do pacote de ${clienteNome} marcado como ${novoStatus.toUpperCase()}.`, 'info');
                 })
                 .catch(error => {
                     console.error("Erro ao atualizar pagamento:", error);
                     showNotification('Erro ao atualizar pagamento.', 'error');
                 });
        }

        // =================================================================
        // 7. FUNÇÕES DE RENDERIZAÇÃO (UI)
        // =================================================================

        // 7.1. Renderizar Clientes (Tabela)
        function renderizarClientes() {
            const tbody = document.getElementById('lista-clientes');
            tbody.innerHTML = '';
            
            const listaFiltrada = filtrarClientes();

            if (listaFiltrada.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" style="text-align: center;">Nenhum cliente encontrado.</td></tr>`;
                return;
            }

            listaFiltrada.forEach(cliente => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td data-label="Nome">${cliente.nome}</td>
                    <td data-label="Telefone">${cliente.telefone || '-'}</td>
                    <td data-label="E-mail">${cliente.email || '-'}</td>
                    <td data-label="Ações" class="action-buttons">
                        <button class="btn-warning" onclick="editarCliente('${cliente.id}')"><span class="material-icons">edit</span> Editar</button>
                        <button class="btn-danger" onclick="deletarCliente('${cliente.id}', '${cliente.nome}')"><span class="material-icons">delete</span> Excluir</button>
                    </td>
                `;
            });
        }

        // 7.2. Filtrar Clientes
        window.filtrarClientes = function() {
            const filtro = document.getElementById('filtro-clientes').value.toLowerCase();
            return clientesDataList.filter(cliente => 
                cliente.nome.toLowerCase().includes(filtro) ||
                (cliente.telefone && cliente.telefone.includes(filtro)) ||
                (cliente.email && cliente.email.toLowerCase().includes(filtro))
            );
        }
        
        // 7.3. Renderizar Serviços (Tabela)
        function renderizarServicos() {
             const tbody = document.getElementById('lista-servicos');
             tbody.innerHTML = '';
             
             const servicosList = Object.values(cacheServicos);

            if (servicosList.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align: center;">Nenhum serviço cadastrado.</td></tr>`;
                return;
            }
             
             servicosList.forEach(servico => {
                 const tipo = servico.isPacote ? 'Pacote' : 'Individual';
                 const totalProc = servico.isPacote ? servico.quantidadeTotal : '-';
                 
                 const row = tbody.insertRow();
                 row.innerHTML = `
                     <td data-label="Serviço">${servico.nome}</td>
                     <td data-label="Tipo">${tipo}</td>
                     <td data-label="Total Proc.">${totalProc}</td>
                     <td data-label="Preço">${formatarMoeda(servico.preco)}</td>
                     <td data-label="Ações" class="action-buttons">
                         <button class="btn-warning" onclick="editarServico('${servico.id}')"><span class="material-icons">edit</span> Editar</button>
                         <button class="btn-danger" onclick="deletarServico('${servico.id}', '${servico.nome}')"><span class="material-icons">delete</span> Excluir</button>
                     </td>
                 `;
             });
        }
        
        // 7.4. Renderizar Agendamentos (Tabela de Lista)
        window.filtrarAgendamentos = function() {
            const tbody = document.getElementById('lista-agendamentos');
            tbody.innerHTML = '';
            
            const filtroData = document.getElementById('filtro-agenda-data').value;
            const filtroCliente = document.getElementById('filtro-agenda-cliente').value.toLowerCase();

            const agendamentosFiltrados = agendamentosAtivos.filter(agd => {
                const dataAgd = agd.dataHora.slice(0, 10);
                const dataMatch = !filtroData || dataAgd === filtroData;
                const clienteMatch = !filtroCliente || agd.clienteNome.toLowerCase().includes(filtroCliente);
                return dataMatch && clienteMatch;
            });
            
            agendamentosFiltrados.sort((a, b) => new Date(a.dataHora) - new Date(b.dataHora));

            if (agendamentosFiltrados.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align: center;">Nenhum agendamento ativo encontrado.</td></tr>`;
                return;
            }

            agendamentosFiltrados.forEach(agd => {
                 const servico = cacheServicos[agd.servicoId];
                 const nomeServico = agd.isPacote ? agd.servicoNome : `${agd.servicoNome} (${formatarMoeda(agd.preco)})`;
                 
                 // Define se o agendamento está no passado para permitir finalização (MELHORIA 1)
                 const isPassado = new Date(agd.dataHoraFim) < new Date();
                 const dataAgd = agd.dataHora.slice(0, 10);
                 const dataAtual = new Date().toISOString().slice(0, 10);

                 let status = 'Agendado';
                 let statusClass = 'status-package-active';
                 let actionButtons = `
                     <button class="btn-warning" onclick="editarAgendamento('${agd.id}')"><span class="material-icons">edit</span> Editar</button>
                     <button class="btn-danger" onclick="deletarAgendamento('${agd.id}', '${agd.clienteNome}')"><span class="material-icons">delete</span> Cancelar</button>
                 `;

                 if (isPassado) {
                     status = 'Aguardando Finalização';
                     statusClass = 'status-package-warning';
                     actionButtons = `
                         <button class="btn-success" onclick="finalizarAgendamento('${agd.id}', '${agd.clienteNome}')"><span class="material-icons">check_circle</span> Finalizar</button>
                         <button class="btn-danger" onclick="deletarAgendamento('${agd.id}', '${agd.clienteNome}')"><span class="material-icons">delete</span> Cancelar</button>
                     `;
                 } else if (dataAgd === dataAtual && new Date(agd.dataHora) <= new Date() && new Date(agd.dataHoraFim) >= new Date()) {
                     status = 'Em Andamento';
                     statusClass = 'status-package-pending';
                 }
                
                 const row = tbody.insertRow();
                 row.innerHTML = `
                     <td data-label="Data/Hora">${formatarDataHora(agd.dataHora)}</td>
                     <td data-label="Cliente"><strong>${agd.clienteNome}</strong></td>
                     <td data-label="Serviço">${nomeServico}</td>
                     <td data-label="Status"><span class="${statusClass}">${status}</span></td>
                     <td data-label="Ações" class="action-buttons">
                         ${actionButtons}
                     </td>
                 `;
             });
        }
        
        // 7.5. Resetar Filtro de Agendamentos
        window.resetFiltroAgenda = function() {
            document.getElementById('filtro-agenda-data').value = '';
            document.getElementById('filtro-agenda-cliente').value = '';
            filtrarAgendamentos();
        }

        // 7.6. Renderizar Pacotes Ativos (Tabela)
        function renderizarPacotesAtivos() {
            const tbody = document.getElementById('lista-pacotes-ativos');
            tbody.innerHTML = '';

            if (pacotesAtivosList.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align: center;">Nenhum pacote ativo encontrado.</td></tr>`;
                return;
            }
            
            pacotesAtivosList.sort((a, b) => new Date(a.dataInicio) - new Date(b.dataInicio));

            pacotesAtivosList.forEach(pacote => {
                const clienteNome = pacote.clienteNome;
                const pacoteInfo = `${pacote.servicoNome} (${pacote.quantidadeTotal}/${pacote.quantidadeUsada})`;
                
                let statusPagamentoText = pacote.statusPagamento === 'pago' ? 'Pago' : 'Pendente';
                let statusPagamentoClass = pacote.statusPagamento === 'pago' ? 'status-package-paid' : 'status-package-pending';
                
                let statusVencimentoText = pacote.status;
                let statusVencimentoClass = 'status-package-active';
                
                if (pacote.status === 'finalizado') {
                     statusVencimentoText = 'Finalizado';
                     statusVencimentoClass = 'status-package-finalized';
                }
                
                const btnPagamento = `<button class="btn-secondary" onclick="marcarPagamentoPacote('${pacote.id}', '${clienteNome}', '${pacote.statusPagamento}')"><span class="material-icons">${pacote.statusPagamento === 'pago' ? 'undo' : 'paid'}</span> ${pacote.statusPagamento === 'pago' ? 'Desfazer Pag.' : 'Marcar Pago'}</button>`;
                
                const btnUso = pacote.status !== 'finalizado' ? 
                    `<button class="btn-success" onclick="usarPacote('${pacote.id}', '${clienteNome}', '${pacote.servicoNome}')"><span class="material-icons">add</span> Registrar Uso</button>` :
                    `<button class="btn-secondary" disabled><span class="material-icons">check</span> Finalizado</button>`;
                
                const row = tbody.insertRow();
                 row.innerHTML = `
                     <td data-label="Cliente"><strong>${clienteNome}</strong></td>
                     <td data-label="Pacote (Total/Usado)">${pacoteInfo}</td>
                     <td data-label="Pagamento"><span class="${statusPagamentoClass}">${statusPagamentoText}</span></td>
                     <td data-label="Vencimento"><span class="${statusVencimentoClass}">${statusVencimentoText}</span></td>
                     <td data-label="Ações" class="action-buttons">
                         ${btnUso}
                         ${btnPagamento}
                     </td>
                 `;
            });
        }
        
        // 7.7. Renderizar Visão Diária
        window.renderizarVisaoDiaria = function(resetDate = false) {
             const tbody = document.getElementById('lista-visao-diaria');
             tbody.innerHTML = '';
             
             if (resetDate) {
                 document.getElementById('filtro-visao-diaria-data').value = new Date().toISOString().slice(0, 10);
             }
             
             const dataFiltro = document.getElementById('filtro-visao-diaria-data').value;
             if (!dataFiltro) {
                 tbody.innerHTML = `<tr><td colspan="2" style="text-align: center;">Selecione uma data para visualizar.</td></tr>`;
                 return;
             }
             
             // Filtra apenas agendamentos ATIVOS (não finalizados) para o dia selecionado (MELHORIA 1)
             const agendamentosDoDia = agendamentosAtivos.filter(agd => 
                 agd.dataHora.startsWith(dataFiltro)
             ).sort((a, b) => new Date(a.dataHora) - new Date(b.dataHora));
             
             const slots = {};
             let currentAgendamentoIndex = 0;
             const inicioDia = new Date(dataFiltro + 'T08:00:00'); // Começa às 8h
             const fimDia = new Date(dataFiltro + 'T21:00:00'); // Termina às 21h

             for (let time = inicioDia.getTime(); time < fimDia.getTime(); time += 30 * 60000) {
                 const slotTime = new Date(time);
                 const horaMinuto = slotTime.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', hour12: false });
                 slots[horaMinuto] = { hora: horaMinuto, agendamento: null };
             }
             
             agendamentosDoDia.forEach(agd => {
                 const start = new Date(agd.dataHora);
                 const end = new Date(agd.dataHoraFim);
                 
                 // Calcula o slot de início
                 let slotStart = start.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', hour12: false });
                 
                 // Garante que o slot de início é um dos slots de 30 min
                 let isAligned = start.getMinutes() % 30 === 0;
                 if (!isAligned) {
                     // Se não for alinhado, arredonda para o slot de 30 min anterior
                     let minutes = start.getMinutes();
                     minutes = minutes - (minutes % 30);
                     start.setMinutes(minutes);
                     slotStart = start.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', hour12: false });
                 }
                 
                 // Calcula quantos slots de 30 minutos o agendamento ocupa
                 const diffMs = end.getTime() - start.getTime();
                 const durationSlots = Math.round(diffMs / (30 * 60000));
                 
                 if (slots[slotStart] && !slots[slotStart].agendamento) {
                      slots[slotStart].agendamento = {
                          agd: agd,
                          rowspan: durationSlots > 0 ? durationSlots : 1,
                          isStart: true
                      };
                      // Marca os slots seguintes como "ocupados, não desenhar"
                      for (let i = 1; i < durationSlots; i++) {
                          const nextSlotTime = new Date(start.getTime() + i * 30 * 60000);
                          const nextHoraMinuto = nextSlotTime.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', hour12: false });
                          if (slots[nextHoraMinuto]) {
                              slots[nextHoraMinuto].agendamento = { isStart: false }; // Marca como ocupado, mas não é o início
                          }
                      }
                 } else {
                     // Caso de conflito (agendamento em slot já ocupado)
                     // Neste caso, ele será desenhado no slot seguinte vago (se houver)
                     // Para simplificar, vamos apenas desenhar o agendamento no slot de início real,
                     // e apenas se for o slot de 30 min, e confiar na lógica de rowspan.
                 }
             });
             
             // Renderiza a tabela
             Object.values(slots).forEach(slot => {
                 if (slot.agendamento && slot.agendamento.isStart) {
                     // Desenha o agendamento
                     const agd = slot.agendamento.agd;
                     const rowspan = slot.agendamento.rowspan;
                     
                     const isPacote = agd.isPacote ? ' (Pacote)' : '';
                     const preco = agd.isPacote ? '' : formatarMoeda(agd.preco);
                     
                     const row = tbody.insertRow();
                     row.innerHTML = `
                         <td class="horario-celula" rowspan="${rowspan}">${slot.hora}</td>
                         <td class="agendamento-ocupado" rowspan="${rowspan}" onclick="editarAgendamento('${agd.id}')">
                             <strong>${agd.clienteNome}</strong>: ${agd.servicoNome}${isPacote} ${preco}<br>
                             <small>Fim: ${agd.dataHoraFim.slice(11, 16)} | Obs: ${agd.observacoes || 'Nenhuma'}</small>
                         </td>
                     `;
                 } else if (!slot.agendamento) {
                     // Desenha slot vago (só se não for um slot ocupado no meio de um agendamento)
                     const row = tbody.insertRow();
                     row.innerHTML = `
                         <td class="horario-celula">${slot.hora}</td>
                         <td class="agendamento-vago">Vago</td>
                     `;
                 }
                 // Se slot.agendamento for { isStart: false }, ele é ignorado pois o rowspan do agendamento anterior já o cobre.
             });
             
             if (Object.keys(slots).length === 0) {
                 tbody.innerHTML = `<tr><td colspan="2" style="text-align: center;">Agenda não configurada para este dia.</td></tr>`;
             }
        }
        
        // 7.8. Renderizar Histórico e Lucros Mensais
        window.renderizarHistorico = function() {
            const filtroMes = document.getElementById('filtro-historico-mes').value; // MELHORIA 2
            
            // Renderiza o resumo de lucros mensais
            renderizarLucrosMensais(filtroMes); // MELHORIA 2: Passa o filtro
            
            // Renderiza a tabela de histórico
            filtrarHistoricoTabela(); // Renomeado de renderizarHistoricoTabela() para o nome mais adequado: filtrarHistoricoTabela
        }

        // Renderiza Lucros Mensais (Agrupamento)
        function renderizarLucrosMensais(filtroMes = null) { // MELHORIA 2: Aceita filtro
            const tbody = document.getElementById('lista-lucros-mensais');
            tbody.innerHTML = '';

            // MELHORIA 2: Altera o título da seção se houver filtro
            const lucroHeader = document.querySelector('#historico-section .card h3');
            if (filtroMes) {
                const ano = filtroMes.split('-')[0];
                const mes = parseInt(filtroMes.split('-')[1]);
                const nomeMes = new Date(ano, mes - 1, 1).toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
                lucroHeader.textContent = `Resumo de Lucros para ${nomeMes.charAt(0).toUpperCase() + nomeMes.slice(1)}`;
            } else {
                lucroHeader.textContent = `Resumo de Lucros (Todos os Meses)`;
            }
            
            const lucrosPorMes = {};
            
            // 1. Agendamentos Individuais (só finalizados)
            agendamentosHistorico.filter(agd => !agd.isPacote).forEach(agd => {
                const data = new Date(agd.dataHora);
                const mesAno = `${data.getFullYear()}-${String(data.getMonth() + 1).padStart(2, '0')}`;
                
                // MELHORIA 2: Aplica filtro de mês se fornecido
                if (filtroMes && mesAno !== filtroMes) return; 

                if (!lucrosPorMes[mesAno]) {
                    lucrosPorMes[mesAno] = { totalAgendamentos: 0, lucroTotal: 0 };
                }
                lucrosPorMes[mesAno].totalAgendamentos += 1;
                lucrosPorMes[mesAno].lucroTotal += (agd.preco || 0);
            });
            
            // 2. Pacotes Ativos (Lucro é contabilizado na data de INÍCIO do pacote) - só pagos
            pacotesAtivosList.filter(pkg => pkg.statusPagamento === 'pago').forEach(pkg => {
                const data = new Date(pkg.dataInicio);
                const mesAno = `${data.getFullYear()}-${String(data.getMonth() + 1).padStart(2, '0')}`;
                
                // MELHORIA 2: Aplica filtro de mês se fornecido
                if (filtroMes && mesAno !== filtroMes) return; 

                if (!lucrosPorMes[mesAno]) {
                    lucrosPorMes[mesAno] = { totalAgendamentos: 0, lucroTotal: 0 };
                }
                // Para o resumo financeiro, vamos agrupar:
                lucrosPorMes[mesAno].lucroTotal += (pkg.precoTotal || 0);
            });

            const mesesOrdenados = Object.keys(lucrosPorMes).sort().reverse();
            
            if (mesesOrdenados.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" style="text-align: center;">Nenhum lucro registrado para o período.</td></tr>`;
                return;
            }

            mesesOrdenados.forEach(mesAno => {
                const mes = parseInt(mesAno.split('-')[1]);
                const ano = mesAno.split('-')[0];
                const nomeMes = new Date(ano, mes - 1, 1).toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
                
                const dataLucro = lucrosPorMes[mesAno];
                
                 const row = tbody.insertRow();
                 row.innerHTML = `
                     <td data-label="Mês/Ano"><strong>${nomeMes.charAt(0).toUpperCase() + nomeMes.slice(1)}</strong></td>
                     <td data-label="Total Agendamentos">${dataLucro.totalAgendamentos}</td>
                     <td data-label="Lucro Total (R$)" class="status-package-paid">${formatarMoeda(dataLucro.lucroTotal)}</td>
                     <td data-label="Detalhes">
                          <button class="btn-info" onclick="aplicarFiltroHistoricoMes('${mesAno}')"><span class="material-icons">search</span> Filtrar Histórico</button>
                     </td>
                 `;
            });
        }
        
        // Renderiza a Tabela de Histórico (Agendamentos Passados)
        window.filtrarHistoricoTabela = function() {
            const tbody = document.getElementById('lista-historico');
            tbody.innerHTML = '';
            
            const filtroMes = document.getElementById('filtro-historico-mes').value;
            const filtroCliente = document.getElementById('filtro-historico-cliente').value.toLowerCase();

            let agendamentosPassados = agendamentosHistorico; // Agora só contém finalizados (MELHORIA 1)
            
            // 1. Aplica filtro de Mês
            if (filtroMes) {
                 agendamentosPassados = agendamentosPassados.filter(agd => agd.dataHora.startsWith(filtroMes));
            }
            
            // 2. Aplica filtro de Cliente
            const historicoFiltrado = agendamentosPassados.filter(agd => 
                !filtroCliente || agd.clienteNome.toLowerCase().includes(filtroCliente)
            );
            
            historicoFiltrado.sort((a, b) => new Date(b.dataHora) - new Date(a.dataHora)); // Mais recente primeiro

            if (historicoFiltrado.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align: center;">Nenhum agendamento no histórico encontrado para os filtros.</td></tr>`;
                return;
            }

            historicoFiltrado.forEach(agd => {
                 const preco = agd.isPacote ? 'Pacote' : formatarMoeda(agd.preco);
                 const precoClass = agd.isPacote ? 'status-package-pending' : 'status-package-paid';
                
                 const row = tbody.insertRow();
                 row.innerHTML = `
                     <td data-label="Data/Hora">${formatarDataHora(agd.dataHora)}</td>
                     <td data-label="Cliente"><strong>${agd.clienteNome}</strong></td>
                     <td data-label="Serviço">${agd.servicoNome}</td>
                     <td data-label="Valor (R$)"><span class="${precoClass}">${preco}</span></td>
                     <td data-label="Ações" class="action-buttons">
                         <button class="btn-info" onclick="reverterParaAgendamento('${agd.id}')"><span class="material-icons">keyboard_return</span> Reverter</button>
                     </td>
                 `;
            });
        }
        
        // Aplica o filtro de Mês na tabela de histórico
        window.aplicarFiltroHistoricoMes = function(mesAno) {
            document.getElementById('filtro-historico-mes').value = mesAno;
            // Chama renderizarHistorico para atualizar ambas as seções
            renderizarHistorico(); 
        }
        
        // Reseta os filtros de histórico
        window.resetFiltroHistorico = function() {
            document.getElementById('filtro-historico-mes').value = '';
            document.getElementById('filtro-historico-cliente').value = '';
            renderizarHistorico();
        }
        
        // Reverter Agendamento para Agendamentos Ativos
        window.reverterParaAgendamento = function(id) {
             const agendamento = cacheAgendamentos[id];
             if (!agendamento) return;
             
             if (confirm(`Tem certeza que deseja reverter este agendamento (${agendamento.clienteNome} em ${formatarDataHora(agendamento.dataHora)}) para a lista de Agendamentos Ativos?`)) {
                 // 1. Atualiza a data/hora do agendamento para o futuro (1 hora a partir de agora)
                 const now = new Date();
                 const dataReversao = now.toISOString().slice(0, 10);
                 const horaReversao = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', hour12: false });
                 const horaFimReversao = new Date(now.getTime() + 60 * 60000).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', hour12: false });
                 
                 const updates = {
                     dataHora: `${dataReversao}T${horaReversao}:00`,
                     dataHoraFim: `${dataReversao}T${horaFimReversao}:00`,
                     isFinalizado: false, // MELHORIA 1: Volta para ativo
                 };
                 
                 update(ref(db, `agendamentos/${id}`), updates)
                     .then(() => {
                         showNotification(`Agendamento de ${agendamento.clienteNome} revertido para Ativo (agendado para daqui a 1 hora).`, 'success');
                         // O listener do carregarAgendamentos irá mover automaticamente o item
                         // para a lista de agendamentosAtivos e renderizar o histórico novamente.
                         renderizarHistorico();
                     })
                     .catch(error => {
                         console.error("Erro ao reverter agendamento:", error);
                         showNotification('Erro ao reverter agendamento.', 'error');
                     });
             }
        }
        
        // ----------------------------------------------------------------------------------
        // INICIALIZAÇÃO
        // ----------------------------------------------------------------------------------
        document.addEventListener('DOMContentLoaded', () => {
             // Mostra a tela de login ao carregar a página
            showLogin();
            
            // Inicia os listeners de dados
            carregarClientes();
            carregarServicos();
            carregarAgendamentos(); 
            carregarPacotesAtivos(); 
            
            // Configura a data de hoje para os inputs de data
            const today = new Date().toISOString().slice(0, 10);
            document.getElementById('agenda-data').value = today;
            document.getElementById('pacote-data-inicio').value = today;
            document.getElementById('filtro-visao-diaria-data').value = today;

            // Associa a função showSection aos links da sidebar
            document.querySelectorAll('.sidebar ul li a').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    showSection(this.getAttribute('data-section') + '-section');
                });
            });
            
            // CORREÇÃO DE LOGIN (FEITA NA ETAPA ANTERIOR)
            document.getElementById('login-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const senha = document.getElementById('loginSenha').value;
                if (senha === senhaAcesso) {
                    showApp();
                    showNotification('Login realizado com sucesso!', 'success');
                } else {
                    showNotification('Senha incorreta. Tente novamente.', 'error');
                }
            });

            document.getElementById('logout-button').addEventListener('click', () => {
                showLogin();
                showNotification('Sessão encerrada.', 'info');
            });

        });
    </script>
</body>
</html>
