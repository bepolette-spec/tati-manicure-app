<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tati Manicure - Gerenciamento de Agendamentos</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <style>
        :root {
            --primary-color: #ff8c6b; /* Cor de Destaque (Salmão/Coral) */
            --secondary-color: #6c757d; /* Cinza para secundários */
            --background-color: #f4f7f6; /* Fundo Suave */
            --sidebar-bg: #ffffff;
            --sidebar-hover-bg: #fff0eb; /* Fundo mais claro para hover */
            --text-color: #343a40; /* Texto Principal (Escuro) */
            --success-color: #28a745;
            --info-color: #17a2b8;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --border-color: #e9ecef;
            --shadow-color: rgba(0, 0, 0, 0.05);
        }

        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            min-height: 100vh;
        }

        /* Estrutura do App */
        #login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            /* CORREÇÕES APLICADAS PARA GARANTIR O ESTILO (CSS) */
            width: 100vw; 
            height: 100vh;
            position: fixed; 
            top: 0;
            left: 0;
            z-index: 1000; /* Garante que ele fique sobre qualquer elemento não estilizado */
            /* Propriedades de Fundo (mantidas) */
            background-image: url('image_decbc8.jpg');
            background-size: cover;
            background-position: center;
            /* Aplica a cor principal com transparência e a mistura com a imagem para suavizar */
            background-color: rgba(255, 140, 107, 0.7);
            /* (var(--primary-color) com 70% de opacidade) */
            background-blend-mode: overlay;
        }

        .login-card {
            background: var(--sidebar-bg);
            padding: 40px;
            border-radius: 12px;
            /* Ajuste de sombra para destacar mais sobre o fundo de imagem */
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            text-align: center;
            width: 100%;
            max-width: 400px;
        }

        .login-card h1 {
            color: var(--primary-color);
            margin-bottom: 30px;
            font-size: 1.8rem;
        }

        .login-card input[type="password"] {
            margin-bottom: 20px;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
            font-size: 1rem;
        }
        
        #app-container {
            display: none; /* Escondido por padrão, mostrado após o login */
            width: 100%;
        }

        /* Barra Lateral (Sidebar) */
        .sidebar {
            width: 250px;
            background-color: var(--sidebar-bg);
            box-shadow: 2px 0 5px var(--shadow-color);
            display: flex;
            flex-direction: column;
            padding: 20px 0;
            flex-shrink: 0;
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
            color: var(--primary-color);
            font-size: 1.6rem;
            font-weight: bold;
        }

        .sidebar ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar ul li a {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            text-decoration: none;
            color: var(--text-color);
            transition: background-color 0.2s, color 0.2s;
            font-weight: 500;
        }

        .sidebar ul li a:hover,
        .sidebar ul li a.active {
            background-color: var(--sidebar-hover-bg);
            color: var(--primary-color);
        }

        .sidebar ul li a .material-icons {
            margin-right: 10px;
            font-size: 20px;
        }

        .user-info {
            margin-top: auto;
            padding: 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .user-info p {
            margin: 0 0 10px 0;
            font-weight: bold;
        }

        /* Conteúdo Principal */
        .main-content {
            flex-grow: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .content-section {
            display: none;
            padding: 20px;
        }

        .content-section.active {
            display: block;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .section-header h2 {
            margin: 0;
            color: var(--text-color);
            font-size: 1.5rem;
        }
        
        /* Novas cores para Status de Pacote e Histórico */
        .status-package-paid {
             color: var(--success-color);
             font-weight: bold;
        }
        .status-package-pending {
            color: var(--warning-color);
            font-weight: bold;
        }
        .status-package-active {
            color: var(--primary-color);
            font-weight: bold;
        }
        .status-package-finalized {
            color: var(--danger-color);
            font-weight: bold;
        }

        /* Cartão (Card) */
        .card {
            background: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 4px var(--shadow-color);
            margin-bottom: 20px;
        }
        
        /* NOVO V6: Abas dentro de uma seção */
        .tab-menu {
             display: flex;
             border-bottom: 2px solid var(--border-color);
             margin-bottom: 20px;
        }
        .tab-menu button {
             padding: 10px 20px;
             border: none;
             background: transparent;
             cursor: pointer;
             font-size: 1rem;
             color: var(--secondary-color);
             border-bottom: 2px solid transparent;
             transition: border-color 0.2s, color 0.2s;
             font-weight: bold;
        }
        .tab-menu button.active {
             color: var(--primary-color);
             border-bottom: 2px solid var(--primary-color);
        }
        .tab-content {
             padding-top: 10px;
        }
        .tab-pane {
             display: none;
        }
        .tab-pane.active {
             display: block;
        }

        /* Formulários */
        .form-group {
            margin-bottom: 15px;
        }

        .form-row {
            display: flex;
            gap: 20px;
        }

        .form-row > div {
            flex: 1;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 0.95rem;
        }

        input[type="text"],
        input[type="number"],
        input[type="email"],
        input[type="tel"],
        input[type="date"],
        input[type="time"],
        textarea,
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        /* Datalist input */
        input[list] {
            /* Estilo para garantir que o input datalist se pareça com um campo normal */
            background-image: none;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="email"]:focus,
        input[type="tel"]:focus,
        input[type="date"]:focus,
        input[type="time"]:focus,
        textarea:focus,
        select:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        textarea {
            resize: vertical;
        }

        /* Botões */
        button, .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: background-color 0.2s, opacity 0.2s;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #e57a5e;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #218838;
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: var(--text-color);
        }

        .btn-warning:hover {
            background-color: #ffb547;
        }


        /* Tabelas */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table thead tr {
            background-color: var(--primary-color);
            color: white;
            text-align: left;
        }

        .data-table th, .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table tbody tr:hover {
            background-color: var(--sidebar-hover-bg);
        }

        .data-table td.action-buttons button {
            margin-right: 5px;
            padding: 6px 8px;
        }

        .data-table td.action-buttons {
            white-space: nowrap;
        }

        /* Notificação */
        #notification-bar {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s, transform 0.3s;
            transform: translateY(-20px);
            z-index: 1000;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            font-weight: bold;
        }

        #notification-bar.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        #notification-bar.success { background-color: var(--success-color); }
        #notification-bar.error { background-color: var(--danger-color); }
        #notification-bar.info { background-color: var(--info-color); }

        /* Utilitários */
        .flex-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .input-group {
            display: flex;
            gap: 10px;
        }
        
        .input-group input, .input-group select {
            flex-grow: 1;
        }

        .filter-row {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            margin-bottom: 20px;
        }
        .filter-row > div {
            flex: 1;
        }
        .filter-row button {
            flex-grow: 0;
            flex-shrink: 0;
            padding: 9px 15px; /* Ajuste para alinhar com o input */
        }
        
        /* NOVO V6: Estilos para a Tabela de Visão Diária */
        .table-responsive {
            overflow-x: auto;
        }
        
        #tabela-visao-diaria {
            border: 1px solid var(--border-color);
            margin-top: 0;
        }
        #tabela-visao-diaria thead tr {
            background-color: var(--secondary-color);
        }
        #tabela-visao-diaria td {
            height: 40px; /* Altura padrão para cada intervalo de 30 min */
            font-size: 0.9rem;
            vertical-align: top;
        }
        .horario-celula {
            width: 80px;
            font-weight: bold;
            background-color: var(--sidebar-hover-bg);
            color: var(--text-color);
            text-align: center;
            vertical-align: middle !important;
            border-right: 1px solid var(--border-color);
        }
        .agendamento-vago {
            background-color: #f7fff7; /* Verde clarinho */
            color: var(--success-color);
            font-weight: bold;
            font-style: italic;
            text-align: center;
            line-height: 40px;
        }
        .agendamento-ocupado {
            background-color: #fff0eb; /* Fundo do hover de sidebar, suave */
            color: var(--text-color);
            font-weight: 500;
            padding: 5px 10px !important;
            vertical-align: middle !important;
            line-height: 1.2;
            border-left: 5px solid var(--primary-color);
            cursor: pointer;
        }
        .agendamento-ocupado strong {
            color: var(--primary-color);
            font-weight: bold;
        }
        
        /* --------------------------------------------------- */
        /* RESPONSIVIDADE MOBILE (Mobile First - Portrait Mode)*/
        /* --------------------------------------------------- */
        @media (max-width: 768px) {
            /* Estrutura Principal */
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
                box-shadow: 0 0 5px var(--shadow-color);
            }
            .main-content {
                padding: 15px;
            }
            #app-container {
                flex-direction: column;
            }
            /* Navegação Horizontal */
            .sidebar ul {
                display: flex;
                flex-wrap: nowrap; /* Tenta manter em uma linha, mas permite rolagem */
                overflow-x: auto;
                justify-content: flex-start;
                border-bottom: 1px solid var(--border-color);
            }
            .sidebar ul li {
                flex-shrink: 0; /* Impede que os itens encolham */
                text-align: center;
            }
            .sidebar ul li a {
                justify-content: center;
                padding: 10px;
                flex-direction: column;
                font-size: 0.75rem;
                white-space: nowrap;
            }
            .sidebar ul li a .material-icons {
                margin-right: 0;
                margin-bottom: 5px;
                font-size: 20px;
            }
            /* FIX: Botão Sair visível no celular */
            .user-info {
                display: block;
                padding: 10px 15px;
                border-top: none;
                text-align: center;
            }
            .user-info p {
                display: none; /* Esconde o texto "Olá, Tati!" para economizar espaço */
            }
            .user-info button {
                width: 100%;
                margin-top: 10px;
                font-size: 0.9rem;
            }
            /* 1. Correção de Formulários e Filtros (Empilhamento) */
            .form-row, .filter-row {
                flex-direction: column;
                gap: 0; /* Remove gap quando empilha */
            }
            .form-row > div, .filter-row > div {
                flex: 0 0 100% !important; /* Força largura total */
                width: 100%;
            }
            /* Ajusta margem para inputs empilhados */
            .form-group, .filter-row > div {
                margin-bottom: 10px;
            }
            .filter-row button {
                width: 100%;
                margin-top: 5px;
                padding: 10px 15px !important;
            }
            /* V6: Ajuste para a Tabela de Visão Diária */
            .table-responsive {
                overflow-x: auto;
            }
            #tabela-visao-diaria {
                width: 100%;
                min-width: 300px; /* Garante que não fique muito esmagada */
            }
            #tabela-visao-diaria td {
                padding: 5px 10px !important;
            }
            /* 2. Correção de Tabelas (Cartão-like View) */
            .data-table, .data-table tbody, .data-table td, .data-table tr {
                display: block; /* Força elementos da tabela a empilhar */
            }
            .data-table thead {
                display: none; /* Esconde o cabeçalho original */
            }
            .data-table tr {
                border: 1px solid var(--border-color);
                margin-bottom: 15px;
                border-radius: 8px;
                box-shadow: 0 1px 3px var(--shadow-color);
                padding: 10px;
            }
            .data-table td {
                border: none;
                position: relative;
                padding-left: 50% !important; /* Espaço para o rótulo */
                text-align: right; 
            }
            /*... restante dos estilos mobile ...*/
            
        }
    </style>
</head>
<body>
    
    <div id="notification-bar"></div>

    <div id="login-container">
        <div class="login-card">
            <h1>Tati Manicure</h1>
            <form id="login-form">
                <input type="password" id="loginSenha" placeholder="Digite a Senha de Acesso" required>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Entrar</button>
            </form>
        </div>
    </div>
    
    <div id="app-container">
        
        <aside class="sidebar">
            <div class="logo">Tati Manicure</div>
            <ul>
                <li><a href="#" data-section="agenda" class="active"><i class="material-icons">event</i> Agenda</a></li>
                <li><a href="#" data-section="clientes"><i class="material-icons">people</i> Clientes</a></li>
                <li><a href="#" data-section="servicos"><i class="material-icons">spa</i> Serviços</a></li>
                <li><a href="#" data-section="pacotes"><i class="material-icons">inventory</i> Pacotes</a></li>
                <li><a href="#" data-section="historico"><i class="material-icons">history</i> Histórico</a></li>
                </ul>
            <div class="user-info">
                <p>Olá, Tati!</p>
                <button id="logout-button" class="btn btn-danger"><i class="material-icons">logout</i> Sair</button>
            </div>
        </aside>

        <main class="main-content">
            
            <section id="agenda-section" class="content-section active">
                <div class="section-header">
                    <h2>Agenda do Dia</h2>
                    <div class="input-group">
                        <input type="date" id="filtro-visao-diaria-data" class="form-control" onchange="renderizarVisaoDiaria(this.value)">
                        <button class="btn btn-primary" onclick="mostrarModalNovoAgendamento()">Novo Agendamento</button>
                    </div>
                </div>

                <div class="card table-responsive">
                    <table id="tabela-visao-diaria" class="data-table">
                        <thead>
                            <tr>
                                <th style="width: 80px;">Hora</th>
                                <th>Agendamento</th>
                            </tr>
                        </thead>
                        <tbody id="lista-visao-diaria">
                            </tbody>
                    </table>
                </div>

            </section>
            
            <section id="clientes-section" class="content-section">
                <div class="section-header">
                    <h2>Cadastro de Clientes</h2>
                    <button class="btn btn-primary" onclick="mostrarModalNovoCliente()">Novo Cliente</button>
                </div>

                <div class="card">
                    <div class="flex-container" style="margin-bottom: 20px;">
                        <div class="input-group">
                             <input type="text" id="filtro-cliente" placeholder="Filtrar por nome ou telefone..." onkeyup="filtrarTabela('lista-clientes', this.value)">
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Telefone</th>
                                    <th>Email</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="lista-clientes">
                                </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="servicos-section" class="content-section">
                <div class="section-header">
                    <h2>Cadastro de Serviços</h2>
                    <button class="btn btn-primary" onclick="mostrarModalNovoServico()">Novo Serviço</button>
                </div>

                <div class="card">
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Nome do Serviço</th>
                                    <th>Preço (R$)</th>
                                    <th>Duração (min)</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="lista-servicos">
                                </tbody>
                        </table>
                    </div>
                </div>
            </section>
            
            <section id="pacotes-section" class="content-section">
                <div class="section-header">
                    <h2>Gerenciamento de Pacotes</h2>
                    <button class="btn btn-primary" onclick="mostrarModalNovoPacote()">Novo Pacote</button>
                </div>
                
                <div class="card">
                     <div class="tab-menu">
                         <button class="active" onclick="showTab('pacotes', 'ativos')">Pacotes Ativos</button>
                         <button onclick="showTab('pacotes', 'historico')">Pacotes Finalizados/Vencidos</button>
                     </div>
                     
                     <div id="pacotes-ativos-tab" class="tab-content tab-pane active">
                        <div class="flex-container" style="margin-bottom: 20px;">
                            <div class="input-group">
                                 <input type="text" id="filtro-pacotes-ativos" placeholder="Filtrar por nome do cliente..." onkeyup="filtrarTabela('lista-pacotes-ativos', this.value)">
                            </div>
                        </div>
                         
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Cliente</th>
                                        <th>Serviço</th>
                                        <th>Preço Total (R$)</th>
                                        <th>Restantes</th>
                                        <th>Status</th>
                                        <th>Data Início</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="lista-pacotes-ativos">
                                    </tbody>
                            </table>
                        </div>
                     </div>
                     
                     <div id="pacotes-historico-tab" class="tab-content tab-pane">
                         <p>Detalhes dos pacotes concluídos ou que expiraram.</p>
                         <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Cliente</th>
                                        <th>Serviço</th>
                                        <th>Status</th>
                                        <th>Preço Total (R$)</th>
                                        <th>Data Início</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="lista-pacotes-historico">
                                    </tbody>
                            </table>
                        </div>
                     </div>
                </div>
            </section>
            
            <section id="historico-section" class="content-section">
                <div class="section-header">
                    <h2>Histórico de Movimentações (Financeiro)</h2>
                    <button class="btn btn-primary" onclick="mostrarModalNovaMovimentacao()">Nova Movimentação</button>
                </div>

                <div class="card">
                    <div class="filter-row">
                        <div>
                            <label for="filtro-historico-mes">Filtrar por Mês:</label>
                            <input type="month" id="filtro-historico-mes" onchange="renderizarHistorico()">
                        </div>
                        <div>
                            <label for="filtro-historico-cliente">Filtrar por Cliente:</label>
                             <input type="text" id="filtro-historico-cliente" placeholder="Nome do Cliente..." onkeyup="filtrarHistoricoTabela()">
                        </div>
                        <button class="btn btn-secondary" onclick="resetFiltroHistorico()">Limpar Filtros</button>
                    </div>

                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Descrição</th>
                                    <th>Valor (R$)</th>
                                    <th>Tipo</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="lista-historico">
                                </tbody>
                        </table>
                    </div>
                </div>
            </section>

        </main>
    </div>
    
    <div id="modal-cliente" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="fecharModal('modal-cliente')">&times;</span>
            <h3 id="modal-cliente-titulo">Novo Cliente</h3>
            <form id="form-cliente">
                <input type="hidden" id="cliente-id">
                <div class="form-group">
                    <label for="cliente-nome">Nome:</label>
                    <input type="text" id="cliente-nome" required>
                </div>
                 <div class="form-group">
                    <label for="cliente-telefone">Telefone:</label>
                    <input type="tel" id="cliente-telefone" placeholder="(99) 99999-9999">
                </div>
                <div class="form-group">
                    <label for="cliente-email">Email:</label>
                    <input type="email" id="cliente-email">
                </div>
                <div class="form-group">
                    <label for="cliente-observacoes">Observações:</label>
                    <textarea id="cliente-observacoes"></textarea>
                </div>
                <button type="submit" class="btn btn-primary" id="btn-salvar-cliente">Salvar Cliente</button>
            </form>
        </div>
    </div>
    
    <div id="modal-servico" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="fecharModal('modal-servico')">&times;</span>
            <h3 id="modal-servico-titulo">Novo Serviço</h3>
            <form id="form-servico">
                <input type="hidden" id="servico-id">
                <div class="form-group">
                    <label for="servico-nome">Nome do Serviço:</label>
                    <input type="text" id="servico-nome" required>
                </div>
                 <div class="form-group">
                    <label for="servico-preco">Preço (R$):</label>
                    <input type="number" id="servico-preco" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label for="servico-duracao">Duração (minutos):</label>
                    <input type="number" id="servico-duracao" min="10" required>
                </div>
                <button type="submit" class="btn btn-primary" id="btn-salvar-servico">Salvar Serviço</button>
            </form>
        </div>
    </div>
    
    <div id="modal-agendamento" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="fecharModal('modal-agendamento')">&times;</span>
            <h3 id="modal-agendamento-titulo">Novo Agendamento</h3>
            <form id="form-agendamento">
                <input type="hidden" id="agendamento-id">
                
                <div class="form-group">
                    <label for="agendamento-cliente-nome">Cliente:</label>
                    <input type="text" id="agendamento-cliente-nome" list="datalist-clientes" placeholder="Comece a digitar o nome..." required>
                    <datalist id="datalist-clientes"></datalist>
                </div>
                
                <div class="form-group">
                    <label for="agendamento-servico-nome">Serviço/Pacote:</label>
                    <input type="text" id="agendamento-servico-nome" list="datalist-servicos-pacotes" placeholder="Selecione um serviço ou pacote..." required>
                    <datalist id="datalist-servicos-pacotes"></datalist>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="agendamento-data">Data:</label>
                        <input type="date" id="agendamento-data" required>
                    </div>
                    <div class="form-group">
                        <label for="agendamento-hora">Hora:</label>
                        <input type="time" id="agendamento-hora" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="agendamento-observacoes">Observações:</label>
                    <textarea id="agendamento-observacoes"></textarea>
                </div>
                
                <div class="flex-container">
                    <button type="submit" class="btn btn-primary" id="btn-salvar-agendamento">Agendar</button>
                    <button type="button" class="btn btn-danger" id="btn-deletar-agendamento" style="display: none;">Deletar</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="modal-pacote" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="fecharModal('modal-pacote')">&times;</span>
            <h3 id="modal-pacote-titulo">Novo Pacote de Serviços</h3>
            <form id="form-pacote">
                <input type="hidden" id="pacote-id">
                
                <div class="form-group">
                    <label for="pacote-cliente-nome">Cliente:</label>
                    <input type="text" id="pacote-cliente-nome" list="datalist-clientes-pacote" placeholder="Nome do Cliente" required>
                    <datalist id="datalist-clientes-pacote"></datalist>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="pacote-servico-nome">Serviço:</label>
                         <input type="text" id="pacote-servico-nome" list="datalist-servicos" placeholder="Selecione o serviço" required>
                         <datalist id="datalist-servicos"></datalist>
                    </div>
                    <div class="form-group">
                        <label for="pacote-quantidade">Quantidade de Sessões:</label>
                        <input type="number" id="pacote-quantidade" min="1" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="pacote-preco-total">Preço Total (R$):</label>
                        <input type="number" id="pacote-preco-total" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="pacote-data-inicio">Data de Início:</label>
                        <input type="date" id="pacote-data-inicio" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="pacote-observacoes">Observações:</label>
                    <textarea id="pacote-observacoes"></textarea>
                </div>
                
                <div class="flex-container">
                    <button type="submit" class="btn btn-primary" id="btn-salvar-pacote">Salvar Pacote</button>
                    <button type="button" class="btn btn-danger" id="btn-deletar-pacote" style="display: none;">Deletar</button>
                </div>
            </form>
        </div>
    </div>
    
     <div id="modal-movimentacao" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="fecharModal('modal-movimentacao')">&times;</span>
            <h3 id="modal-movimentacao-titulo">Nova Movimentação</h3>
            <form id="form-movimentacao">
                <input type="hidden" id="movimentacao-id">
                
                <div class="form-group">
                    <label for="movimentacao-data">Data:</label>
                    <input type="date" id="movimentacao-data" required>
                </div>
                
                <div class="form-group">
                    <label for="movimentacao-tipo">Tipo:</label>
                    <select id="movimentacao-tipo" required>
                        <option value="">Selecione o Tipo</option>
                        <option value="entrada">Entrada (Receita)</option>
                        <option value="saida">Saída (Despesa)</option>
                    </select>
                </div>
                
                 <div class="form-group">
                    <label for="movimentacao-descricao">Descrição:</label>
                    <input type="text" id="movimentacao-descricao" placeholder="Ex: Manicure Tati, Aluguel, Material" required>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="movimentacao-valor">Valor (R$):</label>
                        <input type="number" id="movimentacao-valor" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="movimentacao-cliente-nome">Cliente (Opcional - Apenas Receita):</label>
                        <input type="text" id="movimentacao-cliente-nome" list="datalist-clientes-movimentacao" placeholder="Nome do Cliente (se for receita)">
                        <datalist id="datalist-clientes-movimentacao"></datalist>
                    </div>
                </div>
                
                <div class="flex-container">
                    <button type="submit" class="btn btn-primary" id="btn-salvar-movimentacao">Salvar Movimentação</button>
                    <button type="button" class="btn btn-danger" id="btn-deletar-movimentacao" style="display: none;">Deletar</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        // ----------------------------------------------------------------------------------
        // CONFIGURAÇÕES
        // ----------------------------------------------------------------------------------

        // Chave do Firebase: Substitua pela chave do seu projeto
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY", // Substitua pela sua chave
            authDomain: "YOUR_AUTH_DOMAIN", // Substitua pelo seu domínio
            databaseURL: "YOUR_DATABASE_URL", // Substitua pela sua URL
            projectId: "YOUR_PROJECT_ID", // Substitua pelo seu ID
            storageBucket: "YOUR_STORAGE_BUCKET", // Substitua pelo seu storage bucket
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID", // Substitua pelo seu ID
            appId: "YOUR_APP_ID" // Substitua pelo seu App ID
        };

        // Inicializa o Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.database();

        // Senha de acesso para o login
        const senhaAcesso = 'tati123'; // <--- CORREÇÃO APLICADA AQUI

        // Variáveis globais para armazenar os dados em cache
        let clientesCache = {};
        let servicosCache = {};
        let agendamentosCache = {};
        let pacotesAtivosCache = {};
        let movimentacoesCache = {};
        
        // ----------------------------------------------------------------------------------
        // UTILS: Notificações e Modais
        // ----------------------------------------------------------------------------------

        /**
         * Exibe uma notificação temporária na tela.
         * @param {string} message - A mensagem a ser exibida.
         * @param {string} type - O tipo de notificação ('success', 'error', 'info').
         */
        window.showNotification = function(message, type = 'info') {
            const bar = document.getElementById('notification-bar');
            bar.textContent = message;
            bar.className = `show ${type}`; // Adiciona a classe 'show' e o tipo
            
            setTimeout(() => {
                bar.className = ''; // Remove todas as classes para esconder
            }, 3000);
        }

        /**
         * Abre um modal específico.
         * @param {string} modalId - O ID do modal a ser aberto.
         * @param {string} title - O título a ser exibido no modal.
         */
        window.abrirModal = function(modalId, title = '') {
            const modal = document.getElementById(modalId);
            const titleElement = modal.querySelector('h3');
            if (titleElement && title) {
                titleElement.textContent = title;
            }
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden'; // Evita rolagem do body
            modal.scrollTo(0, 0); // Volta ao topo do modal ao abrir
        }

        /**
         * Fecha um modal específico.
         * @param {string} modalId - O ID do modal a ser fechado.
         */
        window.fecharModal = function(modalId) {
            document.getElementById(modalId).style.display = 'none';
            document.body.style.overflow = 'auto';
            // Reseta formulários ao fechar
            const form = document.getElementById(modalId).querySelector('form');
            if (form) {
                form.reset();
            }
        }
        
        // Estilo de modal para o body
        const modalStyle = document.createElement('style');
        modalStyle.textContent = `
            .modal {
                display: none;
                position: fixed;
                z-index: 2000; /* Mais alto que o login */
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                overflow: auto;
                background-color: rgba(0,0,0,0.5); /* Fundo semi-transparente */
            }
            .modal-content {
                background-color: #fefefe;
                margin: 5% auto; /* 5% do topo e centralizado */
                padding: 30px;
                border-radius: 8px;
                width: 90%; /* Ajuste para mobile */
                max-width: 600px;
                position: relative;
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            }
            .close-button {
                color: var(--secondary-color);
                float: right;
                font-size: 28px;
                font-weight: bold;
                transition: color 0.2s;
            }
            .close-button:hover,
            .close-button:focus {
                color: var(--danger-color);
                text-decoration: none;
                cursor: pointer;
            }
            @media (max-width: 768px) {
                .modal-content {
                    margin: 10% auto;
                }
            }
        `;
        document.head.appendChild(modalStyle);


        // ----------------------------------------------------------------------------------
        // UTILS: Alternância de Seções e Abas
        // ----------------------------------------------------------------------------------
        
        /**
         * Alterna a seção visível do aplicativo.
         * @param {string} sectionId - O ID da seção a ser exibida (ex: 'agenda-section').
         */
        window.showSection = function(sectionId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
            
            // Atualiza o estado ativo na sidebar
            document.querySelectorAll('.sidebar ul li a').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('data-section') + '-section' === sectionId) {
                    link.classList.add('active');
                }
            });

            // Chama funções de renderização específicas ao abrir a seção
            if (sectionId === 'agenda-section') {
                renderizarVisaoDiaria(document.getElementById('filtro-visao-diaria-data').value);
            } else if (sectionId === 'clientes-section') {
                // Clientes já são carregados no carregarClientes
                // Garante que o filtro seja resetado para evitar tabelas vazias
                document.getElementById('filtro-cliente').value = '';
                filtrarTabela('lista-clientes', '');
            } else if (sectionId === 'pacotes-section') {
                renderizarPacotes(pacotesAtivosCache); // Recarrega os pacotes
                showTab('pacotes', 'ativos'); // Garante que a aba ativa seja a de ativos
            } else if (sectionId === 'historico-section') {
                // Define o filtro de mês para o mês atual ao abrir
                const today = new Date();
                const yearMonth = today.toISOString().slice(0, 7); // yyyy-mm
                document.getElementById('filtro-historico-mes').value = yearMonth;
                document.getElementById('filtro-historico-cliente').value = '';
                renderizarHistorico();
            }

        }
        
        /**
         * Alterna a aba visível dentro de uma seção.
         * @param {string} sectionPrefix - O prefixo para os IDs (ex: 'pacotes').
         * @param {string} tabName - O nome da aba a ser exibida (ex: 'ativos').
         */
        window.showTab = function(sectionPrefix, tabName) {
            // Remove a classe 'active' de todos os botões e painéis daquela seção
            document.querySelectorAll(`#${sectionPrefix}-section .tab-menu button`).forEach(button => {
                button.classList.remove('active');
            });
            document.querySelectorAll(`#${sectionPrefix}-section .tab-pane`).forEach(pane => {
                pane.classList.remove('active');
            });

            // Adiciona a classe 'active' ao botão e painel corretos
            document.querySelector(`[onclick="showTab('${sectionPrefix}', '${tabName}')"]`).classList.add('active');
            document.getElementById(`${sectionPrefix}-${tabName}-tab`).classList.add('active');

             // Lógica específica para renderização de conteúdo
            if (sectionPrefix === 'pacotes' && tabName === 'historico') {
                 renderizarHistoricoPacotes();
            } else if (sectionPrefix === 'pacotes' && tabName === 'ativos') {
                 renderizarPacotes(pacotesAtivosCache);
            }
        }


        // ----------------------------------------------------------------------------------
        // GERENCIAMENTO DE DADOS (CRUD) - Firebase
        // ----------------------------------------------------------------------------------

        // ... (Todas as funções CRUD, Carregamento e Renderização a partir daqui) ...

        // 1. CLIENTES (CRUD e Cache)
        
        // ... carregarClientes(), renderizarClientes(), salvarCliente(), editarCliente(), deletarCliente() ...
        
        // Função para carregar os clientes e manter o cache atualizado
        function carregarClientes() {
            db.ref('clientes').on('value', (snapshot) => {
                clientesCache = {};
                snapshot.forEach(childSnapshot => {
                    clientesCache[childSnapshot.key] = childSnapshot.val();
                });
                renderizarClientes(clientesCache);
                preencherDatalist('datalist-clientes', clientesCache, 'nome');
                preencherDatalist('datalist-clientes-pacote', clientesCache, 'nome');
                preencherDatalist('datalist-clientes-movimentacao', clientesCache, 'nome');
            });
        }
        
        // Função para renderizar a lista de clientes na tabela
        function renderizarClientes(clientes) {
            const lista = document.getElementById('lista-clientes');
            lista.innerHTML = '';

            Object.keys(clientes).forEach(key => {
                const cliente = clientes[key];
                const row = lista.insertRow();
                row.dataset.nome = cliente.nome.toLowerCase(); // Para o filtro
                row.dataset.telefone = cliente.telefone ? cliente.telefone.replace(/\D/g, '') : '';
                
                row.innerHTML = `
                    <td>${cliente.nome}</td>
                    <td>${cliente.telefone || 'N/A'}</td>
                    <td>${cliente.email || 'N/A'}</td>
                    <td class="action-buttons">
                        <button class="btn btn-secondary" onclick="editarCliente('${key}')">
                             <i class="material-icons">edit</i> Editar
                        </button>
                        <button class="btn btn-danger" onclick="deletarCliente('${key}')">
                             <i class="material-icons">delete</i>
                        </button>
                    </td>
                `;
            });
        }
        
        // Formulário e Funções de Modal Cliente
        document.getElementById('form-cliente').addEventListener('submit', salvarCliente);

        function mostrarModalNovoCliente() {
            document.getElementById('form-cliente').reset();
            document.getElementById('cliente-id').value = '';
            document.getElementById('btn-salvar-cliente').textContent = 'Salvar Cliente';
            abrirModal('modal-cliente', 'Novo Cliente');
        }
        
        function editarCliente(id) {
            const cliente = clientesCache[id];
            if (!cliente) return;
            
            document.getElementById('cliente-id').value = id;
            document.getElementById('cliente-nome').value = cliente.nome;
            document.getElementById('cliente-telefone').value = cliente.telefone || '';
            document.getElementById('cliente-email').value = cliente.email || '';
            document.getElementById('cliente-observacoes').value = cliente.observacoes || '';
            
            document.getElementById('btn-salvar-cliente').textContent = 'Salvar Alterações';
            abrirModal('modal-cliente', 'Editar Cliente');
        }
        
        function salvarCliente(e) {
            e.preventDefault();
            const id = document.getElementById('cliente-id').value;
            const nome = document.getElementById('cliente-nome').value;
            const telefone = document.getElementById('cliente-telefone').value;
            const email = document.getElementById('cliente-email').value;
            const observacoes = document.getElementById('cliente-observacoes').value;

            const clienteData = { nome, telefone, email, observacoes };

            if (id) {
                // Edição
                db.ref('clientes/' + id).update(clienteData)
                    .then(() => {
                        showNotification('Cliente atualizado com sucesso!', 'success');
                        fecharModal('modal-cliente');
                    })
                    .catch(error => showNotification('Erro ao atualizar cliente: ' + error.message, 'error'));
            } else {
                // Novo
                db.ref('clientes').push(clienteData)
                    .then(() => {
                        showNotification('Cliente cadastrado com sucesso!', 'success');
                        fecharModal('modal-cliente');
                    })
                    .catch(error => showNotification('Erro ao cadastrar cliente: ' + error.message, 'error'));
            }
        }
        
        function deletarCliente(id) {
            if (confirm('Tem certeza que deseja deletar este cliente? Esta ação é irreversível.')) {
                db.ref('clientes/' + id).remove()
                    .then(() => {
                        showNotification('Cliente deletado com sucesso!', 'success');
                    })
                    .catch(error => showNotification('Erro ao deletar cliente: ' + error.message, 'error'));
            }
        }
        
        // ----------------------------------------------------------------------------------
        // 2. SERVIÇOS (CRUD e Cache)
        
        // ... carregarServicos(), renderizarServicos(), salvarServico(), editarServico(), deletarServico() ...

        // Função para carregar os serviços e manter o cache atualizado
        function carregarServicos() {
            db.ref('servicos').on('value', (snapshot) => {
                servicosCache = {};
                snapshot.forEach(childSnapshot => {
                    servicosCache[childSnapshot.key] = childSnapshot.val();
                });
                renderizarServicos(servicosCache);
                
                // Preenche o datalist para Serviços e Pacotes (usa 'nome' e depois combina)
                preencherDatalist('datalist-servicos', servicosCache, 'nome');
                atualizarDatalistAgendamento(); 
            });
        }
        
        // Função para atualizar o datalist de Agendamento (combina serviços e pacotes)
        function atualizarDatalistAgendamento() {
             const combinedList = { ...servicosCache, ...pacotesAtivosCache }; // Combina serviços e pacotes
             preencherDatalist('datalist-servicos-pacotes', combinedList, 'nome');
        }

        // Função para renderizar a lista de serviços na tabela
        function renderizarServicos(servicos) {
            const lista = document.getElementById('lista-servicos');
            lista.innerHTML = '';

            Object.keys(servicos).forEach(key => {
                const servico = servicos[key];
                const row = lista.insertRow();
                
                row.innerHTML = `
                    <td>${servico.nome}</td>
                    <td>R$ ${formatarValor(servico.preco)}</td>
                    <td>${servico.duracao} min</td>
                    <td class="action-buttons">
                        <button class="btn btn-secondary" onclick="editarServico('${key}')">
                             <i class="material-icons">edit</i> Editar
                        </button>
                        <button class="btn btn-danger" onclick="deletarServico('${key}')">
                             <i class="material-icons">delete</i>
                        </button>
                    </td>
                `;
            });
        }

        // Formulário e Funções de Modal Serviço
        document.getElementById('form-servico').addEventListener('submit', salvarServico);

        function mostrarModalNovoServico() {
            document.getElementById('form-servico').reset();
            document.getElementById('servico-id').value = '';
            document.getElementById('btn-salvar-servico').textContent = 'Salvar Serviço';
            abrirModal('modal-servico', 'Novo Serviço');
        }
        
        function editarServico(id) {
            const servico = servicosCache[id];
            if (!servico) return;
            
            document.getElementById('servico-id').value = id;
            document.getElementById('servico-nome').value = servico.nome;
            document.getElementById('servico-preco').value = servico.preco;
            document.getElementById('servico-duracao').value = servico.duracao;
            
            document.getElementById('btn-salvar-servico').textContent = 'Salvar Alterações';
            abrirModal('modal-servico', 'Editar Serviço');
        }
        
        function salvarServico(e) {
            e.preventDefault();
            const id = document.getElementById('servico-id').value;
            const nome = document.getElementById('servico-nome').value;
            const preco = parseFloat(document.getElementById('servico-preco').value);
            const duracao = parseInt(document.getElementById('servico-duracao').value);

            const servicoData = { nome, preco, duracao };

            if (id) {
                // Edição
                db.ref('servicos/' + id).update(servicoData)
                    .then(() => {
                        showNotification('Serviço atualizado com sucesso!', 'success');
                        fecharModal('modal-servico');
                    })
                    .catch(error => showNotification('Erro ao atualizar serviço: ' + error.message, 'error'));
            } else {
                // Novo
                db.ref('servicos').push(servicoData)
                    .then(() => {
                        showNotification('Serviço cadastrado com sucesso!', 'success');
                        fecharModal('modal-servico');
                    })
                    .catch(error => showNotification('Erro ao cadastrar serviço: ' + error.message, 'error'));
            }
        }
        
        function deletarServico(id) {
            if (confirm('Tem certeza que deseja deletar este serviço? Esta ação é irreversível.')) {
                db.ref('servicos/' + id).remove()
                    .then(() => {
                        showNotification('Serviço deletado com sucesso!', 'success');
                    })
                    .catch(error => showNotification('Erro ao deletar serviço: ' + error.message, 'error'));
            }
        }
        
        // ----------------------------------------------------------------------------------
        // 3. AGENDAMENTOS (CRUD e Cache)
        
        // ... carregarAgendamentos(), salvarAgendamento(), editarAgendamento(), deletarAgendamento() ...

        // Função para carregar os agendamentos e manter o cache atualizado
        function carregarAgendamentos() {
            db.ref('agendamentos').on('value', (snapshot) => {
                agendamentosCache = {};
                snapshot.forEach(childSnapshot => {
                    const agendamento = childSnapshot.val();
                    agendamento.id = childSnapshot.key;
                    agendamentosCache[childSnapshot.key] = agendamento;
                });
                
                // Se a seção Agenda estiver ativa, renderiza a visão diária
                if (document.getElementById('agenda-section').classList.contains('active')) {
                     renderizarVisaoDiaria(document.getElementById('filtro-visao-diaria-data').value);
                }
            });
        }
        
        // Função para salvar ou editar agendamento
        document.getElementById('form-agendamento').addEventListener('submit', salvarAgendamento);

        function mostrarModalNovoAgendamento() {
            document.getElementById('form-agendamento').reset();
            document.getElementById('agendamento-id').value = '';
            document.getElementById('btn-salvar-agendamento').textContent = 'Agendar';
            document.getElementById('btn-deletar-agendamento').style.display = 'none';
            
            // Define a data do filtro
            document.getElementById('agendamento-data').value = document.getElementById('filtro-visao-diaria-data').value;
            
            abrirModal('modal-agendamento', 'Novo Agendamento');
        }
        
        function editarAgendamento(id) {
            const agendamento = agendamentosCache[id];
            if (!agendamento) return;
            
            document.getElementById('agendamento-id').value = id;
            document.getElementById('agendamento-cliente-nome').value = agendamento.clienteNome;
            document.getElementById('agendamento-servico-nome').value = agendamento.servicoNome;
            document.getElementById('agendamento-data').value = agendamento.data;
            document.getElementById('agendamento-hora').value = agendamento.hora;
            document.getElementById('agendamento-observacoes').value = agendamento.observacoes || '';
            
            document.getElementById('btn-salvar-agendamento').textContent = 'Salvar Alterações';
            document.getElementById('btn-deletar-agendamento').style.display = 'inline-flex';
            
            // Associa a função de deletar ao botão no modal de edição
            document.getElementById('btn-deletar-agendamento').onclick = () => deletarAgendamento(id);
            
            abrirModal('modal-agendamento', 'Editar Agendamento');
        }

        function salvarAgendamento(e) {
            e.preventDefault();
            const id = document.getElementById('agendamento-id').value;
            const clienteNome = document.getElementById('agendamento-cliente-nome').value.trim();
            const servicoNome = document.getElementById('agendamento-servico-nome').value.trim();
            const data = document.getElementById('agendamento-data').value;
            const hora = document.getElementById('agendamento-hora').value;
            const observacoes = document.getElementById('agendamento-observacoes').value;
            
            if (!clienteNome || !servicoNome || !data || !hora) {
                 showNotification('Preencha todos os campos obrigatórios.', 'error');
                 return;
            }

            // 1. Tenta identificar se o serviço é um pacote
            const isPacote = Object.values(pacotesAtivosCache).some(p => p.nomePacote === servicoNome && p.clienteNome === clienteNome && p.restantes > 0);
            const isServico = Object.values(servicosCache).some(s => s.nome === servicoNome);

            if (!isPacote && !isServico) {
                showNotification(`'${servicoNome}' não é um serviço nem um pacote ativo.`, 'error');
                return;
            }

            const agendamentoData = { 
                clienteNome, 
                servicoNome, 
                data, 
                hora, 
                observacoes,
                timestamp: firebase.database.ServerValue.TIMESTAMP 
            };
            
            // 2. Tenta encontrar a duração do serviço ou usa um valor padrão
            let duracao = 60; // Duração padrão

            if (isServico) {
                const servico = Object.values(servicosCache).find(s => s.nome === servicoNome);
                if (servico) duracao = servico.duracao;
            } else if (isPacote) {
                // Para pacotes, busca a duração do serviço original
                const pacote = Object.values(pacotesAtivosCache).find(p => p.nomePacote === servicoNome);
                 if (pacote) {
                    const servicoOriginal = Object.values(servicosCache).find(s => s.nome === pacote.servicoNomeOriginal);
                    if (servicoOriginal) duracao = servicoOriginal.duracao;
                 }
            }

            // Adiciona a duração ao objeto
            agendamentoData.duracao = duracao;

            if (id) {
                // Edição
                db.ref('agendamentos/' + id).update(agendamentoData)
                    .then(() => {
                        showNotification('Agendamento atualizado com sucesso!', 'success');
                        fecharModal('modal-agendamento');
                    })
                    .catch(error => showNotification('Erro ao atualizar agendamento: ' + error.message, 'error'));
            } else {
                // Novo
                db.ref('agendamentos').push(agendamentoData)
                    .then(() => {
                        showNotification('Agendamento salvo com sucesso!', 'success');
                        fecharModal('modal-agendamento');
                        
                        // 3. Verifica se é pacote e diminui o contador
                        if (isPacote) {
                            darBaixaPacote(clienteNome, servicoNome);
                        }
                        
                        // 4. Cria movimentação (Se não for pacote)
                        if (!isPacote) {
                            const preco = isServico ? Object.values(servicosCache).find(s => s.nome === servicoNome).preco : 0;
                            
                            const movimentacaoData = {
                                data: data,
                                tipo: 'entrada',
                                valor: preco,
                                descricao: `Agendamento - ${servicoNome}`,
                                clienteNome: clienteNome,
                                agendamentoId: id || 'novo', // ID provisório se necessário
                                timestamp: firebase.database.ServerValue.TIMESTAMP
                            };
                            db.ref('movimentacoes').push(movimentacaoData); // Salva a movimentação
                        }
                    })
                    .catch(error => showNotification('Erro ao salvar agendamento: ' + error.message, 'error'));
            }
        }
        
        function deletarAgendamento(id) {
            if (confirm('Tem certeza que deseja deletar este agendamento?')) {
                // Lógica de reversão de pacote e exclusão de movimentação (se existirem) deve vir aqui.
                
                db.ref('agendamentos/' + id).remove()
                    .then(() => {
                        showNotification('Agendamento deletado com sucesso!', 'success');
                        fecharModal('modal-agendamento');
                    })
                    .catch(error => showNotification('Erro ao deletar agendamento: ' + error.message, 'error'));
            }
        }

        // ----------------------------------------------------------------------------------
        // 4. VISÃO DIÁRIA DA AGENDA (Renderização)
        
        /**
         * Renderiza a tabela de visão diária (timesheet)
         * @param {string} dateString - Data no formato YYYY-MM-DD.
         */
        window.renderizarVisaoDiaria = function(dateString) {
            const lista = document.getElementById('lista-visao-diaria');
            lista.innerHTML = '';
            
            // Filtra agendamentos para o dia selecionado
            const agendamentosDoDia = Object.values(agendamentosCache).filter(
                a => a.data === dateString
            ).sort((a, b) => a.hora.localeCompare(b.hora));

            const horariosOcupados = new Array(48).fill(null); // 48 blocos de 30 minutos (00:00 a 23:30)

            agendamentosDoDia.forEach(agendamento => {
                const [h, m] = agendamento.hora.split(':').map(Number);
                const duracao = agendamento.duracao || 60; // Pega a duração ou usa 60 min

                let startBlock = (h * 60 + m) / 30;
                let numBlocks = Math.ceil(duracao / 30);
                
                for (let i = 0; i < numBlocks; i++) {
                    if (startBlock + i < 48) {
                        horariosOcupados[startBlock + i] = agendamento.id;
                    }
                }
            });

            // Geração da Tabela (Intervalos de 30 minutos)
            for (let i = 0; i < 48; i++) {
                const hour = Math.floor(i / 2);
                const minute = (i % 2) * 30;
                const horarioStr = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
                
                const row = lista.insertRow();
                
                // Coluna do Horário
                row.innerHTML = `<td class="horario-celula">${horarioStr}</td>`;
                
                // Coluna do Agendamento
                const agendamentoCell = row.insertCell();
                agendamentoCell.colSpan = 1;

                if (horariosOcupados[i] === null) {
                    // Célula Vaga
                    agendamentoCell.className = 'agendamento-vago';
                    agendamentoCell.textContent = 'Vago';
                    // Futuro: Adicionar evento para agendar neste horário
                } else {
                    // Célula Ocupada
                    const agendamentoId = horariosOcupados[i];
                    const agendamento = agendamentosCache[agendamentoId];
                    
                    if (agendamento) {
                        agendamentoCell.className = 'agendamento-ocupado';
                        agendamentoCell.innerHTML = `
                             <strong>${agendamento.servicoNome}</strong><br>
                             ${agendamento.clienteNome} (${agendamento.hora})
                        `;
                        agendamentoCell.onclick = () => editarAgendamento(agendamentoId);

                        // Se for o início de um bloco de agendamento (onde o ID é diferente do anterior, ou é o primeiro)
                        // A célula só é renderizada se for a primeira do bloco de 30 minutos (i % 2 === 0)
                        if (i === 0 || horariosOcupados[i] !== horariosOcupados[i - 1]) {
                             // Calcular quantas linhas o agendamento deve ocupar (rowspan)
                            const startBlock = (hour * 60 + minute) / 30;
                            const duracaoEmBlocos = Math.ceil((agendamento.duracao || 60) / 30);
                            
                            agendamentoCell.rowSpan = duracaoEmBlocos;
                        } else {
                            // Se não for o início (bloco subsequente), esconde a célula
                            agendamentoCell.style.display = 'none';
                        }
                    } else {
                         // Erro (deveria estar ocupado, mas não achou o ID)
                        agendamentoCell.className = 'agendamento-vago';
                        agendamentoCell.textContent = 'Erro - Vago';
                    }
                }
            }
        }

        // ----------------------------------------------------------------------------------
        // 5. PACOTES (CRUD e Cache)
        
        // ... carregarPacotesAtivos(), renderizarPacotes(), darBaixaPacote(), salvarPacote(), deletarPacote() ...

        // Função para carregar os pacotes e manter o cache atualizado
        function carregarPacotesAtivos() {
            db.ref('pacotes').on('value', (snapshot) => {
                pacotesAtivosCache = {};
                // Filtra apenas pacotes que ainda têm sessões restantes (> 0) e que não expiraram
                const hoje = new Date().toISOString().slice(0, 10);
                
                snapshot.forEach(childSnapshot => {
                    const pacote = childSnapshot.val();
                    pacote.id = childSnapshot.key;
                    
                    // Lógica de Expiração (Simples: 1 ano de validade a partir da data de início)
                    const dataInicio = new Date(pacote.dataInicio);
                    const dataExpiracao = new Date(dataInicio);
                    dataExpiracao.setFullYear(dataExpiracao.getFullYear() + 1);
                    
                    const isVencido = new Date(hoje) > dataExpiracao;
                    
                    if (pacote.restantes > 0 && !isVencido) {
                        pacotesAtivosCache[childSnapshot.key] = pacote;
                    }
                });
                
                renderizarPacotes(pacotesAtivosCache);
                atualizarDatalistAgendamento(); // Atualiza a lista de Serviços/Pacotes
            });
        }
        
        // Função para renderizar a lista de pacotes ativos na tabela
        function renderizarPacotes(pacotes) {
            const lista = document.getElementById('lista-pacotes-ativos');
            lista.innerHTML = '';
            
            Object.keys(pacotes).forEach(key => {
                const pacote = pacotes[key];
                const row = lista.insertRow();
                row.dataset.nome = pacote.clienteNome.toLowerCase(); // Para o filtro
                
                const statusClass = pacote.restantes > 0 ? 'status-package-active' : 'status-package-finalized';
                const statusText = pacote.restantes > 0 ? 'Ativo' : 'Finalizado';

                // Cria o nome do pacote (ex: "Pacote 5x Manicure Simples")
                const nomePacote = `Pacote ${pacote.quantidade}x ${pacote.servicoNomeOriginal}`;
                pacote.nomePacote = nomePacote; // Adiciona para uso no Datalist

                row.innerHTML = `
                    <td>${pacote.clienteNome}</td>
                    <td>${nomePacote}</td>
                    <td>R$ ${formatarValor(pacote.precoTotal)}</td>
                    <td>${pacote.restantes} de ${pacote.quantidade}</td>
                    <td><span class="${statusClass}">${statusText}</span></td>
                    <td>${formatarData(pacote.dataInicio)}</td>
                    <td class="action-buttons">
                        <button class="btn btn-secondary" onclick="editarPacote('${key}')">
                             <i class="material-icons">edit</i>
                        </button>
                    </td>
                `;
            });
        }

        // Função para renderizar histórico de pacotes (finalizados ou vencidos)
        function renderizarHistoricoPacotes() {
             // ... Lógica para buscar e renderizar pacotes expirados ou com 0 restantes no histórico ...
             const lista = document.getElementById('lista-pacotes-historico');
             lista.innerHTML = '<tr><td colspan="6" style="text-align: center;">Funcionalidade em desenvolvimento. Por enquanto, consulte apenas a lista de Ativos.</td></tr>';
        }
        
        // Função para dar baixa em uma sessão de pacote
        function darBaixaPacote(clienteNome, nomePacote) {
            const pacoteId = Object.keys(pacotesAtivosCache).find(key => 
                pacotesAtivosCache[key].clienteNome === clienteNome && 
                pacotesAtivosCache[key].nomePacote === nomePacote
            );

            if (pacoteId) {
                const pacote = pacotesAtivosCache[pacoteId];
                if (pacote.restantes > 0) {
                    const novoRestantes = pacote.restantes - 1;
                    db.ref('pacotes/' + pacoteId).update({ restantes: novoRestantes })
                        .then(() => {
                            showNotification(`Sessão do pacote de ${pacote.servicoNomeOriginal} registrada. Restantes: ${novoRestantes}.`, 'info');
                            // Não precisa fazer mais nada, o listener carregarPacotesAtivos atualiza a lista
                        })
                        .catch(error => showNotification('Erro ao dar baixa no pacote: ' + error.message, 'error'));
                }
            }
        }
        
        // Formulário e Funções de Modal Pacote
        document.getElementById('form-pacote').addEventListener('submit', salvarPacote);

        function mostrarModalNovoPacote() {
            document.getElementById('form-pacote').reset();
            document.getElementById('pacote-id').value = '';
            document.getElementById('btn-salvar-pacote').textContent = 'Salvar Pacote';
            document.getElementById('btn-deletar-pacote').style.display = 'none';
            document.getElementById('pacote-data-inicio').value = new Date().toISOString().slice(0, 10);
            abrirModal('modal-pacote', 'Novo Pacote');
        }
        
        function editarPacote(id) {
            const pacote = pacotesAtivosCache[id];
            if (!pacote) return;
            
            document.getElementById('pacote-id').value = id;
            document.getElementById('pacote-cliente-nome').value = pacote.clienteNome;
            document.getElementById('pacote-servico-nome').value = pacote.servicoNomeOriginal;
            document.getElementById('pacote-quantidade').value = pacote.quantidade;
            document.getElementById('pacote-preco-total').value = pacote.precoTotal;
            document.getElementById('pacote-data-inicio').value = pacote.dataInicio;
            document.getElementById('pacote-observacoes').value = pacote.observacoes || '';
            
            document.getElementById('btn-salvar-pacote').textContent = 'Salvar Alterações';
            document.getElementById('btn-deletar-pacote').style.display = 'inline-flex';
            document.getElementById('btn-deletar-pacote').onclick = () => deletarPacote(id);
            
            abrirModal('modal-pacote', 'Editar Pacote');
        }

        function salvarPacote(e) {
            e.preventDefault();
            const id = document.getElementById('pacote-id').value;
            const clienteNome = document.getElementById('pacote-cliente-nome').value;
            const servicoNomeOriginal = document.getElementById('pacote-servico-nome').value;
            const quantidade = parseInt(document.getElementById('pacote-quantidade').value);
            const precoTotal = parseFloat(document.getElementById('pacote-preco-total').value);
            const dataInicio = document.getElementById('pacote-data-inicio').value;
            const observacoes = document.getElementById('pacote-observacoes').value;
            
            if (!clienteNome || !servicoNomeOriginal || !quantidade || !precoTotal || !dataInicio) {
                 showNotification('Preencha todos os campos obrigatórios.', 'error');
                 return;
            }

            const nomePacote = `Pacote ${quantidade}x ${servicoNomeOriginal}`;

            const pacoteData = { 
                clienteNome, 
                servicoNomeOriginal,
                nomePacote, // Nome formatado para o datalist
                quantidade,
                restantes: id ? pacotesAtivosCache[id].restantes : quantidade, // Mantém o restantes ao editar, ou define a quantidade total ao criar
                precoTotal,
                dataInicio, 
                observacoes,
                timestamp: firebase.database.ServerValue.TIMESTAMP 
            };

            if (id) {
                // Edição
                db.ref('pacotes/' + id).update(pacoteData)
                    .then(() => {
                        showNotification('Pacote atualizado com sucesso!', 'success');
                        fecharModal('modal-pacote');
                    })
                    .catch(error => showNotification('Erro ao atualizar pacote: ' + error.message, 'error'));
            } else {
                // Novo
                db.ref('pacotes').push(pacoteData)
                    .then(() => {
                        showNotification('Pacote salvo com sucesso!', 'success');
                        fecharModal('modal-pacote');
                    })
                    .catch(error => showNotification('Erro ao salvar pacote: ' + error.message, 'error'));
            }
        }
        
        function deletarPacote(id) {
            if (confirm('Tem certeza que deseja deletar este pacote? Esta ação é irreversível.')) {
                 db.ref('pacotes/' + id).remove()
                    .then(() => {
                        showNotification('Pacote deletado com sucesso!', 'success');
                        fecharModal('modal-pacote');
                    })
                    .catch(error => showNotification('Erro ao deletar pacote: ' + error.message, 'error'));
            }
        }

        // ----------------------------------------------------------------------------------
        // 6. HISTÓRICO FINANCEIRO (Movimentações) (CRUD e Cache)
        
        // ... carregarMovimentacoes(), renderizarHistorico(), salvarMovimentacao(), ...

        // Função para carregar todas as movimentações
        function carregarMovimentacoes() {
             db.ref('movimentacoes').on('value', (snapshot) => {
                movimentacoesCache = {};
                snapshot.forEach(childSnapshot => {
                    movimentacoesCache[childSnapshot.key] = childSnapshot.val();
                });
                
                // Se a seção Histórico estiver ativa, renderiza a lista
                if (document.getElementById('historico-section').classList.contains('active')) {
                     renderizarHistorico();
                }
            });
        }
        
        // Função para renderizar o histórico com base no filtro de mês
        window.renderizarHistorico = function() {
            const lista = document.getElementById('lista-historico');
            lista.innerHTML = '';
            
            const filtroMes = document.getElementById('filtro-historico-mes').value; // YYYY-MM
            let totalEntradas = 0;
            let totalSaidas = 0;

            Object.keys(movimentacoesCache).sort((a, b) => {
                // Ordena por data mais recente
                return new Date(movimentacoesCache[b].data) - new Date(movimentacoesCache[a].data);
            }).forEach(key => {
                const mov = movimentacoesCache[key];
                
                // Filtro por Mês (se o filtro estiver preenchido)
                if (filtroMes && !mov.data.startsWith(filtroMes)) {
                    return; // Pula se não for o mês correto
                }
                
                const valorFormatado = formatarValor(mov.valor);
                const tipoClass = mov.tipo === 'entrada' ? 'status-package-paid' : 'status-package-finalized';
                
                // Cálculos dos totais
                if (mov.tipo === 'entrada') {
                    totalEntradas += mov.valor;
                } else {
                    totalSaidas += mov.valor;
                }

                const row = lista.insertRow();
                row.dataset.clienteNome = mov.clienteNome ? mov.clienteNome.toLowerCase() : ''; // Para o filtro
                
                row.innerHTML = `
                    <td>${formatarData(mov.data)}</td>
                    <td>${mov.descricao} ${mov.clienteNome ? `(${mov.clienteNome})` : ''}</td>
                    <td><span class="${tipoClass}">${mov.tipo === 'entrada' ? '+' : '-'} R$ ${valorFormatado}</span></td>
                    <td>${mov.tipo === 'entrada' ? 'Receita' : 'Despesa'}</td>
                    <td class="action-buttons">
                        <button class="btn btn-secondary" onclick="editarMovimentacao('${key}')">
                             <i class="material-icons">edit</i>
                        </button>
                        <button class="btn btn-danger" onclick="deletarMovimentacao('${key}')">
                             <i class="material-icons">delete</i>
                        </button>
                    </td>
                `;
            });
            
            // Adiciona a linha de totais (roda-pé)
            const footerRow = lista.insertRow();
            footerRow.innerHTML = `
                <td colspan="2" style="font-weight: bold; text-align: right; background-color: var(--sidebar-hover-bg);">TOTAIS DO MÊS:</td>
                <td colspan="3" style="font-weight: bold; background-color: var(--sidebar-hover-bg);">
                    Entradas: <span class="status-package-paid">+ R$ ${formatarValor(totalEntradas)}</span> | 
                    Saídas: <span class="status-package-finalized">- R$ ${formatarValor(totalSaidas)}</span> | 
                    Líquido: <span class="${(totalEntradas - totalSaidas) >= 0 ? 'status-package-paid' : 'status-package-finalized'}">R$ ${formatarValor(totalEntradas - totalSaidas)}</span>
                </td>
            `;
            
            // Aplica o filtro de texto após a renderização
            filtrarHistoricoTabela();
        }

        // Formulário e Funções de Modal Movimentação
        document.getElementById('form-movimentacao').addEventListener('submit', salvarMovimentacao);
        
        function mostrarModalNovaMovimentacao() {
            document.getElementById('form-movimentacao').reset();
            document.getElementById('movimentacao-id').value = '';
            document.getElementById('btn-salvar-movimentacao').textContent = 'Salvar Movimentação';
            document.getElementById('btn-deletar-movimentacao').style.display = 'none';
            document.getElementById('movimentacao-data').value = new Date().toISOString().slice(0, 10);
            abrirModal('modal-movimentacao', 'Nova Movimentação');
        }
        
        function editarMovimentacao(id) {
            const mov = movimentacoesCache[id];
            if (!mov) return;
            
            document.getElementById('movimentacao-id').value = id;
            document.getElementById('movimentacao-data').value = mov.data;
            document.getElementById('movimentacao-tipo').value = mov.tipo;
            document.getElementById('movimentacao-descricao').value = mov.descricao;
            document.getElementById('movimentacao-valor').value = mov.valor;
            document.getElementById('movimentacao-cliente-nome').value = mov.clienteNome || '';
            
            document.getElementById('btn-salvar-movimentacao').textContent = 'Salvar Alterações';
            document.getElementById('btn-deletar-movimentacao').style.display = 'inline-flex';
            document.getElementById('btn-deletar-movimentacao').onclick = () => deletarMovimentacao(id);
            
            abrirModal('modal-movimentacao', 'Editar Movimentação');
        }

        function salvarMovimentacao(e) {
            e.preventDefault();
            const id = document.getElementById('movimentacao-id').value;
            const data = document.getElementById('movimentacao-data').value;
            const tipo = document.getElementById('movimentacao-tipo').value;
            const descricao = document.getElementById('movimentacao-descricao').value;
            const valor = parseFloat(document.getElementById('movimentacao-valor').value);
            const clienteNome = document.getElementById('movimentacao-cliente-nome').value;

            const movimentacaoData = { 
                data, 
                tipo, 
                descricao, 
                valor, 
                clienteNome: tipo === 'entrada' ? clienteNome : '', // Cliente só é relevante para entrada
                timestamp: firebase.database.ServerValue.TIMESTAMP 
            };

            if (id) {
                // Edição
                db.ref('movimentacoes/' + id).update(movimentacaoData)
                    .then(() => {
                        showNotification('Movimentação atualizada com sucesso!', 'success');
                        fecharModal('modal-movimentacao');
                    })
                    .catch(error => showNotification('Erro ao atualizar movimentação: ' + error.message, 'error'));
            } else {
                // Novo
                db.ref('movimentacoes').push(movimentacaoData)
                    .then(() => {
                        showNotification('Movimentação salva com sucesso!', 'success');
                        fecharModal('modal-movimentacao');
                    })
                    .catch(error => showNotification('Erro ao salvar movimentação: ' + error.message, 'error'));
            }
        }
        
        function deletarMovimentacao(id) {
            if (confirm('Tem certeza que deseja deletar esta movimentação?')) {
                 db.ref('movimentacoes/' + id).remove()
                    .then(() => {
                        showNotification('Movimentação deletada com sucesso!', 'success');
                        fecharModal('modal-movimentacao');
                    })
                    .catch(error => showNotification('Erro ao deletar movimentação: ' + error.message, 'error'));
            }
        }

        // 6.2. FILTRAR HISTÓRICO NA TABELA
        window.filtrarHistoricoTabela = function() {
             const filtro = document.getElementById('filtro-historico-cliente').value.toLowerCase();
             const listaHistorico = document.getElementById('lista-historico');
             const linhas = listaHistorico.getElementsByTagName('tr');

             for (let i = 0; i < linhas.length; i++) {
                 const row = linhas[i];
                 // Ignora a linha de totais (footerRow)
                 if (row.querySelector('td[colspan="2"]')) continue; 

                 if (!row.dataset.clienteNome) continue; 

                 const clienteNome = row.dataset.clienteNome;
                
                 if (clienteNome.includes(filtro)) {
                     row.style.display = ""; // Usa string vazia para o display padrão da tabela
                 } else {
                     row.style.display = "none";
                 }
             }
        }
        
        // 6.3. RESETAR FILTRO DO HISTÓRICO
        window.resetFiltroHistorico = function() {
            document.getElementById('filtro-historico-mes').value = ''; 
            document.getElementById('filtro-historico-cliente').value = '';
            renderizarHistorico();
        }

        // ----------------------------------------------------------------------------------
        // UTILS: Funções de Apoio (Formatação, Filtro Genérico, Datalist)
        // ----------------------------------------------------------------------------------

        /**
         * Formata um número para o padrão monetário brasileiro.
         * @param {number} valor - O valor numérico.
         * @returns {string} O valor formatado (ex: '1.234,50').
         */
        function formatarValor(valor) {
            if (typeof valor !== 'number' || isNaN(valor)) {
                return '0,00';
            }
            return valor.toFixed(2).replace('.', ',');
        }
        
        /**
         * Formata uma data no formato YYYY-MM-DD para DD/MM/YYYY.
         * @param {string} dateString - A data no formato YYYY-MM-DD.
         * @returns {string} A data no formato DD/MM/YYYY.
         */
        function formatarData(dateString) {
             if (!dateString) return 'N/A';
             const [year, month, day] = dateString.split('-');
             return `${day}/${month}/${year}`;
        }
        
        /**
         * Preenche um <datalist> com dados de um cache.
         * @param {string} datalistId - O ID do datalist.
         * @param {object} cache - O objeto de cache (ex: clientesCache).
         * @param {string} displayKey - A chave do objeto a ser exibida (ex: 'nome').
         */
        function preencherDatalist(datalistId, cache, displayKey) {
            const datalist = document.getElementById(datalistId);
            if (!datalist) return;
            
            datalist.innerHTML = '';
            
            const uniqueValues = new Set();
            Object.values(cache).forEach(item => {
                if (item[displayKey] && !uniqueValues.has(item[displayKey])) {
                    const option = document.createElement('option');
                    option.value = item[displayKey];
                    datalist.appendChild(option);
                    uniqueValues.add(item[displayKey]);
                }
            });
        }
        
        /**
         * Filtra uma tabela genérica por uma coluna específica (padrão é a 1ª coluna).
         * @param {string} tbodyId - O ID do tbody da tabela.
         * @param {string} filtro - O texto a ser filtrado.
         */
        window.filtrarTabela = function(tbodyId, filtro) {
             const lista = document.getElementById(tbodyId);
             if (!lista) return;

             const filtroLower = filtro.toLowerCase();
             const linhas = lista.getElementsByTagName('tr');

             for (let i = 0; i < linhas.length; i++) {
                 const row = linhas[i];
                 // Assume que o atributo data-nome ou data-telefone existe na linha
                 const nomeMatch = row.dataset.nome && row.dataset.nome.includes(filtroLower);
                 const telMatch = row.dataset.telefone && row.dataset.telefone.includes(filtroLower.replace(/\D/g, ''));
                
                 if (nomeMatch || telMatch) {
                     row.style.display = ""; // Mostra a linha
                 } else {
                     row.style.display = "none"; // Esconde a linha
                 }
             }
        }
        
        // ----------------------------------------------------------------------------------
        // CONTROLE DE TELAS (LOGIN/LOGOUT)
        // ----------------------------------------------------------------------------------
        
        function showLogin() {
            document.getElementById('app-container').style.display = 'none';
            document.getElementById('login-container').style.display = 'flex'; // CORREÇÃO: Garante que o CSS 'flex' seja aplicado
        }
        
        function showApp() {
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('app-container').style.display = 'flex';
            // Carrega os dados iniciais do app
            showSection('agenda-section');
        }

        // Função que carrega todos os listeners do Firebase de uma vez após o login
        function carregarTodosOsDados() {
            carregarClientes();
            carregarServicos();
            carregarAgendamentos(); 
            carregarPacotesAtivos(); 
            carregarMovimentacoes();
        }

        // ----------------------------------------------------------------------------------
        // INICIALIZAÇÃO
        // ----------------------------------------------------------------------------------
        document.addEventListener('DOMContentLoaded', () => {
            
            // CORREÇÃO ESSENCIAL: Movendo os listeners de login/logout para dentro de DOMContentLoaded
            // para garantir que o formulário e o botão existam antes de tentar adicionar o evento.
            document.getElementById('login-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const senha = document.getElementById('loginSenha').value;
                
                if (senha === senhaAcesso) {
                     showApp();
                     showNotification('Login realizado com sucesso!', 'success'); // Notificação restaurada
                     
                     // Inicia o carregamento dos dados do Firebase
                     carregarTodosOsDados(); 
                     
                     // Configura a data de hoje para os inputs de data
                     const today = new Date().toISOString().slice(0, 10);
                     document.getElementById('filtro-visao-diaria-data').value = today;
                     document.getElementById('pacote-data-inicio').value = today;
                     // O filtro do histórico é configurado dentro do showSection('historico-section')
                     
                     // Associa a função showSection aos links da sidebar
                     document.querySelectorAll('.sidebar ul li a').forEach(link => {
                         link.addEventListener('click', function(e) {
                             e.preventDefault();
                             showSection(this.getAttribute('data-section') + '-section');
                         });
                     });
                     
                } else {
                     showNotification('Senha incorreta. Tente novamente.', 'error'); // Notificação restaurada
                }
            });

            document.getElementById('logout-button').addEventListener('click', () => {
                showLogin();
                showNotification('Sessão encerrada.', 'info');
            });
            
             // Mostra a tela de login ao carregar a página
            showLogin();
        });
    </script>
</body>
</html>
