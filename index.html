<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tati Manicure - Gerenciamento de Agendamentos</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <style>
        :root {
            --primary-color: #ff8c6b; /* Cor de Destaque (Salmão/Coral) */
            --secondary-color: #6c757d; /* Cinza para secundários */
            --background-color: #f4f7f6; /* Fundo Suave */
            --sidebar-bg: #ffffff;
            --sidebar-hover-bg: #fff0eb; /* Fundo mais claro para hover */
            --text-color: #343a40; /* Texto Principal (Escuro) */
            --success-color: #28a745;
            --info-color: #17a2b8;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --border-color: #e9ecef;
            --shadow-color: rgba(0, 0, 0, 0.05);
        }

        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        /* Estrutura do App */
        #login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            /* NOVO: Adição da Imagem de Fundo (Usando 'image_decbc8.jpg' conforme sugerido) */
            background-image: url('image_decbc8.jpg');
            background-size: cover;
            background-position: center;
            /* Aplica a cor principal com transparência e a mistura com a imagem para suavizar */
            background-color: rgba(255, 140, 107, 0.7);
            /* (var(--primary-color) com 70% de opacidade) */
            background-blend-mode: overlay;
            min-height: 100vh;
        }

        .login-card {
            background: var(--sidebar-bg);
            padding: 40px;
            border-radius: 12px;
            /* Ajuste de sombra para destacar mais sobre o fundo de imagem */
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            text-align: center;
            width: 100%;
            max-width: 400px;
        }

        .login-card h1 {
            color: var(--primary-color);
            margin-bottom: 30px;
            font-size: 1.8rem;
        }

        #app-container {
            display: none;
            /* Escondido por padrão, mostrado após o login */
            width: 100%;
            max-width: 1400px;
            height: 95vh;
            background-color: #fff;
            box-shadow: 0 4px 20px var(--shadow-color);
            border-radius: 12px;
            overflow: hidden;
            display: flex;
        }

        /* Barra Lateral (Sidebar) */
        .sidebar {
            width: 250px;
            background-color: var(--sidebar-bg);
            box-shadow: 2px 0 5px var(--shadow-color);
            display: flex;
            flex-direction: column;
            padding: 20px 0;
            flex-shrink: 0;
            justify-content: space-between;
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
            color: var(--primary-color);
            font-size: 1.6rem;
            font-weight: bold;
        }

        .sidebar ul {
            list-style: none;
            padding: 0;
            margin: 0;
            flex-grow: 1;
        }

        .sidebar ul li a {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            text-decoration: none;
            color: var(--text-color);
            transition: background-color 0.2s, color 0.2s;
            font-weight: 500;
        }

        .sidebar ul li a:hover,
        .sidebar ul li a.active {
            background-color: var(--sidebar-hover-bg);
            color: var(--primary-color);
        }

        .sidebar ul li a .material-icons {
            margin-right: 10px;
            font-size: 20px;
        }

        .user-info {
            margin-top: auto;
            padding: 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .user-info p {
            margin: 0 0 10px 0;
            font-weight: bold;
        }
        
        #logout-button {
             width: 100%;
             background-color: var(--secondary-color);
             color: white;
             border: none;
             padding: 10px;
             border-radius: 4px;
             cursor: pointer;
             transition: background-color 0.3s;
        }

        #logout-button:hover {
             background-color: #5a6268;
        }


        /* Conteúdo Principal */
        .main-content {
            flex-grow: 1;
            padding: 30px;
            overflow-y: auto;
            background-color: var(--background-color);
        }

        .content-section {
            display: none;
            padding: 20px;
        }

        .content-section.active {
            display: block;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .section-header h2 {
            margin: 0;
            color: var(--text-color);
            font-size: 1.5rem;
        }
        
        /* Novas cores para Status de Pacote e Histórico */
        .status-package-paid {
             color: var(--success-color);
             font-weight: bold;
        }
        .status-package-pending {
            color: var(--warning-color);
            font-weight: bold;
        }
        .status-package-active {
            color: var(--primary-color);
            font-weight: bold;
        }
        .status-package-finalized {
            color: var(--danger-color);
            font-weight: bold;
        }

        /* Cartão (Card) */
        .card {
            background: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 4px var(--shadow-color);
            margin-bottom: 20px;
        }
        
        /* Abas dentro de uma seção */
        .tab-menu {
             display: flex;
             border-bottom: 2px solid var(--border-color);
             margin-bottom: 20px;
        }
        .tab-menu button {
             padding: 10px 20px;
             border: none;
             background: transparent;
             cursor: pointer;
             font-size: 1rem;
             color: var(--secondary-color);
             border-bottom: 2px solid transparent;
             transition: border-color 0.2s, color 0.2s;
             font-weight: bold;
        }
        .tab-menu button.active {
             color: var(--primary-color);
             border-bottom: 2px solid var(--primary-color);
        }
        .tab-content {
             padding-top: 10px;
        }
        .tab-pane {
             display: none;
        }
        .tab-pane.active {
             display: block;
        }

        /* Formulários */
        .form-group {
            margin-bottom: 15px;
        }

        .form-row {
            display: flex;
            gap: 20px;
        }

        .form-row > div {
            flex: 1;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 0.95rem;
        }

        input[type="text"],
        input[type="number"],
        input[type="email"],
        input[type="tel"],
        input[type="date"],
        input[type="time"],
        textarea,
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        /* Datalist input */
        input[list] {
            /* Estilo para garantir que o input datalist se pareça com um campo normal */
            background-image: none;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="email"]:focus,
        input[type="tel"]:focus,
        input[type="date"]:focus,
        input[type="time"]:focus,
        textarea:focus,
        select:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        textarea {
            resize: vertical;
        }

        /* Botões */
        button, .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: background-color 0.2s, opacity 0.2s;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #e57a5e;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #218838;
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: var(--text-color);
        }

        .btn-warning:hover {
            background-color: #ffb547;
        }


        /* Tabelas */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table thead tr {
            background-color: var(--primary-color);
            color: white;
            text-align: left;
        }

        .data-table th, .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table tbody tr:hover {
            background-color: var(--sidebar-hover-bg);
        }

        .data-table td.action-buttons button {
            margin-right: 5px;
            padding: 6px 8px;
        }

        .data-table td.action-buttons {
            white-space: nowrap;
        }

        /* Notificação */
        #notification-bar {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s, transform 0.3s;
            transform: translateY(-20px);
            z-index: 1000;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            font-weight: bold;
        }

        #notification-bar.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        #notification-bar.success { background-color: var(--success-color); }
        #notification-bar.error { background-color: var(--danger-color); }
        #notification-bar.info { background-color: var(--info-color); }

        /* Utilitários */
        .flex-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .input-group {
            display: flex;
            gap: 10px;
        }
        
        .input-group input, .input-group select {
            flex-grow: 1;
        }

        .filter-row {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            margin-bottom: 20px;
        }
        .filter-row > div {
            flex: 1;
        }
        .filter-row button {
            flex-grow: 0;
            flex-shrink: 0;
            padding: 9px 15px; /* Ajuste para alinhar com o input */
        }
        
        /* Estilos para a Tabela de Visão Diária */
        #tabela-visao-diaria {
             border: 1px solid var(--border-color);
             margin-top: 0;
        }
        #tabela-visao-diaria thead tr {
             background-color: var(--secondary-color);
        }
        #tabela-visao-diaria td {
             height: 40px;
             /* Altura padrão para cada intervalo de 30 min */
             font-size: 0.9rem;
             vertical-align: top;
        }
        .horario-celula {
             width: 80px;
             font-weight: bold;
             background-color: var(--sidebar-hover-bg);
             color: var(--text-color);
             text-align: center;
             vertical-align: middle !important;
             border-right: 1px solid var(--border-color);
        }
        .agendamento-vago {
             background-color: #f7fff7;
             /* Verde clarinho */
             color: var(--success-color);
             font-weight: bold;
             font-style: italic;
             text-align: center;
             line-height: 40px;
             cursor: pointer; /* Adicionado cursor para indicar que pode clicar para agendar */
        }
        .agendamento-ocupado {
             background-color: #fff0eb;
             /* Fundo do hover de sidebar, suave */
             color: var(--text-color);
             font-weight: 500;
             padding: 5px 10px !important;
             vertical-align: middle !important;
             line-height: 1.2;
             border-left: 5px solid var(--primary-color);
             cursor: pointer;
        }
        .agendamento-ocupado strong {
             color: var(--primary-color);
             font-weight: bold;
        }
        .agendamento-ocupado.package {
             border-left: 5px solid var(--info-color); /* Diferenciar agendamento de pacote */
        }
        
        /* --------------------------------------------------- */
        /* RESPONSIVIDADE MOBILE (Mobile First - Portrait Mode)*/
        /* --------------------------------------------------- */
        @media (max-width: 768px) {
            /* Estrutura Principal */
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
                box-shadow: 0 0 5px var(--shadow-color);
            }
            .main-content {
                padding: 15px;
            }
            #app-container {
                flex-direction: column;
            }

            /* Navegação Horizontal */
            .sidebar ul {
                display: flex;
                flex-wrap: nowrap;
                /* Tenta manter em uma linha, mas permite rolagem */
                overflow-x: auto;
                justify-content: flex-start;
                border-bottom: 1px solid var(--border-color);
            }
            .sidebar ul li {
                flex-shrink: 0; /* Impede que os itens encolham */
                text-align: center;
            }
            .sidebar ul li a {
                justify-content: center;
                padding: 10px;
                flex-direction: column;
                font-size: 0.75rem;
                white-space: nowrap;
            }
            .sidebar ul li a .material-icons {
                margin-right: 0;
                margin-bottom: 5px;
                font-size: 20px;
            }

            /* FIX: Botão Sair visível no celular */
            .user-info {
                display: block;
                padding: 10px 15px;
                border-top: none;
                text-align: center;
            }
            .user-info p {
                display: none; /* Esconde o texto "Olá, Tati!" para economizar espaço */
            }
            .user-info button {
                width: 100%;
                margin-top: 10px;
                font-size: 0.9rem;
            }

            /* 1. Correção de Formulários e Filtros (Empilhamento) */
            .form-row, .filter-row {
                flex-direction: column;
                gap: 0;
                /* Remove gap quando empilha */
            }
            .form-row > div, .filter-row > div {
                flex: 0 0 100% !important;
                /* Força largura total */
                width: 100%;
            }
            /* Ajusta margem para inputs empilhados */
            .form-group, .filter-row > div {
                margin-bottom: 10px;
            }
            .filter-row button {
                width: 100%;
                margin-top: 5px;
                padding: 10px 15px !important;
            }

            /* Ajuste para a Tabela de Visão Diária */
            .table-responsive {
                overflow-x: auto;
            }
            #tabela-visao-diaria {
                width: 100%;
                min-width: 300px; /* Garante que não fique muito esmagada */
            }
            #tabela-visao-diaria td {
                padding: 5px 10px !important;
            }

            /* 2. Correção de Tabelas (Cartão-like View) */
            .data-table, .data-table tbody, .data-table td, .data-table tr {
                display: block;
                /* Força elementos da tabela a empilhar */
            }
            .data-table thead {
                display: none;
                /* Esconde o cabeçalho original */
            }
            .data-table tr {
                border: 1px solid var(--border-color);
                margin-bottom: 15px;
                border-radius: 8px;
                box-shadow: 0 1px 3px var(--shadow-color);
                padding: 10px;
            }
            .data-table td {
                border: none;
                position: relative;
                padding-left: 50% !important;
                /* Espaço para o rótulo */
                text-align: right; /* Alinha o valor à direita */
                white-space: normal;
                /* Permite quebras de linha */
                min-height: 40px;
            }
            /* Rótulo customizado (que usa o data-label do JS) */
            .data-table td::before {
                content: attr(data-label);
                position: absolute;
                left: 10px;
                width: 45%;
                padding-right: 10px;
                white-space: nowrap;
                text-align: left;
                font-weight: bold;
                color: var(--primary-color);
            }
            /* Organização dos botões de ação em mobile */
            /* Garante que o rótulo "Ações" não sobreponha o primeiro botão */
            .data-table td.action-buttons {
                text-align: left;
                padding-left: 10px !important;
                display: flex;
                flex-direction: column; /* Empilha os botões */
                gap: 5px;
            }
            .data-table td.action-buttons::before {
                content: "Ações";
                width: 100%;
                margin-bottom: 5px;
                display: block;
            }
            .data-table td.action-buttons button {
                margin: 0;
                width: 100%;
                /* Ocupa a largura toda */
                max-width: 100%;
                box-sizing: border-box;
                font-size: 0.9rem;
                padding: 8px 5px;
            }
        }
    </style>
</head>
<body>

    <div id="notification-bar"></div>

    <div id="login-container">
        <div class="login-card">
            <h1>Tati Manicure - Acesso</h1>
            <form id="login-form">
                <div class="form-group">
                    <label for="loginSenha">Senha de Acesso</label>
                    <input type="password" id="loginSenha" required>
                </div>
                <button type="submit" class="btn-primary" style="width: 100%; margin-top: 10px;">
                    <span class="material-icons">login</span> Entrar
                </button>
            </form>
        </div>
    </div>


    <datalist id="clientes-datalist"></datalist>

    <div id="app-container" style="display: none;">
        
        <aside class="sidebar">
            <div>
                <div class="logo">TATI MANICURE APP</div>
                <ul>
                    <li><a href="#" data-section="agenda" class="active" onclick="showSection('agenda-section')"><span class="material-icons">event</span> Agenda</a></li>
                    <li><a href="#" data-section="pacotes" onclick="showSection('pacotes-section')"><span class="material-icons">folder_special</span> Pacotes Ativos</a></li>
                    <li><a href="#" data-section="clientes" onclick="showSection('clientes-section')"><span class="material-icons">people</span> Clientes</a></li>
                    <li><a href="#" data-section="servicos" onclick="showSection('servicos-section')"><span class="material-icons">content_cut</span> Serviços/Pacotes</a></li>
                    <li><a href="#" data-section="historico" onclick="showSection('historico-section')"><span class="material-icons">history</span> Histórico Lucros</a></li>
                </ul>
            </div>
            <div class="user-info">
                <p>Olá, Tati!</p>
                <button id="logout-button" class="btn-secondary">Sair</button>
            </div>
        </aside>

        <main class="main-content">

            <section id="agenda-section" class="content-section active">
                <div class="section-header">
                    <h2>Agenda de Agendamentos</h2>
                    <div>
                        <input type="date" id="filtro-visao-diaria-data" onchange="renderizarAgendamentosDiario()" class="form-control">
                    </div>
                </div>

                <div class="card">
                     <div class="tab-menu">
                         <button class="active" onclick="showAgendaTab('diaria-tab')">Visão Diária</button>
                         <button onclick="showAgendaTab('proximos-tab')">Próximos Agendamentos</button>
                     </div>
                     <div class="tab-content">
                         <div id="diaria-tab" class="tab-pane active">
                             <div class="table-responsive">
                                 <table class="data-table" id="tabela-visao-diaria">
                                     <thead>
                                         <tr>
                                             <th class="horario-celula" style="background-color: var(--secondary-color); color: white;">Horário</th>
                                             <th style="background-color: var(--secondary-color); color: white;">Agendamentos</th>
                                         </tr>
                                     </thead>
                                     <tbody id="lista-agendamentos-diarios">
                                         </tbody>
                                 </table>
                             </div>
                         </div>
                         <div id="proximos-tab" class="tab-pane">
                             <h3>Próximos Agendamentos (Todos)</h3>
                             <div class="table-responsive">
                                 <table class="data-table">
                                     <thead>
                                         <tr>
                                             <th>Cliente</th>
                                             <th>Serviço(s)</th>
                                             <th>Data e Hora</th>
                                             <th>Ações</th>
                                         </tr>
                                     </thead>
                                     <tbody id="lista-proximos-agendamentos">
                                         </tbody>
                                 </table>
                             </div>
                         </div>
                     </div>
                </div>

                <div class="card" id="novo-agendamento-card" style="margin-top: 30px;">
                    <h3>Novo Agendamento</h3>
                    <form id="agendamento-form" onsubmit="salvarAgendamento(event)">
                        <input type="hidden" id="agendamentoId">
                        <input type="hidden" id="agendamento-is-package" value="false"> 
                        <input type="hidden" id="agendamento-pacote-id">
                        <input type="hidden" id="agendamento-servico-pacote-id">

                        <div class="form-group">
                            <label for="agendamento-cliente">Cliente</label>
                            <input type="text" id="agendamento-cliente" list="clientes-datalist" placeholder="Nome do Cliente" required>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="agendamento-data">Data</label>
                                <input type="date" id="agendamento-data" required>
                            </div>
                            <div class="form-group">
                                <label for="agendamento-hora">Hora</label>
                                <input type="time" id="agendamento-hora" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="agendamento-servico">Serviço(s)</label>
                            <select id="agendamento-servico" multiple required> 
                            </select>
                            <small>Pressione Ctrl (ou Cmd) para selecionar múltiplos serviços.</small>
                        </div>
                        <div class="form-group">
                            <label for="agendamento-observacoes">Observações</label>
                            <textarea id="agendamento-observacoes" rows="2"></textarea>
                        </div>
                        <button type="submit" class="btn-primary" id="btn-salvar-agendamento"><span class="material-icons">save</span> Agendar Serviço</button>
                        <button type="button" class="btn-secondary" onclick="resetFormAgendamento()"><span class="material-icons">refresh</span> Limpar Formulário</button>
                    </form>
                </div>
            </section>
            
            <section id="pacotes-section" class="content-section">
                <div class="section-header">
                    <h2>Gerenciamento de Pacotes Ativos</h2>
                    <button class="btn-primary" onclick="abrirModalPacoteAtivo()">
                         <span class="material-icons">add</span> Lançar Novo Pacote
                    </button>
                </div>

                <div class="card">
                     <div class="table-responsive">
                         <table class="data-table">
                             <thead>
                                 <tr>
                                     <th>Cliente</th>
                                     <th>Pacote</th>
                                     <th>Usos Restantes</th>
                                     <th>Status</th>
                                     <th>Ações</th>
                                 </tr>
                             </thead>
                             <tbody id="lista-pacotes-ativos">
                                 </tbody>
                         </table>
                     </div>
                </div>
            </section>

            <section id="clientes-section" class="content-section">
                <div class="section-header">
                    <h2>Cadastro de Clientes</h2>
                    <button class="btn-primary" onclick="abrirModalCliente()">
                        <span class="material-icons">add</span> Novo Cliente
                    </button>
                </div>

                <div class="card">
                     <div class="table-responsive">
                         <table class="data-table">
                             <thead>
                                 <tr>
                                     <th>Nome</th>
                                     <th>Telefone</th>
                                     <th>Total Gasto</th>
                                     <th>Último Serviço</th>
                                     <th>Ações</th>
                                 </tr>
                             </thead>
                             <tbody id="lista-clientes">
                                 </tbody>
                         </table>
                     </div>
                </div>

            </section>

            <section id="servicos-section" class="content-section">
                <div class="section-header">
                    <h2>Cadastro de Serviços e Pacotes</h2>
                    <button class="btn-primary" onclick="abrirModalServico()">
                         <span class="material-icons">add</span> Novo Serviço/Pacote
                    </button>
                </div>

                <div class="card">
                    <div class="table-responsive">
                         <table class="data-table">
                             <thead>
                                 <tr>
                                     <th>Nome</th>
                                     <th>Tipo</th>
                                     <th>Preço (R$)</th>
                                     <th>Duração/Qtd. Usos</th>
                                     <th>Ações</th>
                                 </tr>
                             </thead>
                             <tbody id="lista-servicos">
                                 </tbody>
                         </table>
                    </div>
                </div>
            </section>
            
            <section id="historico-section" class="content-section">
                <div class="section-header">
                    <h2>Histórico de Lucros (Serviços Finalizados e Pagamento de Pacotes)</h2>
                </div>
                
                <div class="card">
                    <h3>Filtros</h3>
                    <div class="filter-row">
                        <div class="form-group" style="flex-grow: 2;">
                            <label for="filtro-historico-cliente">Buscar Cliente</label>
                            <input type="text" id="filtro-historico-cliente" list="clientes-datalist" oninput="filtrarHistoricoTabela()" placeholder="Digite o nome do cliente">
                        </div>
                        <div class="form-group">
                            <label for="filtro-historico-mes">Filtrar por Mês/Ano</label>
                            <input type="month" id="filtro-historico-mes" onchange="renderizarHistorico()">
                        </div>
                        <div>
                             <button class="btn-secondary" onclick="resetFiltroHistorico()"><span class="material-icons">filter_alt_off</span> Resetar Filtros</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                     <div class="table-responsive">
                         <table class="data-table">
                             <thead>
                                 <tr>
                                     <th>Tipo</th>
                                     <th>Cliente</th>
                                     <th>Descrição</th>
                                     <th>Data</th>
                                     <th>Valor (R$)</th>
                                     <th>Ações</th>
                                 </tr>
                             </thead>
                             <tbody id="lista-historico">
                                 </tbody>
                         </table>
                     </div>
                </div>
            </section>


        </main>
    </div>

    <div id="modalCliente" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="fecharModalCliente()">&times;</span>
            <h2>Detalhes do Cliente</h2>
            <form id="cliente-modal-form" onsubmit="salvarCliente(event)">
                <input type="hidden" id="clienteId">
                <div class="form-group">
                    <label for="clienteNome">Nome Completo</label>
                    <input type="text" id="clienteNome" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="clienteTelefone">Telefone</label>
                        <input type="tel" id="clienteTelefone">
                    </div>
                    <div class="form-group">
                        <label for="clienteEmail">E-mail</label>
                        <input type="email" id="clienteEmail">
                    </div>
                </div>
                <div class="form-group">
                    <label for="clienteObservacoes">Observações/Preferências</label>
                    <textarea id="clienteObservacoes" rows="3"></textarea>
                </div>
                <button type="submit" class="btn-primary"><span class="material-icons">save</span> Salvar Cliente</button>
                <button type="button" class="btn-danger" id="deletar-cliente-btn" onclick="deletarCliente()" style="margin-left: 10px; display: none;"><span class="material-icons">delete</span> Deletar Cliente</button>
            </form>
        </div>
    </div>

    <div id="modalServico" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="fecharModalServico()">&times;</span>
            <h2>Detalhes do Item</h2>
            <form id="servico-modal-form" onsubmit="salvarServico(event)">
                <input type="hidden" id="servicoId">
                <div class="form-group">
                    <label for="servicoTipo">Tipo</label>
                    <select id="servicoTipo" onchange="toggleServicoFields()" required>
                        <option value="servico">Serviço Individual</option>
                        <option value="pacote">Pacote de Serviços</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="servicoNome">Nome</label>
                    <input type="text" id="servicoNome" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="servicoPreco" id="label-preco">Preço (R$)</label>
                        <input type="number" id="servicoPreco" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="servicoDuracao" id="label-duracao">Duração (minutos)</label>
                        <input type="number" id="servicoDuracao" required>
                    </div>
                </div>
                <button type="submit" class="btn-primary"><span class="material-icons">save</span> Salvar Item</button>
                <button type="button" class="btn-danger" id="deletar-servico-btn" onclick="deletarServico()" style="margin-left: 10px; display: none;"><span class="material-icons">delete</span> Deletar Item</button>
            </form>
        </div>
    </div>
    
    <div id="modalPacoteAtivo" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="fecharModalPacoteAtivo()">&times;</span>
            <h2>Lançar Pacote para Cliente</h2>
            <form id="pacote-ativo-modal-form" onsubmit="salvarPacoteAtivo(event)">
                <input type="hidden" id="pacoteAtivoId">
                <div class="form-group">
                    <label for="pacoteAtivoCliente">Cliente</label>
                    <input type="text" id="pacoteAtivoCliente" list="clientes-datalist" placeholder="Nome do Cliente" required>
                </div>
                <div class="form-group">
                    <label for="pacoteAtivoServico">Pacote</label>
                    <select id="pacoteAtivoServico" required>
                        </select>
                </div>
                 <div class="form-row">
                    <div class="form-group">
                        <label for="pacoteAtivoValor">Valor Total (R$)</label>
                        <input type="number" id="pacoteAtivoValor" step="0.01" required readonly>
                        <small>Valor preenchido automaticamente pelo Pacote.</small>
                    </div>
                    <div class="form-group">
                        <label for="pacoteAtivoUsos">Usos Totais</label>
                        <input type="number" id="pacoteAtivoUsos" required readonly>
                         <small>Qtd. de usos preenchida automaticamente.</small>
                    </div>
                </div>
                <div class="form-group">
                    <label for="pacoteAtivoStatus">Status do Pagamento</label>
                    <select id="pacoteAtivoStatus" required>
                        <option value="Pendente">Pendente</option>
                        <option value="Pago">Pago</option>
                    </select>
                </div>
                <button type="submit" class="btn-primary"><span class="material-icons">save</span> Salvar Pacote Ativo</button>
                <button type="button" class="btn-danger" id="deletar-pacote-ativo-btn" onclick="deletarPacoteAtivo()" style="margin-left: 10px; display: none;"><span class="material-icons">delete</span> Deletar Pacote</button>
            </form>
        </div>
    </div>

    <div id="modalDetalhesAgendamento" class="modal">
         <div class="modal-content">
              <span class="close-button" onclick="fecharModalDetalhesAgendamento()">&times;</span>
              <h2>Detalhes do Agendamento</h2>
              <div id="detalhes-agendamento-corpo">
                  </div>
              <div style="margin-top: 20px;">
                   <button class="btn-success" id="finalizar-agendamento-btn" onclick="confirmarFinalizacaoAgendamento()"><span class="material-icons">done_all</span> Finalizar Serviço</button>
                   <button class="btn-warning" id="editar-agendamento-btn" onclick="editarAgendamentoParaModal()"><span class="material-icons">edit</span> Editar Agendamento</button>
                   <button class="btn-danger" id="cancelar-agendamento-btn" onclick="confirmarCancelamentoAgendamento()"><span class="material-icons">close</span> Cancelar Agendamento</button>
              </div>
         </div>
    </div>


    <script>
        // ----------------------------------------------------------------------------------
        // 1. CONFIGURAÇÃO DE SEGURANÇA E FIREBASE
        // ----------------------------------------------------------------------------------
        
        // CORREÇÃO: Variável de senha fixa (a senha padrão é "0810")
        const senhaAcesso = "0810"; // A senha está hardcoded aqui, mas você pode mudar
        
        // Configurações do Firebase - MANTIDAS INTACTAS
        const firebaseConfig = {
            apiKey: "AIzaSyCXgG-N9B55wY_N9E9j1Q8D3P4I2R1M0L9K",
            authDomain: "tati-manicure-app.firebaseapp.com",
            projectId: "tati-manicure-app",
            storageBucket: "tati-manicure-app.appspot.com",
            messagingSenderId: "987654321098",
            appId: "1:987654321098:web:abcdef1234567890"
        };
        
        // Inicialização do Firebase (MANTIDO)
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const database = firebase.database();
        
        
        // ----------------------------------------------------------------------------------
        // 2. FUNÇÕES DE CONTROLE DE TELA (MANTIDAS)
        // ----------------------------------------------------------------------------------

        window.showLogin = function() {
            document.getElementById('app-container').style.display = 'none';
            document.getElementById('login-container').style.display = 'flex';
        }
        
        window.showApp = function() {
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('app-container').style.display = 'flex';
            // Carrega os dados iniciais do app
            showSection('agenda-section');
        }

        // Função de Notificação (MANTIDA)
        window.showNotification = function(message, type) {
            const toast = document.getElementById('notification-bar'); 
            
            toast.className = `notification ${type}`;
            
            if (type === 'success') {
                toast.textContent = `✅ ${message}`;
            } else if (type === 'error') {
                toast.textContent = `❌ ${message}`;
            } else if (type === 'info') {
                toast.textContent = `ℹ️ ${message}`;
            } else {
                 toast.textContent = message;
            }

            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Função para trocar de seção (MANTIDA)
        window.showSection = function(sectionId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
            
            document.querySelectorAll('.sidebar ul li a').forEach(link => {
                 link.classList.remove('active');
            });
            const link = document.querySelector(`.sidebar ul li a[data-section="${sectionId.replace('-section', '')}"]`);
            if (link) {
                 link.classList.add('active');
            }

            // Lógica de carregamento de dados ao trocar de seção (mantida)
            if (sectionId === 'clientes-section') {
                renderizarClientes();
            } else if (sectionId === 'servicos-section') {
                renderizarServicos();
            } else if (sectionId === 'historico-section') {
                 renderizarHistorico();
            } else if (sectionId === 'pacotes-section') {
                 renderizarPacotesAtivos();
            } else if (sectionId === 'agenda-section') {
                showAgendaTab('diaria-tab'); 
                const dataSelecionada = document.getElementById('filtro-visao-diaria-data').value;
                carregarAgendamentos(dataSelecionada);
            }
        }
        
        // Função para trocar abas da agenda (MANTIDA)
        window.showAgendaTab = function(tabId) {
            document.querySelectorAll('.tab-pane').forEach(tab => {
                 tab.classList.remove('active');
            });
            document.getElementById(tabId).classList.add('active');

            document.querySelectorAll('.tab-menu button').forEach(button => {
                 button.classList.remove('active');
            });
            document.querySelector(`.tab-menu button[onclick="showAgendaTab('${tabId}')"]`).classList.add('active');

            // Lógica de recarregamento ao trocar a aba
            if (tabId === 'proximos-tab') {
                renderizarProximosAgendamentos();
            } else if (tabId === 'diaria-tab') {
                renderizarAgendamentosDiario();
            }
        }

        // ----------------------------------------------------------------------------------
        // 3. FUNÇÕES DE DADOS E VARIÁVEIS GLOBAIS (MANTIDAS)
        // ----------------------------------------------------------------------------------

        // Inicializa as listas
        let clientes = {};
        let servicos = {};
        let pacotesAtivos = {}; // NOVO: Para pacotes ativos
        let agendamentos = {}; 
        let historico = {};

        // Função unificada de carregamento
        window.carregarTodosOsDados = function() {
            carregarClientes();
            carregarServicos();
            carregarPacotesAtivos(); // NOVO: Carregar pacotes ativos
            carregarHistorico();
            
            // Carrega agendamentos para a data atual
            const dataSelecionada = document.getElementById('filtro-visao-diaria-data').value;
            carregarAgendamentos(dataSelecionada); 
        }

        // ----------------------------------------------------------------------------------
        // 3.1. UTILS (MANTIDAS E AJUSTADAS)
        // ----------------------------------------------------------------------------------

        // Mapear Cliente Nome para ID
        function getClienteIdByNome(nome) {
            for (const id in clientes) {
                if (clientes[id].nome === nome) {
                    return id;
                }
            }
            return null;
        }

        // Mapear Serviço ID para Objeto
        function getServicoById(id) {
            return servicos[id] || null;
        }
        
        // Formatar Data
        function formatDate(dateString) {
            if (!dateString) return '';
            const [year, month, day] = dateString.split('-');
            return `${day}/${month}/${year}`;
        }
        
        // Formatar Valor
        function formatValue(value) {
            return `R$ ${parseFloat(value).toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, ".")}`;
        }

        // ----------------------------------------------------------------------------------
        // 3.2. CLIENTES (FUNÇÕES MANTIDAS)
        // ----------------------------------------------------------------------------------

        window.carregarClientes = function() {
            database.ref('clientes').on('value', (snapshot) => {
                clientes = snapshot.val() || {};
                // Atualiza a datalist sempre que os clientes mudarem
                const datalist = document.getElementById('clientes-datalist');
                datalist.innerHTML = '';
                for (const id in clientes) {
                    const option = document.createElement('option');
                    option.value = clientes[id].nome;
                    datalist.appendChild(option);
                }
                if (document.getElementById('clientes-section').classList.contains('active')) {
                     renderizarClientes();
                }
            });
        }
        
        window.salvarCliente = function(e) {
            e.preventDefault();
            const id = document.getElementById('clienteId').value;
            const nome = document.getElementById('clienteNome').value.trim();
            const telefone = document.getElementById('clienteTelefone').value.trim();
            const email = document.getElementById('clienteEmail').value.trim();
            const observacoes = document.getElementById('clienteObservacoes').value.trim();
            
            if (!nome) {
                 showNotification('O nome do cliente é obrigatório.', 'error');
                 return;
            }

            const clienteData = { nome, telefone, email, observacoes };

            if (id) {
                database.ref('clientes/' + id).update(clienteData)
                    .then(() => {
                        showNotification('Cliente atualizado com sucesso!', 'success');
                        fecharModalCliente();
                    })
                    .catch(error => showNotification('Erro ao atualizar cliente: ' + error.message, 'error'));
            } else {
                database.ref('clientes').push(clienteData)
                    .then(() => {
                        showNotification('Cliente salvo com sucesso!', 'success');
                        fecharModalCliente();
                    })
                    .catch(error => showNotification('Erro ao salvar cliente: ' + error.message, 'error'));
            }
        }
        
        window.deletarCliente = function() {
            const id = document.getElementById('clienteId').value;
            if (confirm('Tem certeza que deseja deletar este cliente? Esta ação é irreversível.')) {
                database.ref('clientes/' + id).remove()
                    .then(() => {
                        showNotification('Cliente deletado com sucesso!', 'success');
                        fecharModalCliente();
                    })
                    .catch(error => showNotification('Erro ao deletar cliente: ' + error.message, 'error'));
            }
        }

        window.renderizarClientes = function() {
            const lista = document.getElementById('lista-clientes');
            lista.innerHTML = '';
            
            for (const id in clientes) {
                const cliente = clientes[id];
                
                // NOVO: Calcula último serviço e total gasto (simplificado)
                let ultimoServico = 'Nenhum';
                let totalGasto = 0;

                // Percorre o histórico para calcular
                for (const historicoId in historico) {
                    const item = historico[historicoId];
                    if (item.clienteId === id) {
                         // Se for pagamento de pacote, soma o valor total
                         if(item.tipo === 'pagamento-pacote' && item.valor) {
                             totalGasto += parseFloat(item.valor);
                         } 
                         // Se for serviço individual, soma o valor
                         else if (item.tipo === 'servico-individual' && item.valor) {
                              totalGasto += parseFloat(item.valor);
                         }

                         // Atualiza a data do último serviço
                         const dataHistorico = new Date(item.data + ' ' + item.hora);
                         if (ultimoServico === 'Nenhum' || dataHistorico > new Date(ultimoServico)) {
                             ultimoServico = item.data + ' ' + item.hora;
                         }
                    }
                }

                // Formata a data do último serviço
                let dataUltimoServico = 'Nenhum';
                if (ultimoServico !== 'Nenhum') {
                    const dataObj = new Date(ultimoServico);
                    dataUltimoServico = `${dataObj.toLocaleDateString()} ${dataObj.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
                }

                const row = lista.insertRow();
                row.dataset.clienteId = id; // Para facilitar a edição
                row.innerHTML = `
                    <td data-label="Nome">${cliente.nome}</td>
                    <td data-label="Telefone">${cliente.telefone || '-'}</td>
                    <td data-label="Total Gasto">${formatValue(totalGasto)}</td>
                    <td data-label="Último Serviço">${dataUltimoServico}</td>
                    <td data-label="Ações" class="action-buttons">
                        <button class="btn-warning" onclick="abrirModalCliente('${id}')"><span class="material-icons">edit</span> Editar</button>
                    </td>
                `;
            }
        }
        
        window.abrirModalCliente = function(id = null) {
            const modal = document.getElementById('modalCliente');
            const form = document.getElementById('cliente-modal-form');
            const deletarBtn = document.getElementById('deletar-cliente-btn');
            form.reset();
            document.getElementById('clienteId').value = id;

            if (id) {
                const cliente = clientes[id];
                document.getElementById('clienteNome').value = cliente.nome;
                document.getElementById('clienteTelefone').value = cliente.telefone || '';
                document.getElementById('clienteEmail').value = cliente.email || '';
                document.getElementById('clienteObservacoes').value = cliente.observacoes || '';
                deletarBtn.style.display = 'inline-flex';
            } else {
                deletarBtn.style.display = 'none';
            }
            modal.style.display = 'flex';
        }

        window.fecharModalCliente = function() {
            document.getElementById('modalCliente').style.display = 'none';
            document.getElementById('cliente-modal-form').reset();
        }

        // ----------------------------------------------------------------------------------
        // 3.3. SERVIÇOS/PACOTES (FUNÇÕES MANTIDAS E AJUSTADAS)
        // ----------------------------------------------------------------------------------

        window.carregarServicos = function() {
            database.ref('servicos').on('value', (snapshot) => {
                servicos = snapshot.val() || {};
                
                // Preenche o SELECT de agendamento de serviços individuais
                const selectServico = document.getElementById('agendamento-servico');
                selectServico.innerHTML = '';
                for (const id in servicos) {
                     if (servicos[id].tipo === 'servico') {
                         const option = document.createElement('option');
                         option.value = id;
                         option.textContent = `${servicos[id].nome} (${formatValue(servicos[id].preco)})`;
                         selectServico.appendChild(option);
                     }
                }

                // Preenche o SELECT de pacotes ativos
                const selectPacote = document.getElementById('pacoteAtivoServico');
                selectPacote.innerHTML = '<option value="" disabled selected>Selecione um Pacote</option>';
                for (const id in servicos) {
                     if (servicos[id].tipo === 'pacote') {
                         const option = document.createElement('option');
                         option.value = id;
                         option.textContent = `${servicos[id].nome} (${servicos[id].duracao} usos) - ${formatValue(servicos[id].preco)}`;
                         selectPacote.appendChild(option);
                     }
                }
                
                // Dispara o renderizador se a seção estiver ativa
                if (document.getElementById('servicos-section').classList.contains('active')) {
                    renderizarServicos();
                }
            });
        }

        // NOVO: Função para alternar campos no modal de serviço/pacote
        window.toggleServicoFields = function() {
            const tipo = document.getElementById('servicoTipo').value;
            const labelDuracao = document.getElementById('label-duracao');
            const inputDuracao = document.getElementById('servicoDuracao');

            if (tipo === 'servico') {
                labelDuracao.textContent = 'Duração (minutos)';
                inputDuracao.placeholder = 'Ex: 60';
            } else { // pacote
                labelDuracao.textContent = 'Quantidade de Usos';
                inputDuracao.placeholder = 'Ex: 5';
            }
        }
        
        window.salvarServico = function(e) {
            e.preventDefault();
            const id = document.getElementById('servicoId').value;
            const tipo = document.getElementById('servicoTipo').value;
            const nome = document.getElementById('servicoNome').value.trim();
            const preco = parseFloat(document.getElementById('servicoPreco').value);
            const duracao = parseInt(document.getElementById('servicoDuracao').value); // Pode ser duração (min) ou quantidade de usos

            if (!nome || isNaN(preco) || isNaN(duracao) || preco <= 0 || duracao <= 0) {
                 showNotification('Preencha todos os campos de forma válida.', 'error');
                 return;
            }

            const servicoData = { tipo, nome, preco, duracao };

            if (id) {
                database.ref('servicos/' + id).update(servicoData)
                    .then(() => {
                        showNotification('Item atualizado com sucesso!', 'success');
                        fecharModalServico();
                    })
                    .catch(error => showNotification('Erro ao atualizar item: ' + error.message, 'error'));
            } else {
                database.ref('servicos').push(servicoData)
                    .then(() => {
                        showNotification('Item salvo com sucesso!', 'success');
                        fecharModalServico();
                    })
                    .catch(error => showNotification('Erro ao salvar item: ' + error.message, 'error'));
            }
        }
        
        window.deletarServico = function() {
            const id = document.getElementById('servicoId').value;
            if (confirm('Tem certeza que deseja deletar este item? Esta ação é irreversível.')) {
                database.ref('servicos/' + id).remove()
                    .then(() => {
                        showNotification('Item deletado com sucesso!', 'success');
                        fecharModalServico();
                    })
                    .catch(error => showNotification('Erro ao deletar item: ' + error.message, 'error'));
            }
        }
        
        window.renderizarServicos = function() {
            const lista = document.getElementById('lista-servicos');
            lista.innerHTML = '';
            
            for (const id in servicos) {
                const servico = servicos[id];
                
                const tipoTexto = servico.tipo === 'servico' ? 'Serviço Individual' : 'Pacote';
                const duracaoTexto = servico.tipo === 'servico' ? `${servico.duracao} min` : `${servico.duracao} usos`;

                const row = lista.insertRow();
                row.dataset.servicoId = id;
                row.innerHTML = `
                    <td data-label="Nome">${servico.nome}</td>
                    <td data-label="Tipo">${tipoTexto}</td>
                    <td data-label="Preço">${formatValue(servico.preco)}</td>
                    <td data-label="Duração/Usos">${duracaoTexto}</td>
                    <td data-label="Ações" class="action-buttons">
                        <button class="btn-warning" onclick="abrirModalServico('${id}')"><span class="material-icons">edit</span> Editar</button>
                    </td>
                `;
            }
        }
        
        window.abrirModalServico = function(id = null) {
            const modal = document.getElementById('modalServico');
            const form = document.getElementById('servico-modal-form');
            const deletarBtn = document.getElementById('deletar-servico-btn');
            form.reset();
            document.getElementById('servicoId').value = id;
            document.getElementById('servicoTipo').disabled = !!id; // Não permite mudar o tipo se estiver editando

            if (id) {
                const servico = servicos[id];
                document.getElementById('servicoTipo').value = servico.tipo;
                document.getElementById('servicoNome').value = servico.nome;
                document.getElementById('servicoPreco').value = servico.preco;
                document.getElementById('servicoDuracao').value = servico.duracao;
                deletarBtn.style.display = 'inline-flex';
            } else {
                // Configura o valor padrão (serviço)
                document.getElementById('servicoTipo').value = 'servico';
                deletarBtn.style.display = 'none';
            }
            toggleServicoFields(); // Atualiza os rótulos
            modal.style.display = 'flex';
        }

        window.loadServicoDataToModal = function(id) {
            // Reutiliza a função abrirModalServico para carregar dados de um serviço no modal
            abrirModalServico(id);
        }

        window.fecharModalServico = function() {
            document.getElementById('modalServico').style.display = 'none';
            document.getElementById('servico-modal-form').reset();
            document.getElementById('servicoTipo').disabled = false; // Restaura a possibilidade de escolher o tipo
        }

        // ----------------------------------------------------------------------------------
        // 3.4. PACOTES ATIVOS (FUNÇÕES NOVAS)
        // ----------------------------------------------------------------------------------

        window.carregarPacotesAtivos = function() {
            database.ref('pacotesAtivos').on('value', (snapshot) => {
                pacotesAtivos = snapshot.val() || {};
                if (document.getElementById('pacotes-section').classList.contains('active')) {
                    renderizarPacotesAtivos();
                }
            });
        }
        
        // NOVO: Preenche automaticamente os campos de valor e usos
        document.getElementById('pacoteAtivoServico').addEventListener('change', function() {
            const pacoteId = this.value;
            const pacote = getServicoById(pacoteId);
            if (pacote) {
                 document.getElementById('pacoteAtivoValor').value = pacote.preco;
                 document.getElementById('pacoteAtivoUsos').value = pacote.duracao;
            } else {
                 document.getElementById('pacoteAtivoValor').value = '';
                 document.getElementById('pacoteAtivoUsos').value = '';
            }
        });
        
        window.salvarPacoteAtivo = function(e) {
            e.preventDefault();
            const id = document.getElementById('pacoteAtivoId').value;
            const clienteNome = document.getElementById('pacoteAtivoCliente').value.trim();
            const pacoteServicoId = document.getElementById('pacoteAtivoServico').value;
            const status = document.getElementById('pacoteAtivoStatus').value;
            
            const clienteId = getClienteIdByNome(clienteNome);
            const pacoteServico = getServicoById(pacoteServicoId);

            if (!clienteId || !pacoteServico) {
                 showNotification('Cliente ou Pacote não encontrados/selecionados.', 'error');
                 return;
            }
            
            const pacoteData = {
                clienteId: clienteId,
                clienteNome: clienteNome,
                pacoteServicoId: pacoteServicoId,
                pacoteNome: pacoteServico.nome,
                valorTotal: pacoteServico.preco,
                usosTotais: pacoteServico.duracao,
                usosRestantes: pacoteServico.duracao,
                status: status, // Pendente ou Pago
                dataLancamento: new Date().toISOString().slice(0, 10)
            };
            
            // Lógica para registrar no Histórico Lucros se for marcado como Pago no lançamento
            if (status === 'Pago' && !id) { // Só lança no histórico na primeira vez
                const historicoData = {
                     tipo: 'pagamento-pacote',
                     clienteId: clienteId,
                     clienteNome: clienteNome,
                     descricao: `Pagamento do Pacote: ${pacoteServico.nome}`,
                     data: pacoteData.dataLancamento,
                     hora: new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }),
                     valor: pacoteServico.preco,
                     pacoteAtivoId: id // Será atualizado com o ID gerado abaixo
                };
                // Salva no histórico. O ID do pacote será atualizado no 'then'.
                database.ref('historico').push(historicoData)
                    .then((historicoRef) => {
                        pacoteData.historicoPagamentoId = historicoRef.key;
                        // Continua salvando o pacote ativo
                        salvarPacoteEAtualizarHistorico(pacoteData, id, historicoRef.key);
                    })
                    .catch(error => showNotification('Erro ao salvar pagamento do pacote: ' + error.message, 'error'));
            } else {
                 // Salva o pacote ativo sem lançamento inicial no histórico (se for pendente ou edição)
                 salvarPacoteEAtualizarHistorico(pacoteData, id);
            }
        }

        // Função auxiliar para salvar Pacote e atualizar o histórico
        function salvarPacoteEAtualizarHistorico(pacoteData, id, historicoPagamentoId = null) {
             if (id) {
                database.ref('pacotesAtivos/' + id).update(pacoteData)
                    .then(() => {
                        showNotification('Pacote ativo atualizado com sucesso!', 'success');
                        fecharModalPacoteAtivo();
                    })
                    .catch(error => showNotification('Erro ao atualizar pacote ativo: ' + error.message, 'error'));
            } else {
                database.ref('pacotesAtivos').push(pacoteData)
                    .then((ref) => {
                        const newId = ref.key;
                        if (historicoPagamentoId) {
                            // Atualiza o histórico com o ID do pacote ativo recém-criado
                            database.ref('historico/' + historicoPagamentoId).update({ pacoteAtivoId: newId });
                        }
                        showNotification('Pacote ativo lançado com sucesso!', 'success');
                        fecharModalPacoteAtivo();
                    })
                    .catch(error => showNotification('Erro ao salvar pacote ativo: ' + error.message, 'error'));
            }
        }

        window.deletarPacoteAtivo = function() {
            const id = document.getElementById('pacoteAtivoId').value;
            const pacote = pacotesAtivos[id];
            
            if (pacote.usosRestantes < pacote.usosTotais) {
                 if (!confirm('Este pacote já foi parcialmente utilizado. Deletá-lo pode causar inconsistências no histórico. Deseja continuar?')) {
                     return;
                 }
            }

            if (confirm('Tem certeza que deseja deletar este pacote ativo? Esta ação é irreversível.')) {
                 // Se o pacote foi pago, tenta remover o lançamento de lucro do histórico também
                 if (pacote.historicoPagamentoId) {
                     database.ref('historico/' + pacote.historicoPagamentoId).remove();
                 }

                database.ref('pacotesAtivos/' + id).remove()
                    .then(() => {
                        showNotification('Pacote ativo deletado com sucesso!', 'success');
                        fecharModalPacoteAtivo();
                    })
                    .catch(error => showNotification('Erro ao deletar pacote ativo: ' + error.message, 'error'));
            }
        }

        // NOVO: Função para marcar um pacote ativo como pago (Melhoria Item 3)
        window.marcarPacotePago = function(pacoteAtivoId) {
            const pacote = pacotesAtivos[pacoteAtivoId];
            if (!pacote || pacote.status === 'Pago') {
                showNotification('O pacote já está pago.', 'info');
                return;
            }

            if (confirm(`Confirmar o pagamento do pacote ${pacote.pacoteNome} no valor de ${formatValue(pacote.valorTotal)}?`)) {
                
                // 1. Lança o valor no Histórico Lucros
                const historicoData = {
                     tipo: 'pagamento-pacote',
                     clienteId: pacote.clienteId,
                     clienteNome: pacote.clienteNome,
                     descricao: `Pagamento do Pacote: ${pacote.pacoteNome}`,
                     data: new Date().toISOString().slice(0, 10),
                     hora: new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }),
                     valor: pacote.valorTotal,
                     pacoteAtivoId: pacoteAtivoId
                };
                
                database.ref('historico').push(historicoData)
                    .then((historicoRef) => {
                        const historicoPagamentoId = historicoRef.key;

                        // 2. Atualiza o status do pacote
                        database.ref('pacotesAtivos/' + pacoteAtivoId).update({ 
                            status: 'Pago',
                            historicoPagamentoId: historicoPagamentoId // Salva a referência no pacote
                        })
                        .then(() => {
                            showNotification('Pagamento e lucro registrados com sucesso!', 'success');
                        })
                        .catch(error => showNotification('Erro ao atualizar status do pacote: ' + error.message, 'error'));

                    })
                    .catch(error => showNotification('Erro ao registrar pagamento no histórico: ' + error.message, 'error'));
            }
        }
        
        // NOVO: Função para agendar um serviço usando um pacote (Melhoria Item 3)
        window.agendarUsoDePacote = function(pacoteAtivoId, servicoPacoteId) {
             const pacote = pacotesAtivos[pacoteAtivoId];
             const servicoPacote = getServicoById(pacote.pacoteServicoId);

             if (pacote.usosRestantes <= 0) {
                 showNotification('Este pacote não tem mais usos restantes.', 'error');
                 return;
             }

             // Limpa e abre o formulário de agendamento, preenchendo com os dados do pacote
             resetFormAgendamento();

             // Preenche campos escondidos
             document.getElementById('agendamento-is-package').value = 'true';
             document.getElementById('agendamento-pacote-id').value = pacoteAtivoId;
             document.getElementById('agendamento-servico-pacote-id').value = servicoPacoteId;

             // Preenche campos visíveis
             document.getElementById('agendamento-cliente').value = pacote.clienteNome;
             document.getElementById('agendamento-cliente').disabled = true; // Não permite mudar o cliente
             document.getElementById('agendamento-data').value = new Date().toISOString().slice(0, 10);
             document.getElementById('agendamento-observacoes').value = `USO DE PACOTE: ${pacote.pacoteNome}`;
             
             // Seleciona o serviço associado (se houver) ou o primeiro serviço
             const selectServico = document.getElementById('agendamento-servico');
             for (let i = 0; i < selectServico.options.length; i++) {
                 // Por simplicidade, tenta selecionar o primeiro serviço do pacote
                 if (selectServico.options[i].value) {
                      selectServico.options[i].selected = true;
                      break; 
                 }
             }

             document.getElementById('btn-salvar-agendamento').innerHTML = '<span class="material-icons">save</span> Agendar Uso de Pacote (Valor R$0,00)';

             showSection('agenda-section');
             showNotification('Preencha a data e hora para agendar o uso do pacote.', 'info');
             // Rola para o formulário de agendamento
             document.getElementById('novo-agendamento-card').scrollIntoView({ behavior: 'smooth' });
        }


        window.renderizarPacotesAtivos = function() {
            const lista = document.getElementById('lista-pacotes-ativos');
            lista.innerHTML = '';
            
            for (const id in pacotesAtivos) {
                const pacote = pacotesAtivos[id];
                const pacoteInfo = getServicoById(pacote.pacoteServicoId);
                
                // Ignora pacotes finalizados (usos restantes = 0)
                if (pacote.usosRestantes <= 0) continue; 
                
                let statusClass = '';
                if (pacote.status === 'Pago') {
                    statusClass = 'status-package-paid';
                } else if (pacote.status === 'Pendente') {
                    statusClass = 'status-package-pending';
                }

                const row = lista.insertRow();
                row.dataset.pacoteId = id; 
                row.innerHTML = `
                    <td data-label="Cliente">${pacote.clienteNome}</td>
                    <td data-label="Pacote">${pacote.pacoteNome}</td>
                    <td data-label="Usos Restantes">${pacote.usosRestantes}/${pacote.usosTotais}</td>
                    <td data-label="Status" class="${statusClass}">${pacote.status}</td>
                    <td data-label="Ações" class="action-buttons">
                        <button class="btn-success" onclick="agendarUsoDePacote('${id}')"><span class="material-icons">event</span> Usar Pacote</button>
                        ${pacote.status === 'Pendente' ? 
                            `<button class="btn-primary" onclick="marcarPacotePago('${id}')"><span class="material-icons">payments</span> Marcar Pago</button>` : ''}
                        <button class="btn-warning" onclick="abrirModalPacoteAtivo('${id}')"><span class="material-icons">edit</span> Editar</button>
                    </td>
                `;
            }
        }
        
        window.abrirModalPacoteAtivo = function(id = null) {
            const modal = document.getElementById('modalPacoteAtivo');
            const form = document.getElementById('pacote-ativo-modal-form');
            const deletarBtn = document.getElementById('deletar-pacote-ativo-btn');
            const selectPacote = document.getElementById('pacoteAtivoServico');
            form.reset();
            document.getElementById('pacoteAtivoId').value = id;
            
            // Re-popula o select de pacotes, caso ainda não tenha carregado
            if (selectPacote.options.length <= 1) carregarServicos();

            if (id) {
                const pacote = pacotesAtivos[id];
                document.getElementById('pacoteAtivoCliente').value = pacote.clienteNome;
                document.getElementById('pacoteAtivoCliente').disabled = true;
                
                document.getElementById('pacoteAtivoServico').value = pacote.pacoteServicoId;
                document.getElementById('pacoteAtivoServico').disabled = true;
                
                document.getElementById('pacoteAtivoValor').value = pacote.valorTotal;
                document.getElementById('pacoteAtivoUsos').value = pacote.usosTotais;
                
                document.getElementById('pacoteAtivoStatus').value = pacote.status;
                
                deletarBtn.style.display = 'inline-flex';
            } else {
                document.getElementById('pacoteAtivoCliente').disabled = false;
                document.getElementById('pacoteAtivoServico').disabled = false;
                deletarBtn.style.display = 'none';
                document.getElementById('pacoteAtivoServico').value = ''; // Reseta para o placeholder
                document.getElementById('pacoteAtivoValor').value = '';
                document.getElementById('pacoteAtivoUsos').value = '';
            }
            modal.style.display = 'flex';
        }
        
        window.fecharModalPacoteAtivo = function() {
            document.getElementById('modalPacoteAtivo').style.display = 'none';
            document.getElementById('pacote-ativo-modal-form').reset();
            document.getElementById('pacoteAtivoCliente').disabled = false;
            document.getElementById('pacoteAtivoServico').disabled = false;
        }

        // ----------------------------------------------------------------------------------
        // 3.5. AGENDAMENTOS (FUNÇÕES MANTIDAS E AJUSTADAS)
        // ----------------------------------------------------------------------------------

        window.carregarAgendamentos = function(data) {
            // Busca apenas agendamentos a partir da data atual (para evitar carregar histórico antigo)
            database.ref('agendamentos').orderByChild('data').startAt(new Date().toISOString().slice(0, 10)).on('value', (snapshot) => {
                agendamentos = snapshot.val() || {};
                
                // Dispara o renderizador da visão diária e próximos agendamentos
                if (document.getElementById('diaria-tab').classList.contains('active')) {
                     renderizarAgendamentosDiario();
                }
                if (document.getElementById('proximos-tab').classList.contains('active')) {
                     renderizarProximosAgendamentos();
                }
            });
        }
        
        window.salvarAgendamento = function(e) {
            e.preventDefault();
            const id = document.getElementById('agendamentoId').value;
            const clienteNome = document.getElementById('agendamento-cliente').value.trim();
            const data = document.getElementById('agendamento-data').value;
            const hora = document.getElementById('agendamento-hora').value;
            const observacoes = document.getElementById('agendamento-observacoes').value.trim();
            
            // Campos de Pacote
            const isPackage = document.getElementById('agendamento-is-package').value === 'true';
            const pacoteId = document.getElementById('agendamento-pacote-id').value;
            const servicoPacoteId = document.getElementById('agendamento-servico-pacote-id').value;


            const clienteId = getClienteIdByNome(clienteNome);
            if (!clienteId) {
                 showNotification('Cliente não encontrado. Cadastre o cliente primeiro ou verifique o nome.', 'error');
                 return;
            }
            
            let servicosSelecionados = [];
            let servicosNome = [];
            let valorTotal = 0;
            let duracaoTotal = 0;

            if (isPackage) {
                 // Para pacote, o serviço é o do pacote (valor 0)
                 servicosSelecionados.push(servicoPacoteId);
                 servicosNome.push(`[PACOTE] - ${pacotesAtivos[pacoteId].pacoteNome}`);
                 valorTotal = 0;
                 duracaoTotal = 60; // Duração Padrão para uso de pacote (ajuste conforme necessário)
            } else {
                 // Para serviço individual
                 const selectServicos = document.getElementById('agendamento-servico');
                 for (const option of selectServicos.options) {
                      if (option.selected) {
                           servicosSelecionados.push(option.value);
                           const servico = getServicoById(option.value);
                           if (servico) {
                                servicosNome.push(servico.nome);
                                valorTotal += parseFloat(servico.preco);
                                duracaoTotal += parseInt(servico.duracao);
                           }
                      }
                 }
                 if (servicosSelecionados.length === 0) {
                      showNotification('Selecione pelo menos um serviço.', 'error');
                      return;
                 }
            }


            const agendamentoData = {
                clienteId,
                clienteNome,
                data,
                hora,
                servicosIds: servicosSelecionados,
                servicosNome: servicosNome.join(', '),
                valor: valorTotal,
                duracaoTotal,
                observacoes,
                isPackage: isPackage, // NOVO
                pacoteAtivoId: isPackage ? pacoteId : null, // NOVO
                status: 'Agendado',
                dataCriacao: id ? agendamentos[id].dataCriacao : new Date().toISOString()
            };

            // Determinar a hora final (para verificação de conflito)
            const [horaInicio, minutoInicio] = hora.split(':').map(Number);
            const dataHoraInicio = new Date(data);
            dataHoraInicio.setHours(horaInicio, minutoInicio, 0, 0);
            
            const dataHoraFim = new Date(dataHoraInicio.getTime() + duracaoTotal * 60000);
            const horaFim = `${String(dataHoraFim.getHours()).padStart(2, '0')}:${String(dataHoraFim.getMinutes()).padStart(2, '0')}`;

            agendamentoData.horaFim = horaFim;
            
            // Verificação de Conflito (Simplificada: verifica apenas a hora de início)
            for (const agId in agendamentos) {
                 if (agId !== id && agendamentos[agId].data === data && agendamentos[agId].status === 'Agendado') {
                      const agendamentoExistente = agendamentos[agId];
                      // Lógica de conflito mais robusta seria necessária, mas vamos manter a simplicidade por enquanto
                      const [existHoraInicio, existMinutoInicio] = agendamentoExistente.hora.split(':').map(Number);
                      const [existHoraFim, existMinutoFim] = agendamentoExistente.horaFim.split(':').map(Number);
                      
                      const inicio1 = dataHoraInicio.getTime();
                      const fim1 = dataHoraFim.getTime();
                      
                      const dataExistInicio = new Date(data);
                      dataExistInicio.setHours(existHoraInicio, existMinutoInicio, 0, 0);
                      const dataExistFim = new Date(data);
                      dataExistFim.setHours(existHoraFim, existMinutoFim, 0, 0);
                      
                      const inicio2 = dataExistInicio.getTime();
                      const fim2 = dataExistFim.getTime();
                      
                      // Verifica se os intervalos se sobrepõem
                      if (inicio1 < fim2 && inicio2 < fim1) {
                           showNotification(`Conflito de horário com agendamento de ${agendamentoExistente.clienteNome} das ${agendamentoExistente.hora} às ${agendamentoExistente.horaFim}.`, 'error');
                           return;
                      }
                 }
            }


            if (id) {
                database.ref('agendamentos/' + id).update(agendamentoData)
                    .then(() => {
                        showNotification('Agendamento atualizado com sucesso!', 'success');
                        resetFormAgendamento();
                        // Garante que a visão diária da data correta seja atualizada
                        carregarAgendamentos(data); 
                    })
                    .catch(error => showNotification('Erro ao atualizar agendamento: ' + error.message, 'error'));
            } else {
                database.ref('agendamentos').push(agendamentoData)
                    .then(() => {
                        showNotification('Agendamento salvo com sucesso!', 'success');
                        resetFormAgendamento();
                        // Garante que a visão diária da data correta seja atualizada
                        carregarAgendamentos(data); 
                    })
                    .catch(error => showNotification('Erro ao salvar agendamento: ' + error.message, 'error'));
            }
        }
        
        // NOVO: Limpa o formulário de agendamento e restaura o estado padrão
        window.resetFormAgendamento = function() {
            document.getElementById('agendamento-form').reset();
            document.getElementById('agendamentoId').value = '';
            document.getElementById('agendamento-cliente').disabled = false;
            document.getElementById('agendamento-is-package').value = 'false';
            document.getElementById('agendamento-pacote-id').value = '';
            document.getElementById('agendamento-servico-pacote-id').value = '';
            document.getElementById('btn-salvar-agendamento').innerHTML = '<span class="material-icons">save</span> Agendar Serviço';
            
            // Restaura o select de serviços
            const selectServico = document.getElementById('agendamento-servico');
            for (const option of selectServico.options) {
                 option.selected = false;
            }
             // Configura a data de hoje
            document.getElementById('agendamento-data').value = new Date().toISOString().slice(0, 10);
            
            showNotification('Formulário de Agendamento limpo.', 'info');
        }


        window.deletarAgendamento = function(id) {
            if (confirm('Tem certeza que deseja deletar este agendamento?')) {
                database.ref('agendamentos/' + id).remove()
                    .then(() => {
                        showNotification('Agendamento cancelado com sucesso!', 'success');
                        fecharModalDetalhesAgendamento();
                    })
                    .catch(error => showNotification('Erro ao cancelar agendamento: ' + error.message, 'error'));
            }
        }

        // NOVO: Renderiza todos os agendamentos futuros (Próximos Agendamentos - Aba)
        window.renderizarProximosAgendamentos = function() {
             const lista = document.getElementById('lista-proximos-agendamentos');
             lista.innerHTML = '';
             
             // Filtra apenas agendamentos futuros e ativos
             const hoje = new Date().toISOString().slice(0, 10);
             const agendamentosFuturos = Object.entries(agendamentos)
                 .filter(([id, ag]) => ag.data >= hoje && ag.status === 'Agendado')
                 .sort(([idA, a], [idB, b]) => {
                     const dataA = new Date(`${a.data}T${a.hora}`);
                     const dataB = new Date(`${b.data}T${b.hora}`);
                     return dataA - dataB;
                 });

             agendamentosFuturos.forEach(([id, ag]) => {
                  const row = lista.insertRow();
                  row.dataset.agendamentoId = id;
                  
                  const servicosNome = ag.isPackage ? ag.servicosNome : ag.servicosNome + ` (${formatValue(ag.valor)})`;

                  row.innerHTML = `
                      <td data-label="Cliente">${ag.clienteNome}</td>
                      <td data-label="Serviço(s)">${servicosNome}</td>
                      <td data-label="Data e Hora">${formatDate(ag.data)} às ${ag.hora} - ${ag.horaFim}</td>
                      <td data-label="Ações" class="action-buttons">
                          <button class="btn-primary" onclick="abrirModalDetalhesAgendamento('${id}')"><span class="material-icons">visibility</span> Ver Detalhes</button>
                          <button class="btn-danger" onclick="confirmarCancelamentoAgendamento('${id}')"><span class="material-icons">close</span> Cancelar</button>
                      </td>
                  `;
             });
        }


        // NOVO: Renderiza a visão diária (Melhoria Item 6 - Horários estendidos e Pacotes)
        window.renderizarAgendamentosDiario = function() {
            const lista = document.getElementById('lista-agendamentos-diarios');
            lista.innerHTML = '';
            const dataSelecionada = document.getElementById('filtro-visao-diaria-data').value;
            
            if (!dataSelecionada) return;

            // HORÁRIOS ESTENDIDOS: 07:00 até 22:00, de 30 em 30 minutos (Melhoria Item 6)
            for (let h = 7; h <= 21; h++) {
                for (let m = 0; m < 60; m += 30) {
                    const horaInicio = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                    const horaFimObj = new Date(0, 0, 0, h, m + 30); // Calcula 30 min depois
                    const horaFim = `${String(horaFimObj.getHours()).padStart(2, '0')}:${String(horaFimObj.getMinutes()).padStart(2, '0')}`;
                    
                    const row = lista.insertRow();
                    const horarioCompleto = `${horaInicio}-${horaFim}`;
                    
                    const agendamentosNoSlot = Object.entries(agendamentos)
                        .filter(([id, ag]) => ag.data === dataSelecionada && ag.status === 'Agendado')
                        .filter(([id, ag]) => {
                            // Verifica se o agendamento se sobrepõe ao slot
                            const slotInicio = new Date(`${dataSelecionada}T${horaInicio}`);
                            const slotFim = new Date(`${dataSelecionada}T${horaFim}`);
                            const agendamentoInicio = new Date(`${ag.data}T${ag.hora}`);
                            const agendamentoFim = new Date(`${ag.data}T${ag.horaFim}`);
                            
                            // Sobrposição: (AgendamentoInício < SlotFim) AND (SlotInício < AgendamentoFim)
                            return agendamentoInicio < slotFim && slotInicio < agendamentoFim;
                        });

                    let agendamentosHtml = '';
                    let isSlotOccupied = false;

                    agendamentosNoSlot.forEach(([id, ag]) => {
                        // Se o início do agendamento for exatamente no início do slot
                        if (ag.hora === horaInicio) {
                            const isPackageClass = ag.isPackage ? 'package' : '';
                            agendamentosHtml += `
                                <div class="agendamento-ocupado ${isPackageClass}" onclick="abrirModalDetalhesAgendamento('${id}')">
                                    <strong>${ag.clienteNome}</strong> - ${ag.servicosNome}
                                    <br> <small>Das ${ag.hora} às ${ag.horaFim}</small>
                                </div>
                            `;
                            isSlotOccupied = true;
                        }
                    });
                    
                    if (isSlotOccupied) {
                         // Se for ocupado, exibe os agendamentos
                         row.innerHTML = `
                             <td class="horario-celula">${horaInicio}</td>
                             <td>${agendamentosHtml}</td>
                         `;
                    } else {
                         // Se estiver livre, permite clicar para agendar no slot
                         row.innerHTML = `
                             <td class="horario-celula">${horaInicio}</td>
                             <td class="agendamento-vago" onclick="preencherAgendamentoRapido('${dataSelecionada}', '${horaInicio}')">LIVRE</td>
                         `;
                    }
                }
            }
        }
        
        // NOVO: Preenche o formulário de agendamento com data e hora para agendamento rápido
        window.preencherAgendamentoRapido = function(data, hora) {
            resetFormAgendamento(); // Garante que o formulário está limpo
            document.getElementById('agendamento-data').value = data;
            document.getElementById('agendamento-hora').value = hora;
            
            showNotification(`Agendamento rápido: ${formatDate(data)} às ${hora}`, 'info');
             // Rola para o formulário de agendamento
            document.getElementById('novo-agendamento-card').scrollIntoView({ behavior: 'smooth' });
        }


        // Funções de Modal Detalhes Agendamento (MANTIDAS E AJUSTADAS)
        window.abrirModalDetalhesAgendamento = function(id) {
            const ag = agendamentos[id];
            if (!ag) return;
            
            document.getElementById('modalDetalhesAgendamento').dataset.agendamentoId = id;

            const valorTexto = ag.isPackage ? 'USO DE PACOTE (R$ 0,00)' : formatValue(ag.valor);
            const isPackageInfo = ag.isPackage ? `<p><strong>Tipo:</strong> <span class="status-package-active">USO DE PACOTE (${pacotesAtivos[ag.pacoteAtivoId].pacoteNome})</span></p>` : `<p><strong>Tipo:</strong> Serviço Individual</p>`;

            document.getElementById('detalhes-agendamento-corpo').innerHTML = `
                ${isPackageInfo}
                <p><strong>Cliente:</strong> ${ag.clienteNome}</p>
                <p><strong>Serviço(s):</strong> ${ag.servicosNome}</p>
                <p><strong>Data:</strong> ${formatDate(ag.data)}</p>
                <p><strong>Hora:</strong> ${ag.hora} até ${ag.horaFim} (${ag.duracaoTotal} min)</p>
                <p><strong>Valor:</strong> ${valorTexto}</p>
                <p><strong>Observações:</strong> ${ag.observacoes || '-'}</p>
            `;
            
            document.getElementById('finalizar-agendamento-btn').style.display = (ag.status === 'Agendado' ? 'inline-flex' : 'none');
            document.getElementById('editar-agendamento-btn').style.display = (ag.status === 'Agendado' ? 'inline-flex' : 'none');
            document.getElementById('cancelar-agendamento-btn').style.display = (ag.status === 'Agendado' ? 'inline-flex' : 'none');

            document.getElementById('modalDetalhesAgendamento').style.display = 'flex';
        }
        
        window.fecharModalDetalhesAgendamento = function() {
            document.getElementById('modalDetalhesAgendamento').style.display = 'none';
            document.getElementById('modalDetalhesAgendamento').dataset.agendamentoId = '';
        }
        
        window.editarAgendamentoParaModal = function() {
             const id = document.getElementById('modalDetalhesAgendamento').dataset.agendamentoId;
             const ag = agendamentos[id];
             if (!ag) return;
             
             fecharModalDetalhesAgendamento();

             // 1. Limpa e preenche o formulário
             resetFormAgendamento();
             document.getElementById('agendamentoId').value = id;

             // 2. Preenche campos
             document.getElementById('agendamento-cliente').value = ag.clienteNome;
             document.getElementById('agendamento-data').value = ag.data;
             document.getElementById('agendamento-hora').value = ag.hora;
             document.getElementById('agendamento-observacoes').value = ag.observacoes;
             
             // 3. Preenche campos de Pacote (Se for edição de pacote)
             if (ag.isPackage) {
                  document.getElementById('agendamento-is-package').value = 'true';
                  document.getElementById('agendamento-pacote-id').value = ag.pacoteAtivoId;
                  document.getElementById('agendamento-cliente').disabled = true; // Mantém desativado
                  document.getElementById('btn-salvar-agendamento').innerHTML = '<span class="material-icons">save</span> Salvar Uso de Pacote (Valor R$0,00)';
             } else {
                  // 4. Seleciona os serviços
                  const selectServicos = document.getElementById('agendamento-servico');
                  for (const option of selectServicos.options) {
                       option.selected = ag.servicosIds.includes(option.value);
                  }
             }
             
             showNotification(`Editando agendamento de ${ag.clienteNome}.`, 'info');
             // Rola para o formulário de agendamento
             document.getElementById('novo-agendamento-card').scrollIntoView({ behavior: 'smooth' });
        }


        window.confirmarCancelamentoAgendamento = function(id = null) {
            const agendamentoId = id || document.getElementById('modalDetalhesAgendamento').dataset.agendamentoId;
            if (agendamentoId) {
                 if (confirm('Tem certeza que deseja cancelar este agendamento?')) {
                      cancelarAgendamento(agendamentoId);
                 }
            }
        }

        window.cancelarAgendamento = function(id) {
            database.ref('agendamentos/' + id).update({ status: 'Cancelado' })
                .then(() => {
                    showNotification('Agendamento cancelado e marcado como inativo.', 'info');
                    fecharModalDetalhesAgendamento();
                })
                .catch(error => showNotification('Erro ao cancelar agendamento: ' + error.message, 'error'));
        }

        window.confirmarFinalizacaoAgendamento = function() {
            const id = document.getElementById('modalDetalhesAgendamento').dataset.agendamentoId;
            if (id) {
                 if (confirm('Confirmar a finalização deste serviço e lançamento no histórico de lucros?')) {
                      finalizarAgendamento(id);
                 }
            }
        }
        
        // CORRIGIDO/AJUSTADO: Função de finalização para lidar com Pacotes (Melhoria Item 3 e 4)
        window.finalizarAgendamento = function(id) {
            const ag = agendamentos[id];
            if (!ag) return;

            // 1. Lança no histórico
            const historicoData = {
                 tipo: ag.isPackage ? 'uso-pacote' : 'servico-individual', // NOVO: Diferenciação de tipo
                 clienteId: ag.clienteId,
                 clienteNome: ag.clienteNome,
                 descricao: ag.isPackage ? `Uso de Pacote: ${pacotesAtivos[ag.pacoteAtivoId].pacoteNome} - ${ag.servicosNome}` : ag.servicosNome,
                 data: new Date().toISOString().slice(0, 10), // Data de finalização (hoje)
                 hora: new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }),
                 valor: ag.isPackage ? 0 : ag.valor, // NOVO: Valor zero se for uso de pacote
                 agendamentoId: id,
                 pacoteAtivoId: ag.pacoteAtivoId || null // NOVO: ID do pacote se for uso
            };

            database.ref('historico').push(historicoData)
                .then(() => {
                    // 2. Atualiza o status do agendamento para Finalizado
                    database.ref('agendamentos/' + id).update({ status: 'Finalizado' })
                        .then(() => {
                            showNotification('Serviço finalizado e lucro/uso registrado!', 'success');
                            fecharModalDetalhesAgendamento();
                            
                            // 3. Lógica específica para Pacotes Ativos (Decremento de uso)
                            if (ag.isPackage && ag.pacoteAtivoId) {
                                const pacote = pacotesAtivos[ag.pacoteAtivoId];
                                if (pacote && pacote.usosRestantes > 0) {
                                    database.ref('pacotesAtivos/' + ag.pacoteAtivoId).update({
                                        usosRestantes: pacote.usosRestantes - 1
                                    })
                                    .then(() => {
                                         showNotification('Uso de pacote debitado com sucesso.', 'info');
                                    });
                                }
                            }
                        });
                })
                .catch(error => showNotification('Erro ao finalizar agendamento: ' + error.message, 'error'));
        }

        // ----------------------------------------------------------------------------------
        // 3.6. HISTÓRICO (FUNÇÕES MANTIDAS E AJUSTADAS)
        // ----------------------------------------------------------------------------------

        window.carregarHistorico = function() {
            database.ref('historico').on('value', (snapshot) => {
                historico = snapshot.val() || {};
                if (document.getElementById('historico-section').classList.contains('active')) {
                     renderizarHistorico();
                }
            });
        }

        window.renderizarHistorico = function() {
            const lista = document.getElementById('lista-historico');
            lista.innerHTML = '';
            
            // Obtém o filtro de mês/ano
            const filtroMesAno = document.getElementById('filtro-historico-mes').value;
            
            // Converte o objeto histórico em array e ordena pela data/hora (mais recente primeiro)
            const historicoArray = Object.entries(historico)
                 .sort(([idA, a], [idB, b]) => {
                     const dataHoraA = new Date(`${a.data}T${a.hora}`);
                     const dataHoraB = new Date(`${b.data}T${b.hora}`);
                     return dataHoraB - dataHoraA; // Decrescente
                 });

            historicoArray.forEach(([id, item]) => {
                 
                 // Filtra por Mês/Ano (se aplicável)
                 if (filtroMesAno && !item.data.startsWith(filtroMesAno)) {
                      return;
                 }
                 
                 // NOVO: Renderiza o tipo
                 let tipoTexto = '';
                 let tipoClasse = 'btn-secondary';

                 if (item.tipo === 'servico-individual') {
                      tipoTexto = 'Serviço';
                      tipoClasse = 'btn-primary';
                 } else if (item.tipo === 'uso-pacote') {
                       tipoTexto = 'Uso Pacote';
                       tipoClasse = 'btn-info';
                 } else if (item.tipo === 'pagamento-pacote') {
                       tipoTexto = 'Pagamento Pacote';
                       tipoClasse = 'btn-success';
                 }

                 // Ignora lançamentos de valor zero (uso de pacote) se o usuário quiser focar só em lucro
                 // Mas, por agora, vamos mostrar todos para dar o contexto completo.

                const row = lista.insertRow();
                row.dataset.historicoId = id;
                row.dataset.clienteNome = item.clienteNome.toLowerCase();
                
                // NOVO: Ação de Reverter (Apenas para serviços e pacotes que geraram lucro)
                let acoesHtml = '';
                if (item.tipo === 'servico-individual' || item.tipo === 'pagamento-pacote') {
                     // Adiciona a ação de reversão para itens que representam lucro
                     acoesHtml = `<button class="btn-danger" onclick="reverterLancamento('${id}')"><span class="material-icons">undo</span> Reverter</button>`;
                } else if (item.tipo === 'uso-pacote' && item.pacoteAtivoId) {
                     // Adiciona a ação de reverter uso de pacote (restaura o uso)
                     acoesHtml = `<button class="btn-warning" onclick="reverterUsoPacote('${id}')"><span class="material-icons">undo</span> Reverter Uso</button>`;
                }

                row.innerHTML = `
                    <td data-label="Tipo"><span class="btn ${tipoClasse}" style="padding: 5px 10px; font-size: 0.8rem; pointer-events: none;">${tipoTexto}</span></td>
                    <td data-label="Cliente">${item.clienteNome}</td>
                    <td data-label="Descrição">${item.descricao}</td>
                    <td data-label="Data">${formatDate(item.data)} - ${item.hora}</td>
                    <td data-label="Valor">${formatValue(item.valor)}</td>
                    <td data-label="Ações" class="action-buttons">${acoesHtml}</td>
                `;
            });
            
             // Aplica o filtro de cliente, caso tenha algum texto no campo
            filtrarHistoricoTabela();
        }

        // NOVO: Reverte uso de pacote (Melhoria Item 3)
        window.reverterUsoPacote = function(id) {
            const item = historico[id];
            if (!item || item.tipo !== 'uso-pacote') return;
            
            if (confirm('Reverter este uso de pacote? Isso irá deletar o lançamento e restaurar um uso no pacote ativo.')) {
                
                // 1. Deleta a entrada do histórico
                database.ref('historico/' + id).remove()
                     .then(() => {
                         // 2. Restaura o uso no pacote ativo
                         if (item.pacoteAtivoId) {
                             const pacote = pacotesAtivos[item.pacoteAtivoId];
                             if (pacote) {
                                 database.ref('pacotesAtivos/' + item.pacoteAtivoId).update({
                                     usosRestantes: pacote.usosRestantes + 1
                                 })
                                 .then(() => {
                                      showNotification('Uso de pacote revertido com sucesso e uso restaurado.', 'success');
                                 });
                             }
                         }
                         
                         // 3. Se houver agendamento associado, marca como Agendado novamente
                         if (item.agendamentoId) {
                              database.ref('agendamentos/' + item.agendamentoId).update({ status: 'Agendado' });
                         }
                     })
                     .catch(error => showNotification('Erro ao reverter uso de pacote: ' + error.message, 'error'));
            }
        }


        // CORRIGIDO/AJUSTADO: Função de Reversão de Lucro (Agora lida com pagamento de pacote)
        window.reverterLancamento = function(id) {
             const item = historico[id];
             if (!item) return;

             if (item.tipo === 'servico-individual') {
                 if (confirm('Reverter este lançamento de Serviço Individual? Isso irá deletar o lucro e reativar o agendamento.')) {
                     // 1. Remove do histórico
                     database.ref('historico/' + id).remove()
                         .then(() => {
                             // 2. Reativa o agendamento
                             if (item.agendamentoId) {
                                  database.ref('agendamentos/' + item.agendamentoId).update({ status: 'Agendado' });
                             }
                             showNotification('Lançamento revertido com sucesso. Agendamento reativado.', 'success');
                         })
                         .catch(error => showNotification('Erro ao reverter: ' + error.message, 'error'));
                 }
             } else if (item.tipo === 'pagamento-pacote') {
                  if (confirm('Reverter este lançamento de Pagamento de Pacote? Isso irá deletar o lucro e marcar o pacote como Pendente novamente.')) {
                      
                      // 1. Remove do histórico
                       database.ref('historico/' + id).remove()
                           .then(() => {
                               // 2. Marca o Pacote Ativo como Pendente
                               if (item.pacoteAtivoId) {
                                    database.ref('pacotesAtivos/' + item.pacoteAtivoId).update({ 
                                        status: 'Pendente',
                                        historicoPagamentoId: null 
                                    });
                               }
                               showNotification('Pagamento de pacote revertido com sucesso.', 'success');
                           })
                           .catch(error => showNotification('Erro ao reverter pagamento de pacote: ' + error.message, 'error'));
                  }
             }
        }
        
        // 6.2. FILTRAR HISTÓRICO NA TABELA (MANTIDA)
        window.filtrarHistoricoTabela = function() {
             const filtro = document.getElementById('filtro-historico-cliente').value.toLowerCase();
             const listaHistorico = document.getElementById('lista-historico');
             const linhas = listaHistorico.getElementsByTagName('tr');

             for (let i = 0; i < linhas.length; i++) {
                 const row = linhas[i];
                 if (!row.dataset.clienteNome) continue; 

                 const clienteNome = row.dataset.clienteNome;
                
                 if (clienteNome.includes(filtro)) {
                     row.style.display = ""; // Usa "" para restaurar o display padrão
                 } else {
                     row.style.display = "none";
                 }
             }
        }
        
        // 6.3. RESETAR FILTRO DO HISTÓRICO (MANTIDA)
        window.resetFiltroHistorico = function() {
            document.getElementById('filtro-historico-mes').value = ''; 
            document.getElementById('filtro-historico-cliente').value = '';
            renderizarHistorico();
        }
        
        // ----------------------------------------------------------------------------------
        // INICIALIZAÇÃO E EVENTOS
        // ----------------------------------------------------------------------------------
        document.addEventListener('DOMContentLoaded', () => {
             // Mostra a tela de login ao carregar a página
            showLogin();
            
            // Configura a data de hoje para os inputs de data
            const today = new Date().toISOString().slice(0, 10);
            document.getElementById('filtro-visao-diaria-data').value = today;
            document.getElementById('agendamento-data').value = today;


            // CORREÇÃO ESSENCIAL: Movendo os listeners de login/logout para dentro de DOMContentLoaded
            // para garantir que o formulário e o botão existam antes de tentar adicionar o evento.
            document.getElementById('login-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const senha = document.getElementById('loginSenha').value;
                
                if (senha === senhaAcesso) {
                     showApp();
                     showNotification('Login realizado com sucesso!', 'success'); // Notificação restaurada
                     carregarTodosOsDados();
                } else {
                     showNotification('Senha incorreta. Tente novamente.', 'error'); // Notificação restaurada
                }
            });

            document.getElementById('logout-button').addEventListener('click', () => {
                showLogin();
                showNotification('Sessão encerrada.', 'info');
            });

            
        });
    </script>
</body>
</html>
