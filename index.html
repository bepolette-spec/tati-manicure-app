<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tati Manicure - Gerenciamento de Agendamentos</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #ff8c6b; /* Cor de Destaque (Salmão/Coral) */
            --secondary-color: #6c757d; /* Cinza para secundários */
            --background-color: #f4f7f6; /* Fundo Suave */
            --sidebar-bg: #ffffff;
            --sidebar-hover-bg: #fff0eb; /* Fundo mais claro para hover */
            --text-color: #343a40; /* Texto Principal (Escuro) */
            --success-color: #28a745;
            --info-color: #17a2b8;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --border-color: #e9ecef;
            --shadow-color: rgba(0, 0, 0, 0.05);
        }

        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            min-height: 100vh;
        }

        /* Estrutura do App */
        #login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            background-color: var(--primary-color);
            min-height: 100vh;
        }

        .login-card {
            background: var(--sidebar-bg);
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 15px var(--shadow-color);
            text-align: center;
            width: 100%;
            max-width: 400px;
        }

        .login-card h1 {
            color: var(--primary-color);
            margin-bottom: 30px;
            font-size: 1.8rem;
        }

        #app-container {
            display: none; /* Escondido por padrão, mostrado após o login */
            width: 100%;
            display: flex;
        }

        /* Barra Lateral (Sidebar) */
        .sidebar {
            width: 250px;
            background-color: var(--sidebar-bg);
            box-shadow: 2px 0 5px var(--shadow-color);
            display: flex;
            flex-direction: column;
            padding: 20px 0;
            flex-shrink: 0;
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
            color: var(--primary-color);
            font-size: 1.6rem;
            font-weight: bold;
        }

        .sidebar ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar ul li a {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            text-decoration: none;
            color: var(--text-color);
            transition: background-color 0.2s, color 0.2s;
            font-weight: 500;
        }

        .sidebar ul li a:hover,
        .sidebar ul li a.active {
            background-color: var(--sidebar-hover-bg);
            color: var(--primary-color);
        }

        .sidebar ul li a .material-icons {
            margin-right: 10px;
            font-size: 20px;
        }

        .user-info {
            margin-top: auto;
            padding: 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .user-info p {
            margin: 0 0 10px 0;
            font-weight: bold;
        }

        /* Conteúdo Principal */
        .main-content {
            flex-grow: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .content-section {
            display: none;
            padding: 20px;
        }

        .content-section.active {
            display: block;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .section-header h2 {
            margin: 0;
            color: var(--text-color);
            font-size: 1.5rem;
        }
        
        /* Nova cor para Status de Pacote */
        .status-package-active {
            color: var(--primary-color); 
            font-weight: bold;
        }
        .status-package-finalized {
            color: var(--danger-color); 
            font-weight: bold;
        }

        /* Cartão (Card) */
        .card {
            background: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 4px var(--shadow-color);
            margin-bottom: 20px;
        }

        /* Formulários */
        .form-group {
            margin-bottom: 15px;
        }

        .form-row {
            display: flex;
            gap: 20px;
        }

        .form-row > div {
            flex: 1;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 0.95rem;
        }

        input[type="text"],
        input[type="number"],
        input[type="email"],
        input[type="tel"],
        input[type="date"],
        input[type="time"],
        textarea,
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="email"]:focus,
        input[type="tel"]:focus,
        input[type="date"]:focus,
        input[type="time"]:focus,
        textarea:focus,
        select:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        textarea {
            resize: vertical;
        }

        /* Botões */
        button, .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: background-color 0.2s, opacity 0.2s;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #e57a5e;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #218838;
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        /* Tabelas */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table thead tr {
            background-color: var(--primary-color);
            color: white;
            text-align: left;
        }

        .data-table th, .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table tbody tr:hover {
            background-color: var(--sidebar-hover-bg);
        }

        .data-table td.action-buttons button {
            margin-right: 5px;
            padding: 6px 8px;
        }

        .data-table td.action-buttons {
            white-space: nowrap;
        }

        /* Notificação */
        #notification-bar {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s, transform 0.3s;
            transform: translateY(-20px);
            z-index: 1000;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            font-weight: bold;
        }

        #notification-bar.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        #notification-bar.success { background-color: var(--success-color); }
        #notification-bar.error { background-color: var(--danger-color); }
        #notification-bar.info { background-color: var(--info-color); }

        /* Utilitários */
        .flex-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .input-group {
            display: flex;
            gap: 10px;
        }
        
        .input-group input, .input-group select {
            flex-grow: 1;
        }

        .filter-row {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            margin-bottom: 20px;
        }
        .filter-row > div {
            flex: 1;
        }
        .filter-row button {
            flex-grow: 0;
            flex-shrink: 0;
            padding: 9px 15px; /* Ajuste para alinhar com o input */
        }
        
        /* --------------------------------------------------- */
        /* RESPONSIVIDADE MOBILE (Mobile First - Portrait Mode)*/
        /* --------------------------------------------------- */
        @media (max-width: 768px) {
            
            /* Estrutura Principal */
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
                box-shadow: 0 0 5px var(--shadow-color);
            }

            .main-content {
                padding: 15px;
            }

            #app-container {
                flex-direction: column;
            }

            /* Navegação Horizontal */
            .sidebar ul {
                display: flex;
                flex-wrap: nowrap; /* Tenta manter em uma linha, mas permite rolagem */
                overflow-x: auto;
                justify-content: flex-start;
                border-bottom: 1px solid var(--border-color);
            }

            .sidebar ul li {
                flex-shrink: 0; /* Impede que os itens encolham */
                text-align: center;
            }

            .sidebar ul li a {
                justify-content: center;
                padding: 10px;
                flex-direction: column;
                font-size: 0.75rem;
                white-space: nowrap;
            }

            .sidebar ul li a .material-icons {
                margin-right: 0;
                margin-bottom: 5px;
                font-size: 20px;
            }

            /* FIX: Botão Sair visível no celular */
            .user-info {
                display: block; 
                padding: 10px 15px;
                border-top: none; 
                text-align: center; 
            }

            .user-info p {
                display: none; /* Esconde o texto "Olá, Tati!" para economizar espaço */
            }

            .user-info button {
                width: 100%;
                margin-top: 10px; 
                font-size: 0.9rem;
            }
            
            /* 1. Correção de Formulários e Filtros (Empilhamento) */
            .form-row, .filter-row {
                flex-direction: column;
                gap: 0; /* Remove gap quando empilha */
            }

            .form-row > div, 
            .filter-row > div {
                flex: 0 0 100% !important; /* Força largura total */
                width: 100%;
            }
            
            /* Ajusta margem para inputs empilhados */
            .form-group, .filter-row > div {
                margin-bottom: 10px;
            }
            
            .filter-row button {
                width: 100%;
                margin-top: 5px; 
                padding: 10px 15px !important;
            }
            
            /* 2. Correção de Tabelas (Cartão-like View) */
            .data-table, .data-table tbody, .data-table td, .data-table tr {
                display: block; /* Força elementos da tabela a empilhar */
            }

            .data-table thead {
                display: none; /* Esconde o cabeçalho original */
            }

            .data-table tr {
                border: 1px solid var(--border-color);
                margin-bottom: 15px;
                border-radius: 8px;
                box-shadow: 0 1px 3px var(--shadow-color);
                padding: 10px;
            }

            .data-table td {
                border: none;
                position: relative;
                padding-left: 50% !important; /* Espaço para o rótulo */
                text-align: right; /* Alinha o valor à direita */
                white-space: normal; /* Permite quebras de linha */
                min-height: 40px; 
            }

            /* Rótulo customizado (que usa o data-label do JS) */
            .data-table td::before {
                content: attr(data-label);
                position: absolute;
                left: 10px;
                width: 45%; 
                padding-right: 10px;
                white-space: nowrap;
                text-align: left;
                font-weight: bold;
                color: var(--primary-color);
            }
            
            .data-table td.action-buttons {
                text-align: left;
                padding-left: 10px !important;
            }
            
            .data-table td.action-buttons::before {
                content: "Ações";
            }
            
            .data-table td.action-buttons button {
                margin-top: 5px;
                width: calc(50% - 5px); /* Divide o espaço para os botões */
                box-sizing: border-box;
            }
        }
    </style>
</head>
<body>

    <div id="notification-bar"></div>

    <div id="login-container">
        <div class="login-card">
            <h1>Tati Manicure - Acesso</h1>
            <form id="login-form">
                <div class="form-group">
                    <label for="loginSenha">Senha de Acesso</label>
                    <input type="password" id="loginSenha" required>
                </div>
                <button type="submit" class="btn-primary" style="width: 100%; margin-top: 10px;">
                    <span class="material-icons">login</span> Entrar
                </button>
            </form>
        </div>
    </div>

    <div id="app-container">
        
        <aside class="sidebar">
            <div class="logo">TATI MANICURE APP</div>
            
            <ul>
                <li><a href="#" data-section="agenda" class="active"><span class="material-icons">calendar_today</span> Agenda</a></li>
                <li><a href="#" data-section="clientes"><span class="material-icons">people</span> Clientes</a></li>
                <li><a href="#" data-section="servicos"><span class="material-icons">local_offer</span> Serviços</a></li>
                <li><a href="#" data-section="historico"><span class="material-icons">history</span> Histórico/Lucros</a></li>
            </ul>

            <div class="user-info">
                <p id="userInfo">Olá, Tati!</p>
                <button id="logout-button" class="btn-danger" style="width: 100%;">
                    <span class="material-icons">logout</span> Sair
                </button>
            </div>
        </aside>

        <main class="main-content">

            <div id="agenda-section" class="content-section active">
                
                <div class="section-header"><h2>Gerenciamento de Pacotes Ativos</h2></div>
                <div class="card">
                    <form id="pacote-inicio-form">
                        <h3>Iniciar Novo Pacote de Serviços</h3>
                        <div class="form-row">
                            <div class="form-group" style="flex: 2;">
                                <label for="pacote-cliente-id">Cliente</label>
                                <select id="pacote-cliente-id" required></select>
                            </div>
                            <div class="form-group" style="flex: 2;">
                                <label for="pacote-servico-id">Pacote (Serviços marcados como Pacote)</label>
                                <select id="pacote-servico-id" required></select>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label for="pacote-data-inicio">Data Início (Geralmente Hoje)</label>
                                <input type="date" id="pacote-data-inicio" required>
                            </div>
                        </div>

                        <div class="flex-container">
                            <button type="submit" class="btn-primary">
                                <span class="material-icons">add_box</span> Iniciar/Vender Pacote
                            </button>
                        </div>
                    </form>
                    
                    <hr style="margin: 20px 0;">

                    <h3>Pacotes Ativos e Utilização</h3>
                    <div style="max-height: 500px; overflow-y: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th style="width: 25%;">Cliente</th>
                                    <th style="width: 30%;">Pacote (Total/Usado)</th>
                                    <th style="width: 20%;">Vencimento</th>
                                    <th style="width: 150px;">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="lista-pacotes-ativos">
                                <tr><td colspan="4" style="text-align: center;">Carregando pacotes ativos...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <hr style="margin: 30px 0;">

                <div class="section-header"><h2>Agendamento de Serviços Individuais (Não-Pacote)</h2></div>
                <div class="card">
                    <form id="agendamento-form">
                        <input type="hidden" id="agendamento-id">
                        
                        <div class="form-row">
                            <div class="form-group" style="flex: 2;">
                                <label for="agenda-cliente-id">Cliente</label>
                                <select id="agenda-cliente-id" required></select>
                            </div>
                            <div class="form-group" style="flex: 2;">
                                <label for="agenda-servico-id">Serviço Individual/Promoção</label>
                                <select id="agenda-servico-id" required></select>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label for="agenda-data">Data</label>
                                <input type="date" id="agenda-data" required>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label for="agenda-hora">Hora</label>
                                <input type="time" id="agenda-hora" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="agenda-observacoes">Observações</label>
                            <textarea id="agenda-observacoes" rows="2"></textarea>
                        </div>

                        <div class="flex-container">
                            <div>
                                <button type="submit" class="btn-success" id="btn-salvar-agendamento">
                                    <span class="material-icons">save</span> Salvar Agendamento
                                </button>
                                <button type="button" class="btn-secondary" onclick="resetAgendamentoForm()">
                                    <span class="material-icons">refresh</span> Limpar
                                </button>
                            </div>
                        </div>
                    </form>
                </div>

                <div class="section-header">
                    <h3>Próximos Agendamentos Individuais (Ativos)</h3>
                </div>
                <div class="card">
                    <div class="filter-row">
                        <div style="flex-grow: 1.5;">
                            <label for="filtro-agenda-data">Filtrar por Data</label>
                            <input type="date" id="filtro-agenda-data" onchange="carregarAgendamentos()">
                        </div>
                        <div style="flex-grow: 3;">
                            <label for="filtro-agenda-cliente">Filtrar por Cliente (Busca por Nome)</label>
                            <input type="text" id="filtro-agenda-cliente" placeholder="Digite o nome do cliente..." onkeyup="filtrarAgendamentos()">
                        </div>
                        <button class="btn-secondary" onclick="resetFiltroAgenda()"><span class="material-icons">refresh</span> Resetar Filtro</button>
                    </div>
                    
                    <div style="max-height: 500px; overflow-y: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th style="width: 15%;">Data/Hora</th>
                                    <th style="width: 25%;">Cliente</th>
                                    <th style="width: 25%;">Serviço</th>
                                    <th>Status</th>
                                    <th style="width: 150px;">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="lista-agendamentos">
                                <tr><td colspan="5" style="text-align: center;">Carregando agendamentos...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="clientes-section" class="content-section">
                <div class="section-header"><h2>Cadastro de Clientes</h2></div>
                <div class="card">
                    <form id="cliente-form">
                        <input type="hidden" id="cliente-id">
                        <div class="form-row">
                            <div class="form-group" style="flex: 2;">
                                <label for="cliente-nome">Nome Completo</label>
                                <input type="text" id="cliente-nome" required>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label for="cliente-telefone">Telefone (Whatsapp)</label>
                                <input type="tel" id="cliente-telefone">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="cliente-email">E-mail (Opcional)</label>
                            <input type="email" id="cliente-email">
                        </div>
                        <div class="form-group">
                            <label for="cliente-endereco">Endereço (Opcional)</label>
                            <input type="text" id="cliente-endereco">
                        </div>
                        <div class="form-group">
                            <label for="cliente-observacoes">Observações (Alergias, Preferências)</label>
                            <textarea id="cliente-observacoes" rows="2"></textarea>
                        </div>

                        <div class="flex-container">
                            <div>
                                <button type="submit" class="btn-success" id="btn-salvar-cliente">
                                    <span class="material-icons">save</span> Salvar Cliente
                                </button>
                                <button type="button" class="btn-secondary" onclick="resetClienteForm()">
                                    <span class="material-icons">refresh</span> Limpar
                                </button>
                            </div>
                        </div>
                    </form>
                </div>

                <div class="section-header">
                    <h3>Lista de Clientes Cadastrados</h3>
                    <div class="input-group" style="width: 300px;">
                        <input type="text" id="filtro-clientes" placeholder="Filtrar por nome, tel ou email..." onkeyup="filtrarClientes()">
                    </div>
                </div>
                <div class="card">
                    <div style="max-height: 500px; overflow-y: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th style="width: 30%;">Nome</th>
                                    <th style="width: 20%;">Telefone</th>
                                    <th style="width: 30%;">E-mail</th>
                                    <th style="width: 150px;">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="lista-clientes">
                                <tr><td colspan="4" style="text-align: center;">Carregando clientes...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="servicos-section" class="content-section">
                <div class="section-header"><h2>Cadastro de Serviços/Pacotes</h2></div>
                <div class="card">
                    <form id="servico-form">
                        <input type="hidden" id="servico-id">
                        <div class="form-row">
                            <div class="form-group" style="flex: 2;">
                                <label for="servico-nome">Nome do Serviço</label>
                                <input type="text" id="servico-nome" required>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label for="servico-preco">Preço (R$)</label>
                                <input type="number" id="servico-preco" step="0.01" min="0" required value="0.00">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <label>
                                    <input type="checkbox" id="servico-isPacote">
                                    É um **Pacote Mensal**?
                                </label>
                            </div>
                            <div class="form-group" id="group-quantidade-total" style="flex: 1; display: none;">
                                <label for="servico-quantidade-total">Total de Procedimentos no Pacote (ex: 6)</label>
                                <input type="number" id="servico-quantidade-total" min="1" value="1">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="servico-descricao">Descrição Detalhada (ex: 4 Mãos e 2 Pés)</label>
                            <textarea id="servico-descricao" rows="2"></textarea>
                        </div>

                        <div class="flex-container">
                            <div>
                                <button type="submit" class="btn-success" id="btn-salvar-servico">
                                    <span class="material-icons">save</span> Salvar Serviço
                                </button>
                                <button type="button" class="btn-secondary" onclick="resetServicoForm()">
                                    <span class="material-icons">refresh</span> Limpar
                                </button>
                            </div>
                        </div>
                    </form>
                </div>

                <div class="section-header">
                    <h3>Lista de Serviços e Preços</h3>
                </div>
                <div class="card">
                    <div style="max-height: 500px; overflow-y: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th style="width: 40%;">Serviço</th>
                                    <th style="width: 15%;">Tipo</th>
                                    <th style="width: 15%;">Total Proc.</th>
                                    <th style="width: 15%;">Preço</th>
                                    <th style="width: 150px;">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="lista-servicos">
                                <tr><td colspan="5" style="text-align: center;">Carregando serviços...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="historico-section" class="content-section">
                </div>
            
        </main>
    </div>

    <script type="module">
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
        import { getDatabase, ref, onValue, push, set, update, remove } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";
        
        // =================================================================
        // 1.1. CONFIGURAÇÃO FIREBASE E VARIÁVEIS GLOBAIS
        // =================================================================
        
        // Sua configuração do Firebase (dados enviados por você)
        const firebaseConfig = {
            apiKey: "AIzaSyBatp6e1NzevurpB2yS8eGErgSYC_t2-Nc",
            authDomain: "tati-manicure.firebaseapp.com",
            databaseURL: "https://tati-manicure-default-rtdb.firebaseio.com",
            projectId: "tati-manicure",
            storageBucket: "tati-manicure.firebaseapp.com",
            messagingSenderId: "1061777323027",
            appId: "1:1061777323027:web:7b54e5fdbb7f06ee293be6",
            measurementId: "G-V3J5ZJ5XBT"
        };
        // Inicialização do Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        // Referências aos nós (listas/tabelas) do seu banco de dados
        const clientesRef = ref(db, 'clientes');
        const servicosRef = ref(db, 'servicos'); 
        const agendamentosRef = ref(db, 'agendamentos'); 
        const pacotesAtivosRef = ref(db, 'pacotes_ativos'); 
        const SENHA_UNICA = "tati123";

        // Caches de Dados
        let cacheClientes = {}; 
        let cacheServicos = {};
        let cachePacotes = {}; 
        let agendamentosAtivos = []; 
        
        // =================================================================
        // 1. LÓGICA DE LOGIN, NAVEGAÇÃO E NOTIFICAÇÃO
        // =================================================================
        
        const loginContainer = document.getElementById('login-container');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const logoutButton = document.getElementById('logout-button');
        const navLinks = document.querySelectorAll('.sidebar ul li a');
        const contentSections = document.querySelectorAll('.content-section');
        const userInfoDisplay = document.getElementById('userInfo');
        const notificationBar = document.getElementById('notification-bar');

        const today = new Date().toISOString().slice(0, 10);

        function showApp(userName = 'Tati') {
            loginContainer.style.display = 'none';
            appContainer.style.display = 'flex';
            userInfoDisplay.textContent = `Olá, ${userName}!`;
            
            carregarClientes();
            carregarServicos(); 
            // Os selects são populados após o carregamento dos dados
            // Define o filtro de data da agenda como o dia atual e carrega
            document.getElementById('filtro-agenda-data').value = today;
            carregarAgendamentos(); 
            carregarPacotesAtivos(); 
        }
        
        function showLogin() {
            loginContainer.style.display = 'flex';
            appContainer.style.display = 'none';
        }
        
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const senha = document.getElementById('loginSenha').value;
            if (senha === SENHA_UNICA) {
                showApp();
                showNotification(`Acesso liberado! Bem-vinda.`, 'success');
            } else {
                showNotification('Senha incorreta.', 'error');
            }
            document.getElementById('loginSenha').value = '';
        });

        logoutButton.addEventListener('click', () => {
            showLogin();
            showNotification('Você saiu do sistema.', 'info');
        });
        
        // Navegação entre Telas
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetSectionId = e.currentTarget.getAttribute('data-section');
        
                // Recarrega as listas quando as abas são clicadas
                if (targetSectionId === 'clientes') { carregarClientes(); }
                if (targetSectionId === 'servicos') { carregarServicos(); }
                if (targetSectionId === 'agenda') { 
                    popularSelects();
                    if (!document.getElementById('filtro-agenda-data').value) {
                         document.getElementById('filtro-agenda-data').value = today;
                    }
                    carregarAgendamentos(); 
                    carregarPacotesAtivos(); 
                }
                if (targetSectionId === 'historico') { carregarHistorico(); }
        
                navLinks.forEach(l => l.classList.remove('active'));
                contentSections.forEach(s => s.classList.remove('active'));
        
                e.currentTarget.classList.add('active');
                document.getElementById(`${targetSectionId}-section`).classList.add('active');
            });
        });
         
        // Função de Notificação
        function showNotification(message, type = 'success') {
             notificationBar.innerHTML = message; 
             notificationBar.className = `notification ${type} show`;
             setTimeout(() => { notificationBar.classList.remove('show'); }, 3000);
        }

        // Função auxiliar para obter cor da variável CSS
        function varToColor(varName) {
            return getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
        }

        // =================================================================
        // 2. CRUD DE CLIENTES (NÓ: 'clientes')
        // =================================================================
        
        const clienteForm = document.getElementById('cliente-form');
        const listaClientes = document.getElementById('lista-clientes');
        const btnSalvarCliente = document.getElementById('btn-salvar-cliente');

        window.resetClienteForm = function() {
            clienteForm.reset();
            document.getElementById('cliente-id').value = '';
            btnSalvarCliente.innerHTML = '<span class="material-icons">save</span> Salvar Cliente';
            btnSalvarCliente.classList.replace('btn-secondary', 'btn-success');
        }

        // 2.1. SALVAR/ATUALIZAR CLIENTE
        clienteForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const id = document.getElementById('cliente-id').value;
            const novoCliente = {
                nome: document.getElementById('cliente-nome').value.trim(),
                telefone: document.getElementById('cliente-telefone').value.trim(),
                email: document.getElementById('cliente-email').value.trim(),
                endereco: document.getElementById('cliente-endereco').value.trim(),
                observacoes: document.getElementById('cliente-observacoes').value.trim()
            };

            if (id) {
                update(ref(db, `clientes/${id}`), novoCliente)
                    .then(() => {
                        showNotification('Cliente atualizado com sucesso!', 'success');
                        resetClienteForm();
                    })
                    .catch(error => {
                        showNotification('Erro ao atualizar cliente: ' + error.message, 'error');
                    });
            } else {
                push(clientesRef, novoCliente)
                    .then(() => {
                        showNotification('Cliente cadastrado com sucesso!', 'success');
                        resetClienteForm();
                    })
                    .catch(error => {
                        showNotification('Erro ao cadastrar cliente: ' + error.message, 'error');
                    });
            }
        });

        // 2.2. CARREGAR CLIENTES DO FIREBASE (e popular cache)
        function carregarClientes() {
            onValue(clientesRef, (snapshot) => {
                const clientes = snapshot.val();
                listaClientes.innerHTML = '';
                cacheClientes = {}; 
                const clientesArray = [];

                if (clientes) {
                    for (let id in clientes) {
                        clientesArray.push({ id, ...clientes[id] });
                        cacheClientes[id] = { id, ...clientes[id] };
                    }

                    clientesArray.sort((a, b) => a.nome.localeCompare(b.nome));

                    clientesArray.forEach(cliente => {
                        const row = listaClientes.insertRow();
                        row.dataset.clienteData = JSON.stringify(cliente);
                        
                        row.insertCell().setAttribute('data-label', 'Nome');
                        row.cells[0].textContent = cliente.nome;

                        row.insertCell().setAttribute('data-label', 'Telefone');
                        row.cells[1].textContent = cliente.telefone;

                        row.insertCell().setAttribute('data-label', 'E-mail');
                        row.cells[2].textContent = cliente.email;

                        const acoesCell = row.insertCell();
                        acoesCell.className = 'action-buttons';
                        acoesCell.setAttribute('data-label', 'Ações');

                        const btnEditar = document.createElement('button');
                        btnEditar.innerHTML = '<span class="material-icons" style="font-size: 18px;">edit</span> Editar';
                        btnEditar.className = 'btn-secondary';
                        btnEditar.title = 'Editar';
                        btnEditar.onclick = () => editarCliente(cliente);
                        acoesCell.appendChild(btnEditar);

                        const btnExcluir = document.createElement('button');
                        btnExcluir.innerHTML = '<span class="material-icons" style="font-size: 18px;">delete</span> Excluir';
                        btnExcluir.className = 'btn-danger';
                        btnExcluir.title = 'Excluir';
                        btnExcluir.onclick = () => confirmarExclusaoCliente(cliente.id, cliente.nome);
                        acoesCell.appendChild(btnExcluir);
                    });
                } else {
                    listaClientes.innerHTML = '<tr><td colspan="4" style="text-align: center;">Nenhum cliente cadastrado.</td></tr>';
                }

                popularSelects(); 
            });
        }

        // 2.3. PREENCHER FORMULÁRIO PARA EDIÇÃO
        function editarCliente(cliente) {
            document.getElementById('cliente-id').value = cliente.id;
            document.getElementById('cliente-nome').value = cliente.nome;
            document.getElementById('cliente-telefone').value = cliente.telefone;
            document.getElementById('cliente-email').value = cliente.email;
            document.getElementById('cliente-endereco').value = cliente.endereco;
            document.getElementById('cliente-observacoes').value = cliente.observacoes;

            btnSalvarCliente.innerHTML = '<span class="material-icons">update</span> Atualizar Cliente';
            btnSalvarCliente.classList.replace('btn-success', 'btn-secondary');
            document.getElementById('clientes-section').scrollIntoView({ behavior: 'smooth' });
        }

        // 2.4. EXCLUIR CLIENTE
        function confirmarExclusaoCliente(id, nome) {
            if (confirm(`Tem certeza que deseja excluir o cliente "${nome}"? Esta ação não pode ser desfeita.`)) {
                remove(ref(db, `clientes/${id}`))
                    .then(() => {
                        showNotification(`Cliente "**${nome}**" excluído com sucesso.`, 'danger');
                    })
                    .catch(error => {
                        showNotification('Erro ao excluir cliente: ' + error.message, 'error');
                    });
            }
        }

        // 2.5. FILTRAR CLIENTES NA TABELA (Busca Local)
        window.filtrarClientes = function() {
            const filtro = document.getElementById('filtro-clientes').value.toLowerCase();
            const linhas = listaClientes.getElementsByTagName('tr');

            for (let i = 0; i < linhas.length; i++) {
                const row = linhas[i];
                if (row.cells.length < 4 || !row.dataset.clienteData) { 
                    row.style.display = "block";
                    continue; 
                }

                const clienteData = JSON.parse(row.dataset.clienteData);
                const nome = clienteData.nome.toLowerCase();
                const telefone = clienteData.telefone.toLowerCase();
                const email = clienteData.email.toLowerCase();

                if (nome.includes(filtro) || telefone.includes(filtro) || email.includes(filtro)) {
                    row.style.display = "block"; 
                } else {
                    row.style.display = "none";
                }
            }
        }

        // =================================================================
        // 3. CRUD DE SERVIÇOS (NÓ: 'servicos')
        // =================================================================
        
        const servicoForm = document.getElementById('servico-form');
        const listaServicos = document.getElementById('lista-servicos');
        const btnSalvarServico = document.getElementById('btn-salvar-servico');
        const servicoIsPacote = document.getElementById('servico-isPacote');
        const groupQuantidadeTotal = document.getElementById('group-quantidade-total');

        // Lógica de exibição do campo de quantidade
        servicoIsPacote.addEventListener('change', () => {
             groupQuantidadeTotal.style.display = servicoIsPacote.checked ? 'block' : 'none';
        });

        window.resetServicoForm = function() {
            servicoForm.reset();
            document.getElementById('servico-id').value = '';
            document.getElementById('servico-quantidade-total').value = '1';
            groupQuantidadeTotal.style.display = 'none'; // Esconde o campo ao resetar
            btnSalvarServico.innerHTML = '<span class="material-icons">save</span> Salvar Serviço';
            btnSalvarServico.classList.replace('btn-secondary', 'btn-success');
        }

        // 3.1. SALVAR/ATUALIZAR SERVIÇO/PACOTE (INCLUI QUANTIDADE TOTAL)
        servicoForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const id = document.getElementById('servico-id').value;
            const isPacote = servicoIsPacote.checked;
            const quantidadeTotal = isPacote ? parseInt(document.getElementById('servico-quantidade-total').value) : 0;
            
            if (isPacote && (isNaN(quantidadeTotal) || quantidadeTotal < 1)) {
                 showNotification('Pacotes devem ter no mínimo 1 procedimento.', 'error');
                 return;
            }
            
            const novoServico = {
                nome: document.getElementById('servico-nome').value.trim(),
                preco: parseFloat(document.getElementById('servico-preco').value).toFixed(2),
                descricao: document.getElementById('servico-descricao').value.trim(),
                isPacote: isPacote,
                tipo: isPacote ? 'Pacote' : 'Serviço/Promoção',
                quantidadeTotalProcedimentos: quantidadeTotal 
            };

            const dbRef = id ? ref(db, `servicos/${id}`) : push(servicosRef);
            
            set(dbRef, novoServico)
                .then(() => {
                    showNotification(isPacote ? 'Pacote salvo com sucesso!' : 'Serviço salvo com sucesso!', 'success');
                    resetServicoForm();
                })
                .catch(error => {
                    showNotification('Erro ao salvar: ' + error.message, 'error');
                });
        });

        // 3.2. CARREGAR SERVIÇOS DO FIREBASE (e popular cache)
        function carregarServicos() {
            onValue(servicosRef, (snapshot) => {
                const servicos = snapshot.val();
                listaServicos.innerHTML = '';
                cacheServicos = {}; 
                const servicosArray = [];

                if (servicos) {
                    for (let id in servicos) {
                        servicosArray.push({ id, ...servicos[id] });
                        cacheServicos[id] = { id, ...servicos[id] };
                    }

                    servicosArray.sort((a, b) => a.nome.localeCompare(b.nome));

                    servicosArray.forEach(servico => {
                        const row = listaServicos.insertRow();
                        
                        row.insertCell().setAttribute('data-label', 'Serviço');
                        row.cells[0].textContent = servico.nome;

                        row.insertCell().setAttribute('data-label', 'Tipo');
                        row.cells[1].textContent = servico.tipo;
                        
                        // Coluna Total de Procedimentos
                        row.insertCell().setAttribute('data-label', 'Total Proc.');
                        row.cells[2].textContent = servico.isPacote ? servico.quantidadeTotalProcedimentos : '-';

                        row.insertCell().setAttribute('data-label', 'Preço');
                        row.cells[3].textContent = `R$ ${parseFloat(servico.preco).toFixed(2).replace('.', ',')}`;

                        const acoesCell = row.insertCell();
                        acoesCell.className = 'action-buttons';
                        acoesCell.setAttribute('data-label', 'Ações');

                        const btnEditar = document.createElement('button');
                        btnEditar.innerHTML = '<span class="material-icons" style="font-size: 18px;">edit</span> Editar';
                        btnEditar.className = 'btn-secondary';
                        btnEditar.title = 'Editar';
                        btnEditar.onclick = () => editarServico(servico);
                        acoesCell.appendChild(btnEditar);

                        const btnExcluir = document.createElement('button');
                        btnExcluir.innerHTML = '<span class="material-icons" style="font-size: 18px;">delete</span> Excluir';
                        btnExcluir.className = 'btn-danger';
                        btnExcluir.title = 'Excluir';
                        btnExcluir.onclick = () => confirmarExclusaoServico(servico.id, servico.nome);
                        acoesCell.appendChild(btnExcluir);
                    });
                } else {
                    listaServicos.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nenhum serviço/pacote cadastrado.</td></tr>';
                }

                popularSelects(); 
            });
        }

        // 3.3. PREENCHER FORMULÁRIO PARA EDIÇÃO
        function editarServico(servico) {
            document.getElementById('servico-id').value = servico.id;
            document.getElementById('servico-nome').value = servico.nome;
            document.getElementById('servico-preco').value = servico.preco;
            document.getElementById('servico-descricao').value = servico.descricao;
            servicoIsPacote.checked = servico.isPacote;
            document.getElementById('servico-quantidade-total').value = servico.quantidadeTotalProcedimentos || 1;
            
            // Exibe ou esconde o campo de quantidade na edição
            groupQuantidadeTotal.style.display = servico.isPacote ? 'block' : 'none';

            btnSalvarServico.innerHTML = '<span class="material-icons">update</span> Atualizar Serviço';
            btnSalvarServico.classList.replace('btn-success', 'btn-secondary');
            document.getElementById('servicos-section').scrollIntoView({ behavior: 'smooth' });
        }

        // 3.4. EXCLUIR SERVIÇO
        function confirmarExclusaoServico(id, nome) {
            if (confirm(`Tem certeza que deseja excluir o serviço/pacote "${nome}"? Esta ação não pode ser desfeita.`)) {
                remove(ref(db, `servicos/${id}`))
                    .then(() => {
                        showNotification(`Serviço/Pacote "**${nome}**" excluído com sucesso.`, 'danger');
                    })
                    .catch(error => {
                        showNotification('Erro ao excluir serviço: ' + error.message, 'error');
                    });
            }
        }

        // =================================================================
        // 4. LÓGICA DA AGENDA (NÓS: 'agendamentos' e 'pacotes_ativos')
        // =================================================================
        
        const agendamentoForm = document.getElementById('agendamento-form');
        const listaAgendamentos = document.getElementById('lista-agendamentos');
        const clienteSelect = document.getElementById('agenda-cliente-id');
        const servicoSelect = document.getElementById('agenda-servico-id');
        const btnSalvarAgendamento = document.getElementById('btn-salvar-agendamento');
        
        // Novos elementos para pacotes
        const pacoteInicioForm = document.getElementById('pacote-inicio-form');
        const pacoteClienteSelect = document.getElementById('pacote-cliente-id');
        const pacoteServicoSelect = document.getElementById('pacote-servico-id');
        const listaPacotesAtivos = document.getElementById('lista-pacotes-ativos');


        // Função auxiliar para formatar a data para exibição
        function formatarDataHora(dataString, horaString) {
            const data = new Date(dataString + 'T' + horaString + ':00');
            if (isNaN(data)) return 'Data Inválida';

            const options = { weekday: 'short', day: '2-digit', month: '2-digit' };
            const dataFormatada = data.toLocaleDateString('pt-BR', options).replace(',', '').replace('.', '');
            const horaFormatada = horaString ? horaString.substring(0, 5) : '00:00';
            return `${dataFormatada} ${horaFormatada}`;
        }
        
        // Função auxiliar para adicionar dias
        function addDays(dateString, days) {
            const date = new Date(dateString);
            date.setDate(date.getDate() + days);
            return date.toISOString().slice(0, 10);
        }

        // 4.1. POPULAR SELECTS (Clientes, Serviços Individuais e Pacotes)
        function popularSelects() {
            // Limpa e Adiciona opção default
            clienteSelect.innerHTML = '<option value="">-- Selecione o Cliente --</option>';
            pacoteClienteSelect.innerHTML = '<option value="">-- Selecione o Cliente --</option>';
            servicoSelect.innerHTML = '<option value="">-- Selecione o Serviço/Promoção --</option>';
            pacoteServicoSelect.innerHTML = '<option value="">-- Selecione o Pacote --</option>';
            
            // Popula Selects de Clientes
            const clientesOrdenados = Object.values(cacheClientes).sort((a, b) => a.nome.localeCompare(b.nome));

            clientesOrdenados.forEach(cliente => {
                const optionAgenda = document.createElement('option');
                optionAgenda.value = cliente.id;
                optionAgenda.textContent = cliente.nome;
                clienteSelect.appendChild(optionAgenda);
                
                const optionPacote = document.createElement('option');
                optionPacote.value = cliente.id;
                optionPacote.textContent = cliente.nome;
                pacoteClienteSelect.appendChild(optionPacote);
            });

            // Popula Selects de Serviços/Pacotes
            for (let id in cacheServicos) {
                const servico = cacheServicos[id];
                const preco = parseFloat(servico.preco).toFixed(2).replace('.', ',');
                
                if (servico.isPacote) {
                     const optionPacote = document.createElement('option');
                     optionPacote.value = id;
                     optionPacote.textContent = `${servico.nome} (${servico.quantidadeTotalProcedimentos} Proc.) - R$ ${preco}`;
                     pacoteServicoSelect.appendChild(optionPacote);
                } else {
                     const optionAgenda = document.createElement('option');
                     optionAgenda.value = id;
                     optionAgenda.textContent = `${servico.nome} - R$ ${preco}`;
                     servicoSelect.appendChild(optionAgenda);
                }
            }
            
            // Define a data de início do pacote como hoje por padrão
            document.getElementById('pacote-data-inicio').value = today;
        }

        // 4.2. RESETAR FORMULÁRIO DE AGENDAMENTO INDIVIDUAL
        window.resetAgendamentoForm = function() {
            agendamentoForm.reset();
            document.getElementById('agendamento-id').value = '';
            document.getElementById('agenda-data').value = ''; 
            document.getElementById('agenda-hora').value = ''; 
            btnSalvarAgendamento.innerHTML = '<span class="material-icons">save</span> Salvar Agendamento';
            btnSalvarAgendamento.classList.replace('btn-secondary', 'btn-success');
        }
        
        // 4.3. SALVAR/ATUALIZAR AGENDAMENTO INDIVIDUAL
        agendamentoForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const id = document.getElementById('agendamento-id').value;
            const clienteId = document.getElementById('agenda-cliente-id').value;
            const servicoId = document.getElementById('agenda-servico-id').value;
            
            if (!clienteId || !servicoId) {
                 showNotification('Selecione um cliente e um serviço/promoção.', 'error');
                 return;
            }

            const cliente = cacheClientes[clienteId];
            const servico = cacheServicos[servicoId];
            
            if (servico.isPacote) {
                 showNotification('Por favor, use a seção "Gerenciar Pacotes" para iniciar um pacote.', 'error');
                 return;
            }

            const novoAgendamento = {
                clienteId: clienteId,
                clienteNome: cliente.nome,
                clienteTelefone: cliente.telefone,
                servicoId: servicoId,
                servicoNome: servico.nome,
                servicoPreco: servico.preco, 
                data: document.getElementById('agenda-data').value,
                hora: document.getElementById('agenda-hora').value,
                observacoes: document.getElementById('agenda-observacoes').value.trim(),
                status: 'Ativo',
                isPacoteUse: false 
            };

            const dbRef = id ? ref(db, `agendamentos/${id}`) : push(agendamentosRef);
            
            set(dbRef, novoAgendamento)
                .then(() => {
                    resetAgendamentoForm(); 
                    showNotification('Agendamento de serviço individual salvo!', 'success');
                })
                .catch(error => {
                    showNotification('Erro ao salvar agendamento: ' + error.message, 'error');
                });
        });

        // 4.4. CARREGAR AGENDAMENTOS INDIVIDUAIS
        function carregarAgendamentos() {
            const lista = document.getElementById('lista-agendamentos');
            const dataFiltro = document.getElementById('filtro-agenda-data').value;
            lista.innerHTML = '<tr><td colspan="5" style="text-align: center;">Carregando agendamentos...</td></tr>';
            
            onValue(agendamentosRef, (snapshot) => {
                const agendamentos = snapshot.val();
                agendamentosAtivos = []; 
                
                if (agendamentos) {
                    for (let id in agendamentos) {
                        if (agendamentos[id].status === 'Ativo' && !agendamentos[id].isPacoteUse) { 
                            agendamentosAtivos.push({ id, ...agendamentos[id] });
                        }
                    }
                }
                
                renderizarListaAgendamentos(dataFiltro);
            });
        }
        
        // 4.5. RENDERIZAR LISTA DE AGENDAMENTOS INDIVIDUAIS
        function renderizarListaAgendamentos(dataFiltro) {
            const lista = document.getElementById('lista-agendamentos');
            lista.innerHTML = ''; 
            
            let agendamentosFiltrados = agendamentosAtivos.filter(agendamento => {
                if (dataFiltro && agendamento.data !== dataFiltro) {
                    return false;
                }
                return true; 
            });

            agendamentosFiltrados.sort((a, b) => {
                const dateTimeA = new Date(`${a.data}T${a.hora}`);
                const dateTimeB = new Date(`${b.data}T${b.hora}`);
                return dateTimeA - dateTimeB;
            });

            if (agendamentosFiltrados.length > 0) {
                agendamentosFiltrados.forEach(agendamento => {
                    const row = lista.insertRow();
                    row.dataset.agendamentoData = JSON.stringify(agendamento);
                    
                    row.insertCell().setAttribute('data-label', 'Data/Hora');
                    row.cells[0].textContent = formatarDataHora(agendamento.data, agendamento.hora);
                    
                    const clienteCell = row.insertCell();
                    clienteCell.setAttribute('data-label', 'Cliente');
                    clienteCell.innerHTML = `<strong>${agendamento.clienteNome}</strong><br><small>${agendamento.clienteTelefone}</small>`;
                    
                    const servicoCell = row.insertCell();
                    servicoCell.setAttribute('data-label', 'Serviço');
                    const precoFormatado = parseFloat(agendamento.servicoPreco).toFixed(2).replace('.', ',');
                    servicoCell.innerHTML = `<strong>${agendamento.servicoNome}</strong><br><small>R$ ${precoFormatado}</small>`;
                    
                    const statusCell = row.insertCell();
                    statusCell.setAttribute('data-label', 'Status');
                    statusCell.textContent = agendamento.status;
                    statusCell.style.color = agendamento.status === 'Ativo' ? varToColor('--success-color') : varToColor('--secondary-color');
                    
                    const acoesCell = row.insertCell();
                    acoesCell.className = 'action-buttons';
                    
                    const btnEditar = document.createElement('button');
                    btnEditar.innerHTML = '<span class="material-icons" style="font-size: 18px;">edit</span> Editar';
                    btnEditar.className = 'btn-secondary';
                    btnEditar.title = 'Editar';
                    btnEditar.onclick = () => editarAgendamento(agendamento);
                    acoesCell.appendChild(btnEditar);

                    const btnConcluir = document.createElement('button');
                    btnConcluir.innerHTML = '<span class="material-icons" style="font-size: 18px;">check</span> Concluir';
                    btnConcluir.className = 'btn-success';
                    btnConcluir.title = 'Concluir';
                    btnConcluir.onclick = () => concluirAgendamento(agendamento.id, agendamento.clienteNome);
                    acoesCell.appendChild(btnConcluir);
                });
                
                filtrarAgendamentos(); 
                
            } else {
                lista.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nenhum agendamento ativo de serviço individual encontrado para esta data.</td></tr>';
            }
        }

        // 4.6. PREENCHER FORMULÁRIO PARA EDIÇÃO
        function editarAgendamento(agendamento) {
            document.getElementById('agendamento-id').value = agendamento.id;
            document.getElementById('agenda-cliente-id').value = agendamento.clienteId;
            document.getElementById('agenda-servico-id').value = agendamento.servicoId;
            document.getElementById('agenda-data').value = agendamento.data;
            document.getElementById('agenda-hora').value = agendamento.hora;
            document.getElementById('agenda-observacoes').value = agendamento.observacoes;

            btnSalvarAgendamento.innerHTML = '<span class="material-icons">update</span> Atualizar Agendamento';
            btnSalvarAgendamento.classList.replace('btn-success', 'btn-secondary');
            document.getElementById('agenda-section').scrollIntoView({ behavior: 'smooth' });
        }
        
        // 4.7. CONCLUIR AGENDAMENTO INDIVIDUAL
        function concluirAgendamento(id, clienteNome) {
            if (confirm(`Confirmar a conclusão e registro do agendamento de "${clienteNome}" como realizado?`)) {
                 update(ref(db, `agendamentos/${id}`), { status: 'Concluído' })
                    .then(() => {
                        showNotification(`Agendamento de **${clienteNome}** concluído com sucesso.`, 'success');
                    })
                    .catch(error => {
                        showNotification('Erro ao concluir agendamento: ' + error.message, 'error');
                    });
            }
        }
        
        // 4.8. FILTRAR AGENDAMENTOS INDIVIDUAIS NA TABELA (Mantido como busca por texto para filtrar)
        window.filtrarAgendamentos = function() {
            const filtro = document.getElementById('filtro-agenda-cliente').value.toLowerCase();
            const linhas = listaAgendamentos.getElementsByTagName('tr');

            for (let i = 0; i < linhas.length; i++) {
                const row = linhas[i];
                if (row.cells.length < 5 || !row.dataset.agendamentoData) { 
                    row.style.display = "block";
                    continue; 
                }

                const agendamentoData = JSON.parse(row.dataset.agendamentoData);
                const clienteNome = agendamentoData.clienteNome.toLowerCase();
                
                if (clienteNome.includes(filtro)) {
                    row.style.display = "block";
                } else {
                    row.style.display = "none";
                }
            }
        }
        
        // 4.9. RESETAR FILTRO DA AGENDA
        window.resetFiltroAgenda = function() {
            document.getElementById('filtro-agenda-data').value = today;
            document.getElementById('filtro-agenda-cliente').value = '';
            carregarAgendamentos();
        }
        
        // =================================================================
        // 5. LÓGICA DE GERENCIAMENTO DE PACOTES (NOVO NÓ: 'pacotes_ativos')
        // =================================================================
        
        // 5.1. INICIAR NOVO PACOTE
        pacoteInicioForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const clienteId = pacoteClienteSelect.value;
            const servicoId = pacoteServicoSelect.value;
            const dataInicio = document.getElementById('pacote-data-inicio').value;
            
            if (!clienteId || !servicoId || !dataInicio) {
                 showNotification('Preencha todos os campos para iniciar o pacote.', 'error');
                 return;
            }

            const cliente = cacheClientes[clienteId];
            const pacoteServico = cacheServicos[servicoId];
            
            // Verifica se o cliente já tem um pacote ativo com o mesmo serviço
            const pacoteExistente = Object.values(cachePacotes).find(p => 
                p.clienteId === clienteId && 
                p.servicoId === servicoId && 
                p.status === 'Ativo'
            );
            
            if (pacoteExistente) {
                showNotification(`O cliente ${cliente.nome} já possui o pacote ${pacoteServico.nome} ativo.`, 'info');
                return;
            }

            const dataFim = addDays(dataInicio, 30); // 30 dias de validade
            
            const novoPacoteAtivo = {
                clienteId: clienteId,
                clienteNome: cliente.nome,
                clienteTelefone: cliente.telefone,
                servicoId: servicoId,
                servicoNome: pacoteServico.nome,
                servicoPreco: pacoteServico.preco, 
                dataInicio: dataInicio,
                dataFim: dataFim,
                quantidadeTotal: pacoteServico.quantidadeTotalProcedimentos,
                quantidadeUtilizada: 0,
                status: 'Ativo'
            };

            push(pacotesAtivosRef, novoPacoteAtivo)
                .then(() => {
                    pacoteInicioForm.reset();
                    document.getElementById('pacote-data-inicio').value = today; // Reseta para hoje
                    showNotification(`Pacote **${pacoteServico.nome}** iniciado para **${cliente.nome}**. Válido até ${dataFim.split('-').reverse().join('/')}.`, 'success');
                })
                .catch(error => {
                    showNotification('Erro ao iniciar pacote: ' + error.message, 'error');
                });
        });
        
        // 5.2. CARREGAR PACOTES ATIVOS (e popular cache)
        function carregarPacotesAtivos() {
            listaPacotesAtivos.innerHTML = '<tr><td colspan="4" style="text-align: center;">Carregando pacotes ativos...</td></tr>';
            
            onValue(pacotesAtivosRef, (snapshot) => {
                const pacotes = snapshot.val();
                cachePacotes = {};
                let pacotesArray = [];

                if (pacotes) {
                    for (let id in pacotes) {
                        const pacote = { id, ...pacotes[id] };
                        
                        // Verifica validade (se não estiver finalizado)
                        if (pacote.status === 'Ativo' && new Date(pacote.dataFim) < new Date(today)) {
                             // Marca como Vencido
                             update(ref(db, `pacotes_ativos/${id}`), { status: 'Vencido' });
                             pacote.status = 'Vencido'; // Atualiza localmente para a renderização
                        }
                        
                        pacotesArray.push(pacote);
                        cachePacotes[id] = pacote;
                    }
                }
                
                // Filtra para exibir apenas Ativos e Vencidos, ordenados por Cliente e Data de Vencimento
                pacotesArray = pacotesArray.filter(p => p.status !== 'Finalizado');
                pacotesArray.sort((a, b) => a.clienteNome.localeCompare(b.clienteNome));

                renderizarPacotesAtivos(pacotesArray);
            });
        }
        
        // 5.3. RENDERIZAR LISTA DE PACOTES ATIVOS
        function renderizarPacotesAtivos(pacotesArray) {
            listaPacotesAtivos.innerHTML = '';
            
            if (pacotesArray.length > 0) {
                 pacotesArray.forEach(pacote => {
                    const row = listaPacotesAtivos.insertRow();
                    
                    const restante = pacote.quantidadeTotal - pacote.quantidadeUtilizada;
                    const isVencido = pacote.status === 'Vencido';
                    const statusClass = isVencido ? 'status-package-finalized' : 'status-package-active';
                    const dataVencimentoFormatada = pacote.dataFim.split('-').reverse().join('/');

                    // Coluna Cliente (data-label "Cliente")
                    row.insertCell().setAttribute('data-label', 'Cliente');
                    row.cells[0].innerHTML = `<strong>${pacote.clienteNome}</strong><br><small>Início: ${pacote.dataInicio.split('-').reverse().join('/')}</small>`;
                    
                    // Coluna Pacote (data-label "Pacote")
                    row.insertCell().setAttribute('data-label', 'Pacote (Total/Usado)');
                    row.cells[1].innerHTML = `${pacote.servicoNome}<br>
                                            <span class="${statusClass}">Utilizados: ${pacote.quantidadeUtilizada} / ${pacote.quantidadeTotal}</span>`;
                    
                    // Coluna Vencimento (data-label "Vencimento")
                    row.insertCell().setAttribute('data-label', 'Vencimento');
                    row.cells[2].innerHTML = `<strong>${dataVencimentoFormatada}</strong><br><small>${pacote.status}</small>`;
                    
                    // Coluna Ações (data-label "Ações")
                    const acoesCell = row.insertCell();
                    acoesCell.className = 'action-buttons';
                    
                    if (isVencido || restante === 0) {
                        // Se estiver vencido ou zerado (mas não Finalizado), oferece a opção de finalizar
                        const btnFinalizar = document.createElement('button');
                        btnFinalizar.innerHTML = '<span class="material-icons" style="font-size: 18px;">archive</span> Finalizar';
                        btnFinalizar.className = 'btn-danger';
                        btnFinalizar.title = 'Marcar como Finalizado';
                        btnFinalizar.onclick = () => finalizarPacote(pacote.id, pacote.clienteNome, pacote.servicoNome);
                        acoesCell.appendChild(btnFinalizar);
                        
                    } else if (restante > 0) {
                        // Se ainda há procedimentos
                        const btnUsar = document.createElement('button');
                        btnUsar.innerHTML = '<span class="material-icons" style="font-size: 18px;">check</span> Registrar Uso';
                        btnUsar.className = 'btn-primary';
                        btnUsar.title = 'Registrar uso e reduzir o contador';
                        btnUsar.onclick = () => registrarUsoPacote(pacote.id, pacote.clienteNome, pacote.servicoNome, restante);
                        acoesCell.appendChild(btnUsar);
                    }
                    
                    // Botão opcional de Excluir/Cancelar o pacote
                    const btnCancelar = document.createElement('button');
                    btnCancelar.innerHTML = '<span class="material-icons" style="font-size: 18px;">cancel</span> Cancelar';
                    btnCancelar.className = 'btn-secondary';
                    btnCancelar.title = 'Cancelar Pacote (Remover do Ativo)';
                    btnCancelar.onclick = () => confirmarExclusaoPacote(pacote.id, pacote.clienteNome, pacote.servicoNome);
                    acoesCell.appendChild(btnCancelar);
                    
                 });
            } else {
                listaPacotesAtivos.innerHTML = '<tr><td colspan="4" style="text-align: center;">Nenhum pacote ativo no momento.</td></tr>';
            }
        }
        
        // 5.4. REGISTRAR USO DE PROCEDIMENTO
        function registrarUsoPacote(id, clienteNome, servicoNome, restante) {
             if (confirm(`Confirmar o uso de 1 procedimento do pacote **${servicoNome}** de **${clienteNome}**? Restam ${restante - 1} após esta baixa.`)) {
                 const pacote = cachePacotes[id];
                 const novaQuantidade = pacote.quantidadeUtilizada + 1;
                 let novoStatus = pacote.status;
                 
                 if (novaQuantidade === pacote.quantidadeTotal) {
                      novoStatus = 'Finalizado'; 
                 }

                 update(ref(db, `pacotes_ativos/${id}`), { 
                     quantidadeUtilizada: novaQuantidade, 
                     status: novoStatus 
                 })
                    .then(() => {
                        showNotification(`1 Procedimento do pacote **${servicoNome}** de **${clienteNome}** registrado.`, 'success');
                    })
                    .catch(error => {
                        showNotification('Erro ao registrar uso: ' + error.message, 'error');
                    });
             }
        }
        
        // 5.5. FINALIZAR PACOTE (Mudar status para Finalizado - Lucro no histórico)
        function finalizarPacote(id, clienteNome, servicoNome) {
            if (confirm(`Finalizar o pacote **${servicoNome}** de **${clienteNome}** e movê-lo para o Histórico de Lucros?`)) {
                 update(ref(db, `pacotes_ativos/${id}`), { status: 'Finalizado' })
                    .then(() => {
                        showNotification(`Pacote **${servicoNome}** de **${clienteNome}** finalizado e registrado no histórico.`, 'info');
                        carregarPacotesAtivos(); // Recarrega lista
                    })
                    .catch(error => {
                        showNotification('Erro ao finalizar pacote: ' + error.message, 'error');
                    });
            }
        }
        
        // 5.6. EXCLUIR/CANCELAR PACOTE ATIVO
        function confirmarExclusaoPacote(id, clienteNome, servicoNome) {
            if (confirm(`Tem certeza que deseja **CANCELAR** o pacote **${servicoNome}** de **${clienteNome}**? Esta ação o remove da lista ativa.`)) {
                 remove(ref(db, `pacotes_ativos/${id}`))
                    .then(() => {
                        showNotification(`Pacote **${servicoNome}** cancelado com sucesso.`, 'danger');
                    })
                    .catch(error => {
                        showNotification('Erro ao cancelar pacote: ' + error.message, 'error');
                    });
            }
        }


        // =================================================================
        // 6. HISTÓRICO E LUCROS (AGORA INCLUI PACOTES FINALIZADOS)
        // =================================================================
        
        function carregarHistorico() {
            const historicoSection = document.getElementById('historico-section');
            historicoSection.innerHTML = `
                <div class="section-header">
                    <h2>Histórico e Lucros</h2>
                </div>
                <div class="card">
                    <h3>Filtros de Histórico</h3>
                    <div class="filter-row">
                        <div style="flex-grow: 1;">
                            <label for="filtro-historico-mes">Filtrar por Mês</label>
                            <input type="month" id="filtro-historico-mes" onchange="renderizarHistorico()">
                        </div>
                        <div style="flex-grow: 1;">
                            <label for="filtro-historico-cliente">Filtrar por Cliente</label>
                            <input type="text" id="filtro-historico-cliente" placeholder="Nome do cliente..." onkeyup="filtrarHistoricoTabela()">
                        </div>
                        <button class="btn-secondary" onclick="resetFiltroHistorico()"><span class="material-icons">refresh</span> Resetar Filtro</button>
                    </div>
                </div>
                <div class="card">
                    <div class="flex-container">
                        <h3>Resumo do Período (<span id="resumo-periodo">Todos os Tempos</span>)</h3>
                        <h2 id="lucro-total">R$ 0,00</h2>
                    </div>
                    <p id="contagem-servicos" style="font-size: 0.9rem; color: var(--secondary-color);"></p>
                </div>
                <div class="card">
                    <h3>Detalhes dos Serviços Concluídos</h3>
                    <div style="max-height: 500px; overflow-y: auto;">
                        <table class="data-table" id="tabela-historico">
                            <thead>
                                <tr>
                                    <th style="width: 15%;">Data</th>
                                    <th style="width: 25%;">Cliente</th>
                                    <th style="width: 35%;">Serviço</th>
                                    <th style="width: 15%;">Valor</th>
                                    <th style="width: 100px;">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="lista-historico">
                                <tr><td colspan="5" style="text-align: center;">Carregando histórico...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            const now = new Date();
            const mesAtual = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
            document.getElementById('filtro-historico-mes').value = mesAtual;
            
            renderizarHistorico();
        }
        
        let historicoCompleto = []; 

        function renderizarHistorico() {
            const filtroMes = document.getElementById('filtro-historico-mes').value;
            const listaHistorico = document.getElementById('lista-historico');
            const resumoPeriodo = document.getElementById('resumo-periodo');
            const lucroTotalDisplay = document.getElementById('lucro-total');
            const contagemServicos = document.getElementById('contagem-servicos');

            listaHistorico.innerHTML = '<tr><td colspan="5" style="text-align: center;">Filtrando dados...</td></tr>';
            lucroTotalDisplay.textContent = 'R$ 0,00';
            contagemServicos.textContent = '0 serviços concluídos.';
            
            // Reúne dados de agendamentos e pacotes
            Promise.all([
                 new Promise(resolve => onValue(agendamentosRef, snapshot => resolve(snapshot.val()), { onlyOnce: true })),
                 new Promise(resolve => onValue(pacotesAtivosRef, snapshot => resolve(snapshot.val()), { onlyOnce: true }))
            ]).then(([agendamentos, pacotes]) => {
                
                historicoCompleto = [];
                let lucroTotal = 0;
                let contagem = 0;
                
                // 1. Processa Agendamentos Concluídos
                if (agendamentos) {
                     for (let id in agendamentos) {
                         const item = { id, source: 'agendamentos', ...agendamentos[id] };
                         if (item.status === 'Concluído' && !item.isPacoteUse) {
                             const dataReferencia = item.data;
                             if (filtroMes && dataReferencia.substring(0, 7) !== filtroMes) continue;

                             historicoCompleto.push(item);
                             lucroTotal += parseFloat(item.servicoPreco || 0);
                             contagem++;
                         }
                     }
                }
                
                // 2. Processa Pacotes Finalizados
                if (pacotes) {
                     for (let id in pacotes) {
                         const item = { id, source: 'pacotes_ativos', ...pacotes[id] };
                         if (item.status === 'Finalizado') {
                             const dataReferencia = item.dataFim; // Usa a data final como referência para o lucro
                             if (filtroMes && dataReferencia.substring(0, 7) !== filtroMes) continue;

                             historicoCompleto.push(item);
                             lucroTotal += parseFloat(item.servicoPreco || 0);
                             contagem++;
                         }
                     }
                }
                
                // Ordena por data (mais recente primeiro)
                historicoCompleto.sort((a, b) => {
                    const dataA = a.source === 'agendamentos' ? a.data : a.dataFim;
                    const dataB = b.source === 'agendamentos' ? b.data : b.dataFim;
                    return dataB.localeCompare(dataA);
                });
                
                // Atualiza o resumo
                lucroTotalDisplay.textContent = `R$ ${lucroTotal.toFixed(2).replace('.', ',')}`;
                contagemServicos.textContent = `${contagem} item(s) (serviço/pacote) concluído(s) no período.`;
                
                if (filtroMes) {
                     const [ano, mes] = filtroMes.split('-');
                     const data = new Date(ano, mes - 1);
                     resumoPeriodo.textContent = data.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
                } else {
                     resumoPeriodo.textContent = 'Todos os Tempos';
                }
                
                listaHistorico.innerHTML = '';
                
                if (historicoCompleto.length > 0) {
                     historicoCompleto.forEach(item => {
                         const row = listaHistorico.insertRow();
                         row.dataset.clienteNome = item.clienteNome.toLowerCase();
                         
                         const dataReferencia = item.source === 'agendamentos' ? item.data : item.dataFim;
                         
                         // Coluna Data (data-label "Data")
                         row.insertCell().setAttribute('data-label', 'Data');
                         row.cells[0].textContent = dataReferencia.split('-').reverse().join('/');
                         
                         // Coluna Cliente (data-label "Cliente")
                         row.insertCell().setAttribute('data-label', 'Cliente');
                         row.cells[1].innerHTML = `<strong>${item.clienteNome}</strong><br><small>${item.clienteTelefone}</small>`;
                         
                         // Coluna Serviço (data-label "Serviço")
                         row.insertCell().setAttribute('data-label', 'Serviço');
                         const tipo = item.source === 'pacotes_ativos' ? ' (Pacote Finalizado)' : '';
                         row.cells[2].textContent = item.servicoNome + tipo;
                         
                         // Coluna Valor (data-label "Valor")
                         row.insertCell().setAttribute('data-label', 'Valor');
                         const valorFormatado = parseFloat(item.servicoPreco).toFixed(2).replace('.', ',');
                         row.cells[3].textContent = `R$ ${valorFormatado}`;
                         
                         // Coluna Ações (Reverter)
                         const acoesCell = row.insertCell();
                         acoesCell.className = 'action-buttons';
                         
                         const btnReverter = document.createElement('button');
                         btnReverter.innerHTML = '<span class="material-icons" style="font-size: 18px;">undo</span> Reverter';
                         btnReverter.className = 'btn-danger';
                         btnReverter.title = item.source === 'agendamentos' ? 'Reverter para Ativo' : 'Reverter para Pacote Ativo';
                         btnReverter.onclick = () => reverterHistorico(item.id, item.source, item.clienteNome);
                         acoesCell.appendChild(btnReverter);
                     });
                     
                     filtrarHistoricoTabela(); 
                } else {
                     listaHistorico.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nenhum serviço/pacote concluído no período selecionado.</td></tr>';
                }
             });
        }
        
        // 6.1. REVERTER AGENDAMENTO/PACOTE (Voltar para Ativo)
        function reverterHistorico(id, source, clienteNome) {
             let message = '';
             let dbPath = '';
             let novoStatus = '';
             let successMessage = '';

             if (source === 'agendamentos') {
                 message = `Tem certeza que deseja reverter o agendamento individual de "${clienteNome}" de 'Concluído' para 'Ativo'?`;
                 dbPath = `agendamentos/${id}`;
                 novoStatus = 'Ativo';
                 successMessage = 'Agendamento individual revertido para Ativo.';
             } else if (source === 'pacotes_ativos') {
                 message = `Tem certeza que deseja reverter o pacote de "${clienteNome}" de 'Finalizado' para 'Ativo'?`;
                 dbPath = `pacotes_ativos/${id}`;
                 novoStatus = 'Ativo';
                 successMessage = 'Pacote revertido para Ativo.';
             } else {
                 return;
             }

             if (confirm(message)) {
                 update(ref(db, dbPath), { status: novoStatus })
                    .then(() => {
                        showNotification(successMessage, 'info');
                        renderizarHistorico(); 
                        carregarAgendamentos(); 
                        carregarPacotesAtivos(); 
                    })
                    .catch(error => {
                        showNotification('Erro ao reverter: ' + error.message, 'error');
                    });
            }
        }
        
        // 6.2. FILTRAR HISTÓRICO NA TABELA
        window.filtrarHistoricoTabela = function() {
             const filtro = document.getElementById('filtro-historico-cliente').value.toLowerCase();
             const listaHistorico = document.getElementById('lista-historico');
             const linhas = listaHistorico.getElementsByTagName('tr');

             for (let i = 0; i < linhas.length; i++) {
                 const row = linhas[i];
                 if (!row.dataset.clienteNome) continue; 

                 const clienteNome = row.dataset.clienteNome;
                
                 if (clienteNome.includes(filtro)) {
                     row.style.display = "block";
                 } else {
                     row.style.display = "none";
                 }
             }
        }
        
        // 6.3. RESETAR FILTRO DO HISTÓRICO
        window.resetFiltroHistorico = function() {
            document.getElementById('filtro-historico-mes').value = ''; 
            document.getElementById('filtro-historico-cliente').value = '';
            renderizarHistorico();
        }
        
        // Inicializa a exibição
        document.addEventListener('DOMContentLoaded', () => {
             // Mostra a tela de login ao carregar a página
            showLogin();
        });
    </script>
</body>
</html>
