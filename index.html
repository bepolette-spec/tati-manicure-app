<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tati Manicure - Gerenciamento de Agendamentos</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <style>
        :root {
            --primary-color: #ff8c6b; /* Cor de Destaque (Salmão/Coral) */
            --secondary-color: #6c757d; /* Cinza para secundários */
            --background-color: #f4f7f6; /* Fundo Suave */
            --sidebar-bg: #ffffff;
            --sidebar-hover-bg: #fff0eb; /* Fundo mais claro para hover */
            --text-color: #343a40; /* Texto Principal (Escuro) */
            --success-color: #28a745;
            --info-color: #17a2b8;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --border-color: #e9ecef;
            --shadow-color: rgba(0, 0, 0, 0.05);
        }

        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            min-height: 100vh;
        }

        /* Estrutura do App */
        #login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            background-color: var(--primary-color);
            min-height: 100vh;
        }

        .login-card {
            background: var(--sidebar-bg);
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 15px var(--shadow-color);
            text-align: center;
            width: 100%;
            max-width: 400px;
        }

        .login-card h1 {
            color: var(--primary-color);
            margin-bottom: 30px;
            font-size: 1.8rem;
        }

        #app-container {
            display: none; /* Escondido por padrão, mostrado após o login */
            width: 100%;
            /* display: flex; REMOVIDO PARA SER ATIVADO PELO JS */
        }

        /* Barra Lateral (Sidebar) */
        .sidebar {
            width: 250px;
            background-color: var(--sidebar-bg);
            box-shadow: 2px 0 5px var(--shadow-color);
            display: flex;
            flex-direction: column;
            padding: 20px 0;
            flex-shrink: 0;
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
            color: var(--primary-color);
            font-size: 1.6rem;
            font-weight: bold;
        }

        .sidebar ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar ul li a {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            text-decoration: none;
            color: var(--text-color);
            transition: background-color 0.2s, color 0.2s;
            font-weight: 500;
        }

        .sidebar ul li a:hover,
        .sidebar ul li a.active {
            background-color: var(--sidebar-hover-bg);
            color: var(--primary-color);
        }

        .sidebar ul li a .material-icons {
            margin-right: 10px;
            font-size: 20px;
        }

        .user-info {
            margin-top: auto;
            padding: 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .user-info p {
            margin: 0 0 10px 0;
            font-weight: bold;
        }

        /* Conteúdo Principal */
        .main-content {
            flex-grow: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .content-section {
            display: none;
            padding: 20px;
        }

        .content-section.active {
            display: block;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .section-header h2 {
            margin: 0;
            color: var(--text-color);
            font-size: 1.5rem;
        }
        
        /* Novas cores para Status de Pacote e Histórico */
        .status-package-paid {
             color: var(--success-color); 
             font-weight: bold;
        }
        .status-package-pending {
            color: var(--warning-color);
            font-weight: bold;
        }
        .status-package-active {
            color: var(--primary-color);
            font-weight: bold;
        }
        .status-package-finalized {
            color: var(--danger-color);
            font-weight: bold;
        }

        /* Cartão (Card) */
        .card {
            background: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 4px var(--shadow-color);
            margin-bottom: 20px;
        }
        
        /* NOVO V6: Abas dentro de uma seção */
        .tab-menu {
             display: flex;
             border-bottom: 2px solid var(--border-color);
             margin-bottom: 20px;
        }
        .tab-menu button {
             padding: 10px 20px;
             border: none;
             background: transparent;
             cursor: pointer;
             font-size: 1rem;
             color: var(--secondary-color);
             border-bottom: 2px solid transparent;
             transition: border-color 0.2s, color 0.2s;
             font-weight: bold;
        }
        .tab-menu button.active {
             color: var(--primary-color);
             border-bottom: 2px solid var(--primary-color);
        }
        .tab-content {
             padding-top: 10px;
        }
        .tab-pane {
             display: none;
        }
        .tab-pane.active {
             display: block;
        }

        /* Formulários */
        .form-group {
            margin-bottom: 15px;
        }

        .form-row {
            display: flex;
            gap: 20px;
        }

        .form-row > div {
            flex: 1;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 0.95rem;
        }

        input[type="text"],
        input[type="number"],
        input[type="email"],
        input[type="tel"],
        input[type="date"],
        input[type="time"],
        textarea,
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        /* Datalist input */
        input[list] {
            /* Estilo para garantir que o input datalist se pareça com um campo normal */
            background-image: none;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="email"]:focus,
        input[type="tel"]:focus,
        input[type="date"]:focus,
        input[type="time"]:focus,
        textarea:focus,
        select:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        textarea {
            resize: vertical;
        }

        /* Botões */
        button, .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: background-color 0.2s, opacity 0.2s;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #e57a5e;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #218838;
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: var(--text-color);
        }

        .btn-warning:hover {
            background-color: #ffb547;
        }


        /* Tabelas */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table thead tr {
            background-color: var(--primary-color);
            color: white;
            text-align: left;
        }

        .data-table th, .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table tbody tr:hover {
            background-color: var(--sidebar-hover-bg);
        }

        .data-table td.action-buttons button {
            margin-right: 5px;
            padding: 6px 8px;
        }

        /* CORREÇÃO: Aumenta o espaço para os botões para evitar quebras de linha em telas maiores */
        .data-table td.action-buttons {
            white-space: nowrap;
            width: 280px; /* Garante espaço suficiente */
        }

        /* Notificação */
        #notification-bar {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s, transform 0.3s;
            transform: translateY(-20px);
            z-index: 1000;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            font-weight: bold;
        }

        #notification-bar.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        #notification-bar.success { background-color: var(--success-color); }
        #notification-bar.error { background-color: var(--danger-color); }
        #notification-bar.info { background-color: var(--info-color); }

        /* Utilitários */
        .flex-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .input-group {
            display: flex;
            gap: 10px;
        }
        
        .input-group input, .input-group select {
            flex-grow: 1;
        }

        .filter-row {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            margin-bottom: 20px;
        }
        .filter-row > div {
            flex: 1;
        }
        .filter-row button {
            flex-grow: 0;
            flex-shrink: 0;
            padding: 9px 15px; /* Ajuste para alinhar com o input */
        }
        
        /* NOVO V6: Estilos para a Tabela de Visão Diária */
        .table-responsive {
             overflow-x: auto;
        }
        #tabela-visao-diaria {
             border: 1px solid var(--border-color);
             margin-top: 0;
        }
        #tabela-visao-diaria thead tr {
             background-color: var(--secondary-color);
        }
        #tabela-visao-diaria td {
             height: 40px; /* Altura padrão para cada intervalo de 30 min */
             font-size: 0.9rem;
             vertical-align: top;
        }
        .horario-celula {
             width: 80px;
             font-weight: bold;
             background-color: var(--sidebar-hover-bg);
             color: var(--text-color);
             text-align: center;
             vertical-align: middle !important;
             border-right: 1px solid var(--border-color);
        }
        .agendamento-vago {
             background-color: #f7fff7; /* Verde clarinho */
             color: var(--success-color);
             font-weight: bold;
             font-style: italic;
             text-align: center;
             line-height: 40px;
        }
        .agendamento-ocupado {
             background-color: #fff0eb; /* Fundo do hover de sidebar, suave */
             color: var(--text-color);
             font-weight: 500;
             padding: 5px 10px !important;
             vertical-align: middle !important;
             line-height: 1.2;
             border-left: 5px solid var(--primary-color);
             cursor: pointer;
        }
        .agendamento-ocupado strong {
             color: var(--primary-color);
             font-weight: bold;
        }
        
        /* --------------------------------------------------- */
        /* RESPONSIVIDADE MOBILE (Mobile First - Portrait Mode)*/
        /* --------------------------------------------------- */
        @media (max-width: 768px) {
            
            /* Estrutura Principal */
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
                box-shadow: 0 0 5px var(--shadow-color);
            }

            .main-content {
                padding: 15px;
            }

            #app-container {
                flex-direction: column;
            }

            /* Navegação Horizontal */
            .sidebar ul {
                display: flex;
                flex-wrap: nowrap; /* Tenta manter em uma linha, mas permite rolagem */
                overflow-x: auto;
                justify-content: flex-start;
                border-bottom: 1px solid var(--border-color);
            }

            .sidebar ul li {
                flex-shrink: 0; /* Impede que os itens encolham */
                text-align: center;
            }

            .sidebar ul li a {
                justify-content: center;
                padding: 10px;
                flex-direction: column;
                font-size: 0.75rem;
                white-space: nowrap;
            }

            .sidebar ul li a .material-icons {
                margin-right: 0;
                margin-bottom: 5px;
                font-size: 20px;
            }

            /* FIX: Botão Sair visível no celular */
            .user-info {
                display: block;
                padding: 10px 15px;
                border-top: none; 
                text-align: center; 
            }

            .user-info p {
                display: none; /* Esconde o texto "Olá, Tati!" para economizar espaço */
            }

            .user-info button {
                width: 100%;
                margin-top: 10px; 
                font-size: 0.9rem;
            }
            
            /* 1. Correção de Formulários e Filtros (Empilhamento) */
            .form-row, .filter-row {
                flex-direction: column;
                gap: 0; /* Remove gap quando empilha */
            }

            .form-row > div, 
            .filter-row > div {
                flex: 0 0 100% !important; /* Força largura total */
                width: 100%;
            }
            
            /* Ajusta margem para inputs empilhados */
            .form-group, .filter-row > div {
                margin-bottom: 10px;
            }
            
            .filter-row button {
                width: 100%;
                margin-top: 5px; 
                padding: 10px 15px !important;
            }
            
            /* V6: Ajuste para a Tabela de Visão Diária */
            #tabela-visao-diaria {
                 width: 100%;
                 min-width: 300px; /* Garante que não fique muito esmagada */
            }
            #tabela-visao-diaria td {
                 padding: 5px 10px !important;
            }

            /* 2. Correção de Tabelas (Cartão-like View) */
            .data-table, .data-table tbody, .data-table td, .data-table tr {
                display: block; /* Força elementos da tabela a empilhar */
            }

            .data-table thead {
                display: none; /* Esconde o cabeçalho original */
            }

            .data-table tr {
                border: 1px solid var(--border-color);
                margin-bottom: 15px;
                border-radius: 8px;
                box-shadow: 0 1px 3px var(--shadow-color);
                padding: 10px;
            }

            .data-table td {
                border: none;
                position: relative;
                padding-left: 50% !important; /* Espaço para o rótulo */
                text-align: right; /* Alinha o valor à direita */
                white-space: normal; /* Permite quebras de linha */
                min-height: 40px;
            }

            /* Rótulo customizado (que usa o data-label do JS) */
            .data-table td::before {
                content: attr(data-label);
                position: absolute;
                left: 10px;
                width: 45%; 
                padding-right: 10px;
                white-space: nowrap;
                text-align: left;
                font-weight: bold;
                color: var(--primary-color);
            }
            
            /* FIX V6: Organização dos botões de ação em mobile */
            /* Garante que o rótulo "Ações" não sobreponha o primeiro botão */
            .data-table td.action-buttons {
                text-align: left;
                padding-left: 10px !important;
                display: flex; 
                flex-direction: column; /* Empilha os botões */
                gap: 5px;
                width: 100% !important; /* Garante que ocupe a largura total no mobile */
            }
            
            .data-table td.action-buttons::before {
                content: "Ações";
                width: 100%; 
                margin-bottom: 5px;
                display: block;
            }
            
            .data-table td.action-buttons button {
                margin: 0;
                width: 100%; /* Ocupa a largura toda */
                max-width: 100%;
                box-sizing: border-box;
                font-size: 0.9rem; 
                padding: 8px 5px;
            }
        }
    </style>
</head>
<body>

    <div id="notification-bar"></div>

    <div id="login-container">
        <div class="login-card">
            <h1>Tati Manicure - Acesso</h1>
            <form id="login-form">
                <div class="form-group">
                    <label for="loginSenha">Senha de Acesso</label>
                    <input type="password" id="loginSenha" required>
                </div>
                <button type="submit" class="btn-primary" style="width: 100%; margin-top: 10px;">
                    <span class="material-icons">login</span> Entrar
                </button>
            </form>
        </div>
    </div>

    <datalist id="clientes-datalist"></datalist>

    <div id="app-container">
        
        <aside class="sidebar">
            <div class="logo">TATI MANICURE APP</div>
            
            <ul>
                <li><a href="#" data-section="agenda" class="active"><span class="material-icons">calendar_today</span> Agenda</a></li>
                <li><a href="#" data-section="clientes"><span class="material-icons">people</span> Clientes</a></li>
                <li><a href="#" data-section="servicos"><span class="material-icons">local_offer</span> Serviços</a></li>
                <li><a href="#" data-section="historico"><span class="material-icons">history</span> Histórico/Lucros</a></li>
            </ul>

            
            <div class="user-info">
                <p id="userInfo">Olá, Tati!</p>
                <button id="logout-button" class="btn-danger" style="width: 100%;">
                    <span class="material-icons">logout</span> Sair
                </button>
            </div>
        </aside>

        <main class="main-content">

            <div id="agenda-section" class="content-section active">
                
                <div class="tab-menu">
                     <button class="tab-button active" onclick="showAgendaTab('pacotes-ativos')">Pacotes Ativos</button>
                     <button class="tab-button" onclick="showAgendaTab('novo-agendamento')">Novo Agendamento</button>
                     <button class="tab-button" onclick="showAgendaTab('lista-agendamentos')">Próx. Agendamentos</button>
                     <button class="tab-button" onclick="showAgendaTab('visao-diaria')">Visão Diária</button>
                </div>
                
                <div class="tab-content">
                    
                    <div id="pacotes-ativos-pane" class="tab-pane active">
                         <div class="section-header"><h2>Gerenciamento de Pacotes Ativos</h2></div>
                         <div class="card">
                            <form id="pacote-inicio-form">
                                <h3>Iniciar Novo Pacote de Serviços</h3>
                                <div class="form-row">
                                    <div class="form-group" style="flex: 2;">
                                        <label for="pacote-cliente-id">Cliente</label>
                                        <select id="pacote-cliente-id" required></select>
                                    </div>
                                    <div class="form-group" style="flex: 2;">
                                        <label for="pacote-servico-id">Pacote (Serviços marcados como Pacote)</label>
                                        <select id="pacote-servico-id" required></select>
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label for="pacote-data-inicio">Data Início (Geralmente Hoje)</label>
                                        <input type="date" id="pacote-data-inicio" required>
                                    </div>
                                </div>
                                <div class="flex-container">
                                    <button type="submit" class="btn-primary">
                                        <span class="material-icons">add_box</span> Iniciar/Vender Pacote
                                    </button>
                                </div>
                            </form>
                            
                            <hr style="margin: 20px 0;">

                            <h3>Pacotes Ativos e Utilização</h3>
                            <div style="max-height: 500px; overflow-y: auto;">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 20%;">Cliente</th>
                                            <th style="width: 25%;">Pacote (Total/Usado)</th>
                                            <th style="width: 15%;">Pagamento</th>
                                            <th style="width: 15%;">Vencimento</th>
                                            <th style="width: 280px;">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="lista-pacotes-ativos">
                                        <tr><td colspan="5" style="text-align: center;">Carregando pacotes ativos...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                         </div>
                         
                         <div id="pacote-utilizacao-modal" class="card" style="display: none; margin-top: 20px;">
                             <h3>Utilizar Serviço de Pacote</h3>
                             <form id="pacote-utilizacao-form">
                                 <input type="hidden" id="utilizacao-pacote-id">
                                 <div class="form-row">
                                     <div class="form-group" style="flex: 2;">
                                         <label for="utilizacao-servico-id">Serviço do Pacote</label>
                                         <select id="utilizacao-servico-id" required></select>
                                     </div>
                                     <div class="form-group" style="flex: 1;">
                                         <label for="utilizacao-data">Data</label>
                                         <input type="date" id="utilizacao-data" required>
                                     </div>
                                     <div class="form-group" style="flex: 1;">
                                         <label for="utilizacao-hora">Hora Início</label>
                                         <input type="time" id="utilizacao-hora" required>
                                     </div>
                                 </div>
                                 <div class="form-row">
                                     <div class="form-group" style="flex: 1;">
                                        <label for="utilizacao-hora-fim">Hora Fim</label> 
                                        <input type="time" id="utilizacao-hora-fim" required> 
                                     </div>
                                     <div class="form-group" style="flex: 3;">
                                         <label for="utilizacao-observacoes">Observações (Opcional)</label>
                                         <input type="text" id="utilizacao-observacoes">
                                     </div>
                                 </div>
                                 <div class="flex-container">
                                     <div>
                                         <button type="submit" class="btn-warning">
                                             <span class="material-icons">check_circle</span> Utilizar Serviço do Pacote
                                         </button>
                                         <button type="button" class="btn-secondary" onclick="hidePacoteUtilizacao()">
                                             <span class="material-icons">close</span> Cancelar
                                         </button>
                                     </div>
                                 </div>
                             </form>
                         </div>
                    </div>

                    <div id="novo-agendamento-pane" class="tab-pane">
                        <div class="section-header"><h2>Agendamento de Serviços Individuais (Não-Pacote)</h2></div>
                        <div class="card">
                            <form id="agendamento-form">
                                <input type="hidden" id="agendamento-id">
                                <div class="form-row">
                                    <div class="form-group" style="flex: 2;">
                                        <label for="agenda-cliente-id">Cliente</label>
                                        <select id="agenda-cliente-id" required></select>
                                    </div>
                                    <div class="form-group" style="flex: 2;">
                                        <label for="agenda-servico-id">Serviço Individual/Promoção</label>
                                        <select id="agenda-servico-id" required></select>
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label for="agenda-data">Data</label>
                                        <input type="date" id="agenda-data" required>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group" style="flex: 1;">
                                        <label for="agenda-hora">Hora Início</label>
                                        <input type="time" id="agenda-hora" required>
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label for="agenda-hora-fim">Hora Fim</label>
                                        <input type="time" id="agenda-hora-fim" required>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="agenda-observacoes">Observações</label>
                                    <textarea id="agenda-observacoes" rows="2"></textarea>
                                </div>
                                <div class="flex-container">
                                    <div>
                                        <button type="submit" class="btn-success" id="btn-salvar-agendamento">
                                            <span class="material-icons">save</span> Salvar Agendamento
                                        </button>
                                        <button type="button" class="btn-secondary" onclick="resetAgendamentoForm()">
                                            <span class="material-icons">refresh</span> Limpar
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div id="lista-agendamentos-pane" class="tab-pane">
                        <div class="section-header">
                            <h3>Próximos Agendamentos (Serviços Individuais e Pacotes Agendados)</h3>
                        </div>
                        <div class="card">
                            <div class="filter-row">
                                <div style="flex-grow: 1.5;">
                                    <label for="filtro-agenda-data">Filtrar por Data</label>
                                    <input type="date" id="filtro-agenda-data" onchange="carregarAgendamentos()">
                                </div>
                                <div style="flex-grow: 3;">
                                    <label for="filtro-agenda-cliente">Filtrar por Cliente (Digite ou Selecione)</label>
                                    <input type="text" id="filtro-agenda-cliente" list="clientes-datalist" placeholder="Digite o nome do cliente..." onkeyup="filtrarAgendamentos()">
                                </div>
                                <button class="btn-secondary" onclick="resetFiltroAgenda()"><span class="material-icons">refresh</span> Resetar Filtro</button>
                            </div>
                            <div style="max-height: 500px; overflow-y: auto;">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 15%;">Data/Hora</th>
                                            <th style="width: 25%;">Cliente</th>
                                            <th style="width: 25%;">Serviço</th>
                                            <th>Status</th>
                                            <th style="width: 280px;">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="lista-agendamentos">
                                        <tr><td colspan="5" style="text-align: center;">Carregando agendamentos...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div id="visao-diaria-pane" class="tab-pane">
                        <div class="section-header">
                            <h2>Visão Diária da Agenda</h2>
                        </div>
                        <div class="card">
                            <div class="filter-row">
                                <div style="flex-grow: 1;">
                                    <label for="filtro-visao-diaria-data">Selecione a Data</label>
                                    <input type="date" id="filtro-visao-diaria-data" onchange="renderizarVisaoDiaria()">
                                </div>
                                <button class="btn-secondary" onclick="renderizarVisaoDiaria(today)"><span class="material-icons">today</span> Ver Hoje</button>
                            </div>
                            <div class="table-responsive">
                                <table class="data-table" id="tabela-visao-diaria">
                                    <thead>
                                        <tr>
                                            <th style="width: 100px;">Horário</th>
                                            <th>Detalhes do Agendamento</th>
                                        </tr>
                                    </thead>
                                    <tbody id="lista-visao-diaria">
                                        <tr><td colspan="2" style="text-align: center;">Selecione uma data para visualizar.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="clientes-section" class="content-section">
                <div class="section-header"><h2>Cadastro de Clientes</h2></div>
                <div class="card">
                    <form id="cliente-form">
                        <input type="hidden" id="cliente-id">
                        <div class="form-row">
                            <div class="form-group" style="flex: 2;">
                                <label for="cliente-nome">Nome Completo</label>
                                <input type="text" id="cliente-nome" required>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label for="cliente-telefone">Telefone (Whatsapp)</label>
                                <input type="tel" id="cliente-telefone">
                            </div>
                        </div>
                        <div class="form-group" style="display: none;">
                            <label for="cliente-email">E-mail (Opcional)</label>
                            <input type="email" id="cliente-email">
                        </div>
                        <div class="form-group">
                            <label for="cliente-endereco">Endereço (Opcional)</label>
                            <input type="text" id="cliente-endereco">
                        </div>
                        <div class="form-group">
                            <label for="cliente-observacoes">Observações (Alergias, Preferências)</label>
                            <textarea id="cliente-observacoes" rows="2"></textarea>
                        </div>
                        <div class="flex-container">
                            <div>
                                <button type="submit" class="btn-success" id="btn-salvar-cliente">
                                    <span class="material-icons">save</span> Salvar Cliente
                                </button>
                                <button type="button" class="btn-secondary" onclick="resetClienteForm()">
                                    <span class="material-icons">refresh</span> Limpar
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
                
                <div class="section-header">
                    <h3>Lista de Clientes Cadastrados</h3>
                    <div class="input-group" style="width: 300px;">
                        <input type="text" id="filtro-clientes" list="clientes-datalist" placeholder="Filtrar por nome, tel ou email..." onkeyup="filtrarClientes()">
                    </div>
                </div>
                <div class="card">
                    <div style="max-height: 500px; overflow-y: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th style="width: 30%;">Nome</th>
                                    <th style="width: 20%;">Telefone</th>
                                    <th style="width: 30%;">Endereço</th>
                                    <th style="width: 150px;">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="lista-clientes">
                                <tr><td colspan="4" style="text-align: center;">Carregando clientes...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="servicos-section" class="content-section">
                <div class="section-header"><h2>Cadastro de Serviços/Pacotes</h2></div>
                <div class="card">
                    <form id="servico-form">
                        <input type="hidden" id="servico-id">
                        <div class="form-row">
                            <div class="form-group" style="flex: 2;">
                                <label for="servico-nome">Nome do Serviço</label>
                                <input type="text" id="servico-nome" required>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label for="servico-preco">Preço (R$)</label>
                                <input type="number" id="servico-preco" step="0.01" min="0" required value="0.00">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <label>
                                    <input type="checkbox" id="servico-isPacote"> É um **Pacote Mensal**?
                                </label>
                            </div>
                            <div class="form-group" id="group-quantidade-total" style="flex: 1; display: none;">
                                <label for="servico-quantidade-total">Quantidade Total de Usos</label>
                                <input type="number" id="servico-quantidade-total" min="1" step="1" value="4">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="servico-observacoes">Descrição/Observações</label>
                            <textarea id="servico-observacoes" rows="2"></textarea>
                        </div>
                        <div class="flex-container">
                            <div>
                                <button type="submit" class="btn-success" id="btn-salvar-servico">
                                    <span class="material-icons">save</span> Salvar Serviço
                                </button>
                                <button type="button" class="btn-secondary" onclick="resetServicoForm()">
                                    <span class="material-icons">refresh</span> Limpar
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
                
                <div class="section-header">
                    <h3>Lista de Serviços Cadastrados</h3>
                    <div class="input-group" style="width: 300px;">
                        <input type="text" id="filtro-servicos" placeholder="Filtrar por nome..." onkeyup="filtrarServicos()">
                    </div>
                </div>
                <div class="card">
                    <div style="max-height: 500px; overflow-y: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th style="width: 30%;">Nome</th>
                                    <th style="width: 15%;">Preço</th>
                                    <th style="width: 15%;">Tipo</th>
                                    <th style="width: 300px;">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="lista-servicos">
                                <tr><td colspan="4" style="text-align: center;">Carregando serviços...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="historico-section" class="content-section">
                <div class="section-header">
                    <h2>Histórico de Agendamentos e Lucros</h2>
                </div>
                <div class="card">
                     <div class="filter-row">
                        <div style="flex-grow: 1;">
                            <label for="filtro-historico-mes">Filtrar por Mês/Ano</label>
                            <input type="month" id="filtro-historico-mes" onchange="renderizarHistorico()">
                        </div>
                        <div style="flex-grow: 2;">
                            <label for="filtro-historico-cliente">Filtrar por Cliente</label>
                            <input type="text" id="filtro-historico-cliente" list="clientes-datalist" placeholder="Digite o nome do cliente..." onkeyup="filtrarHistoricoTabela()">
                        </div>
                        <button class="btn-secondary" onclick="resetFiltroHistorico()"><span class="material-icons">refresh</span> Resetar Filtro</button>
                    </div>

                    <h3 style="margin-top: 0;">Resumo Financeiro Mensal</h3>
                    <div id="resumo-mensal" class="card" style="background-color: var(--sidebar-hover-bg); padding: 15px;">
                        <p>Total de Lucro no Mês: <strong id="total-lucro" style="color: var(--success-color);">R$ 0,00</strong></p>
                        <p style="font-size: 0.9em; color: var(--secondary-color);">*Apenas serviços individuais/promoções contam no lucro.</p>
                    </div>

                    <div style="max-height: 500px; overflow-y: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th style="width: 15%;">Data/Hora</th>
                                    <th style="width: 20%;">Cliente</th>
                                    <th style="width: 25%;">Serviço/Pacote</th>
                                    <th style="width: 15%;">Tipo</th>
                                    <th style="width: 15%;">Valor</th>
                                    <th style="width: 280px;">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="lista-historico">
                                <tr><td colspan="6" style="text-align: center;">Selecione um mês para carregar o histórico.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        // ----------------------------------------------------------------------------------
        // 1. CONFIGURAÇÃO E VARIÁVEIS GLOBAIS
        // ----------------------------------------------------------------------------------
        
        // **ATENÇÃO: SUBSTITUA COM AS SUAS CHAVES DO FIREBASE**
        const firebaseConfig = {
            apiKey: "SUA_API_KEY",
            authDomain: "SEU_AUTH_DOMAIN",
            projectId: "SEU_PROJECT_ID",
            storageBucket: "SEU_STORAGE_BUCKET",
            messagingSenderId: "SEU_MESSAGING_SENDER_ID",
            appId: "SEU_APP_ID"
        };
        
        // Inicializa o Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Variáveis de cache para as listas (para evitar múltiplas chamadas ao Firebase)
        let listaClientes = [];
        let listaServicos = [];
        let listaPacotesAtivos = [];
        let listaMovimentacoes = []; // Contém agendamentos futuros (status: agendado/confirmado) e históricos (status: realizado/cancelado)
        
        const senhaAcesso = '12345'; // Senha de acesso para o login
        const today = new Date().toISOString().split('T')[0];
        
        // Variável global para armazenar a duração de serviços (removida do form, mas útil se voltar)
        // Como o campo 'duração' foi removido, a duração será calculada pela diferença entre hora inicial e final.
        
        // ----------------------------------------------------------------------------------
        // 2. FUNÇÕES GERAIS / UTILITÁRIOS
        // ----------------------------------------------------------------------------------

        function showNotification(message, type = 'info', duration = 3000) {
            const bar = document.getElementById('notification-bar');
            bar.textContent = message;
            bar.className = `show ${type}`;
            setTimeout(() => {
                bar.className = bar.className.replace('show', '');
            }, duration);
        }

        // Formata data para dd/mm/aaaa
        function formatarData(dataISO) {
            if (!dataISO) return '';
            const [year, month, day] = dataISO.split('-');
            return `${day}/${month}/${year}`;
        }
        
        // Formata data e hora para exibição
        function formatarDataHora(dataISO, hora) {
            return `${formatarData(dataISO)} às ${hora}`;
        }
        
        // Formata data e hora para exibição na Visão Diária
        function formatarDataHoraVisaoDiaria(dataISO, hora, horaFim) {
             const horaInicio = hora ? hora.substring(0, 5) : 'N/A';
             const horaFinal = horaFim ? horaFim.substring(0, 5) : 'N/A';
             return `${formatarData(dataISO)} | ${horaInicio} - ${horaFinal}`;
        }

        // ----------------------------------------------------------------------------------
        // 3. NAVEGAÇÃO / ROTAS
        // ----------------------------------------------------------------------------------

        // 3.1. GERENCIAR AS SEÇÕES PRINCIPAIS
        window.showSection = async function(sectionId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');

            document.querySelectorAll('.sidebar ul li a').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector(`.sidebar ul li a[data-section="${sectionId.replace('-section', '')}"]`).classList.add('active');

            // Recarregar dados específicos da seção
            if (sectionId === 'agenda-section') {
                showAgendaTab('pacotes-ativos'); // Redireciona para a aba correta
            } else if (sectionId === 'clientes-section') {
                await carregarClientes();
            } else if (sectionId === 'servicos-section') {
                await carregarServicos();
            } else if (sectionId === 'historico-section') {
                renderizarHistorico(); // Carrega histórico padrão (mês atual)
            }
        }
        
        // 3.2. GERENCIAR AS ABAS DA AGENDA
        window.showAgendaTab = async function(tabId) {
             document.querySelectorAll('.tab-pane').forEach(pane => {
                 pane.classList.remove('active');
             });
             document.getElementById(tabId + '-pane').classList.add('active');

             document.querySelectorAll('.tab-button').forEach(button => {
                 button.classList.remove('active');
             });
             document.querySelector(`.tab-menu button[onclick="showAgendaTab('${tabId}')"]`).classList.add('active');
             
             if (tabId === 'pacotes-ativos') {
                 await carregarPacotesAtivos();
                 await carregarClientes(true); // Recarrega clientes apenas para o select
                 await carregarServicos(true); // Recarrega serviços apenas para o select
             } else if (tabId === 'novo-agendamento') {
                 await carregarClientes(true);
                 await carregarServicos(true, false); // Apenas serviços individuais
                 resetAgendamentoForm();
             } else if (tabId === 'lista-agendamentos') {
                 // Esta view agora lista *todos* os agendamentos futuros (individual e pacote)
                 await carregarMovimentacoes(); 
                 await carregarClientes(true); // Para o datalist/filtro
                 carregarAgendamentos();
             } else if (tabId === 'visao-diaria') {
                 // A Visão Diária precisa de todas as movimentações
                 document.getElementById('filtro-visao-diaria-data').value = today;
                 await carregarMovimentacoes(); 
                 renderizarVisaoDiaria(today);
             }
        }

        // ----------------------------------------------------------------------------------
        // 4. MÓDULO DE DADOS (FIREBASE)
        // ----------------------------------------------------------------------------------

        // 4.1. CARREGAR CLIENTES (LISTA GERAL)
        window.carregarClientes = async function(isSelect = false) {
            try {
                if (!isSelect || listaClientes.length === 0) {
                    const snapshot = await db.collection('clientes').get();
                    listaClientes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                }

                if (isSelect) {
                    renderizarSelects('cliente', listaClientes);
                } else {
                    renderizarClientes();
                }
            } catch (error) {
                console.error("Erro ao carregar clientes: ", error);
                showNotification('Erro ao carregar clientes.', 'error');
            }
        }
        
        // 4.2. CARREGAR SERVIÇOS (LISTA GERAL)
        window.carregarServicos = async function(isSelect = false, isPacote = null) {
            try {
                if (!isSelect || listaServicos.length === 0) {
                    const snapshot = await db.collection('servicos').get();
                    listaServicos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                }
                
                const servicosFiltrados = listaServicos.filter(s => {
                    if (isPacote === true) return s.isPacote;
                    if (isPacote === false) return !s.isPacote;
                    return true;
                });
                
                if (isSelect) {
                    renderizarSelects('servico', servicosFiltrados, isPacote);
                } else {
                    renderizarServicos();
                }

            } catch (error) {
                console.error("Erro ao carregar serviços: ", error);
                showNotification('Erro ao carregar serviços.', 'error');
            }
        }

        // 4.3. CARREGAR PACOTES ATIVOS (LISTA GERAL)
        window.carregarPacotesAtivos = async function() {
            try {
                 // Filtra por pacotes com status 'ativo'
                 const snapshot = await db.collection('pacotes').where('status', '==', 'ativo').get();
                 listaPacotesAtivos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                 
                 // Busca todos os clientes e serviços para enriquecer os dados
                 await carregarClientes(false);
                 await carregarServicos(false);
                 
                 // Adiciona nome do cliente e serviço
                 listaPacotesAtivos.forEach(pacote => {
                    const cliente = listaClientes.find(c => c.id === pacote.clienteId);
                    const servico = listaServicos.find(s => s.id === pacote.servicoId);
                    pacote.clienteNome = cliente ? cliente.nome : 'Cliente Não Encontrado';
                    pacote.servicoNome = servico ? servico.nome : 'Serviço Não Encontrado';
                 });
                 
                 renderizarPacotesAtivos();
            } catch (error) {
                console.error("Erro ao carregar pacotes ativos: ", error);
                showNotification('Erro ao carregar pacotes ativos.', 'error');
            }
        }

        // 4.4. CARREGAR MOVIMENTAÇÕES (AGENDAMENTOS E USO DE PACOTES)
        window.carregarMovimentacoes = async function() {
            try {
                 const snapshot = await db.collection('movimentacoes').get();
                 listaMovimentacoes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                 
                 // As movimentações já devem conter os nomes do cliente e serviço.
                 // Garante que o cache de clientes e serviços está atualizado para o caso de precisar
                 await carregarClientes(false);
                 await carregarServicos(false);

            } catch (error) {
                console.error("Erro ao carregar movimentações: ", error);
                showNotification('Erro ao carregar agendamentos e histórico.', 'error');
            }
        }
        
        // ----------------------------------------------------------------------------------
        // 5. MÓDULO DE CLIENTES
        // ----------------------------------------------------------------------------------
        
        // 5.1. SALVAR/ATUALIZAR CLIENTE
        document.getElementById('cliente-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('cliente-id').value;
            const nome = document.getElementById('cliente-nome').value.trim();
            const telefone = document.getElementById('cliente-telefone').value.trim();
            const email = document.getElementById('cliente-email').value.trim();
            const endereco = document.getElementById('cliente-endereco').value.trim();
            const observacoes = document.getElementById('cliente-observacoes').value.trim();

            const clienteData = {
                nome: nome,
                telefone: telefone,
                email: email,
                endereco: endereco,
                observacoes: observacoes,
                dataAtualizacao: new Date().toISOString()
            };

            try {
                if (id) {
                    await db.collection('clientes').doc(id).update(clienteData);
                    showNotification('Cliente atualizado com sucesso!', 'success');
                } else {
                    clienteData.dataCriacao = new Date().toISOString();
                    await db.collection('clientes').add(clienteData);
                    showNotification('Cliente salvo com sucesso!', 'success');
                }
                resetClienteForm();
                await carregarClientes();
            } catch (error) {
                console.error("Erro ao salvar cliente: ", error);
                showNotification(`Erro ao salvar cliente: ${error.message}`, 'error');
            }
        });

        // 5.2. FUNÇÕES DE RENDERIZAÇÃO E EDIÇÃO
        window.renderizarClientes = function() {
            const lista = document.getElementById('lista-clientes');
            lista.innerHTML = '';
            if (listaClientes.length === 0) {
                lista.innerHTML = '<tr><td colspan="4" style="text-align: center;">Nenhum cliente cadastrado.</td></tr>';
                return;
            }

            listaClientes.sort((a, b) => a.nome.localeCompare(b.nome)).forEach(cliente => {
                const row = lista.insertRow();
                row.dataset.clienteNome = cliente.nome.toLowerCase(); // Para filtro
                
                // Aplica data-label para responsividade mobile
                row.insertCell().innerHTML = cliente.nome;
                row.cells[0].setAttribute('data-label', 'Nome');
                row.insertCell().innerHTML = cliente.telefone || '-';
                row.cells[1].setAttribute('data-label', 'Telefone');
                row.insertCell().innerHTML = cliente.endereco || '-';
                row.cells[2].setAttribute('data-label', 'Endereço');

                const actionsCell = row.insertCell();
                actionsCell.classList.add('action-buttons');
                actionsCell.innerHTML = `
                    <button class="btn-primary" onclick="editarCliente('${cliente.id}')"><span class="material-icons">edit</span> Editar</button>
                    <button class="btn-danger" onclick="excluirCliente('${cliente.id}')"><span class="material-icons">delete</span> Excluir</button>
                    <a href="https://wa.me/55${cliente.telefone.replace(/\D/g, '')}" target="_blank" class="btn btn-success"><span class="material-icons">whatsapp</span> Msg</a>
                `;
            });
            // Popula o datalist para o filtro em outras telas
            popularDatalistClientes(listaClientes);
        }

        window.editarCliente = function(id) {
            const cliente = listaClientes.find(c => c.id === id);
            if (cliente) {
                document.getElementById('cliente-id').value = cliente.id;
                document.getElementById('cliente-nome').value = cliente.nome;
                document.getElementById('cliente-telefone').value = cliente.telefone;
                document.getElementById('cliente-email').value = cliente.email;
                document.getElementById('cliente-endereco').value = cliente.endereco;
                document.getElementById('cliente-observacoes').value = cliente.observacoes;
                document.getElementById('btn-salvar-cliente').innerHTML = '<span class="material-icons">update</span> Atualizar Cliente';
                showSection('clientes-section'); // Garante que a seção esteja visível
            }
        }
        
        window.resetClienteForm = function() {
            document.getElementById('cliente-form').reset();
            document.getElementById('cliente-id').value = '';
            document.getElementById('btn-salvar-cliente').innerHTML = '<span class="material-icons">save</span> Salvar Cliente';
        }

        window.excluirCliente = async function(id) {
            if (confirm('Tem certeza que deseja excluir este cliente?')) {
                try {
                    await db.collection('clientes').doc(id).delete();
                    showNotification('Cliente excluído com sucesso.', 'success');
                    await carregarClientes();
                } catch (error) {
                    console.error("Erro ao excluir cliente: ", error);
                    showNotification(`Erro ao excluir cliente: ${error.message}`, 'error');
                }
            }
        }
        
        // 5.3. FILTROS
        window.filtrarClientes = function() {
            const filtro = document.getElementById('filtro-clientes').value.toLowerCase();
            const lista = document.getElementById('lista-clientes');
            const linhas = lista.getElementsByTagName('tr');

            for (let i = 0; i < linhas.length; i++) {
                const row = linhas[i];
                if (!row.dataset.clienteNome) continue; 
                
                // Filtra por nome, telefone ou endereço (simplesmente verificando o innerHTML)
                const textContent = row.textContent.toLowerCase();
                
                if (textContent.includes(filtro)) {
                     // Em desktop é 'table-row', em mobile é 'block'
                     row.style.display = window.innerWidth > 768 ? "table-row" : "block"; 
                } else {
                    row.style.display = "none";
                }
            }
        }
        
        // 5.4. DATALIST PARA FILTROS
        function popularDatalistClientes(clientes) {
             const datalist = document.getElementById('clientes-datalist');
             datalist.innerHTML = '';
             clientes.forEach(cliente => {
                 const option = document.createElement('option');
                 option.value = cliente.nome;
                 datalist.appendChild(option);
             });
        }
        
        // ----------------------------------------------------------------------------------
        // 6. MÓDULO DE SERVIÇOS/PACOTES
        // ----------------------------------------------------------------------------------
        
        // 6.1. TOGGLE PACOTE INPUT
        document.getElementById('servico-isPacote').addEventListener('change', (e) => {
             const group = document.getElementById('group-quantidade-total');
             if (e.target.checked) {
                 group.style.display = 'flex';
             } else {
                 group.style.display = 'none';
             }
        });

        // 6.2. SALVAR/ATUALIZAR SERVIÇO
        document.getElementById('servico-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('servico-id').value;
            const nome = document.getElementById('servico-nome').value.trim();
            const preco = parseFloat(document.getElementById('servico-preco').value);
            const isPacote = document.getElementById('servico-isPacote').checked;
            const quantidadeTotal = isPacote ? parseInt(document.getElementById('servico-quantidade-total').value) : null;
            const observacoes = document.getElementById('servico-observacoes').value.trim();

            const servicoData = {
                nome: nome,
                preco: preco,
                isPacote: isPacote,
                quantidadeTotal: quantidadeTotal,
                observacoes: observacoes,
                dataAtualizacao: new Date().toISOString()
            };

            try {
                if (id) {
                    await db.collection('servicos').doc(id).update(servicoData);
                    showNotification('Serviço/Pacote atualizado com sucesso!', 'success');
                } else {
                    servicoData.dataCriacao = new Date().toISOString();
                    await db.collection('servicos').add(servicoData);
                    showNotification('Serviço/Pacote salvo com sucesso!', 'success');
                }
                resetServicoForm();
                await carregarServicos();
            } catch (error) {
                console.error("Erro ao salvar serviço: ", error);
                showNotification(`Erro ao salvar serviço: ${error.message}`, 'error');
            }
        });
        
        // 6.3. FUNÇÕES DE RENDERIZAÇÃO E EDIÇÃO
        window.renderizarServicos = function() {
            const lista = document.getElementById('lista-servicos');
            lista.innerHTML = '';
            if (listaServicos.length === 0) {
                lista.innerHTML = '<tr><td colspan="4" style="text-align: center;">Nenhum serviço/pacote cadastrado.</td></tr>';
                return;
            }

            listaServicos.sort((a, b) => a.nome.localeCompare(b.nome)).forEach(servico => {
                const row = lista.insertRow();
                row.dataset.servicoNome = servico.nome.toLowerCase(); // Para filtro
                
                const tipo = servico.isPacote ? `Pacote (${servico.quantidadeTotal} usos)` : 'Individual/Promoção';
                const preco = servico.isPacote ? 'R$ ' + servico.preco.toFixed(2).replace('.', ',') + ' (Pacote)' : 'R$ ' + servico.preco.toFixed(2).replace('.', ',');
                
                // Aplica data-label para responsividade mobile
                row.insertCell().innerHTML = servico.nome;
                row.cells[0].setAttribute('data-label', 'Nome');
                row.insertCell().innerHTML = preco;
                row.cells[1].setAttribute('data-label', 'Preço');
                row.insertCell().innerHTML = tipo;
                row.cells[2].setAttribute('data-label', 'Tipo');

                const actionsCell = row.insertCell();
                actionsCell.classList.add('action-buttons');
                actionsCell.innerHTML = `
                    <button class="btn-primary" onclick="editarServico('${servico.id}')"><span class="material-icons">edit</span> Editar</button>
                    <button class="btn-danger" onclick="excluirServico('${servico.id}')"><span class="material-icons">delete</span> Excluir</button>
                `;
            });
        }
        
        window.editarServico = function(id) {
            const servico = listaServicos.find(s => s.id === id);
            if (servico) {
                document.getElementById('servico-id').value = servico.id;
                document.getElementById('servico-nome').value = servico.nome;
                document.getElementById('servico-preco').value = servico.preco;
                document.getElementById('servico-observacoes').value = servico.observacoes;
                
                const isPacote = servico.isPacote || false;
                document.getElementById('servico-isPacote').checked = isPacote;
                
                // Seta e mostra/esconde a quantidade total
                document.getElementById('servico-quantidade-total').value = servico.quantidadeTotal || 4;
                document.getElementById('group-quantidade-total').style.display = isPacote ? 'flex' : 'none';

                document.getElementById('btn-salvar-servico').innerHTML = '<span class="material-icons">update</span> Atualizar Serviço';
                showSection('servicos-section'); // Garante que a seção esteja visível
            }
        }
        
        window.resetServicoForm = function() {
            document.getElementById('servico-form').reset();
            document.getElementById('servico-id').value = '';
            document.getElementById('btn-salvar-servico').innerHTML = '<span class="material-icons">save</span> Salvar Serviço';
            document.getElementById('group-quantidade-total').style.display = 'none';
        }

        window.excluirServico = async function(id) {
            if (confirm('Tem certeza que deseja excluir este serviço/pacote?')) {
                try {
                    await db.collection('servicos').doc(id).delete();
                    showNotification('Serviço/Pacote excluído com sucesso.', 'success');
                    await carregarServicos();
                } catch (error) {
                    console.error("Erro ao excluir serviço: ", error);
                    showNotification(`Erro ao excluir serviço: ${error.message}`, 'error');
                }
            }
        }
        
        // 6.4. FILTROS
        window.filtrarServicos = function() {
             const filtro = document.getElementById('filtro-servicos').value.toLowerCase();
             const lista = document.getElementById('lista-servicos');
             const linhas = lista.getElementsByTagName('tr');

             for (let i = 0; i < linhas.length; i++) {
                 const row = linhas[i];
                 if (!row.dataset.servicoNome) continue; 

                 const servicoNome = row.dataset.servicoNome;
                
                 if (servicoNome.includes(filtro)) {
                     row.style.display = window.innerWidth > 768 ? "table-row" : "block"; 
                 } else {
                     row.style.display = "none";
                 }
             }
        }
        
        // ----------------------------------------------------------------------------------
        // 7. MÓDULO DE PACOTES ATIVOS E UTILIZAÇÃO
        // ----------------------------------------------------------------------------------

        // 7.1. RENDERIZAR SELECTS
        function renderizarSelects(type, lista, isPacote = null) {
            const selects = type === 'cliente' ? 
                [document.getElementById('pacote-cliente-id'), document.getElementById('agenda-cliente-id')] :
                [document.getElementById('pacote-servico-id'), document.getElementById('agenda-servico-id'), document.getElementById('utilizacao-servico-id')];

            selects.forEach(select => {
                // Se o select não existe (por exemplo, na aba de serviços) ou se for o select de utilização, recarrega
                if (!select) return;
                
                // Preserva o valor selecionado se for o caso
                const selectedValue = select.value;
                
                select.innerHTML = type === 'cliente' ? '<option value="">Selecione o Cliente</option>' : '<option value="">Selecione o Serviço</option>';
                
                lista.forEach(item => {
                    // Lógica específica para o select de Pacote Ativo (isPacote === true)
                    if (select.id === 'pacote-servico-id' && !item.isPacote) return;
                    
                    // Lógica específica para o select de Novo Agendamento (isPacote === false)
                    if (select.id === 'agenda-servico-id' && item.isPacote) return;
                    
                    // Lógica específica para o select de Utilização de Pacote (isPacote === false)
                    if (select.id === 'utilizacao-servico-id' && item.isPacote) return;

                    const option = document.createElement('option');
                    option.value = item.id;
                    option.textContent = type === 'cliente' ? item.nome : item.nome + (item.preco > 0 && !item.isPacote ? ' (R$ ' + item.preco.toFixed(2).replace('.', ',') + ')' : '');
                    select.appendChild(option);
                });
                
                // Restaura o valor selecionado
                if (selectedValue) {
                    select.value = selectedValue;
                }
            });
        }
        
        // 7.2. INICIAR NOVO PACOTE
        document.getElementById('pacote-inicio-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const clienteId = document.getElementById('pacote-cliente-id').value;
            const servicoId = document.getElementById('pacote-servico-id').value;
            const dataInicio = document.getElementById('pacote-data-inicio').value;
            
            if (!clienteId || !servicoId || !dataInicio) {
                showNotification('Preencha todos os campos para iniciar o pacote.', 'warning');
                return;
            }
            
            const servico = listaServicos.find(s => s.id === servicoId);
            if (!servico || !servico.isPacote) {
                 showNotification('O serviço selecionado não é um pacote válido.', 'error');
                 return;
            }
            
            const cliente = listaClientes.find(c => c.id === clienteId);

            const pacoteData = {
                clienteId: clienteId,
                servicoId: servicoId,
                servicoNome: servico.nome,
                clienteNome: cliente.nome, // Cache do nome
                quantidadeTotal: servico.quantidadeTotal,
                quantidadeUsada: 0,
                dataInicio: dataInicio,
                dataVencimento: calcularDataVencimento(dataInicio), // Vencimento em 30 dias
                status: 'ativo',
                valorVenda: servico.preco,
                dataCriacao: new Date().toISOString()
            };

            try {
                await db.collection('pacotes').add(pacoteData);
                showNotification(`Pacote "${servico.nome}" para ${cliente.nome} iniciado com sucesso!`, 'success');
                document.getElementById('pacote-inicio-form').reset();
                await carregarPacotesAtivos(); // Recarrega a lista
            } catch (error) {
                console.error("Erro ao iniciar pacote: ", error);
                showNotification(`Erro ao iniciar pacote: ${error.message}`, 'error');
            }
        });
        
        function calcularDataVencimento(dataInicio) {
             const data = new Date(dataInicio + 'T00:00:00'); // Garante que a data seja tratada corretamente
             data.setMonth(data.getMonth() + 1); // Adiciona 1 mês
             return data.toISOString().split('T')[0];
        }
        
        // 7.3. RENDERIZAR PACOTES ATIVOS
        window.renderizarPacotesAtivos = function() {
             const lista = document.getElementById('lista-pacotes-ativos');
             lista.innerHTML = '';
             if (listaPacotesAtivos.length === 0) {
                 lista.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nenhum pacote ativo.</td></tr>';
                 return;
             }

             listaPacotesAtivos.sort((a, b) => a.clienteNome.localeCompare(b.clienteNome)).forEach(pacote => {
                 const row = lista.insertRow();
                 row.dataset.pacoteId = pacote.id;
                 
                 const statusPagamento = `<span class="status-package-paid">PAGO</span>`;
                 const statusPacote = (pacote.quantidadeUsada >= pacote.quantidadeTotal) ? 
                     `<span class="status-package-finalized">FINALIZADO</span>` :
                     `<span class="status-package-active">ATIVO</span>`;
                     
                 const vencido = pacote.dataVencimento < today;

                 const actionsHtml = (pacote.quantidadeUsada < pacote.quantidadeTotal && !vencido) ?
                     `<button class="btn-warning" onclick="showPacoteUtilizacao('${pacote.id}')"><span class="material-icons">cut</span> Utilizar Serviço</button>` :
                     `<button class="btn-secondary" disabled>Finalizado/Vencido</button>`;
                     
                 const vencimentoDisplay = vencido ? 
                     `<span class="status-package-finalized">${formatarData(pacote.dataVencimento)} (VENCIDO)</span>` :
                     formatarData(pacote.dataVencimento);

                 // Aplica data-label para responsividade mobile
                 row.insertCell().innerHTML = `<strong>${pacote.clienteNome}</strong>`;
                 row.cells[0].setAttribute('data-label', 'Cliente');
                 row.insertCell().innerHTML = `<strong>${pacote.servicoNome}</strong><br>(${pacote.quantidadeUsada}/${pacote.quantidadeTotal} Usos) ${statusPacote}`;
                 row.cells[1].setAttribute('data-label', 'Pacote (Usos)');
                 row.insertCell().innerHTML = statusPagamento;
                 row.cells[2].setAttribute('data-label', 'Pagamento');
                 row.insertCell().innerHTML = vencimentoDisplay;
                 row.cells[3].setAttribute('data-label', 'Vencimento');

                 const actionsCell = row.insertCell();
                 actionsCell.classList.add('action-buttons');
                 actionsCell.innerHTML = actionsHtml + `
                    <button class="btn-secondary" onclick="finalizarPacote('${pacote.id}', true)"><span class="material-icons">history</span> Histórico Uso</button>
                    <button class="btn-danger" onclick="finalizarPacote('${pacote.id}')"><span class="material-icons">lock</span> Finalizar Pacote</button>
                 `;
             });
        }
        
        // 7.4. MOSTRAR FORMULÁRIO DE UTILIZAÇÃO DE PACOTE
        window.showPacoteUtilizacao = function(pacoteId) {
             const pacote = listaPacotesAtivos.find(p => p.id === pacoteId);
             if (!pacote) {
                 showNotification('Pacote não encontrado.', 'error');
                 return;
             }
             
             document.getElementById('utilizacao-pacote-id').value = pacoteId;
             document.getElementById('pacote-utilizacao-modal').style.display = 'block';
             
             // Preenche a data de hoje e a hora atual como padrão
             document.getElementById('utilizacao-data').value = today;
             document.getElementById('utilizacao-hora').value = new Date().toTimeString().substring(0, 5);
             
             // Carrega serviços que NÃO são pacotes no select de utilização
             carregarServicos(true, false); 
        }
        
        // 7.5. ESCONDER FORMULÁRIO DE UTILIZAÇÃO DE PACOTE
        window.hidePacoteUtilizacao = function() {
             document.getElementById('pacote-utilizacao-form').reset();
             document.getElementById('pacote-utilizacao-modal').style.display = 'none';
        }
        
        // 7.6. UTILIZAR SERVIÇO DO PACOTE (Salva Movimentação e Atualiza o Pacote)
        document.getElementById('pacote-utilizacao-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const pacoteId = document.getElementById('utilizacao-pacote-id').value;
            const servicoId = document.getElementById('utilizacao-servico-id').value;
            const dataAgendamento = document.getElementById('utilizacao-data').value;
            const horaAgendamento = document.getElementById('utilizacao-hora').value;
            const horaFimAgendamento = document.getElementById('utilizacao-hora-fim').value; // NOVO CAMPO
            const observacoes = document.getElementById('utilizacao-observacoes').value.trim();

            if (!servicoId || !dataAgendamento || !horaAgendamento || !horaFimAgendamento) {
                showNotification('Preencha a data e os horários para registrar o uso.', 'warning');
                return;
            }

            const pacote = listaPacotesAtivos.find(p => p.id === pacoteId);
            const cliente = listaClientes.find(c => c.id === pacote.clienteId);
            const servicoUsado = listaServicos.find(s => s.id === servicoId);

            if (!pacote || pacote.quantidadeUsada >= pacote.quantidadeTotal || pacote.dataVencimento < today) {
                showNotification('Pacote inválido, esgotado ou vencido.', 'error');
                return;
            }

            try {
                // 1. ATUALIZA O PACOTE
                await db.collection('pacotes').doc(pacoteId).update({
                    quantidadeUsada: firebase.firestore.FieldValue.increment(1),
                    dataAtualizacao: new Date().toISOString()
                });

                // 2. CRIA REGISTRO NA COLEÇÃO DE MOVIMENTAÇÕES/HISTÓRICO
                const movimentacao = {
                    clienteId: pacote.clienteId,
                    clienteNome: cliente.nome,
                    servicoId: servicoId, // O serviço individual usado
                    servicoNome: servicoUsado.nome,
                    servicoPreco: servicoUsado.preco, // Para relatórios futuros, mas o valor é 0 para o lucro
                    data: dataAgendamento,
                    hora: horaAgendamento,
                    horaFim: horaFimAgendamento, // ESSENCIAL PARA VISÃO DIÁRIA
                    pacoteId: pacoteId,
                    tipo_movimentacao: 'pacote', // Indica que é uso de pacote
                    status: 'realizado',
                    observacoes: `Uso de serviço do pacote: ${pacote.servicoNome}. Obs: ${observacoes}`,
                    dataCriacao: new Date().toISOString()
                };

                await db.collection('movimentacoes').add(movimentacao);
                
                showNotification(`Uso do pacote de ${pacote.clienteNome} registrado e agendamento salvo!`, 'success');
                hidePacoteUtilizacao();
                await carregarPacotesAtivos(); // Recarrega Pacotes Ativos
                // Se o usuário estiver na Visão Diária, precisa atualizar
                if(document.getElementById('visao-diaria-pane').classList.contains('active')) {
                     await carregarMovimentacoes();
                     renderizarVisaoDiaria();
                }

            } catch (error) {
                console.error("Erro ao utilizar pacote: ", error);
                showNotification(`Erro ao registrar uso: ${error.message}`, 'error');
            }
        });
        
        // 7.7. FINALIZAR PACOTE
        window.finalizarPacote = async function(id, isHistorico = false) {
             if (isHistorico) {
                 // Esta função não está implementada (visualizar histórico de uso)
                 showNotification('Funcionalidade de Histórico de Uso do Pacote não implementada.', 'info', 5000);
                 return;
             }
             
             if (confirm('Tem certeza que deseja FINALIZAR este pacote? Ele será movido para o histórico de pacotes. Isso não pode ser desfeito.')) {
                 try {
                     await db.collection('pacotes').doc(id).update({
                         status: 'finalizado',
                         dataFinalizacao: new Date().toISOString()
                     });
                     showNotification('Pacote finalizado com sucesso.', 'info');
                     await carregarPacotesAtivos(); 
                 } catch (error) {
                     console.error("Erro ao finalizar pacote: ", error);
                     showNotification(`Erro ao finalizar pacote: ${error.message}`, 'error');
                 }
             }
        }

        // ----------------------------------------------------------------------------------
        // 8. MÓDULO DE AGENDA / AGENDAMENTOS
        // ----------------------------------------------------------------------------------

        // 8.1. SALVAR/ATUALIZAR AGENDAMENTO (APENAS INDIVIDUAL/PROMOÇÃO)
        document.getElementById('agendamento-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('agendamento-id').value;
            const clienteId = document.getElementById('agenda-cliente-id').value;
            const servicoId = document.getElementById('agenda-servico-id').value;
            const data = document.getElementById('agenda-data').value;
            const hora = document.getElementById('agenda-hora').value;
            const horaFim = document.getElementById('agenda-hora-fim').value;
            const observacoes = document.getElementById('agenda-observacoes').value.trim();

            if (!clienteId || !servicoId || !data || !hora || !horaFim) {
                showNotification('Preencha todos os campos obrigatórios (Cliente, Serviço, Data, Hora Início e Hora Fim).', 'warning');
                return;
            }

            const cliente = listaClientes.find(c => c.id === clienteId);
            const servico = listaServicos.find(s => s.id === servicoId);

            const agendamentoData = {
                clienteId: clienteId,
                clienteNome: cliente.nome,
                servicoId: servicoId,
                servicoNome: servico.nome,
                servicoPreco: servico.preco,
                data: data,
                hora: hora,
                horaFim: horaFim,
                observacoes: observacoes,
                tipo_movimentacao: 'agendamento', // Indica que é agendamento regular
                status: id ? 'agendado' : 'agendado', // Mantém o status ao editar
                dataAtualizacao: new Date().toISOString()
            };

            try {
                if (id) {
                    await db.collection('movimentacoes').doc(id).update(agendamentoData);
                    showNotification('Agendamento atualizado com sucesso!', 'success');
                } else {
                    agendamentoData.dataCriacao = new Date().toISOString();
                    await db.collection('movimentacoes').add(agendamentoData);
                    showNotification('Agendamento salvo com sucesso!', 'success');
                }
                resetAgendamentoForm();
                await carregarMovimentacoes();
                carregarAgendamentos(); // Recarrega a lista
            } catch (error) {
                console.error("Erro ao salvar agendamento: ", error);
                showNotification(`Erro ao salvar agendamento: ${error.message}`, 'error');
            }
        });

        // 8.2. RENDERIZAR SELECTS
        // As listas de clientes e serviços são carregadas em showAgendaTab('novo-agendamento')

        // 8.3. RENDERIZAR LISTA DE AGENDAMENTOS FUTUROS (INDIVIDUAIS E PACOTES)
        window.carregarAgendamentos = function() {
            const dataAtual = new Date();
            const dataAtualString = dataAtual.toISOString().split('T')[0];
            const horaAtualString = dataAtual.toTimeString().substring(0, 5);

            const filtroData = document.getElementById('filtro-agenda-data').value;

            const agendamentosFuturos = listaMovimentacoes
                .filter(mov => {
                    // Filtra por agendamentos que não foram realizados ou cancelados
                    const isAtivo = mov.status === 'agendado' || mov.status === 'confirmado'; 
                    
                    // Filtra por agendamentos que são futuros (ou hoje, mas a partir da hora atual)
                    const isFuturo = mov.data > dataAtualString || (mov.data === dataAtualString && mov.hora >= horaAtualString);
                    
                    if (filtroData && mov.data !== filtroData) return false;
                    
                    return isAtivo && isFuturo;
                })
                .sort((a, b) => {
                    if (a.data !== b.data) return a.data.localeCompare(b.data);
                    return a.hora.localeCompare(b.hora);
                });

            renderizarAgendamentos(agendamentosFuturos);
        }

        window.renderizarAgendamentos = function(agendamentos) {
            const lista = document.getElementById('lista-agendamentos');
            lista.innerHTML = '';
            
            // Filtro de texto adicional (por cliente)
            const filtroCliente = document.getElementById('filtro-agenda-cliente').value.toLowerCase();
            
            const agendamentosFiltrados = agendamentos.filter(a => a.clienteNome.toLowerCase().includes(filtroCliente));

            if (agendamentosFiltrados.length === 0) {
                lista.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nenhum agendamento futuro encontrado.</td></tr>';
                return;
            }

            agendamentosFiltrados.forEach(agendamento => {
                const row = lista.insertRow();
                row.dataset.clienteNome = agendamento.clienteNome.toLowerCase(); // Para filtro

                const tipo = agendamento.tipo_movimentacao === 'pacote' ? 'Uso de Pacote' : 'Serviço Individual';
                const statusDisplay = agendamento.status === 'agendado' ? 
                    `<span class="status-package-pending">AGENDADO</span>` :
                    agendamento.status === 'confirmado' ?
                    `<span class="status-package-active">CONFIRMADO</span>` :
                    agendamento.status;
                
                // Aplica data-label para responsividade mobile
                row.insertCell().innerHTML = formatarDataHora(agendamento.data, agendamento.hora);
                row.cells[0].setAttribute('data-label', 'Data/Hora');
                row.insertCell().innerHTML = `<strong>${agendamento.clienteNome}</strong>`;
                row.cells[1].setAttribute('data-label', 'Cliente');
                row.insertCell().innerHTML = `${agendamento.servicoNome} (${tipo})`;
                row.cells[2].setAttribute('data-label', 'Serviço');
                row.insertCell().innerHTML = statusDisplay;
                row.cells[3].setAttribute('data-label', 'Status');


                const actionsCell = row.insertCell();
                actionsCell.classList.add('action-buttons');
                actionsCell.innerHTML = `
                    <button class="btn-primary" onclick="editarAgendamento('${agendamento.id}')"><span class="material-icons">edit</span> Editar</button>
                    ${agendamento.status === 'agendado' ? 
                       `<button class="btn-success" onclick="mudarStatusAgendamento('${agendamento.id}', 'confirmado')"><span class="material-icons">check</span> Confirmar</button>` :
                       `<button class="btn-secondary" disabled><span class="material-icons">check</span> Confirmado</button>`
                    }
                    <button class="btn-danger" onclick="mudarStatusAgendamento('${agendamento.id}', 'cancelado')"><span class="material-icons">close</span> Cancelar</button>
                    <button class="btn-warning" onclick="finalizarAgendamento('${agendamento.id}')"><span class="material-icons">done_all</span> Finalizar</button>
                `;
            });
        }
        
        window.editarAgendamento = function(id) {
            const agendamento = listaMovimentacoes.find(a => a.id === id);
            if (agendamento) {
                // Preenche o formulário
                document.getElementById('agendamento-id').value = agendamento.id;
                document.getElementById('agenda-cliente-id').value = agendamento.clienteId;
                document.getElementById('agenda-servico-id').value = agendamento.servicoId;
                document.getElementById('agenda-data').value = agendamento.data;
                document.getElementById('agenda-hora').value = agendamento.hora;
                document.getElementById('agenda-hora-fim').value = agendamento.horaFim;
                document.getElementById('agenda-observacoes').value = agendamento.observacoes;
                document.getElementById('btn-salvar-agendamento').innerHTML = '<span class="material-icons">update</span> Atualizar Agendamento';
                
                // Vai para a aba de novo agendamento
                showAgendaTab('novo-agendamento');
            }
        }
        
        window.resetAgendamentoForm = function() {
            document.getElementById('agendamento-form').reset();
            document.getElementById('agendamento-id').value = '';
            document.getElementById('btn-salvar-agendamento').innerHTML = '<span class="material-icons">save</span> Salvar Agendamento';
        }
        
        window.filtrarAgendamentos = function() {
            carregarAgendamentos(); // Recarrega usando o filtro de texto
        }
        
        window.resetFiltroAgenda = function() {
             document.getElementById('filtro-agenda-data').value = '';
             document.getElementById('filtro-agenda-cliente').value = '';
             carregarAgendamentos();
        }
        
        // 8.4. MUDAR STATUS DO AGENDAMENTO
        window.mudarStatusAgendamento = async function(id, status) {
            const agendamento = listaMovimentacoes.find(a => a.id === id);
            if (!agendamento) return;
            
            const confirmMsg = status === 'cancelado' 
                ? 'Tem certeza que deseja CANCELAR este agendamento?' 
                : `Tem certeza que deseja CONFIRMAR este agendamento?`;
                
            if (confirm(confirmMsg)) {
                try {
                    await db.collection('movimentacoes').doc(id).update({ 
                        status: status,
                        dataAtualizacao: new Date().toISOString()
                    });
                    showNotification(`Agendamento ${status.toUpperCase()} com sucesso!`, 'info');
                    await carregarMovimentacoes();
                    carregarAgendamentos();
                } catch (error) {
                    console.error("Erro ao mudar status: ", error);
                    showNotification(`Erro ao mudar status: ${error.message}`, 'error');
                }
            }
        }
        
        // 8.5. FINALIZAR AGENDAMENTO (Muda status para 'realizado')
        window.finalizarAgendamento = async function(id) {
             const agendamento = listaMovimentacoes.find(a => a.id === id);
             if (!agendamento) return;
             
             if (confirm('Ao finalizar, o agendamento será movido para o histórico. Deseja continuar?')) {
                 try {
                     // 1. Atualiza o status
                     await db.collection('movimentacoes').doc(id).update({
                         status: 'realizado',
                         dataFinalizacao: new Date().toISOString()
                     });
                     
                     showNotification(`Agendamento de ${agendamento.clienteNome} finalizado e movido para o histórico.`, 'success');
                     
                     // 2. Recarrega as listas
                     await carregarMovimentacoes();
                     carregarAgendamentos(); 
                     
                     // Se o usuário estiver na aba de histórico, atualiza
                     if(document.getElementById('historico-section').classList.contains('active')) {
                          renderizarHistorico();
                     }
                     
                 } catch (error) {
                     console.error("Erro ao finalizar agendamento: ", error);
                     showNotification(`Erro ao finalizar agendamento: ${error.message}`, 'error');
                 }
             }
        }
        
        // ----------------------------------------------------------------------------------
        // 9. MÓDULO VISÃO DIÁRIA (AGENDA GRÁFICA)
        // ----------------------------------------------------------------------------------
        
        window.renderizarVisaoDiaria = async function(dataParam = null) {
            
            // 1. Define a data de filtro
            const dataElement = document.getElementById('filtro-visao-diaria-data');
            const dataFiltro = dataParam === 'today' ? today : dataElement.value;
            
            if (!dataFiltro) {
                 document.getElementById('lista-visao-diaria').innerHTML = '<tr><td colspan="2" style="text-align: center;">Selecione uma data para visualizar.</td></tr>';
                 return;
            }
            
            dataElement.value = dataFiltro; // Atualiza o input de data

            // 2. Garante que as movimentações estão carregadas
            await carregarMovimentacoes(); 
            
            // 3. Filtra as movimentações (agendado/confirmado E realizado no dia)
            const agendamentosHoje = listaMovimentacoes
                .filter(mov => {
                    // Inclui agendamentos ativos/confirmados
                    const isAtivo = mov.status === 'agendado' || mov.status === 'confirmado'; 
                    // Inclui agendamentos realizados (que podem ter sido lançados hoje via pacote)
                    const isRealizadoHoje = mov.status === 'realizado' && mov.data === dataFiltro;
                    
                    return mov.data === dataFiltro && (isAtivo || isRealizadoHoje);
                })
                .sort((a, b) => a.hora.localeCompare(b.hora));

            const listaVisaoDiaria = document.getElementById('lista-visao-diaria');
            listaVisaoDiaria.innerHTML = '';
            
            const horariosOcupados = new Map();
            
            // 4. Marca os horários ocupados
            agendamentosHoje.forEach(agendamento => {
                const start = new Date(agendamento.data + 'T' + agendamento.hora);
                const end = new Date(agendamento.data + 'T' + agendamento.horaFim);
                
                // Itera em intervalos de 30 minutos
                let current = start;
                while (current < end) {
                    const horaKey = current.toTimeString().substring(0, 5);
                    horariosOcupados.set(horaKey, agendamento);
                    current.setMinutes(current.getMinutes() + 30);
                }
            });

            // 5. Gera a tabela (Intervalos de 30 minutos das 8h às 21h)
            for (let h = 8; h <= 20; h++) {
                for (let m = 0; m < 60; m += 30) {
                    const horaKey = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                    const row = listaVisaoDiaria.insertRow();
                    
                    // Coluna Horário
                    const horaCell = row.insertCell();
                    horaCell.className = 'horario-celula';
                    horaCell.textContent = horaKey;
                    
                    // Coluna Detalhes
                    const detalhesCell = row.insertCell();
                    detalhesCell.setAttribute('data-label', 'Detalhes');

                    const agendamento = horariosOcupados.get(horaKey);

                    if (agendamento) {
                        const start = agendamento.hora;
                        const end = agendamento.horaFim;

                        // Se for o início do agendamento, mostra os detalhes
                        if (horaKey === start.substring(0, 5)) {
                            detalhesCell.className = 'agendamento-ocupado';
                            detalhesCell.setAttribute('rowspan', calcularRowspan(start, end));
                            detalhesCell.setAttribute('onclick', `abrirDetalhesAgendamento('${agendamento.id}')`);
                            
                            const tipo = agendamento.tipo_movimentacao === 'pacote' ? 'Uso de Pacote' : 'Serviço Individual';
                            const valor = agendamento.tipo_movimentacao === 'pacote' ? 'PACOTE (PAGO)' : `R$ ${agendamento.servicoPreco.toFixed(2).replace('.', ',')}`;

                            detalhesCell.innerHTML = `
                                <strong>${agendamento.clienteNome}</strong><br>
                                ${agendamento.servicoNome} (${tipo})<br>
                                ${start.substring(0, 5)} - ${end.substring(0, 5)} | ${valor}
                            `;
                        } else if (horaKey > start.substring(0, 5) && horaKey < end.substring(0, 5)) {
                            // Células do meio do agendamento são escondidas
                            detalhesCell.style.display = 'none';
                            horaCell.style.display = 'none';
                        } else {
                            // Espaço vago
                             detalhesCell.className = 'agendamento-vago';
                             detalhesCell.textContent = 'Vago';
                        }
                    } else {
                        // Espaço vago
                        detalhesCell.className = 'agendamento-vago';
                        detalhesCell.textContent = 'Vago';
                    }
                }
            }
        }
        
        function calcularRowspan(startHour, endHour) {
            const start = new Date('2000/01/01 ' + startHour);
            const end = new Date('2000/01/01 ' + endHour);
            const diffInMinutes = (end - start) / (1000 * 60);
            return Math.max(1, Math.round(diffInMinutes / 30)); // 1 rowspan por cada 30 min
        }

        window.abrirDetalhesAgendamento = function(id) {
             const agendamento = listaMovimentacoes.find(a => a.id === id);
             if (agendamento) {
                 const tipo = agendamento.tipo_movimentacao === 'pacote' ? 'USO DE PACOTE' : 'SERVIÇO INDIVIDUAL';
                 const valor = agendamento.tipo_movimentacao === 'pacote' ? 'PACOTE (PAGO)' : `R$ ${agendamento.servicoPreco.toFixed(2).replace('.', ',')}`;
                 
                 alert(`
                 Detalhes do Agendamento:
                 ----------------------------------
                 Cliente: ${agendamento.clienteNome}
                 Serviço: ${agendamento.servicoNome} (${tipo})
                 Data/Hora: ${formatarDataHoraVisaoDiaria(agendamento.data, agendamento.hora, agendamento.horaFim)}
                 Valor: ${valor}
                 Status: ${agendamento.status.toUpperCase()}
                 Observações: ${agendamento.observacoes || 'Nenhuma'}
                 `);
             }
        }
        
        // ----------------------------------------------------------------------------------
        // 10. MÓDULO HISTÓRICO / RELATÓRIOS
        // ----------------------------------------------------------------------------------

        // 10.1. RENDERIZAR HISTÓRICO DE AGENDAMENTOS E PACOTES
        window.renderizarHistorico = async function() {
            // Garante que as movimentações estão carregadas
            await carregarMovimentacoes(); 

            const mesAnoFiltro = document.getElementById('filtro-historico-mes').value;
            const listaHistorico = document.getElementById('lista-historico');
            listaHistorico.innerHTML = '';
            let totalLucro = 0;
            
            if (!mesAnoFiltro) {
                 document.getElementById('total-lucro').textContent = 'R$ 0,00';
                 listaHistorico.innerHTML = '<tr><td colspan="6" style="text-align: center;">Selecione um mês para carregar o histórico.</td></tr>';
                 return;
            }

            const historicoFiltrado = listaMovimentacoes
                .filter(mov => mov.status === 'realizado' && mov.data.startsWith(mesAnoFiltro))
                .sort((a, b) => {
                    if (a.data !== b.data) return a.data.localeCompare(b.data);
                    return a.hora.localeCompare(b.hora);
                });

            if (historicoFiltrado.length === 0) {
                 document.getElementById('total-lucro').textContent = 'R$ 0,00';
                 listaHistorico.innerHTML = '<tr><td colspan="6" style="text-align: center;">Nenhuma movimentação finalizada neste mês.</td></tr>';
                 return;
            }
            
            historicoFiltrado.forEach(mov => {
                // Cálculo de Lucro: Apenas serviços 'agendamento' contam
                if (mov.tipo_movimentacao === 'agendamento' && mov.servicoPreco) {
                    totalLucro += mov.servicoPreco;
                }
                
                const row = listaHistorico.insertRow();
                row.dataset.clienteNome = mov.clienteNome.toLowerCase(); // Para filtro
                
                // Tipo de Serviço
                const tipoServico = mov.tipo_movimentacao === 'pacote' ? 
                                       `<span class="status-package-paid">USO DE PACOTE</span>` : 
                                       `<span class="status-package-active">SERVIÇO INDIVIDUAL</span>`;
                
                // Valor Exibido
                const valor = mov.tipo_movimentacao === 'pacote' 
                    ? '0,00 (Pago no Pacote)' 
                    : parseFloat(mov.servicoPreco || 0).toFixed(2).replace('.', ',');
                
                // Aplica data-label para responsividade mobile
                row.insertCell().innerHTML = formatarDataHora(mov.data, mov.hora);
                row.cells[0].setAttribute('data-label', 'Data/Hora');
                row.insertCell().innerHTML = `<strong>${mov.clienteNome}</strong>`;
                row.cells[1].setAttribute('data-label', 'Cliente');
                row.insertCell().innerHTML = mov.servicoNome;
                row.cells[2].setAttribute('data-label', 'Serviço/Pacote');
                row.insertCell().innerHTML = tipoServico;
                row.cells[3].setAttribute('data-label', 'Tipo');
                row.insertCell().innerHTML = `R$ ${valor}`;
                row.cells[4].setAttribute('data-label', 'Valor');


                const actionsCell = row.insertCell();
                actionsCell.classList.add('action-buttons');
                actionsCell.innerHTML = `
                    <button class="btn-info" onclick="abrirDetalhesAgendamento('${mov.id}')"><span class="material-icons">info</span> Detalhes</button>
                    <button class="btn-secondary" onclick="reverterAgendamento('${mov.id}')"><span class="material-icons">undo</span> Reverter p/ Agenda</button>
                 `;
            });

            // Atualiza o total de lucros
            document.getElementById('total-lucro').textContent = 'R$ ' + totalLucro.toFixed(2).replace('.', ',');
            
            // Re-aplica filtro de cliente, se houver
            window.filtrarHistoricoTabela();
        }
        
        // 10.2. REVERTER PARA AGENDA
        window.reverterAgendamento = async function(id) {
             const mov = listaMovimentacoes.find(m => m.id === id);
             if (!mov) return;
             
             if (confirm(`Tem certeza que deseja reverter o serviço "${mov.servicoNome}" de ${mov.clienteNome} de volta para a agenda como 'Agendado'?`)) {
                 try {
                     await db.collection('movimentacoes').doc(id).update({
                         status: 'agendado',
                         dataReversao: new Date().toISOString()
                     });
                     showNotification('Movimentação revertida para status "Agendado".', 'warning');
                     await carregarMovimentacoes();
                     renderizarHistorico();
                 } catch (error) {
                     console.error("Erro ao reverter: ", error);
                     showNotification('Erro ao reverter: ' + error.message, 'error');
                 }
             }
        }
        
        // 10.3. FILTRAR HISTÓRICO NA TABELA
        window.filtrarHistoricoTabela = function() {
             const filtro = document.getElementById('filtro-historico-cliente').value.toLowerCase();
             const listaHistorico = document.getElementById('lista-historico');
             const linhas = listaHistorico.getElementsByTagName('tr');

             for (let i = 0; i < linhas.length; i++) {
                 const row = linhas[i];
                 if (!row.dataset.clienteNome) continue; 

                 const clienteNome = row.dataset.clienteNome;
                
                 if (clienteNome.includes(filtro)) {
                    // Em desktop é 'table-row', em mobile é 'block'
                     row.style.display = window.innerWidth > 768 ? "table-row" : "block"; 
                 } else {
                     row.style.display = "none";
                 }
             }
        }
        
        // 10.4. RESETAR FILTRO DO HISTÓRICO
        window.resetFiltroHistorico = function() {
            document.getElementById('filtro-historico-mes').value = ''; 
            document.getElementById('filtro-historico-cliente').value = '';
            document.getElementById('total-lucro').textContent = 'R$ 0,00';
            renderizarHistorico();
        }
        
        // ----------------------------------------------------------------------------------
        // 11. LOGIN / AUTENTICAÇÃO SIMPLES
        // ----------------------------------------------------------------------------------
        
        function showLogin() {
            document.getElementById('app-container').style.display = 'none';
            document.getElementById('login-container').style.display = 'flex';
        }
        
        function showApp() {
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('app-container').style.display = 'flex';
            // Carrega os dados iniciais do app
            showSection('agenda-section');
        }
        
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const senha = document.getElementById('loginSenha').value;
            
            if (senha === senhaAcesso) {
                 showApp();
                 showNotification('Login realizado com sucesso!', 'success');
            } else {
                 showNotification('Senha incorreta. Tente novamente.', 'error');
            }
        });
        
        document.getElementById('logout-button').addEventListener('click', () => {
            showLogin();
            showNotification('Sessão encerrada.', 'info');
        });


        // ----------------------------------------------------------------------------------
        // INICIALIZAÇÃO
        // ----------------------------------------------------------------------------------
        document.addEventListener('DOMContentLoaded', () => {
             // Mostra a tela de login ao carregar a página
            showLogin();
        });
    </script>
</body>
</html>
