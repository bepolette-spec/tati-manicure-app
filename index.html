<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tati Manicure - Gerenciamento de Agendamentos</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #ff8c6b; /* Cor de Destaque (Salmão/Coral) */
            --secondary-color: #6c757d; /* Cinza para secundários */
            --background-color: #f4f7f6; /* Fundo Suave */
            --sidebar-bg: #ffffff;
            --sidebar-hover-bg: #fff0eb; /* Fundo mais claro para hover */
            --text-color: #343a40; /* Texto Principal (Escuro) */
            --success-color: #28a745;
            --info-color: #17a2b8;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --border-color: #e9ecef;
            --shadow-color: rgba(0, 0, 0, 0.05);
        }

        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            min-height: 100vh;
        }

        /* Estrutura do App */
        #login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            background-color: var(--primary-color);
            min-height: 100vh;
        }

        .login-card {
            background: var(--sidebar-bg);
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 15px var(--shadow-color);
            text-align: center;
            width: 100%;
            max-width: 400px;
        }

        .login-card h1 {
            color: var(--primary-color);
            margin-bottom: 30px;
            font-size: 1.8rem;
        }

        #app-container {
            display: none; /* Escondido por padrão, mostrado após o login */
            width: 100%;
            display: flex;
        }

        /* Barra Lateral (Sidebar) */
        .sidebar {
            width: 250px;
            background-color: var(--sidebar-bg);
            box-shadow: 2px 0 5px var(--shadow-color);
            display: flex;
            flex-direction: column;
            padding: 20px 0;
            flex-shrink: 0;
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
            color: var(--primary-color);
            font-size: 1.6rem;
            font-weight: bold;
        }

        .sidebar ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar ul li a {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            text-decoration: none;
            color: var(--text-color);
            transition: background-color 0.2s, color 0.2s;
            font-weight: 500;
        }

        .sidebar ul li a:hover,
        .sidebar ul li a.active {
            background-color: var(--sidebar-hover-bg);
            color: var(--primary-color);
        }

        .sidebar ul li a .material-icons {
            margin-right: 10px;
            font-size: 20px;
        }

        .user-info {
            margin-top: auto;
            padding: 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .user-info p {
            margin: 0 0 10px 0;
            font-weight: bold;
        }

        /* Conteúdo Principal */
        .main-content {
            flex-grow: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .content-section {
            display: none;
            padding: 20px;
        }

        .content-section.active {
            display: block;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .section-header h2 {
            margin: 0;
            color: var(--text-color);
            font-size: 1.5rem;
        }
        
        /* Novas cores para Status de Pacote e Histórico */
        .status-package-paid {
             color: var(--success-color);
             font-weight: bold;
        }
        .status-package-pending {
            color: var(--warning-color);
            font-weight: bold;
        }
        .status-package-active {
            color: var(--primary-color);
            font-weight: bold;
        }
        .status-package-finalized {
            color: var(--danger-color);
            font-weight: bold;
        }

        /* Cartão (Card) */
        .card {
            background: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 4px var(--shadow-color);
            margin-bottom: 20px;
        }
        
        /* NOVO V6: Abas dentro de uma seção */
        .tab-menu {
             display: flex;
             border-bottom: 2px solid var(--border-color);
             margin-bottom: 20px;
        }
        .tab-menu button {
             padding: 10px 20px;
             border: none;
             background: transparent;
             cursor: pointer;
             font-size: 1rem;
             color: var(--secondary-color);
             border-bottom: 2px solid transparent;
             transition: border-color 0.2s, color 0.2s;
             font-weight: bold;
        }
        .tab-menu button.active {
             color: var(--primary-color);
             border-bottom: 2px solid var(--primary-color);
        }
        .tab-content {
             padding-top: 10px;
        }
        .tab-pane {
             display: none;
        }
        .tab-pane.active {
             display: block;
        }

        /* Formulários */
        .form-group {
            margin-bottom: 15px;
        }

        .form-row {
            display: flex;
            gap: 20px;
        }

        .form-row > div {
            flex: 1;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 0.95rem;
        }

        input[type="text"],
        input[type="number"],
        input[type="email"],
        input[type="tel"],
        input[type="date"],
        input[type="time"],
        textarea,
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        /* Datalist input */
        input[list] {
            /* Estilo para garantir que o input datalist se pareça com um campo normal */
            background-image: none;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="email"]:focus,
        input[type="tel"]:focus,
        input[type="date"]:focus,
        input[type="time"]:focus,
        textarea:focus,
        select:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        textarea {
            resize: vertical;
        }

        /* Botões */
        button, .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: background-color 0.2s, opacity 0.2s;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #e57a5e;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #218838;
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: var(--text-color);
        }

        .btn-warning:hover {
            background-color: #ffb547;
        }


        /* Tabelas */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table thead tr {
            background-color: var(--primary-color);
            color: white;
            text-align: left;
        }

        .data-table th, .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table tbody tr:hover {
            background-color: var(--sidebar-hover-bg);
        }

        .data-table td.action-buttons button {
            margin-right: 5px;
            padding: 6px 8px;
        }

        /* CORREÇÃO: Aumenta o espaço para os botões para evitar quebras de linha em telas maiores */
        .data-table td.action-buttons {
            white-space: nowrap;
            width: 280px; /* Garante espaço suficiente */
        }

        /* Notificação */
        #notification-bar {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s, transform 0.3s;
            transform: translateY(-20px);
            z-index: 1000;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            font-weight: bold;
        }

        #notification-bar.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        #notification-bar.success { background-color: var(--success-color); }
        #notification-bar.error { background-color: var(--danger-color); }
        #notification-bar.info { background-color: var(--info-color); }

        /* Utilitários */
        .flex-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .input-group {
            display: flex;
            gap: 10px;
        }
        
        .input-group input, .input-group select {
            flex-grow: 1;
        }

        .filter-row {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            margin-bottom: 20px;
        }
        .filter-row > div {
            flex: 1;
        }
        .filter-row button {
            flex-grow: 0;
            flex-shrink: 0;
            padding: 9px 15px; /* Ajuste para alinhar com o input */
        }
        
        /* NOVO V6: Estilos para a Tabela de Visão Diária */
        .table-responsive {
             overflow-x: auto;
        }
        #tabela-visao-diaria {
             border: 1px solid var(--border-color);
             margin-top: 0;
        }
        #tabela-visao-diaria thead tr {
             background-color: var(--secondary-color);
        }
        #tabela-visao-diaria td {
             height: 40px; /* Altura padrão para cada intervalo de 30 min */
             font-size: 0.9rem;
             vertical-align: top;
        }
        .horario-celula {
             width: 80px;
             font-weight: bold;
             background-color: var(--sidebar-hover-bg);
             color: var(--text-color);
             text-align: center;
             vertical-align: middle !important;
             border-right: 1px solid var(--border-color);
        }
        .agendamento-vago {
             background-color: #f7fff7; /* Verde clarinho */
             color: var(--success-color);
             font-weight: bold;
             font-style: italic;
             text-align: center;
             line-height: 40px;
        }
        .agendamento-ocupado {
             background-color: #fff0eb; /* Fundo do hover de sidebar, suave */
             color: var(--text-color);
             font-weight: 500;
             padding: 5px 10px !important;
             vertical-align: middle !important;
             line-height: 1.2;
             border-left: 5px solid var(--primary-color);
             cursor: pointer;
        }
        .agendamento-ocupado strong {
             color: var(--primary-color);
             font-weight: bold;
        }
        
        /* --------------------------------------------------- */
        /* RESPONSIVIDADE MOBILE (Mobile First - Portrait Mode)*/
        /* --------------------------------------------------- */
        @media (max-width: 768px) {
            
            /* Estrutura Principal */
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
                box-shadow: 0 0 5px var(--shadow-color);
            }

            .main-content {
                padding: 15px;
            }

            #app-container {
                flex-direction: column;
            }

            /* Navegação Horizontal */
            .sidebar ul {
                display: flex;
                flex-wrap: nowrap; /* Tenta manter em uma linha, mas permite rolagem */
                overflow-x: auto;
                justify-content: flex-start;
                border-bottom: 1px solid var(--border-color);
            }

            .sidebar ul li {
                flex-shrink: 0; /* Impede que os itens encolham */
                text-align: center;
            }

            .sidebar ul li a {
                justify-content: center;
                padding: 10px;
                flex-direction: column;
                font-size: 0.75rem;
                white-space: nowrap;
            }

            .sidebar ul li a .material-icons {
                margin-right: 0;
                margin-bottom: 5px;
                font-size: 20px;
            }

            /* FIX: Botão Sair visível no celular */
            .user-info {
                display: block;
                padding: 10px 15px;
                border-top: none; 
                text-align: center; 
            }

            .user-info p {
                display: none; /* Esconde o texto "Olá, Tati!" para economizar espaço */
            }

            .user-info button {
                width: 100%;
                margin-top: 10px; 
                font-size: 0.9rem;
            }
            
            /* 1. Correção de Formulários e Filtros (Empilhamento) */
            .form-row, .filter-row {
                flex-direction: column;
                gap: 0; /* Remove gap quando empilha */
            }

            .form-row > div, 
            .filter-row > div {
                flex: 0 0 100% !important; /* Força largura total */
                width: 100%;
            }
            
            /* Ajusta margem para inputs empilhados */
            .form-group, .filter-row > div {
                margin-bottom: 10px;
            }
            
            .filter-row button {
                width: 100%;
                margin-top: 5px; 
                padding: 10px 15px !important;
            }
            
            /* V6: Ajuste para a Tabela de Visão Diária */
            #tabela-visao-diaria {
                 width: 100%;
                 min-width: 300px; /* Garante que não fique muito esmagada */
            }
            #tabela-visao-diaria td {
                 padding: 5px 10px !important;
            }

            /* 2. Correção de Tabelas (Cartão-like View) */
            .data-table, .data-table tbody, .data-table td, .data-table tr {
                display: block; /* Força elementos da tabela a empilhar */
            }

            .data-table thead {
                display: none; /* Esconde o cabeçalho original */
            }

            .data-table tr {
                border: 1px solid var(--border-color);
                margin-bottom: 15px;
                border-radius: 8px;
                box-shadow: 0 1px 3px var(--shadow-color);
                padding: 10px;
            }

            .data-table td {
                border: none;
                position: relative;
                padding-left: 50% !important; /* Espaço para o rótulo */
                text-align: right; /* Alinha o valor à direita */
                white-space: normal; /* Permite quebras de linha */
                min-height: 40px;
            }

            /* Rótulo customizado (que usa o data-label do JS) */
            .data-table td::before {
                content: attr(data-label);
                position: absolute;
                left: 10px;
                width: 45%; 
                padding-right: 10px;
                white-space: nowrap;
                text-align: left;
                font-weight: bold;
                color: var(--primary-color);
            }
            
            /* FIX V6: Organização dos botões de ação em mobile */
            /* Garante que o rótulo "Ações" não sobreponha o primeiro botão */
            .data-table td.action-buttons {
                text-align: left;
                padding-left: 10px !important;
                display: flex; 
                flex-direction: column; /* Empilha os botões */
                gap: 5px;
                width: 100% !important; /* Garante que ocupe a largura total no mobile */
            }
            
            .data-table td.action-buttons::before {
                content: "Ações";
                width: 100%; 
                margin-bottom: 5px;
                display: block;
            }
            
            .data-table td.action-buttons button {
                margin: 0;
                width: 100%; /* Ocupa a largura toda */
                max-width: 100%;
                box-sizing: border-box;
                font-size: 0.9rem; 
                padding: 8px 5px;
            }
        }
    </style>
</head>
<body>

    <div id="notification-bar"></div>

    <div id="login-container">
        <div class="login-card">
            <h1>Tati Manicure - Acesso</h1>
            <form id="login-form">
                <div class="form-group">
                    <label for="loginSenha">Senha de Acesso</label>
                    <input type="password" id="loginSenha" required>
                </div>
                <button type="submit" class="btn-primary" style="width: 100%; margin-top: 10px;">
                    <span class="material-icons">login</span> Entrar
                </button>
            </form>
        </div>
    </div>

    <datalist id="clientes-datalist"></datalist>

    <div id="app-container">
        
        <aside class="sidebar">
            <div class="logo">TATI MANICURE APP</div>
            
            <ul>
                <li><a href="#" data-section="agenda" class="active"><span class="material-icons">calendar_today</span> Agenda</a></li>
                <li><a href="#" data-section="clientes"><span class="material-icons">people</span> Clientes</a></li>
                <li><a href="#" data-section="servicos"><span class="material-icons">local_offer</span> Serviços</a></li>
                <li><a href="#" data-section="historico"><span class="material-icons">history</span> Histórico/Lucros</a></li>
            </ul>

            <div class="user-info">
                <p id="userInfo">Olá, Tati!</p>
                <button id="logout-button" class="btn-danger" style="width: 100%;">
                    <span class="material-icons">logout</span> Sair
                </button>
            </div>
        </aside>

        <main class="main-content">

            <div id="agenda-section" class="content-section active">
                
                <div class="tab-menu">
                     <button class="tab-button active" onclick="showAgendaTab('pacotes-ativos')">Pacotes Ativos</button>
                     <button class="tab-button" onclick="showAgendaTab('novo-agendamento')">Novo Agendamento</button>
                     <button class="tab-button" onclick="showAgendaTab('lista-agendamentos')">Lista Agendamentos</button>
                     <button class="tab-button" onclick="showAgendaTab('visao-diaria')">Visão Diária</button>
                </div>
                
                <div class="tab-content">
                    
                    <div id="pacotes-ativos-pane" class="tab-pane active">
                         <div class="section-header"><h2>Gerenciamento de Pacotes Ativos</h2></div>
                         <div class="card">
                            <form id="pacote-inicio-form">
                                <h3>Iniciar Novo Pacote de Serviços</h3>
                                <div class="form-row">
                                    <div class="form-group" style="flex: 2;">
                                        <label for="pacote-cliente-id">Cliente</label>
                                        <select id="pacote-cliente-id" required></select>
                                    </div>
                                    <div class="form-group" style="flex: 2;">
                                        <label for="pacote-servico-id">Pacote (Serviços marcados como Pacote)</label>
                                        <select id="pacote-servico-id" required></select>
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label for="pacote-data-inicio">Data Início (Geralmente Hoje)</label>
                                        <input type="date" id="pacote-data-inicio" required>
                                    </div>
                                </div>

                                <div class="flex-container">
                                    <button type="submit" class="btn-primary">
                                        <span class="material-icons">add_box</span> Iniciar/Vender Pacote
                                    </button>
                                </div>
                            </form>
                            
                            <hr style="margin: 20px 0;">

                            <h3>Pacotes Ativos e Utilização</h3>
                            <div style="max-height: 500px; overflow-y: auto;">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 20%;">Cliente</th>
                                            <th style="width: 25%;">Pacote (Total/Usado)</th>
                                            <th style="width: 15%;">Pagamento</th>
                                            <th style="width: 15%;">Vencimento</th>
                                            <th style="width: 280px;">Ações</th> </tr>
                                    </thead>
                                    <tbody id="lista-pacotes-ativos">
                                        <tr><td colspan="5" style="text-align: center;">Carregando pacotes ativos...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div id="novo-agendamento-pane" class="tab-pane">
                        <div class="section-header"><h2>Agendamento de Serviços Individuais (Não-Pacote)</h2></div>
                         <div class="card">
                            <form id="agendamento-form">
                                <input type="hidden" id="agendamento-id">
                                
                                <div class="form-row">
                                    <div class="form-group" style="flex: 2;">
                                        <label for="agenda-cliente-id">Cliente</label>
                                        <select id="agenda-cliente-id" required></select>
                                    </div>
                                    <div class="form-group" style="flex: 2;">
                                        <label for="agenda-servico-id">Serviço Individual/Promoção</label>
                                        <select id="agenda-servico-id" required></select>
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label for="agenda-data">Data</label>
                                        <input type="date" id="agenda-data" required>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group" style="flex: 1;">
                                        <label for="agenda-hora">Hora Início</label>
                                        <input type="time" id="agenda-hora" required>
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label for="agenda-hora-fim">Hora Fim</label>
                                        <input type="time" id="agenda-hora-fim" required>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="agenda-observacoes">Observações</label>
                                    <textarea id="agenda-observacoes" rows="2"></textarea>
                                </div>

                                <div class="flex-container">
                                    <div>
                                        <button type="submit" class="btn-success" id="btn-salvar-agendamento">
                                            <span class="material-icons">save</span> Salvar Agendamento
                                        </button>
                                        <button type="button" class="btn-secondary" onclick="resetAgendamentoForm()">
                                            <span class="material-icons">refresh</span> Limpar
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <div id="lista-agendamentos-pane" class="tab-pane">
                        <div class="section-header">
                            <h3>Próximos Agendamentos Individuais (Ativos)</h3>
                        </div>
                        <div class="card">
                            <div class="filter-row">
                                <div style="flex-grow: 1.5;">
                                    <label for="filtro-agenda-data">Filtrar por Data</label>
                                    <input type="date" id="filtro-agenda-data" onchange="carregarAgendamentos()">
                                </div>
                                <div style="flex-grow: 3;">
                                    <label for="filtro-agenda-cliente">Filtrar por Cliente (Digite ou Selecione)</label>
                                    <input type="text" id="filtro-agenda-cliente" list="clientes-datalist" placeholder="Digite o nome do cliente..." onkeyup="filtrarAgendamentos()">
                                </div>
                                <button class="btn-secondary" onclick="resetFiltroAgenda()"><span class="material-icons">refresh</span> Resetar Filtro</button>
                            </div>
                            
                            <div style="max-height: 500px; overflow-y: auto;">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 15%;">Data/Hora</th>
                                            <th style="width: 25%;">Cliente</th>
                                            <th style="width: 25%;">Serviço</th>
                                            <th>Status</th>
                                            <th style="width: 280px;">Ações</th> </tr>
                                    </thead>
                                    <tbody id="lista-agendamentos">
                                        <tr><td colspan="5" style="text-align: center;">Carregando agendamentos...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div id="visao-diaria-pane" class="tab-pane">
                        <div class="section-header">
                            <h2>Visão Diária da Agenda</h2>
                        </div>
                        <div class="card">
                            <div class="filter-row">
                                <div style="flex-grow: 1;">
                                    <label for="filtro-visao-diaria-data">Selecione a Data</label>
                                    <input type="date" id="filtro-visao-diaria-data" onchange="renderizarVisaoDiaria()">
                                </div>
                                <button class="btn-secondary" onclick="renderizarVisaoDiaria(today)"><span class="material-icons">today</span> Ver Hoje</button>
                            </div>
                            <div class="table-responsive">
                                <table class="data-table" id="tabela-visao-diaria">
                                    <thead>
                                        <tr>
                                            <th style="width: 100px;">Horário</th>
                                            <th>Detalhes do Agendamento</th>
                                        </tr>
                                    </thead>
                                    <tbody id="lista-visao-diaria">
                                        <tr><td colspan="2" style="text-align: center;">Selecione uma data para visualizar.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                </div>
            </div>

            <div id="clientes-section" class="content-section">
                <div class="section-header"><h2>Cadastro de Clientes</h2></div>
                <div class="card">
                    <form id="cliente-form">
                        <input type="hidden" id="cliente-id">
                        <div class="form-row">
                            <div class="form-group" style="flex: 2;">
                                <label for="cliente-nome">Nome Completo</label>
                                <input type="text" id="cliente-nome" required>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label for="cliente-telefone">Telefone (Whatsapp)</label>
                                <input type="tel" id="cliente-telefone">
                            </div>
                        </div>
                        <div class="form-group" style="display: none;"> <label for="cliente-email">E-mail (Opcional)</label>
                            <input type="email" id="cliente-email">
                        </div>
                        <div class="form-group">
                            <label for="cliente-endereco">Endereço (Opcional)</label>
                            <input type="text" id="cliente-endereco">
                        </div>
                        <div class="form-group">
                            <label for="cliente-observacoes">Observações (Alergias, Preferências)</label>
                            <textarea id="cliente-observacoes" rows="2"></textarea>
                        </div>
                        <div class="flex-container">
                            <div>
                                <button type="submit" class="btn-success" id="btn-salvar-cliente">
                                    <span class="material-icons">save</span> Salvar Cliente
                                </button>
                                <button type="button" class="btn-secondary" onclick="resetClienteForm()">
                                    <span class="material-icons">refresh</span> Limpar
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
                
                <div class="section-header">
                    <h3>Lista de Clientes Cadastrados</h3>
                    <div class="input-group" style="width: 300px;">
                        <input type="text" id="filtro-clientes" list="clientes-datalist" placeholder="Filtrar por nome, tel ou email..." onkeyup="filtrarClientes()">
                    </div>
                </div>
                <div class="card">
                    <div style="max-height: 500px; overflow-y: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th style="width: 30%;">Nome</th>
                                    <th style="width: 20%;">Telefone</th>
                                    <th style="width: 30%;">Endereço</th> <th style="width: 150px;">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="lista-clientes">
                                <tr><td colspan="4" style="text-align: center;">Carregando clientes...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="servicos-section" class="content-section">
                <div class="section-header"><h2>Cadastro de Serviços/Pacotes</h2></div>
                <div class="card">
                    <form id="servico-form">
                        <input type="hidden" id="servico-id">
                        <div class="form-row">
                            <div class="form-group" style="flex: 2;">
                                <label for="servico-nome">Nome do Serviço</label>
                                <input type="text" id="servico-nome" required>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label for="servico-preco">Preço (R$)</label>
                                <input type="number" id="servico-preco" step="0.01" min="0" required value="0.00">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <label>
                                    <input type="checkbox" id="servico-isPacote"> É um **Pacote Mensal**?
                                </label>
                            </div>
                            <div class="form-group" id="group-quantidade-total" style="flex: 1; display: none;">
                                <label for="servico-quantidade-total">Total de Procedimentos no Pacote (ex: 6)</label>
                                <input type="number" id="servico-quantidade-total" min="1" value="1">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="servico-descricao">Descrição Detalhada (ex: 4 Mãos e 2 Pés)</label>
                            <textarea id="servico-descricao" rows="2"></textarea>
                        </div>
                        <div class="flex-container">
                            <div>
                                <button type="submit" class="btn-success" id="btn-salvar-servico">
                                    <span class="material-icons">save</span> Salvar Serviço
                                </button>
                                <button type="button" class="btn-secondary" onclick="resetServicoForm()">
                                    <span class="material-icons">refresh</span> Limpar
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
                
                <div class="section-header">
                    <h3>Lista de Serviços e Preços</h3>
                </div>
                <div class="card">
                    <div style="max-height: 500px; overflow-y: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th style="width: 40%;">Serviço</th>
                                    <th style="width: 15%;">Tipo</th>
                                    <th style="width: 15%;">Total Proc.</th>
                                    <th style="width: 15%;">Preço</th>
                                    <th style="width: 150px;">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="lista-servicos">
                                <tr><td colspan="5" style="text-align: center;">Carregando serviços...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="historico-section" class="content-section"> </div>
            
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
        import { getDatabase, ref, onValue, push, set, update, remove } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

        // =================================================================
        // 1.1. CONFIGURAÇÃO FIREBASE E VARIÁVEIS GLOBAIS
        // =================================================================
        
        // Sua configuração do Firebase (dados enviados por você)
        const firebaseConfig = {
            apiKey: "AIzaSyBatp6e1NzevurpB2yS8eGErgSYC_t2-Nc", 
            authDomain: "tati-manicure.firebaseapp.com",
            // CORREÇÃO CRÍTICA: URL do Firebase corrigida!
            databaseURL: "https://tati-manicure-app-default-rtdb.firebaseio.com", 
            projectId: "tati-manicure",
            storageBucket: "tati-manicure.firebaseapp.com",
            messagingSenderId: "1061777323027",
            appId: "1:1061777323027:web:7b54e5fdbb7f06ee293be6",
            measurementId: "G-V3J5ZJ5XBT"
        };
        
        // Inicialização do Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        // Referências aos nós (listas/tabelas) do seu banco de dados
        const clientesRef = ref(db, 'clientes');
        const servicosRef = ref(db, 'servicos');
        const agendamentosRef = ref(db, 'agendamentos'); // Nó para salvar agendamentos
        const pacotesAtivosRef = ref(db, 'pacotes_ativos');
        const historicoRef = ref(db, 'historico');
        const SENHA_UNICA = "tati123";

        // Caches de Dados
        let cacheClientes = {};
        let cacheServicos = {};
        let cachePacotes = {};
        let agendamentosAtivos = [];
        let cacheAgendamentos = {}; // Cache de todos os agendamentos (para lookup em reverter)

        // =================================================================
        // 1. LÓGICA DE LOGIN, NAVEGAÇÃO E NOTIFICAÇÃO
        // =================================================================

        const loginContainer = document.getElementById('login-container');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const logoutButton = document.getElementById('logout-button');
        const navLinks = document.querySelectorAll('.sidebar ul li a');
        const contentSections = document.querySelectorAll('.content-section');
        const userInfoDisplay = document.getElementById('userInfo');
        const notificationBar = document.getElementById('notification-bar');
        const clientesDatalist = document.getElementById('clientes-datalist');
        const today = new Date().toISOString().slice(0, 10);

        function showApp(userName = 'Tati') {
            loginContainer.style.display = 'none';
            appContainer.style.display = 'flex';
            userInfoDisplay.textContent = `Olá, ${userName}!`;
            
            carregarClientes();
            carregarServicos();
            carregarPacotesAtivos();

            // Define o filtro de data da agenda como o dia atual e carrega
            document.getElementById('filtro-agenda-data').value = today;
            carregarAgendamentos();
            
            // V6: Define a data de hoje para a Visão Diária e renderiza
            document.getElementById('filtro-visao-diaria-data').value = today;
            renderizarVisaoDiaria();
        }

        function showLogin() {
            loginContainer.style.display = 'flex';
            appContainer.style.display = 'none';
        }

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const senha = document.getElementById('loginSenha').value;
            if (senha === SENHA_UNICA) {
                showApp();
                showNotification(`Acesso liberado! Bem-vinda.`, 'success');
            } else {
                showNotification('Senha incorreta.', 'error');
            }
            document.getElementById('loginSenha').value = '';
        });

        logoutButton.addEventListener('click', () => {
            showLogin();
            showNotification('Você saiu do sistema.', 'info');
        });

        // Navegação entre Telas
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetSectionId = e.currentTarget.getAttribute('data-section');

                // Recarrega as listas quando as abas são clicadas
                if (targetSectionId === 'clientes') { carregarClientes(); }
                if (targetSectionId === 'servicos') { carregarServicos(); }
                if (targetSectionId === 'historico') { carregarHistorico(); }

                if (targetSectionId === 'agenda') {
                    popularSelects(); // Garante que o datalist também seja populado (feito em carregarClientes)
                    if (!document.getElementById('filtro-agenda-data').value) {
                        document.getElementById('filtro-agenda-data').value = today;
                    }
                    carregarAgendamentos();
                    carregarPacotesAtivos();
                    // V6: Reseta para o filtro de hoje na Visão Diária
                    document.getElementById('filtro-visao-diaria-data').value = today;
                    renderizarVisaoDiaria();
                    // V6: Garante que o primeiro TAB seja o ativo
                    showAgendaTab('pacotes-ativos');
                }

                navLinks.forEach(l => l.classList.remove('active'));
                contentSections.forEach(s => s.classList.remove('active'));
                e.currentTarget.classList.add('active');
                document.getElementById(`${targetSectionId}-section`).classList.add('active');
            });
        });

        // V6: Função para Navegação de Tabs dentro da Agenda
        window.showAgendaTab = function(tabName) {
            document.querySelectorAll('#agenda-section .tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('#agenda-section .tab-pane').forEach(pane => pane.classList.remove('active'));

            document.querySelector(`.tab-button[onclick*='${tabName}']`).classList.add('active');
            document.getElementById(`${tabName}-pane`).classList.add('active');

            // Lógicas específicas ao clicar nas abas
            if (tabName === 'lista-agendamentos') {
                carregarAgendamentos(); // Recarrega a lista
            }
            if (tabName === 'visao-diaria') {
                // Se não tem data, define para hoje e renderiza
                if (!document.getElementById('filtro-visao-diaria-data').value) {
                    document.getElementById('filtro-visao-diaria-data').value = today;
                }
                renderizarVisaoDiaria();
            }
        }


        function showNotification(message, type) {
            notificationBar.textContent = message;
            notificationBar.className = `show ${type}`;
            setTimeout(() => {
                notificationBar.className = '';
            }, 3000);
        }


        // =================================================================
        // 2. FUNÇÕES COMPARTILHADAS (POPULATE SELECTS)
        // =================================================================

        function popularSelects() {
            // Popula selects de Cliente
            const clienteSelects = document.querySelectorAll('#pacote-cliente-id, #agenda-cliente-id');
            clienteSelects.forEach(select => {
                select.innerHTML = '<option value="">-- Selecione o Cliente --</option>';
                for (const id in cacheClientes) {
                    const cliente = cacheClientes[id];
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = cliente.nome;
                    select.appendChild(option);
                }
            });

            // Popula selects de Serviço (Pacote e Individual)
            const pacoteSelect = document.getElementById('pacote-servico-id');
            const agendaSelect = document.getElementById('agenda-servico-id');
            pacoteSelect.innerHTML = '<option value="">-- Selecione o Pacote --</option>';
            agendaSelect.innerHTML = '<option value="">-- Selecione o Serviço/Promoção --</option>';
            
            for (const id in cacheServicos) {
                const servico = cacheServicos[id];
                const option = document.createElement('option');
                option.value = id;
                option.textContent = `${servico.nome} (R$ ${parseFloat(servico.preco).toFixed(2).replace('.', ',')})`;

                if (servico.isPacote) {
                    pacoteSelect.appendChild(option.cloneNode(true)); // Adiciona ao select de Pacotes
                } else {
                    agendaSelect.appendChild(option); // Adiciona ao select de Agendamentos
                }
            }
        }


        // =================================================================
        // 3. SEÇÃO CLIENTES
        // =================================================================

        const clienteForm = document.getElementById('cliente-form');
        const listaClientes = document.getElementById('lista-clientes');

        // 3.1. SALVAR/EDITAR CLIENTE
        clienteForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const clienteId = document.getElementById('cliente-id').value;
            const nome = document.getElementById('cliente-nome').value;
            const telefone = document.getElementById('cliente-telefone').value;
            const email = document.getElementById('cliente-email').value;
            const endereco = document.getElementById('cliente-endereco').value;
            const observacoes = document.getElementById('cliente-observacoes').value;
            
            const novoCliente = { nome, telefone, email, endereco, observacoes };
            
            const refParaSalvar = clienteId ? ref(db, `clientes/${clienteId}`) : clientesRef;

            // Salva no Firebase
            set(refParaSalvar, novoCliente)
                .then(() => {
                    showNotification(`Cliente ${nome} ${clienteId ? 'atualizado' : 'adicionado'} com sucesso!`, 'success');
                    resetClienteForm();
                    carregarClientes(); // Recarrega para atualizar o cache e a tabela
                })
                .catch(error => {
                    showNotification('Erro ao salvar cliente: ' + error.message, 'error');
                });
        });

        // 3.2. CARREGAR CLIENTES DO FIREBASE
        window.carregarClientes = function() {
            onValue(clientesRef, (snapshot) => {
                cacheClientes = {};
                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        const clienteId = childSnapshot.key;
                        const clienteData = childSnapshot.val();
                        cacheClientes[clienteId] = { ...clienteData, id: clienteId };
                    });
                }
                renderizarClientes();
                popularDatalistClientes(); // Popula o Datalist
                popularSelects(); // Popula os Selects de cliente/pacote
            }, {
                onlyOnce: false
            });
        }

        // 3.3. RENDERIZAR CLIENTES NA TABELA
        function renderizarClientes() {
            listaClientes.innerHTML = ''; // Limpa a lista
            const clientesArray = Object.values(cacheClientes).sort((a, b) => a.nome.localeCompare(b.nome));

            if (clientesArray.length === 0) {
                listaClientes.innerHTML = '<tr><td colspan="4" style="text-align: center;">Nenhum cliente cadastrado.</td></tr>';
                return;
            }

            clientesArray.forEach(cliente => {
                const row = document.createElement('tr');
                row.dataset.clienteNome = cliente.nome.toLowerCase(); // Para filtro em mobile

                // Rótulos de Mobile
                const nomeCell = document.createElement('td');
                nomeCell.textContent = cliente.nome;
                nomeCell.setAttribute('data-label', 'Nome');
                row.appendChild(nomeCell);

                const telefoneCell = document.createElement('td');
                telefoneCell.textContent = cliente.telefone || 'N/A';
                telefoneCell.setAttribute('data-label', 'Telefone');
                row.appendChild(telefoneCell);

                // CORRIGIDO: Exibe Endereço
                const enderecoCell = document.createElement('td');
                enderecoCell.textContent = cliente.endereco || 'N/A';
                enderecoCell.setAttribute('data-label', 'Endereço');
                row.appendChild(enderecoCell);

                const actionCell = document.createElement('td');
                actionCell.classList.add('action-buttons');
                actionCell.setAttribute('data-label', 'Ações');

                // Botão Editar
                const btnEditar = document.createElement('button');
                btnEditar.innerHTML = '<span class="material-icons">edit</span> Editar';
                btnEditar.classList.add('btn', 'btn-warning');
                btnEditar.onclick = () => editarCliente(cliente.id);
                actionCell.appendChild(btnEditar);

                // Botão Excluir
                const btnExcluir = document.createElement('button');
                btnExcluir.innerHTML = '<span class="material-icons">delete</span> Excluir';
                btnExcluir.classList.add('btn', 'btn-danger');
                btnExcluir.onclick = () => excluirCliente(cliente.id, cliente.nome);
                actionCell.appendChild(btnExcluir);

                row.appendChild(actionCell);
                listaClientes.appendChild(row);
            });
        }
        
        // 3.4. POPULAR DATALIST PARA FILTROS
        function popularDatalistClientes() {
            clientesDatalist.innerHTML = '';
            for (const id in cacheClientes) {
                const cliente = cacheClientes[id];
                const option = document.createElement('option');
                option.value = cliente.nome;
                clientesDatalist.appendChild(option);
            }
        }

        // 3.5. EDITAR CLIENTE
        window.editarCliente = function(id) {
            const cliente = cacheClientes[id];
            if (!cliente) return;
            
            document.getElementById('cliente-id').value = id;
            document.getElementById('cliente-nome').value = cliente.nome;
            document.getElementById('cliente-telefone').value = cliente.telefone;
            document.getElementById('cliente-email').value = cliente.email;
            document.getElementById('cliente-endereco').value = cliente.endereco;
            document.getElementById('cliente-observacoes').value = cliente.observacoes;
            
            document.getElementById('btn-salvar-cliente').innerHTML = '<span class="material-icons">update</span> Atualizar Cliente';
            
            showNotification(`Editando cliente: ${cliente.nome}.`, 'info');
            // Leva para o topo do cadastro
            document.getElementById('clientes-section').scrollIntoView({ behavior: 'smooth' });
        }

        // 3.6. EXCLUIR CLIENTE
        window.excluirCliente = function(id, nome) {
            if (confirm(`Tem certeza que deseja EXCLUIR o cliente ${nome} e todos os seus agendamentos/pacotes?`)) {
                // Remove cliente
                const clienteRemoverRef = ref(db, `clientes/${id}`);
                remove(clienteRemoverRef)
                    .then(() => {
                        showNotification(`Cliente ${nome} excluído com sucesso!`, 'success');
                        // Lógica extra para remover agendamentos e pacotes relacionados (OPCIONAL, mas recomendado)
                        // ...
                        carregarClientes();
                    })
                    .catch(error => {
                        showNotification('Erro ao excluir cliente: ' + error.message, 'error');
                    });
            }
        }

        // 3.7. RESETAR FORMULÁRIO DE CLIENTE
        window.resetClienteForm = function() {
            clienteForm.reset();
            document.getElementById('cliente-id').value = '';
            document.getElementById('btn-salvar-cliente').innerHTML = '<span class="material-icons">save</span> Salvar Cliente';
        }
        
        // 3.8. FILTRAR CLIENTES NA TABELA
        window.filtrarClientes = function() {
             const filtro = document.getElementById('filtro-clientes').value.toLowerCase();
             const linhas = listaClientes.getElementsByTagName('tr');

             for (let i = 0; i < linhas.length; i++) {
                 const row = linhas[i];
                 if (!row.dataset.clienteNome) continue; 

                 // Pega os dados brutos de cada célula
                 const nome = row.cells[0].textContent.toLowerCase();
                 const telefone = row.cells[1].textContent.toLowerCase();
                 // Endereço na posição 2 agora
                 const endereco = row.cells[2].textContent.toLowerCase(); 
                
                 if (nome.includes(filtro) || telefone.includes(filtro) || endereco.includes(filtro)) {
                     row.style.display = "table-row";
                 } else {
                     row.style.display = "none";
                 }
             }
        }


        // =================================================================
        // 4. SEÇÃO SERVIÇOS/PACOTES
        // =================================================================

        const servicoForm = document.getElementById('servico-form');
        const listaServicos = document.getElementById('lista-servicos');
        const servicoIsPacoteCheckbox = document.getElementById('servico-isPacote');
        const groupQuantidadeTotal = document.getElementById('group-quantidade-total');

        // Toggle do campo de quantidade total
        servicoIsPacoteCheckbox.addEventListener('change', () => {
            groupQuantidadeTotal.style.display = servicoIsPacoteCheckbox.checked ? 'block' : 'none';
            document.getElementById('servico-quantidade-total').required = servicoIsPacoteCheckbox.checked;
        });

        // 4.1. SALVAR/EDITAR SERVIÇO
        servicoForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const servicoId = document.getElementById('servico-id').value;
            const nome = document.getElementById('servico-nome').value;
            const preco = parseFloat(document.getElementById('servico-preco').value).toFixed(2);
            const descricao = document.getElementById('servico-descricao').value;
            const isPacote = servicoIsPacoteCheckbox.checked;
            const quantidadeTotal = isPacote ? parseInt(document.getElementById('servico-quantidade-total').value) : 0;
            
            const novoServico = { nome, preco, descricao, isPacote, quantidadeTotal };
            
            const refParaSalvar = servicoId ? ref(db, `servicos/${servicoId}`) : servicosRef;

            set(refParaSalvar, novoServico)
                .then(() => {
                    showNotification(`Serviço ${nome} ${servicoId ? 'atualizado' : 'adicionado'} com sucesso!`, 'success');
                    resetServicoForm();
                    carregarServicos();
                })
                .catch(error => {
                    showNotification('Erro ao salvar serviço: ' + error.message, 'error');
                });
        });

        // 4.2. CARREGAR SERVIÇOS DO FIREBASE
        window.carregarServicos = function() {
            onValue(servicosRef, (snapshot) => {
                cacheServicos = {};
                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        const servicoId = childSnapshot.key;
                        const servicoData = childSnapshot.val();
                        cacheServicos[servicoId] = { ...servicoData, id: servicoId };
                    });
                }
                renderizarServicos();
                popularSelects();
            }, {
                onlyOnce: false
            });
        }

        // 4.3. RENDERIZAR SERVIÇOS NA TABELA
        function renderizarServicos() {
            listaServicos.innerHTML = '';
            const servicosArray = Object.values(cacheServicos).sort((a, b) => a.nome.localeCompare(b.nome));

            if (servicosArray.length === 0) {
                listaServicos.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nenhum serviço/pacote cadastrado.</td></tr>';
                return;
            }

            servicosArray.forEach(servico => {
                const row = document.createElement('tr');
                
                const tipo = servico.isPacote ? 'Pacote' : 'Individual';
                const totalProc = servico.isPacote ? servico.quantidadeTotal : '-';

                // Rótulos de Mobile
                row.innerHTML = `
                    <td data-label="Serviço">${servico.nome}</td>
                    <td data-label="Tipo">${tipo}</td>
                    <td data-label="Total Proc.">${totalProc}</td>
                    <td data-label="Preço">R$ ${parseFloat(servico.preco).toFixed(2).replace('.', ',')}</td>
                    <td class="action-buttons" data-label="Ações">
                        <button class="btn btn-warning" onclick="editarServico('${servico.id}')"><span class="material-icons">edit</span> Editar</button>
                        <button class="btn btn-danger" onclick="excluirServico('${servico.id}', '${servico.nome}')"><span class="material-icons">delete</span> Excluir</button>
                    </td>
                `;
                listaServicos.appendChild(row);
            });
        }

        // 4.4. EDITAR SERVIÇO
        window.editarServico = function(id) {
            const servico = cacheServicos[id];
            if (!servico) return;
            
            document.getElementById('servico-id').value = id;
            document.getElementById('servico-nome').value = servico.nome;
            document.getElementById('servico-preco').value = parseFloat(servico.preco).toFixed(2);
            document.getElementById('servico-descricao').value = servico.descricao;
            servicoIsPacoteCheckbox.checked = servico.isPacote;
            document.getElementById('servico-quantidade-total').value = servico.quantidadeTotal;

            // Trigger o evento change para mostrar/esconder o campo de quantidade
            servicoIsPacoteCheckbox.dispatchEvent(new Event('change'));
            
            document.getElementById('btn-salvar-servico').innerHTML = '<span class="material-icons">update</span> Atualizar Serviço';
            
            showNotification(`Editando serviço: ${servico.nome}.`, 'info');
            document.getElementById('servicos-section').scrollIntoView({ behavior: 'smooth' });
        }

        // 4.5. EXCLUIR SERVIÇO
        window.excluirServico = function(id, nome) {
            if (confirm(`Tem certeza que deseja EXCLUIR o serviço/pacote ${nome}?`)) {
                const servicoRemoverRef = ref(db, `servicos/${id}`);
                remove(servicoRemoverRef)
                    .then(() => {
                        showNotification(`Serviço ${nome} excluído com sucesso!`, 'success');
                        carregarServicos();
                    })
                    .catch(error => {
                        showNotification('Erro ao excluir serviço: ' + error.message, 'error');
                    });
            }
        }

        // 4.6. RESETAR FORMULÁRIO DE SERVIÇO
        window.resetServicoForm = function() {
            servicoForm.reset();
            document.getElementById('servico-id').value = '';
            document.getElementById('servico-preco').value = '0.00';
            servicoIsPacoteCheckbox.checked = false;
            servicoIsPacoteCheckbox.dispatchEvent(new Event('change')); // Esconde o campo de quantidade
            document.getElementById('btn-salvar-servico').innerHTML = '<span class="material-icons">save</span> Salvar Serviço';
        }


        // =================================================================
        // 5. SEÇÃO AGENDA - PACOTES ATIVOS
        // =================================================================

        const pacoteInicioForm = document.getElementById('pacote-inicio-form');
        const listaPacotesAtivos = document.getElementById('lista-pacotes-ativos');

        // 5.1. INICIAR/VENDER NOVO PACOTE
        pacoteInicioForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const clienteId = document.getElementById('pacote-cliente-id').value;
            const servicoId = document.getElementById('pacote-servico-id').value;
            const dataInicio = document.getElementById('pacote-data-inicio').value;
            
            if (!clienteId || !servicoId) {
                showNotification('Selecione um cliente e um pacote.', 'error');
                return;
            }

            const cliente = cacheClientes[clienteId];
            const servico = cacheServicos[servicoId];
            
            if (!servico || !servico.isPacote) {
                showNotification('O serviço selecionado não é um pacote. Use a aba "Novo Agendamento".', 'error');
                return;
            }
            
            // Define o vencimento para 30 dias depois (aproximadamente 1 mês)
            const dataVencimento = new Date(dataInicio);
            dataVencimento.setDate(dataVencimento.getDate() + 30);
            const vencimento = dataVencimento.toISOString().slice(0, 10);
            
            const novoPacote = {
                clienteId: clienteId,
                clienteNome: cliente.nome,
                servicoId: servicoId,
                servicoNome: servico.nome,
                servicoPreco: servico.preco,
                quantidadeTotal: servico.quantidadeTotal,
                quantidadeUsada: 0,
                dataInicio: dataInicio,
                dataVencimento: vencimento,
                status: 'ativo' // 'ativo', 'pendente_pgto', 'finalizado', 'expirado'
            };

            push(pacotesAtivosRef, novoPacote)
                .then(() => {
                    showNotification(`Pacote ${servico.nome} para ${cliente.nome} iniciado com sucesso!`, 'success');
                    pacoteInicioForm.reset();
                })
                .catch(error => {
                    showNotification('Erro ao iniciar pacote: ' + error.message, 'error');
                });
        });

        // 5.2. CARREGAR PACOTES ATIVOS
        window.carregarPacotesAtivos = function() {
            onValue(pacotesAtivosRef, (snapshot) => {
                cachePacotes = {};
                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        const pacoteId = childSnapshot.key;
                        const pacoteData = childSnapshot.val();
                        
                        // Lógica para verificar e atualizar o status de expirado
                        if (pacoteData.status === 'ativo') {
                            const hoje = new Date(today);
                            const vencimento = new Date(pacoteData.dataVencimento);
                            
                            if (hoje > vencimento && pacoteData.quantidadeUsada < pacoteData.quantidadeTotal) {
                                // Se expirou, atualiza o status no banco
                                update(ref(db, `pacotes_ativos/${pacoteId}`), { status: 'expirado' })
                                    .catch(err => console.error('Erro ao atualizar status do pacote:', err));
                                pacoteData.status = 'expirado'; // Atualiza o cache temporariamente
                            }
                        }
                        
                        cachePacotes[pacoteId] = { ...pacoteData, id: pacoteId };
                    });
                }
                renderizarPacotesAtivos();
            }, {
                onlyOnce: false
            });
        }

        // 5.3. RENDERIZAR PACOTES ATIVOS NA TABELA
        function renderizarPacotesAtivos() {
            listaPacotesAtivos.innerHTML = '';
            const pacotesArray = Object.values(cachePacotes).sort((a, b) => {
                // Ordena ativos primeiro
                if (a.status === 'ativo' && b.status !== 'ativo') return -1;
                if (a.status !== 'ativo' && b.status === 'ativo') return 1;
                return a.clienteNome.localeCompare(b.clienteNome);
            });

            if (pacotesArray.length === 0) {
                listaPacotesAtivos.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nenhum pacote ativo.</td></tr>';
                return;
            }

            pacotesArray.forEach(pacote => {
                const row = document.createElement('tr');
                let statusText = '';
                let statusClass = '';

                switch (pacote.status) {
                    case 'ativo':
                        statusText = 'Ativo';
                        statusClass = 'status-package-active';
                        break;
                    case 'pendente_pgto':
                        statusText = 'Pagamento Pendente';
                        statusClass = 'status-package-pending';
                        break;
                    case 'finalizado':
                        statusText = 'Finalizado';
                        statusClass = 'status-package-paid';
                        break;
                    case 'expirado':
                        statusText = 'Expirado';
                        statusClass = 'status-package-finalized';
                        break;
                    default:
                        statusText = pacote.status;
                        statusClass = '';
                }
                
                // Formatação da data
                const vencimentoFormatado = pacote.dataVencimento ? new Date(pacote.dataVencimento).toLocaleDateString('pt-BR') : 'N/A';
                
                // Rótulos de Mobile
                row.innerHTML = `
                    <td data-label="Cliente">${pacote.clienteNome}</td>
                    <td data-label="Pacote (Total/Usado)">${pacote.servicoNome} (${pacote.quantidadeTotal}/${pacote.quantidadeUsada})</td>
                    <td data-label="Pagamento"><span class="${statusClass}">${statusText}</span></td>
                    <td data-label="Vencimento">${vencimentoFormatado}</td>
                    <td class="action-buttons" data-label="Ações">
                        ${pacote.status === 'ativo' && pacote.quantidadeUsada < pacote.quantidadeTotal ? 
                            `<button class="btn btn-primary" onclick="usarPacote('${pacote.id}', '${pacote.clienteNome}', '${pacote.servicoNome}')"><span class="material-icons">check_circle</span> Usar Serviço</button>` : 
                            `<button class="btn btn-secondary" disabled><span class="material-icons">block</span> ${pacote.quantidadeUsada >= pacote.quantidadeTotal ? 'Esgotado' : 'Encerrado'}</button>`
                        }
                        <button class="btn btn-danger" onclick="excluirPacote('${pacote.id}', '${pacote.clienteNome}')"><span class="material-icons">delete</span> Excluir</button>
                    </td>
                `;
                listaPacotesAtivos.appendChild(row);
            });
        }
        
        // 5.4. USAR SERVIÇO DO PACOTE
        window.usarPacote = function(id, clienteNome, servicoNome) {
            const pacote = cachePacotes[id];
            
            if (!pacote) return;
            
            if (pacote.quantidadeUsada >= pacote.quantidadeTotal) {
                showNotification('Este pacote já foi totalmente utilizado.', 'error');
                return;
            }
            
            if (pacote.status !== 'ativo') {
                showNotification('Este pacote não está ativo para uso.', 'error');
                return;
            }
            
            if (confirm(`Confirmar o uso de 1 procedimento do Pacote **${servicoNome}** para **${clienteNome}**?`)) {
                
                const quantidadeUsada = pacote.quantidadeUsada + 1;
                let status = 'ativo';
                
                if (quantidadeUsada >= pacote.quantidadeTotal) {
                    status = 'finalizado';
                }
                
                update(ref(db, `pacotes_ativos/${id}`), { quantidadeUsada, status })
                    .then(() => {
                        showNotification(`Uso do pacote registrado. Restam ${pacote.quantidadeTotal - quantidadeUsada} procedimentos.`, 'success');
                        
                        // Adiciona ao histórico também
                        const historicoItem = {
                            clienteId: pacote.clienteId,
                            clienteNome: pacote.clienteNome,
                            tipo: 'pacote', // Indica que é um uso de pacote
                            servico: pacote.servicoNome,
                            valor: 0, // Não gera lucro aqui, apenas indica o uso
                            data: today,
                            hora: new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }),
                            pacoteId: id,
                            observacoes: `Uso de procedimento do pacote ${pacote.servicoNome}.`
                        };
                        push(historicoRef, historicoItem);
                        
                        carregarPacotesAtivos(); // Recarrega a lista
                    })
                    .catch(error => {
                        showNotification('Erro ao usar pacote: ' + error.message, 'error');
                    });
            }
        }
        
        // 5.5. EXCLUIR PACOTE
        window.excluirPacote = function(id, nome) {
            if (confirm(`Tem certeza que deseja EXCLUIR o pacote ${nome} do cliente ${cachePacotes[id].clienteNome}?`)) {
                const pacoteRemoverRef = ref(db, `pacotes_ativos/${id}`);
                remove(pacoteRemoverRef)
                    .then(() => {
                        showNotification(`Pacote excluído com sucesso!`, 'success');
                        carregarPacotesAtivos();
                    })
                    .catch(error => {
                        showNotification('Erro ao excluir pacote: ' + error.message, 'error');
                    });
            }
        }


        // =================================================================
        // 6. SEÇÃO AGENDA - AGENDAMENTOS INDIVIDUAIS
        // =================================================================

        const agendamentoForm = document.getElementById('agendamento-form');
        const listaAgendamentos = document.getElementById('lista-agendamentos');

        // 6.1. SALVAR/EDITAR AGENDAMENTO
        agendamentoForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const agendamentoId = document.getElementById('agendamento-id').value;
            const clienteId = document.getElementById('agenda-cliente-id').value;
            const servicoId = document.getElementById('agenda-servico-id').value;
            const data = document.getElementById('agenda-data').value;
            const hora = document.getElementById('agenda-hora').value;
            const horaFim = document.getElementById('agenda-hora-fim').value;
            const observacoes = document.getElementById('agenda-observacoes').value;
            
            if (!clienteId || !servicoId || !data || !hora) {
                showNotification('Preencha todos os campos obrigatórios (Cliente, Serviço, Data, Hora Início).', 'error');
                return;
            }

            const cliente = cacheClientes[clienteId];
            const servico = cacheServicos[servicoId];
            
            if (!servico || servico.isPacote) {
                showNotification('Este serviço é um pacote. Use a aba "Pacotes Ativos" para vendê-lo/iniciá-lo.', 'error');
                return;
            }
            
            const novoAgendamento = {
                clienteId: clienteId,
                clienteNome: cliente.nome,
                servicoId: servicoId,
                servicoNome: servico.nome,
                servicoPreco: servico.preco,
                data: data,
                hora: hora,
                horaFim: horaFim,
                observacoes: observacoes,
                status: 'ativo' // 'ativo', 'concluido', 'cancelado'
            };
            
            // CORREÇÃO CRÍTICA: Garantindo que a referência de agendamentos seja correta para push/set
            const refParaSalvar = agendamentoId ? ref(db, `agendamentos/${agendamentoId}`) : agendamentosRef;

            // Se for um novo agendamento, usa push para criar um novo nó com ID único
            const promiseSalvar = agendamentoId 
                ? update(refParaSalvar, novoAgendamento) // Se for edição, usa update
                : push(agendamentosRef, novoAgendamento); // Se for novo, usa push

            promiseSalvar
                .then(() => {
                    showNotification(`Agendamento para ${cliente.nome} ${agendamentoId ? 'atualizado' : 'salvo'} com sucesso!`, 'success');
                    
                    resetAgendamentoForm();
                    carregarAgendamentos();
                    renderizarVisaoDiaria(); // Atualiza a visão diária
                })
                .catch(error => {
                    showNotification('Erro ao salvar agendamento: ' + error.message, 'error');
                });
        });
        
        // 6.2. CARREGAR AGENDAMENTOS DO FIREBASE
        window.carregarAgendamentos = function() {
            onValue(agendamentosRef, (snapshot) => {
                cacheAgendamentos = {};
                agendamentosAtivos = [];
                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        const agendamentoId = childSnapshot.key;
                        const agendamentoData = childSnapshot.val();
                        const agendamento = { ...agendamentoData, id: agendamentoId };
                        
                        cacheAgendamentos[agendamentoId] = agendamento;
                        
                        // Filtra apenas agendamentos ATIVOS e FUTUROS para a lista
                        const dataFiltro = document.getElementById('filtro-agenda-data').value;
                        
                        if (agendamento.status === 'ativo') {
                            if (!dataFiltro || agendamento.data === dataFiltro) {
                                agendamentosAtivos.push(agendamento);
                            }
                        }
                    });
                }
                
                // Ordena os agendamentos ativos por data e hora
                agendamentosAtivos.sort((a, b) => {
                    if (a.data < b.data) return -1;
                    if (a.data > b.data) return 1;
                    if (a.hora < b.hora) return -1;
                    if (a.hora > b.hora) return 1;
                    return 0;
                });
                
                renderizarAgendamentos();
                // A Visão Diária é renderizada separadamente por `renderizarVisaoDiaria()`
            }, {
                onlyOnce: false
            });
        }

        // 6.3. RENDERIZAR AGENDAMENTOS NA TABELA (LISTA)
        function renderizarAgendamentos() {
            listaAgendamentos.innerHTML = '';
            
            const filtroCliente = document.getElementById('filtro-agenda-cliente').value.toLowerCase();
            
            const agendamentosFiltrados = agendamentosAtivos.filter(agendamento => 
                agendamento.clienteNome.toLowerCase().includes(filtroCliente)
            );

            if (agendamentosFiltrados.length === 0) {
                listaAgendamentos.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nenhum agendamento ativo encontrado para o filtro.</td></tr>';
                return;
            }

            agendamentosFiltrados.forEach(agendamento => {
                const row = document.createElement('tr');
                
                // Formatação
                const dataFormatada = new Date(agendamento.data).toLocaleDateString('pt-BR', { day: '2-digit', month: 'short' });
                const horaFormatada = `${agendamento.hora} - ${agendamento.horaFim}`;
                
                // Rótulos de Mobile
                row.innerHTML = `
                    <td data-label="Data/Hora"><strong>${dataFormatada}</strong><br>${horaFormatada}</td>
                    <td data-label="Cliente">${agendamento.clienteNome}</td>
                    <td data-label="Serviço">${agendamento.servicoNome} (R$ ${parseFloat(agendamento.servicoPreco).toFixed(2).replace('.', ',')})</td>
                    <td data-label="Status"><span class="status-package-active">Ativo</span></td>
                    <td class="action-buttons" data-label="Ações">
                        <button class="btn btn-primary" onclick="concluirAgendamento('${agendamento.id}', '${agendamento.clienteNome}', '${agendamento.servicoNome}')"><span class="material-icons">done_all</span> Concluir</button>
                        <button class="btn btn-warning" onclick="editarAgendamento('${agendamento.id}')"><span class="material-icons">edit</span> Editar</button>
                        <button class="btn btn-danger" onclick="cancelarAgendamento('${agendamento.id}', '${agendamento.clienteNome}')"><span class="material-icons">cancel</span> Cancelar</button>
                    </td>
                `;
                listaAgendamentos.appendChild(row);
            });
        }
        
        // 6.4. EDITAR AGENDAMENTO
        window.editarAgendamento = function(id) {
            const agendamento = cacheAgendamentos[id];
            if (!agendamento) return;
            
            document.getElementById('agendamento-id').value = id;
            document.getElementById('agenda-cliente-id').value = agendamento.clienteId;
            document.getElementById('agenda-servico-id').value = agendamento.servicoId;
            document.getElementById('agenda-data').value = agendamento.data;
            document.getElementById('agenda-hora').value = agendamento.hora;
            document.getElementById('agenda-hora-fim').value = agendamento.horaFim;
            document.getElementById('agenda-observacoes').value = agendamento.observacoes;
            
            document.getElementById('btn-salvar-agendamento').innerHTML = '<span class="material-icons">update</span> Atualizar Agendamento';
            
            showNotification(`Editando agendamento de ${agendamento.clienteNome}.`, 'info');
            showAgendaTab('novo-agendamento'); // Mudar para a aba de formulário
        }

        // 6.5. CONCLUIR AGENDAMENTO
        window.concluirAgendamento = function(id, clienteNome, servicoNome) {
            if (confirm(`Confirmar a conclusão do agendamento para **${clienteNome}** (${servicoNome})? Ele será movido para o histórico.`)) {
                
                const agendamento = cacheAgendamentos[id];
                
                if (!agendamento) {
                    showNotification('Erro: Agendamento não encontrado no cache.', 'error');
                    return;
                }
                
                // 1. Cria item no Histórico
                const historicoItem = {
                    clienteId: agendamento.clienteId,
                    clienteNome: agendamento.clienteNome,
                    tipo: 'servico', // Indica que é um serviço individual
                    servico: agendamento.servicoNome,
                    valor: parseFloat(agendamento.servicoPreco),
                    data: agendamento.data,
                    hora: agendamento.hora,
                    observacoes: agendamento.observacoes
                };
                
                push(historicoRef, historicoItem)
                    .then(() => {
                        // 2. Remove da lista de Agendamentos (ou altera o status)
                        const agendamentoRemoverRef = ref(db, `agendamentos/${id}`);
                        return remove(agendamentoRemoverRef);
                    })
                    .then(() => {
                        showNotification(`Agendamento de ${clienteNome} concluído e movido para Histórico/Lucros.`, 'success');
                        carregarAgendamentos();
                        renderizarVisaoDiaria(); // Atualiza a visão diária
                    })
                    .catch(error => {
                        showNotification('Erro ao concluir agendamento: ' + error.message, 'error');
                    });
            }
        }

        // 6.6. CANCELAR AGENDAMENTO
        window.cancelarAgendamento = function(id, clienteNome) {
            if (confirm(`Tem certeza que deseja CANCELAR o agendamento de **${clienteNome}**?`)) {
                // Remove da lista de Agendamentos
                const agendamentoRemoverRef = ref(db, `agendamentos/${id}`);
                remove(agendamentoRemoverRef)
                    .then(() => {
                        showNotification(`Agendamento de ${clienteNome} cancelado com sucesso!`, 'success');
                        carregarAgendamentos();
                        renderizarVisaoDiaria(); // Atualiza a visão diária
                    })
                    .catch(error => {
                        showNotification('Erro ao cancelar agendamento: ' + error.message, 'error');
                    });
            }
        }
        
        // 6.7. FILTRAR AGENDAMENTOS NA TABELA
        window.filtrarAgendamentos = function() {
             // Chama a função de renderização, que já aplica o filtro de cliente por texto
             renderizarAgendamentos();
        }

        // 6.8. RESETAR FILTRO DA AGENDA
        window.resetFiltroAgenda = function() {
            document.getElementById('filtro-agenda-data').value = today; // Volta para o dia de hoje
            document.getElementById('filtro-agenda-cliente').value = '';
            carregarAgendamentos();
        }

        // 6.9. RESETAR FORMULÁRIO DE AGENDAMENTO
        window.resetAgendamentoForm = function() {
            agendamentoForm.reset();
            document.getElementById('agendamento-id').value = '';
            document.getElementById('btn-salvar-agendamento').innerHTML = '<span class="material-icons">save</span> Salvar Agendamento';
            document.getElementById('agenda-data').value = today; // Seta a data de hoje como padrão
        }


        // =================================================================
        // 7. SEÇÃO AGENDA - VISÃO DIÁRIA
        // =================================================================

        const listaVisaoDiaria = document.getElementById('lista-visao-diaria');

        // 7.1. FUNÇÃO PARA CRIAR CÉLULAS DA AGENDA
        window.renderizarVisaoDiaria = function() {
            
            const dataSelecionada = document.getElementById('filtro-visao-diaria-data').value || today;
            
            // Filtra os agendamentos ATIVOS para a data selecionada
            const agendamentosDoDia = Object.values(cacheAgendamentos)
                .filter(a => a.status === 'ativo' && a.data === dataSelecionada)
                .sort((a, b) => a.hora.localeCompare(b.hora));

            listaVisaoDiaria.innerHTML = ''; // Limpa a lista
            
            // Horários de trabalho (Ex: 08:00 às 20:00, intervalos de 30 min)
            const horaInicio = 8; 
            const horaFim = 20;
            
            let htmlTabela = '';
            
            let agendamentoIndex = 0;

            for (let h = horaInicio; h < horaFim; h++) {
                for (let m = 0; m < 60; m += 30) {
                    const horaAtual = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                    let conteudoCelula = '';
                    let classCelula = 'agendamento-vago';
                    let onClickAction = '';
                    
                    let agendamentoEncontrado = agendamentosDoDia[agendamentoIndex];

                    // Verifica se o agendamento atual se inicia no slot ou já está em andamento
                    if (agendamentoEncontrado) {
                        
                        // Função auxiliar para comparar horas
                        const timeToMinutes = (time) => {
                            const [h, m] = time.split(':').map(Number);
                            return h * 60 + m;
                        };
                        
                        const horaInicioAg = timeToMinutes(agendamentoEncontrado.hora);
                        const horaFimAg = timeToMinutes(agendamentoEncontrado.horaFim);
                        const horaSlot = timeToMinutes(horaAtual);
                        
                        // Se o slot atual está dentro do intervalo do agendamento
                        if (horaSlot >= horaInicioAg && horaSlot < horaFimAg) {
                            
                            // Se o slot é o de início, mostra os detalhes
                            if (horaSlot === horaInicioAg) {
                                classCelula = 'agendamento-ocupado';
                                onClickAction = `onclick="editarAgendamento('${agendamentoEncontrado.id}')"`;
                                
                                conteudoCelula = `
                                    <strong>${agendamentoEncontrado.clienteNome}</strong> - ${agendamentoEncontrado.servicoNome}<br>
                                    ${agendamentoEncontrado.horaFim ? `(Término: ${agendamentoEncontrado.horaFim})` : ''}
                                `;
                            } else {
                                // Se o slot não é o de início, é continuidade, mas ainda o marcamos como ocupado
                                classCelula = 'agendamento-ocupado';
                                conteudoCelula = '... (Continua)';
                            }
                            
                            // Move para o próximo agendamento se este terminou neste slot ou antes
                            if (horaSlot >= horaFimAg - 30) {
                                agendamentoIndex++;
                            }
                            
                        } else {
                            // Slot vazio
                            conteudoCelula = 'Vago';
                        }
                    } else {
                        // Slot vazio
                        conteudoCelula = 'Vago';
                    }
                    
                    // Constrói a linha da tabela
                    htmlTabela += `
                        <tr>
                            <td class="horario-celula">${horaAtual}</td>
                            <td class="${classCelula}" ${onClickAction}>${conteudoCelula}</td>
                        </tr>
                    `;
                }
            }
            
            listaVisaoDiaria.innerHTML = htmlTabela;
        }


        // =================================================================
        // 8. SEÇÃO HISTÓRICO/LUCROS
        // =================================================================

        const historicoSection = document.getElementById('historico-section');

        // 8.1. CARREGAR HISTÓRICO DO FIREBASE
        window.carregarHistorico = function() {
            // Cria a estrutura da página de histórico (para ser recriada a cada clique)
            historicoSection.innerHTML = `
                <div class="section-header">
                    <h2>Histórico e Lucros</h2>
                </div>
                <div class="card">
                    <div class="filter-row">
                        <div style="flex-grow: 1;">
                            <label for="filtro-historico-mes">Filtrar por Mês/Ano</label>
                            <input type="month" id="filtro-historico-mes" onchange="renderizarHistorico()">
                        </div>
                        <div style="flex-grow: 2;">
                            <label for="filtro-historico-cliente">Filtrar por Cliente (Digite ou Selecione)</label>
                            <input type="text" id="filtro-historico-cliente" list="clientes-datalist" placeholder="Digite o nome do cliente..." onkeyup="filtrarHistoricoTabela()">
                        </div>
                        <button class="btn-secondary" onclick="resetFiltroHistorico()"><span class="material-icons">refresh</span> Resetar Filtro</button>
                    </div>
                    
                    <h3 style="margin-top: 30px;">Resumo Mensal de Lucros</h3>
                    <div class="flex-container" style="gap: 20px;">
                        <div class="card" style="flex: 1; padding: 15px; text-align: center; border-left: 5px solid var(--success-color);">
                            <p style="margin: 0; font-size: 0.9rem;">Lucro Total (Serviços e Pacotes)</p>
                            <h4 id="resumo-lucro-total" style="margin: 5px 0 0 0; color: var(--success-color);">R$ 0,00</h4>
                        </div>
                        <div class="card" style="flex: 1; padding: 15px; text-align: center; border-left: 5px solid var(--primary-color);">
                            <p style="margin: 0; font-size: 0.9rem;">Serviços Individuais</p>
                            <h4 id="resumo-servicos-individuais" style="margin: 5px 0 0 0; color: var(--primary-color);">R$ 0,00</h4>
                        </div>
                        <div class="card" style="flex: 1; padding: 15px; text-align: center; border-left: 5px solid var(--secondary-color);">
                            <p style="margin: 0; font-size: 0.9rem;">Pacotes Vendidos</p>
                            <h4 id="resumo-pacotes-vendidos" style="margin: 5px 0 0 0; color: var(--secondary-color);">R$ 0,00</h4>
                        </div>
                    </div>

                    <h3 style="margin-top: 30px;">Detalhe das Movimentações</h3>
                    <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th style="width: 15%;">Data</th>
                                    <th style="width: 20%;">Cliente</th>
                                    <th style="width: 30%;">Serviço/Pacote</th>
                                    <th style="width: 15%;">Tipo</th>
                                    <th style="width: 10%;">Valor</th>
                                    <th style="width: 10%;">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="lista-historico">
                                <tr><td colspan="6" style="text-align: center;">Carregando histórico...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            onValue(historicoRef, (snapshot) => {
                let historico = [];
                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        const item = childSnapshot.val();
                        item.id = childSnapshot.key;
                        historico.push(item);
                    });
                }
                
                // Salva no cache do histórico para filtragem/reversão
                historico.sort((a, b) => {
                    if (a.data < b.data) return 1; // Mais recente primeiro
                    if (a.data > b.data) return -1;
                    if (a.hora < b.hora) return 1;
                    if (a.hora > b.hora) return -1;
                    return 0;
                });

                // Armazenar o histórico no cache ou variável global se necessário para reversão
                window.cacheHistorico = historico; 
                renderizarHistorico(); 

            }, {
                onlyOnce: false
            });
        }
        
        // 8.2. RENDERIZAR HISTÓRICO (COM FILTROS)
        window.renderizarHistorico = function() {
            const historico = window.cacheHistorico || [];
            const listaHistorico = document.getElementById('lista-historico');
            const filtroMesInput = document.getElementById('filtro-historico-mes').value;
            
            let totalServicos = 0;
            let totalPacotes = 0;
            
            // 1. Filtrar por mês
            const historicoFiltrado = historico.filter(item => {
                if (!filtroMesInput) return true; // Se não há filtro de mês, mostra tudo
                
                // Formato filtro: YYYY-MM
                // Formato data: YYYY-MM-DD
                return item.data.startsWith(filtroMesInput);
            });
            
            listaHistorico.innerHTML = '';
            
            if (historicoFiltrado.length === 0) {
                listaHistorico.innerHTML = '<tr><td colspan="6" style="text-align: center;">Nenhuma movimentação encontrada para o período.</td></tr>';
                document.getElementById('resumo-lucro-total').textContent = 'R$ 0,00';
                document.getElementById('resumo-servicos-individuais').textContent = 'R$ 0,00';
                document.getElementById('resumo-pacotes-vendidos').textContent = 'R$ 0,00';
                return;
            }

            // 2. Renderizar e Calcular totais
            historicoFiltrado.forEach(item => {
                const row = document.createElement('tr');
                const dataFormatada = new Date(item.data).toLocaleDateString('pt-BR');
                const valorFormatado = `R$ ${parseFloat(item.valor).toFixed(2).replace('.', ',')}`;
                
                let tipoTexto = '';
                let valorParaTotal = 0;

                if (item.tipo === 'servico') {
                    tipoTexto = 'Serviço Individual';
                    valorParaTotal = parseFloat(item.valor);
                    totalServicos += valorParaTotal;
                } else if (item.tipo === 'pacote_venda') {
                    tipoTexto = 'Venda de Pacote';
                    valorParaTotal = parseFloat(item.valor);
                    totalPacotes += valorParaTotal;
                } else if (item.tipo === 'pacote') {
                    tipoTexto = 'Uso de Pacote';
                    valorParaTotal = 0; // Uso de pacote não soma lucro
                }

                // Rótulos de Mobile
                row.dataset.clienteNome = item.clienteNome.toLowerCase(); // Para filtro de cliente
                row.style.display = 'table-row'; // Reseta o estilo em mobile

                row.innerHTML = `
                    <td data-label="Data">${dataFormatada} ${item.hora}</td>
                    <td data-label="Cliente">${item.clienteNome}</td>
                    <td data-label="Serviço/Pacote">${item.servico}</td>
                    <td data-label="Tipo">${tipoTexto}</td>
                    <td data-label="Valor">${valorFormatado}</td>
                    <td class="action-buttons" data-label="Ações">
                        <button class="btn btn-secondary" onclick="reverterMovimentacao('${item.id}', '${item.clienteNome}', '${item.tipo}')"><span class="material-icons">undo</span> Reverter</button>
                    </td>
                `;
                listaHistorico.appendChild(row);
            });

            // 3. Exibir Resumo
            const lucroTotal = totalServicos + totalPacotes;
            document.getElementById('resumo-lucro-total').textContent = `R$ ${lucroTotal.toFixed(2).replace('.', ',')}`;
            document.getElementById('resumo-servicos-individuais').textContent = `R$ ${totalServicos.toFixed(2).replace('.', ',')}`;
            document.getElementById('resumo-pacotes-vendidos').textContent = `R$ ${totalPacotes.toFixed(2).replace('.', ',')}`;
            
            // Re-aplica filtro de cliente após a renderização
            filtrarHistoricoTabela();
        }

        // 8.3. REVERTER MOVIMENTAÇÃO (REMOVE DO HISTÓRICO)
        window.reverterMovimentacao = function(id, clienteNome, tipo) {
            if (confirm(`Atenção: Reverter esta movimentação para ${clienteNome}? Isso irá removê-la do Histórico e do cálculo de Lucros.`)) {
                
                // Adicionalmente, se for um "Uso de Pacote", deveria ser revertido no `pacotes_ativos`
                const item = window.cacheHistorico.find(i => i.id === id);

                if (tipo === 'pacote' && item.pacoteId) {
                    const pacote = cachePacotes[item.pacoteId];
                    if (pacote) {
                        const novaQtdUsada = Math.max(0, pacote.quantidadeUsada - 1);
                        let novoStatus = pacote.quantidadeUsada > pacote.quantidadeTotal ? 'finalizado' : 'ativo';

                         update(ref(db, `pacotes_ativos/${item.pacoteId}`), { 
                             quantidadeUsada: novaQtdUsada, 
                             status: novoStatus // Volta para ativo se não estiver mais cheio
                         })
                         .then(() => {
                            showNotification(`Uso do pacote para ${clienteNome} revertido.`, 'info');
                            // Prosegue para remover do histórico
                            remove(ref(db, `historico/${id}`))
                                .then(() => showNotification(`Movimentação de ${clienteNome} revertida e removida do Histórico.`, 'success'))
                                .catch(error => showNotification('Erro ao remover do histórico: ' + error.message, 'error'));
                            carregarPacotesAtivos(); // Recarrega pacotes
                         })
                         .catch(error => {
                            showNotification('Erro ao reverter uso de pacote: ' + error.message, 'error');
                         });
                    } else {
                        // Se não encontrou o pacote, remove só do histórico
                       remove(ref(db, `historico/${id}`))
                        .then(() => showNotification(`Movimentação de ${clienteNome} revertida (pacote original não encontrado).`, 'success'))
                        .catch(error => showNotification('Erro ao remover do histórico: ' + error.message, 'error'));
                    }

                } else {
                    // Para Serviço Individual ou Venda de Pacote
                    remove(ref(db, `historico/${id}`))
                       .then(() => showNotification(`Movimentação de ${clienteNome} revertida e removida do Histórico.`, 'success'))
                       .catch(error => showNotification('Erro ao remover do histórico: ' + error.message, 'error'));
                }
            }
        }
        
        // 8.4. FILTRAR HISTÓRICO NA TABELA
        window.filtrarHistoricoTabela = function() {
             const filtro = document.getElementById('filtro-historico-cliente').value.toLowerCase();
             const listaHistorico = document.getElementById('lista-historico');
             const linhas = listaHistorico.getElementsByTagName('tr');

             for (let i = 0; i < linhas.length; i++) {
                 const row = linhas[i];
                 if (!row.dataset.clienteNome) continue; 

                 const clienteNome = row.dataset.clienteNome;
                
                 if (clienteNome.includes(filtro)) {
                    // Em desktop é 'table-row', em mobile é 'block'
                     row.style.display = window.innerWidth > 768 ? "table-row" : "block"; 
                 } else {
                     row.style.display = "none";
                 }
             }
        }
        
        // 8.5. RESETAR FILTRO DO HISTÓRICO
        window.resetFiltroHistorico = function() {
            document.getElementById('filtro-historico-mes').value = ''; 
            document.getElementById('filtro-historico-cliente').value = '';
            renderizarHistorico();
        }
        
        // Inicializa a exibição
        document.addEventListener('DOMContentLoaded', () => {
             // Mostra a tela de login ao carregar a página
            showLogin();
        });
    </script>
</body>
</html>
