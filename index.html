<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tati Manicure - Gerenciamento de Agendamentos</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #ff6b8b; /* Rosa mais feminino */
            --secondary-color: #ba68c8; /* Roxo suave */
            --background-color: #fce4ec; /* Rosa claro de fundo */
            --sidebar-bg: #ffffff;
            --sidebar-hover-bg: #f8bbd9; /* Rosa mais claro para hover */
            --text-color: #4a148c; /* Roxo escuro para texto */
            --success-color: #66bb6a; /* Verde suave */
            --info-color: #4fc3f7; /* Azul claro */
            --danger-color: #ef5350; /* Vermelho suave */
            --warning-color: #ffb74d; /* Laranja suave */
            --border-color: #f48fb1; /* Rosa para bordas */
            --shadow-color: rgba(255, 107, 139, 0.1); /* Sombra rosa */
        }

        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #fce4ec 0%, #f8bbd9 100%); /* Gradiente feminino */
            color: var(--text-color);
            display: flex;
            min-height: 100vh;
        }

        /* Estrutura do App */
        #login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            background: linear-gradient(135deg, #ff6b8b 0%, #ba68c8 100%); /* Gradiente rosa-roxo */
            min-height: 100vh;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><path fill="%23ffffff" opacity="0.1" d="M30,30 Q50,10 70,30 T90,50 Q70,90 50,70 T10,50 Q30,10 50,30 Z M40,40 Q50,35 60,40 T70,50 Q60,65 50,60 T30,50 Q40,35 50,40 Z"/></svg>');
            background-size: 150px;
        }

        .login-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(255, 107, 139, 0.3);
            text-align: center;
            width: 100%;
            max-width: 400px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .login-card h1 {
            color: var(--primary-color);
            margin-bottom: 30px;
            font-size: 1.8rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .login-icon {
            font-size: 80px;
            color: var(--primary-color);
            margin-bottom: 20px;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        #app-container {
            display: none;
            width: 100%;
            flex-direction: row;
        }

        /* Barra Lateral (Sidebar) */
        .sidebar {
            width: 250px;
            background: linear-gradient(180deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            box-shadow: 4px 0 15px var(--shadow-color);
            display: flex;
            flex-direction: column;
            padding: 20px 0;
            flex-shrink: 0;
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
            color: white;
            font-size: 1.6rem;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
            padding: 0 20px;
        }

        .sidebar ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar ul li a {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            text-decoration: none;
            color: white;
            transition: all 0.3s ease;
            font-weight: 500;
            border-left: 4px solid transparent;
        }

        .sidebar ul li a:hover,
        .sidebar ul li a.active {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border-left-color: white;
            transform: translateX(5px);
        }

        .sidebar ul li a .material-icons {
            margin-right: 10px;
            font-size: 20px;
        }

        .user-info {
            margin-top: auto;
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.3);
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .user-info p {
            margin: 0 0 10px 0;
            font-weight: bold;
            color: white;
        }

        /* Conteúdo Principal */
        .main-content {
            flex-grow: 1;
            padding: 30px;
            overflow-y: auto;
            background: var(--background-color);
        }

        .content-section {
            display: none;
            padding: 20px;
        }

        .content-section.active {
            display: block;
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }

        .section-header h2 {
            margin: 0;
            color: var(--text-color);
            font-size: 1.5rem;
        }
        
        /* Novas cores para Status de Pacote e Histórico */
        .status-package-paid {
             color: var(--success-color);
             font-weight: bold;
        }
        .status-package-pending {
            color: var(--warning-color);
            font-weight: bold;
        }
        .status-package-active {
            color: var(--primary-color);
            font-weight: bold;
        }
        .status-package-finalized {
            color: var(--danger-color);
            font-weight: bold;
        }

        /* Cartão (Card) */
        .card {
            background: rgba(255, 255, 255, 0.9);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px var(--shadow-color);
            margin-bottom: 20px;
            border: 1px solid rgba(255, 107, 139, 0.1);
            backdrop-filter: blur(10px);
        }
        
        /* NOVO V6: Abas dentro de uma seção */
        .tab-menu {
             display: flex;
             border-bottom: 3px solid var(--border-color);
             margin-bottom: 20px;
             border-radius: 10px 10px 0 0;
             overflow: hidden;
        }
        .tab-menu button {
             padding: 12px 20px;
             border: none;
             background: rgba(255, 255, 255, 0.7);
             cursor: pointer;
             font-size: 1rem;
             color: var(--secondary-color);
             border-bottom: 3px solid transparent;
             transition: all 0.3s ease;
             font-weight: bold;
             flex: 1;
        }
        .tab-menu button.active {
             color: var(--primary-color);
             border-bottom: 3px solid var(--primary-color);
             background: white;
        }
        .tab-menu button:hover {
             background: rgba(255, 255, 255, 0.9);
             color: var(--primary-color);
        }
        .tab-content {
             padding-top: 10px;
        }
        .tab-pane {
             display: none;
        }
        .tab-pane.active {
             display: block;
             animation: fadeIn 0.5s ease-in;
        }

        /* Formulários */
        .form-group {
            margin-bottom: 15px;
        }

        .form-row {
            display: flex;
            gap: 20px;
        }

        .form-row > div {
            flex: 1;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--text-color);
        }

        input[type="text"],
        input[type="number"],
        input[type="email"],
        input[type="tel"],
        input[type="date"],
        input[type="time"],
        textarea,
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.8);
        }

        /* Datalist input */
        input[list] {
            background-image: none;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="email"]:focus,
        input[type="tel"]:focus,
        input[type="date"]:focus,
        input[type="time"]:focus,
        textarea:focus,
        select:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(255, 107, 139, 0.2);
            background: white;
        }

        textarea {
            resize: vertical;
        }

        /* Botões */
        button, .btn {
            padding: 12px 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(255, 107, 139, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color) 0%, #4caf50 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(102, 187, 106, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary-color) 0%, #7b1fa2 100%);
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(186, 104, 200, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color) 0%, #d32f2f 100%);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(239, 83, 80, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color) 0%, #f57c00 100%);
            color: white;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(255, 183, 77, 0.4);
        }

        .btn-info {
            background: linear-gradient(135deg, var(--info-color) 0%, #0288d1 100%);
            color: white;
        }

        .btn-info:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(79, 195, 247, 0.4);
        }

        /* Tabelas */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 3px 10px var(--shadow-color);
        }

        .data-table thead tr {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            text-align: left;
        }

        .data-table th, .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table tbody tr:hover {
            background: rgba(255, 107, 139, 0.05);
            transform: scale(1.01);
            transition: all 0.2s ease;
        }

        .data-table td.action-buttons button {
            margin-right: 5px;
            padding: 6px 8px;
        }

        .data-table td.action-buttons {
            white-space: nowrap;
        }

        /* Notificação */
        #notification-bar {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            transform: translateY(-20px);
            z-index: 1000;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            font-weight: bold;
            backdrop-filter: blur(10px);
        }

        #notification-bar.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        #notification-bar.success { 
            background: linear-gradient(135deg, var(--success-color) 0%, #4caf50 100%); 
        }
        #notification-bar.error { 
            background: linear-gradient(135deg, var(--danger-color) 0%, #d32f2f 100%); 
        }
        #notification-bar.info { 
            background: linear-gradient(135deg, var(--info-color) 0%, #0288d1 100%); 
        }

        /* Utilitários */
        .flex-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .input-group {
            display: flex;
            gap: 10px;
        }
        
        .input-group input, .input-group select {
            flex-grow: 1;
        }

        .filter-row {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            margin-bottom: 20px;
        }
        .filter-row > div {
            flex: 1;
        }
        .filter-row button {
            flex-grow: 0;
            flex-shrink: 0;
            padding: 11px 15px;
        }
        
        /* NOVO V6: Estilos para a Tabela de Visão Diária */
        #tabela-visao-diaria {
             border: 2px solid var(--border-color);
             margin-top: 0;
             border-radius: 10px;
        }
        #tabela-visao-diaria thead tr {
             background: linear-gradient(135deg, var(--secondary-color) 0%, #7b1fa2 100%);
        }
        #tabela-visao-diaria td {
             height: 40px;
             font-size: 0.9rem;
             vertical-align: top;
        }
        .horario-celula {
             width: 80px;
             font-weight: bold;
             background: rgba(255, 107, 139, 0.1);
             color: var(--text-color);
             text-align: center;
             vertical-align: middle !important;
             border-right: 2px solid var(--border-color);
        }
        .agendamento-vago {
             background: rgba(102, 187, 106, 0.1);
             color: var(--success-color);
             font-weight: bold;
             font-style: italic;
             text-align: center;
             line-height: 40px;
        }
        .agendamento-vencido {
             background: rgba(239, 83, 80, 0.1);
             color: var(--danger-color);
             font-weight: bold;
             font-style: italic;
             text-align: center;
             line-height: 40px;
        }
        .agendamento-ocupado {
             background: rgba(255, 107, 139, 0.05);
             color: var(--text-color);
             font-weight: 500;
             padding: 5px 10px !important;
             vertical-align: middle !important;
             line-height: 1.2;
             border-left: 5px solid var(--primary-color);
             cursor: pointer;
        }
        .agendamento-ocupado strong {
             color: var(--primary-color);
             font-weight: bold;
        }
        
        /* Modal para usar pacote */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 2px solid var(--border-color);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }
        
        .modal-header h3 {
            margin: 0;
            color: var(--primary-color);
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--secondary-color);
            transition: all 0.3s ease;
        }
        
        .close-modal:hover {
            color: var(--primary-color);
            transform: scale(1.1);
        }
        
        /* --------------------------------------------------- */
        /* RESPONSIVIDADE MOBILE - MELHORIAS PARA VISÃO DIÁRIA */
        /* --------------------------------------------------- */
        @media (max-width: 768px) {
            
            /* Estrutura Principal */
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
                box-shadow: 0 0 10px var(--shadow-color);
            }

            .main-content {
                padding: 15px;
            }

            #app-container {
                flex-direction: column;
            }

            /* Navegação Horizontal */
            .sidebar ul {
                display: flex;
                flex-wrap: nowrap;
                overflow-x: auto;
                justify-content: flex-start;
                border-bottom: 2px solid rgba(255, 255, 255, 0.3);
            }

            .sidebar ul li {
                flex-shrink: 0;
                text-align: center;
            }

            .sidebar ul li a {
                justify-content: center;
                padding: 10px;
                flex-direction: column;
                font-size: 0.75rem;
                white-space: nowrap;
                border-left: none;
                border-bottom: 3px solid transparent;
            }

            .sidebar ul li a:hover,
            .sidebar ul li a.active {
                border-left: none;
                border-bottom: 3px solid white;
                transform: translateY(-2px);
            }

            .sidebar ul li a .material-icons {
                margin-right: 0;
                margin-bottom: 5px;
                font-size: 20px;
            }

            /* FIX: Botão Sair visível no celular */
            .user-info {
                display: block;
                padding: 10px 15px;
                border-top: none; 
                text-align: center; 
            }

            .user-info p {
                display: none;
            }

            .user-info button {
                width: 100%;
                margin-top: 10px; 
                font-size: 0.9rem;
            }
            
            /* 1. Correção de Formulários e Filtros (Empilhamento) */
            .form-row, .filter-row {
                flex-direction: column;
                gap: 0;
            }

            .form-row > div, 
            .filter-row > div {
                flex: 0 0 100% !important;
                width: 100%;
            }
            
            /* Ajusta margem para inputs empilhados */
            .form-group, .filter-row > div {
                margin-bottom: 10px;
            }
            
            .filter-row button {
                width: 100%;
                margin-top: 5px; 
                padding: 12px 15px !important;
            }
            
            /* MELHORIA: Visão Diária em Mobile */
            .table-responsive {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            #tabela-visao-diaria {
                width: 100%;
                min-width: 350px;
                font-size: 0.85rem;
            }
            
            #tabela-visao-diaria td {
                padding: 8px 5px !important;
                height: 35px;
                word-wrap: break-word;
                overflow: hidden;
            }
            
            .horario-celula {
                width: 60px;
                font-size: 0.8rem;
                padding: 5px !important;
            }
            
            .agendamento-ocupado {
                font-size: 0.8rem;
                line-height: 1.1;
                padding: 3px 5px !important;
                border-left: 3px solid var(--primary-color);
            }
            
            .agendamento-ocupado strong {
                font-size: 0.85rem;
            }
            
            .agendamento-vago,
            .agendamento-vencido {
                font-size: 0.8rem;
                line-height: 35px;
                padding: 0 5px;
            }
            
            /* Garantir que o conteúdo não ultrapasse os limites */
            #tabela-visao-diaria td:not(.horario-celula) {
                max-width: 200px;
                white-space: normal;
            }

            /* 2. Correção de Tabelas (Cartão-like View) */
            .data-table, .data-table tbody, .data-table td, .data-table tr {
                display: block;
            }

            .data-table thead {
                display: none;
            }

            .data-table tr {
                border: 2px solid var(--border-color);
                margin-bottom: 15px;
                border-radius: 10px;
                box-shadow: 0 2px 8px var(--shadow-color);
                padding: 10px;
            }

            .data-table td {
                border: none;
                position: relative;
                padding-left: 50% !important;
                text-align: right;
                white-space: normal;
                min-height: 40px;
            }

            /* Rótulo customizado (que usa o data-label do JS) */
            .data-table td::before {
                content: attr(data-label);
                position: absolute;
                left: 10px;
                width: 45%; 
                padding-right: 10px;
                white-space: nowrap;
                text-align: left;
                font-weight: bold;
                color: var(--primary-color);
            }
            
            /* FIX V6: Organização dos botões de ação em mobile */
            .data-table td.action-buttons {
                text-align: left;
                padding-left: 10px !important;
                display: flex; 
                flex-direction: column;
                gap: 5px;
            }
            
            /* MELHORIA 1: Remover label "Ações" em mobile */
            .data-table td.action-buttons::before {
                content: "" !important;
                display: none !important;
            }
            
            .data-table td.action-buttons button {
                margin: 0;
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
                font-size: 0.9rem; 
                padding: 8px 5px;
            }
            
            /* Modal em mobile */
            .modal-content {
                width: 95%;
                padding: 15px;
            }
        }
    
/* ===== AJUSTES MÍNIMOS APLICADOS: manter todas as lógicas originais ===== */
/* 1) Forçar empilhamento dos botões da aba Agenda em mobile (retrato) */
@media (max-width: 768px) {
  .tab-menu {
    flex-direction: column !important;
    align-items: stretch !important;
    gap: 8px !important;
  }
  .tab-menu button, .tab-menu .tab-button {
    display: block !important;
    width: 100% !important;
    margin: 6px 0 !important;
    box-sizing: border-box !important;
  }
  /* remover transformações que podem esconder botões em mobile */
  .tab-menu button.active { transform: none !important; }
}

/* 2) Garantir que os botões de Ações não se sobreponham (desktop e mobile) */
.data-table td.action-buttons {
  display: flex !important;
  gap: 8px !important;
  align-items: center !important;
  justify-content: flex-end !important;
  flex-wrap: wrap !important;
  position: relative !important;
  z-index: 2 !important;
}
@media (max-width: 768px) {
  .data-table td.action-buttons {
    flex-direction: column !important;
    align-items: stretch !important;
    justify-content: flex-start !important;
  }
  .data-table td.action-buttons button {
    width: 100% !important;
    box-sizing: border-box !important;
  }
}

/* MELHORIA 2: Estilo para valor de lucro */
.lucro-valor {
    font-size: 1.2rem;
    font-weight: bold;
    text-align: center;
    color: var(--success-color);
    padding: 10px;
    background: rgba(102, 187, 106, 0.1);
    border-radius: 8px;
    margin: 5px 0;
}
/* ===== FIM AJUSTES ===== */
</style>
</head>
<body>

    <div id="notification-bar"></div>

    <!-- Modal para usar pacote -->
    <div id="modal-usar-pacote" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Agendar Uso de Pacote</h3>
                <button class="close-modal">&times;</button>
            </div>
            <form id="form-usar-pacote">
                <input type="hidden" id="modal-pacote-id">
                <input type="hidden" id="modal-pacote-servico-id">
                <input type="hidden" id="modal-pacote-cliente-id">
                
                <div class="form-group">
                    <label for="modal-pacote-data">Data</label>
                    <input type="date" id="modal-pacote-data" required>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="modal-pacote-hora">Hora Início</label>
                        <input type="time" id="modal-pacote-hora" required>
                    </div>
                    <div class="form-group">
                        <label for="modal-pacote-hora-fim">Hora Fim</label>
                        <input type="time" id="modal-pacote-hora-fim" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="modal-pacote-procedimento">Procedimento Realizado</label>
                    <select id="modal-pacote-procedimento" required>
                        <option value="">Selecione o procedimento</option>
                        <option value="Pés" data-quantidade="1">Pés (1 procedimento)</option>
                        <option value="Mãos" data-quantidade="1">Mãos (1 procedimento)</option>
                        <option value="Pés e Mãos" data-quantidade="2">Pés e Mãos (2 procedimentos)</option>
                        <option value="Outro" data-quantidade="1">Outro (1 procedimento)</option>
                    </select>
                </div>
                
                <div class="form-group" id="group-outro-procedimento" style="display: none;">
                    <label for="modal-pacote-outro">Descreva o procedimento</label>
                    <input type="text" id="modal-pacote-outro" placeholder="Digite o procedimento realizado">
                </div>
                
                <div class="form-group">
                    <label for="modal-pacote-observacoes">Observações Adicionais</label>
                    <textarea id="modal-pacote-observacoes" rows="2" placeholder="Observações sobre o serviço..."></textarea>
                </div>
                
                <div class="flex-container">
                    <button type="submit" class="btn-success">
                        <span class="material-icons">check_circle</span> Confirmar Uso
                    </button>
                    <button type="button" class="btn-secondary" id="cancelar-usar-pacote">
                        <span class="material-icons">cancel</span> Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- NOVO: Modal para limpeza de dados -->
    <div id="modal-limpeza-dados" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Limpeza de Dados</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="form-group">
                <p><strong>Atenção:</strong> Esta ação não pode ser desfeita!</p>
                <label>
                    <input type="checkbox" id="confirmar-limpeza"> Confirmo que desejo prosseguir com a limpeza
                </label>
            </div>
            <div class="flex-container">
                <button type="button" class="btn-danger" id="btn-limpar-historico" disabled>
                    <span class="material-icons">delete_forever</span> Limpar Apenas Histórico
                </button>
                <button type="button" class="btn-danger" id="btn-limpar-tudo" disabled>
                    <span class="material-icons">delete_sweep</span> Limpar Tudo (exceto Clientes/Serviços)
                </button>
                <button type="button" class="btn-secondary" id="cancelar-limpeza">
                    <span class="material-icons">cancel</span> Cancelar
                </button>
            </div>
        </div>
    </div>

    <div id="login-container">
        <div class="login-card">
            <!-- MELHORIA 3: Ícone mais temático para manicure -->
            <div class="login-icon">
                <span class="material-icons">spa</span>
            </div>
            <h1>Tati Manicure - Acesso</h1>
            <form id="login-form">
                <div class="form-group">
                    <label for="loginSenha">Senha de Acesso</label>
                    <input type="password" id="loginSenha" required>
                </div>
                <button type="submit" class="btn-primary" style="width: 100%; margin-top: 10px;">
                    <span class="material-icons">login</span> Entrar
                </button>
            </form>
        </div>
    </div>

    <datalist id="clientes-datalist"></datalist>

    <div id="app-container">
        
        <aside class="sidebar">
            <div class="logo">TATI MANICURE APP</div>
            
            <ul>
                <li><a href="#" data-section="agenda" class="active"><span class="material-icons">calendar_today</span> Agenda</a></li>
                <li><a href="#" data-section="clientes"><span class="material-icons">people</span> Clientes</a></li>
                <li><a href="#" data-section="servicos"><span class="material-icons">local_offer</span> Serviços</a></li>
                <li><a href="#" data-section="historico"><span class="material-icons">history</span> Histórico/Lucros</a></li>
            </ul>

            <div class="user-info">
                <p id="userInfo">Olá, Tati!</p>
                <button id="logout-button" class="btn-danger" style="width: 100%;">
                    <span class="material-icons">logout</span> Sair
                </button>
            </div>
        </aside>

        <main class="main-content">

            <div id="agenda-section" class="content-section active">
                
                <div class="tab-menu">
                     <button class="tab-button active" onclick="showAgendaTab('pacotes-ativos', event)">Pacotes Ativos</button>
                     <button class="tab-button" onclick="showAgendaTab('novo-agendamento', event)">Novo Agendamento</button>
                     <button class="tab-button" onclick="showAgendaTab('lista-agendamentos', event)">Lista Agendamentos</button>
                     <button class="tab-button" onclick="showAgendaTab('visao-diaria', event)">Visão Diária</button>
                </div>
                
                <div class="tab-content">
                    
                    <div id="pacotes-ativos-pane" class="tab-pane active">
                         <div class="section-header"><h2>Gerenciamento de Pacotes Ativos</h2></div>
                         <div class="card">
                            <form id="pacote-inicio-form">
                                <h3>Iniciar Novo Pacote de Serviços</h3>
                                <div class="form-row">
                                    <div class="form-group" style="flex: 2;">
                                        <label for="pacote-cliente-id">Cliente</label>
                                        <select id="pacote-cliente-id" required></select>
                                    </div>
                                    <div class="form-group" style="flex: 2;">
                                        <label for="pacote-servico-id">Serviço</label>
                                        <select id="pacote-servico-id" required></select>
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label for="pacote-quantidade">Quantidade</label>
                                        <input type="number" id="pacote-quantidade" min="1" value="1" required>
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label for="pacote-valor">Valor Total</label>
                                        <input type="number" id="pacote-valor" step="0.01" min="0" required>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="pacote-observacoes">Observações</label>
                                    <textarea id="pacote-observacoes" rows="2" placeholder="Observações sobre o pacote..."></textarea>
                                </div>
                                <button type="submit" class="btn-success">
                                    <span class="material-icons">playlist_add_check</span> Iniciar Pacote
                                </button>
                            </form>
                         </div>
                         
                         <div class="card">
                            <h3>Pacotes Ativos</h3>
                            <div class="table-responsive">
                                <table class="data-table" id="tabela-pacotes-ativos">
                                    <thead>
                                        <tr>
                                            <th>Cliente</th>
                                            <th>Serviço</th>
                                            <th>Procedimentos Restantes</th>
                                            <th>Valor</th>
                                            <th>Status</th>
                                            <th>Data Início</th>
                                            <th>Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="lista-pacotes-ativos">
                                        <!-- Os pacotes ativos serão inseridos aqui pelo JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                         </div>
                    </div>
                    
                    <div id="novo-agendamento-pane" class="tab-pane">
                         <div class="section-header"><h2>Novo Agendamento</h2></div>
                         <div class="card">
                            <form id="agendamento-form">
                                <div class="form-row">
                                    <div class="form-group" style="flex: 2;">
                                        <label for="agendamento-cliente">Cliente</label>
                                        <input type="text" id="agendamento-cliente" list="clientes-datalist" required>
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label for="agendamento-telefone">Telefone</label>
                                        <input type="tel" id="agendamento-telefone" placeholder="(00) 00000-0000">
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group" style="flex: 1;">
                                        <label for="agendamento-data">Data</label>
                                        <input type="date" id="agendamento-data" required>
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label for="agendamento-hora">Hora Início</label>
                                        <input type="time" id="agendamento-hora" required>
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label for="agendamento-hora-fim">Hora Fim</label>
                                        <input type="time" id="agendamento-hora-fim" required>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group" style="flex: 2;">
                                        <label for="agendamento-servico">Serviço</label>
                                        <select id="agendamento-servico" required>
                                            <option value="">Selecione um serviço</option>
                                        </select>
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label for="agendamento-valor">Valor</label>
                                        <input type="number" id="agendamento-valor" step="0.01" min="0" required>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="agendamento-observacoes">Observações</label>
                                    <textarea id="agendamento-observacoes" rows="3" placeholder="Detalhes do serviço, observações, etc..."></textarea>
                                </div>
                                
                                <div class="form-group">
                                    <label>
                                        <input type="checkbox" id="agendamento-pacote"> Usar pacote ativo (se disponível)
                                    </label>
                                </div>
                                
                                <div class="form-group" id="pacote-selecao-container" style="display: none;">
                                    <label for="agendamento-pacote-id">Selecionar Pacote</label>
                                    <select id="agendamento-pacote-id">
                                        <option value="">Selecione um pacote</option>
                                    </select>
                                </div>
                                
                                <button type="submit" class="btn-success">
                                    <span class="material-icons">event_available</span> Agendar
                                </button>
                            </form>
                         </div>
                    </div>
                    
                    <div id="lista-agendamentos-pane" class="tab-pane">
                         <div class="section-header"><h2>Agendamentos Futuros</h2></div>
                         <div class="card">
                            <div class="filter-row">
                                <div class="form-group">
                                    <label for="filtro-data">Filtrar por Data</label>
                                    <input type="date" id="filtro-data">
                                </div>
                                <div class="form-group">
                                    <label for="filtro-cliente">Filtrar por Cliente</label>
                                    <input type="text" id="filtro-cliente" list="clientes-datalist">
                                </div>
                                <div class="form-group">
                                    <button type="button" class="btn-info" id="btn-limpar-filtros">
                                        <span class="material-icons">clear_all</span> Limpar Filtros
                                    </button>
                                </div>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="data-table" id="tabela-agendamentos">
                                    <thead>
                                        <tr>
                                            <th>Data</th>
                                            <th>Hora</th>
                                            <th>Cliente</th>
                                            <th>Serviço</th>
                                            <th>Valor</th>
                                            <th>Observações</th>
                                            <th>Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="lista-agendamentos">
                                        <!-- Os agendamentos serão inseridos aqui pelo JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                         </div>
                    </div>
                    
                    <div id="visao-diaria-pane" class="tab-pane">
                         <div class="section-header"><h2>Visão Diária da Agenda</h2></div>
                         <div class="card">
                            <div class="filter-row">
                                <div class="form-group">
                                    <label for="visao-data">Selecione a Data</label>
                                    <input type="date" id="visao-data" required>
                                </div>
                                <div class="form-group">
                                    <button type="button" class="btn-info" id="btn-hoje">
                                        <span class="material-icons">today</span> Hoje
                                    </button>
                                </div>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="data-table" id="tabela-visao-diaria">
                                    <thead>
                                        <tr>
                                            <th>Horário</th>
                                            <th>08:00</th>
                                            <th>09:00</th>
                                            <th>10:00</th>
                                            <th>11:00</th>
                                            <th>12:00</th>
                                            <th>13:00</th>
                                            <th>14:00</th>
                                            <th>15:00</th>
                                            <th>16:00</th>
                                            <th>17:00</th>
                                            <th>18:00</th>
                                        </tr>
                                    </thead>
                                    <tbody id="corpo-visao-diaria">
                                        <!-- A visão diária será inserida aqui pelo JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                         </div>
                    </div>
                    
                </div>
            </div>

            <div id="clientes-section" class="content-section">
                <div class="section-header">
                    <h2>Gerenciamento de Clientes</h2>
                    <button class="btn-primary" id="btn-novo-cliente">
                        <span class="material-icons">person_add</span> Novo Cliente
                    </button>
                </div>
                
                <div class="card" id="form-cliente-card" style="display: none;">
                    <h3 id="form-cliente-titulo">Novo Cliente</h3>
                    <form id="cliente-form">
                        <input type="hidden" id="cliente-id">
                        <div class="form-row">
                            <div class="form-group" style="flex: 2;">
                                <label for="cliente-nome">Nome Completo</label>
                                <input type="text" id="cliente-nome" required>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label for="cliente-telefone">Telefone</label>
                                <input type="tel" id="cliente-telefone" placeholder="(00) 00000-0000" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group" style="flex: 2;">
                                <label for="cliente-email">E-mail</label>
                                <input type="email" id="cliente-email">
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label for="cliente-aniversario">Data de Nascimento</label>
                                <input type="date" id="cliente-aniversario">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="cliente-observacoes">Observações</label>
                            <textarea id="cliente-observacoes" rows="3" placeholder="Observações sobre o cliente..."></textarea>
                        </div>
                        <div class="flex-container">
                            <button type="submit" class="btn-success">
                                <span class="material-icons">save</span> Salvar Cliente
                            </button>
                            <button type="button" class="btn-secondary" id="btn-cancelar-cliente">
                                <span class="material-icons">cancel</span> Cancelar
                            </button>
                        </div>
                    </form>
                </div>
                
                <div class="card">
                    <div class="filter-row">
                        <div class="form-group">
                            <label for="filtro-cliente-nome">Buscar por Nome</label>
                            <input type="text" id="filtro-cliente-nome" placeholder="Digite o nome do cliente...">
                        </div>
                        <div class="form-group">
                            <button type="button" class="btn-info" id="btn-limpar-filtro-cliente">
                                <span class="material-icons">clear</span> Limpar
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="data-table" id="tabela-clientes">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Telefone</th>
                                    <th>E-mail</th>
                                    <th>Aniversário</th>
                                    <th>Observações</th>
                                    <!-- MELHORIA 1: Removido o cabeçalho "Ações" -->
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="lista-clientes">
                                <!-- Os clientes serão inseridos aqui pelo JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="servicos-section" class="content-section">
                <div class="section-header">
                    <h2>Gerenciamento de Serviços</h2>
                    <button class="btn-primary" id="btn-novo-servico">
                        <span class="material-icons">add_circle</span> Novo Serviço
                    </button>
                </div>
                
                <div class="card" id="form-servico-card" style="display: none;">
                    <h3 id="form-servico-titulo">Novo Serviço</h3>
                    <form id="servico-form">
                        <input type="hidden" id="servico-id">
                        <div class="form-row">
                            <div class="form-group" style="flex: 2;">
                                <label for="servico-nome">Nome do Serviço</label>
                                <input type="text" id="servico-nome" required>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label for="servico-duracao">Duração (minutos)</label>
                                <input type="number" id="servico-duracao" min="1" value="30" required>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label for="servico-valor">Valor (R$)</label>
                                <input type="number" id="servico-valor" step="0.01" min="0" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="servico-descricao">Descrição</label>
                            <textarea id="servico-descricao" rows="3" placeholder="Descrição detalhada do serviço..."></textarea>
                        </div>
                        <div class="flex-container">
                            <button type="submit" class="btn-success">
                                <span class="material-icons">save</span> Salvar Serviço
                            </button>
                            <button type="button" class="btn-secondary" id="btn-cancelar-servico">
                                <span class="material-icons">cancel</span> Cancelar
                            </button>
                        </div>
                    </form>
                </div>
                
                <div class="card">
                    <div class="table-responsive">
                        <table class="data-table" id="tabela-servicos">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Duração</th>
                                    <th>Valor</th>
                                    <th>Descrição</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="lista-servicos">
                                <!-- Os serviços serão inseridos aqui pelo JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="historico-section" class="content-section">
                <div class="section-header">
                    <h2>Histórico e Relatório de Lucros</h2>
                    <button class="btn-danger" id="btn-limpeza-dados">
                        <span class="material-icons">cleaning_services</span> Limpeza de Dados
                    </button>
                </div>
                
                <div class="card">
                    <h3>Filtros de Período</h3>
                    <div class="filter-row">
                        <div class="form-group">
                            <label for="filtro-mes">Mês</label>
                            <select id="filtro-mes">
                                <option value="1">Janeiro</option>
                                <option value="2">Fevereiro</option>
                                <option value="3">Março</option>
                                <option value="4">Abril</option>
                                <option value="5">Maio</option>
                                <option value="6">Junho</option>
                                <option value="7">Julho</option>
                                <option value="8">Agosto</option>
                                <option value="9">Setembro</option>
                                <option value="10">Outubro</option>
                                <option value="11">Novembro</option>
                                <option value="12">Dezembro</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="filtro-ano">Ano</label>
                            <select id="filtro-ano"></select>
                        </div>
                        <div class="form-group">
                            <button type="button" class="btn-primary" id="btn-filtrar-historico">
                                <span class="material-icons">filter_alt</span> Filtrar
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h3>Resumo Financeiro</h3>
                    <div class="form-row">
                        <div class="form-group" style="flex: 1;">
                            <label>Total de Serviços Realizados</label>
                            <div class="card" style="padding: 15px; text-align: center; background: rgba(79, 195, 247, 0.1);">
                                <h3 id="total-servicos">0</h3>
                                <p>Serviços</p>
                            </div>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label>Faturamento Bruto</label>
                            <div class="card" style="padding: 15px; text-align: center; background: rgba(102, 187, 106, 0.1);">
                                <h3 id="faturamento-bruto">R$ 0,00</h3>
                                <p>Receita Total</p>
                            </div>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label>Lucro Líquido</label>
                            <div class="card" style="padding: 15px; text-align: center; background: rgba(255, 183, 77, 0.1);">
                                <!-- MELHORIA 2: Estilo melhorado para o valor do lucro -->
                                <div class="lucro-valor" id="lucro-liquido">R$ 0,00</div>
                                <p>Lucro Real</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h3>Histórico de Serviços Realizados</h3>
                    <div class="table-responsive">
                        <table class="data-table" id="tabela-historico">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Cliente</th>
                                    <th>Serviço</th>
                                    <th>Valor</th>
                                    <th>Observações</th>
                                    <th>Tipo</th>
                                </tr>
                            </thead>
                            <tbody id="lista-historico">
                                <!-- O histórico será inserido aqui pelo JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Firebase App (o SDK do Firebase é sempre necessário) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <!-- Firebase Authentication -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <!-- Firebase Firestore -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDqMlT3c4v3h9Zk9Q7d8w6X7y5z4a3b2c1d",
            authDomain: "tati-manicure-app.firebaseapp.com",
            projectId: "tati-manicure-app",
            storageBucket: "tati-manicure-app.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abcdef123456"
        };

        // Inicializa o Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Referências às coleções do Firestore
        const clientesRef = db.collection("clientes");
        const servicosRef = db.collection("servicos");
        const agendamentosRef = db.collection("agendamentos");
        const pacotesRef = db.collection("pacotes");
        const historicoRef = db.collection("historico");

        // Estado da aplicação
        let clientes = [];
        let servicos = [];
        let agendamentos = [];
        let pacotes = [];
        let historico = [];
        let usuarioLogado = null;

        // Inicialização da aplicação
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar se o usuário já está logado
            auth.onAuthStateChanged((user) => {
                if (user) {
                    usuarioLogado = user;
                    document.getElementById('login-container').style.display = 'none';
                    document.getElementById('app-container').style.display = 'flex';
                    carregarDados();
                } else {
                    document.getElementById('login-container').style.display = 'flex';
                    document.getElementById('app-container').style.display = 'none';
                }
            });

            // Configurar formulário de login
            document.getElementById('login-form').addEventListener('submit', fazerLogin);

            // Configurar botão de logout
            document.getElementById('logout-button').addEventListener('click', fazerLogout);

            // Configurar navegação entre seções
            document.querySelectorAll('.sidebar ul li a').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const sectionId = this.getAttribute('data-section') + '-section';
                    
                    // Atualizar navegação ativa
                    document.querySelectorAll('.sidebar ul li a').forEach(item => {
                        item.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    // Mostrar seção correspondente
                    document.querySelectorAll('.content-section').forEach(section => {
                        section.classList.remove('active');
                    });
                    document.getElementById(sectionId).classList.add('active');
                });
            });

            // Configurar formulários
            document.getElementById('cliente-form').addEventListener('submit', salvarCliente);
            document.getElementById('servico-form').addEventListener('submit', salvarServico);
            document.getElementById('agendamento-form').addEventListener('submit', salvarAgendamento);
            document.getElementById('pacote-inicio-form').addEventListener('submit', iniciarPacote);
            document.getElementById('form-usar-pacote').addEventListener('submit', usarPacote);

            // Configurar botões
            document.getElementById('btn-novo-cliente').addEventListener('click', mostrarFormCliente);
            document.getElementById('btn-cancelar-cliente').addEventListener('click', cancelarFormCliente);
            document.getElementById('btn-novo-servico').addEventListener('click', mostrarFormServico);
            document.getElementById('btn-cancelar-servico').addEventListener('click', cancelarFormServico);
            document.getElementById('btn-limpar-filtro-cliente').addEventListener('click', limparFiltroCliente);
            document.getElementById('btn-limpar-filtros').addEventListener('click', limparFiltrosAgendamentos);
            document.getElementById('btn-filtrar-historico').addEventListener('click', filtrarHistorico);
            document.getElementById('btn-hoje').addEventListener('click', definirDataHoje);
            document.getElementById('btn-limpeza-dados').addEventListener('click', mostrarModalLimpeza);
            document.getElementById('cancelar-limpeza').addEventListener('click', fecharModalLimpeza);
            document.getElementById('confirmar-limpeza').addEventListener('change', toggleBotoesLimpeza);
            document.getElementById('btn-limpar-historico').addEventListener('click', limparHistorico);
            document.getElementById('btn-limpar-tudo').addEventListener('click', limparTudo);

            // Configurar filtros
            document.getElementById('filtro-cliente-nome').addEventListener('input', filtrarClientes);
            document.getElementById('filtro-data').addEventListener('change', filtrarAgendamentos);
            document.getElementById('filtro-cliente').addEventListener('input', filtrarAgendamentos);
            document.getElementById('visao-data').addEventListener('change', carregarVisaoDiaria);

            // Configurar modal de pacote
            document.querySelector('.close-modal').addEventListener('click', fecharModalPacote);
            document.getElementById('cancelar-usar-pacote').addEventListener('click', fecharModalPacote);
            document.getElementById('modal-pacote-procedimento').addEventListener('change', function() {
                document.getElementById('group-outro-procedimento').style.display = 
                    this.value === 'Outro' ? 'block' : 'none';
            });

            // Configurar checkbox de pacote no agendamento
            document.getElementById('agendamento-pacote').addEventListener('change', function() {
                document.getElementById('pacote-selecao-container').style.display = 
                    this.checked ? 'block' : 'none';
                if (this.checked) {
                    carregarPacotesParaAgendamento();
                }
            });

            // Configurar seleção de serviço para atualizar valor
            document.getElementById('agendamento-servico').addEventListener('change', function() {
                const servicoId = this.value;
                const servico = servicos.find(s => s.id === servicoId);
                if (servico) {
                    document.getElementById('agendamento-valor').value = servico.valor;
                }
            });

            // Configurar seleção de serviço para pacote
            document.getElementById('pacote-servico-id').addEventListener('change', function() {
                const servicoId = this.value;
                const servico = servicos.find(s => s.id === servicoId);
                if (servico) {
                    document.getElementById('pacote-valor').value = servico.valor;
                document.getElementById('pacote-quantidade').value = 1;
                calcularValorPacote();
                document.getElementById('pacote-quantidade').addEventListener('input', calcularValorPacote);
                document.getElementById('pacote-servico-id').removeEventListener('change', arguments.callee);
                document.getElementById('pacote-servico-id').addEventListener('change', function() {
                    document.getElementById('pacote-quantidade').removeEventListener('input', calcularValorPacote);
                });
            });

            // Inicializar campos de data
            definirDataHoje();
            carregarAnosFiltro();
            
            // MELHORIA 2: Corrigir o mês no filtro do histórico
            const hoje = new Date();
            document.getElementById('filtro-mes').value = hoje.getMonth() + 1;
            document.getElementById('filtro-ano').value = hoje.getFullYear();
        });

        // ========== FUNÇÕES DE AUTENTICAÇÃO ==========
        function fazerLogin(e) {
            e.preventDefault();
            const senha = document.getElementById('loginSenha').value;
            
            // Autenticação simples com senha fixa (em produção, usar Firebase Auth)
            if (senha === 'tati123') {
                auth.signInAnonymously()
                    .then(() => {
                        mostrarNotificacao('Login realizado com sucesso!', 'success');
                    })
                    .catch((error) => {
                        console.error('Erro no login:', error);
                        mostrarNotificacao('Erro ao fazer login. Tente novamente.', 'error');
                    });
            } else {
                mostrarNotificacao('Senha incorreta!', 'error');
            }
        }

        function fazerLogout() {
            auth.signOut()
                .then(() => {
                    mostrarNotificacao('Logout realizado com sucesso!', 'success');
                })
                .catch((error) => {
                    console.error('Erro no logout:', error);
                });
        }

        // ========== FUNÇÕES DE CARREGAMENTO DE DADOS ==========
        function carregarDados() {
            carregarClientes();
            carregarServicos();
            carregarAgendamentos();
            carregarPacotes();
            carregarHistorico();
        }

        function carregarClientes() {
            clientesRef.orderBy('nome').onSnapshot((snapshot) => {
                clientes = [];
                snapshot.forEach((doc) => {
                    clientes.push({ id: doc.id, ...doc.data() });
                });
                atualizarListaClientes();
                atualizarDatalistClientes();
                atualizarSelectClientes();
            });
        }

        function carregarServicos() {
            servicosRef.orderBy('nome').onSnapshot((snapshot) => {
                servicos = [];
                snapshot.forEach((doc) => {
                    servicos.push({ id: doc.id, ...doc.data() });
                });
                atualizarListaServicos();
                atualizarSelectServicos();
            });
        }

        function carregarAgendamentos() {
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);
            
            agendamentosRef.where('data', '>=', hoje.toISOString().split('T')[0])
                          .orderBy('data')
                          .orderBy('horaInicio')
                          .onSnapshot((snapshot) => {
                agendamentos = [];
                snapshot.forEach((doc) => {
                    agendamentos.push({ id: doc.id, ...doc.data() });
                });
                atualizarListaAgendamentos();
                carregarVisaoDiaria();
            });
        }

        function carregarPacotes() {
            pacotesRef.where('status', 'in', ['ativo', 'pendente']).onSnapshot((snapshot) => {
                pacotes = [];
                snapshot.forEach((doc) => {
                    pacotes.push({ id: doc.id, ...doc.data() });
                });
                atualizarListaPacotesAtivos();
            });
        }

        function carregarHistorico() {
            // Carregar histórico do mês atual por padrão
            const hoje = new Date();
            const primeiroDiaMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
            const ultimoDiaMes = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0);
            
            historicoRef.where('data', '>=', primeiroDiaMes.toISOString().split('T')[0])
                       .where('data', '<=', ultimoDiaMes.toISOString().split('T')[0])
                       .orderBy('data', 'desc')
                       .onSnapshot((snapshot) => {
                historico = [];
                snapshot.forEach((doc) => {
                    historico.push({ id: doc.id, ...doc.data() });
                });
                atualizarListaHistorico();
                calcularResumoFinanceiro();
            });
        }

        // ========== FUNÇÕES DE ATUALIZAÇÃO DE UI ==========
        function atualizarListaClientes() {
            const tbody = document.getElementById('lista-clientes');
            const filtro = document.getElementById('filtro-cliente-nome').value.toLowerCase();
            
            tbody.innerHTML = '';
            
            const clientesFiltrados = clientes.filter(cliente => 
                cliente.nome.toLowerCase().includes(filtro)
            );
            
            clientesFiltrados.forEach(cliente => {
                const tr = document.createElement('tr');
                
                // Formatar data de aniversário
                let aniversarioFormatado = '-';
                if (cliente.aniversario) {
                    const data = new Date(cliente.aniversario);
                    aniversarioFormatado = data.toLocaleDateString('pt-BR');
                }
                
                tr.innerHTML = `
                    <td data-label="Nome">${cliente.nome}</td>
                    <td data-label="Telefone">${cliente.telefone || '-'}</td>
                    <td data-label="E-mail">${cliente.email || '-'}</td>
                    <td data-label="Aniversário">${aniversarioFormatado}</td>
                    <td data-label="Observações">${cliente.observacoes || '-'}</td>
                    <td class="action-buttons" data-label="">
                        <button class="btn-warning editar-cliente" data-id="${cliente.id}">
                            <span class="material-icons">edit</span> Editar
                        </button>
                        <button class="btn-danger excluir-cliente" data-id="${cliente.id}">
                            <span class="material-icons">delete</span> Excluir
                        </button>
                    </td>
                `;
                
                tbody.appendChild(tr);
            });
            
            // Adicionar event listeners aos botões
            document.querySelectorAll('.editar-cliente').forEach(btn => {
                btn.addEventListener('click', function() {
                    editarCliente(this.getAttribute('data-id'));
                });
            });
            
            document.querySelectorAll('.excluir-cliente').forEach(btn => {
                btn.addEventListener('click', function() {
                    excluirCliente(this.getAttribute('data-id'));
                });
            });
            
            // Aplicar responsividade às tabelas
            aplicarResponsividadeTabelas();
        }

        function atualizarListaServicos() {
            const tbody = document.getElementById('lista-servicos');
            tbody.innerHTML = '';
            
            servicos.forEach(servico => {
                const tr = document.createElement('tr');
                
                tr.innerHTML = `
                    <td data-label="Nome">${servico.nome}</td>
                    <td data-label="Duração">${servico.duracao} min</td>
                    <td data-label="Valor">R$ ${servico.valor.toFixed(2)}</td>
                    <td data-label="Descrição">${servico.descricao || '-'}</td>
                    <td class="action-buttons" data-label="Ações">
                        <button class="btn-warning editar-servico" data-id="${servico.id}">
                            <span class="material-icons">edit</span> Editar
                        </button>
                        <button class="btn-danger excluir-servico" data-id="${servico.id}">
                            <span class="material-icons">delete</span> Excluir
                        </button>
                    </td>
                `;
                
                tbody.appendChild(tr);
            });
            
            // Adicionar event listeners aos botões
            document.querySelectorAll('.editar-servico').forEach(btn => {
                btn.addEventListener('click', function() {
                    editarServico(this.getAttribute('data-id'));
                });
            });
            
            document.querySelectorAll('.excluir-servico').forEach(btn => {
                btn.addEventListener('click', function() {
                    excluirServico(this.getAttribute('data-id'));
                });
            });
            
            // Aplicar responsividade às tabelas
            aplicarResponsividadeTabelas();
        }

        function atualizarListaAgendamentos() {
            const tbody = document.getElementById('lista-agendamentos');
            const filtroData = document.getElementById('filtro-data').value;
            const filtroCliente = document.getElementById('filtro-cliente').value.toLowerCase();
            
            tbody.innerHTML = '';
            
            const agendamentosFiltrados = agendamentos.filter(agendamento => {
                const atendeData = !filtroData || agendamento.data === filtroData;
                const atendeCliente = !filtroCliente || 
                    agendamento.clienteNome.toLowerCase().includes(filtroCliente);
                return atendeData && atendeCliente;
            });
            
            agendamentosFiltrados.forEach(agendamento => {
                const tr = document.createElement('tr');
                
                // Formatar data
                const data = new Date(agendamento.data);
                const dataFormatada = data.toLocaleDateString('pt-BR');
                
                tr.innerHTML = `
                    <td data-label="Data">${dataFormatada}</td>
                    <td data-label="Hora">${agendamento.horaInicio} - ${agendamento.horaFim}</td>
                    <td data-label="Cliente">${agendamento.clienteNome}</td>
                    <td data-label="Serviço">${agendamento.servicoNome}</td>
                    <td data-label="Valor">R$ ${agendamento.valor.toFixed(2)}</td>
                    <td data-label="Observações">${agendamento.observacoes || '-'}</td>
                    <td class="action-buttons" data-label="Ações">
                        <button class="btn-success finalizar-agendamento" data-id="${agendamento.id}">
                            <span class="material-icons">check_circle</span> Finalizar
                        </button>
                        <button class="btn-danger excluir-agendamento" data-id="${agendamento.id}">
                            <span class="material-icons">delete</span> Excluir
                        </button>
                    </td>
                `;
                
                tbody.appendChild(tr);
            });
            
            // Adicionar event listeners aos botões
            document.querySelectorAll('.finalizar-agendamento').forEach(btn => {
                btn.addEventListener('click', function() {
                    finalizarAgendamento(this.getAttribute('data-id'));
                });
            });
            
            document.querySelectorAll('.excluir-agendamento').forEach(btn => {
                btn.addEventListener('click', function() {
                    excluirAgendamento(this.getAttribute('data-id'));
                });
            });
            
            // Aplicar responsividade às tabelas
            aplicarResponsividadeTabelas();
        }

        function atualizarListaPacotesAtivos() {
            const tbody = document.getElementById('lista-pacotes-ativos');
            tbody.innerHTML = '';
            
            pacotes.forEach(pacote => {
                const tr = document.createElement('tr');
                
                // Formatar data de início
                const dataInicio = new Date(pacote.dataInicio);
                const dataFormatada = dataInicio.toLocaleDateString('pt-BR');
                
                // Determinar classe de status
                let statusClass = '';
                let statusText = '';
                
                switch(pacote.status) {
                    case 'ativo':
                        statusClass = 'status-package-active';
                        statusText = 'Ativo';
                        break;
                    case 'pendente':
                        statusClass = 'status-package-pending';
                        statusText = 'Pendente';
                        break;
                    case 'pago':
                        statusClass = 'status-package-paid';
                        statusText = 'Pago';
                        break;
                    case 'finalizado':
                        statusClass = 'status-package-finalized';
                        statusText = 'Finalizado';
                        break;
                }
                
                tr.innerHTML = `
                    <td data-label="Cliente">${pacote.clienteNome}</td>
                    <td data-label="Serviço">${pacote.servicoNome}</td>
                    <td data-label="Procedimentos Restantes">${pacote.procedimentosRestantes} / ${pacote.quantidadeTotal}</td>
                    <td data-label="Valor">R$ ${pacote.valorTotal.toFixed(2)}</td>
                    <td data-label="Status"><span class="${statusClass}">${statusText}</span></td>
                    <td data-label="Data Início">${dataFormatada}</td>
                    <td class="action-buttons" data-label="Ações">
                        <button class="btn-info usar-pacote" data-id="${pacote.id}" 
                                data-servico-id="${pacote.servicoId}" 
                                data-cliente-id="${pacote.clienteId}"
                                ${pacote.status !== 'ativo' ? 'disabled' : ''}>
                            <span class="material-icons">event_available</span> Usar
                        </button>
                        <button class="btn-warning editar-pacote" data-id="${pacote.id}">
                            <span class="material-icons">edit</span> Editar
                        </button>
                        <button class="btn-danger excluir-pacote" data-id="${pacote.id}">
                            <span class="material-icons">delete</span> Excluir
                        </button>
                    </td>
                `;
                
                tbody.appendChild(tr);
            });
            
            // Adicionar event listeners aos botões
            document.querySelectorAll('.usar-pacote').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (!this.disabled) {
                        abrirModalUsarPacote(
                            this.getAttribute('data-id'),
                            this.getAttribute('data-servico-id'),
                            this.getAttribute('data-cliente-id')
                        );
                    }
                });
            });
            
            document.querySelectorAll('.editar-pacote').forEach(btn => {
                btn.addEventListener('click', function() {
                    // Implementar edição de pacote se necessário
                    mostrarNotificacao('Funcionalidade em desenvolvimento', 'info');
                });
            });
            
            document.querySelectorAll('.excluir-pacote').forEach(btn => {
                btn.addEventListener('click', function() {
                    excluirPacote(this.getAttribute('data-id'));
                });
            });
            
            // Aplicar responsividade às tabelas
            aplicarResponsividadeTabelas();
        }

        function atualizarListaHistorico() {
            const tbody = document.getElementById('lista-historico');
            tbody.innerHTML = '';
            
            historico.forEach(item => {
                const tr = document.createElement('tr');
                
                // Formatar data
                const data = new Date(item.data);
                const dataFormatada = data.toLocaleDateString('pt-BR');
                
                tr.innerHTML = `
                    <td data-label="Data">${dataFormatada}</td>
                    <td data-label="Cliente">${item.clienteNome}</td>
                    <td data-label="Serviço">${item.servicoNome}</td>
                    <td data-label="Valor">R$ ${item.valor.toFixed(2)}</td>
                    <td data-label="Observações">${item.observacoes || '-'}</td>
                    <td data-label="Tipo">${item.tipo === 'pacote' ? 'Pacote' : 'Avulso'}</td>
                `;
                
                tbody.appendChild(tr);
            });
            
            // Aplicar responsividade às tabelas
            aplicarResponsividadeTabelas();
        }

        function atualizarDatalistClientes() {
            const datalist = document.getElementById('clientes-datalist');
            datalist.innerHTML = '';
            
            clientes.forEach(cliente => {
                const option = document.createElement('option');
                option.value = cliente.nome;
                datalist.appendChild(option);
            });
        }

        function atualizarSelectClientes() {
            const select = document.getElementById('pacote-cliente-id');
            select.innerHTML = '<option value="">Selecione um cliente</option>';
            
            clientes.forEach(cliente => {
                const option = document.createElement('option');
                option.value = cliente.id;
                option.textContent = cliente.nome;
                select.appendChild(option);
            });
        }

        function atualizarSelectServicos() {
            const selectAgendamento = document.getElementById('agendamento-servico');
            const selectPacote = document.getElementById('pacote-servico-id');
            
            selectAgendamento.innerHTML = '<option value="">Selecione um serviço</option>';
            selectPacote.innerHTML = '<option value="">Selecione um serviço</option>';
            
            servicos.forEach(servico => {
                const option1 = document.createElement('option');
                option1.value = servico.id;
                option1.textContent = servico.nome;
                selectAgendamento.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = servico.id;
                option2.textContent = servico.nome;
                selectPacote.appendChild(option2);
            });
        }

        function carregarPacotesParaAgendamento() {
            const select = document.getElementById('agendamento-pacote-id');
            const clienteNome = document.getElementById('agendamento-cliente').value;
            
            select.innerHTML = '<option value="">Selecione um pacote</option>';
            
            if (!clienteNome) return;
            
            const cliente = clientes.find(c => c.nome === clienteNome);
            if (!cliente) return;
            
            const pacotesCliente = pacotes.filter(p => 
                p.clienteId === cliente.id && p.status === 'ativo' && p.procedimentosRestantes > 0
            );
            
            pacotesCliente.forEach(pacote => {
                const option = document.createElement('option');
                option.value = pacote.id;
                option.textContent = `${pacote.servicoNome} (${pacote.procedimentosRestantes} restantes)`;
                select.appendChild(option);
            });
        }

        // ========== FUNÇÕES DE FORMULÁRIOS ==========
        function mostrarFormCliente() {
            document.getElementById('form-cliente-card').style.display = 'block';
            document.getElementById('form-cliente-titulo').textContent = 'Novo Cliente';
            document.getElementById('cliente-form').reset();
            document.getElementById('cliente-id').value = '';
        }

        function cancelarFormCliente() {
            document.getElementById('form-cliente-card').style.display = 'none';
        }

        function mostrarFormServico() {
            document.getElementById('form-servico-card').style.display = 'block';
            document.getElementById('form-servico-titulo').textContent = 'Novo Serviço';
            document.getElementById('servico-form').reset();
            document.getElementById('servico-id').value = '';
        }

        function cancelarFormServico() {
            document.getElementById('form-servico-card').style.display = 'none';
        }

        function salvarCliente(e) {
            e.preventDefault();
            
            const id = document.getElementById('cliente-id').value;
            const nome = document.getElementById('cliente-nome').value;
            const telefone = document.getElementById('cliente-telefone').value;
            const email = document.getElementById('cliente-email').value;
            const aniversario = document.getElementById('cliente-aniversario').value;
            const observacoes = document.getElementById('cliente-observacoes').value;
            
            const clienteData = {
                nome,
                telefone,
                email: email || null,
                aniversario: aniversario || null,
                observacoes: observacoes || null,
                dataCriacao: new Date().toISOString()
            };
            
            if (id) {
                // Editar cliente existente
                clientesRef.doc(id).update(clienteData)
                    .then(() => {
                        mostrarNotificacao('Cliente atualizado com sucesso!', 'success');
                        cancelarFormCliente();
                    })
                    .catch((error) => {
                        console.error('Erro ao atualizar cliente:', error);
                        mostrarNotificacao('Erro ao atualizar cliente.', 'error');
                    });
            } else {
                // Adicionar novo cliente
                clientesRef.add(clienteData)
                    .then(() => {
                        mostrarNotificacao('Cliente adicionado com sucesso!', 'success');
                        cancelarFormCliente();
                    })
                    .catch((error) => {
                        console.error('Erro ao adicionar cliente:', error);
                        mostrarNotificacao('Erro ao adicionar cliente.', 'error');
                    });
            }
        }

        function salvarServico(e) {
            e.preventDefault();
            
            const id = document.getElementById('servico-id').value;
            const nome = document.getElementById('servico-nome').value;
            const duracao = parseInt(document.getElementById('servico-duracao').value);
            const valor = parseFloat(document.getElementById('servico-valor').value);
            const descricao = document.getElementById('servico-descricao').value;
            
            const servicoData = {
                nome,
                duracao,
                valor,
                descricao: descricao || null,
                dataCriacao: new Date().toISOString()
            };
            
            if (id) {
                // Editar serviço existente
                servicosRef.doc(id).update(servicoData)
                    .then(() => {
                        mostrarNotificacao('Serviço atualizado com sucesso!', 'success');
                        cancelarFormServico();
                    })
                    .catch((error) => {
                        console.error('Erro ao atualizar serviço:', error);
                        mostrarNotificacao('Erro ao atualizar serviço.', 'error');
                    });
            } else {
                // Adicionar novo serviço
                servicosRef.add(servicoData)
                    .then(() => {
                        mostrarNotificacao('Serviço adicionado com sucesso!', 'success');
                        cancelarFormServico();
                    })
                    .catch((error) => {
                        console.error('Erro ao adicionar serviço:', error);
                        mostrarNotificacao('Erro ao adicionar serviço.', 'error');
                    });
            }
        }

        function salvarAgendamento(e) {
            e.preventDefault();
            
            const clienteNome = document.getElementById('agendamento-cliente').value;
            const telefone = document.getElementById('agendamento-telefone').value;
            const data = document.getElementById('agendamento-data').value;
            const horaInicio = document.getElementById('agendamento-hora').value;
            const horaFim = document.getElementById('agendamento-hora-fim').value;
            const servicoId = document.getElementById('agendamento-servico').value;
            const valor = parseFloat(document.getElementById('agendamento-valor').value);
            const observacoes = document.getElementById('agendamento-observacoes').value;
            const usarPacote = document.getElementById('agendamento-pacote').checked;
            const pacoteId = document.getElementById('agendamento-pacote-id').value;
            
            // Verificar se o cliente existe
            let cliente = clientes.find(c => c.nome === clienteNome);
            let clienteId = null;
            
            if (cliente) {
                clienteId = cliente.id;
            } else {
                // Criar novo cliente
                clienteId = clientesRef.doc().id;
                const clienteData = {
                    nome: clienteNome,
                    telefone: telefone || null,
                    dataCriacao: new Date().toISOString()
                };
                
                clientesRef.doc(clienteId).set(clienteData)
                    .then(() => {
                        mostrarNotificacao('Novo cliente criado automaticamente!', 'info');
                    })
                    .catch((error) => {
                        console.error('Erro ao criar cliente:', error);
                    });
            }
            
            // Obter nome do serviço
            const servico = servicos.find(s => s.id === servicoId);
            const servicoNome = servico ? servico.nome : 'Serviço não encontrado';
            
            const agendamentoData = {
                clienteId,
                clienteNome,
                servicoId,
                servicoNome,
                data,
                horaInicio,
                horaFim,
                valor,
                observacoes: observacoes || null,
                status: 'agendado',
                dataCriacao: new Date().toISOString(),
                tipo: usarPacote && pacoteId ? 'pacote' : 'avulso',
                pacoteId: usarPacote && pacoteId ? pacoteId : null
            };
            
            // Verificar conflitos de horário
            const conflito = agendamentos.find(a => 
                a.data === data && 
                ((horaInicio >= a.horaInicio && horaInicio < a.horaFim) ||
                 (horaFim > a.horaInicio && horaFim <= a.horaFim) ||
                 (horaInicio <= a.horaInicio && horaFim >= a.horaFim))
            );
            
            if (conflito) {
                mostrarNotificacao('Conflito de horário! Já existe um agendamento neste período.', 'error');
                return;
            }
            
            agendamentosRef.add(agendamentoData)
                .then(() => {
                    mostrarNotificacao('Agendamento realizado com sucesso!', 'success');
                    document.getElementById('agendamento-form').reset();
                    document.getElementById('pacote-selecao-container').style.display = 'none';
                    document.getElementById('agendamento-pacote').checked = false;
                })
                .catch((error) => {
                    console.error('Erro ao agendar:', error);
                    mostrarNotificacao('Erro ao realizar agendamento.', 'error');
                });
        }

        function iniciarPacote(e) {
            e.preventDefault();
            
            const clienteId = document.getElementById('pacote-cliente-id').value;
            const servicoId = document.getElementById('pacote-servico-id').value;
            const quantidade = parseInt(document.getElementById('pacote-quantidade').value);
            const valorTotal = parseFloat(document.getElementById('pacote-valor').value);
            const observacoes = document.getElementById('pacote-observacoes').value;
            
            // Obter nome do cliente e serviço
            const cliente = clientes.find(c => c.id === clienteId);
            const servico = servicos.find(s => s.id === servicoId);
            
            if (!cliente || !servico) {
                mostrarNotificacao('Cliente ou serviço não encontrado.', 'error');
                return;
            }
            
            const pacoteData = {
                clienteId,
                clienteNome: cliente.nome,
                servicoId,
                servicoNome: servico.nome,
                quantidadeTotal: quantidade,
                procedimentosRestantes: quantidade,
                valorTotal,
                valorUnitario: valorTotal / quantidade,
                observacoes: observacoes || null,
                status: 'pendente', // Será ativo após o pagamento
                dataInicio: new Date().toISOString().split('T')[0],
                dataCriacao: new Date().toISOString()
            };
            
            pacotesRef.add(pacoteData)
                .then(() => {
                    mostrarNotificacao('Pacote iniciado com sucesso!', 'success');
                    document.getElementById('pacote-inicio-form').reset();
                })
                .catch((error) => {
                    console.error('Erro ao iniciar pacote:', error);
                    mostrarNotificacao('Erro ao iniciar pacote.', 'error');
                });
        }

        // ========== FUNÇÕES DE EDIÇÃO E EXCLUSÃO ==========
        function editarCliente(id) {
            const cliente = clientes.find(c => c.id === id);
            if (!cliente) return;
            
            document.getElementById('form-cliente-card').style.display = 'block';
            document.getElementById('form-cliente-titulo').textContent = 'Editar Cliente';
            document.getElementById('cliente-id').value = cliente.id;
            document.getElementById('cliente-nome').value = cliente.nome;
            document.getElementById('cliente-telefone').value = cliente.telefone || '';
            document.getElementById('cliente-email').value = cliente.email || '';
            document.getElementById('cliente-aniversario').value = cliente.aniversario || '';
            document.getElementById('cliente-observacoes').value = cliente.observacoes || '';
        }

        function excluirCliente(id) {
            if (confirm('Tem certeza que deseja excluir este cliente?')) {
                clientesRef.doc(id).delete()
                    .then(() => {
                        mostrarNotificacao('Cliente excluído com sucesso!', 'success');
                    })
                    .catch((error) => {
                        console.error('Erro ao excluir cliente:', error);
                        mostrarNotificacao('Erro ao excluir cliente.', 'error');
                    });
            }
        }

        function editarServico(id) {
            const servico = servicos.find(s => s.id === id);
            if (!servico) return;
            
            document.getElementById('form-servico-card').style.display = 'block';
            document.getElementById('form-servico-titulo').textContent = 'Editar Serviço';
            document.getElementById('servico-id').value = servico.id;
            document.getElementById('servico-nome').value = servico.nome;
            document.getElementById('servico-duracao').value = servico.duracao;
            document.getElementById('servico-valor').value = servico.valor;
            document.getElementById('servico-descricao').value = servico.descricao || '';
        }

        function excluirServico(id) {
            if (confirm('Tem certeza que deseja excluir este serviço?')) {
                servicosRef.doc(id).delete()
                    .then(() => {
                        mostrarNotificacao('Serviço excluído com sucesso!', 'success');
                    })
                    .catch((error) => {
                        console.error('Erro ao excluir serviço:', error);
                        mostrarNotificacao('Erro ao excluir serviço.', 'error');
                    });
            }
        }

        function finalizarAgendamento(id) {
            const agendamento = agendamentos.find(a => a.id === id);
            if (!agendamento) return;
            
            // Mover para histórico
            const historicoData = {
                clienteId: agendamento.clienteId,
                clienteNome: agendamento.clienteNome,
                servicoId: agendamento.servicoId,
                servicoNome: agendamento.servicoNome,
                data: agendamento.data,
                horaInicio: agendamento.horaInicio,
                horaFim: agendamento.horaFim,
                valor: agendamento.valor,
                observacoes: agendamento.observacoes,
                tipo: agendamento.tipo || 'avulso',
                pacoteId: agendamento.pacoteId || null,
                dataConclusao: new Date().toISOString()
            };
            
            // Se foi usado um pacote, atualizar o pacote
            if (agendamento.pacoteId) {
                pacotesRef.doc(agendamento.pacoteId).get()
                    .then((doc) => {
                        if (doc.exists) {
                            const pacote = doc.data();
                            const novosProcedimentos = pacote.procedimentosRestantes - 1;
                            const novoStatus = novosProcedimentos === 0 ? 'finalizado' : 'ativo';
                            
                            pacotesRef.doc(agendamento.pacoteId).update({
                                procedimentosRestantes: novosProcedimentos,
                                status: novoStatus
                            });
                        }
                    })
                    .catch((error) => {
                        console.error('Erro ao atualizar pacote:', error);
                    });
            }
            
            historicoRef.add(historicoData)
                .then(() => {
                    // Excluir o agendamento
                    agendamentosRef.doc(id).delete()
                        .then(() => {
                            mostrarNotificacao('Serviço finalizado com sucesso!', 'success');
                        })
                        .catch((error) => {
                            console.error('Erro ao excluir agendamento:', error);
                        });
                })
                .catch((error) => {
                    console.error('Erro ao mover para histórico:', error);
                    mostrarNotificacao('Erro ao finalizar serviço.', 'error');
                });
        }

        function excluirAgendamento(id) {
            if (confirm('Tem certeza que deseja excluir este agendamento?')) {
                agendamentosRef.doc(id).delete()
                    .then(() => {
                        mostrarNotificacao('Agendamento excluído com sucesso!', 'success');
                    })
                    .catch((error) => {
                        console.error('Erro ao excluir agendamento:', error);
                        mostrarNotificacao('Erro ao excluir agendamento.', 'error');
                    });
            }
        }

        function excluirPacote(id) {
            if (confirm('Tem certeza que deseja excluir este pacote?')) {
                pacotesRef.doc(id).delete()
                    .then(() => {
                        mostrarNotificacao('Pacote excluído com sucesso!', 'success');
                    })
                    .catch((error) => {
                        console.error('Erro ao excluir pacote:', error);
                        mostrarNotificacao('Erro ao excluir pacote.', 'error');
                    });
            }
        }

        // ========== FUNÇÕES DE PACOTE ==========
        function abrirModalUsarPacote(pacoteId, servicoId, clienteId) {
            document.getElementById('modal-usar-pacote').style.display = 'flex';
            document.getElementById('modal-pacote-id').value = pacoteId;
            document.getElementById('modal-pacote-servico-id').value = servicoId;
            document.getElementById('modal-pacote-cliente-id').value = clienteId;
            
            // Definir data atual como padrão
            document.getElementById('modal-pacote-data').value = new Date().toISOString().split('T')[0];
            
            // Limpar outros campos
            document.getElementById('modal-pacote-hora').value = '';
            document.getElementById('modal-pacote-hora-fim').value = '';
            document.getElementById('modal-pacote-procedimento').value = '';
            document.getElementById('modal-pacote-outro').value = '';
            document.getElementById('modal-pacote-observacoes').value = '';
            document.getElementById('group-outro-procedimento').style.display = 'none';
        }

        function fecharModalPacote() {
            document.getElementById('modal-usar-pacote').style.display = 'none';
        }

        function usarPacote(e) {
            e.preventDefault();
            
            const pacoteId = document.getElementById('modal-pacote-id').value;
            const servicoId = document.getElementById('modal-pacote-servico-id').value;
            const clienteId = document.getElementById('modal-pacote-cliente-id').value;
            const data = document.getElementById('modal-pacote-data').value;
            const horaInicio = document.getElementById('modal-pacote-hora').value;
            const horaFim = document.getElementById('modal-pacote-hora-fim').value;
            const procedimento = document.getElementById('modal-pacote-procedimento').value;
            const outroProcedimento = document.getElementById('modal-pacote-outro').value;
            const observacoes = document.getElementById('modal-pacote-observacoes').value;
            
            // Validar horário
            if (!horaInicio || !horaFim) {
                mostrarNotificacao('Preencha os horários de início e fim.', 'error');
                return;
            }
            
            if (horaInicio >= horaFim) {
                mostrarNotificacao('O horário de fim deve ser após o horário de início.', 'error');
                return;
            }
            
            // Validar procedimento
            let procedimentoRealizado = procedimento;
            if (procedimento === 'Outro' && outroProcedimento) {
                procedimentoRealizado = outroProcedimento;
            }
            
            if (!procedimentoRealizado) {
                mostrarNotificacao('Selecione ou descreva o procedimento realizado.', 'error');
                return;
            }
            
            // Obter dados do cliente e serviço
            const cliente = clientes.find(c => c.id === clienteId);
            const servico = servicos.find(s => s.id === servicoId);
            
            if (!cliente || !servico) {
                mostrarNotificacao('Dados do cliente ou serviço não encontrados.', 'error');
                return;
            }
            
            // Verificar conflitos de horário
            const conflito = agendamentos.find(a => 
                a.data === data && 
                ((horaInicio >= a.horaInicio && horaInicio < a.horaFim) ||
                 (horaFim > a.horaInicio && horaFim <= a.horaFim) ||
                 (horaInicio <= a.horaInicio && horaFim >= a.horaFim))
            );
            
            if (conflito) {
                mostrarNotificacao('Conflito de horário! Já existe um agendamento neste período.', 'error');
                return;
            }
            
            // Criar agendamento para o pacote
            const agendamentoData = {
                clienteId,
                clienteNome: cliente.nome,
                servicoId,
                servicoNome: servico.nome,
                data,
                horaInicio,
                horaFim,
                valor: 0, // Já pago no pacote
                observacoes: observacoes || null,
                status: 'agendado',
                dataCriacao: new Date().toISOString(),
                tipo: 'pacote',
                pacoteId,
                procedimentoRealizado
            };
            
            agendamentosRef.add(agendamentoData)
                .then(() => {
                    mostrarNotificacao('Uso de pacote agendado com sucesso!', 'success');
                    fecharModalPacote();
                })
                .catch((error) => {
                    console.error('Erro ao agendar uso de pacote:', error);
                    mostrarNotificacao('Erro ao agendar uso de pacote.', 'error');
                });
        }

        function calcularValorPacote() {
            const servicoId = document.getElementById('pacote-servico-id').value;
            const quantidade = parseInt(document.getElementById('pacote-quantidade').value);
            
            if (servicoId && quantidade) {
                const servico = servicos.find(s => s.id === servicoId);
                if (servico) {
                    const valorTotal = servico.valor * quantidade;
                    document.getElementById('pacote-valor').value = valorTotal.toFixed(2);
                }
            }
        }

        // ========== FUNÇÕES DE VISÃO DIÁRIA ==========
        function carregarVisaoDiaria() {
            const dataSelecionada = document.getElementById('visao-data').value;
            if (!dataSelecionada) return;
            
            const tbody = document.getElementById('corpo-visao-diaria');
            tbody.innerHTML = '';
            
            // Obter agendamentos do dia
            const agendamentosDia = agendamentos.filter(a => a.data === dataSelecionada);
            
            // Criar linhas para cada horário (8:00 às 18:00)
            for (let hora = 8; hora <= 18; hora++) {
                const tr = document.createElement('tr');
                
                // Célula de horário
                const tdHorario = document.createElement('td');
                tdHorario.className = 'horario-celula';
                tdHorario.textContent = `${hora}:00`;
                tr.appendChild(tdHorario);
                
                // Células para cada coluna de hora (8:00, 9:00, etc.)
                for (let colHora = 8; colHora <= 18; colHora++) {
                    const td = document.createElement('td');
                    
                    // Verificar se há agendamento neste horário
                    const agendamento = agendamentosDia.find(a => {
                        const horaInicio = parseInt(a.horaInicio.split(':')[0]);
                        const horaFim = parseInt(a.horaFim.split(':')[0]);
                        return hora >= horaInicio && hora < horaFim && colHora === horaInicio;
                    });
                    
                    if (agendamento) {
                        td.className = 'agendamento-ocupado';
                        td.innerHTML = `
                            <strong>${agendamento.clienteNome}</strong><br>
                            ${agendamento.servicoNome}<br>
                            ${agendamento.horaInicio} - ${agendamento.horaFim}
                        `;
                        td.setAttribute('data-id', agendamento.id);
                        td.addEventListener('click', function() {
                            // Implementar ação ao clicar no agendamento, se necessário
                        });
                    } else {
                        // Verificar se este horário já passou (para a data selecionada)
                        const hoje = new Date();
                        const dataAgenda = new Date(dataSelecionada);
                        
                        if (dataAgenda.toDateString() === hoje.toDateString() && hora < hoje.getHours()) {
                            td.className = 'agendamento-vencido';
                            td.textContent = 'Horário passado';
                        } else {
                            td.className = 'agendamento-vago';
                            td.textContent = 'Livre';
                        }
                    }
                    
                    tr.appendChild(td);
                }
                
                tbody.appendChild(tr);
            }
        }

        // ========== FUNÇÕES DE FILTRO E RELATÓRIO ==========
        function filtrarClientes() {
            atualizarListaClientes();
        }

        function limparFiltroCliente() {
            document.getElementById('filtro-cliente-nome').value = '';
            filtrarClientes();
        }

        function filtrarAgendamentos() {
            atualizarListaAgendamentos();
        }

        function limparFiltrosAgendamentos() {
            document.getElementById('filtro-data').value = '';
            document.getElementById('filtro-cliente').value = '';
            filtrarAgendamentos();
        }

        function carregarAnosFiltro() {
            const selectAno = document.getElementById('filtro-ano');
            const anoAtual = new Date().getFullYear();
            
            for (let i = anoAtual - 5; i <= anoAtual + 1; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                selectAno.appendChild(option);
            }
            
            selectAno.value = anoAtual;
        }

        function filtrarHistorico() {
            const mes = parseInt(document.getElementById('filtro-mes').value);
            const ano = parseInt(document.getElementById('filtro-ano').value);
            
            const primeiroDiaMes = new Date(ano, mes - 1, 1);
            const ultimoDiaMes = new Date(ano, mes, 0);
            
            historicoRef.where('data', '>=', primeiroDiaMes.toISOString().split('T')[0])
                       .where('data', '<=', ultimoDiaMes.toISOString().split('T')[0])
                       .orderBy('data', 'desc')
                       .get()
                       .then((snapshot) => {
                historico = [];
                snapshot.forEach((doc) => {
                    historico.push({ id: doc.id, ...doc.data() });
                });
                atualizarListaHistorico();
                calcularResumoFinanceiro();
            })
            .catch((error) => {
                console.error('Erro ao filtrar histórico:', error);
                mostrarNotificacao('Erro ao filtrar histórico.', 'error');
            });
        }

        function calcularResumoFinanceiro() {
            const totalServicos = historico.length;
            const faturamentoBruto = historico.reduce((total, item) => total + item.valor, 0);
            
            // Para simplificar, consideramos 70% de lucro líquido
            const lucroLiquido = faturamentoBruto * 0.7;
            
            document.getElementById('total-servicos').textContent = totalServicos;
            document.getElementById('faturamento-bruto').textContent = `R$ ${faturamentoBruto.toFixed(2)}`;
            document.getElementById('lucro-liquido').textContent = `R$ ${lucroLiquido.toFixed(2)}`;
        }

        // ========== FUNÇÕES UTILITÁRIAS ==========
        function definirDataHoje() {
            const hoje = new Date().toISOString().split('T')[0];
            document.getElementById('agendamento-data').value = hoje;
            document.getElementById('visao-data').value = hoje;
        }

        function mostrarNotificacao(mensagem, tipo) {
            const notification = document.getElementById('notification-bar');
            notification.textContent = mensagem;
            notification.className = '';
            notification.classList.add(tipo);
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function aplicarResponsividadeTabelas() {
            // Esta função é executada automaticamente ao atualizar as tabelas
            // Não é necessário chamá-la manualmente
        }

        function showAgendaTab(tabName, event) {
            // Esconder todas as abas
            document.querySelectorAll('.tab-pane').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Mostrar a aba selecionada
            document.getElementById(tabName + '-pane').classList.add('active');
            
            // Atualizar botões ativos
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            event.target.classList.add('active');
        }

        // ========== FUNÇÕES DE LIMPEZA DE DADOS ==========
        function mostrarModalLimpeza() {
            document.getElementById('modal-limpeza-dados').style.display = 'flex';
            document.getElementById('confirmar-limpeza').checked = false;
            toggleBotoesLimpeza();
        }

        function fecharModalLimpeza() {
            document.getElementById('modal-limpeza-dados').style.display = 'none';
        }

        function toggleBotoesLimpeza() {
            const confirmado = document.getElementById('confirmar-limpeza').checked;
            document.getElementById('btn-limpar-historico').disabled = !confirmado;
            document.getElementById('btn-limpar-tudo').disabled = !confirmado;
        }

        function limparHistorico() {
            if (!confirm('ATENÇÃO: Esta ação irá apagar todo o histórico de serviços e não pode ser desfeita. Continuar?')) {
                return;
            }
            
            historicoRef.get()
                .then((snapshot) => {
                    const batch = db.batch();
                    snapshot.forEach((doc) => {
                        batch.delete(doc.ref);
                    });
                    return batch.commit();
                })
                .then(() => {
                    mostrarNotificacao('Histórico limpo com sucesso!', 'success');
                    fecharModalLimpeza();
                })
                .catch((error) => {
                    console.error('Erro ao limpar histórico:', error);
                    mostrarNotificacao('Erro ao limpar histórico.', 'error');
                });
        }

        function limparTudo() {
            if (!confirm('ATENÇÃO: Esta ação irá apagar TODOS os agendamentos, pacotes e histórico. Apenas clientes e serviços serão mantidos. Continuar?')) {
                return;
            }
            
            // Limpar agendamentos
            const promise1 = agendamentosRef.get()
                .then((snapshot) => {
                    const batch = db.batch();
                    snapshot.forEach((doc) => {
                        batch.delete(doc.ref);
                    });
                    return batch.commit();
                });
            
            // Limpar pacotes
            const promise2 = pacotesRef.get()
                .then((snapshot) => {
                    const batch = db.batch();
                    snapshot.forEach((doc) => {
                        batch.delete(doc.ref);
                    });
                    return batch.commit();
                });
            
            // Limpar histórico
            const promise3 = historicoRef.get()
                .then((snapshot) => {
                    const batch = db.batch();
                    snapshot.forEach((doc) => {
                        batch.delete(doc.ref);
                    });
                    return batch.commit();
                });
            
            Promise.all([promise1, promise2, promise3])
                .then(() => {
                    mostrarNotificacao('Todos os dados foram limpos com sucesso!', 'success');
                    fecharModalLimpeza();
                })
                .catch((error) => {
                    console.error('Erro ao limpar dados:', error);
                    mostrarNotificacao('Erro ao limpar dados.', 'error');
                });
        }
    </script>
</body>
</html>
