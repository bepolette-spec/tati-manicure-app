<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tati Manicure - Gerenciamento</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        /* =================================================================
           VARIÁVEIS E ESTILOS GLOBAIS
           ================================================================= */
        :root {
            --primary-color: #ff69b4; /* Pink (Rosa choque) */
            --secondary-color: #5d5d5d; /* Cinza escuro */
            --background-color: #f7f7f7;
            --sidebar-width: 250px;
            --sidebar-bg: #ffffff;
            --sidebar-hover-bg: #ffe0f0; /* Rosa claro para hover */
            --font-color: #333;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
            --warning-color: #ffc107;
            --border-radius: 8px;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            color: var(--font-color);
        }

        body {
            background-color: var(--background-color);
            display: flex;
            min-height: 100vh;
        }

        /* =================================================================
           TELA DE LOGIN
           ================================================================= */

        #login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100vh;
            background-color: var(--background-color);
        }

        .login-card {
            background-color: #fff;
            padding: 40px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            width: 350px;
            text-align: center;
        }

        .login-card h1 {
            color: var(--primary-color);
            margin-bottom: 30px;
            font-size: 2em;
        }

        .login-card input[type="password"] {
            width: 100%;
            padding: 10px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1.1em;
        }

        .login-card .btn-primary {
            width: 100%;
        }


        /* =================================================================
           ESTRUTURA PRINCIPAL (APP)
           ================================================================= */

        #app-container {
            display: none; /* Inicia escondido, só aparece após o login */
            width: 100%;
            /* CORREÇÃO DE LAYOUT: Trocando grid por flex para maior compatibilidade */
            display: flex; 
        }

        /* =================================================================
           SIDEBAR (MENU LATERAL)
           ================================================================= */

        .sidebar {
            background-color: var(--sidebar-bg);
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.05);
            padding: 20px 0;
            height: 100vh;
            position: fixed;
            width: var(--sidebar-width);
            display: flex;
            flex-direction: column;
            justify-content: space-between; 
        }

        .sidebar h1 {
            text-align: center;
            color: var(--primary-color);
            font-size: 1.6em;
            margin-bottom: 30px;
        }

        .sidebar ul {
            list-style: none;
        }

        .sidebar ul li a {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            text-decoration: none;
            color: var(--secondary-color);
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .sidebar ul li a .material-icons {
            margin-right: 10px;
            font-size: 20px;
            color: var(--secondary-color);
        }

        .sidebar ul li a:hover,
        .sidebar ul li a.active {
            background-color: var(--sidebar-hover-bg);
            color: var(--primary-color);
        }

        .sidebar ul li a.active .material-icons {
            color: var(--primary-color);
        }

        .user-info {
            padding: 20px;
            border-top: 1px solid #eee;
            text-align: center;
        }

        .user-info p {
            margin-bottom: 10px;
            font-weight: bold;
        }


        /* =================================================================
           CONTEÚDO PRINCIPAL
           ================================================================= */

        .main-content {
            margin-left: var(--sidebar-width); /* Mantém o espaçamento com a sidebar fixa */
            padding: 30px;
            width: calc(100% - var(--sidebar-width));
            flex-grow: 1; /* Garante que ocupe o restante do espaço */
        }

        .content-section {
            display: none;
            padding-bottom: 50px; 
        }

        .content-section.active {
            display: block;
        }

        .section-header {
            border-bottom: 2px solid var(--primary-color);
            margin-bottom: 25px;
            padding-bottom: 10px;
        }

        .section-header h2 {
            color: var(--secondary-color);
            font-size: 1.8em;
            margin: 0;
        }

        /* =================================================================
           ESTILOS DOS ELEMENTOS (Cards, Forms, Buttons, Table)
           ================================================================= */
        
        .card {
            background-color: #fff;
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            align-items: flex-start;
        }

        .form-row > div {
            flex: 1;
            min-width: 0; 
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 0.9em;
        }

        input[type="text"],
        input[type="number"],
        input[type="email"],
        input[type="tel"],
        input[type="date"],
        input[type="time"],
        textarea,
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1em;
            transition: border-color 0.2s;
        }

        input:focus, textarea:focus, select:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }

        .checkbox-container input {
            width: auto;
            margin-right: 10px;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: background-color 0.2s;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        .btn-primary:hover { background-color: #ff479a; }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        .btn-success:hover { background-color: #1f8b37; }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }
        .btn-secondary:hover { background-color: #444; }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        .btn-danger:hover { background-color: #c82333; }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: #fff;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .data-table th, .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .data-table th {
            background-color: var(--primary-color);
            color: white;
            font-weight: normal;
            text-transform: uppercase;
            font-size: 0.9em;
        }

        .data-table tbody tr:hover {
            background-color: #fcfcfc;
        }

        .action-buttons button {
            margin-right: 5px;
            padding: 6px 8px;
            font-size: 0.8em;
        }

        /* =================================================================
           NOTIFICAÇÃO
           ================================================================= */

        #notification-bar {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 30px;
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            color: white;
            font-weight: bold;
            text-align: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        #notification-bar.show {
            opacity: 1;
        }

        .notification.success { background-color: var(--success-color); }
        .notification.error { background-color: var(--danger-color); }
        .notification.info { background-color: var(--info-color); }

    </style>
</head>
<body>

    <div id="login-container">
        <div class="login-card">
            <h1>Tati Manicure</h1>
            <p>Gerenciamento de Clientes e Agenda</p>
            <form id="login-form">
                <input type="password" id="loginSenha" placeholder="Digite a senha de acesso" required>
                <button type="submit" class="btn btn-primary"><span class="material-icons">lock_open</span> Acessar Sistema</button>
            </form>
        </div>
    </div>

    <div id="app-container">
        
        <div class="sidebar">
            <nav>
                <h1>Tati Manicure</h1>
                <ul>
                    <li><a href="#" data-section="agenda" class="active"><span class="material-icons">calendar_today</span> Agenda</a></li>
                    <li><a href="#" data-section="clientes"><span class="material-icons">people</span> Clientes</a></li>
                    <li><a href="#" data-section="servicos"><span class="material-icons">content_cut</span> Serviços & Pacotes</a></li>
                    <li><a href="#" data-section="historico"><span class="material-icons">history</span> Histórico & Lucros</a></li>
                    <li><a href="#" data-section="configuracoes"><span class="material-icons">settings</span> Configurações</a></li>
                </ul>
            </nav>
            <div class="user-info">
                <p id="userInfo">Olá, Tati!</p>
                <button id="logout-button" class="btn btn-danger"><span class="material-icons">logout</span> Sair</button>
            </div>
        </div>

        <main class="main-content">
            
            <section id="agenda-section" class="content-section active">
                <div class="section-header"><h2>Agenda de Atendimentos</h2></div>
                <div class="card">
                    <h3>Novo Agendamento</h3>
                    <form id="agendamento-form">
                        <input type="hidden" id="agendamento-id">
                        <div class="form-row">
                            <div>
                                <label for="agenda-data">Data:</label>
                                <input type="date" id="agenda-data" required>
                            </div>
                            <div>
                                <label for="agenda-hora">Hora:</label>
                                <input type="time" id="agenda-hora" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div>
                                <label for="agenda-cliente-id">Cliente:</label>
                                <select id="agenda-cliente-id" required>
                                    <option value="">-- Selecione o Cliente --</option>
                                    </select>
                            </div>
                            <div>
                                <label for="agenda-servico-id">Serviço/Pacote:</label>
                                <select id="agenda-servico-id" required>
                                    <option value="">-- Selecione o Serviço --</option>
                                    </select>
                            </div>
                        </div>
                        <label for="agenda-observacoes">Observações (Opcional):</label>
                        <textarea id="agenda-observacoes"></textarea>
                        
                        <div style="margin-top: 20px; display: flex; gap: 10px;">
                            <button type="submit" id="btn-salvar-agendamento" class="btn btn-success"><span class="material-icons">save</span> Salvar Agendamento</button>
                            <button type="button" onclick="resetAgendamentoForm()" class="btn btn-secondary"><span class="material-icons">close</span> Limpar</button>
                        </div>
                    </form>
                </div>
                
                <div class="section-header">
                    <h3>Próximos Agendamentos</h3>
                </div>
                <div class="card">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th style="width: 15%;">Data/Hora</th>
                                <th style="width: 30%;">Cliente</th>
                                <th style="width: 30%;">Serviço</th>
                                <th style="width: 15%;">Status</th>
                                <th style="width: 10%;">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="lista-agendamentos">
                            <tr><td colspan="5" style="text-align: center;">Carregando agendamentos...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="clientes-section" class="content-section">
                <div class="section-header"><h2>Cadastro de Clientes</h2></div>
                <div class="card">
                    <h3>Formulário do Cliente</h3>
                    <form id="cliente-form">
                        <input type="hidden" id="cliente-id">
                        <div class="form-row">
                            <div>
                                <label for="cliente-nome">Nome Completo:</label>
                                <input type="text" id="cliente-nome" required>
                            </div>
                            <div>
                                <label for="cliente-telefone">Telefone (WhatsApp):</label>
                                <input type="tel" id="cliente-telefone">
                            </div>
                        </div>
                        <div class="form-row">
                            <div>
                                <label for="cliente-email">E-mail (Opcional):</label>
                                <input type="email" id="cliente-email">
                            </div>
                            <div>
                                <label for="cliente-endereco">Endereço (Opcional):</label>
                                <input type="text" id="cliente-endereco">
                            </div>
                        </div>
                        <label for="cliente-observacoes">Observações de Saúde/Alergias (Opcional):</label>
                        <textarea id="cliente-observacoes"></textarea>
                        
                        <div style="margin-top: 20px; display: flex; gap: 10px;">
                            <button type="submit" id="btn-salvar-cliente" class="btn btn-success"><span class="material-icons">save</span> Salvar Cliente</button>
                            <button type="button" onclick="resetClienteForm()" class="btn btn-secondary"><span class="material-icons">close</span> Limpar</button>
                        </div>
                    </form>
                </div>
                
                <div class="section-header">
                    <h3>Lista de Clientes Cadastrados</h3>
                </div>
                <div class="card">
                    <input type="text" id="filtro-clientes" onkeyup="filtrarClientes()" placeholder="Filtrar por nome, telefone ou e-mail..." style="margin-bottom: 15px;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th style="width: 40%;">Nome</th>
                                <th style="width: 20%;">Telefone</th>
                                <th style="width: 30%;">E-mail</th>
                                <th style="width: 10%;">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="lista-clientes">
                            <tr><td colspan="4" style="text-align: center;">Carregando clientes...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>
            
            <section id="servicos-section" class="content-section">
                <div class="section-header"><h2>Cadastro de Serviços & Pacotes</h2></div>
                <div class="card">
                    <h3>Formulário de Serviço</h3>
                    <form id="servico-form">
                        <input type="hidden" id="servico-id">
                        <div class="form-row">
                            <div style="flex: 2;">
                                <label for="servico-nome">Nome do Serviço/Pacote:</label>
                                <input type="text" id="servico-nome" required>
                            </div>
                            <div style="flex: 1;">
                                <label for="servico-preco">Preço (R$):</label>
                                <input type="number" id="servico-preco" step="0.01" required>
                            </div>
                        </div>
                        
                        <div class="checkbox-container">
                            <input type="checkbox" id="servico-isPacote">
                            <label for="servico-isPacote" style="margin-bottom: 0; font-weight: normal;">Marcar como Pacote/Promoção (se aplicável)</label>
                        </div>
                        
                        <label for="servico-descricao" style="margin-top: 15px;">Descrição:</label>
                        <textarea id="servico-descricao"></textarea>
                        
                        <div style="margin-top: 20px; display: flex; gap: 10px;">
                            <button type="submit" id="btn-salvar-servico" class="btn btn-success"><span class="material-icons">save</span> Salvar Serviço</button>
                            <button type="button" onclick="resetServicoForm()" class="btn btn-secondary"><span class="material-icons">close</span> Limpar</button>
                        </div>
                    </form>
                </div>
                
                <div class="section-header">
                    <h3>Lista de Serviços e Pacotes</h3>
                </div>
                <div class="card">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th style="width: 40%;">Nome</th>
                                <th style="width: 25%;">Tipo</th>
                                <th style="width: 25%;">Preço</th>
                                <th style="width: 10%;">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="lista-servicos">
                            <tr><td colspan="4" style="text-align: center;">Carregando serviços...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="historico-section" class="content-section">
                </section>
            
            <section id="configuracoes-section" class="content-section">
                <div class="section-header"><h2>Configurações do Sistema</h2></div>
                <div class="card">
                    <p>Funcionalidade em desenvolvimento. Futuramente, aqui você poderá configurar:</p>
                    <ul>
                        <li>Alteração de Senha de Acesso.</li>
                        <li>Notificações por E-mail.</li>
                        <li>Configurações de horário de trabalho.</li>
                    </ul>
                </div>
            </section>

        </main>
    </div>

    <div id="notification-bar" class="notification"></div>
    
    <script type="module">
        // =================================================================
        //          CÓDIGO JAVASCRIPT COMPLETO (INTEGRAÇÃO FIREBASE)
        // =================================================================

        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
        import { getDatabase, ref, onValue, push, set, update, remove } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";
        
        // --- NOVO: INTEGRAÇÃO EMAILJS ---
        import emailjs from "https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js";
         
        // Sua configuração do Firebase (dados enviados por você)
        const firebaseConfig = {
            apiKey: "AIzaSyBatp6e1NzevurpB2yS8eGErgSYC_t2-Nc",
            authDomain: "tati-manicure.firebaseapp.com",
            databaseURL: "https://tati-manicure-default-rtdb.firebaseio.com",
            projectId: "tati-manicure",
            storageBucket: "tati-manicure.firebasestorage.app",
            messagingSenderId: "1061777323027",
            appId: "1:1061777323027:web:7b54e5fdbb7f06ee293be6",
            measurementId: "G-V3ZJ5XBT" 
        };

        // Inicialização do Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app); 

        // Referências aos nós (listas/tabelas) do seu banco de dados
        const clientesRef = ref(db, 'clientes');
        const servicosRef = ref(db, 'servicos'); 
        const agendamentosRef = ref(db, 'agendamentos'); 
        const SENHA_UNICA = "tati123"; // **SENHA ATUAL: tati123**

        // Caches de Dados (para evitar consultas repetidas e facilitar a Agenda)
        let cacheClientes = {}; 
        let cacheServicos = {}; 

        // =================================================================
        //      AUXILIAR: FUNÇÃO DE E-MAIL (EMAILJS)
        // =================================================================

        // Inicializar EmailJS com sua chave pública
        const EMAILJS_PUBLIC_KEY = 'NL4GJXPD62V3HSEOC'; 
        emailjs.init(EMAILJS_PUBLIC_KEY);

        const EMAILJS_SERVICE_ID = 'service_pphgor9';
        const EMAILJS_TEMPLATE_ID = 'template_t6tt9ap';

        // Função auxiliar para formatar a data para exibição (usada no Email e na Tabela)
        function formatarDataHora(dataString, horaString) {
            const data = new Date(dataString + 'T' + horaString + ':00');
            if (isNaN(data.getTime())) return 'Data Inválida';
            
            const options = { weekday: 'short', day: '2-digit', month: '2-digit' };
            let dataFormatada = data.toLocaleDateString('pt-BR', options);
            dataFormatada = dataFormatada.replace(/,|\./g, '').trim(); 
            const horaFormatada = horaString.substring(0, 5); 
            
            return `${dataFormatada} ${horaFormatada}`;
        }


        // Função para enviar o e-mail de confirmação
        function enviarEmailConfirmacao(agendamento) {
            // Usa o cache para buscar o e-mail do cliente
            const cliente = cacheClientes[agendamento.clienteId];
            
            if (!cliente || !cliente.email) {
                console.warn(`Não foi possível enviar e-mail. Cliente ${agendamento.clienteNome} não tem e-mail cadastrado.`);
                return; 
            }
            
            // Parâmetros que correspondem às variáveis no seu Template do EmailJS ({{cliente_nome}}, etc.)
            const templateParams = {
                to: cliente.email, 
                cliente_nome: cliente.nome.split(' ')[0], 
                servico_nome: agendamento.servicoNome,
                // Formata o preço no padrão brasileiro (R$ X,XX)
                servico_preco: `R$ ${parseFloat(agendamento.servicoPreco).toFixed(2).replace('.', ',')}`,
                data_e_hora: formatarDataHora(agendamento.data, agendamento.hora).replace(/,/g, ''), 
                to_email: cliente.email
            };

            emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams)
                .then(() => {
                    console.log(`E-mail de confirmação enviado para: ${cliente.email}`);
                })
                .catch((error) => {
                    console.error("Erro ao enviar e-mail:", error);
                    showNotification('Erro ao enviar e-mail de confirmação.', 'info');
                });
        }


        // =================================================================
        //      1. LÓGICA DE LOGIN, NAVEGAÇÃO E NOTIFICAÇÃO
        // =================================================================

        const loginContainer = document.getElementById('login-container');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const logoutButton = document.getElementById('logout-button');
        const navLinks = document.querySelectorAll('.sidebar ul li a');
        const contentSections = document.querySelectorAll('.content-section');
        const userInfoDisplay = document.getElementById('userInfo');
        const notificationBar = document.getElementById('notification-bar');

        function showApp(userName = 'Tati') {
            loginContainer.style.display = 'none';
            appContainer.style.display = 'flex'; // Usando flex para o layout corrigido
            userInfoDisplay.textContent = `Olá, ${userName}!`;
            
            // Força a carga inicial de dados essenciais
            carregarClientes(); 
            carregarServicos(); 
            popularSelects(); 
            carregarAgendamentos(); 
        }

        function showLogin() {
            loginContainer.style.display = 'flex';
            appContainer.style.display = 'none';
        }

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const senha = document.getElementById('loginSenha').value;
            if (senha === SENHA_UNICA) {
                showApp();
                showNotification(`Acesso liberado! Bem-vinda.`, 'success');
            } else {
                showNotification('Senha incorreta.', 'error');
            }
            document.getElementById('loginSenha').value = '';
        });

        logoutButton.addEventListener('click', () => {
            showLogin();
            showNotification('Você saiu do sistema.', 'info');
        });

        // Navegação entre Telas
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetSectionId = e.currentTarget.getAttribute('data-section');

                // Recarrega as listas quando as abas são clicadas
                if (targetSectionId === 'clientes') { resetClienteForm(); carregarClientes(); }
                if (targetSectionId === 'servicos') { resetServicoForm(); carregarServicos(); }
                if (targetSectionId === 'agenda') { 
                    resetAgendamentoForm();
                    popularSelects(); 
                    carregarAgendamentos(); 
                }
                if (targetSectionId === 'historico') { carregarHistorico(); }

                navLinks.forEach(l => l.classList.remove('active'));
                contentSections.forEach(s => s.classList.remove('active'));

                e.currentTarget.classList.add('active');
                document.getElementById(`${targetSectionId}-section`).classList.add('active');
            });
        });
         
        // Função de Notificação
        function showNotification(message, type = 'success') {
             notificationBar.textContent = message;
             notificationBar.className = `notification ${type} show`;
             setTimeout(() => { notificationBar.classList.remove('show'); }, 3000);
        }

        // =================================================================
        //      2. CRUD DE CLIENTES (NÓ: 'clientes')
        // =================================================================

        const clienteForm = document.getElementById('cliente-form');
        const listaClientes = document.getElementById('lista-clientes');
        const btnSalvarCliente = document.getElementById('btn-salvar-cliente');

        window.resetClienteForm = function() {
            clienteForm.reset();
            document.getElementById('cliente-id').value = '';
            btnSalvarCliente.innerHTML = '<span class="material-icons">save</span> Salvar Cliente';
            btnSalvarCliente.classList.replace('btn-secondary', 'btn-success');
        }

        // 2.1. SALVAR/ATUALIZAR CLIENTE
        clienteForm.addEventListener('submit', (e) => {
            e.preventDefault();

            const id = document.getElementById('cliente-id').value;
            const novoCliente = {
                nome: document.getElementById('cliente-nome').value.trim(),
                telefone: document.getElementById('cliente-telefone').value.trim(),
                email: document.getElementById('cliente-email').value.trim(),
                endereco: document.getElementById('cliente-endereco').value.trim(),
                observacoes: document.getElementById('cliente-observacoes').value.trim()
            };

            if (id) {
                update(ref(db, `clientes/${id}`), novoCliente)
                    .then(() => {
                        showNotification('Cliente atualizado com sucesso!', 'success');
                        resetClienteForm();
                    })
                    .catch(error => {
                        showNotification('Erro ao atualizar cliente: ' + error.message, 'error');
                    });
            } else {
                push(clientesRef, novoCliente)
                    .then(() => {
                        showNotification('Cliente cadastrado com sucesso!', 'success');
                        resetClienteForm();
                    })
                    .catch(error => {
                        showNotification('Erro ao cadastrar cliente: ' + error.message, 'error');
                    });
            }
        });

        // 2.2. CARREGAR CLIENTES DO FIREBASE (e popular cache)
        function carregarClientes() {
            onValue(clientesRef, (snapshot) => {
                const clientes = snapshot.val();
                listaClientes.innerHTML = '';
                cacheClientes = {}; // Limpa e repopula o cache
                const clientesArray = [];

                if (clientes) {
                    for (let id in clientes) {
                        clientesArray.push({ id, ...clientes[id] });
                        cacheClientes[id] = { id, ...clientes[id] }; 
                    }
                    
                    clientesArray.sort((a, b) => a.nome.localeCompare(b.nome));

                    clientesArray.forEach(cliente => {
                        const row = listaClientes.insertRow();
                        row.dataset.clienteData = JSON.stringify(cliente); 
                        
                        row.insertCell().textContent = cliente.nome;
                        row.insertCell().textContent = cliente.telefone;
                        row.insertCell().textContent = cliente.email;
                        
                        const acoesCell = row.insertCell();
                        acoesCell.className = 'action-buttons';
                        
                        const btnEditar = document.createElement('button');
                        btnEditar.innerHTML = '<span class="material-icons" style="font-size: 18px;">edit</span>';
                        btnEditar.className = 'btn-secondary';
                        btnEditar.title = 'Editar';
                        btnEditar.onclick = () => editarCliente(cliente);
                        acoesCell.appendChild(btnEditar);
                        
                        const btnExcluir = document.createElement('button');
                        btnExcluir.innerHTML = '<span class="material-icons" style="font-size: 18px;">delete</span>';
                        btnExcluir.className = 'btn-danger';
                        btnExcluir.title = 'Excluir';
                        btnExcluir.onclick = () => confirmarExclusaoCliente(cliente.id, cliente.nome);
                        acoesCell.appendChild(btnExcluir);
                    });
                } else {
                    listaClientes.innerHTML = '<tr><td colspan="4" style="text-align: center;">Nenhum cliente cadastrado.</td></tr>';
                }
            });
        }

        // 2.3. PREENCHER FORMULÁRIO PARA EDIÇÃO
        function editarCliente(cliente) {
            document.getElementById('cliente-id').value = cliente.id;
            document.getElementById('cliente-nome').value = cliente.nome;
            document.getElementById('cliente-telefone').value = cliente.telefone;
            document.getElementById('cliente-email').value = cliente.email;
            document.getElementById('cliente-endereco').value = cliente.endereco;
            document.getElementById('cliente-observacoes').value = cliente.observacoes;

            btnSalvarCliente.innerHTML = '<span class="material-icons">update</span> Atualizar Cliente';
            btnSalvarCliente.classList.replace('btn-success', 'btn-secondary');

            document.getElementById('clientes-section').scrollIntoView({ behavior: 'smooth' });
        }

        // 2.4. EXCLUIR CLIENTE
        function confirmarExclusaoCliente(id, nome) {
            if (confirm(`Tem certeza que deseja excluir o cliente "${nome}"? Esta ação não pode ser desfeita.`)) {
                remove(ref(db, `clientes/${id}`))
                    .then(() => {
                        showNotification(`Cliente "${nome}" excluído com sucesso.`, 'danger');
                    })
                    .catch(error => {
                        showNotification('Erro ao excluir cliente: ' + error.message, 'error');
                    });
            }
        }
         
        // 2.5. FILTRAR CLIENTES NA TABELA (Busca Local)
        window.filtrarClientes = function() {
            const filtro = document.getElementById('filtro-clientes').value.toLowerCase();
            const linhas = listaClientes.getElementsByTagName('tr');

            for (let i = 0; i < linhas.length; i++) {
                const row = linhas[i];
                if (row.cells.length < 4) continue; 
                
                const clienteData = JSON.parse(row.dataset.clienteData);
                const nome = clienteData.nome.toLowerCase();
                const telefone = clienteData.telefone.toLowerCase();
                const email = clienteData.email.toLowerCase();

                if (nome.includes(filtro) || telefone.includes(filtro) || email.includes(filtro)) {
                    row.style.display = "";
                } else {
                    row.style.display = "none";
                }
            }
        }


        // =================================================================
        //      3. CRUD DE SERVIÇOS (NÓ: 'servicos')
        // =================================================================

        const servicoForm = document.getElementById('servico-form');
        const listaServicos = document.getElementById('lista-servicos');
        const btnSalvarServico = document.getElementById('btn-salvar-servico');

        window.resetServicoForm = function() {
            servicoForm.reset();
            document.getElementById('servico-id').value = '';
            document.getElementById('servico-isPacote').checked = false; 
            btnSalvarServico.innerHTML = '<span class="material-icons">save</span> Salvar Serviço';
            btnSalvarServico.classList.replace('btn-secondary', 'btn-success');
        }

        // 3.1. SALVAR/ATUALIZAR SERVIÇO
        servicoForm.addEventListener('submit', (e) => {
            e.preventDefault();

            const id = document.getElementById('servico-id').value;
            const isPacote = document.getElementById('servico-isPacote').checked;
            
            const novoServico = {
                nome: document.getElementById('servico-nome').value.trim(),
                preco: parseFloat(document.getElementById('servico-preco').value).toFixed(2),
                descricao: document.getElementById('servico-descricao').value.trim(),
                isPacote: isPacote,
                tipo: isPacote ? 'Pacote/Promoção' : 'Serviço'
            };

            if (id) {
                update(ref(db, `servicos/${id}`), novoServico)
                    .then(() => {
                        showNotification('Serviço atualizado com sucesso!', 'success');
                        resetServicoForm();
                    })
                    .catch(error => {
                        showNotification('Erro ao atualizar serviço: ' + error.message, 'error');
                    });
            } else {
                push(servicosRef, novoServico)
                    .then(() => {
                        showNotification('Serviço cadastrado com sucesso!', 'success');
                        resetServicoForm();
                    })
                    .catch(error => {
                        showNotification('Erro ao cadastrar serviço: ' + error.message, 'error');
                    });
            }
        });

        // 3.2. CARREGAR SERVIÇOS DO FIREBASE (e popular cache)
        function carregarServicos() {
            onValue(servicosRef, (snapshot) => {
                const servicos = snapshot.val();
                listaServicos.innerHTML = '';
                cacheServicos = {}; 
                const servicosArray = [];

                if (servicos) {
                    for (let id in servicos) {
                        servicosArray.push({ id, ...servicos[id] });
                        cacheServicos[id] = { id, ...servicos[id] }; 
                    }
                    
                    servicosArray.sort((a, b) => a.nome.localeCompare(b.nome));

                    servicosArray.forEach(servico => {
                        const row = listaServicos.insertRow();
                        row.insertCell().textContent = servico.nome;
                        row.insertCell().textContent = servico.tipo;
                        row.insertCell().textContent = `R$ ${servico.preco.replace('.', ',')}`;
                        
                        const acoesCell = row.insertCell();
                        acoesCell.className = 'action-buttons';
                        
                        const btnEditar = document.createElement('button');
                        btnEditar.innerHTML = '<span class="material-icons" style="font-size: 18px;">edit</span>';
                        btnEditar.className = 'btn-secondary';
                        btnEditar.title = 'Editar';
                        btnEditar.onclick = () => editarServico(servico);
                        acoesCell.appendChild(btnEditar);
                        
                        const btnExcluir = document.createElement('button');
                        btnExcluir.innerHTML = '<span class="material-icons" style="font-size: 18px;">delete</span>';
                        btnExcluir.className = 'btn-danger';
                        btnExcluir.title = 'Excluir';
                        btnExcluir.onclick = () => confirmarExclusaoServico(servico.id, servico.nome);
                        acoesCell.appendChild(btnExcluir);
                    });
                } else {
                    listaServicos.innerHTML = '<tr><td colspan="4" style="text-align: center;">Nenhum serviço/pacote cadastrado.</td></tr>';
                }
            });
        }

        // 3.3. PREENCHER FORMULÁRIO PARA EDIÇÃO
        function editarServico(servico) {
            document.getElementById('servico-id').value = servico.id;
            document.getElementById('servico-nome').value = servico.nome;
            document.getElementById('servico-preco').value = servico.preco;
            document.getElementById('servico-descricao').value = servico.descricao;
            document.getElementById('servico-isPacote').checked = servico.isPacote;

            btnSalvarServico.innerHTML = '<span class="material-icons">update</span> Atualizar Serviço';
            btnSalvarServico.classList.replace('btn-success', 'btn-secondary');

            document.getElementById('servicos-section').scrollIntoView({ behavior: 'smooth' });
        }

        // 3.4. EXCLUIR SERVIÇO
        function confirmarExclusaoServico(id, nome) {
            if (confirm(`Tem certeza que deseja excluir o serviço/pacote "${nome}"? Esta ação não pode ser desfeita.`)) {
                remove(ref(db, `servicos/${id}`))
                    .then(() => {
                        showNotification(`Serviço/Pacote "${nome}" excluído com sucesso.`, 'danger');
                    })
                    .catch(error => {
                        showNotification('Erro ao excluir serviço: ' + error.message, 'error');
                    });
            }
        }


        // =================================================================
        //      4. LÓGICA DA AGENDA (NÓ: 'agendamentos')
        // =================================================================

        const agendamentoForm = document.getElementById('agendamento-form');
        const listaAgendamentos = document.getElementById('lista-agendamentos');
        const clienteSelect = document.getElementById('agenda-cliente-id');
        const servicoSelect = document.getElementById('agenda-servico-id');
        const btnSalvarAgendamento = document.getElementById('btn-salvar-agendamento');

        // 4.1. POPULAR SELECTS (CLIENTES e SERVIÇOS)
        function popularSelects() {
            // 4.1.1. Popula Select de Clientes
            clienteSelect.innerHTML = '<option value="">-- Selecione o Cliente --</option>';
            let clientesArray = Object.values(cacheClientes).sort((a, b) => a.nome.localeCompare(b.nome));

            clientesArray.forEach(cliente => {
                const option = document.createElement('option');
                option.value = cliente.id;
                option.textContent = cliente.nome;
                clienteSelect.appendChild(option);
            });

            // 4.1.2. Popula Select de Serviços
            servicoSelect.innerHTML = '<option value="">-- Selecione o Serviço --</option>';
            let servicosArray = Object.values(cacheServicos).sort((a, b) => a.nome.localeCompare(b.nome));
                
            servicosArray.forEach(servico => {
                const option = document.createElement('option');
                option.value = servico.id;
                option.textContent = `${servico.nome} (R$ ${servico.preco.replace('.', ',')})`;
                servicoSelect.appendChild(option);
            });
        }

        window.resetAgendamentoForm = function() {
            agendamentoForm.reset();
            document.getElementById('agendamento-id').value = '';
            btnSalvarAgendamento.innerHTML = '<span class="material-icons">save</span> Salvar Agendamento';
            btnSalvarAgendamento.classList.replace('btn-secondary', 'btn-success');
        }

        // 4.2. SALVAR/ATUALIZAR AGENDAMENTO
        agendamentoForm.addEventListener('submit', (e) => {
            e.preventDefault();

            const id = document.getElementById('agendamento-id').value;
            const clienteId = clienteSelect.value;
            const servicoId = servicoSelect.value;
            const data = document.getElementById('agenda-data').value;
            const hora = document.getElementById('agenda-hora').value;
            
            const clienteNome = cacheClientes[clienteId] ? cacheClientes[clienteId].nome : 'Cliente Removido';
            const servico = cacheServicos[servicoId];
            
            if (!servico) {
                showNotification('Serviço inválido. Por favor, selecione um serviço existente.', 'error');
                return;
            }

            const novoAgendamento = {
                data: data,
                hora: hora,
                clienteId: clienteId,
                clienteNome: clienteNome,
                servicoId: servicoId,
                servicoNome: servico.nome,
                servicoPreco: servico.preco, 
                observacoes: document.getElementById('agenda-observacoes').value.trim(),
                status: id ? document.querySelector('.data-table tr[data-id="' + id + '"] span')?.textContent || 'Agendado' : 'Agendado' 
            };

            if (id) {
                update(ref(db, `agendamentos/${id}`), novoAgendamento)
                    .then(() => {
                        showNotification('Agendamento atualizado com sucesso!', 'success');
                        enviarEmailConfirmacao(novoAgendamento); // Envia e-mail na atualização
                        resetAgendamentoForm();
                    })
                    .catch(error => {
                        showNotification('Erro ao atualizar agendamento: ' + error.message, 'error');
                    });
            } else {
                push(agendamentosRef, novoAgendamento)
                    .then(() => {
                        showNotification('Agendamento criado com sucesso!', 'success');
                        enviarEmailConfirmacao(novoAgendamento); // Envia e-mail no novo agendamento
                        resetAgendamentoForm();
                    })
                    .catch(error => {
                        showNotification('Erro ao criar agendamento: ' + error.message, 'error');
                    });
            }
        });


        // 4.3. CARREGAR AGENDAMENTOS DO FIREBASE (Próximos)
        function carregarAgendamentos() {
            onValue(agendamentosRef, (snapshot) => {
                const agendamentos = snapshot.val();
                listaAgendamentos.innerHTML = '';
                const agendamentosArray = [];
                const hoje = new Date().toISOString().slice(0, 10);
                const agora = new Date().toTimeString().slice(0, 5);

                if (agendamentos) {
                    for (let id in agendamentos) {
                        agendamentosArray.push({ id, ...agendamentos[id] });
                    }
                    
                    const proximosAgendamentos = agendamentosArray
                        .filter(a => {
                            if (a.status !== 'Agendado') return false; 
                            if (a.data > hoje) return true;
                            if (a.data === hoje && a.hora >= agora) return true;
                            return false;
                        })
                        .sort((a, b) => {
                            const dateTimeA = a.data + 'T' + a.hora;
                            const dateTimeB = b.data + 'T' + b.hora;
                            return new Date(dateTimeA) - new Date(dateTimeB);
                        });


                    proximosAgendamentos.forEach(agendamento => {
                        const row = listaAgendamentos.insertRow();
                        row.dataset.id = agendamento.id; 
                        const dataHoraFormatada = formatarDataHora(agendamento.data, agendamento.hora);

                        row.insertCell().textContent = dataHoraFormatada;
                        row.insertCell().textContent = agendamento.clienteNome;
                        row.insertCell().textContent = agendamento.servicoNome;
                        
                        const statusCell = row.insertCell();
                        const statusSpan = document.createElement('span');
                        statusSpan.textContent = 'Agendado';
                        statusSpan.style.padding = '4px 8px';
                        statusSpan.style.borderRadius = '4px';
                        statusSpan.style.fontSize = '0.9rem';
                        statusSpan.style.backgroundColor = 'var(--primary-color)';
                        statusSpan.style.color = 'white';
                        statusCell.appendChild(statusSpan);

                        const acoesCell = row.insertCell();
                        acoesCell.className = 'action-buttons';
                        
                        const btnEditar = document.createElement('button');
                        btnEditar.innerHTML = '<span class="material-icons" style="font-size: 18px;">edit</span>';
                        btnEditar.className = 'btn-secondary';
                        btnEditar.title = 'Editar Agendamento';
                        btnEditar.onclick = () => editarAgendamento(agendamento);
                        acoesCell.appendChild(btnEditar);
                        
                        const btnConcluir = document.createElement('button');
                        btnConcluir.innerHTML = '<span class="material-icons" style="font-size: 18px;">check_circle</span>';
                        btnConcluir.className = 'btn-success';
                        btnConcluir.title = 'Marcar como Concluído';
                        btnConcluir.onclick = () => atualizarStatusAgendamento(agendamento.id, 'Concluído');
                        acoesCell.appendChild(btnConcluir);
                        
                        const btnCancelar = document.createElement('button');
                        btnCancelar.innerHTML = '<span class="material-icons" style="font-size: 18px;">cancel</span>';
                        btnCancelar.className = 'btn-danger';
                        btnCancelar.title = 'Cancelar Agendamento';
                        btnCancelar.onclick = () => atualizarStatusAgendamento(agendamento.id, 'Cancelado');
                        acoesCell.appendChild(btnCancelar);
                        
                    });
                }
                
                if (proximosAgendamentos?.length === 0 || !agendamentos) {
                    listaAgendamentos.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nenhum agendamento futuro.</td></tr>';
                }
            });
        }

        // 4.4. PREENCHER FORMULÁRIO PARA EDIÇÃO DE AGENDAMENTO
        function editarAgendamento(agendamento) {
            popularSelects(); 
            
            document.getElementById('agendamento-id').value = agendamento.id;
            document.getElementById('agenda-data').value = agendamento.data;
            document.getElementById('agenda-hora').value = agendamento.hora;
            document.getElementById('agenda-cliente-id').value = agendamento.clienteId;
            document.getElementById('agenda-servico-id').value = agendamento.servicoId;
            document.getElementById('agenda-observacoes').value = agendamento.observacoes;

            btnSalvarAgendamento.innerHTML = '<span class="material-icons">update</span> Atualizar Agendamento';
            btnSalvarAgendamento.classList.replace('btn-success', 'btn-secondary');

            document.getElementById('agenda-section').scrollIntoView({ behavior: 'smooth' });
        }

        // 4.5. ATUALIZAR STATUS DO AGENDAMENTO
        window.atualizarStatusAgendamento = function(id, novoStatus) {
            const statusText = novoStatus === 'Concluído' ? 'CONCLUÍDO e registrar a venda' : 'CANCELADO';
            if (confirm(`Tem certeza que deseja marcar este agendamento como **${statusText}**?`)) {
                update(ref(db, `agendamentos/${id}`), { status: novoStatus })
                    .then(() => {
                        showNotification(`Agendamento atualizado para **${novoStatus}**!`, 'info');
                    })
                    .catch(error => {
                        showNotification(`Erro ao atualizar status: ${error.message}`, 'error');
                    });
            }
        }


        // =================================================================
        //      5. LÓGICA DO HISTÓRICO E LUCROS (Filtro e Resumo)
        // =================================================================

        const historicoSection = document.getElementById('historico-section');
        historicoSection.innerHTML = `
            <div class="section-header"><h2>Histórico de Atendimentos & Lucros</h2></div>
            <div class="card">
                <div class="form-row" style="margin-bottom: 20px; align-items: flex-end;">
                    <div>
                        <label for="filtro-data-inicio">De:</label>
                        <input type="date" id="filtro-data-inicio">
                    </div>
                    <div>
                        <label for="filtro-data-fim">Até:</label>
                        <input type="date" id="filtro-data-fim">
                    </div>
                    <div>
                        <button class="btn-primary" onclick="carregarHistorico()" style="margin-bottom: 0;"><span class="material-icons">search</span> Filtrar</button>
                    </div>
                </div>
                
                <div class="card" style="background-color: var(--sidebar-hover-bg); border-left: 5px solid var(--primary-color);">
                    <h3 style="margin-bottom: 10px;">Resumo do Período Filtrado:</h3>
                    <p><strong>Atendimentos Concluídos:</strong> <span id="total-atendimentos">0</span></p>
                    <p><strong>Lucro Estimado:</strong> <span id="lucro-total" style="font-size: 1.5rem; color: var(--success-color); font-weight: bold;">R$ 0,00</span></p>
                </div>

                <div class="section-header" style="margin-top: 30px; border-bottom: none;">
                    <h3>Detalhes dos Atendimentos Concluídos</h3>
                </div>

                <div style="max-height: 500px; overflow-y: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th style="width: 15%;">Data/Hora</th>
                                <th style="width: 30%;">Cliente</th>
                                <th style="width: 30%;">Serviço</th>
                                <th>Valor (R$)</th>
                                <th style="width: 100px;">Status</th>
                            </tr>
                        </thead>
                        <tbody id="lista-historico">
                            <tr><td colspan="5" style="text-align: center;">Use o filtro acima para buscar atendimentos concluídos.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        `;


        const listaHistorico = document.getElementById('lista-historico');
        const lucroTotalDisplay = document.getElementById('lucro-total');
        const totalAtendimentosDisplay = document.getElementById('total-atendimentos');
        const filtroDataInicio = document.getElementById('filtro-data-inicio');
        const filtroDataFim = document.getElementById('filtro-data-fim');

        window.carregarHistorico = function() {
            const dataInicio = filtroDataInicio.value;
            const dataFim = filtroDataFim.value;
            
            const dataInicial = dataInicio || '1900-01-01'; 
            const dataFinal = dataFim || '9999-12-31'; 

            onValue(agendamentosRef, (snapshot) => {
                const agendamentos = snapshot.val();
                let atendimentosConcluidos = [];
                let lucroTotal = 0.00;
                
                listaHistorico.innerHTML = '';

                if (agendamentos) {
                    for (let id in agendamentos) {
                        const agendamento = { id, ...agendamentos[id] };

                        if (agendamento.status === 'Concluído' && agendamento.data >= dataInicial && agendamento.data <= dataFinal) {
                            atendimentosConcluidos.push(agendamento);
                            lucroTotal += parseFloat(agendamento.servicoPreco || 0);
                        }
                    }

                    atendimentosConcluidos.sort((a, b) => {
                        const dateTimeA = a.data + 'T' + a.hora;
                        const dateTimeB = b.data + 'T' + b.hora;
                        return new Date(dateTimeB) - new Date(dateTimeA); 
                    });

                    atendimentosConcluidos.forEach(agendamento => {
                        const row = listaHistorico.insertRow();
                        row.insertCell().textContent = formatarDataHora(agendamento.data, agendamento.hora);
                        row.insertCell().textContent = agendamento.clienteNome;
                        row.insertCell().textContent = agendamento.servicoNome;
                        row.insertCell().textContent = `R$ ${parseFloat(agendamento.servicoPreco).toFixed(2).replace('.', ',')}`;

                        const statusCell = row.insertCell();
                        const statusSpan = document.createElement('span');
                        statusSpan.textContent = 'Concluído';
                        statusSpan.style.padding = '4px 8px';
                        statusSpan.style.borderRadius = '4px';
                        statusSpan.style.fontSize = '0.9rem';
                        statusSpan.style.backgroundColor = 'var(--success-color)';
                        statusSpan.style.color = 'white';
                        statusCell.appendChild(statusSpan);
                    });
                }
                
                lucroTotalDisplay.textContent = `R$ ${lucroTotal.toFixed(2).replace('.', ',')}`;
                totalAtendimentosDisplay.textContent = atendimentosConcluidos.length;
                
                if (atendimentosConcluidos.length === 0) {
                    listaHistorico.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nenhum atendimento concluído encontrado no período.</td></tr>';
                }
            }, { onlyOnce: true }); 
        }

        // 5.1. Inicialização do histórico ao entrar na seção
        document.querySelector('[data-section="historico"]').addEventListener('click', carregarHistorico);


        // =================================================================
        //      6. INICIALIZAÇÃO
        // =================================================================

        // Garante que a tela de Login é a primeira a ser mostrada
        showLogin();

    </script>
</body>
</html>
