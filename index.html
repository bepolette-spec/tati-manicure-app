<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tati Manicure - Gerenciamento de Agendamentos</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #ff8c6b; /* Cor de Destaque (Salmão/Coral) */
            --secondary-color: #6c757d; /* Cinza para secundários */
            --background-color: #f4f7f6; /* Fundo Suave */
            --sidebar-bg: #ffffff;
            --sidebar-hover-bg: #fff0eb; /* Fundo mais claro para hover */
            --text-color: #343a40; /* Texto Principal (Escuro) */
            --success-color: #28a745;
            --info-color: #17a2b8;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --border-color: #e9ecef;
            --shadow-color: rgba(0, 0, 0, 0.05);
        }

        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            min-height: 100vh;
        }

        /* Estrutura do App */
        #login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            background-color: var(--primary-color);
            min-height: 100vh;
        }

        .login-card {
            background: var(--sidebar-bg);
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 15px var(--shadow-color);
            text-align: center;
            width: 100%;
            max-width: 400px;
        }

        .login-card h1 {
            color: var(--primary-color);
            margin-bottom: 30px;
            font-size: 1.8rem;
        }

        #app-container {
            display: none; /* Escondido por padrão, mostrado após o login */
            width: 100%;
            display: flex;
        }

        /* Barra Lateral (Sidebar) */
        .sidebar {
            width: 250px;
            background-color: var(--sidebar-bg);
            box-shadow: 2px 0 5px var(--shadow-color);
            display: flex;
            flex-direction: column;
            padding: 20px 0;
            flex-shrink: 0;
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
            color: var(--primary-color);
            font-size: 1.6rem;
            font-weight: bold;
        }

        .sidebar ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar ul li a {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            text-decoration: none;
            color: var(--text-color);
            transition: background-color 0.2s, color 0.2s;
            font-weight: 500;
        }

        .sidebar ul li a:hover,
        .sidebar ul li a.active {
            background-color: var(--sidebar-hover-bg);
            color: var(--primary-color);
        }

        .sidebar ul li a .material-icons {
            margin-right: 10px;
            font-size: 20px;
        }

        .user-info {
            margin-top: auto;
            padding: 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .user-info p {
            margin: 0 0 10px 0;
            font-weight: bold;
        }

        /* Conteúdo Principal */
        .main-content {
            flex-grow: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .content-section {
            display: none;
            padding: 20px;
        }

        .content-section.active {
            display: block;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .section-header h2 {
            margin: 0;
            color: var(--text-color);
            font-size: 1.5rem;
        }
        
        /* Novas cores para Status de Pacote e Histórico */
        .status-package-paid {
             color: var(--success-color);
             font-weight: bold;
        }
        .status-package-pending {
            color: var(--warning-color);
            font-weight: bold;
        }
        .status-package-active {
            color: var(--primary-color);
            font-weight: bold;
        }
        .status-package-finalized {
            color: var(--danger-color);
            font-weight: bold;
        }

        /* Cartão (Card) */
        .card {
            background: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 4px var(--shadow-color);
            margin-bottom: 20px;
        }
        
        /* NOVO V6: Abas dentro de uma seção */
        .tab-menu {
             display: flex;
             border-bottom: 2px solid var(--border-color);
             margin-bottom: 20px;
        }
        .tab-menu button {
             padding: 10px 20px;
             border: none;
             background: transparent;
             cursor: pointer;
             font-size: 1rem;
             color: var(--secondary-color);
             border-bottom: 2px solid transparent;
             transition: border-color 0.2s, color 0.2s;
             font-weight: bold;
        }
        .tab-menu button.active {
             color: var(--primary-color);
             border-bottom: 2px solid var(--primary-color);
        }
        .tab-content {
             padding-top: 10px;
        }
        .tab-pane {
             display: none;
        }
        .tab-pane.active {
             display: block;
        }

        /* Formulários */
        .form-group {
            margin-bottom: 15px;
        }

        .form-row {
            display: flex;
            gap: 20px;
        }

        .form-row > div {
            flex: 1;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 0.95rem;
        }

        input[type="text"],
        input[type="number"],
        input[type="email"],
        input[type="tel"],
        input[type="date"],
        input[type="time"],
        textarea,
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        /* Datalist input */
        input[list] {
            /* Estilo para garantir que o input datalist se pareça com um campo normal */
            background-image: none;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="email"]:focus,
        input[type="tel"]:focus,
        input[type="date"]:focus,
        input[type="time"]:focus,
        textarea:focus,
        select:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        textarea {
            resize: vertical;
        }

        /* Botões */
        button, .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: background-color 0.2s, opacity 0.2s;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #e57a5e;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #218838;
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: var(--text-color);
        }

        .btn-warning:hover {
            background-color: #ffb547;
        }


        /* Tabelas */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table thead tr {
            background-color: var(--primary-color);
            color: white;
            text-align: left;
        }

        .data-table th, .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table tbody tr:hover {
            background-color: var(--sidebar-hover-bg);
        }

        .data-table td.action-buttons button {
            margin-right: 5px;
            padding: 6px 8px;
        }

        .data-table td.action-buttons {
            white-space: nowrap;
        }

        /* Notificação */
        #notification-bar {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s, transform 0.3s;
            transform: translateY(-20px);
            z-index: 1000;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            font-weight: bold;
        }

        #notification-bar.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        #notification-bar.success { background-color: var(--success-color); }
        #notification-bar.error { background-color: var(--danger-color); }
        #notification-bar.info { background-color: var(--info-color); }

        /* Utilitários */
        .flex-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .input-group {
            display: flex;
            gap: 10px;
        }
        
        .input-group input, .input-group select {
            flex-grow: 1;
        }

        .filter-row {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            margin-bottom: 20px;
        }
        .filter-row > div {
            flex: 1;
        }
        .filter-row button {
            flex-grow: 0;
            flex-shrink: 0;
            padding: 9px 15px; /* Ajuste para alinhar com o input */
        }
        
        /* NOVO V6: Estilos para a Tabela de Visão Diária */
        .table-responsive {
             overflow-x: auto;
        }
        #tabela-visao-diaria {
             border: 1px solid var(--border-color);
             margin-top: 0;
        }
        #tabela-visao-diaria thead tr {
             background-color: var(--secondary-color);
        }
        #tabela-visao-diaria td {
             height: 40px; /* Altura padrão para cada intervalo de 30 min */
             font-size: 0.9rem;
             vertical-align: top;
        }
        .horario-celula {
             width: 80px;
             font-weight: bold;
             background-color: var(--sidebar-hover-bg);
             color: var(--text-color);
             text-align: center;
             vertical-align: middle !important;
             border-right: 1px solid var(--border-color);
        }
        .agendamento-vago {
             background-color: #f7fff7; /* Verde clarinho */
             color: var(--success-color);
             font-weight: bold;
             font-style: italic;
             text-align: center;
             line-height: 40px;
        }
        .agendamento-ocupado {
             background-color: #fff0eb; /* Fundo do hover de sidebar, suave */
             color: var(--text-color);
             font-weight: 500;
             padding: 5px 10px !important;
             vertical-align: middle !important;
             line-height: 1.2;
             border-left: 5px solid var(--primary-color);
             cursor: pointer;
        }
        .agendamento-ocupado strong {
             color: var(--primary-color);
             font-weight: bold;
        }
        
        /* --------------------------------------------------- */
        /* RESPONSIVIDADE MOBILE (Mobile First - Portrait Mode)*/
        /* --------------------------------------------------- */
        @media (max-width: 768px) {
            
            /* Estrutura Principal */
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
                box-shadow: 0 0 5px var(--shadow-color);
            }

            .main-content {
                padding: 15px;
            }

            #app-container {
                flex-direction: column;
            }

            /* Navegação Horizontal */
            .sidebar ul {
                display: flex;
                flex-wrap: nowrap; /* Tenta manter em uma linha, mas permite rolagem */
                overflow-x: auto;
                justify-content: flex-start;
                border-bottom: 1px solid var(--border-color);
            }

            .sidebar ul li {
                flex-shrink: 0; /* Impede que os itens encolham */
                text-align: center;
            }

            .sidebar ul li a {
                justify-content: center;
                padding: 10px;
                flex-direction: column;
                font-size: 0.75rem;
                white-space: nowrap;
            }

            .sidebar ul li a .material-icons {
                margin-right: 0;
                margin-bottom: 5px;
                font-size: 20px;
            }

            /* FIX: Botão Sair visível no celular */
            .user-info {
                display: block;
                padding: 10px 15px;
                border-top: none; 
                text-align: center; 
            }

            .user-info p {
                display: none; /* Esconde o texto "Olá, Tati!" para economizar espaço */
            }

            .user-info button {
                width: 100%;
                margin-top: 10px; 
                font-size: 0.9rem;
            }
            
            /* 1. Correção de Formulários e Filtros (Empilhamento) */
            .form-row, .filter-row {
                flex-direction: column;
                gap: 0; /* Remove gap quando empilha */
            }

            .form-row > div, 
            .filter-row > div {
                flex: 0 0 100% !important; /* Força largura total */
                width: 100%;
            }
            
            /* Ajusta margem para inputs empilhados */
            .form-group, .filter-row > div {
                margin-bottom: 10px;
            }
            
            .filter-row button {
                width: 100%;
                margin-top: 5px; 
                padding: 10px 15px !important;
            }
            
            /* V6: Ajuste para a Tabela de Visão Diária */
            #tabela-visao-diaria {
                 width: 100%;
                 min-width: 300px; /* Garante que não fique muito esmagada */
            }
            #tabela-visao-diaria td {
                 padding: 5px 10px !important;
            }

            /* 2. Correção de Tabelas (Cartão-like View) */
            .data-table, .data-table tbody, .data-table td, .data-table tr {
                display: block; /* Força elementos da tabela a empilhar */
            }

            .data-table thead {
                display: none; /* Esconde o cabeçalho original */
            }

            .data-table tr {
                border: 1px solid var(--border-color);
                margin-bottom: 15px;
                border-radius: 8px;
                box-shadow: 0 1px 3px var(--shadow-color);
                padding: 10px;
            }

            .data-table td {
                border: none;
                position: relative;
                padding-left: 50% !important; /* Espaço para o rótulo */
                text-align: right; /* Alinha o valor à direita */
                white-space: normal; /* Permite quebras de linha */
                min-height: 40px;
            }

            /* Rótulo customizado (que usa o data-label do JS) */
            .data-table td::before {
                content: attr(data-label);
                position: absolute;
                left: 10px;
                width: 45%; 
                padding-right: 10px;
                white-space: nowrap;
                text-align: left;
                font-weight: bold;
                color: var(--primary-color);
            }
            
            /* FIX V6: Organização dos botões de ação em mobile */
            /* Garante que o rótulo "Ações" não sobreponha o primeiro botão */
            .data-table td.action-buttons {
                text-align: left;
                padding-left: 10px !important;
                display: flex; 
                flex-direction: column; /* Empilha os botões */
                gap: 5px;
            }
            
            .data-table td.action-buttons::before {
                content: "Ações";
                width: 100%; 
                margin-bottom: 5px;
                display: block;
            }
            
            .data-table td.action-buttons button {
                margin: 0;
                width: 100%; /* Ocupa a largura toda */
                max-width: 100%;
                box-sizing: border-box;
                font-size: 0.9rem; 
                padding: 8px 5px;
            }
        }
    </style>
</head>
<body>

    <div id="notification-bar"></div>

    <div id="login-container">
        <div class="login-card">
            <h1>Tati Manicure - Acesso</h1>
            <form id="login-form">
                <div class="form-group">
                    <label for="loginSenha">Senha de Acesso</label>
                    <input type="password" id="loginSenha" required>
                </div>
                <button type="submit" class="btn-primary" style="width: 100%; margin-top: 10px;">
                    <span class="material-icons">login</span> Entrar
                </button>
            </form>
        </div>
    </div>

    <datalist id="clientes-datalist"></datalist>

    <div id="app-container">
        
        <aside class="sidebar">
            <div class="logo">TATI MANICURE APP</div>
            
            <ul>
                <li><a href="#" data-section="agenda" class="active"><span class="material-icons">calendar_today</span> Agenda</a></li>
                <li><a href="#" data-section="clientes"><span class="material-icons">people</span> Clientes</a></li>
                <li><a href="#" data-section="servicos"><span class="material-icons">local_offer</span> Serviços</a></li>
                <li><a href="#" data-section="historico"><span class="material-icons">history</span> Histórico/Lucros</a></li>
            </ul>

            
            <div class="user-info">
                <p id="userInfo">Olá, Tati!</p>
                <button id="logout-button" class="btn-danger" style="width: 100%;">
                    <span class="material-icons">logout</span> Sair
                </button>
            </div>
        </aside>

        <main class="main-content">

            <div id="agenda-section" class="content-section active">
                
                <div class="tab-menu">
                     <button class="tab-button active" onclick="showAgendaTab('pacotes-ativos')">Pacotes Ativos</button>
                     <button class="tab-button" onclick="showAgendaTab('novo-agendamento')">Novo Agendamento</button>
                     <button class="tab-button" onclick="showAgendaTab('lista-agendamentos')">Lista Agendamentos</button>
                     <button class="tab-button" onclick="showAgendaTab('visao-diaria')">Visão Diária</button>
                </div>
                
                <div class="tab-content">
                    
                    <div id="pacotes-ativos-pane" class="tab-pane active">
                         <div class="section-header"><h2>Gerenciamento de Pacotes Ativos</h2></div>
                         <div class="card">
                            <form id="pacote-inicio-form">
                                <h3>Iniciar Novo Pacote de Serviços</h3>
                                <div class="form-row">
                                    <div class="form-group" style="flex: 2;">
                                        <label for="pacote-cliente-id">Cliente</label>
                                        <select id="pacote-cliente-id" required></select>
                                    </div>
                                    <div class="form-group" style="flex: 2;">
                                         <label for="pacote-servico-id">Pacote (Serviços marcados como Pacote)</label>
                                        <select id="pacote-servico-id" required></select>
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label for="pacote-data-inicio">Data Início (Geralmente Hoje)</label>
                                        <input type="date" id="pacote-data-inicio" required>
                                    </div>
                                </div>

                                <div class="flex-container">
                                    <button type="submit" class="btn-primary">
                                         <span class="material-icons">add_box</span> Iniciar/Vender Pacote
                                    </button>
                                </div>
                            </form>
                            
                            <hr style="margin: 20px 0;">

                            <h3>Pacotes Ativos e Utilização</h3>
                            <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 20%;">Cliente</th>
                                            <th style="width: 25%;">Pacote (Total/Usado)</th>
                                            <th style="width: 15%;">Pagamento</th>
                                            <th style="width: 15%;">Vencimento</th>
                                            <th style="width: 200px;">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="lista-pacotes-ativos">
                                        <tr><td colspan="5" style="text-align: center;">Carregando pacotes ativos...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                         </div>
                    </div>
                    
                    <div id="novo-agendamento-pane" class="tab-pane">
                         <div class="section-header"><h2>Agendamento de Serviços</h2></div>
                         <div class="card">
                            <form id="agendamento-form">
                                <input type="hidden" id="agendamento-id">
                                
                                <div class="form-row">
                                  <div class="form-group" style="flex: 2;">
                                        <label for="agenda-cliente-id">Cliente</label>
                                        <select id="agenda-cliente-id" required></select>
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                         <label for="agenda-tipo-movimentacao">Tipo de Movimentação</label>
                                         <select id="agenda-tipo-movimentacao" onchange="popularServicosAgendamento()" required>
                                             <option value="">Selecione o Tipo</option>
                                             <option value="servico">Serviço/Promoção (Individual)</option>
                                             <option value="pacote">Uso de Pacote Ativo</option>
                                         </select>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group" style="flex: 2;">
                                         <label for="agenda-servico-id" id="label-agenda-servico-id">Serviço (Individual) / Pacote (Ativo)</label>
                                         <select id="agenda-servico-id" required></select>
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label for="agenda-data">Data</label>
                                        <input type="date" id="agenda-data" required>
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="form-group" style="flex: 1;">
                                        <label for="agenda-hora">Hora Início</label>
                                        <input type="time" id="agenda-hora" required>
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label for="agenda-hora-fim">Hora Fim</label>
                                        <input type="time" id="agenda-hora-fim" required>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="agenda-observacoes">Observações</label>
                                    <textarea id="agenda-observacoes" rows="2"></textarea>
                                </div>


                                <div class="flex-container">
                                    <div>
                                        <button type="submit" class="btn-success" id="btn-salvar-agendamento">
                                            <span class="material-icons">save</span> Salvar Agendamento
                                        </button>
                                        <button type="button" class="btn-secondary" onclick="resetAgendamentoForm()">
                                            <span class="material-icons">refresh</span> Limpar
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <div id="lista-agendamentos-pane" class="tab-pane">
                        <div class="section-header">
                            <h3>Próximos Agendamentos (Ativos)</h3>
                        </div>
                        <div class="card">
                            <div class="filter-row">
                                <div style="flex-grow: 1.5;">
                                    <label for="filtro-agenda-data">Filtrar por Data</label>
                                    <input type="date" id="filtro-agenda-data" onchange="carregarAgendamentos()">
                                </div>
                                <div style="flex-grow: 3;">
                                    <label for="filtro-agenda-cliente">Filtrar por Cliente (Digite ou Selecione)</label>
                                    <input type="text" id="filtro-agenda-cliente" list="clientes-datalist" placeholder="Digite o nome do cliente..." onkeyup="filtrarAgendamentos()">
                                </div>
                                <button class="btn-secondary" onclick="resetFiltroAgenda()"><span class="material-icons">refresh</span> Resetar Filtro</button>
                            </div>
                            <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 15%;">Data/Hora</th>
                                            <th style="width: 25%;">Cliente</th>
                                            <th style="width: 25%;">Serviço</th>
                                            <th>Status</th>
                                            <th style="width: 150px;">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="lista-agendamentos">
                                        <tr><td colspan="5" style="text-align: center;">Carregando agendamentos...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div id="visao-diaria-pane" class="tab-pane">
                        <div class="section-header">
                            <h2>Visão Diária da Agenda</h2>
                        </div>
                        <div class="card">
                            <div class="filter-row">
                                <div style="flex-grow: 1;">
                                    <label for="filtro-visao-diaria-data">Selecione a Data</label>
                                    <input type="date" id="filtro-visao-diaria-data" onchange="renderizarVisaoDiaria()">
                                </div>
                                <button class="btn-secondary" onclick="renderizarVisaoDiaria(today)"><span class="material-icons">today</span> Ver Hoje</button>
                            </div>
                            <div class="table-responsive">
                                <table class="data-table" id="tabela-visao-diaria">
                                    <thead>
                                        <tr>
                                            <th style="width: 100px;">Horário</th>
                                            <th>Detalhes do Agendamento</th>
                                        </tr>
                                    </thead>
                                    <tbody id="lista-visao-diaria">
                                        <tr><td colspan="2" style="text-align: center;">Selecione uma data para visualizar.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="clientes-section" class="content-section">
                <div class="section-header"><h2>Cadastro de Clientes</h2></div>
                <div class="card">
                    <form id="cliente-form">
                        <input type="hidden" id="cliente-id">
                        <div class="form-row">
                            <div class="form-group" style="flex: 2;">
                                <label for="cliente-nome">Nome Completo</label>
                                <input type="text" id="cliente-nome" required>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label for="cliente-telefone">Telefone (Whatsapp)</label>
                                <input type="tel" id="cliente-telefone">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="cliente-email">E-mail (Opcional)</label>
                            <input type="email" id="cliente-email">
                        </div>
                        <div class="form-group">
                            <label for="cliente-endereco">Endereço (Opcional)</label>
                            <input type="text" id="cliente-endereco">
                        </div>
                        <div class="form-group">
                            <label for="cliente-observacoes">Observações (Alergias, Preferências)</label>
                            <textarea id="cliente-observacoes" rows="2"></textarea>
                        </div>
                        <div class="flex-container">
                            <div>
                                <button type="submit" class="btn-success" id="btn-salvar-cliente">
                                    <span class="material-icons">save</span> Salvar Cliente
                                </button>
                                <button type="button" class="btn-secondary" onclick="resetClienteForm()">
                                    <span class="material-icons">refresh</span> Limpar
                                </button>
                            </div>
                        </div>
                    </form>
                </div>

                <div class="section-header">
                    <h3>Lista de Clientes Cadastrados</h3>
                    <div class="input-group" style="width: 300px;">
                        <input type="text" id="filtro-clientes" list="clientes-datalist" placeholder="Filtrar por nome, tel ou email..." onkeyup="filtrarClientes()">
                    </div>
                </div>
                <div class="card">
                    <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th style="width: 30%;">Nome</th>
                                    <th style="width: 20%;">Telefone</th>
                                    <th style="width: 30%;">E-mail</th>
                                    <th style="width: 150px;">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="lista-clientes">
                                <tr><td colspan="4" style="text-align: center;">Carregando clientes...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="servicos-section" class="content-section">
                <div class="section-header"><h2>Cadastro de Serviços/Pacotes</h2></div>
                <div class="card">
                    <form id="servico-form">
                        <input type="hidden" id="servico-id">
                        <div class="form-row">
                            <div class="form-group" style="flex: 2;">
                                <label for="servico-nome">Nome do Serviço</label>
                                <input type="text" id="servico-nome" required>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label for="servico-preco">Preço (R$)</label>
                                <input type="number" id="servico-preco" step="0.01" min="0" required value="0.00">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <label>
                                    <input type="checkbox" id="servico-isPacote"> É um **Pacote Mensal**?
                                </label>
                            </div>
                            <div class="form-group" id="group-quantidade-total" style="flex: 1; display: none;">
                                <label for="servico-quantidade-total">Total de Procedimentos no Pacote (ex: 6)</label>
                                <input type="number" id="servico-quantidade-total" min="1" value="1">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="servico-descricao">Descrição Detalhada (ex: 4 Mãos e 2 Pés)</label>
                            <textarea id="servico-descricao" rows="2"></textarea>
                        </div>
                        <div class="flex-container">
                            <div>
                                <button type="submit" class="btn-success" id="btn-salvar-servico">
                                    <span class="material-icons">save</span> Salvar Serviço
                                </button>
                                <button type="button" class="btn-secondary" onclick="resetServicoForm()">
                                    <span class="material-icons">refresh</span> Limpar
                                </button>
                            </div>
                        </div>
                    </form>
                </div>

                <div class="section-header">
                    <h3>Lista de Serviços e Preços</h3>
                </div>
                <div class="card">
                    <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th style="width: 40%;">Serviço</th>
                                    <th style="width: 15%;">Tipo</th>
                                    <th style="width: 15%;">Total Proc.</th>
                                    <th style="width: 15%;">Preço</th>
                                    <th style="width: 150px;">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="lista-servicos">
                                <tr><td colspan="5" style="text-align: center;">Carregando serviços...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="historico-section" class="content-section">
                </div>

        </main>
    </div>

    <script src="https://unpkg.com/@emailjs/browser@4.3.3/dist/email.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
        import { getDatabase, ref, onValue, push, set, update, remove } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

        // =================================================================
        // 1.1. CONFIGURAÇÃO FIREBASE E VARIÁVEIS GLOBAIS
        // =================================================================
        
        // Sua configuração do Firebase (dados enviados por você)
        const firebaseConfig = {
            apiKey: "AIzaSyBatp6e1NzevurpB2yS8eGErgSYC_t2-Nc",
            authDomain: "tati-manicure.firebaseapp.com",
            databaseURL: "https://tati-manicure-default-rtdb.firebaseio.com",
            projectId: "tati-manicure",
            storageBucket: "tati-manicure.firebaseapp.com",
            messagingSenderId: "1061777323027",
            appId: "1:1061777323027:web:7b54e5fdbb7f06ee293be6",
            measurementId: "G-V3J5ZJ5XBT"
        };
        
        // Configuração do EmailJS
        let cacheConfig = {
            serviceId: "service_t1x9p9s", 
            templateId: "template_14t2a7l",
            userId: "v3D_p3PjF4KxG4p5v", 
        };

        // Inicialização do EmailJS
        emailjs.init(cacheConfig.userId);
        
        // Inicialização do Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Referências aos nós (listas/tabelas) do seu banco de dados
        const clientesRef = ref(db, 'clientes');
        const servicosRef = ref(db, 'servicos');
        const agendamentosRef = ref(db, 'agendamentos');
        const pacotesAtivosRef = ref(db, 'pacotes_ativos');
        const movimentacoesRef = ref(db, 'movimentacoes');
        
        const SENHA_UNICA = "tati123";

        // Caches de Dados
        let cacheClientes = {};
        let cacheServicos = {};
        let cachePacotes = {};
        let cacheMovimentacoes = {}; // Novo cache para as movimentações (para lookup em reverter)
        let agendamentosAtivos = [];
        let cacheAgendamentos = {}; // Cache de todos os agendamentos (para lookup em reverter)

        // =================================================================
        // 1. LÓGICA DE LOGIN, NAVEGAÇÃO E NOTIFICAÇÃO
        // =================================================================

        const loginContainer = document.getElementById('login-container');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const logoutButton = document.getElementById('logout-button');
        const navLinks = document.querySelectorAll('.sidebar ul li a');
        const contentSections = document.querySelectorAll('.content-section');
        const userInfoDisplay = document.getElementById('userInfo');
        const notificationBar = document.getElementById('notification-bar');
        const clientesDatalist = document.getElementById('clientes-datalist');
        
        const today = new Date().toISOString().slice(0, 10);

        function showApp(userName = 'Tati') {
            loginContainer.style.display = 'none';
            appContainer.style.display = 'flex';
            userInfoDisplay.textContent = `Olá, ${userName}!`;

            carregarClientes();
            carregarServicos();
            carregarConfig(); // Carrega config de email
            
            // Define o filtro de data da agenda como o dia atual e carrega
            document.getElementById('filtro-agenda-data').value = today;
            carregarAgendamentos();
            carregarPacotesAtivos();

            // V6: Define o filtro de hoje na Visão Diária e carrega
            document.getElementById('filtro-visao-diaria-data').value = today;
            renderizarVisaoDiaria(); 
            
            // Carrega a seção de histórico na primeira vez
            carregarHistorico(); 
        }

        function showLogin() {
            loginContainer.style.display = 'flex';
            appContainer.style.display = 'none';
        }

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const senha = document.getElementById('loginSenha').value;
            if (senha === SENHA_UNICA) {
                showApp();
                showNotification(`Acesso liberado! Bem-vinda.`, 'success');
            } else {
                showNotification('Senha incorreta.', 'error');
            }
            document.getElementById('loginSenha').value = '';
        });

        logoutButton.addEventListener('click', () => {
            showLogin();
            showNotification('Você saiu do sistema.', 'info');
        });

        // Navegação entre Telas
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetSectionId = e.currentTarget.getAttribute('data-section');

                // Recarrega as listas quando as abas são clicadas
                if (targetSectionId === 'clientes') { carregarClientes(); }
                if (targetSectionId === 'servicos') { carregarServicos(); }
                if (targetSectionId === 'historico') { 
                    carregarHistorico(); 
                }

                if (targetSectionId === 'agenda') { 
                    popularSelects(); 
                    if (!document.getElementById('filtro-agenda-data').value) {
                         document.getElementById('filtro-agenda-data').value = today;
                    }
                    carregarAgendamentos();
                    carregarPacotesAtivos();
                    
                    // V6: Reseta para o filtro de hoje na Visão Diária
                    document.getElementById('filtro-visao-diaria-data').value = today;
                    renderizarVisaoDiaria(); 
                    
                    // V6: Garante que o primeiro TAB seja o ativo
                    showAgendaTab('pacotes-ativos');
                }

                // Esconde todas as seções e mostra a alvo
                contentSections.forEach(section => section.classList.remove('active'));
                document.getElementById(`${targetSectionId}-section`).classList.add('active');

                // Atualiza a navegação
                navLinks.forEach(nav => nav.classList.remove('active'));
                e.currentTarget.classList.add('active');
            });
        });

        // Função de Notificação
        function showNotification(message, type = 'info') {
            notificationBar.textContent = message;
            notificationBar.className = `show ${type}`;
            setTimeout(() => {
                notificationBar.classList.remove('show');
            }, 3000);
        }

        // =================================================================
        // 2. UTILIDADES E FORMATAÇÕES
        // =================================================================
        
        function formatarData(dataISO) {
             if (!dataISO) return 'N/A';
             const [ano, mes, dia] = dataISO.split('-');
             return `${dia}/${mes}/${ano}`;
        }
        
        function formatarDataHora(dataISO, hora) {
            if (!dataISO) return 'N/A';
            const data = formatarData(dataISO);
            return hora ? `${data} às ${hora.slice(0, 5)}` : data;
        }

        // =================================================================
        // 3. CRUD - CLIENTES
        // =================================================================

        const clienteForm = document.getElementById('cliente-form');
        clienteForm.addEventListener('submit', function(e) {
            e.preventDefault();
            salvarCliente();
        });

        function resetClienteForm() {
            clienteForm.reset();
            document.getElementById('cliente-id').value = '';
            document.getElementById('btn-salvar-cliente').innerHTML = '<span class="material-icons">save</span> Salvar Cliente';
        }

        async function salvarCliente() {
            const id = document.getElementById('cliente-id').value;
            const nome = document.getElementById('cliente-nome').value.trim();
            const telefone = document.getElementById('cliente-telefone').value.trim();
            const email = document.getElementById('cliente-email').value.trim();
            const endereco = document.getElementById('cliente-endereco').value.trim();
            const observacoes = document.getElementById('cliente-observacoes').value.trim();

            const cliente = {
                nome: nome,
                telefone: telefone,
                email: email,
                endereco: endereco,
                observacoes: observacoes
            };

            const clienteRef = id ? ref(db, `clientes/${id}`) : push(clientesRef);

            try {
                await set(clienteRef, cliente);
                showNotification(`Cliente ${id ? 'atualizado' : 'salvo'} com sucesso!`, 'success');
                resetClienteForm();
            } catch (error) {
                console.error("Erro ao salvar cliente:", error);
                showNotification('Erro ao salvar cliente. Tente novamente.', 'error');
            }
        }

        function carregarClientes() {
            onValue(clientesRef, (snapshot) => {
                const clientes = snapshot.val() || {};
                cacheClientes = clientes;
                renderizarClientes(clientes);
                popularSelects(); // Recarrega os selects de cliente
            });
        }

        function renderizarClientes(clientes) {
            const listaClientes = document.getElementById('lista-clientes');
            listaClientes.innerHTML = '';
            const fragment = document.createDocumentFragment();

            Object.keys(clientes).forEach(id => {
                const cliente = clientes[id];
                const row = document.createElement('tr');
                row.dataset.id = id;
                row.innerHTML = `
                    <td data-label="Nome">${cliente.nome}</td>
                    <td data-label="Telefone">${cliente.telefone || 'N/A'}</td>
                    <td data-label="E-mail">${cliente.email || 'N/A'}</td>
                    <td class="action-buttons" data-label="Ações">
                        <button class="btn-warning" onclick="editarCliente('${id}')" title="Editar">
                            <span class="material-icons">edit</span>
                        </button>
                        <button class="btn-danger" onclick="removerCliente('${id}')" title="Remover">
                            <span class="material-icons">delete</span>
                        </button>
                    </td>
                `;
                fragment.appendChild(row);
            });
            
            if (Object.keys(clientes).length === 0) {
                 listaClientes.innerHTML = '<tr><td colspan="4" style="text-align: center;">Nenhum cliente cadastrado.</td></tr>';
            } else {
                 listaClientes.appendChild(fragment);
            }
        }

        window.editarCliente = function(id) {
            const cliente = cacheClientes[id];
            if (cliente) {
                document.getElementById('cliente-id').value = id;
                document.getElementById('cliente-nome').value = cliente.nome;
                document.getElementById('cliente-telefone').value = cliente.telefone;
                document.getElementById('cliente-email').value = cliente.email;
                document.getElementById('cliente-endereco').value = cliente.endereco;
                document.getElementById('cliente-observacoes').value = cliente.observacoes;
                document.getElementById('btn-salvar-cliente').innerHTML = '<span class="material-icons">update</span> Atualizar Cliente';
                showNotification(`Editando cliente: ${cliente.nome}`, 'info');
                
                // Leva a tela para o topo para ver o formulário
                document.getElementById('clientes-section').scrollTop = 0;
            }
        }

        window.removerCliente = function(id) {
            if (confirm("Tem certeza que deseja remover este cliente? Isso não removerá agendamentos ou histórico antigos.")) {
                const clienteRef = ref(db, `clientes/${id}`);
                remove(clienteRef)
                    .then(() => {
                        showNotification('Cliente removido com sucesso.', 'success');
                    })
                    .catch(error => {
                        console.error("Erro ao remover cliente:", error);
                        showNotification('Erro ao remover cliente. Tente novamente.', 'error');
                    });
            }
        }
        
        // 3.1. FILTRAR CLIENTES NA TABELA
        window.filtrarClientes = function() {
             const filtro = document.getElementById('filtro-clientes').value.toLowerCase();
             const listaClientes = document.getElementById('lista-clientes');
             const linhas = listaClientes.getElementsByTagName('tr');

             for (let i = 0; i < linhas.length; i++) {
                 const row = linhas[i];
                 if (!row.dataset.id) continue; // Pula a linha de "Nenhum cliente"

                 const nome = row.cells[0].textContent.toLowerCase();
                 const telefone = row.cells[1].textContent.toLowerCase();
                 const email = row.cells[2].textContent.toLowerCase();

                 if (nome.includes(filtro) || telefone.includes(filtro) || email.includes(filtro)) {
                     row.style.display = "";
                 } else {
                     row.style.display = "none";
                 }
             }
        }

        // =================================================================
        // 4. CRUD - SERVIÇOS E PACOTES (PRODUTOS)
        // =================================================================
        
        const servicoIsPacote = document.getElementById('servico-isPacote');
        const groupQuantidadeTotal = document.getElementById('group-quantidade-total');
        
        servicoIsPacote.addEventListener('change', () => {
             groupQuantidadeTotal.style.display = servicoIsPacote.checked ? 'block' : 'none';
        });

        const servicoForm = document.getElementById('servico-form');
        servicoForm.addEventListener('submit', function(e) {
            e.preventDefault();
            salvarServico();
        });

        function resetServicoForm() {
            servicoForm.reset();
            document.getElementById('servico-id').value = '';
            document.getElementById('servico-preco').value = '0.00';
            document.getElementById('servico-isPacote').checked = false;
            document.getElementById('servico-quantidade-total').value = '1';
            groupQuantidadeTotal.style.display = 'none';
            document.getElementById('btn-salvar-servico').innerHTML = '<span class="material-icons">save</span> Salvar Serviço';
        }

        async function salvarServico() {
            const id = document.getElementById('servico-id').value;
            const nome = document.getElementById('servico-nome').value.trim();
            const preco = parseFloat(document.getElementById('servico-preco').value) || 0;
            const isPacote = document.getElementById('servico-isPacote').checked;
            const quantidadeTotal = isPacote ? (parseInt(document.getElementById('servico-quantidade-total').value) || 1) : 0;
            const descricao = document.getElementById('servico-descricao').value.trim();


            if (isPacote && quantidadeTotal <= 0) {
                 showNotification('Pacotes devem ter no mínimo 1 procedimento.', 'error');
                 return;
            }

            const servico = {
                nome: nome,
                preco: preco.toFixed(2),
                isPacote: isPacote,
                quantidadeTotal: quantidadeTotal,
                descricao: descricao
            };

            const servicoRef = id ? ref(db, `servicos/${id}`) : push(servicosRef);

            try {
                await set(servicoRef, servico);
                showNotification(`Serviço/Pacote ${id ? 'atualizado' : 'salvo'} com sucesso!`, 'success');
                resetServicoForm();
            } catch (error) {
                console.error("Erro ao salvar serviço:", error);
                showNotification('Erro ao salvar serviço. Tente novamente.', 'error');
            }
        }

        function carregarServicos() {
            onValue(servicosRef, (snapshot) => {
                const servicos = snapshot.val() || {};
                cacheServicos = servicos;
                renderizarServicos(servicos);
                popularSelects(); // Recarrega selects que usam serviços
            });
        }

        function renderizarServicos(servicos) {
            const listaServicos = document.getElementById('lista-servicos');
            listaServicos.innerHTML = '';
            const fragment = document.createDocumentFragment();

            Object.keys(servicos).forEach(id => {
                const servico = servicos[id];
                const tipo = servico.isPacote ? `<span class="status-package-active">PACOTE</span>` : 'INDIVIDUAL';
                const totalProc = servico.isPacote ? servico.quantidadeTotal : 'N/A';
                const row = document.createElement('tr');
                row.dataset.id = id;
                row.innerHTML = `
                    <td data-label="Serviço">${servico.nome}</td>
                    <td data-label="Tipo">${tipo}</td>
                    <td data-label="Total Proc.">${totalProc}</td>
                    <td data-label="Preço">R$ ${parseFloat(servico.preco).toFixed(2).replace('.', ',')}</td>
                    <td class="action-buttons" data-label="Ações">
                        <button class="btn-warning" onclick="editarServico('${id}')" title="Editar">
                            <span class="material-icons">edit</span>
                        </button>
                        <button class="btn-danger" onclick="removerServico('${id}')" title="Remover">
                            <span class="material-icons">delete</span>
                        </button>
                    </td>
                `;
                fragment.appendChild(row);
            });

             if (Object.keys(servicos).length === 0) {
                 listaServicos.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nenhum serviço/pacote cadastrado.</td></tr>';
            } else {
                 listaServicos.appendChild(fragment);
            }
        }

        window.editarServico = function(id) {
            const servico = cacheServicos[id];
            if (servico) {
                document.getElementById('servico-id').value = id;
                document.getElementById('servico-nome').value = servico.nome;
                document.getElementById('servico-preco').value = parseFloat(servico.preco).toFixed(2);
                document.getElementById('servico-descricao').value = servico.descricao;
                
                const isPacote = servico.isPacote || false;
                document.getElementById('servico-isPacote').checked = isPacote;
                groupQuantidadeTotal.style.display = isPacote ? 'block' : 'none';
                document.getElementById('servico-quantidade-total').value = servico.quantidadeTotal || 1;
                
                document.getElementById('btn-salvar-servico').innerHTML = '<span class="material-icons">update</span> Atualizar Serviço';
                showNotification(`Editando serviço: ${servico.nome}`, 'info');
                
                // Leva a tela para o topo para ver o formulário
                document.getElementById('servicos-section').scrollTop = 0;
            }
        }

        window.removerServico = function(id) {
            if (confirm("Tem certeza que deseja remover este Serviço/Pacote?")) {
                const servicoRef = ref(db, `servicos/${id}`);
                remove(servicoRef)
                    .then(() => {
                        showNotification('Serviço/Pacote removido com sucesso.', 'success');
                    })
                    .catch(error => {
                        console.error("Erro ao remover serviço:", error);
                        showNotification('Erro ao remover serviço. Tente novamente.', 'error');
                    });
            }
        }

        // =================================================================
        // 5. CRU - PACOTES ATIVOS (MOVIMENTAÇÃO DE SESSÕES)
        // =================================================================
        
        const pacoteInicioForm = document.getElementById('pacote-inicio-form');
        pacoteInicioForm.addEventListener('submit', function(e) {
            e.preventDefault();
            iniciarPacote();
        });
        
        async function iniciarPacote() {
             const clienteId = document.getElementById('pacote-cliente-id').value;
             const servicoId = document.getElementById('pacote-servico-id').value;
             const dataInicio = document.getElementById('pacote-data-inicio').value;
             
             if (!clienteId || !servicoId || !dataInicio) {
                 showNotification('Selecione o cliente, o pacote e a data de início.', 'error');
                 return;
             }
             
             const cliente = cacheClientes[clienteId];
             const servico = cacheServicos[servicoId];
             
             if (!cliente || !servico || !servico.isPacote) {
                 showNotification('Dados inválidos. Verifique se o serviço é um pacote.', 'error');
                 return;
             }
             
             const quantidadeTotal = servico.quantidadeTotal;
             
             const pacoteAtivo = {
                 clienteId: clienteId,
                 clienteNome: cliente.nome,
                 servicoId: servicoId,
                 servicoNome: servico.nome,
                 quantidade_total: quantidadeTotal,
                 sessoes_restantes: quantidadeTotal, // Inicia com o total de sessões
                 preco_total: parseFloat(servico.preco),
                 data_inicio: dataInicio,
                 data_vencimento: getVencimentoPacote(dataInicio),
                 status: 'ativo', // Outros status: 'pendente', 'finalizado', 'cancelado'
                 dataCriacao: new Date().toISOString()
             };
             
             const pacoteRef = push(pacotesAtivosRef);
             
             try {
                 await set(pacoteRef, pacoteAtivo);
                 showNotification(`Pacote **${servico.nome}** iniciado para ${cliente.nome} com ${quantidadeTotal} sessões.`, 'success');
                 pacoteInicioForm.reset();
                 carregarPacotesAtivos();
             } catch (error) {
                 console.error("Erro ao iniciar pacote:", error);
                 showNotification('Erro ao iniciar pacote. Tente novamente.', 'error');
             }
        }
        
        function getVencimentoPacote(dataInicio) {
             const data = new Date(dataInicio);
             // Adiciona 1 mês
             data.setMonth(data.getMonth() + 1);
             // Para garantir que a data não avance um mês extra se for dia 31 (ex: jan 31 + 1 mês = mar 3)
             if (data.getDate() !== new Date(dataInicio).getDate()) {
                 data.setDate(0); // Volta para o último dia do mês anterior (fevereiro, nesse caso)
             }
             return data.toISOString().slice(0, 10);
        }
        
        function carregarPacotesAtivos() {
            onValue(pacotesAtivosRef, (snapshot) => {
                const pacotes = snapshot.val() || {};
                cachePacotes = pacotes;
                renderizarPacotesAtivos(pacotes);
                popularServicosAgendamento(); // Atualiza a lista de pacotes no agendamento, se estiver ativo
            });
        }
        
        function renderizarPacotesAtivos(pacotes) {
             const listaPacotes = document.getElementById('lista-pacotes-ativos');
             listaPacotes.innerHTML = '';
             const fragment = document.createDocumentFragment();
             
             // Filtra e ordena pacotes: ativos primeiro, depois por nome do cliente
             const pacotesOrdenados = Object.keys(pacotes).map(id => ({ id, ...pacotes[id] })).sort((a, b) => {
                 // Ativos vêm antes de finalizados
                 if (a.status === 'ativo' && b.status !== 'ativo') return -1;
                 if (a.status !== 'ativo' && b.status === 'ativo') return 1;
                 // Depois, ordena por nome do cliente
                 return a.clienteNome.localeCompare(b.clienteNome);
             });
             
             pacotesOrdenados.forEach(pacote => {
                 const statusClass = {
                      'ativo': 'status-package-active',
                      'finalizado': 'status-package-finalized',
                      'pendente': 'status-package-pending',
                      'pago': 'status-package-paid'
                 }[pacote.status] || 'status-package-pending';
                 
                 const row = document.createElement('tr');
                 row.dataset.id = pacote.id;
                 row.innerHTML = `
                      <td data-label="Cliente">${pacote.clienteNome}</td>
                      <td data-label="Pacote">${pacote.servicoNome} (${pacote.sessoes_restantes}/${pacote.quantidade_total})</td>
                      <td data-label="Pagamento">R$ ${pacote.preco_total.toFixed(2).replace('.', ',')} (${pacote.status.toUpperCase()})</td>
                      <td data-label="Vencimento">${formatarData(pacote.data_vencimento)}</td>
                      <td class="action-buttons" data-label="Ações">
                           <button class="btn-primary" onclick="visualizarPacote('${pacote.id}')" title="Ver Detalhes">
                               <span class="material-icons">visibility</span>
                           </button>
                           </td>
                 `;
                 fragment.appendChild(row);
             });
             
             if (pacotesOrdenados.length === 0) {
                 listaPacotes.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nenhum pacote ativo/registrado.</td></tr>';
            } else {
                 listaPacotes.appendChild(fragment);
            }
        }
        
        window.visualizarPacote = function(id) {
            const pacote = cachePacotes[id];
            if (!pacote) {
                 showNotification('Pacote não encontrado.', 'error');
                 return;
            }
            
            const detalhes = `
                 **Cliente:** ${pacote.clienteNome}
                 **Pacote:** ${pacote.servicoNome}
                 **Preço Total:** R$ ${pacote.preco_total.toFixed(2).replace('.', ',')}
                 **Sessões:** ${pacote.sessoes_restantes} restantes de ${pacote.quantidade_total}
                 **Status:** ${pacote.status.toUpperCase()}
                 **Início:** ${formatarData(pacote.data_inicio)}
                 **Vencimento:** ${formatarData(pacote.data_vencimento)}
            `;
            
            alert(`Detalhes do Pacote:\n\n${detalhes}`);
        }
        
        window.removerPacote = function(id) {
             if (confirm("ATENÇÃO: Deseja realmente DELETAR este pacote ativo? Isso não reverte o uso de sessões em agendamentos.")) {
                 const pacoteRef = ref(db, `pacotes_ativos/${id}`);
                 remove(pacoteRef)
                    .then(() => {
                        showNotification('Pacote ativo deletado com sucesso.', 'success');
                    })
                    .catch(error => {
                        console.error("Erro ao remover pacote:", error);
                        showNotification('Erro ao remover pacote. Tente novamente.', 'error');
                    });
             }
        }
        
        // =================================================================
        // 6. CRU - AGENDAMENTOS (AGENDA)
        // =================================================================
        
        // Função utilitária para alternar abas da agenda
        window.showAgendaTab = function(tabName) {
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });

            document.getElementById(`${tabName}-pane`).classList.add('active');
            document.querySelector(`.tab-button[onclick*='${tabName}']`).classList.add('active');
            
            // Força o carregamento da lista de agendamentos ou pacotes quando a aba é ativada
            if (tabName === 'lista-agendamentos') {
                 carregarAgendamentos();
            } else if (tabName === 'pacotes-ativos') {
                 carregarPacotesAtivos();
            } else if (tabName === 'visao-diaria') {
                 renderizarVisaoDiaria();
            }
        }
        
        // Preenche selects de Cliente e Pacotes/Serviços
        function popularSelects() {
             const clientes = cacheClientes;
             const servicos = cacheServicos;
             
             // 1. Selects de Cliente
             const clienteSelects = [
                 document.getElementById('agenda-cliente-id'),
                 document.getElementById('pacote-cliente-id')
             ];
             
             // 2. Select de Pacote (apenas serviços marcados como pacote)
             const pacoteServicoSelect = document.getElementById('pacote-servico-id');
             
             clientesDatalist.innerHTML = '';
             clienteSelects.forEach(select => select.innerHTML = '<option value="">-- Selecione o Cliente --</option>');
             pacoteServicoSelect.innerHTML = '<option value="">-- Selecione o Pacote --</option>';

             // Populando Clientes e Datalist
             Object.keys(clientes).forEach(id => {
                 const cliente = clientes[id];
                 
                 // Selects
                 clienteSelects.forEach(select => {
                     const option = document.createElement('option');
                     option.value = id;
                     option.textContent = cliente.nome;
                     select.appendChild(option);
                 });
                 
                 // Datalist (para filtros)
                 const datalistOption = document.createElement('option');
                 datalistOption.value = cliente.nome;
                 clientesDatalist.appendChild(datalistOption);
             });
             
             // Populando Select de Pacotes (Apenas serviços `isPacote: true`)
             Object.keys(servicos).forEach(id => {
                 const servico = servicos[id];
                 if (servico.isPacote) {
                      const option = document.createElement('option');
                      option.value = id;
                      option.textContent = `${servico.nome} (${servico.quantidadeTotal} Proc. - R$ ${parseFloat(servico.preco).toFixed(2).replace('.', ',')})`;
                      pacoteServicoSelect.appendChild(option);
                 }
             });
             
             // V6: Chama a função que popula o select de serviço/pacote do agendamento
             popularServicosAgendamento(); 
        }
        
        // NEW FUNCTION V6 - Popular serviços/pacotes dinamicamente no agendamento
        window.popularServicosAgendamento = function() {
            const tipo = document.getElementById('agenda-tipo-movimentacao')?.value;
            const selectServico = document.getElementById('agenda-servico-id');
            const selectClienteId = document.getElementById('agenda-cliente-id')?.value;
            const labelServico = document.getElementById('label-agenda-servico-id');

            if (!selectServico || !labelServico) return;
            
            selectServico.innerHTML = '<option value="">-- Selecione --</option>';

            if (tipo === 'servico') {
                labelServico.textContent = 'Serviço/Promoção (Individual)';
                // Popula com serviços individuais (isPacote: false)
                Object.keys(cacheServicos).forEach(id => {
                    const servico = cacheServicos[id];
                    if (!servico.isPacote) {
                        const option = document.createElement('option');
                        option.value = id;
                        option.textContent = `${servico.nome} (R$ ${parseFloat(servico.preco).toFixed(2).replace('.', ',')})`;
                        selectServico.appendChild(option);
                    }
                });
            } else if (tipo === 'pacote') {
                labelServico.textContent = 'Pacote Ativo (Sessões Restantes)';
                
                if (!selectClienteId) {
                     showNotification('Selecione um cliente primeiro para ver os pacotes ativos.', 'info');
                     return;
                }

                // Popula com pacotes ativos do cliente selecionado que têm sessões restantes
                const pacotesDoCliente = Object.values(cachePacotes).filter(p => 
                    p.clienteId === selectClienteId && p.sessoes_restantes > 0 && p.status === 'ativo'
                );
                
                if (pacotesDoCliente.length === 0) {
                     showNotification('Nenhum pacote ativo com sessões restantes para este cliente.', 'error');
                }

                pacotesDoCliente.forEach(pacote => {
                    const servicoNome = cacheServicos[pacote.servicoId]?.nome || 'Serviço Desconhecido';
                    const option = document.createElement('option');
                    option.value = pacote.id; // Neste caso, o ID do pacote ativo (pacote_ativo_id)
                    option.textContent = `${servicoNome} (Restam: ${pacote.sessoes_restantes}/${pacote.quantidade_total})`;
                    selectServico.appendChild(option);
                });

            } else {
                labelServico.textContent = 'Serviço (Individual) / Pacote (Ativo)';
            }
        }
        
        // Listener para o select de cliente (agenda) para atualizar pacotes ativos
        document.getElementById('agenda-cliente-id')?.addEventListener('change', popularServicosAgendamento);

        const agendamentoForm = document.getElementById('agendamento-form');
        agendamentoForm?.addEventListener('submit', function(e) {
            e.preventDefault();
            agendarServico();
        });

        function resetAgendamentoForm() {
            agendamentoForm.reset();
            document.getElementById('agendamento-id').value = '';
            document.getElementById('btn-salvar-agendamento').innerHTML = '<span class="material-icons">save</span> Salvar Agendamento';
            document.getElementById('filtro-agenda-data').value = today; // Volta para o dia atual no filtro

            // Reseta a lista de serviços para mostrar o que era antes
            popularServicosAgendamento(); 
            
            showAgendaTab('lista-agendamentos'); // Volta para a lista
        }

        window.editarAgendamento = function(id) {
            const agendamento = agendamentosAtivos.find(a => a.id === id);
            if (agendamento) {
                // Alterna para a aba de Novo Agendamento para editar
                showAgendaTab('novo-agendamento');
                
                document.getElementById('agendamento-id').value = id;
                document.getElementById('agenda-cliente-id').value = agendamento.clienteId;
                document.getElementById('agenda-data').value = agendamento.data;
                document.getElementById('agenda-hora').value = agendamento.hora;
                document.getElementById('agenda-hora-fim').value = agendamento.horaFim;
                document.getElementById('agenda-observacoes').value = agendamento.observacoes;
                
                // NOVO V6: Define o tipo de movimentação e popula o select de serviço
                const tipoMovimentacao = agendamento.tipo_movimentacao || 'servico';
                document.getElementById('agenda-tipo-movimentacao').value = tipoMovimentacao;
                popularServicosAgendamento(); // Popula com pacotes/serviços
                
                // O valor a ser selecionado é o ID do serviço (se for individual) ou o ID do pacote ativo
                const selectValue = tipoMovimentacao === 'pacote' ? agendamento.pacote_ativo_id : agendamento.servicoId;
                document.getElementById('agenda-servico-id').value = selectValue;
                
                document.getElementById('btn-salvar-agendamento').innerHTML = '<span class="material-icons">update</span> Atualizar Agendamento';
                showNotification(`Editando agendamento para: ${agendamento.clienteNome}`, 'info');
                
                // Leva a tela para o topo para ver o formulário
                document.getElementById('agenda-section').scrollTop = 0;
            }
        }

        async function agendarServico() {
            const id = document.getElementById('agendamento-id').value;
            const clienteId = document.getElementById('agenda-cliente-id').value;
            const servicoID_or_PacoteID = document.getElementById('agenda-servico-id').value;
            const data = document.getElementById('agenda-data').value;
            const hora = document.getElementById('agenda-hora').value;
            const horaFim = document.getElementById('agenda-hora-fim').value;
            const observacoes = document.getElementById('agenda-observacoes').value;
            
            // NOVO V6: Tipo de Movimentação (Servico ou Pacote)
            const tipoMovimentacao = document.getElementById('agenda-tipo-movimentacao').value;

            if (!clienteId || !servicoID_or_PacoteID || !data || !hora || !horaFim || !tipoMovimentacao) {
                showNotification('Preencha todos os campos obrigatórios, incluindo o Tipo de Movimentação.', 'error');
                return;
            }

            let servicoNome, servicoPreco, pacoteAtivoId = null, servicoIdFinal = null;

            if (tipoMovimentacao === 'servico') {
                const servico = cacheServicos[servicoID_or_PacoteID];
                if (!servico) {
                    showNotification('Serviço individual não encontrado.', 'error');
                    return;
                }
                servicoNome = servico.nome;
                servicoPreco = servico.preco; // Preço normal
                servicoIdFinal = servicoID_or_PacoteID;
            } else if (tipoMovimentacao === 'pacote') {
                const pacoteAtivo = cachePacotes[servicoID_or_PacoteID];
                
                // Se for edição, precisamos ignorar a validação de sessões restantes SE o pacote já foi usado para este agendamento.
                const isEditing = !!id;
                let isAlreadyUsed = false;
                if (isEditing) {
                     const oldAgendamento = agendamentosAtivos.find(a => a.id === id);
                     if (oldAgendamento && oldAgendamento.pacote_ativo_id === servicoID_or_PacoteID) {
                          isAlreadyUsed = true; // Pacote é o mesmo, não precisa decrementar
                     }
                }

                if (!pacoteAtivo || (pacoteAtivo.sessoes_restantes <= 0 && !isAlreadyUsed) || pacoteAtivo.status !== 'ativo') {
                     showNotification('Pacote ativo inválido, esgotado ou inativo. (Restantes: ' + pacoteAtivo.sessoes_restantes + ')', 'error');
                     return;
                }
                
                // O ID do serviço no agendamento será o ID do serviço PAI do pacote
                const servicoPacote = cacheServicos[pacoteAtivo.servicoId];
                servicoNome = `${servicoPacote?.nome || 'Pacote Desconhecido'} (Uso de Sessão)`;
                servicoPreco = 0.00; // PREÇO ZERO pois já foi pago
                pacoteAtivoId = servicoID_or_PacoteID; // Armazena o ID do pacote_ativo para decremento e reversão
                servicoIdFinal = servicoPacote.id;

                // Se estiver editando, e o pacote foi alterado, o pacote original deve ser revertido e o novo decrementado.
                // Isso se torna complexo, então para a V6 vamos simplificar:
                // Se estiver editando, e for PACOTE, o preço é 0,00 e o ID do pacote é salvo. 
                // A reversão deve ser feita na função de status, e o decremento aqui.
                // Se for pacote, faremos a reversão do pacote antigo e o decremento do novo (se for diferente)
                if (isEditing) {
                     await reverterPacoteEmEdicao(id, pacoteAtivoId);
                }
            } else {
                showNotification('Tipo de movimentação inválido.', 'error');
                return;
            }


            const cliente = cacheClientes[clienteId];
            if (!cliente) {
                showNotification('Cliente não encontrado.', 'error');
                return;
            }
            
            // Lógica para decremento do pacote
            let pacoteUpdatePromise = Promise.resolve();
            if (tipoMovimentacao === 'pacote' && pacoteAtivoId) {
                 // Decrementa o contador de sessões restantes do pacote ativo
                 const novoPacoteRef = ref(db, `pacotes_ativos/${pacoteAtivoId}`);
                 const novoPacote = cachePacotes[pacoteAtivoId];
                 const novasSessoes = novoPacote.sessoes_restantes - 1;
                 
                 if (novasSessoes < 0) {
                     showNotification('Erro: Tentativa de agendar mais sessões do que o permitido no pacote.', 'error');
                     return;
                 }

                 // Verifica se o pacote vai finalizar
                 let statusUpdate = {};
                 if (novasSessoes === 0) {
                      statusUpdate.status = 'finalizado';
                 }

                 // Cria a promessa de atualização
                 pacoteUpdatePromise = update(novoPacoteRef, {
                     sessoes_restantes: novasSessoes,
                     ...statusUpdate
                 }).then(() => {
                     // Atualiza o cache (importante para evitar re-uso imediato)
                     cachePacotes[pacoteAtivoId].sessoes_restantes = novasSessoes;
                     if (statusUpdate.status) {
                         cachePacotes[pacoteAtivoId].status = 'finalizado';
                     }
                 });
            }

            const agendamento = {
                clienteId: clienteId,
                clienteNome: cliente.nome,
                clienteTelefone: cliente.telefone,
                servicoId: servicoIdFinal, // Guarda o servicoId do serviço individual ou do serviço PAI do pacote
                servicoNome: servicoNome,
                servicoPreco: parseFloat(servicoPreco),
                data: data,
                hora: hora,
                horaFim: horaFim,
                status: 'Agendado',
                observacoes: observacoes,
                dataCriacao: new Date().toISOString(),
                // NOVO V6: Campos para controle de Pacote
                tipo_movimentacao: tipoMovimentacao,
                pacote_ativo_id: pacoteAtivoId // null se for serviço individual
            };
            
            // Promessa para salvar o agendamento
            const agendamentoRef = id ? ref(db, `agendamentos/${id}`) : push(agendamentosRef);
            const savePromise = set(agendamentoRef, agendamento);
            const agendamentoID = id || agendamentoRef.key;

            // Promessa para salvar a movimentação (sempre salva, mesmo que o preço seja 0.00, para histórico)
            const movimentacao = {
                data: data,
                clienteNome: agendamento.clienteNome,
                servicoNome: agendamento.servicoNome,
                valor: agendamento.servicoPreco,
                tipo: 'Agendamento',
                status: 'Agendado',
                agendamentoId: agendamentoID,
                // NOVO V6: Campos para controle de Pacote na movimentação também
                tipo_movimentacao: tipoMovimentacao,
                pacote_ativo_id: pacoteAtivoId 
            };
            
            // Se for edição, encontra a movimentação existente para o agendamento
            let movimentacaoId = null;
            if (id) {
                 // Lógica para encontrar movimentacaoId (assumindo que movimentacao.agendamentoId é o link)
                 movimentacaoId = Object.keys(cacheMovimentacoes).find(key => cacheMovimentacoes[key].agendamentoId === id);
            }

            const movimentacaoRef = movimentacaoId ? ref(db, `movimentacoes/${movimentacaoId}`) : push(movimentacoesRef);
            const saveMovimentacaoPromise = set(movimentacaoRef, movimentacao);


            // Executa as promessas em paralelo/sequência
            Promise.all([pacoteUpdatePromise, savePromise, saveMovimentacaoPromise])
                .then(() => {
                    showNotification(`Agendamento ${id ? 'editado' : 'salvo'} com sucesso!`, 'success');
                    resetAgendamentoForm();
                    carregarAgendamentos(); // Recarrega a lista de agendamentos
                    carregarHistorico(); // Recarrega a lista de movimentações
                    carregarPacotesAtivos(); // Recarrega a lista de pacotes
                    
                    // Lógica de envio de email
                    enviarEmailConfirmacao(agendamento);

                })
                .catch(error => {
                    console.error('Erro ao salvar agendamento ou pacote:', error);
                    showNotification('Erro ao salvar agendamento. Tente novamente.', 'error');
                     // TODO: Se der erro no agendamento, pode ser necessário reverter o decremento do pacote
                });
        }
        
        async function reverterPacoteEmEdicao(agendamentoId, novoPacoteAtivoId) {
             const agendamentoAntigo = cacheAgendamentos[agendamentoId];
             
             if (agendamentoAntigo && agendamentoAntigo.tipo_movimentacao === 'pacote' && agendamentoAntigo.pacote_ativo_id) {
                 const pacoteAntigoId = agendamentoAntigo.pacote_ativo_id;
                 
                 // Reverte o pacote antigo se ele for diferente do novo ou se o novo for serviço individual
                 if (pacoteAntigoId !== novoPacoteAtivoId) {
                     const pacoteRef = ref(db, `pacotes_ativos/${pacoteAntigoId}`);
                     const pacote = cachePacotes[pacoteAntigoId];
                     
                     if (pacote) {
                         const novasSessoes = pacote.sessoes_restantes + 1;
                         let statusUpdate = { status: 'ativo' };
                         
                         await update(pacoteRef, {
                             sessoes_restantes: novasSessoes,
                             ...statusUpdate
                         }).then(() => {
                             pacote.sessoes_restantes = novasSessoes;
                             pacote.status = 'ativo';
                             console.log(`Sessão de pacote antigo ${pacoteAntigoId} revertida com sucesso durante edição.`);
                         }).catch(error => {
                              console.error('Erro ao reverter sessão de pacote antigo durante edição:', error);
                              showNotification('Erro ao reverter sessão de pacote antigo. Verifique manualmente.', 'error');
                         });
                     }
                 }
             }
        }

        function carregarAgendamentos() {
            const filtroData = document.getElementById('filtro-agenda-data').value;
            
            onValue(agendamentosRef, (snapshot) => {
                const agendamentos = snapshot.val() || {};
                cacheAgendamentos = agendamentos; // Cache completo para lookup
                
                // Filtra para manter apenas os agendamentos ativos/agendados e pela data
                agendamentosAtivos = Object.keys(agendamentos)
                    .map(id => ({ id, ...agendamentos[id] }))
                    .filter(a => a.status === 'Agendado' || a.status === 'Confirmado')
                    .filter(a => !filtroData || a.data === filtroData)
                    .sort((a, b) => {
                         if (a.data !== b.data) return a.data.localeCompare(b.data);
                         return a.hora.localeCompare(b.hora);
                    });
                
                renderizarAgendamentos(agendamentosAtivos);
                renderizarVisaoDiaria(); // Atualiza a visão diária se estiver no dia do filtro
            });
        }

        function renderizarAgendamentos(agendamentos) {
            const listaAgendamentos = document.getElementById('lista-agendamentos');
            listaAgendamentos.innerHTML = '';
            const fragment = document.createDocumentFragment();

            agendamentos.forEach(agendamento => {
                const isPackage = agendamento.tipo_movimentacao === 'pacote';
                const servicoDisplay = isPackage ? 
                    `${agendamento.servicoNome} <span class="status-package-active">(USO PACOTE)</span>` : 
                    `${agendamento.servicoNome} (R$ ${agendamento.servicoPreco.toFixed(2).replace('.', ',')})`;
                    
                const row = document.createElement('tr');
                row.dataset.clienteNome = agendamento.clienteNome.toLowerCase();
                row.dataset.id = agendamento.id;
                row.innerHTML = `
                    <td data-label="Data/Hora">${formatarDataHora(agendamento.data, agendamento.hora)}</td>
                    <td data-label="Cliente">${agendamento.clienteNome}</td>
                    <td data-label="Serviço">${servicoDisplay}</td>
                    <td data-label="Status">
                         <span style="font-weight: bold; color: ${agendamento.status === 'Confirmado' ? 'var(--success-color)' : 'var(--primary-color)'};">${agendamento.status}</span>
                    </td>
                    <td class="action-buttons" data-label="Ações">
                        <button class="btn-success" onclick="mudarStatusAgendamento('${agendamento.id}', 'Concluído')" title="Concluído">
                            <span class="material-icons">check_circle</span>
                        </button>
                        <button class="btn-warning" onclick="editarAgendamento('${agendamento.id}')" title="Editar">
                            <span class="material-icons">edit</span>
                        </button>
                         <button class="btn-secondary" onclick="mudarStatusAgendamento('${agendamento.id}', 'Cancelado')" title="Cancelar">
                            <span class="material-icons">cancel</span>
                        </button>
                    </td>
                `;
                fragment.appendChild(row);
            });
            
             if (agendamentos.length === 0) {
                 listaAgendamentos.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nenhum agendamento ativo/na data selecionada.</td></tr>';
            } else {
                 listaAgendamentos.appendChild(fragment);
            }
        }

        window.mudarStatusAgendamento = function(id, status) {
            const agendamentoRef = ref(db, `agendamentos/${id}`);
            const agendamento = agendamentosAtivos.find(a => a.id === id);
            
            if (!agendamento) {
                 showNotification('Agendamento não encontrado.', 'error');
                 return;
            }

            // Confirmação para Status Críticos
            if (status === 'Cancelado' && !confirm(`Tem certeza que deseja CANCELAR o agendamento de ${agendamento.clienteNome}?`)) {
                 return;
            }
            if (status === 'Concluído' && !confirm(`Confirmar CONCLUSÃO e registrar a movimentação financeira para ${agendamento.clienteNome}?`)) {
                 return;
            }
            

            // 1. Atualiza o status do Agendamento
            update(agendamentoRef, { status: status })
                .then(() => {
                    showNotification(`Status de agendamento alterado para: ${status}`, 'success');
                    carregarAgendamentos(); 
                    
                    // 2. Atualiza a Movimentação
                    const movimentacaoId = Object.keys(cacheMovimentacoes).find(key => cacheMovimentacoes[key].agendamentoId === id);
                    if (movimentacaoId) {
                         const movimentacaoRef = ref(db, `movimentacoes/${movimentacaoId}`);
                         update(movimentacaoRef, { 
                             status: status,
                             // Se for concluído, registra o valor na movimentação para histórico de lucros
                             tipo: status === 'Concluído' ? 'Concluído' : 'Agendamento'
                         }).then(() => {
                             carregarHistorico(); // Recarrega a lista de movimentações
                         });
                    }
                    
                    // 3. NOVO V6: Lógica para reverter o uso de pacote
                    if ((status === 'Cancelado' || status === 'Deletado') && agendamento.tipo_movimentacao === 'pacote' && agendamento.pacote_ativo_id) {
                         const pacoteId = agendamento.pacote_ativo_id;
                         const pacoteRef = ref(db, `pacotes_ativos/${pacoteId}`);
                         const pacote = cachePacotes[pacoteId];
                         
                         if (pacote) {
                             const novasSessoes = pacote.sessoes_restantes + 1;
                             let statusUpdate = { status: 'ativo' }; // Reativa se estiver finalizado
                             
                             // Atualiza o banco de dados
                             update(pacoteRef, {
                                 sessoes_restantes: novasSessoes,
                                 ...statusUpdate
                             }).then(() => {
                                 // Atualiza o cache
                                 pacote.sessoes_restantes = novasSessoes;
                                 pacote.status = 'ativo';
                                 console.log(`Sessão de pacote ${pacoteId} revertida com sucesso.`);
                                 showNotification(`Status alterado para ${status}. Sessão de pacote revertida.`, 'success');
                                 carregarPacotesAtivos(); // Recarrega a lista
                             }).catch(error => {
                                 console.error('Erro ao reverter sessão de pacote:', error);
                                 showNotification('Erro ao reverter sessão de pacote. Verifique manualmente.', 'error');
                             });
                         }
                    }
                })
                .catch(error => {
                    console.error("Erro ao alterar status:", error);
                    showNotification('Erro ao alterar status. Tente novamente.', 'error');
                });
        }
        
        window.filtrarAgendamentos = function() {
             const filtroNome = document.getElementById('filtro-agenda-cliente').value.toLowerCase();
             const listaAgendamentos = document.getElementById('lista-agendamentos');
             const linhas = listaAgendamentos.getElementsByTagName('tr');

             for (let i = 0; i < linhas.length; i++) {
                 const row = linhas[i];
                 if (!row.dataset.clienteNome) continue; 

                 const clienteNome = row.dataset.clienteNome;
                
                 if (clienteNome.includes(filtroNome)) {
                     row.style.display = "";
                 } else {
                     row.style.display = "none";
                 }
             }
        }
        
        window.resetFiltroAgenda = function() {
            document.getElementById('filtro-agenda-data').value = today;
            document.getElementById('filtro-agenda-cliente').value = '';
            carregarAgendamentos();
        }

        // =================================================================
        // 7. VISÃO DIÁRIA DA AGENDA (NOVO V6)
        // =================================================================
        
        window.renderizarVisaoDiaria = function(data = null) {
            const listaVisaoDiaria = document.getElementById('lista-visao-diaria');
            const dataFiltro = data || document.getElementById('filtro-visao-diaria-data').value;
            listaVisaoDiaria.innerHTML = '';
            
            if (!dataFiltro) {
                 listaVisaoDiaria.innerHTML = '<tr><td colspan="2" style="text-align: center;">Selecione uma data para visualizar.</td></tr>';
                 return;
            }
            
            // Filtra agendamentos para a data selecionada
            const agendamentosDoDia = agendamentosAtivos.filter(a => a.data === dataFiltro);
            
            const horarios = [];
            // Gera horários de 8:00 às 20:00, de 30 em 30 minutos
            for (let h = 8; h <= 20; h++) {
                 horarios.push(`${h.toString().padStart(2, '0')}:00`);
                 if (h < 20) {
                      horarios.push(`${h.toString().padStart(2, '0')}:30`);
                 }
            }
            
            const fragment = document.createDocumentFragment();
            
            horarios.forEach(horario => {
                 const row = document.createElement('tr');
                 row.innerHTML = `<td class="horario-celula">${horario}</td>`;
                 
                 // Verifica se há agendamento que comece *ou* esteja em andamento neste horário
                 const agendamentoNoHorario = agendamentosDoDia.find(a => {
                      return (a.hora <= horario && a.horaFim > horario) || (a.hora === horario);
                 });
                 
                 let detalhesCell = document.createElement('td');
                 
                 if (agendamentoNoHorario) {
                      detalhesCell.classList.add('agendamento-ocupado');
                      detalhesCell.dataset.id = agendamentoNoHorario.id; // Para editar/visualizar
                      detalhesCell.onclick = () => editarAgendamento(agendamentoNoHorario.id);
                      
                      const isPackage = agendamentoNoHorario.tipo_movimentacao === 'pacote';
                      const precoDisplay = isPackage ? 'USO PACOTE' : `R$ ${agendamentoNoHorario.servicoPreco.toFixed(2).replace('.', ',')}`;
                      
                      detalhesCell.innerHTML = `
                           <strong>${agendamentoNoHorario.clienteNome}</strong> - ${agendamentoNoHorario.servicoNome}
                           <br>
                           <small>Das ${agendamentoNoHorario.hora.slice(0, 5)} às ${agendamentoNoHorario.horaFim.slice(0, 5)} | ${precoDisplay}</small>
                      `;
                 } else {
                      detalhesCell.classList.add('agendamento-vago');
                      detalhesCell.textContent = 'Vago';
                 }
                 
                 row.appendChild(detalhesCell);
                 fragment.appendChild(row);
            });
            
            listaVisaoDiaria.appendChild(fragment);
        }

        // =================================================================
        // 8. HISTÓRICO E LUCROS (MOVIMENTAÇÕES)
        // =================================================================

        function carregarHistorico() {
            onValue(movimentacoesRef, (snapshot) => {
                const movimentacoes = snapshot.val() || {};
                cacheMovimentacoes = movimentacoes;
                renderizarHistorico();
            });
        }
        
        window.renderizarHistorico = function() {
            const historicoSection = document.getElementById('historico-section');
            const movimentacoesArray = Object.keys(cacheMovimentacoes).map(id => ({ id, ...cacheMovimentacoes[id] }));
            
            let html = `
                <div class="section-header"><h2>Histórico e Lucros de Agendamentos Concluídos</h2></div>
                <div class="card">
                     <div class="filter-row">
                        <div style="flex-grow: 1.5;">
                            <label for="filtro-historico-mes">Filtrar por Mês/Ano</label>
                            <input type="month" id="filtro-historico-mes" onchange="renderizarHistorico()">
                        </div>
                        <div style="flex-grow: 3;">
                            <label for="filtro-historico-cliente">Filtrar por Cliente (Digite ou Selecione)</label>
                            <input type="text" id="filtro-historico-cliente" list="clientes-datalist" placeholder="Digite o nome do cliente..." onkeyup="filtrarHistoricoTabela()">
                        </div>
                        <button class="btn-secondary" onclick="resetFiltroHistorico()"><span class="material-icons">refresh</span> Resetar Filtro</button>
                    </div>
                    <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th style="width: 15%;">Data/Hora</th>
                                    <th style="width: 25%;">Cliente</th>
                                    <th style="width: 30%;">Serviço/Descrição</th>
                                    <th style="width: 15%;">Valor</th>
                                    <th style="width: 150px;">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="lista-historico">
            `;
            
            let totalLucro = 0;
            const filtroMes = document.getElementById('filtro-historico-mes')?.value;

            const movimentacoesFiltradas = movimentacoesArray.filter(mov => {
                if (mov.status !== 'Concluído') return false;
                if (filtroMes && !mov.data.startsWith(filtroMes)) return false;
                return true;
            }).sort((a, b) => b.data.localeCompare(a.data) || b.hora.localeCompare(a.hora || ''));
            
            if (movimentacoesFiltradas.length === 0) {
                 html += '<tr><td colspan="5" style="text-align: center;">Nenhuma movimentação concluída no filtro.</td></tr>';
            } else {
                movimentacoesFiltradas.forEach(mov => {
                     totalLucro += mov.valor;
                     
                     // NOVO V6: Formatação para uso de pacote
                     const tipo = mov.tipo_movimentacao === 'pacote' ? 
                         `<span style="color: var(--primary-color); font-weight: bold;">(Uso Pacote)</span>` :
                         '';
                     const valor = mov.valor == 0.00 && mov.tipo_movimentacao === 'pacote' ?
                         '<span class="status-package-active">R$ 0,00</span>' :
                         `R$ ${parseFloat(mov.valor).toFixed(2).replace('.', ',')}`;

                     
                     html += `
                         <tr data-agendamento-id="${mov.agendamentoId}" data-cliente-nome="${mov.clienteNome.toLowerCase()}">
                             <td data-label="Data/Hora">${formatarDataHora(mov.data, mov.hora || '')}</td>
                             <td data-label="Cliente">${mov.clienteNome}</td>
                             <td data-label="Serviço/Descrição">${mov.servicoNome} ${tipo}</td>
                             <td data-label="Valor">${valor}</td>
                             <td class="action-buttons" data-label="Ações">
                                 <button class="btn-danger" onclick="reverterMovimentacao('${mov.id}')" title="Reverter Movimentação">
                                     <span class="material-icons">undo</span> Reverter
                                 </button>
                             </td>
                         </tr>
                     `;
                });
            }
            
            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="card">
                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--success-color);">
                        Lucro Total no Período Selecionado: R$ ${totalLucro.toFixed(2).replace('.', ',')}
                    </div>
                    <small>Este valor considera apenas agendamentos com status "Concluído" no filtro.</small>
                </div>
            `;
            
            historicoSection.innerHTML = html;
        }

        window.reverterMovimentacao = function(movimentacaoId) {
             const mov = cacheMovimentacoes[movimentacaoId];
             
             if (!mov) {
                  showNotification('Movimentação não encontrada.', 'error');
                  return;
             }
             
             if (mov.status !== 'Concluído') {
                  showNotification('Apenas movimentações Concluídas podem ser revertidas.', 'error');
                  return;
             }
             
             if (confirm(`Tem certeza que deseja reverter a conclusão de ${mov.servicoNome} para ${mov.clienteNome}? Isso irá mover o agendamento de volta para a Agenda.`)) {
                 
                 // 1. Atualiza a Movimentação (volta para status Agendado)
                 const movimentacaoRef = ref(db, `movimentacoes/${movimentacaoId}`);
                 update(movimentacaoRef, { 
                     status: 'Agendado',
                     tipo: 'Agendamento'
                 }).then(() => {
                     
                     // 2. Atualiza o Status do Agendamento (volta para Agendado)
                     const agendamentoRef = ref(db, `agendamentos/${mov.agendamentoId}`);
                     update(agendamentoRef, { status: 'Agendado' })
                        .then(() => {
                             showNotification(`Movimentação revertida e agendamento de ${mov.clienteNome} movido de volta para a Agenda.`, 'success');
                             carregarAgendamentos();
                             carregarHistorico();
                             
                             // 3. NOVO V6: Lógica de reversão de pacote
                             if (mov.tipo_movimentacao === 'pacote' && mov.pacote_ativo_id) {
                                  // Como o agendamento foi CONCLUÍDO, a sessão já estava DECREMENTADA.
                                  // A reversão de conclusão NÃO DEVE credita a sessão de volta, pois ela não foi cancelada.
                                  // O agendamento só volta para a lista de ativos para ser CONCLUÍDO novamente.
                                  // A reversão de sessão só acontece em "Cancelar" ou "Deletar".
                             }

                        })
                        .catch(error => {
                            console.error("Erro ao reverter agendamento:", error);
                            showNotification('Erro ao reverter agendamento: ' + error.message, 'error');
                        });
                 });
             }
        }
        
        // 6.2. FILTRAR HISTÓRICO NA TABELA
        window.filtrarHistoricoTabela = function() {
             const filtro = document.getElementById('filtro-historico-cliente').value.toLowerCase();
             const listaHistorico = document.getElementById('lista-historico');
             const linhas = listaHistorico.getElementsByTagName('tr');

             for (let i = 0; i < linhas.length; i++) {
                 const row = linhas[i];
                 if (!row.dataset.clienteNome) continue; 

                 const clienteNome = row.dataset.clienteNome;
                
                 if (clienteNome.includes(filtro)) {
                     row.style.display = "";
                 } else {
                     row.style.display = "none";
                 }
             }
        }
        
        // 6.3. RESETAR FILTRO DO HISTÓRICO
        window.resetFiltroHistorico = function() {
            document.getElementById('filtro-historico-mes').value = ''; 
            document.getElementById('filtro-historico-cliente').value = '';
            renderizarHistorico();
        }
        
        // =================================================================
        // 9. CONFIGURAÇÃO DE E-MAIL (EMAILJS)
        // =================================================================

        function carregarConfig() {
            // Esta função pode ser usada para carregar configurações de e-mail se elas estiverem no Firebase,
            // mas por enquanto usa as configurações fixas (cacheConfig)
             if (!cacheConfig.userId || !cacheConfig.serviceId || !cacheConfig.templateId) {
                  console.warn('Configurações de EmailJS incompletas.');
                  // showNotification('Atenção: Configurações de e-mail pendentes.', 'info');
             }
        }
        
        function enviarEmailConfirmacao(agendamento) {
            const cliente = cacheClientes[agendamento.clienteId];
            const clienteEmail = cliente?.email;

            if (!clienteEmail) {
                showNotification('Agendamento salvo, mas o **E-mail não foi enviado** (Cliente sem e-mail).', 'info');
                return;
            }

            if (!cacheConfig.userId || !cacheConfig.serviceId || !cacheConfig.templateId) {
                showNotification('Agendamento salvo, mas o **E-mail não foi enviado** (Configurações pendentes).', 'info');
                return;
            }

            const servicoPrecoDisplay = agendamento.tipo_movimentacao === 'pacote' ? 
                                       'Uso de Pacote (Pago)' : 
                                       `R$ ${parseFloat(agendamento.servicoPreco).toFixed(2).replace('.', ',')}`;
        
            const templateParams = {
                to: clienteEmail, // O e-mail do cliente
                cliente_nome: agendamento.clienteNome,
                servico_nome: agendamento.servicoNome,
                servico_preco: servicoPrecoDisplay,
                data_hora: formatarDataHora(agendamento.data, agendamento.hora),
                // Adicione outros parâmetros conforme seu template do EmailJS
            };
        
            emailjs.send(cacheConfig.serviceId, cacheConfig.templateId, templateParams)
                .then(() => {
                   console.log('E-MAIL ENVIADO COM SUCESSO!');
                   showNotification('Agendamento salvo e **e-mail de confirmação enviado!**', 'success');
                }, (err) => {
                   console.error('FALHA AO ENVIAR O E-MAIL:', err);
                   showNotification(`Agendamento salvo, mas **erro ao enviar e-mail**: ${err.text || err.message || err}`, 'error');
                });
        }
        
        // Inicializa a exibição
        document.addEventListener('DOMContentLoaded', () => {
             // Mostra a tela de login ao carregar a página
            showLogin();
        });
    </script>
</body>
</html>
