<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tati Manicure - Gerenciamento de Agendamentos</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #ff8c6b; /* Cor de Destaque (Salmão/Coral) */
            --secondary-color: #6c757d; /* Cinza para secundários */
            --background-color: #f4f7f6; /* Fundo Suave */
            --sidebar-bg: #ffffff;
            --sidebar-hover-bg: #fff0eb; /* Fundo mais claro para hover */
            --text-color: #343a40; /* Texto Principal (Escuro) */
            --success-color: #28a745;
            --info-color: #17a2b8;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --border-color: #e9ecef;
            --shadow-color: rgba(0, 0, 0, 0.05);
        }

        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            min-height: 100vh;
        }

        /* Estrutura do App */
        #login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            background-color: var(--primary-color);
            min-height: 100vh;
        }

        .login-card {
            background: var(--sidebar-bg);
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 15px var(--shadow-color);
            text-align: center;
            width: 100%;
            max-width: 400px;
        }

        .login-card h1 {
            color: var(--primary-color);
            margin-bottom: 30px;
            font-size: 1.8rem;
        }

        #app-container {
            display: none; /* Escondido por padrão, mostrado após o login */
            width: 100%;
            /* display: flex; REMOVIDO PARA SER ATIVADO VIA JS APÓS LOGIN */
        }

        /* Barra Lateral (Sidebar) */
        .sidebar {
            width: 250px;
            background-color: var(--sidebar-bg);
            box-shadow: 2px 0 5px var(--shadow-color);
            display: flex;
            flex-direction: column;
            padding: 20px 0;
            flex-shrink: 0;
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
            color: var(--primary-color);
            font-size: 1.6rem;
            font-weight: bold;
        }

        .sidebar ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar ul li a {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            text-decoration: none;
            color: var(--text-color);
            transition: background-color 0.2s, color 0.2s;
            font-weight: 500;
        }

        .sidebar ul li a:hover,
        .sidebar ul li a.active {
            background-color: var(--sidebar-hover-bg);
            color: var(--primary-color);
        }

        .sidebar ul li a .material-icons {
            margin-right: 10px;
            font-size: 20px;
        }

        .user-info {
            margin-top: auto;
            padding: 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .user-info p {
            margin: 0 0 10px 0;
            font-weight: bold;
        }

        /* Conteúdo Principal */
        .main-content {
            flex-grow: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .content-section {
            display: none;
            padding: 20px;
        }

        .content-section.active {
            display: block;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .section-header h2 {
            margin: 0;
            color: var(--text-color);
            font-size: 1.5rem;
        }
        
        /* Novas cores para Status de Pacote e Histórico */
        .status-package-paid {
             color: var(--success-color);
             font-weight: bold;
        }
        .status-package-pending {
            color: var(--warning-color);
            font-weight: bold;
        }
        .status-package-active {
            color: var(--primary-color);
            font-weight: bold;
        }
        .status-package-finalized {
            color: var(--danger-color);
            font-weight: bold;
        }

        /* Cartão (Card) */
        .card {
            background: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 4px var(--shadow-color);
            margin-bottom: 20px;
        }
        
        /* NOVO V6: Abas dentro de uma seção */
        .tab-menu {
             display: flex;
             border-bottom: 2px solid var(--border-color);
             margin-bottom: 20px;
        }
        .tab-menu button {
             padding: 10px 20px;
             border: none;
             background: transparent;
             cursor: pointer;
             font-size: 1rem;
             color: var(--secondary-color);
             border-bottom: 2px solid transparent;
             transition: border-color 0.2s, color 0.2s;
             font-weight: bold;
        }
        .tab-menu button.active {
             color: var(--primary-color);
             border-bottom: 2px solid var(--primary-color);
        }
        .tab-content {
             padding-top: 10px;
        }
        .tab-pane {
             display: none;
        }
        .tab-pane.active {
             display: block;
        }

        /* Formulários */
        .form-group {
            margin-bottom: 15px;
        }

        .form-row {
            display: flex;
            gap: 20px;
        }

        .form-row > div {
            flex: 1;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 0.95rem;
        }

        input[type="text"],
        input[type="number"],
        input[type="email"],
        input[type="tel"],
        input[type="date"],
        input[type="time"],
        textarea,
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        /* Datalist input */
        input[list] {
            /* Estilo para garantir que o input datalist se pareça com um campo normal */
            background-image: none;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="email"]:focus,
        input[type="tel"]:focus,
        input[type="date"]:focus,
        input[type="time"]:focus,
        textarea:focus,
        select:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        textarea {
            resize: vertical;
        }

        /* Botões */
        button, .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: background-color 0.2s, opacity 0.2s;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #e57a5e;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #218838;
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: var(--text-color);
        }

        .btn-warning:hover {
            background-color: #ffb547;
        }


        /* Tabelas */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table thead tr {
            background-color: var(--primary-color);
            color: white;
            text-align: left;
        }

        .data-table th, .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table tbody tr:hover {
            background-color: var(--sidebar-hover-bg);
        }

        .data-table td.action-buttons button {
            margin-right: 5px;
            padding: 6px 8px;
        }

        /* CORREÇÃO: Aumenta o espaço para os botões para evitar quebras de linha em telas maiores */
        .data-table td.action-buttons {
            white-space: nowrap;
            width: 280px; /* Garante espaço suficiente */
        }

        /* Notificação */
        #notification-bar {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s, transform 0.3s;
            transform: translateY(-20px);
            z-index: 1000;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            font-weight: bold;
        }

        #notification-bar.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        #notification-bar.success { background-color: var(--success-color); }
        #notification-bar.error { background-color: var(--danger-color); }
        #notification-bar.info { background-color: var(--info-color); }

        /* Utilitários */
        .flex-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .input-group {
            display: flex;
            gap: 10px;
        }
        
        .input-group input, .input-group select {
            flex-grow: 1;
        }

        .filter-row {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            margin-bottom: 20px;
        }
        .filter-row > div {
            flex: 1;
        }
        .filter-row button {
            flex-grow: 0;
            flex-shrink: 0;
            padding: 9px 15px; /* Ajuste para alinhar com o input */
        }
        
        /* NOVO V6: Estilos para a Tabela de Visão Diária */
        .table-responsive {
             overflow-x: auto;
        }
        #tabela-visao-diaria {
             border: 1px solid var(--border-color);
             margin-top: 0;
        }
        #tabela-visao-diaria thead tr {
             background-color: var(--secondary-color);
        }
        #tabela-visao-diaria td {
             height: 40px; /* Altura padrão para cada intervalo de 30 min */
             font-size: 0.9rem;
             vertical-align: top;
        }
        .horario-celula {
             width: 80px;
             font-weight: bold;
             background-color: var(--sidebar-hover-bg);
             color: var(--text-color);
             text-align: center;
             vertical-align: middle !important;
             border-right: 1px solid var(--border-color);
        }
        .agendamento-vago {
             background-color: #f7fff7; /* Verde clarinho */
             color: var(--success-color);
             font-weight: bold;
             font-style: italic;
             text-align: center;
             line-height: 40px;
        }
        .agendamento-ocupado {
             background-color: #fff0eb; /* Fundo do hover de sidebar, suave */
             color: var(--text-color);
             font-weight: 500;
             padding: 5px 10px !important;
             vertical-align: middle !important;
             line-height: 1.2;
             border-left: 5px solid var(--primary-color);
             cursor: pointer;
        }
        .agendamento-ocupado strong {
             color: var(--primary-color);
             font-weight: bold;
        }
        
        /* --------------------------------------------------- */
        /* RESPONSIVIDADE MOBILE (Mobile First - Portrait Mode)*/
        /* --------------------------------------------------- */
        @media (max-width: 768px) {
            
            /* Estrutura Principal */
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
                box-shadow: 0 0 5px var(--shadow-color);
            }

            .main-content {
                padding: 15px;
            }

            #app-container {
                flex-direction: column;
            }

            /* Navegação Horizontal */
            .sidebar ul {
                display: flex;
                flex-wrap: nowrap; /* Tenta manter em uma linha, mas permite rolagem */
                overflow-x: auto;
                justify-content: flex-start;
                border-bottom: 1px solid var(--border-color);
            }

            .sidebar ul li {
                flex-shrink: 0; /* Impede que os itens encolham */
                text-align: center;
            }

            .sidebar ul li a {
                justify-content: center;
                padding: 10px;
                flex-direction: column;
                font-size: 0.75rem;
                white-space: nowrap;
            }

            .sidebar ul li a .material-icons {
                margin-right: 0;
                margin-bottom: 5px;
                font-size: 20px;
            }

            /* FIX: Botão Sair visível no celular */
            .user-info {
                display: block;
                padding: 10px 15px;
                border-top: none; 
                text-align: center; 
            }

            .user-info p {
                display: none; /* Esconde o texto "Olá, Tati!" para economizar espaço */
            }

            .user-info button {
                width: 100%;
                margin-top: 10px; 
                font-size: 0.9rem;
            }
            
            /* 1. Correção de Formulários e Filtros (Empilhamento) */
            .form-row, .filter-row {
                flex-direction: column;
                gap: 0; /* Remove gap quando empilha */
            }

            .form-row > div, 
            .filter-row > div {
                flex: 0 0 100% !important; /* Força largura total */
                width: 100%;
            }
            
            /* Ajusta margem para inputs empilhados */
            .form-group, .filter-row > div {
                margin-bottom: 10px;
            }
            
            .filter-row button {
                width: 100%;
                margin-top: 5px; 
                padding: 10px 15px !important;
            }
            
            /* V6: Ajuste para a Tabela de Visão Diária */
            #tabela-visao-diaria {
                 width: 100%;
                 min-width: 300px; /* Garante que não fique muito esmagada */
            }
            #tabela-visao-diaria td {
                 padding: 5px 10px !important;
            }

            /* 2. Correção de Tabelas (Cartão-like View) */
            .data-table, .data-table tbody, .data-table td, .data-table tr {
                display: block; /* Força elementos da tabela a empilhar */
            }

            .data-table thead {
                display: none; /* Esconde o cabeçalho original */
            }

            .data-table tr {
                border: 1px solid var(--border-color);
                margin-bottom: 15px;
                border-radius: 8px;
                box-shadow: 0 1px 3px var(--shadow-color);
                padding: 10px;
            }

            .data-table td {
                border: none;
                position: relative;
                padding-left: 50% !important; /* Espaço para o rótulo */
                text-align: right; /* Alinha o valor à direita */
                white-space: normal; /* Permite quebras de linha */
                min-height: 40px;
            }

            /* Rótulo customizado (que usa o data-label do JS) */
            .data-table td::before {
                content: attr(data-label);
                position: absolute;
                left: 10px;
                width: 45%; 
                padding-right: 10px;
                white-space: nowrap;
                text-align: left;
                font-weight: bold;
                color: var(--primary-color);
            }
            
            /* FIX V6: Organização dos botões de ação em mobile */
            /* Garante que o rótulo "Ações" não sobreponha o primeiro botão */
            .data-table td.action-buttons {
                text-align: left;
                padding-left: 10px !important;
                display: flex; 
                flex-direction: column; /* Empilha os botões */
                gap: 5px;
                width: 100% !important; /* Garante que ocupe a largura total no mobile */
            }
            
            .data-table td.action-buttons::before {
                content: "Ações";
                width: 100%; 
                margin-bottom: 5px;
                display: block;
            }
            
            .data-table td.action-buttons button {
                margin: 0;
                width: 100%; /* Ocupa a largura toda */
                max-width: 100%;
                box-sizing: border-box;
                font-size: 0.9rem; 
                padding: 8px 5px;
            }
        }
    </style>
</head>
<body>

    <div id="notification-bar"></div>

    <div id="login-container">
        <div class="login-card">
            <h1>Tati Manicure - Acesso</h1>
            <form id="login-form">
                <div class="form-group">
                    <label for="loginSenha">Senha de Acesso</label>
                    <input type="password" id="loginSenha" required>
                </div>
                <button type="submit" class="btn-primary" style="width: 100%; margin-top: 10px;">
                    <span class="material-icons">login</span> Entrar
                </button>
            </form>
        </div>
    </div>

    <datalist id="clientes-datalist"></datalist>

    <div id="app-container">
        
        <aside class="sidebar">
            <div class="logo">TATI MANICURE APP</div>
            
            <ul>
                <li><a href="#" data-section="agenda" class="active"><span class="material-icons">calendar_today</span> Agenda</a></li>
                <li><a href="#" data-section="clientes"><span class="material-icons">people</span> Clientes</a></li>
                <li><a href="#" data-section="servicos"><span class="material-icons">local_offer</span> Serviços</a></li>
                <li><a href="#" data-section="historico"><span class="material-icons">history</span> Histórico/Lucros</a></li>
            </ul>

            <div class="user-info">
                <p id="userInfo">Olá, Tati!</p>
                <button id="logout-button" class="btn-danger" style="width: 100%;">
                    <span class="material-icons">logout</span> Sair
                </button>
            </div>
        </aside>

        <main class="main-content">

            <div id="agenda-section" class="content-section active">
                
                <div class="tab-menu">
                     <button class="tab-button active" onclick="showAgendaTab('pacotes-ativos')">Pacotes Ativos</button>
                     <button class="tab-button" onclick="showAgendaTab('novo-agendamento')">Novo Agendamento</button>
                     <button class="tab-button" onclick="showAgendaTab('lista-agendamentos')">Lista Agendamentos</button>
                     <button class="tab-button" onclick="showAgendaTab('visao-diaria')">Visão Diária</button>
                </div>
                
                <div class="tab-content">
                    
                    <div id="pacotes-ativos-pane" class="tab-pane active">
                         <div class="section-header"><h2>Gerenciamento de Pacotes Ativos</h2></div>
                         <div class="card">
                             <form id="pacote-inicio-form">
                                <h3>Iniciar Novo Pacote de Serviços</h3>
                                <div class="form-row">
                                    <div class="form-group" style="flex: 2;">
                                        <label for="pacote-cliente-id">Cliente</label>
                                        <select id="pacote-cliente-id" required></select>
                                    </div>
                                    <div class="form-group" style="flex: 2;">
                                        <label for="pacote-servico-id">Pacote (Serviços marcados como Pacote)</label>
                                        <select id="pacote-servico-id" required></select>
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label for="pacote-data-inicio">Data Início (Geralmente Hoje)</label>
                                        <input type="date" id="pacote-data-inicio" required>
                                    </div>
                                </div>
                                <div class="flex-container">
                                    <button type="submit" class="btn-primary">
                                        <span class="material-icons">add_box</span> Iniciar/Vender Pacote
                                    </button>
                                </div>
                             </form>
                             <hr style="margin: 20px 0;">
                             <h3>Pacotes Ativos e Utilização</h3>
                             <div style="max-height: 500px; overflow-y: auto;">
                                 <table class="data-table">
                                     <thead>
                                         <tr>
                                             <th style="width: 20%;">Cliente</th>
                                             <th style="width: 25%;">Pacote (Total/Usado)</th>
                                             <th style="width: 15%;">Pagamento</th>
                                             <th style="width: 15%;">Vencimento</th>
                                             <th style="width: 280px;">Ações</th>
                                         </tr>
                                     </thead>
                                     <tbody id="lista-pacotes-ativos">
                                         <tr><td colspan="5" style="text-align: center;">Carregando pacotes ativos...</td></tr>
                                     </tbody>
                                 </table>
                             </div>
                         </div>
                    </div>
                    
                    <div id="novo-agendamento-pane" class="tab-pane">
                        <div class="section-header"><h2>Agendamento de Serviços Individuais (Não-Pacote)</h2></div>
                        <div class="card">
                            <form id="agendamento-form">
                                <input type="hidden" id="agendamento-id">
                                <div class="form-row">
                                    <div class="form-group" style="flex: 2;">
                                        <label for="agenda-cliente-id">Cliente</label>
                                        <select id="agenda-cliente-id" required></select>
                                    </div>
                                    <div class="form-group" style="flex: 2;">
                                        <label for="agenda-servico-id">Serviço Individual/Promoção</label>
                                        <select id="agenda-servico-id" required></select>
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label for="agenda-data">Data</label>
                                        <input type="date" id="agenda-data" required>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group" style="flex: 1;">
                                        <label for="agenda-hora">Hora Início</label>
                                        <input type="time" id="agenda-hora" required>
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label for="agenda-hora-fim">Hora Fim</label>
                                        <input type="time" id="agenda-hora-fim" required>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="agenda-observacoes">Observações</label>
                                    <textarea id="agenda-observacoes" rows="2"></textarea>
                                </div>
                                <div class="flex-container">
                                    <div>
                                        <button type="submit" class="btn-success" id="btn-salvar-agendamento">
                                            <span class="material-icons">save</span> Salvar Agendamento
                                        </button>
                                        <button type="button" class="btn-secondary" onclick="resetAgendamentoForm()">
                                            <span class="material-icons">refresh</span> Limpar
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <div id="lista-agendamentos-pane" class="tab-pane">
                        <div class="section-header">
                            <h3>Próximos Agendamentos Individuais (Ativos)</h3>
                        </div>
                        <div class="card">
                            <div class="filter-row">
                                <div style="flex-grow: 1.5;">
                                    <label for="filtro-agenda-data">Filtrar por Data</label>
                                    <input type="date" id="filtro-agenda-data" onchange="carregarAgendamentos()">
                                </div>
                                <div style="flex-grow: 3;">
                                    <label for="filtro-agenda-cliente">Filtrar por Cliente (Digite ou Selecione)</label>
                                    <input type="text" id="filtro-agenda-cliente" list="clientes-datalist" placeholder="Digite o nome do cliente..." onkeyup="filtrarAgendamentos()">
                                </div>
                                <button class="btn-secondary" onclick="resetFiltroAgenda()"><span class="material-icons">refresh</span> Resetar Filtro</button>
                            </div>
                            <div style="max-height: 500px; overflow-y: auto;">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 15%;">Data/Hora</th>
                                            <th style="width: 25%;">Cliente</th>
                                            <th style="width: 25%;">Serviço</th>
                                            <th>Status</th>
                                            <th style="width: 280px;">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="lista-agendamentos">
                                        <tr><td colspan="5" style="text-align: center;">Carregando agendamentos...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div id="visao-diaria-pane" class="tab-pane">
                        <div class="section-header">
                            <h2>Visão Diária da Agenda</h2>
                        </div>
                        <div class="card">
                            <div class="filter-row">
                                <div style="flex-grow: 1;">
                                    <label for="filtro-visao-diaria-data">Selecione a Data</label>
                                    <input type="date" id="filtro-visao-diaria-data" onchange="renderizarVisaoDiaria()">
                                </div>
                                <button class="btn-secondary" onclick="renderizarVisaoDiaria(today)"><span class="material-icons">today</span> Ver Hoje</button>
                            </div>
                            <div class="table-responsive">
                                <table class="data-table" id="tabela-visao-diaria">
                                    <thead>
                                        <tr>
                                            <th style="width: 100px;">Horário</th>
                                            <th>Detalhes do Agendamento</th>
                                        </tr>
                                    </thead>
                                    <tbody id="lista-visao-diaria">
                                        <tr><td colspan="2" style="text-align: center;">Selecione uma data para visualizar.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                </div>
                
            </div>

            <div id="clientes-section" class="content-section">
                <div class="section-header"><h2>Cadastro de Clientes</h2></div>
                <div class="card">
                    <form id="cliente-form">
                        <input type="hidden" id="cliente-id">
                        <div class="form-row">
                            <div class="form-group" style="flex: 2;">
                                <label for="cliente-nome">Nome Completo</label>
                                <input type="text" id="cliente-nome" required>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label for="cliente-telefone">Telefone (Whatsapp)</label>
                                <input type="tel" id="cliente-telefone">
                            </div>
                        </div>
                        <div class="form-group" style="display: none;">
                            <label for="cliente-email">E-mail (Opcional)</label>
                            <input type="email" id="cliente-email">
                        </div>
                        <div class="form-group">
                            <label for="cliente-endereco">Endereço (Opcional)</label>
                            <input type="text" id="cliente-endereco">
                        </div>
                        <div class="form-group">
                            <label for="cliente-observacoes">Observações (Alergias, Preferências)</label>
                            <textarea id="cliente-observacoes" rows="2"></textarea>
                        </div>
                        <div class="flex-container">
                            <div>
                                <button type="submit" class="btn-success" id="btn-salvar-cliente">
                                    <span class="material-icons">save</span> Salvar Cliente
                                </button>
                                <button type="button" class="btn-secondary" onclick="resetClienteForm()">
                                    <span class="material-icons">refresh</span> Limpar
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
                
                <div class="section-header">
                    <h3>Lista de Clientes Cadastrados</h3>
                    <div class="input-group" style="width: 300px;">
                        <input type="text" id="filtro-clientes" list="clientes-datalist" placeholder="Filtrar por nome, tel ou email..." onkeyup="filtrarClientes()">
                    </div>
                </div>
                <div class="card">
                    <div style="max-height: 500px; overflow-y: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th style="width: 30%;">Nome</th>
                                    <th style="width: 20%;">Telefone</th>
                                    <th style="width: 30%;">Endereço</th>
                                    <th style="width: 150px;">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="lista-clientes">
                                <tr><td colspan="4" style="text-align: center;">Carregando clientes...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="servicos-section" class="content-section">
                <div class="section-header"><h2>Cadastro de Serviços/Pacotes</h2></div>
                <div class="card">
                    <form id="servico-form">
                        <input type="hidden" id="servico-id">
                        <div class="form-row">
                            <div class="form-group" style="flex: 2;">
                                <label for="servico-nome">Nome do Serviço</label>
                                <input type="text" id="servico-nome" required>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label for="servico-preco">Preço (R$)</label>
                                <input type="number" id="servico-preco" step="0.01" min="0" required value="0.00">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <label for="servico-duracao">Duração (minutos)</label>
                                <input type="number" id="servico-duracao" min="10" required value="60">
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label>
                                    <input type="checkbox" id="servico-isPacote"> É um **Pacote Mensal**?
                                </label>
                            </div>
                            <div class="form-group" id="group-quantidade-total" style="flex: 1; display: none;">
                                <label for="servico-quantidade-total">Total de Procedimentos no Pacote (ex: 6)</label>
                                <input type="number" id="servico-quantidade-total" min="1" value="1">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="servico-descricao">Descrição Detalhada (ex: 4 Mãos e 2 Pés)</label>
                            <textarea id="servico-descricao" rows="2"></textarea>
                        </div>
                        <div class="flex-container">
                            <div>
                                <button type="submit" class="btn-success" id="btn-salvar-servico">
                                    <span class="material-icons">save</span> Salvar Serviço
                                </button>
                                <button type="button" class="btn-secondary" onclick="resetServicoForm()">
                                    <span class="material-icons">refresh</span> Limpar
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
                
                <div class="section-header"><h3>Lista de Serviços Cadastrados</h3></div>
                <div class="card">
                    <div style="max-height: 500px; overflow-y: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th style="width: 30%;">Nome</th>
                                    <th style="width: 15%;">Preço</th>
                                    <th style="width: 15%;">Duração</th>
                                    <th style="width: 25%;">Tipo</th>
                                    <th style="width: 150px;">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="lista-servicos">
                                <tr><td colspan="5" style="text-align: center;">Carregando serviços...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="historico-section" class="content-section">
                <div class="tab-menu">
                     <button class="tab-button active" onclick="showHistoricoTab('historico-movimentacoes')">Histórico de Movimentações</button>
                     <button class="tab-button" onclick="showHistoricoTab('relatorio-lucro')">Relatório de Lucro</button>
                     <button class="tab-button" onclick="showHistoricoTab('configuracoes-email')">Configurações/Email</button>
                </div>
                
                <div class="tab-content">
                     <div id="historico-movimentacoes-pane" class="tab-pane active">
                         <div class="section-header"><h2>Histórico de Agendamentos e Pacotes</h2></div>
                         <div class="card">
                            <div class="filter-row">
                                <div style="flex-grow: 1.5;">
                                    <label for="filtro-historico-mes">Filtrar por Mês/Ano</label>
                                    <input type="month" id="filtro-historico-mes" onchange="renderizarHistorico()">
                                </div>
                                <div style="flex-grow: 3;">
                                    <label for="filtro-historico-cliente">Filtrar por Cliente</label>
                                    <input type="text" id="filtro-historico-cliente" list="clientes-datalist" placeholder="Digite o nome do cliente..." onkeyup="filtrarHistoricoTabela()">
                                </div>
                                <button class="btn-secondary" onclick="resetFiltroHistorico()"><span class="material-icons">refresh</span> Resetar Filtro</button>
                            </div>
                            <div style="max-height: 500px; overflow-y: auto;">
                                 <table class="data-table">
                                     <thead>
                                         <tr>
                                             <th style="width: 15%;">Data</th>
                                             <th style="width: 20%;">Cliente</th>
                                             <th style="width: 25%;">Serviço/Pacote</th>
                                             <th style="width: 15%;">Valor</th>
                                             <th style="width: 15%;">Tipo</th>
                                             <th style="width: 150px;">Ações</th>
                                         </tr>
                                     </thead>
                                     <tbody id="lista-historico">
                                         <tr><td colspan="6" style="text-align: center;">Carregando histórico...</td></tr>
                                     </tbody>
                                 </table>
                            </div>
                         </div>
                     </div>
                     
                     <div id="relatorio-lucro-pane" class="tab-pane">
                         <div class="section-header"><h2>Relatório de Lucro Mensal</h2></div>
                         <div class="card">
                              <div class="filter-row">
                                 <div style="flex-grow: 1;">
                                     <label for="filtro-lucro-mes">Selecione o Mês/Ano</label>
                                     <input type="month" id="filtro-lucro-mes" onchange="renderizarRelatorioLucro()">
                                 </div>
                                 <button class="btn-secondary" onclick="renderizarRelatorioLucro(today)"><span class="material-icons">today</span> Mês Atual</button>
                             </div>
                             
                            <h3>Resumo do Mês: <span id="lucro-mes-nome"></span></h3>
                            <div class="card" style="display: flex; gap: 20px; text-align: center;">
                                <div style="flex: 1;">
                                    <p style="font-size: 0.9rem; margin: 0;">Total Recebido</p>
                                    <h4 id="total-recebido" style="color: var(--success-color); font-size: 1.8rem; margin: 5px 0;">R$ 0,00</h4>
                                </div>
                                <div style="flex: 1;">
                                    <p style="font-size: 0.9rem; margin: 0;">Pacotes Vendidos</p>
                                    <h4 id="pacotes-vendidos" style="color: var(--primary-color); font-size: 1.8rem; margin: 5px 0;">0</h4>
                                </div>
                                <div style="flex: 1;">
                                    <p style="font-size: 0.9rem; margin: 0;">Serviços Individuais</p>
                                    <h4 id="servicos-individuais" style="color: var(--info-color); font-size: 1.8rem; margin: 5px 0;">0</h4>
                                </div>
                            </div>
                            
                            <h4>Detalhes por Serviço (Pagos no Mês)</h4>
                            <div style="max-height: 300px; overflow-y: auto;">
                                 <table class="data-table">
                                     <thead>
                                         <tr>
                                             <th style="width: 50%;">Serviço/Pacote</th>
                                             <th style="width: 25%; text-align: center;">Qtd Vendas</th>
                                             <th style="width: 25%; text-align: right;">Total Arrecadado</th>
                                         </tr>
                                     </thead>
                                     <tbody id="lista-lucro-servicos">
                                         <tr><td colspan="3" style="text-align: center;">Nenhum dado para o mês selecionado.</td></tr>
                                     </tbody>
                                 </table>
                            </div>
                         </div>
                     </div>
                     
                     <div id="configuracoes-email-pane" class="tab-pane">
                         <div class="section-header"><h2>Configuração de Envio de E-mail (EmailJS)</h2></div>
                         <div class="card">
                             <form id="emailjs-config-form">
                                 <p>Configure abaixo as chaves do seu serviço <a href="https://www.emailjs.com/" target="_blank">EmailJS</a> para enviar e-mails de confirmação de agendamento automáticos para os clientes.</p>
                                 <div class="form-group">
                                     <label for="emailjs-service-id">Service ID (ex: gmail)</label>
                                     <input type="text" id="emailjs-service-id" required>
                                 </div>
                                 <div class="form-group">
                                     <label for="emailjs-template-id">Template ID</label>
                                     <input type="text" id="emailjs-template-id" required>
                                 </div>
                                 <div class="form-group">
                                     <label for="emailjs-user-id">User ID (Public Key)</label>
                                     <input type="text" id="emailjs-user-id" required>
                                 </div>
                                 <div class="flex-container">
                                    <button type="submit" class="btn-success">
                                        <span class="material-icons">save</span> Salvar Configuração
                                    </button>
                                 </div>
                             </form>
                             <div style="margin-top: 20px;">
                                 <p>Status: <span id="emailjs-status" style="font-weight: bold;">Não configurado</span></p>
                             </div>
                         </div>
                     </div>
                </div>
            </div>

        </main>
    </div>

    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
    
    <script type="module">
        // ---------------------------------------------------
        // 1. FIREBASE CONFIGURAÇÃO E INICIALIZAÇÃO (CORRIGIDO)
        // ---------------------------------------------------
        
        // Importações dos módulos Firebase usando CDN (Corrigido para incluir o Realtime Database)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
        import { getDatabase, ref, onValue, push, set, update, remove, get } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

        // Sua web app's Firebase configuration (Informações do seu projeto 'tati-manicure')
        const firebaseConfig = {
          apiKey: "AIzaSyBatp6e1NzevurpB2yS8eGErgSYC_t2-Nc",
          authDomain: "tati-manicure.firebaseapp.com",
          databaseURL: "https://tati-manicure-default-rtdb.firebaseio.com",
          projectId: "tati-manicure",
          storageBucket: "tati-manicure.firebasestorage.app",
          messagingSenderId: "1061777323027",
          appId: "1:1061777323027:web:7b54e5fdbb7f06ee293be6",
          measurementId: "G-V3J5ZJ5XBT"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        // ESSENCIAL: Inicializa o Realtime Database
        const db = getDatabase(app); 
        // Variável para armazenar a configuração do EmailJS
        let cacheConfig = {};
        
        // ---------------------------------------------------
        // 2. VARIÁVEIS GLOBAIS DE DADOS
        // ---------------------------------------------------
        let clientes = {}; // Armazena todos os clientes
        let servicos = {}; // Armazena todos os serviços
        let pacotesAtivos = {}; // Armazena os pacotes ativos
        let agendamentos = {}; // Armazena os agendamentos futuros
        let movimentacoes = {}; // Armazena todo o histórico
        
        const today = new Date().toISOString().split('T')[0];
        
        // ---------------------------------------------------
        // 3. FUNÇÕES UTILITY
        // ---------------------------------------------------
        
        // 3.1. NOTIFICAÇÃO
        function showNotification(message, type = 'info') {
            const bar = document.getElementById('notification-bar');
            bar.textContent = message;
            bar.className = `notification show ${type}`;
            setTimeout(() => {
                bar.classList.remove('show');
            }, 5000);
        }

        // 3.2. FORMATADOR DE DATA/HORA
        function formatarDataHora(data, hora) {
            if (!data) return '';
            const [year, month, day] = data.split('-');
            let dateStr = `${day}/${month}/${year}`;
            if (hora) {
                dateStr += ` às ${hora}`;
            }
            return dateStr;
        }

        // 3.3. FORMATADOR DE MOEDA
        function formatarMoeda(valor) {
            return parseFloat(valor).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        // 3.4. CÁLCULO DE DURAÇÃO
        function calcularDuracaoEmMinutos(horaInicioStr, horaFimStr) {
            if (!horaInicioStr || !horaFimStr) return 0;
            const [h1, m1] = horaInicioStr.split(':').map(Number);
            const [h2, m2] = horaFimStr.split(':').map(Number);
            
            const totalMinutos1 = h1 * 60 + m1;
            const totalMinutos2 = h2 * 60 + m2;
            
            return totalMinutos2 - totalMinutos1;
        }

        // 3.5. MOBILE: ADICIONA O RÓTULO DE CADA CÉLULA
        function addMobileLabels(tableId) {
            const table = document.querySelector(tableId);
            if (!table) return;
            const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent);
            
            table.querySelectorAll('tbody tr').forEach(row => {
                row.querySelectorAll('td').forEach((cell, index) => {
                    if (headers[index] && cell.getAttribute('data-label') === null) {
                        cell.setAttribute('data-label', headers[index].trim());
                    }
                });
            });
        }
        
        // 3.6. RETORNA O ESTADO DO PACOTE EM TEXTO E CLASSE
        function getStatusPacote(pacote) {
             const dataVencimento = new Date(pacote.data_vencimento);
             const hoje = new Date(today);
             hoje.setHours(0,0,0,0);
             dataVencimento.setHours(0,0,0,0);
             
             if (pacote.quantidade_usada >= pacote.quantidade_total) {
                 return { text: 'FINALIZADO (USADO)', class: 'status-package-finalized' };
             }
             if (dataVencimento < hoje) {
                 return { text: 'VENCIDO', class: 'status-package-finalized' };
             }
             
             // Assumindo que a venda já foi concluída/paga
             return { text: 'ATIVO', class: 'status-package-active' };
        }
        
        // ---------------------------------------------------
        // 4. MUDANÇA DE TELA / NAVEGAÇÃO
        // ---------------------------------------------------

        // 4.1. FUNÇÃO DE LOGIN
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const senha = document.getElementById('loginSenha').value;

            // Senha Simples (Pode ser melhorada com Firebase Auth se necessário)
            if (senha === 'tati123') { 
                showMainApp();
            } else {
                showNotification('Senha incorreta. Tente novamente.', 'error');
            }
        });
        
        // 4.2. MOSTRAR A TELA PRINCIPAL
        function showMainApp() {
            document.getElementById('login-container').style.display = 'none';
            const appContainer = document.getElementById('app-container');
            appContainer.style.display = 'flex';
            // Garante que o cliente datalist está carregado ao entrar
            carregarClientes(); 
            carregarServicos();
            carregarPacotesAtivos();
            carregarAgendamentos();
            renderizarHistorico(); // Carrega o histórico ao entrar
        }

        // 4.3. MOSTRAR TELA DE LOGIN
        window.showLogin = function() {
            document.getElementById('app-container').style.display = 'none';
            document.getElementById('login-container').style.display = 'flex';
            document.getElementById('loginSenha').value = '';
        }

        // 4.4. LOGOUT
        document.getElementById('logout-button').addEventListener('click', showLogin);

        // 4.5. NAVEGAÇÃO LATERAL
        document.querySelectorAll('.sidebar ul li a').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                const sectionId = this.getAttribute('data-section') + '-section';

                document.querySelectorAll('.content-section').forEach(section => {
                    section.classList.remove('active');
                });
                document.getElementById(sectionId).classList.add('active');

                document.querySelectorAll('.sidebar ul li a').forEach(link => {
                    link.classList.remove('active');
                });
                this.classList.add('active');
                
                // Recarrega dados relevantes ao mudar de seção (Garantia de atualização)
                if (sectionId === 'clientes-section') {
                     carregarClientes();
                } else if (sectionId === 'servicos-section') {
                     carregarServicos();
                } else if (sectionId === 'agenda-section') {
                     carregarAgendamentos();
                     carregarPacotesAtivos();
                } else if (sectionId === 'historico-section') {
                    // Garante que a primeira aba de histórico esteja ativa e carrega os dados
                    showHistoricoTab('historico-movimentacoes');
                    renderizarHistorico();
                }
            });
        });

        // 4.6. NAVEGAÇÃO POR ABAS (AGENDA)
        window.showAgendaTab = function(tabName) {
             document.querySelectorAll('#agenda-section .tab-pane').forEach(pane => {
                 pane.classList.remove('active');
             });
             document.getElementById(tabName + '-pane').classList.add('active');
             
             document.querySelectorAll('#agenda-section .tab-button').forEach(btn => {
                 btn.classList.remove('active');
             });
             document.querySelector(`.tab-button[onclick*='${tabName}']`).classList.add('active');
             
             // Carrega a visão diária automaticamente se for ativada
             if (tabName === 'visao-diaria' && !document.getElementById('filtro-visao-diaria-data').value) {
                 document.getElementById('filtro-visao-diaria-data').value = today;
                 renderizarVisaoDiaria();
             }
        }
        
        // 4.7. NAVEGAÇÃO POR ABAS (HISTÓRICO)
        window.showHistoricoTab = function(tabName) {
             document.querySelectorAll('#historico-section .tab-pane').forEach(pane => {
                 pane.classList.remove('active');
             });
             document.getElementById(tabName + '-pane').classList.add('active');
             
             document.querySelectorAll('#historico-section .tab-button').forEach(btn => {
                 btn.classList.remove('active');
             });
             document.querySelector(`#historico-section .tab-menu button[onclick*='${tabName}']`).classList.add('active');
             
             if (tabName === 'relatorio-lucro-pane') {
                 // Carrega o relatório para o mês atual
                 const mesAtual = new Date().toISOString().substring(0, 7);
                 document.getElementById('filtro-lucro-mes').value = mesAtual;
                 renderizarRelatorioLucro();
             } else if (tabName === 'historico-movimentacoes-pane') {
                 // Carrega o histórico para o mês atual
                 const mesAtual = new Date().toISOString().substring(0, 7);
                 document.getElementById('filtro-historico-mes').value = mesAtual;
                 document.getElementById('filtro-historico-cliente').value = '';
                 renderizarHistorico();
             } else if (tabName === 'configuracoes-email') {
                 // Carrega a configuração do EmailJS
                 carregarEmailJSConfig();
             }
        }

        // ---------------------------------------------------
        // 5. CLIENTES (CRUD e RENDERIZAÇÃO)
        // ---------------------------------------------------

        // 5.1. SALVAR/ATUALIZAR CLIENTE
        document.getElementById('cliente-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('cliente-id').value;
            const nome = document.getElementById('cliente-nome').value;
            const telefone = document.getElementById('cliente-telefone').value;
            const email = document.getElementById('cliente-email').value;
            const endereco = document.getElementById('cliente-endereco').value;
            const observacoes = document.getElementById('cliente-observacoes').value;
            
            const clienteData = { nome, telefone, email, endereco, observacoes };
            
            try {
                if (id) {
                    await update(ref(db, `clientes/${id}`), clienteData);
                    showNotification(`Cliente **${nome}** atualizado com sucesso!`, 'success');
                } else {
                    const newRef = push(ref(db, 'clientes'));
                    await set(newRef, clienteData);
                    showNotification(`Cliente **${nome}** salvo com sucesso!`, 'success');
                }
                
                resetClienteForm();
                carregarClientes(); // Recarrega a lista
            } catch (error) {
                console.error("Erro ao salvar cliente:", error);
                showNotification('Erro ao salvar o cliente.', 'error');
            }
        });

        // 5.2. CARREGAR CLIENTES DO FIREBASE
        function carregarClientes() {
            const clientesRef = ref(db, 'clientes');
            onValue(clientesRef, (snapshot) => {
                clientes = {}; // Limpa o objeto global
                const listaClientes = document.getElementById('lista-clientes');
                const datalist = document.getElementById('clientes-datalist');
                
                listaClientes.innerHTML = '';
                datalist.innerHTML = '';
                
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        const key = childSnapshot.key;
                        const cliente = childSnapshot.val();
                        clientes[key] = { ...cliente, id: key }; // Salva no objeto global
                        
                        // Renderiza a linha na tabela de clientes
                        const row = listaClientes.insertRow();
                        row.dataset.clienteId = key;
                        
                        row.innerHTML = `
                            <td data-label="Nome">${cliente.nome}</td>
                            <td data-label="Telefone">${cliente.telefone || 'N/A'}</td>
                            <td data-label="Endereço">${cliente.endereco || 'N/A'}</td>
                            <td data-label="Ações" class="action-buttons">
                                <button class="btn-secondary" onclick="editarCliente('${key}')"><span class="material-icons">edit</span> Editar</button>
                                <button class="btn-danger" onclick="excluirCliente('${key}', '${cliente.nome}')"><span class="material-icons">delete</span> Excluir</button>
                            </td>
                        `;
                        
                        // Adiciona ao Datalist (usado nos filtros)
                        const option = document.createElement('option');
                        option.value = cliente.nome;
                        datalist.appendChild(option);
                    });
                } else {
                    listaClientes.innerHTML = '<tr><td colspan="4" style="text-align: center;">Nenhum cliente cadastrado.</td></tr>';
                }
                
                // Adiciona os rótulos em mobile (após o carregamento)
                addMobileLabels('#clientes-section .data-table');
                
                // Recarrega os selects de clientes (pacote e agendamento)
                preencherSelectClientes();
            }, (error) => {
                 console.error("Erro ao carregar clientes:", error);
                 showNotification('Erro ao carregar clientes.', 'error');
            });
        }
        
        // 5.3. PREENCHER SELECTS DE CLIENTES
        function preencherSelectClientes() {
            const selectIds = ['pacote-cliente-id', 'agenda-cliente-id'];
            
            selectIds.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (!select) return;
                
                select.innerHTML = '<option value="">-- Selecione um Cliente --</option>';
                
                // Converte o objeto global de clientes em um array para ordenar
                const clientesArray = Object.values(clientes).sort((a, b) => a.nome.localeCompare(b.nome));

                clientesArray.forEach(cliente => {
                    const option = document.createElement('option');
                    option.value = cliente.id;
                    option.textContent = cliente.nome;
                    select.appendChild(option);
                });
            });
        }

        // 5.4. EDITAR CLIENTE
        window.editarCliente = function(id) {
            const cliente = clientes[id];
            if (!cliente) return showNotification('Cliente não encontrado.', 'error');
            
            document.getElementById('cliente-id').value = id;
            document.getElementById('cliente-nome').value = cliente.nome;
            document.getElementById('cliente-telefone').value = cliente.telefone || '';
            document.getElementById('cliente-email').value = cliente.email || '';
            document.getElementById('cliente-endereco').value = cliente.endereco || '';
            document.getElementById('cliente-observacoes').value = cliente.observacoes || '';
            
            document.getElementById('btn-salvar-cliente').innerHTML = '<span class="material-icons">save</span> Atualizar Cliente';
            showNotification(`Editando cliente: **${cliente.nome}**`, 'info');
            
            // Leva o usuário de volta ao topo do formulário
            document.getElementById('clientes-section').querySelector('.card').scrollIntoView({ behavior: 'smooth' });
        }

        // 5.5. EXCLUIR CLIENTE
        window.excluirCliente = function(id, nome) {
            if (confirm(`Tem certeza que deseja EXCLUIR o cliente ${nome}? Isso também apagará agendamentos e pacotes associados.`)) {
                remove(ref(db, `clientes/${id}`))
                    .then(() => {
                        showNotification(`Cliente **${nome}** excluído com sucesso!`, 'success');
                        carregarClientes();
                    })
                    .catch(error => {
                        console.error("Erro ao excluir cliente:", error);
                        showNotification('Erro ao excluir o cliente.', 'error');
                    });
            }
        }
        
        // 5.6. LIMPAR FORMULÁRIO
        window.resetClienteForm = function() {
            document.getElementById('cliente-form').reset();
            document.getElementById('cliente-id').value = '';
            document.getElementById('btn-salvar-cliente').innerHTML = '<span class="material-icons">save</span> Salvar Cliente';
        }

        // 5.7. FILTRAR CLIENTES
        window.filtrarClientes = function() {
             const filtro = document.getElementById('filtro-clientes').value.toLowerCase();
             const listaClientes = document.getElementById('lista-clientes');
             const linhas = listaClientes.getElementsByTagName('tr');

             for (let i = 0; i < linhas.length; i++) {
                 const nome = linhas[i].cells[0].textContent.toLowerCase();
                 const telefone = linhas[i].cells[1].textContent.toLowerCase();
                 
                 if (nome.includes(filtro) || telefone.includes(filtro)) {
                     // Em desktop é 'table-row', em mobile é 'block'
                     linhas[i].style.display = window.innerWidth > 768 ? "table-row" : "block"; 
                 } else {
                     linhas[i].style.display = "none";
                 }
             }
        }

        // ---------------------------------------------------
        // 6. SERVIÇOS (CRUD e RENDERIZAÇÃO)
        // ---------------------------------------------------

        // 6.1. ATIVAR/DESATIVAR CAMPO DE QUANTIDADE DO PACOTE
        document.getElementById('servico-isPacote').addEventListener('change', function() {
            const group = document.getElementById('group-quantidade-total');
            group.style.display = this.checked ? 'block' : 'none';
            document.getElementById('servico-quantidade-total').required = this.checked;
        });

        // 6.2. SALVAR/ATUALIZAR SERVIÇO
        document.getElementById('servico-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('servico-id').value;
            const nome = document.getElementById('servico-nome').value;
            const preco = parseFloat(document.getElementById('servico-preco').value);
            const duracao = parseInt(document.getElementById('servico-duracao').value);
            const descricao = document.getElementById('servico-descricao').value;
            const isPacote = document.getElementById('servico-isPacote').checked;
            const quantidadeTotal = isPacote ? parseInt(document.getElementById('servico-quantidade-total').value) : 0;
            
            const servicoData = { nome, preco, duracao, descricao, isPacote, quantidadeTotal };
            
            try {
                if (id) {
                    await update(ref(db, `servicos/${id}`), servicoData);
                    showNotification(`Serviço **${nome}** atualizado com sucesso!`, 'success');
                } else {
                    const newRef = push(ref(db, 'servicos'));
                    await set(newRef, servicoData);
                    showNotification(`Serviço **${nome}** salvo com sucesso!`, 'success');
                }
                
                resetServicoForm();
                carregarServicos(); // Recarrega a lista
            } catch (error) {
                console.error("Erro ao salvar serviço:", error);
                showNotification('Erro ao salvar o serviço.', 'error');
            }
        });

        // 6.3. CARREGAR SERVIÇOS DO FIREBASE
        function carregarServicos() {
            const servicosRef = ref(db, 'servicos');
            onValue(servicosRef, (snapshot) => {
                servicos = {}; // Limpa o objeto global
                const listaServicos = document.getElementById('lista-servicos');
                listaServicos.innerHTML = '';
                
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        const key = childSnapshot.key;
                        const servico = childSnapshot.val();
                        servicos[key] = { ...servico, id: key }; // Salva no objeto global
                        
                        // Renderiza a linha na tabela de serviços
                        const row = listaServicos.insertRow();
                        row.dataset.servicoId = key;
                        
                        const tipoTexto = servico.isPacote ? 
                            `Pacote (${servico.quantidadeTotal}x)` : 
                            'Individual';
                            
                        row.innerHTML = `
                            <td data-label="Nome">${servico.nome}</td>
                            <td data-label="Preço">${formatarMoeda(servico.preco)}</td>
                            <td data-label="Duração">${servico.duracao} min</td>
                            <td data-label="Tipo">${tipoTexto}</td>
                            <td data-label="Ações" class="action-buttons">
                                <button class="btn-secondary" onclick="editarServico('${key}')"><span class="material-icons">edit</span> Editar</button>
                                <button class="btn-danger" onclick="excluirServico('${key}', '${servico.nome}')"><span class="material-icons">delete</span> Excluir</button>
                            </td>
                        `;
                    });
                } else {
                    listaServicos.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nenhum serviço cadastrado.</td></tr>';
                }
                
                // Adiciona os rótulos em mobile
                addMobileLabels('#servicos-section .data-table');

                // Recarrega os selects de serviços (pacote e agendamento)
                preencherSelectServicos();
            }, (error) => {
                 console.error("Erro ao carregar serviços:", error);
                 showNotification('Erro ao carregar serviços.', 'error');
            });
        }

        // 6.4. PREENCHER SELECTS DE SERVIÇOS
        function preencherSelectServicos() {
            const selectPacote = document.getElementById('pacote-servico-id');
            const selectAgendamento = document.getElementById('agenda-servico-id');
            
            [selectPacote, selectAgendamento].forEach(select => {
                if (select) select.innerHTML = '<option value="">-- Selecione um Serviço --</option>';
            });
            
            // Converte o objeto global de serviços em um array para ordenar
            const servicosArray = Object.values(servicos).sort((a, b) => a.nome.localeCompare(b.nome));

            servicosArray.forEach(servico => {
                const option = document.createElement('option');
                option.value = servico.id;
                option.textContent = `${servico.nome} (${formatarMoeda(servico.preco)})`;

                if (servico.isPacote && selectPacote) {
                    selectPacote.appendChild(option.cloneNode(true));
                } else if (!servico.isPacote && selectAgendamento) {
                    selectAgendamento.appendChild(option.cloneNode(true));
                }
            });
        }

        // 6.5. EDITAR SERVIÇO
        window.editarServico = function(id) {
            const servico = servicos[id];
            if (!servico) return showNotification('Serviço não encontrado.', 'error');
            
            document.getElementById('servico-id').value = id;
            document.getElementById('servico-nome').value = servico.nome;
            document.getElementById('servico-preco').value = servico.preco.toFixed(2);
            document.getElementById('servico-duracao').value = servico.duracao;
            document.getElementById('servico-descricao').value = servico.descricao || '';
            document.getElementById('servico-isPacote').checked = servico.isPacote;
            document.getElementById('servico-quantidade-total').value = servico.quantidadeTotal || 0;
            
            // Ativa/Desativa o campo de quantidade
            document.getElementById('group-quantidade-total').style.display = servico.isPacote ? 'block' : 'none';
            
            document.getElementById('btn-salvar-servico').innerHTML = '<span class="material-icons">save</span> Atualizar Serviço';
            showNotification(`Editando serviço: **${servico.nome}**`, 'info');
            
            document.getElementById('servicos-section').querySelector('.card').scrollIntoView({ behavior: 'smooth' });
        }

        // 6.6. EXCLUIR SERVIÇO
        window.excluirServico = function(id, nome) {
            if (confirm(`Tem certeza que deseja EXCLUIR o serviço/pacote ${nome}?`)) {
                remove(ref(db, `servicos/${id}`))
                    .then(() => {
                        showNotification(`Serviço/Pacote **${nome}** excluído com sucesso!`, 'success');
                        carregarServicos();
                    })
                    .catch(error => {
                        console.error("Erro ao excluir serviço:", error);
                        showNotification('Erro ao excluir o serviço.', 'error');
                    });
            }
        }
        
        // 6.7. LIMPAR FORMULÁRIO
        window.resetServicoForm = function() {
            document.getElementById('servico-form').reset();
            document.getElementById('servico-id').value = '';
            document.getElementById('group-quantidade-total').style.display = 'none';
            document.getElementById('btn-salvar-servico').innerHTML = '<span class="material-icons">save</span> Salvar Serviço';
        }


        // ---------------------------------------------------
        // 7. PACOTES ATIVOS (CRUD e RENDERIZAÇÃO)
        // ---------------------------------------------------

        // 7.1. INICIAR NOVO PACOTE
        document.getElementById('pacote-inicio-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const clienteId = document.getElementById('pacote-cliente-id').value;
            const servicoId = document.getElementById('pacote-servico-id').value;
            const dataInicio = document.getElementById('pacote-data-inicio').value;
            
            const cliente = clientes[clienteId];
            const servico = servicos[servicoId];
            
            if (!cliente || !servico || !servico.isPacote) {
                return showNotification('Selecione um cliente e um pacote válido.', 'error');
            }
            
            // Cálculo da data de vencimento (30 dias após o início)
            const dataInicioObj = new Date(dataInicio);
            const dataVencimentoObj = new Date(dataInicioObj);
            dataVencimentoObj.setDate(dataInicioObj.getDate() + 30);
            const dataVencimento = dataVencimentoObj.toISOString().split('T')[0];
            
            const pacoteData = {
                clienteId: clienteId,
                clienteNome: cliente.nome,
                servicoId: servicoId,
                servicoNome: servico.nome,
                dataCriacao: new Date().toISOString(),
                data_inicio: dataInicio,
                data_vencimento: dataVencimento,
                preco_total: servico.preco,
                quantidade_total: servico.quantidadeTotal,
                quantidade_usada: 0,
                status: 'ativo' // Ou 'pago' / 'pendente' se fosse necessário
            };
            
            try {
                const newRef = push(ref(db, 'pacotes_ativos'));
                await set(newRef, pacoteData);
                showNotification(`Pacote **${servico.nome}** para **${cliente.nome}** iniciado!`, 'success');
                document.getElementById('pacote-inicio-form').reset();
                carregarPacotesAtivos(); 
            } catch (error) {
                console.error("Erro ao iniciar pacote:", error);
                showNotification('Erro ao iniciar o pacote.', 'error');
            }
        });

        // 7.2. CARREGAR PACOTES ATIVOS
        function carregarPacotesAtivos() {
            const pacotesRef = ref(db, 'pacotes_ativos');
            onValue(pacotesRef, (snapshot) => {
                pacotesAtivos = {}; // Limpa o objeto global
                const listaPacotes = document.getElementById('lista-pacotes-ativos');
                listaPacotes.innerHTML = '';
                
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        const key = childSnapshot.key;
                        const pacote = childSnapshot.val();
                        pacotesAtivos[key] = { ...pacote, id: key }; // Salva no objeto global
                        
                        // Renderiza apenas se não estiver completamente usado/vencido (para manter a lista "ativa" limpa)
                        const status = getStatusPacote(pacote);
                        
                        if (status.text === 'ATIVO') { 
                            const row = listaPacotes.insertRow();
                            row.dataset.pacoteId = key;
                            
                            const vencimentoDisplay = formatarDataHora(pacote.data_vencimento);
                            const usoDisplay = `${pacote.quantidade_usada || 0} de ${pacote.quantidade_total}`;

                            row.innerHTML = `
                                <td data-label="Cliente">${pacote.clienteNome}</td>
                                <td data-label="Pacote (Total/Usado)">${pacote.servicoNome} (${usoDisplay})</td>
                                <td data-label="Pagamento">${formatarMoeda(pacote.preco_total)}</td>
                                <td data-label="Vencimento">${vencimentoDisplay}</td>
                                <td data-label="Ações" class="action-buttons">
                                    <button class="btn-primary" onclick="usarPacote('${key}', '${pacote.clienteNome}', '${pacote.servicoNome}')">
                                        <span class="material-icons">check_circle</span> Usar 1 Procedimento
                                    </button>
                                    <button class="btn-danger" onclick="finalizarPacote('${key}', '${pacote.clienteNome}')">
                                        <span class="material-icons">cancel</span> Finalizar/Cancelar
                                    </button>
                                </td>
                            `;
                        }
                    });
                } 
                
                if (listaPacotes.childElementCount === 0) {
                     listaPacotes.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nenhum pacote ativo no momento.</td></tr>';
                }
                
                // Adiciona os rótulos em mobile
                addMobileLabels('#pacotes-ativos-pane .data-table');
            }, (error) => {
                 console.error("Erro ao carregar pacotes ativos:", error);
                 showNotification('Erro ao carregar pacotes ativos.', 'error');
            });
        }
        
        // 7.3. USAR PROCEDIMENTO DO PACOTE
        window.usarPacote = async function(id, clienteNome, servicoNome) {
             const pacote = pacotesAtivos[id];
             if (!pacote) return showNotification('Pacote não encontrado.', 'error');
             
             if (pacote.quantidade_usada >= pacote.quantidade_total) {
                 return showNotification('Este pacote já foi completamente utilizado.', 'warning');
             }

             if (confirm(`Confirmar o uso de 1 procedimento do pacote **${servicoNome}** para **${clienteNome}**?`)) {
                 try {
                     const novaQuantidadeUsada = (pacote.quantidade_usada || 0) + 1;
                     
                     // 1. Atualiza o uso no nó `pacotes_ativos`
                     await update(ref(db, `pacotes_ativos/${id}`), {
                         quantidade_usada: novaQuantidadeUsada
                     });
                     
                     // 2. Registra a movimentação no nó `movimentacoes`
                     const movimentacaoData = {
                         clienteId: pacote.clienteId,
                         clienteNome: pacote.clienteNome,
                         servicoNome: pacote.servicoNome,
                         servicoPreco: 0, // Custo zero na movimentação, pois já foi pago
                         data: today,
                         hora: new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }),
                         tipo_movimentacao: 'uso_pacote',
                         status: 'finalizado'
                     };
                     await push(ref(db, 'movimentacoes'), movimentacaoData);
                     
                     showNotification(`Uso de pacote registrado para **${clienteNome}**. Restam ${pacote.quantidade_total - novaQuantidadeUsada}.`, 'success');
                     carregarPacotesAtivos(); // Recarrega a lista de ativos
                 } catch (error) {
                     console.error("Erro ao usar pacote:", error);
                     showNotification('Erro ao registrar o uso do pacote.', 'error');
                 }
             }
        }
        
        // 7.4. FINALIZAR/CANCELAR PACOTE
        window.finalizarPacote = async function(id, clienteNome) {
             if (confirm(`Tem certeza que deseja FINALIZAR/CANCELAR o pacote de ${clienteNome}? Isso o removerá da lista de ativos.`)) {
                 try {
                     // Altera o status para 'finalized'
                     await update(ref(db, `pacotes_ativos/${id}`), {
                         status: 'finalized' 
                     });
                     
                     showNotification(`Pacote de **${clienteNome}** finalizado/cancelado com sucesso.`, 'info');
                     carregarPacotesAtivos(); 
                 } catch (error) {
                     console.error("Erro ao finalizar pacote:", error);
                     showNotification('Erro ao finalizar o pacote.', 'error');
                 }
             }
        }

        // ---------------------------------------------------
        // 8. AGENDAMENTOS (CRUD e RENDERIZAÇÃO)
        // ---------------------------------------------------
        
        // 8.1. SALVAR/ATUALIZAR AGENDAMENTO (Serviço Individual)
        document.getElementById('agendamento-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('agendamento-id').value;
            const clienteId = document.getElementById('agenda-cliente-id').value;
            const servicoId = document.getElementById('agenda-servico-id').value;
            const data = document.getElementById('agenda-data').value;
            const hora = document.getElementById('agenda-hora').value;
            const horaFim = document.getElementById('agenda-hora-fim').value;
            const observacoes = document.getElementById('agenda-observacoes').value;
            
            const cliente = clientes[clienteId];
            const servico = servicos[servicoId];
            
            if (!cliente || !servico) {
                return showNotification('Selecione um cliente e um serviço válido.', 'error');
            }
            if (servico.isPacote) {
                return showNotification('Este formulário é apenas para serviços individuais. Use a aba "Pacotes Ativos" para agendar uso de pacotes.', 'warning');
            }
            
            const agendamentoData = {
                clienteId: clienteId,
                clienteNome: cliente.nome,
                clienteEmail: cliente.email || '',
                servicoId: servicoId,
                servicoNome: servico.nome,
                servicoPreco: servico.preco,
                servicoDuracao: servico.duracao,
                data: data,
                hora: hora,
                horaFim: horaFim,
                observacoes: observacoes,
                tipo_movimentacao: 'individual',
                status: 'pendente' 
            };
            
            try {
                if (id) {
                    await update(ref(db, `agendamentos/${id}`), agendamentoData);
                    showNotification(`Agendamento de **${cliente.nome}** atualizado para ${formatarDataHora(data, hora)}!`, 'success');
                } else {
                    const newRef = push(ref(db, 'agendamentos'));
                    await set(newRef, agendamentoData);
                    showNotification(`Agendamento de **${cliente.nome}** salvo para ${formatarDataHora(data, hora)}!`, 'success');
                    
                    // Tenta enviar o e-mail
                    enviarEmailConfirmacao(agendamentoData);
                }
                
                resetAgendamentoForm();
                carregarAgendamentos(); 
            } catch (error) {
                console.error("Erro ao salvar agendamento:", error);
                showNotification('Erro ao salvar o agendamento.', 'error');
            }
        });
        
        // 8.2. LIMPAR FORMULÁRIO DE AGENDAMENTO
        window.resetAgendamentoForm = function() {
            document.getElementById('agendamento-form').reset();
            document.getElementById('agendamento-id').value = '';
            document.getElementById('btn-salvar-agendamento').innerHTML = '<span class="material-icons">save</span> Salvar Agendamento';
            document.getElementById('agenda-data').value = today;
        }

        // 8.3. CARREGAR AGENDAMENTOS FUTUROS (A PARTIR DE HOJE)
        function carregarAgendamentos() {
            const agendamentosRef = ref(db, 'agendamentos');
            // Utilizamos onValue, mas a filtragem por data é feita no front-end para simplificar, 
            // já que a lista de agendamentos futuros não deve ser excessivamente grande.
            onValue(agendamentosRef, (snapshot) => {
                agendamentos = {}; // Limpa o objeto global
                const listaAgendamentos = document.getElementById('lista-agendamentos');
                listaAgendamentos.innerHTML = '';
                
                // Pega o filtro de data
                const filtroData = document.getElementById('filtro-agenda-data').value || today;
                const filtroCliente = document.getElementById('filtro-agenda-cliente').value.toLowerCase().trim();

                const agendamentosParaRenderizar = [];
                
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        const key = childSnapshot.key;
                        const agendamento = childSnapshot.val();
                        
                        // Armazena no global (todos, mesmo os antigos, para uso na visão diária)
                        agendamentos[key] = { ...agendamento, id: key }; 

                        // Filtra: Apenas agendamentos *a partir* da data de filtro (incluindo o filtro)
                        if (agendamento.data >= filtroData && agendamento.status === 'pendente') {
                            
                            // Filtro por nome do cliente
                            if (!filtroCliente || agendamento.clienteNome.toLowerCase().includes(filtroCliente)) {
                                agendamentosParaRenderizar.push({ ...agendamento, id: key });
                            }
                        }
                    });
                } 
                
                // Ordena por data e hora
                agendamentosParaRenderizar.sort((a, b) => {
                    if (a.data !== b.data) {
                        return a.data.localeCompare(b.data);
                    }
                    return a.hora.localeCompare(b.hora);
                });
                
                if (agendamentosParaRenderizar.length > 0) {
                    agendamentosParaRenderizar.forEach(agendamento => {
                        const row = listaAgendamentos.insertRow();
                        row.dataset.agendamentoId = agendamento.id;
                        
                        const duracao = calcularDuracaoEmMinutos(agendamento.hora, agendamento.horaFim);

                        row.innerHTML = `
                            <td data-label="Data/Hora">
                                ${formatarDataHora(agendamento.data)}<br>
                                <strong>${agendamento.hora} - ${agendamento.horaFim} (${duracao} min)</strong>
                            </td>
                            <td data-label="Cliente">${agendamento.clienteNome}</td>
                            <td data-label="Serviço">${agendamento.servicoNome} (${formatarMoeda(agendamento.servicoPreco)})</td>
                            <td data-label="Status"><span class="status-package-pending">AGENDADO</span></td>
                            <td data-label="Ações" class="action-buttons">
                                <button class="btn-success" onclick="finalizarAgendamento('${agendamento.id}', '${agendamento.clienteNome}')"><span class="material-icons">done</span> Finalizar</button>
                                <button class="btn-secondary" onclick="editarAgendamento('${agendamento.id}')"><span class="material-icons">edit</span> Editar</button>
                                <button class="btn-danger" onclick="cancelarAgendamento('${agendamento.id}', '${agendamento.clienteNome}')"><span class="material-icons">close</span> Cancelar</button>
                            </td>
                        `;
                    });
                } else {
                    listaAgendamentos.innerHTML = `<tr><td colspan="5" style="text-align: center;">Nenhum agendamento futuro encontrado ${filtroCliente ? 'para este cliente.' : `a partir de ${formatarDataHora(filtroData)}.`}</td></tr>`;
                }

                // Adiciona os rótulos em mobile
                addMobileLabels('#lista-agendamentos-pane .data-table');
            }, (error) => {
                 console.error("Erro ao carregar agendamentos:", error);
                 showNotification('Erro ao carregar agendamentos.', 'error');
            });
        }
        
        // 8.4. FILTRAR AGENDAMENTOS (Quando o filtro de cliente é digitado)
        window.filtrarAgendamentos = function() {
            // carregarAgendamentos já possui a lógica de filtragem interna
            carregarAgendamentos();
        }

        // 8.5. RESETAR FILTRO DA AGENDA
        window.resetFiltroAgenda = function() {
            document.getElementById('filtro-agenda-data').value = '';
            document.getElementById('filtro-agenda-cliente').value = '';
            carregarAgendamentos();
        }

        // 8.6. EDITAR AGENDAMENTO
        window.editarAgendamento = function(id) {
            const agendamento = agendamentos[id];
            if (!agendamento) return showNotification('Agendamento não encontrado.', 'error');
            
            document.getElementById('agendamento-id').value = id;
            document.getElementById('agenda-cliente-id').value = agendamento.clienteId;
            document.getElementById('agenda-servico-id').value = agendamento.servicoId;
            document.getElementById('agenda-data').value = agendamento.data;
            document.getElementById('agenda-hora').value = agendamento.hora;
            document.getElementById('agenda-hora-fim').value = agendamento.horaFim;
            document.getElementById('agenda-observacoes').value = agendamento.observacoes || '';
            
            document.getElementById('btn-salvar-agendamento').innerHTML = '<span class="material-icons">save</span> Atualizar Agendamento';
            showNotification(`Editando agendamento de: **${agendamento.clienteNome}**`, 'info');
            
            showAgendaTab('novo-agendamento');
            document.getElementById('novo-agendamento-pane').querySelector('.card').scrollIntoView({ behavior: 'smooth' });
        }
        
        // 8.7. FINALIZAR AGENDAMENTO (MOVE PARA HISTÓRICO)
        window.finalizarAgendamento = async function(id, clienteNome) {
             const agendamento = agendamentos[id];
             if (!agendamento) return showNotification('Agendamento não encontrado.', 'error');

             if (confirm(`Confirmar que o serviço **${agendamento.servicoNome}** foi realizado para **${clienteNome}**? Isso registrará o lucro.`)) {
                 try {
                     // 1. Remove do nó `agendamentos`
                     await remove(ref(db, `agendamentos/${id}`));
                     
                     // 2. Registra a movimentação no nó `movimentacoes`
                     const movimentacaoData = {
                         ...agendamento,
                         status: 'finalizado',
                         data_finalizacao: today, // Usa a data de hoje como finalização
                         data: agendamento.data, // Mantém a data original do agendamento para o histórico
                         tipo_movimentacao: 'individual_pago',
                         agendamentoId: id // Referência para o agendamento original
                     };
                     await push(ref(db, 'movimentacoes'), movimentacaoData);
                     
                     showNotification(`Serviço de **${clienteNome}** finalizado e lucro registrado: ${formatarMoeda(agendamento.servicoPreco)}`, 'success');
                     carregarAgendamentos(); 
                 } catch (error) {
                     console.error("Erro ao finalizar agendamento:", error);
                     showNotification('Erro ao finalizar o agendamento.', 'error');
                 }
             }
        }
        
        // 8.8. CANCELAR AGENDAMENTO
        window.cancelarAgendamento = async function(id, clienteNome) {
             if (confirm(`Tem certeza que deseja CANCELAR o agendamento de ${clienteNome}? Isso o removerá da lista.`)) {
                 try {
                     await remove(ref(db, `agendamentos/${id}`));
                     
                     showNotification(`Agendamento de **${clienteNome}** cancelado com sucesso.`, 'info');
                     carregarAgendamentos(); 
                 } catch (error) {
                     console.error("Erro ao cancelar agendamento:", error);
                     showNotification('Erro ao cancelar o agendamento.', 'error');
                 }
             }
        }
        
        // 8.9. VISÃO DIÁRIA (Função Principal)
        window.renderizarVisaoDiaria = function(data = null) {
            const filtroInput = document.getElementById('filtro-visao-diaria-data');
            const dataFiltro = data || filtroInput.value;
            const listaVisaoDiaria = document.getElementById('lista-visao-diaria');
            
            if (!dataFiltro) {
                listaVisaoDiaria.innerHTML = '<tr><td colspan="2" style="text-align: center;">Selecione uma data para visualizar.</td></tr>';
                return;
            }
            
            listaVisaoDiaria.innerHTML = '';
            
            // 1. Filtrar agendamentos do dia (incluindo pacotes que foram registrados no dia, mas o foco é agendamentos)
            const agendamentosDoDia = Object.values(agendamentos).filter(a => a.data === dataFiltro && a.status === 'pendente');

            const agendaTimeline = {}; // Usaremos para mapear a ocupação por intervalo de 30 minutos

            // 2. Preencher a Timeline com agendamentos ocupados
            agendamentosDoDia.forEach(a => {
                const [hInicio, mInicio] = a.hora.split(':').map(Number);
                const [hFim, mFim] = a.horaFim.split(':').map(Number);
                
                const inicioMinutos = hInicio * 60 + mInicio;
                const fimMinutos = hFim * 60 + mFim;

                for (let min = inicioMinutos; min < fimMinutos; min += 30) {
                     const horaStr = `${String(Math.floor(min / 60)).padStart(2, '0')}:${String(min % 60).padStart(2, '0')}`;
                     agendaTimeline[horaStr] = a;
                }
            });
            
            // 3. Renderizar a tabela (de 8:00h às 20:00h)
            for (let h = 8; h < 20; h++) {
                for (let m = 0; m < 60; m += 30) {
                    const horaStr = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                    const row = listaVisaoDiaria.insertRow();
                    
                    row.innerHTML = `<td class="horario-celula">${horaStr}</td>`;
                    const detalhesCell = row.insertCell();
                    
                    const agendamento = agendaTimeline[horaStr];
                    
                    if (agendamento) {
                        detalhesCell.className = 'agendamento-ocupado';
                        detalhesCell.innerHTML = `
                            <strong>${agendamento.clienteNome}</strong> - ${agendamento.servicoNome}<br>
                            ${agendamento.hora} às ${agendamento.horaFim} (${calcularDuracaoEmMinutos(agendamento.hora, agendamento.horaFim)} min)
                        `;
                        detalhesCell.setAttribute('onclick', `editarAgendamento('${agendamento.id}')`);
                    } else {
                        detalhesCell.className = 'agendamento-vago';
                        detalhesCell.textContent = 'Vago';
                        detalhesCell.setAttribute('onclick', `prepararNovoAgendamento('${dataFiltro}', '${horaStr}')`);
                    }
                    
                    // Se estiver ocupado, pular o próximo intervalo de 30 min para evitar linhas repetidas
                    if (agendamento && m === 0) {
                         // A função de merge CSS é complexa, no momento a linha vazia será renderizada
                         // O CSS simples já garante o estilo de ocupado. Manter linhas separadas é mais simples.
                    }
                }
            }
            
            // Adiciona os rótulos em mobile
            addMobileLabels('#visao-diaria-pane .data-table');
        }

        // 8.10. PREPARAR NOVO AGENDAMENTO A PARTIR DA VISÃO DIÁRIA
        window.prepararNovoAgendamento = function(data, hora) {
             showAgendaTab('novo-agendamento');
             document.getElementById('agenda-data').value = data;
             document.getElementById('agenda-hora').value = hora;
             
             // Estima a hora de fim (padrão de 60 minutos)
             const [h, m] = hora.split(':').map(Number);
             const fimMinutos = h * 60 + m + 60;
             const hFim = String(Math.floor(fimMinutos / 60)).padStart(2, '0');
             const mFim = String(fimMinutos % 60).padStart(2, '0');
             document.getElementById('agenda-hora-fim').value = `${hFim}:${mFim}`;
             
             showNotification(`Novo agendamento pré-preenchido para ${formatarDataHora(data, hora)}`, 'info');
        }


        // ---------------------------------------------------
        // 9. HISTÓRICO E LUCRO (RENDERIZAÇÃO)
        // ---------------------------------------------------
        
        // 9.1. CARREGAR TODO O HISTÓRICO DE MOVIMENTAÇÕES
        function carregarHistorico() {
            const movimentacoesRef = ref(db, 'movimentacoes');
            onValue(movimentacoesRef, (snapshot) => {
                movimentacoes = {}; // Limpa o objeto global
                
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        const key = childSnapshot.key;
                        const mov = childSnapshot.val();
                        movimentacoes[key] = { ...mov, id: key }; // Salva no objeto global
                    });
                }
                
                renderizarHistorico(); // Chama a renderização após carregar
            }, (error) => {
                 console.error("Erro ao carregar histórico:", error);
                 showNotification('Erro ao carregar histórico.', 'error');
            });
        }
        
        // 9.2. RENDERIZAR HISTÓRICO (FILTRADO POR MÊS)
        window.renderizarHistorico = function() {
             const listaHistorico = document.getElementById('lista-historico');
             listaHistorico.innerHTML = '';
             
             const filtroMesAno = document.getElementById('filtro-historico-mes').value; // Ex: 2025-09
             const filtroCliente = document.getElementById('filtro-historico-cliente').value.toLowerCase().trim();
             
             const movimentacoesArray = Object.values(movimentacoes).sort((a, b) => b.data.localeCompare(a.data));

             const movimentacoesFiltradas = movimentacoesArray.filter(mov => {
                 const dataRef = mov.data || mov.data_finalizacao || ''; // Usa data original ou finalização
                 
                 // 1. Filtro por Mês/Ano
                 const mesMatch = !filtroMesAno || dataRef.startsWith(filtroMesAno);
                 
                 // 2. Filtro por Cliente
                 const clienteMatch = !filtroCliente || mov.clienteNome.toLowerCase().includes(filtroCliente);
                 
                 return mesMatch && clienteMatch;
             });

             if (movimentacoesFiltradas.length > 0) {
                 movimentacoesFiltradas.forEach(mov => {
                     const row = listaHistorico.insertRow();
                     row.dataset.movimentacaoId = mov.id;
                     row.dataset.clienteNome = mov.clienteNome; // Para filtro JS

                     let tipoDisplay = '';
                     let valorDisplay = '';
                     let acoes = '';

                     switch (mov.tipo_movimentacao) {
                         case 'individual_pago':
                             tipoDisplay = `<span class="status-package-paid">Serviço Pago</span>`;
                             valorDisplay = formatarMoeda(mov.servicoPreco);
                             acoes = `<button class="btn-danger" onclick="reverterMovimentacao('${mov.id}', 'individual')"><span class="material-icons">undo</span> Reverter</button>`;
                             break;
                         case 'venda_pacote':
                             tipoDisplay = `<span class="status-package-active">Venda de Pacote</span>`;
                             valorDisplay = formatarMoeda(mov.servicoPreco);
                             acoes = `<button class="btn-danger" onclick="reverterMovimentacao('${mov.id}', 'venda')"><span class="material-icons">undo</span> Reverter</button>`;
                             break;
                         case 'uso_pacote':
                             tipoDisplay = `<span class="status-package-pending">Uso de Pacote</span>`;
                             valorDisplay = 'R$ 0,00';
                             acoes = `<button class="btn-danger" onclick="reverterMovimentacao('${mov.id}', 'uso')"><span class="material-icons">undo</span> Reverter Uso</button>`;
                             break;
                         default:
                             tipoDisplay = 'Outro';
                             valorDisplay = 'N/A';
                             break;
                     }
                     
                     // Ajusta a data exibida (usa a data do agendamento ou a data de registro)
                     const dataDisplay = formatarDataHora(mov.data || mov.data_finalizacao);

                     row.innerHTML = `
                         <td data-label="Data">${dataDisplay} ${mov.hora ? `às ${mov.hora}` : ''}</td>
                         <td data-label="Cliente">${mov.clienteNome}</td>
                         <td data-label="Serviço/Pacote">${mov.servicoNome}</td>
                         <td data-label="Valor">${valorDisplay}</td>
                         <td data-label="Tipo">${tipoDisplay}</td>
                         <td data-label="Ações" class="action-buttons">${acoes}</td>
                     `;
                 });
             } else {
                 listaHistorico.innerHTML = '<tr><td colspan="6" style="text-align: center;">Nenhuma movimentação encontrada para o filtro.</td></tr>';
             }
             
             // Adiciona os rótulos em mobile
             addMobileLabels('#historico-movimentacoes-pane .data-table');
        }

        // 9.3. REVERTER MOVIMENTAÇÃO (Exclui a movimentação e, se for uso de pacote, desfaz o uso)
        window.reverterMovimentacao = function(id, tipo) {
             const mov = movimentacoes[id];
             if (!mov) return showNotification('Movimentação não encontrada.', 'error');
             
             let confirmMsg = `Tem certeza que deseja reverter a movimentação de **${mov.servicoNome}** para **${mov.clienteNome}**?`;
             if (tipo === 'uso') {
                 confirmMsg += " Isso também diminuirá o uso no pacote ativo.";
             }
             
             if (confirm(confirmMsg)) {
                 remove(ref(db, `movimentacoes/${id}`))
                    .then(() => {
                        // Se for uso de pacote, reverte o contador no pacote ativo
                        if (tipo === 'uso') {
                            // Necessário encontrar o pacote ativo associado (Não temos o ID do pacote no Mov.)
                            // Simplificação: Vamos assumir que o pacote mais recente do cliente está sendo usado.
                            // Para um sistema robusto, Movimentação de uso deveria ter o pacoteId.
                            // Como não temos, notificamos o usuário para corrigir manualmente.
                             showNotification('Movimentação de uso revertida. **Lembre-se de corrigir a contagem do pacote ativo manualmente**.', 'warning');
                        }
                        
                        showNotification('Movimentação revertida com sucesso!', 'success');
                        carregarHistorico(); 
                    })
                    .catch(error => {
                        console.error("Erro ao reverter:", error);
                        showNotification('Erro ao reverter: ' + error.message, 'error');
                    });
             }
        }

        // 9.4. RENDERIZAR RELATÓRIO DE LUCRO
        window.renderizarRelatorioLucro = function() {
            const filtroMesAno = document.getElementById('filtro-lucro-mes').value; // Ex: 2025-09
            const listaLucroServicos = document.getElementById('lista-lucro-servicos');
            listaLucroServicos.innerHTML = '<tr><td colspan="3" style="text-align: center;">Calculando...</td></tr>';
            
            if (!filtroMesAno) {
                const hoje = new Date().toISOString().substring(0, 7);
                document.getElementById('filtro-lucro-mes').value = hoje;
                return renderizarRelatorioLucro();
            }
            
            const [ano, mes] = filtroMesAno.split('-');
            document.getElementById('lucro-mes-nome').textContent = `${new Date(ano, mes - 1).toLocaleString('pt-BR', { month: 'long', year: 'numeric' }).toUpperCase()}`;
            
            let totalRecebido = 0;
            let pacotesVendidos = 0;
            let servicosIndividuais = 0;
            const resumoPorServico = {};
            
            const movimentacoesArray = Object.values(movimentacoes);
            
            movimentacoesArray.filter(mov => mov.tipo_movimentacao !== 'uso_pacote') // Exclui uso de pacote (valor R$0,00)
                              .filter(mov => mov.data_finalizacao && mov.data_finalizacao.startsWith(filtroMesAno)) // Filtra por data de finalização
                              .forEach(mov => {
                const valor = mov.servicoPreco || 0;
                totalRecebido += valor;
                
                if (mov.tipo_movimentacao === 'venda_pacote') {
                    pacotesVendidos++;
                } else if (mov.tipo_movimentacao === 'individual_pago') {
                    servicosIndividuais++;
                }
                
                // Acumula por Serviço/Pacote
                if (!resumoPorServico[mov.servicoNome]) {
                    resumoPorServico[mov.servicoNome] = { quantidade: 0, total: 0 };
                }
                resumoPorServico[mov.servicoNome].quantidade += 1;
                resumoPorServico[mov.servicoNome].total += valor;
            });
            
            // Renderiza o resumo
            document.getElementById('total-recebido').textContent = formatarMoeda(totalRecebido);
            document.getElementById('pacotes-vendidos').textContent = pacotesVendidos;
            document.getElementById('servicos-individuais').textContent = servicosIndividuais;
            
            // Renderiza a tabela de detalhes
            listaLucroServicos.innerHTML = '';
            const servicosOrdenados = Object.keys(resumoPorServico).sort();
            
            if (servicosOrdenados.length > 0) {
                 servicosOrdenados.forEach(nomeServico => {
                     const resumo = resumoPorServico[nomeServico];
                     const row = listaLucroServicos.insertRow();
                     row.innerHTML = `
                         <td data-label="Serviço/Pacote">${nomeServico}</td>
                         <td data-label="Qtd Vendas" style="text-align: center;">${resumo.quantidade}</td>
                         <td data-label="Total Arrecadado" style="text-align: right;">${formatarMoeda(resumo.total)}</td>
                     `;
                 });
            } else {
                 listaLucroServicos.innerHTML = '<tr><td colspan="3" style="text-align: center;">Nenhum lucro registrado para este mês.</td></tr>';
            }
            
            // Adiciona os rótulos em mobile
            addMobileLabels('#relatorio-lucro-pane .data-table');
        }

        // ---------------------------------------------------
        // 10. CONFIGURAÇÃO DE E-MAIL (EMAILJS)
        // ---------------------------------------------------

        // 10.1. SALVAR CONFIGURAÇÃO
        document.getElementById('emailjs-config-form').addEventListener('submit', async (e) => {
             e.preventDefault();
             
             const serviceId = document.getElementById('emailjs-service-id').value.trim();
             const templateId = document.getElementById('emailjs-template-id').value.trim();
             const userId = document.getElementById('emailjs-user-id').value.trim();
             
             const configData = { serviceId, templateId, userId };
             
             try {
                 // Salva no Firebase em um nó separado (configurações)
                 await set(ref(db, `configuracoes/emailjs`), configData);
                 
                 // Inicializa o EmailJS
                 emailjs.init(userId); 
                 cacheConfig = configData;
                 
                 document.getElementById('emailjs-status').textContent = 'Configurado e Pronto para Uso';
                 document.getElementById('emailjs-status').style.color = 'var(--success-color)';
                 showNotification('Configuração do EmailJS salva e ativada!', 'success');
             } catch (error) {
                 console.error("Erro ao salvar config EmailJS:", error);
                 showNotification('Erro ao salvar a configuração do EmailJS.', 'error');
             }
        });

        // 10.2. CARREGAR CONFIGURAÇÃO (Ao abrir a tela)
        function carregarEmailJSConfig() {
            const configRef = ref(db, 'configuracoes/emailjs');
            get(configRef).then((snapshot) => {
                if (snapshot.exists()) {
                    const config = snapshot.val();
                    cacheConfig = config;
                    
                    document.getElementById('emailjs-service-id').value = config.serviceId || '';
                    document.getElementById('emailjs-template-id').value = config.templateId || '';
                    document.getElementById('emailjs-user-id').value = config.userId || '';

                    emailjs.init(config.userId); 
                    document.getElementById('emailjs-status').textContent = 'Configurado e Pronto para Uso';
                    document.getElementById('emailjs-status').style.color = 'var(--success-color)';
                } else {
                    document.getElementById('emailjs-status').textContent = 'Não configurado (Necessário salvar as chaves)';
                    document.getElementById('emailjs-status').style.color = 'var(--danger-color)';
                }
            }).catch(error => {
                 console.error("Erro ao carregar config EmailJS:", error);
            });
        }
        
        // 10.3. ENVIAR E-MAIL DE CONFIRMAÇÃO (Chamado após salvar agendamento)
        async function enviarEmailConfirmacao(agendamento) {
            const clienteEmail = agendamento.clienteEmail;
            
            if (!clienteEmail) {
                showNotification('Agendamento salvo, mas cliente sem e-mail para envio de confirmação.', 'info');
                return;
            }
            
            if (!cacheConfig.serviceId || !cacheConfig.templateId) {
                showNotification('Agendamento salvo, mas o **E-mail não foi enviado** (Configurações pendentes).', 'info');
                return;
            }
            
            // Garante que o valor exibido no e-mail reflete o tipo de movimentação
            const servicoPrecoDisplay = agendamento.tipo_movimentacao === 'pacote' ? 
                                       'Uso de Pacote (Pago)' : 
                                       `R$ ${parseFloat(agendamento.servicoPreco).toFixed(2).replace('.', ',')}`;

            const templateParams = {
                to: clienteEmail, // O e-mail do cliente
                cliente_nome: agendamento.clienteNome,
                servico_nome: agendamento.servicoNome,
                servico_preco: servicoPrecoDisplay,
                data_hora: formatarDataHora(agendamento.data, agendamento.hora),
                // Adicione outros parâmetros conforme seu template do EmailJS
            };
        
            emailjs.send(cacheConfig.serviceId, cacheConfig.templateId, templateParams)
                .then(() => {
                   console.log('E-MAIL ENVIADO COM SUCESSO!');
                   // A notificação de sucesso já foi dada no salvarAgendamento.
                }, (err) => {
                   console.error('FALHA AO ENVIAR O E-MAIL:', err);
                   showNotification(`Agendamento salvo, mas **erro ao enviar e-mail**: ${err.text || err.message || err}`, 'error');
                });
        }
        
        // Inicializa a exibição
        document.addEventListener('DOMContentLoaded', () => {
             // Mostra a tela de login ao carregar a página
            showLogin();
        });
    </script>
</body>
</html>
