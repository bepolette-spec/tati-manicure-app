<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tati Manicure - Gerenciamento de Agendamentos</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <style>
        :root {
            --primary-color: #ff8c6b; /* Cor de Destaque (Salmão/Coral) */
            --secondary-color: #6c757d; /* Cinza para secundários */
            --background-color: #f4f7f6; /* Fundo Suave */
            --sidebar-bg: #ffffff;
            --sidebar-hover-bg: #fff0eb; /* Fundo mais claro para hover */
            --text-color: #343a40; /* Texto Principal (Escuro) */
            --success-color: #28a745;
            --info-color: #17a2b8;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --border-color: #e9ecef;
            --shadow-color: rgba(0, 0, 0, 0.05);
        }

        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            min-height: 100vh;
        }

        /* Estrutura do App */
        #login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            /* NOVO: Adição da Imagem de Fundo (Usando 'image_decbc8.jpg' conforme sugerido) */
            background-image: url('image_decbc8.jpg'); 
            background-size: cover;
            background-position: center;
            /* Aplica a cor principal com transparência e a mistura com a imagem para suavizar */
            background-color: rgba(255, 140, 107, 0.7); /* (var(--primary-color) com 70% de opacidade) */
            background-blend-mode: overlay; 
            min-height: 100vh;
        }

        .login-card {
            background: var(--sidebar-bg);
            padding: 40px;
            border-radius: 12px;
            /* Ajuste de sombra para destacar mais sobre o fundo de imagem */
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3); 
            text-align: center;
            width: 100%;
            max-width: 400px;
        }

        .login-card h1 {
            color: var(--primary-color);
            margin-bottom: 30px;
            font-size: 1.8rem;
        }

        #app-container {
            display: none; /* Escondido por padrão, mostrado após o login */
            width: 100%;
        }

        /* Barra Lateral (Sidebar) */
        .sidebar {
            width: 250px;
            background-color: var(--sidebar-bg);
            box-shadow: 2px 0 5px var(--shadow-color);
            display: flex;
            flex-direction: column;
            padding: 20px 0;
            flex-shrink: 0;
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
            color: var(--primary-color);
            font-size: 1.6rem;
            font-weight: bold;
        }

        .sidebar ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar ul li a {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            text-decoration: none;
            color: var(--text-color);
            transition: background-color 0.2s, color 0.2s;
            font-weight: 500;
        }

        .sidebar ul li a:hover,
        .sidebar ul li a.active {
            background-color: var(--sidebar-hover-bg);
            color: var(--primary-color);
        }

        .sidebar ul li a .material-icons {
            margin-right: 10px;
            font-size: 20px;
        }

        .user-info {
            margin-top: auto;
            padding: 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .user-info p {
            margin: 0 0 10px 0;
            font-weight: bold;
        }

        /* Conteúdo Principal */
        .main-content {
            flex-grow: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .content-section {
            display: none;
            padding: 20px;
        }

        .content-section.active {
            display: block;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .section-header h2 {
            margin: 0;
            color: var(--text-color);
            font-size: 1.5rem;
        }
        
        /* Novas cores para Status de Pacote e Histórico */
        .status-package-paid {
             color: var(--success-color);
             font-weight: bold;
        }
        .status-package-pending {
            color: var(--warning-color);
            font-weight: bold;
        }
        .status-package-active {
            color: var(--primary-color);
            font-weight: bold;
        }
        .status-package-finalized {
            color: var(--danger-color);
            font-weight: bold;
        }

        /* Cartão (Card) */
        .card {
            background: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 4px var(--shadow-color);
            margin-bottom: 20px;
        }
        
        /* NOVO V6: Abas dentro de uma seção */
        .tab-menu {
             display: flex;
             border-bottom: 2px solid var(--border-color);
             margin-bottom: 20px;
        }
        .tab-menu button {
             padding: 10px 20px;
             border: none;
             background: transparent;
             cursor: pointer;
             font-size: 1rem;
             color: var(--secondary-color);
             border-bottom: 2px solid transparent;
             transition: border-color 0.2s, color 0.2s;
             font-weight: bold;
        }
        .tab-menu button.active {
             color: var(--primary-color);
             border-bottom: 2px solid var(--primary-color);
        }
        .tab-content {
             padding-top: 10px;
        }
        .tab-pane {
             display: none;
        }
        .tab-pane.active {
             display: block;
        }

        /* Formulários */
        .form-group {
            margin-bottom: 15px;
        }

        .form-row {
            display: flex;
            gap: 20px;
        }

        .form-row > div {
            flex: 1;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 0.95rem;
        }

        input[type="text"],
        input[type="number"],
        input[type="email"],
        input[type="tel"],
        input[type="date"],
        input[type="time"],
        textarea,
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        /* Datalist input */
        input[list] {
            /* Estilo para garantir que o input datalist se pareça com um campo normal */
            background-image: none;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="email"]:focus,
        input[type="tel"]:focus,
        input[type="date"]:focus,
        input[type="time"]:focus,
        textarea:focus,
        select:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        textarea {
            resize: vertical;
        }

        /* Botões */
        button, .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: background-color 0.2s, opacity 0.2s;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #e57a5e;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #218838;
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: var(--text-color);
        }

        .btn-warning:hover {
            background-color: #ffb547;
        }


        /* Tabelas */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table thead tr {
            background-color: var(--primary-color);
            color: white;
            text-align: left;
        }

        .data-table th, .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table tbody tr:hover {
            background-color: var(--sidebar-hover-bg);
        }

        .data-table td.action-buttons button {
            margin-right: 5px;
            padding: 6px 8px;
        }

        .data-table td.action-buttons {
            white-space: nowrap;
        }

        /* Notificação */
        #notification-bar {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s, transform 0.3s;
            transform: translateY(-20px);
            z-index: 1000;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            font-weight: bold;
        }

        #notification-bar.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        #notification-bar.success { background-color: var(--success-color); }
        #notification-bar.error { background-color: var(--danger-color); }
        #notification-bar.info { background-color: var(--info-color); }

        /* Utilitários */
        .flex-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .input-group {
            display: flex;
            gap: 10px;
        }
        
        .input-group input, .input-group select {
            flex-grow: 1;
        }

        .filter-row {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            margin-bottom: 20px;
        }
        .filter-row > div {
            flex: 1;
        }
        .filter-row button {
            flex-grow: 0;
            flex-shrink: 0;
            padding: 9px 15px; /* Ajuste para alinhar com o input */
        }
        
        /* NOVO V6: Estilos para a Tabela de Visão Diária */
        #tabela-visao-diaria {
             border: 1px solid var(--border-color);
             margin-top: 0;
        }
        #tabela-visao-diaria thead tr {
             background-color: var(--secondary-color);
        }
        #tabela-visao-diaria td {
             height: 40px; /* Altura padrão para cada intervalo de 30 min */
             font-size: 0.9rem;
             vertical-align: top;
        }
        .horario-celula {
             width: 80px;
             font-weight: bold;
             background-color: var(--sidebar-hover-bg);
             color: var(--text-color);
             text-align: center;
             vertical-align: middle !important;
             border-right: 1px solid var(--border-color);
        }
        .agendamento-vago {
             background-color: #f7fff7; /* Verde clarinho */
             color: var(--success-color);
             font-weight: bold;
             font-style: italic;
             text-align: center;
             line-height: 40px;
        }
        .agendamento-ocupado {
             background-color: #fff0eb; /* Fundo do hover de sidebar, suave */
             color: var(--text-color);
             font-weight: 500;
             padding: 5px 10px !important;
             vertical-align: middle !important;
             line-height: 1.2;
             border-left: 5px solid var(--primary-color);
             cursor: pointer;
        }
        .agendamento-ocupado strong {
             color: var(--primary-color);
             font-weight: bold;
        }
        
        /* --------------------------------------------------- */
        /* RESPONSIVIDADE MOBILE (Mobile First - Portrait Mode)*/
        /* --------------------------------------------------- */
        @media (max-width: 768px) {
            
            /* Estrutura Principal */
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
                box-shadow: 0 0 5px var(--shadow-color);
            }

            .main-content {
                padding: 15px;
            }

            #app-container {
                flex-direction: column;
            }

            /* Navegação Horizontal */
            .sidebar ul {
                display: flex;
                flex-wrap: nowrap; /* Tenta manter em uma linha, mas permite rolagem */
                overflow-x: auto;
                justify-content: flex-start;
                border-bottom: 1px solid var(--border-color);
            }

            .sidebar ul li {
                flex-shrink: 0; /* Impede que os itens encolham */
                text-align: center;
            }

            .sidebar ul li a {
                justify-content: center;
                padding: 10px;
                flex-direction: column;
                font-size: 0.75rem;
                white-space: nowrap;
            }

            .sidebar ul li a .material-icons {
                margin-right: 0;
                margin-bottom: 5px;
                font-size: 20px;
            }

            /* FIX: Botão Sair visível no celular */
            .user-info {
                display: block;
                padding: 10px 15px;
                border-top: none; 
                text-align: center;
            }

            .user-info p {
                display: none; /* Esconde o texto "Olá, Tati!" para economizar espaço */
            }

            .user-info button {
                width: 100%;
                margin-top: 10px;
                font-size: 0.9rem;
            }
            
            /* 1. Correção de Formulários e Filtros (Empilhamento) */
            .form-row, .filter-row {
                flex-direction: column;
                gap: 0; /* Remove gap quando empilha */
            }

            .form-row > div, .filter-row > div {
                flex: 0 0 100% !important; /* Força largura total */
                width: 100%;
            }

            /* Ajusta margem para inputs empilhados */
            .form-group, .filter-row > div {
                margin-bottom: 10px;
            }

            .filter-row button {
                width: 100%;
                margin-top: 5px;
                padding: 10px 15px !important;
            }
            
            /* V6: Ajuste para a Tabela de Visão Diária */
            .table-responsive {
                overflow-x: auto;
            }
            #tabela-visao-diaria {
                width: 100%;
                min-width: 300px; /* Garante que não fique muito esmagada */
            }
            #tabela-visao-diaria td {
                padding: 5px 10px !important;
            }

            /* 2. Correção de Tabelas (Cartão-like View) */
            .data-table, .data-table tbody, .data-table td, .data-table tr {
                display: block; /* Força elementos da tabela a empilhar */
            }

            .data-table thead {
                display: none; /* Esconde o cabeçalho original */
            }

            .data-table tr {
                border: 1px solid var(--border-color);
                margin-bottom: 15px;
                border-radius: 8px;
                box-shadow: 0 1px 3px var(--shadow-color);
                padding: 10px;
            }

            .data-table td {
                border: none;
                position: relative;
                padding-left: 50% !important; /* Espaço para o rótulo */
                text-align: right; /* Alinha o valor à direita */
                white-space: normal; /* Permite quebras de linha */
                min-height: 40px;
            }

            /* Rótulo customizado (que usa o data-label do JS) */
            .data-table td::before {
                content: attr(data-label);
                position: absolute;
                left: 10px;
                width: 45%;
                padding-right: 10px;
                white-space: nowrap;
                text-align: left;
                font-weight: bold;
                color: var(--primary-color);
            }

            /* FIX V6: Organização dos botões de ação em mobile */
            /* Garante que o rótulo "Ações" não sobreponha o primeiro botão */
            .data-table td.action-buttons {
                text-align: left;
                padding-left: 10px !important;
                display: flex;
                flex-direction: column; /* Empilha os botões */
                gap: 5px;
            }

            .data-table td.action-buttons::before {
                content: "Ações";
                width: 100%;
                margin-bottom: 5px;
                display: block;
            }
            
            .data-table td.action-buttons button {
                margin: 0;
                width: 100%; /* Ocupa a largura toda */
                max-width: 100%;
                box-sizing: border-box;
                font-size: 0.9rem;
                padding: 8px 5px;
            }
        }
    </style>
</head>
<body>
    <div id="notification-bar"></div>

    <div id="login-container">
        <div class="login-card">
            <h1>Tati Manicure - Acesso</h1>
            <form id="login-form">
                <div class="form-group">
                    <label for="loginSenha">Senha de Acesso</label>
                    <input type="password" id="loginSenha" required>
                </div>
                <button type="submit" class="btn-primary" style="width: 100%; margin-top: 10px;">
                    <span class="material-icons">login</span> Entrar
                </button>
            </form>
        </div>
    </div>
    
    <datalist id="clientes-datalist"></datalist>

    <div id="app-container">
        <aside class="sidebar">
            <div class="logo">TATI MANICURE APP</div>
            <ul>
                <li><a href="#" data-section="agenda" class="active"><span class="material-icons">calendar_today</span> Agenda</a></li>
                <li><a href="#" data-section="clientes"><span class="material-icons">people</span> Clientes</a></li>
                <li><a href="#" data-section="servicos"><span class="material-icons">local_offer</span> Serviços</a></li>
                <li><a href="#" data-section="historico"><span class="material-icons">history</span> Histórico/Lucros</a></li>
            </ul>
            <div class="user-info">
                <p id="userInfo">Olá, Tati!</p>
                <button id="logout-button" class="btn-danger" style="width: 100%;">
                    <span class="material-icons">logout</span> Sair
                </button>
            </div>
        </aside>

        <main class="main-content">
            <div id="agenda-section" class="content-section active">
                <div class="tab-menu">
                    <button class="tab-button active" onclick="showAgendaTab('pacotes-ativos')">Pacotes Ativos</button>
                    <button class="tab-button" onclick="showAgendaTab('novo-agendamento')">Novo Agendamento</button>
                    <button class="tab-button" onclick="showAgendaTab('lista-agendamentos')">Lista Agendamentos</button>
                    <button class="tab-button" onclick="showAgendaTab('visao-diaria')">Visão Diária</button>
                </div>

                <div class="tab-content">
                    <div id="pacotes-ativos-pane" class="tab-pane active">
                        <div class="section-header"><h2>Gerenciamento de Pacotes Ativos</h2></div>

                        <div class="card">
                            <form id="pacote-inicio-form">
                                <h3>Iniciar Novo Pacote de Serviços</h3>
                                <div class="form-row">
                                    <div class="form-group" style="flex: 2;">
                                        <label for="pacote-cliente-id">Cliente</label>
                                        <select id="pacote-cliente-id" required></select>
                                    </div>
                                    <div class="form-group" style="flex: 2;">
                                        <label for="pacote-servico-id">Pacote (Serviços marcados como Pacote)</label>
                                        <select id="pacote-servico-id" required></select>
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label for="pacote-data-inicio">Data Início (Geralmente Hoje)</label>
                                        <input type="date" id="pacote-data-inicio" required>
                                    </div>
                                </div>
                                <div class="flex-container">
                                    <button type="submit" class="btn-primary">
                                        <span class="material-icons">add_circle</span> Iniciar Pacote
                                    </button>
                                </div>
                            </form>
                        </div>
                        
                        <div class="card">
                            <h3>Pacotes em Andamento</h3>
                            <div class="table-responsive">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Cliente</th>
                                            <th>Serviço (Pacote)</th>
                                            <th>Total de Sessões</th>
                                            <th>Sessões Restantes</th>
                                            <th>Status</th>
                                            <th class="action-buttons">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="lista-pacotes-ativos">
                                        </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div id="novo-agendamento-pane" class="tab-pane">
                        <div class="section-header"><h2>Novo Agendamento</h2></div>
                        <div class="card">
                            <form id="novo-agendamento-form">
                                <div class="form-row">
                                    <div class="form-group" style="flex: 2;">
                                        <label for="agendamento-cliente">Cliente</label>
                                        <input type="text" id="agendamento-cliente" list="clientes-datalist" required placeholder="Digite o nome ou selecione da lista">
                                        <input type="hidden" id="agendamento-cliente-id">
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label for="agendamento-servico-tipo">Tipo de Serviço</label>
                                        <select id="agendamento-servico-tipo" required>
                                            <option value="">Selecione...</option>
                                            <option value="pacote">Pacote Ativo</option>
                                            <option value="avulso">Avulso</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="form-group" id="agendamento-pacote-select-group" style="display: none;">
                                        <label for="agendamento-pacote-id">Pacote Ativo</label>
                                        <select id="agendamento-pacote-id"></select>
                                    </div>

                                    <div class="form-group" id="agendamento-servico-avulso-select-group" style="display: none;">
                                        <label for="agendamento-servico-avulso">Serviço Avulso</label>
                                        <select id="agendamento-servico-avulso"></select>
                                    </div>

                                    <div class="form-group" style="flex: 1;">
                                        <label for="agendamento-data">Data</label>
                                        <input type="date" id="agendamento-data" required>
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label for="agendamento-hora">Hora</label>
                                        <input type="time" id="agendamento-hora" required>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="agendamento-observacoes">Observações</label>
                                    <textarea id="agendamento-observacoes"></textarea>
                                </div>
                                <div class="flex-container">
                                    <button type="submit" class="btn-primary">
                                        <span class="material-icons">schedule</span> Agendar
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div id="lista-agendamentos-pane" class="tab-pane">
                        <div class="section-header"><h2>Lista de Agendamentos</h2></div>
                        <div class="card">
                             <div class="filter-row">
                                <div style="flex: 2;">
                                    <label for="filtro-agendamento-cliente">Filtrar por Cliente</label>
                                    <input type="text" id="filtro-agendamento-cliente" onkeyup="filtrarAgendamentosTabela()">
                                </div>
                                <div>
                                    <label for="filtro-agendamento-data">Filtrar por Data</label>
                                    <input type="date" id="filtro-agendamento-data" onchange="filtrarAgendamentosTabela()">
                                </div>
                                <div>
                                    <label for="filtro-agendamento-status">Status</label>
                                    <select id="filtro-agendamento-status" onchange="filtrarAgendamentosTabela()">
                                        <option value="">Todos</option>
                                        <option value="pendente">Pendente</option>
                                        <option value="concluido">Concluído</option>
                                        <option value="cancelado">Cancelado</option>
                                    </select>
                                </div>
                                <button class="btn-secondary" onclick="resetFiltroAgendamento()">
                                    <span class="material-icons">clear</span> Limpar Filtros
                                </button>
                             </div>
                            
                            <div class="table-responsive">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Cliente</th>
                                            <th>Data</th>
                                            <th>Hora</th>
                                            <th>Serviço</th>
                                            <th>Tipo</th>
                                            <th>Status</th>
                                            <th class="action-buttons">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="lista-agendamentos">
                                        </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div id="visao-diaria-pane" class="tab-pane">
                        <div class="section-header">
                            <h2>Visão Diária da Agenda</h2>
                            <div class="input-group">
                                <label for="data-visao-diaria" style="display: none;">Data</label>
                                <input type="date" id="data-visao-diaria" onchange="renderizarVisaoDiaria(this.value)">
                                <button class="btn-secondary" onclick="mudarDiaVisaoDiaria(-1)"><span class="material-icons">chevron_left</span> Anterior</button>
                                <button class="btn-secondary" onclick="mudarDiaVisaoDiaria(1)">Próximo <span class="material-icons">chevron_right</span></button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="data-table" id="tabela-visao-diaria">
                                <thead>
                                    <tr>
                                        <th>Horário</th>
                                        <th>Detalhes do Agendamento</th>
                                    </tr>
                                </thead>
                                <tbody id="corpo-visao-diaria">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="clientes-section" class="content-section">
                <div class="section-header">
                    <h2>Clientes</h2>
                    <button class="btn-primary" onclick="mostrarFormularioCliente()">
                        <span class="material-icons">person_add</span> Adicionar Cliente
                    </button>
                </div>
                
                <div id="form-cliente-card" class="card" style="display: none;">
                    <h3><span id="form-cliente-titulo">Novo</span> Cliente</h3>
                    <form id="cliente-form">
                        <input type="hidden" id="cliente-id">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="cliente-nome">Nome</label>
                                <input type="text" id="cliente-nome" required>
                            </div>
                            <div class="form-group">
                                <label for="cliente-telefone">Telefone</label>
                                <input type="tel" id="cliente-telefone">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="cliente-email">E-mail</label>
                                <input type="email" id="cliente-email">
                            </div>
                            <div class="form-group">
                                <label for="cliente-nascimento">Data de Nascimento</label>
                                <input type="date" id="cliente-nascimento">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="cliente-observacoes">Observações</label>
                            <textarea id="cliente-observacoes"></textarea>
                        </div>
                        <div class="flex-container">
                            <div>
                                <button type="submit" class="btn-success">
                                    <span class="material-icons">save</span> Salvar Cliente
                                </button>
                                <button type="button" class="btn-secondary" onclick="cancelarEdicaoCliente()">
                                    <span class="material-icons">cancel</span> Cancelar
                                </button>
                            </div>
                            <button type="button" id="btn-cliente-historico" class="btn-info" style="display:none;" onclick="mostrarHistoricoCliente(document.getElementById('cliente-id').value)">
                                <span class="material-icons">history</span> Ver Histórico
                            </button>
                        </div>
                    </form>
                </div>
                
                <div class="card">
                     <div class="filter-row">
                        <div style="flex: 3;">
                            <label for="filtro-cliente-nome">Filtrar por Nome</label>
                            <input type="text" id="filtro-cliente-nome" onkeyup="filtrarClientes()">
                        </div>
                        <div>
                            <button class="btn-secondary" onclick="resetFiltroClientes()">
                                <span class="material-icons">clear</span> Limpar Filtro
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Telefone</th>
                                    <th>E-mail</th>
                                    <th>Nascimento</th>
                                    <th class="action-buttons">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="lista-clientes">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="servicos-section" class="content-section">
                <div class="section-header">
                    <h2>Serviços</h2>
                    <button class="btn-primary" onclick="mostrarFormularioServico()">
                        <span class="material-icons">local_offer</span> Adicionar Serviço
                    </button>
                </div>

                <div id="form-servico-card" class="card" style="display: none;">
                    <h3><span id="form-servico-titulo">Novo</span> Serviço</h3>
                    <form id="servico-form">
                        <input type="hidden" id="servico-id">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="servico-nome">Nome do Serviço</label>
                                <input type="text" id="servico-nome" required>
                            </div>
                            <div class="form-group">
                                <label for="servico-preco">Preço (R$)</label>
                                <input type="number" id="servico-preco" step="0.01" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="servico-duracao">Duração (Minutos)</label>
                                <input type="number" id="servico-duracao" required>
                            </div>
                            <div class="form-group">
                                <label for="servico-tipo">Tipo</label>
                                <select id="servico-tipo" required>
                                    <option value="avulso">Avulso</option>
                                    <option value="pacote">Pacote (Venda Múltipla)</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group" id="pacote-sessoes-group" style="display: none;">
                            <label for="pacote-sessoes">Número de Sessões no Pacote</label>
                            <input type="number" id="pacote-sessoes" min="2">
                        </div>
                        <div class="form-group">
                            <label for="servico-descricao">Descrição</label>
                            <textarea id="servico-descricao"></textarea>
                        </div>
                        <div class="flex-container">
                            <button type="submit" class="btn-success">
                                <span class="material-icons">save</span> Salvar Serviço
                            </button>
                            <button type="button" class="btn-secondary" onclick="cancelarEdicaoServico()">
                                <span class="material-icons">cancel</span> Cancelar
                            </button>
                        </div>
                    </form>
                </div>
                
                <div class="card">
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Serviço</th>
                                    <th>Preço (R$)</th>
                                    <th>Duração (Min)</th>
                                    <th>Tipo</th>
                                    <th>Descrição</th>
                                    <th class="action-buttons">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="lista-servicos">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="historico-section" class="content-section">
                <div class="section-header">
                    <h2>Histórico e Lucros</h2>
                </div>
                
                <div class="card">
                    <h3>Resumo Financeiro</h3>
                    <div class="form-row" style="gap: 30px;">
                        <div style="flex: 1; text-align: center; background-color: #f0f8ff; padding: 15px; border-radius: 8px;">
                            <p style="font-size: 0.9rem; margin: 0; color: var(--secondary-color);">Faturamento do Mês Atual</p>
                            <p id="faturamento-mensal" style="font-size: 1.8rem; font-weight: bold; color: var(--success-color);">R$ 0,00</p>
                        </div>
                        <div style="flex: 1; text-align: center; background-color: #f7fff7; padding: 15px; border-radius: 8px;">
                            <p style="font-size: 0.9rem; margin: 0; color: var(--secondary-color);">Total de Agendamentos Concluídos</p>
                            <p id="total-agendamentos" style="font-size: 1.8rem; font-weight: bold; color: var(--primary-color);">0</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>Detalhes do Histórico</h3>
                    <div class="filter-row">
                        <div style="flex: 2;">
                            <label for="filtro-historico-cliente">Filtrar por Cliente</label>
                            <input type="text" id="filtro-historico-cliente" onkeyup="filtrarHistoricoTabela()" list="clientes-datalist">
                        </div>
                         <div>
                            <label for="filtro-historico-mes">Filtrar por Mês/Ano</label>
                            <input type="month" id="filtro-historico-mes" onchange="renderizarHistorico()">
                        </div>
                        <button class="btn-secondary" onclick="resetFiltroHistorico()">
                            <span class="material-icons">clear</span> Limpar Filtros
                        </button>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Cliente</th>
                                    <th>Serviço</th>
                                    <th>Tipo</th>
                                    <th>Valor (R$)</th>
                                    <th>Status</th>
                                    <th class="action-buttons">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="lista-historico">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="historico-cliente-section" class="content-section">
                <div class="section-header">
                    <h2 id="historico-cliente-titulo">Histórico de Cliente</h2>
                    <button class="btn-secondary" onclick="showSection('historico')">
                        <span class="material-icons">arrow_back</span> Voltar ao Histórico Geral
                    </button>
                </div>
                
                <div class="card">
                    <h3>Detalhes de Agendamentos</h3>
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Serviço</th>
                                    <th>Tipo</th>
                                    <th>Valor (R$)</th>
                                    <th>Status</th>
                                    <th>Observações</th>
                                </tr>
                            </thead>
                            <tbody id="lista-historico-cliente">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        // Variáveis Globais de Controle
        const FIREBASE_CONFIG = {
            // FIREBASE CONFIGURAÇÃO
        };
        firebase.initializeApp(FIREBASE_CONFIG);
        const db = firebase.database();

        let clientes = {};
        let servicos = {};
        let agendamentos = {};
        let pacotesAtivos = {};
        let historico = {};
        
        const senhaAcesso = "tati123"; // Senha de acesso

        const TEMPO_MINUTOS = 30; // Intervalo de tempo para agendamentos (30 minutos)
        const HORA_INICIO = 8; // 8:00
        const HORA_FIM = 20; // 20:00

        // ----------------------------------------------------------------------------------
        // FUNÇÕES GLOBAIS
        // ----------------------------------------------------------------------------------

        // 1. Alterna entre as seções do APP
        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');

            // Atualiza a navegação lateral
            document.querySelectorAll('.sidebar ul li a').forEach(link => {
                link.classList.remove('active');
            });
            const activeLink = document.querySelector(`.sidebar ul li a[data-section="${sectionId.replace('-section', '')}"]`);
            if (activeLink) {
                activeLink.classList.add('active');
            }

            // Atualiza o conteúdo da seção se necessário (Ex: renderizar listas ao mudar)
            if (sectionId === 'agenda-section') {
                 // Mantém a aba ativa
                 const activeTab = document.querySelector('.tab-menu .tab-button.active');
                 const tabId = activeTab ? activeTab.getAttribute('onclick').match(/'([^']+)'/)[1] : 'pacotes-ativos';
                 showAgendaTab(tabId);
            } else if (sectionId === 'clientes-section') {
                renderizarClientes();
                cancelarEdicaoCliente();
            } else if (sectionId === 'servicos-section') {
                renderizarServicos();
                cancelarEdicaoServico();
            } else if (sectionId === 'historico-section') {
                renderizarHistorico();
            }
        }
        
        // 1.1. Alterna entre as abas da AGENDA
        window.showAgendaTab = function(tabName) {
            document.querySelectorAll('#agenda-section .tab-button').forEach(button => {
                button.classList.remove('active');
            });
            document.querySelector(`#agenda-section .tab-button[onclick*='${tabName}']`).classList.add('active');

            document.querySelectorAll('#agenda-section .tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });
            document.getElementById(`${tabName}-pane`).classList.add('active');

            // Chamadas de renderização específicas
            if (tabName === 'pacotes-ativos') {
                 renderizarPacotesAtivos();
            } else if (tabName === 'lista-agendamentos') {
                 renderizarAgendamentos();
            } else if (tabName === 'visao-diaria') {
                 // Define a data de hoje e renderiza a visão diária
                 const hoje = new Date().toISOString().split('T')[0];
                 document.getElementById('data-visao-diaria').value = hoje;
                 renderizarVisaoDiaria(hoje);
            }
        }
        
        // 2. Notificações
        function showNotification(message, type = 'info', duration = 3000) {
            const bar = document.getElementById('notification-bar');
            bar.textContent = message;
            bar.className = `show ${type}`; // Adiciona 'show' e o tipo (success, error, info)
            
            setTimeout(() => {
                bar.classList.remove('show');
            }, duration);
        }

        // 3. Formatação de Dados
        function formatarDataHora(dataString, horaString = null) {
            const data = new Date(dataString + (horaString ? 'T' + horaString + ':00' : ''));
            const dataFormatada = data.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
            
            if (horaString) {
                // A horaString já está no formato HH:mm
                return `${dataFormatada} às ${horaString}`;
            }
            return dataFormatada;
        }

        function formatarMoeda(valor) {
            return parseFloat(valor).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }
        
        // 4. Utilidades
        function generateUniqueId() {
            return db.ref().push().key;
        }

        function getClienteNome(clienteId) {
            return clientes[clienteId] ? clientes[clienteId].nome : 'Cliente Desconhecido';
        }

        function getServicoInfo(servicoId) {
            const servico = servicos[servicoId];
            return servico ? { 
                nome: servico.nome, 
                preco: servico.preco,
                duracao: servico.duracao,
                tipo: servico.tipo,
                sessoes: servico.sessoes || 1
            } : { nome: 'Serviço Desconhecido', preco: 0, duracao: 0, tipo: 'avulso', sessoes: 1 };
        }
        
        function getPacoteInfo(pacoteId) {
             return pacotesAtivos[pacoteId] ? pacotesAtivos[pacoteId] : null;
        }
        
        // ----------------------------------------------------------------------------------
        // FUNÇÕES DE PERSISTÊNCIA (FIREBASE)
        // ----------------------------------------------------------------------------------
        
        // 1. CARREGAR TODOS OS DADOS INICIAIS
        function carregarTodosOsDados() {
            return new Promise(resolve => {
                const promessas = [
                    db.ref('clientes').on('value', snapshot => { clientes = snapshot.val() || {}; preencherDatalistClientes(); }),
                    db.ref('servicos').on('value', snapshot => { servicos = snapshot.val() || {}; }),
                    db.ref('agendamentos').on('value', snapshot => { agendamentos = snapshot.val() || {}; }),
                    db.ref('pacotesAtivos').on('value', snapshot => { pacotesAtivos = snapshot.val() || {}; }),
                    db.ref('historico').on('value', snapshot => { historico = snapshot.val() || {}; })
                ];

                Promise.all(promessas.map(p => new Promise(r => r(p)))).then(() => {
                    showNotification('Dados carregados com sucesso!', 'info');
                    resolve();
                });
            });
        }
        
        // 2. SALVAR DADOS
        function salvarDados(ref, id, dados) {
            return db.ref(ref + '/' + id).set(dados)
                .then(() => true)
                .catch(error => {
                    showNotification('Erro ao salvar dados: ' + error.message, 'error');
                    return false;
                });
        }
        
        // 3. REMOVER DADOS
        function removerDados(ref, id) {
             return db.ref(ref + '/' + id).remove()
                .then(() => true)
                .catch(error => {
                    showNotification('Erro ao remover dados: ' + error.message, 'error');
                    return false;
                });
        }

        // 4. ATUALIZAR UM CAMPO ESPECÍFICO
        function atualizarCampo(ref, id, campo, valor) {
             return db.ref(ref + '/' + id + '/' + campo).set(valor)
                .then(() => true)
                .catch(error => {
                    showNotification('Erro ao atualizar campo: ' + error.message, 'error');
                    return false;
                });
        }

        // ----------------------------------------------------------------------------------
        // FUNÇÕES DE CLIENTES (CRUD E RENDERIZAÇÃO)
        // ----------------------------------------------------------------------------------
        
        // 1. FORM SUBMIT
        document.getElementById('cliente-form').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const id = document.getElementById('cliente-id').value || generateUniqueId();
            const dados = {
                nome: document.getElementById('cliente-nome').value,
                telefone: document.getElementById('cliente-telefone').value,
                email: document.getElementById('cliente-email').value,
                nascimento: document.getElementById('cliente-nascimento').value,
                observacoes: document.getElementById('cliente-observacoes').value
            };
            
            salvarDados('clientes', id, dados).then(success => {
                if (success) {
                    showNotification('Cliente salvo com sucesso!', 'success');
                    cancelarEdicaoCliente();
                    // renderizarClientes() é chamado automaticamente pela atualização do listener do Firebase
                }
            });
        });

        // 2. RENDERIZAÇÃO DA LISTA
        function renderizarClientes() {
            const lista = document.getElementById('lista-clientes');
            lista.innerHTML = '';
            
            const clientesArray = Object.keys(clientes).map(id => ({ id, ...clientes[id] }));
            
            if (clientesArray.length === 0) {
                 lista.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nenhum cliente cadastrado.</td></tr>';
                 return;
            }

            clientesArray.forEach(cliente => {
                const row = lista.insertRow();
                row.dataset.clienteId = cliente.id;
                row.dataset.clienteNome = cliente.nome.toLowerCase(); // Para filtragem

                // Rótulos para mobile
                row.insertCell().setAttribute('data-label', 'Nome');
                row.insertCell().setAttribute('data-label', 'Telefone');
                row.insertCell().setAttribute('data-label', 'E-mail');
                row.insertCell().setAttribute('data-label', 'Nascimento');
                const acoesCell = row.insertCell();
                acoesCell.classList.add('action-buttons');

                row.cells[0].textContent = cliente.nome;
                row.cells[1].textContent = cliente.telefone;
                row.cells[2].textContent = cliente.email;
                row.cells[3].textContent = cliente.nascimento ? formatarDataHora(cliente.nascimento) : '';

                // Botões de Ação
                acoesCell.innerHTML = `
                    <button class="btn-info" onclick="editarCliente('${cliente.id}')">
                        <span class="material-icons">edit</span> Editar
                    </button>
                    <button class="btn-secondary" onclick="mostrarHistoricoCliente('${cliente.id}')">
                        <span class="material-icons">history</span> Histórico
                    </button>
                    <button class="btn-danger" onclick="removerCliente('${cliente.id}')">
                        <span class="material-icons">delete</span> Excluir
                    </button>
                `;
            });
        }
        
        // 3. EDITAR
        window.editarCliente = function(id) {
            const cliente = clientes[id];
            if (cliente) {
                document.getElementById('cliente-id').value = id;
                document.getElementById('cliente-nome').value = cliente.nome;
                document.getElementById('cliente-telefone').value = cliente.telefone;
                document.getElementById('cliente-email').value = cliente.email;
                document.getElementById('cliente-nascimento').value = cliente.nascimento;
                document.getElementById('cliente-observacoes').value = cliente.observacoes;
                
                document.getElementById('form-cliente-titulo').textContent = 'Editar';
                document.getElementById('btn-cliente-historico').style.display = 'inline-flex';
                document.getElementById('form-cliente-card').style.display = 'block';
            }
        }
        
        // 4. REMOVER
        window.removerCliente = function(id) {
            if (confirm(`Tem certeza que deseja remover o cliente ${clientes[id].nome}? Todos os agendamentos e pacotes ligados a ele serão mantidos no histórico.`)) {
                removerDados('clientes', id).then(success => {
                    if (success) {
                        showNotification('Cliente removido com sucesso!', 'success');
                        // renderizarClientes() é chamado automaticamente
                    }
                });
            }
        }
        
        // 5. MOSTRAR FORMULÁRIO (Novo)
        window.mostrarFormularioCliente = function() {
            document.getElementById('cliente-form').reset();
            document.getElementById('cliente-id').value = '';
            document.getElementById('form-cliente-titulo').textContent = 'Novo';
            document.getElementById('btn-cliente-historico').style.display = 'none';
            document.getElementById('form-cliente-card').style.display = 'block';
        }
        
        // 6. CANCELAR EDIÇÃO
        window.cancelarEdicaoCliente = function() {
             document.getElementById('form-cliente-card').style.display = 'none';
             document.getElementById('cliente-form').reset();
        }

        // 7. PREENCHER DATALIST PARA FORMULÁRIOS DE AGENDAMENTO
        function preencherDatalistClientes() {
             const datalist = document.getElementById('clientes-datalist');
             datalist.innerHTML = '';
             Object.keys(clientes).forEach(id => {
                 const cliente = clientes[id];
                 const option = document.createElement('option');
                 option.value = cliente.nome;
                 option.setAttribute('data-id', id);
                 datalist.appendChild(option);
             });
        }
        
        // 8. FILTRAR CLIENTES NA TABELA
        window.filtrarClientes = function() {
             const filtro = document.getElementById('filtro-cliente-nome').value.toLowerCase();
             const listaClientes = document.getElementById('lista-clientes');
             const linhas = listaClientes.getElementsByTagName('tr');

             for (let i = 0; i < linhas.length; i++) {
                 const row = linhas[i];
                 const clienteNome = row.dataset.clienteNome;
                
                 if (clienteNome && clienteNome.includes(filtro)) {
                     row.style.display = "";
                 } else if (clienteNome) {
                     row.style.display = "none";
                 }
             }
        }
        
        // 9. RESETAR FILTRO DE CLIENTES
        window.resetFiltroClientes = function() {
            document.getElementById('filtro-cliente-nome').value = '';
            filtrarClientes();
        }
        
        // ----------------------------------------------------------------------------------
        // FUNÇÕES DE SERVIÇOS (CRUD E RENDERIZAÇÃO)
        // ----------------------------------------------------------------------------------
        
        // 1. FORM SUBMIT
        document.getElementById('servico-form').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const id = document.getElementById('servico-id').value || generateUniqueId();
            const tipo = document.getElementById('servico-tipo').value;
            const dados = {
                nome: document.getElementById('servico-nome').value,
                preco: parseFloat(document.getElementById('servico-preco').value),
                duracao: parseInt(document.getElementById('servico-duracao').value),
                tipo: tipo,
                descricao: document.getElementById('servico-descricao').value,
            };
            
            if (tipo === 'pacote') {
                 const sessoes = parseInt(document.getElementById('pacote-sessoes').value);
                 if (sessoes < 2 || isNaN(sessoes)) {
                      showNotification('Pacotes devem ter no mínimo 2 sessões.', 'error');
                      return;
                 }
                 dados.sessoes = sessoes;
            } else {
                 dados.sessoes = 1; // Para fins de consistência
            }
            
            salvarDados('servicos', id, dados).then(success => {
                if (success) {
                    showNotification('Serviço salvo com sucesso!', 'success');
                    cancelarEdicaoServico();
                    // renderizarServicos() é chamado automaticamente
                }
            });
        });
        
        // 1.1. CONTROLE DE CAMPO PACOTE
        document.getElementById('servico-tipo').addEventListener('change', (e) => {
             const group = document.getElementById('pacote-sessoes-group');
             if (e.target.value === 'pacote') {
                 group.style.display = 'block';
                 document.getElementById('pacote-sessoes').setAttribute('required', 'required');
             } else {
                 group.style.display = 'none';
                 document.getElementById('pacote-sessoes').removeAttribute('required');
             }
        });

        // 2. RENDERIZAÇÃO DA LISTA
        function renderizarServicos() {
            const lista = document.getElementById('lista-servicos');
            lista.innerHTML = '';
            
            const servicosArray = Object.keys(servicos).map(id => ({ id, ...servicos[id] }));
            
            if (servicosArray.length === 0) {
                 lista.innerHTML = '<tr><td colspan="6" style="text-align: center;">Nenhum serviço cadastrado.</td></tr>';
                 return;
            }

            servicosArray.forEach(servico => {
                const row = lista.insertRow();
                row.dataset.servicoId = servico.id;

                // Rótulos para mobile
                row.insertCell().setAttribute('data-label', 'Serviço');
                row.insertCell().setAttribute('data-label', 'Preço');
                row.insertCell().setAttribute('data-label', 'Duração');
                row.insertCell().setAttribute('data-label', 'Tipo');
                row.insertCell().setAttribute('data-label', 'Descrição');
                const acoesCell = row.insertCell();
                acoesCell.classList.add('action-buttons');
                
                const tipoTexto = servico.tipo === 'pacote' ? 
                    `Pacote (${servico.sessoes} Sessões)` : 'Avulso';

                row.cells[0].textContent = servico.nome;
                row.cells[1].textContent = formatarMoeda(servico.preco);
                row.cells[2].textContent = `${servico.duracao} min`;
                row.cells[3].textContent = tipoTexto;
                row.cells[4].textContent = servico.descricao;

                // Botões de Ação
                acoesCell.innerHTML = `
                    <button class="btn-info" onclick="editarServico('${servico.id}')">
                        <span class="material-icons">edit</span> Editar
                    </button>
                    <button class="btn-danger" onclick="removerServico('${servico.id}')">
                        <span class="material-icons">delete</span> Excluir
                    </button>
                `;
            });
            
            // Preenche os selects de serviço em "Pacotes Ativos" e "Novo Agendamento"
            preencherSelectsServicos();
        }
        
        // 3. EDITAR
        window.editarServico = function(id) {
            const servico = servicos[id];
            if (servico) {
                document.getElementById('servico-id').value = id;
                document.getElementById('servico-nome').value = servico.nome;
                document.getElementById('servico-preco').value = servico.preco;
                document.getElementById('servico-duracao').value = servico.duracao;
                document.getElementById('servico-tipo').value = servico.tipo;
                document.getElementById('servico-descricao').value = servico.descricao;
                
                if (servico.tipo === 'pacote') {
                     document.getElementById('pacote-sessoes').value = servico.sessoes;
                     document.getElementById('pacote-sessoes-group').style.display = 'block';
                } else {
                     document.getElementById('pacote-sessoes').value = '';
                     document.getElementById('pacote-sessoes-group').style.display = 'none';
                }
                
                document.getElementById('form-servico-titulo').textContent = 'Editar';
                document.getElementById('form-servico-card').style.display = 'block';
            }
        }
        
        // 4. REMOVER
        window.removerServico = function(id) {
            if (confirm(`Tem certeza que deseja remover o serviço ${servicos[id].nome}?`)) {
                removerDados('servicos', id).then(success => {
                    if (success) {
                        showNotification('Serviço removido com sucesso!', 'success');
                        // renderizarServicos() é chamado automaticamente
                    }
                });
            }
        }
        
        // 5. MOSTRAR FORMULÁRIO (Novo)
        window.mostrarFormularioServico = function() {
            document.getElementById('servico-form').reset();
            document.getElementById('servico-id').value = '';
            document.getElementById('form-servico-titulo').textContent = 'Novo';
            document.getElementById('pacote-sessoes-group').style.display = 'none';
            document.getElementById('form-servico-card').style.display = 'block';
        }
        
        // 6. CANCELAR EDIÇÃO
        window.cancelarEdicaoServico = function() {
             document.getElementById('form-servico-card').style.display = 'none';
             document.getElementById('servico-form').reset();
        }
        
        // 7. PREENCHE OS SELECTS DE SERVIÇOS
        function preencherSelectsServicos() {
            const selectPacote = document.getElementById('pacote-servico-id');
            const selectAvulso = document.getElementById('agendamento-servico-avulso');
            selectPacote.innerHTML = '<option value="">Selecione...</option>';
            selectAvulso.innerHTML = '<option value="">Selecione...</option>';
            
            Object.keys(servicos).forEach(id => {
                const servico = servicos[id];
                if (servico.tipo === 'pacote') {
                    selectPacote.innerHTML += `<option value="${id}">${servico.nome} (${servico.sessoes} Sessões) - ${formatarMoeda(servico.preco)}</option>`;
                } else if (servico.tipo === 'avulso') {
                    selectAvulso.innerHTML += `<option value="${id}">${servico.nome} (${servico.duracao} min) - ${formatarMoeda(servico.preco)}</option>`;
                }
            });
        }
        
        // ----------------------------------------------------------------------------------
        // FUNÇÕES DE PACOTES ATIVOS (CRUD E RENDERIZAÇÃO)
        // ----------------------------------------------------------------------------------

        // 1. PREENCHE OS SELECTS DE CLIENTES PARA INICIAR PACOTES
        function preencherSelectsClientesParaPacote() {
             const selectCliente = document.getElementById('pacote-cliente-id');
             selectCliente.innerHTML = '<option value="">Selecione...</option>';
             Object.keys(clientes).forEach(id => {
                 const cliente = clientes[id];
                 selectCliente.innerHTML += `<option value="${id}">${cliente.nome}</option>`;
             });
        }

        // 2. FORM SUBMIT (Iniciar Novo Pacote)
        document.getElementById('pacote-inicio-form').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const clienteId = document.getElementById('pacote-cliente-id').value;
            const servicoId = document.getElementById('pacote-servico-id').value;
            const dataInicio = document.getElementById('pacote-data-inicio').value;
            
            if (!clienteId || !servicoId || !dataInicio) {
                 showNotification('Preencha todos os campos obrigatórios para iniciar o pacote.', 'error');
                 return;
            }
            
            const servicoInfo = getServicoInfo(servicoId);
            const id = generateUniqueId();

            const dados = {
                clienteId: clienteId,
                servicoId: servicoId,
                nomePacote: servicoInfo.nome,
                dataInicio: dataInicio,
                totalSessoes: servicoInfo.sessoes,
                sessoesRestantes: servicoInfo.sessoes,
                valorTotal: servicoInfo.preco,
                status: 'ativo' // ativo, finalizado, pago, pendente_pagamento
            };
            
            salvarDados('pacotesAtivos', id, dados).then(success => {
                if (success) {
                    showNotification('Pacote iniciado com sucesso!', 'success');
                    document.getElementById('pacote-inicio-form').reset();
                    // renderizarPacotesAtivos() é chamado automaticamente
                }
            });
        });

        // 3. RENDERIZAÇÃO DA LISTA DE PACOTES ATIVOS
        function renderizarPacotesAtivos() {
             const lista = document.getElementById('lista-pacotes-ativos');
             lista.innerHTML = '';
             
             // Garante que os selects de clientes e serviços estejam preenchidos antes de renderizar
             preencherSelectsClientesParaPacote();
             preencherSelectsServicos();
             
             const pacotesArray = Object.keys(pacotesAtivos)
                .map(id => ({ id, ...pacotesAtivos[id] }))
                .filter(p => p.status !== 'finalizado'); // Filtra apenas ativos/pendentes
                
             if (pacotesArray.length === 0) {
                 lista.innerHTML = '<tr><td colspan="6" style="text-align: center;">Nenhum pacote ativo no momento.</td></tr>';
                 return;
             }

             pacotesArray.forEach(pacote => {
                 const clienteNome = getClienteNome(pacote.clienteId);
                 const statusClass = `status-package-${pacote.status.replace('_', '-')}`;
                 
                 const row = lista.insertRow();
                 row.dataset.pacoteId = pacote.id;
                 
                 // Rótulos para mobile
                 row.insertCell().setAttribute('data-label', 'Cliente');
                 row.insertCell().setAttribute('data-label', 'Pacote');
                 row.insertCell().setAttribute('data-label', 'Total Sessões');
                 row.insertCell().setAttribute('data-label', 'Sessões Restantes');
                 row.insertCell().setAttribute('data-label', 'Status');
                 const acoesCell = row.insertCell();
                 acoesCell.classList.add('action-buttons');
                 
                 row.cells[0].textContent = clienteNome;
                 row.cells[1].textContent = pacote.nomePacote;
                 row.cells[2].textContent = pacote.totalSessoes;
                 row.cells[3].textContent = pacote.sessoesRestantes;
                 row.cells[4].innerHTML = `<span class="${statusClass}">${pacote.status.toUpperCase()}</span>`;
                 
                 let acoesHtml = '';
                 
                 if (pacote.status === 'ativo') {
                      acoesHtml += `
                         <button class="btn-success" onclick="marcarPacoteComoPago('${pacote.id}')">
                            <span class="material-icons">payments</span> Marcar como Pago
                         </button>
                      `;
                 } else if (pacote.status === 'pendente_pagamento') {
                      acoesHtml += `
                         <button class="btn-warning" onclick="marcarPacoteComoPago('${pacote.id}')">
                            <span class="material-icons">payments</span> Receber Pagamento
                         </button>
                      `;
                 } else if (pacote.status === 'pago') {
                      acoesHtml += `
                         <button class="btn-info" disabled>
                            <span class="material-icons">check_circle</span> Pago
                         </button>
                      `;
                 }
                 
                 acoesHtml += `
                     <button class="btn-danger" onclick="removerPacote('${pacote.id}')">
                         <span class="material-icons">delete</span> Excluir
                     </button>
                 `;
                 
                 acoesCell.innerHTML = acoesHtml;
             });
             
             // Preenche o select de Pacote Ativo no Novo Agendamento
             preencherSelectPacoteAgendamento(pacotesArray);
        }
        
        // 4. MARCAR PACOTE COMO PAGO
        window.marcarPacoteComoPago = function(id) {
             if (confirm('Tem certeza que deseja marcar este pacote como PAGO?')) {
                 atualizarCampo('pacotesAtivos', id, 'status', 'pago').then(success => {
                     if (success) {
                         showNotification('Status do pacote atualizado para PAGO!', 'success');
                         // renderizarPacotesAtivos() é chamado automaticamente
                     }
                 });
             }
        }
        
        // 5. REMOVER PACOTE
        window.removerPacote = function(id) {
            if (confirm(`Tem certeza que deseja remover o pacote ${pacotesAtivos[id].nomePacote} do cliente ${getClienteNome(pacotesAtivos[id].clienteId)}? Essa ação é irreversível e afetará os agendamentos futuros.`)) {
                removerDados('pacotesAtivos', id).then(success => {
                    if (success) {
                        showNotification('Pacote removido com sucesso!', 'success');
                        // renderizarPacotesAtivos() é chamado automaticamente
                    }
                });
            }
        }

        // ----------------------------------------------------------------------------------
        // FUNÇÕES DE AGENDAMENTOS (CRUD E RENDERIZAÇÃO)
        // ----------------------------------------------------------------------------------
        
        // 1. CONTROLE DO SELECT DE TIPO DE SERVIÇO (Pacote vs Avulso)
        document.getElementById('agendamento-servico-tipo').addEventListener('change', (e) => {
            const tipo = e.target.value;
            const pacoteGroup = document.getElementById('agendamento-pacote-select-group');
            const avulsoGroup = document.getElementById('agendamento-servico-avulso-select-group');
            const selectPacote = document.getElementById('agendamento-pacote-id');
            const selectAvulso = document.getElementById('agendamento-servico-avulso');

            if (tipo === 'pacote') {
                pacoteGroup.style.display = 'block';
                avulsoGroup.style.display = 'none';
                selectPacote.setAttribute('required', 'required');
                selectAvulso.removeAttribute('required');
            } else if (tipo === 'avulso') {
                pacoteGroup.style.display = 'none';
                avulsoGroup.style.display = 'block';
                selectPacote.removeAttribute('required');
                selectAvulso.setAttribute('required', 'required');
            } else {
                pacoteGroup.style.display = 'none';
                avulsoGroup.style.display = 'none';
                selectPacote.removeAttribute('required');
                selectAvulso.removeAttribute('required');
            }
        });
        
        // 2. PREENCHE SELECT DE PACOTES ATIVOS NO FORM DE AGENDAMENTO
        function preencherSelectPacoteAgendamento(pacotesArray) {
            const selectPacote = document.getElementById('agendamento-pacote-id');
            selectPacote.innerHTML = '<option value="">Selecione um Pacote Ativo...</option>';
            
            if (pacotesArray.length === 0) return;
            
            pacotesArray
                .filter(p => p.sessoesRestantes > 0 && p.status !== 'finalizado')
                .forEach(pacote => {
                    const clienteNome = getClienteNome(pacote.clienteId);
                    selectPacote.innerHTML += `<option value="${pacote.id}" data-cliente-id="${pacote.clienteId}">
                         ${clienteNome} - ${pacote.nomePacote} (${pacote.sessoesRestantes} restantes)
                    </option>`;
                });
        }
        
        // 2.1. ATUALIZA O CLIENTE NO FORM DE AGENDAMENTO QUANDO SELECIONA UM PACOTE
        document.getElementById('agendamento-pacote-id').addEventListener('change', (e) => {
             const selectedOption = e.target.options[e.target.selectedIndex];
             const clienteId = selectedOption.dataset.clienteId;
             
             if (clienteId) {
                  const clienteNome = getClienteNome(clienteId);
                  document.getElementById('agendamento-cliente').value = clienteNome;
                  document.getElementById('agendamento-cliente-id').value = clienteId;
             }
        });

        // 3. FORM SUBMIT (Novo Agendamento)
        document.getElementById('novo-agendamento-form').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const tipoServico = document.getElementById('agendamento-servico-tipo').value;
            let servicoId, pacoteId = null, valor = 0, duracao = 0, clienteId, nomeServico;

            // 3.1. Obtém Cliente ID
            const clienteInput = document.getElementById('agendamento-cliente').value;
            const clienteOption = document.querySelector(`#clientes-datalist option[value="${clienteInput}"]`);
            
            if (clienteOption) {
                 clienteId = clienteOption.dataset.id;
            } else {
                 showNotification('Cliente não encontrado na lista. Por favor, selecione um cliente válido.', 'error');
                 return;
            }
            document.getElementById('agendamento-cliente-id').value = clienteId; // Garante que o hidden campo esteja preenchido
            
            // 3.2. Obtém Serviço/Pacote
            if (tipoServico === 'pacote') {
                pacoteId = document.getElementById('agendamento-pacote-id').value;
                const pacote = getPacoteInfo(pacoteId);
                servicoId = pacote.servicoId;
                nomeServico = pacote.nomePacote;
                
                const servicoInfo = getServicoInfo(servicoId);
                duracao = servicoInfo.duracao;
                // Valor é 0, pois já foi pago no pacote (ou será cobrado do pacote)
                // Usamos o valor dividido para fins de relatório/histórico, mas para o agendamento em si, é 0.
                valor = pacote.valorTotal / pacote.totalSessoes; 

            } else if (tipoServico === 'avulso') {
                servicoId = document.getElementById('agendamento-servico-avulso').value;
                const servicoInfo = getServicoInfo(servicoId);
                nomeServico = servicoInfo.nome;
                valor = servicoInfo.preco;
                duracao = servicoInfo.duracao;
            } else {
                 showNotification('Tipo de serviço inválido.', 'error');
                 return;
            }

            const id = generateUniqueId();
            const dados = {
                clienteId: clienteId,
                servicoId: servicoId,
                pacoteId: pacoteId,
                nomeServico: nomeServico,
                data: document.getElementById('agendamento-data').value,
                hora: document.getElementById('agendamento-hora').value,
                valor: valor,
                duracao: duracao,
                observacoes: document.getElementById('agendamento-observacoes').value,
                status: 'pendente', // pendente, concluido, cancelado
                criadoEm: new Date().toISOString()
            };
            
            salvarDados('agendamentos', id, dados).then(success => {
                if (success) {
                    showNotification('Agendamento criado com sucesso!', 'success');
                    document.getElementById('novo-agendamento-form').reset();
                    document.getElementById('agendamento-pacote-select-group').style.display = 'none';
                    document.getElementById('agendamento-servico-avulso-select-group').style.display = 'none';
                    // renderizarAgendamentos() e renderizarVisaoDiaria() são chamados automaticamente
                }
            });
        });

        // 4. RENDERIZAÇÃO DA LISTA DE AGENDAMENTOS
        function renderizarAgendamentos() {
             const lista = document.getElementById('lista-agendamentos');
             lista.innerHTML = '';
             
             const agendamentosArray = Object.keys(agendamentos)
                .map(id => ({ id, ...agendamentos[id] }))
                .sort((a, b) => new Date(a.data + 'T' + a.hora) - new Date(b.data + 'T' + b.hora));
                
             if (agendamentosArray.length === 0) {
                 lista.innerHTML = '<tr><td colspan="7" style="text-align: center;">Nenhum agendamento cadastrado.</td></tr>';
                 return;
             }

             agendamentosArray.forEach(agendamento => {
                 const clienteNome = getClienteNome(agendamento.clienteId);
                 const tipoServico = agendamento.pacoteId ? 'Pacote' : 'Avulso';
                 
                 const row = lista.insertRow();
                 row.dataset.clienteNome = clienteNome.toLowerCase(); // Para filtragem
                 row.dataset.data = agendamento.data;
                 row.dataset.status = agendamento.status;
                 
                 // Rótulos para mobile
                 row.insertCell().setAttribute('data-label', 'Cliente');
                 row.insertCell().setAttribute('data-label', 'Data');
                 row.insertCell().setAttribute('data-label', 'Hora');
                 row.insertCell().setAttribute('data-label', 'Serviço');
                 row.insertCell().setAttribute('data-label', 'Tipo');
                 row.insertCell().setAttribute('data-label', 'Status');
                 const acoesCell = row.insertCell();
                 acoesCell.classList.add('action-buttons');
                 
                 row.cells[0].textContent = clienteNome;
                 row.cells[1].textContent = formatarDataHora(agendamento.data);
                 row.cells[2].textContent = agendamento.hora;
                 row.cells[3].textContent = agendamento.nomeServico;
                 row.cells[4].textContent = tipoServico;
                 row.cells[5].textContent = agendamento.status.toUpperCase();
                 
                 let acoesHtml = '';
                 if (agendamento.status === 'pendente') {
                      acoesHtml += `
                         <button class="btn-success" onclick="concluirAgendamento('${agendamento.id}')">
                            <span class="material-icons">check_circle</span> Concluir
                         </button>
                         <button class="btn-warning" onclick="cancelarAgendamento('${agendamento.id}')">
                            <span class="material-icons">cancel</span> Cancelar
                         </button>
                      `;
                 } else if (agendamento.status === 'concluido') {
                       acoesHtml += `
                         <button class="btn-secondary" onclick="reverterConclusaoAgendamento('${agendamento.id}')">
                            <span class="material-icons">undo</span> Reverter
                         </button>
                       `;
                 }
                 
                 acoesHtml += `
                     <button class="btn-danger" onclick="removerAgendamento('${agendamento.id}')">
                         <span class="material-icons">delete</span> Excluir
                     </button>
                 `;
                 
                 acoesCell.innerHTML = acoesHtml;
             });
             
             // Aplica o filtro atual após a renderização
             filtrarAgendamentosTabela();
        }
        
        // 5. FILTRAR AGENDAMENTOS NA TABELA
        window.filtrarAgendamentosTabela = function() {
             const filtroCliente = document.getElementById('filtro-agendamento-cliente').value.toLowerCase();
             const filtroData = document.getElementById('filtro-agendamento-data').value;
             const filtroStatus = document.getElementById('filtro-agendamento-status').value;

             const listaAgendamentos = document.getElementById('lista-agendamentos');
             const linhas = listaAgendamentos.getElementsByTagName('tr');

             for (let i = 0; i < linhas.length; i++) {
                 const row = linhas[i];
                 const clienteNome = row.dataset.clienteNome;
                 const data = row.dataset.data;
                 const status = row.dataset.status;
                
                 let mostrar = true;
                 
                 if (filtroCliente && (!clienteNome || !clienteNome.includes(filtroCliente))) {
                     mostrar = false;
                 }
                 
                 if (filtroData && data !== filtroData) {
                     mostrar = false;
                 }
                 
                 if (filtroStatus && status !== filtroStatus) {
                     mostrar = false;
                 }
                
                 row.style.display = mostrar ? "" : "none";
             }
        }
        
        // 5.1. RESETAR FILTRO DO AGENDAMENTO
        window.resetFiltroAgendamento = function() {
            document.getElementById('filtro-agendamento-cliente').value = '';
            document.getElementById('filtro-agendamento-data').value = '';
            document.getElementById('filtro-agendamento-status').value = '';
            renderizarAgendamentos(); // Chama a renderização que irá aplicar o filtro (vazio)
        }
        
        // 6. REMOVER AGENDAMENTO
        window.removerAgendamento = function(id) {
            const agendamento = agendamentos[id];
            if (confirm(`Tem certeza que deseja remover o agendamento de ${getClienteNome(agendamento.clienteId)} para ${formatarDataHora(agendamento.data, agendamento.hora)}?`)) {
                removerDados('agendamentos', id).then(success => {
                    if (success) {
                        showNotification('Agendamento removido com sucesso!', 'success');
                        // Os renders são chamados automaticamente
                    }
                });
            }
        }
        
        // 7. CONCLUIR AGENDAMENTO
        window.concluirAgendamento = function(id) {
            const agendamento = agendamentos[id];
            if (agendamento.status !== 'pendente') {
                 showNotification('Agendamento já está concluído ou cancelado.', 'warning');
                 return;
            }
            
            const novoHistoricoId = generateUniqueId();
            const dadosHistorico = {
                 agendamentoId: id,
                 clienteId: agendamento.clienteId,
                 dataHora: agendamento.data + ' ' + agendamento.hora,
                 nomeServico: agendamento.nomeServico,
                 valor: agendamento.valor,
                 pacoteId: agendamento.pacoteId || null,
                 status: 'concluido'
            };

            // 7.1. Transação para Concluir Agendamento e Salvar Histórico
            const updates = {};
            updates['/agendamentos/' + id + '/status'] = 'concluido';
            updates['/historico/' + novoHistoricoId] = dadosHistorico;

            // 7.2. Se for um pacote, decrementa sessoesRestantes
            if (agendamento.pacoteId) {
                 const pacote = pacotesAtivos[agendamento.pacoteId];
                 if (pacote && pacote.sessoesRestantes > 0) {
                      const novasSessoesRestantes = pacote.sessoesRestantes - 1;
                      updates['/pacotesAtivos/' + agendamento.pacoteId + '/sessoesRestantes'] = novasSessoesRestantes;
                      
                      if (novasSessoesRestantes === 0) {
                           // Marca o pacote como finalizado
                           updates['/pacotesAtivos/' + agendamento.pacoteId + '/status'] = 'finalizado';
                      }
                 }
            }
            
            db.ref().update(updates)
                 .then(() => {
                      showNotification('Agendamento concluído e histórico salvo!', 'success');
                      // Os renders são chamados automaticamente pelos listeners do Firebase
                 })
                 .catch(error => {
                      showNotification('Erro ao concluir agendamento: ' + error.message, 'error');
                 });
        }
        
        // 8. CANCELAR AGENDAMENTO
        window.cancelarAgendamento = function(id) {
            const agendamento = agendamentos[id];
            if (agendamento.status !== 'pendente') {
                 showNotification('Agendamento já está concluído ou cancelado.', 'warning');
                 return;
            }
            
            if (confirm(`Tem certeza que deseja CANCELAR o agendamento de ${getClienteNome(agendamento.clienteId)}?`)) {
                 atualizarCampo('agendamentos', id, 'status', 'cancelado').then(success => {
                     if (success) {
                         showNotification('Agendamento cancelado com sucesso!', 'info');
                     }
                 });
            }
        }
        
        // 9. REVERTER CONCLUSÃO
        window.reverterConclusaoAgendamento = function(id) {
            const agendamento = agendamentos[id];
            if (agendamento.status !== 'concluido') return;
            
            if (confirm('Tem certeza que deseja REVERTER a conclusão deste agendamento? Ele voltará a ser "pendente" e a sessão do pacote (se houver) será restituída.')) {
                
                // 9.1. Encontra e remove a entrada no histórico
                const historicoEntry = Object.keys(historico).find(key => historico[key].agendamentoId === id);
                
                const updates = {};
                updates['/agendamentos/' + id + '/status'] = 'pendente';
                
                if (historicoEntry) {
                     updates['/historico/' + historicoEntry] = null;
                }
                
                // 9.2. Se for um pacote, incrementa sessoesRestantes
                if (agendamento.pacoteId) {
                     const pacote = pacotesAtivos[agendamento.pacoteId];
                     if (pacote) {
                          const novasSessoesRestantes = pacote.sessoesRestantes + 1;
                          updates['/pacotesAtivos/' + agendamento.pacoteId + '/sessoesRestantes'] = novasSessoesRestantes;
                          
                          // Se o pacote estava finalizado, retorna para ativo
                          if (pacote.status === 'finalizado') {
                               updates['/pacotesAtivos/' + agendamento.pacoteId + '/status'] = 'ativo';
                          }
                     }
                }
                
                db.ref().update(updates)
                     .then(() => {
                          showNotification('Conclusão revertida com sucesso!', 'info');
                     })
                     .catch(error => {
                          showNotification('Erro ao reverter: ' + error.message, 'error');
                     });
            }
        }
        
        // 10. VISÃO DIÁRIA
        window.mudarDiaVisaoDiaria = function(dias) {
             const inputData = document.getElementById('data-visao-diaria');
             const dataAtual = new Date(inputData.value + 'T00:00:00'); // Garante que a hora seja 00:00:00
             dataAtual.setDate(dataAtual.getDate() + dias);
             
             const novaData = dataAtual.toISOString().split('T')[0];
             inputData.value = novaData;
             renderizarVisaoDiaria(novaData);
        }
        
        window.renderizarVisaoDiaria = function(dataFiltro) {
            const corpoTabela = document.getElementById('corpo-visao-diaria');
            corpoTabela.innerHTML = '';
            
            const agendamentosDoDia = Object.keys(agendamentos)
                .map(id => ({ id, ...agendamentos[id] }))
                .filter(a => a.data === dataFiltro && a.status !== 'cancelado') // Ignora cancelados
                .sort((a, b) => a.hora.localeCompare(b.hora));

            const horarios = {}; // Mapa para rastrear horários ocupados
            
            // Preenche o mapa de horários
            agendamentosDoDia.forEach(agendamento => {
                const [h, m] = agendamento.hora.split(':').map(Number);
                const duracaoMinutos = agendamento.duracao || 30; // Garante uma duração mínima
                
                // Itera por todos os blocos de 30 minutos que o agendamento ocupa
                let tempoAtual = new Date(agendamento.data + 'T' + agendamento.hora + ':00');
                let fimAgendamento = new Date(tempoAtual.getTime() + duracaoMinutos * 60000);
                
                while (tempoAtual < fimAgendamento) {
                    const horaChave = tempoAtual.toTimeString().substring(0, 5);
                    horarios[horaChave] = { 
                        agendamento,
                        isInicio: horaChave === agendamento.hora // Marca o início do agendamento
                    };
                    tempoAtual = new Date(tempoAtual.getTime() + TEMPO_MINUTOS * 60000);
                }
            });

            // Cria as linhas da tabela
            for (let h = HORA_INICIO; h < HORA_FIM; h++) {
                for (let m = 0; m < 60; m += TEMPO_MINUTOS) {
                    const horaStr = String(h).padStart(2, '0');
                    const minStr = String(m).padStart(2, '0');
                    const chave = `${horaStr}:${minStr}`;

                    const row = corpoTabela.insertRow();
                    row.insertCell().textContent = chave;
                    row.cells[0].classList.add('horario-celula');

                    const agendamentoInfo = horarios[chave];
                    const celulaDetalhe = row.insertCell();

                    if (agendamentoInfo) {
                        const agendamento = agendamentoInfo.agendamento;
                        const clienteNome = getClienteNome(agendamento.clienteId);
                        const tipo = agendamento.pacoteId ? 'Pacote' : 'Avulso';
                        
                        // Ocupa múltiplas células se não for o bloco inicial
                        if (!agendamentoInfo.isInicio) {
                            row.style.display = 'none'; // Esconde a linha que é continuação
                            continue;
                        }
                        
                        // Calcula quantas linhas o agendamento ocupa
                        const duracaoBlocos = Math.ceil((agendamento.duracao || 30) / TEMPO_MINUTOS);
                        celulaDetalhe.setAttribute('rowspan', duracaoBlocos);
                        
                        // Conteúdo do agendamento
                        const statusClass = agendamento.status === 'concluido' ? 'status-package-paid' : 'status-package-active';
                        
                        celulaDetalhe.classList.add('agendamento-ocupado');
                        celulaDetalhe.setAttribute('title', agendamento.observacoes || 'Sem observações.');
                        celulaDetalhe.innerHTML = `
                             <strong>${clienteNome}</strong> - ${agendamento.nomeServico}<br>
                             <span>Tipo: ${tipo}</span> | <span class="${statusClass}">${agendamento.status.toUpperCase()}</span>
                        `;
                        celulaDetalhe.onclick = () => {
                             // Abre a lista de agendamentos e filtra para este cliente/data (Opcional, mas útil)
                             document.getElementById('filtro-agendamento-data').value = agendamento.data;
                             document.getElementById('filtro-agendamento-cliente').value = clienteNome;
                             showAgendaTab('lista-agendamentos');
                        };
                        
                    } else {
                        celulaDetalhe.classList.add('agendamento-vago');
                        celulaDetalhe.textContent = 'Vago';
                        
                        // Permite agendar rapidamente (opcional)
                        celulaDetalhe.onclick = () => {
                             document.getElementById('agendamento-data').value = dataFiltro;
                             document.getElementById('agendamento-hora').value = chave;
                             showAgendaTab('novo-agendamento');
                        };
                    }
                }
            }
        }
        
        // ----------------------------------------------------------------------------------
        // FUNÇÕES DE HISTÓRICO / LUCROS
        // ----------------------------------------------------------------------------------

        // 1. RENDERIZAÇÃO DA LISTA E RESUMO
        function renderizarHistorico() {
             const lista = document.getElementById('lista-historico');
             lista.innerHTML = '';
             
             const filtroMesAno = document.getElementById('filtro-historico-mes').value;
             let faturamentoMensal = 0;
             let totalAgendamentos = 0;

             const historicoArray = Object.keys(historico)
                .map(id => ({ id, ...historico[id] }))
                .filter(h => h.status === 'concluido')
                .sort((a, b) => new Date(b.dataHora) - new Date(a.dataHora));
                
             if (historicoArray.length === 0) {
                 lista.innerHTML = '<tr><td colspan="7" style="text-align: center;">Nenhum histórico de agendamento concluído.</td></tr>';
                 document.getElementById('faturamento-mensal').textContent = formatarMoeda(0);
                 document.getElementById('total-agendamentos').textContent = 0;
                 return;
             }

             historicoArray.forEach(item => {
                 const data = item.dataHora.split(' ')[0];
                 const mesAno = data.substring(0, 7); // YYYY-MM

                 // Cálculo do Resumo Mensal
                 if (!filtroMesAno || mesAno === filtroMesAno) {
                      faturamentoMensal += item.valor;
                      totalAgendamentos++;
                 }

                 // Renderiza a linha na tabela (aplica o filtro se houver)
                 const row = lista.insertRow();
                 row.dataset.clienteNome = getClienteNome(item.clienteId).toLowerCase(); // Para filtragem por nome
                 row.dataset.mesAno = mesAno;

                 // Aplica o filtro de mês/ano para exibição na tabela
                 if (filtroMesAno && mesAno !== filtroMesAno) {
                      row.style.display = 'none';
                 }

                 // Rótulos para mobile
                 row.insertCell().setAttribute('data-label', 'Data');
                 row.insertCell().setAttribute('data-label', 'Cliente');
                 row.insertCell().setAttribute('data-label', 'Serviço');
                 row.insertCell().setAttribute('data-label', 'Tipo');
                 row.insertCell().setAttribute('data-label', 'Valor');
                 row.insertCell().setAttribute('data-label', 'Status');
                 const acoesCell = row.insertCell();
                 acoesCell.classList.add('action-buttons');
                 
                 const clienteNome = getClienteNome(item.clienteId);
                 const tipoServico = item.pacoteId ? 'Pacote' : 'Avulso';
                 
                 row.cells[0].textContent = formatarDataHora(data, item.dataHora.split(' ')[1]);
                 row.cells[1].textContent = clienteNome;
                 row.cells[2].textContent = item.nomeServico;
                 row.cells[3].textContent = tipoServico;
                 row.cells[4].textContent = formatarMoeda(item.valor);
                 row.cells[5].textContent = item.status.toUpperCase();
                 
                 // Ações: Reverter (somente se o agendamento original não tiver sido excluído)
                 if (agendamentos[item.agendamentoId]) {
                      acoesCell.innerHTML = `
                         <button class="btn-secondary" onclick="reverterConclusaoAgendamento('${item.agendamentoId}')">
                            <span class="material-icons">undo</span> Reverter
                         </button>
                      `;
                 } else {
                      acoesCell.textContent = '-';
                 }

             });
             
             // Atualiza o resumo financeiro (do mês filtrado ou do mês atual se não houver filtro)
             const mesAtual = new Date().toISOString().substring(0, 7);
             const mesParaResumo = filtroMesAno || mesAtual;

             let resumoFaturamento = 0;
             let resumoTotalAgendamentos = 0;
             
             historicoArray
                 .filter(item => item.dataHora.substring(0, 7) === mesParaResumo)
                 .forEach(item => {
                     resumoFaturamento += item.valor;
                     resumoTotalAgendamentos++;
                 });


             document.getElementById('faturamento-mensal').textContent = formatarMoeda(resumoFaturamento);
             document.getElementById('total-agendamentos').textContent = resumoTotalAgendamentos;
             
             // Aplica filtro por cliente se já estiver preenchido
             filtrarHistoricoTabela();
        }
        
        // 2. MOSTRAR HISTÓRICO DE CLIENTE ESPECÍFICO
        window.mostrarHistoricoCliente = function(clienteId) {
             const lista = document.getElementById('lista-historico-cliente');
             lista.innerHTML = '';
             
             const clienteNome = getClienteNome(clienteId);
             document.getElementById('historico-cliente-titulo').textContent = `Histórico de: ${clienteNome}`;
             
             const historicoClienteArray = Object.keys(historico)
                .map(id => ({ id, ...historico[id] }))
                .filter(h => h.clienteId === clienteId)
                .sort((a, b) => new Date(b.dataHora) - new Date(a.dataHora));

             if (historicoClienteArray.length === 0) {
                 lista.innerHTML = '<tr><td colspan="6" style="text-align: center;">Nenhum agendamento concluído para este cliente.</td></tr>';
             } else {
                 historicoClienteArray.forEach(item => {
                      const data = item.dataHora.split(' ')[0];
                      const hora = item.dataHora.split(' ')[1];
                      const agendamento = agendamentos[item.agendamentoId]; // Busca o agendamento original para observações
                      
                      const row = lista.insertRow();
                      
                      // Rótulos para mobile
                      row.insertCell().setAttribute('data-label', 'Data/Hora');
                      row.insertCell().setAttribute('data-label', 'Serviço');
                      row.insertCell().setAttribute('data-label', 'Tipo');
                      row.insertCell().setAttribute('data-label', 'Valor');
                      row.insertCell().setAttribute('data-label', 'Status');
                      row.insertCell().setAttribute('data-label', 'Obs.');
                      
                      const tipoServico = item.pacoteId ? 'Pacote' : 'Avulso';

                      row.cells[0].textContent = formatarDataHora(data, hora);
                      row.cells[1].textContent = item.nomeServico;
                      row.cells[2].textContent = tipoServico;
                      row.cells[3].textContent = formatarMoeda(item.valor);
                      row.cells[4].textContent = item.status.toUpperCase();
                      row.cells[5].textContent = agendamento ? agendamento.observacoes : '-';
                 });
             }

             showSection('historico-cliente-section');
        }
        
        // 3. FILTRAR HISTÓRICO NA TABELA
        window.filtrarHistoricoTabela = function() {
             const filtro = document.getElementById('filtro-historico-cliente').value.toLowerCase();
             const listaHistorico = document.getElementById('lista-historico');
             const linhas = listaHistorico.getElementsByTagName('tr');

             for (let i = 0; i < linhas.length; i++) {
                 const row = linhas[i];
                 if (!row.dataset.clienteNome) continue; 
                 
                 // Garante que o filtro de mês não seja sobrescrito se ele já escondeu a linha
                 if (row.style.display === 'none' && document.getElementById('filtro-historico-mes').value) {
                     continue; 
                 }

                 const clienteNome = row.dataset.clienteNome;
                
                 if (clienteNome.includes(filtro)) {
                     row.style.display = "";
                 } else {
                     row.style.display = "none";
                 }
             }
        }
        
        // 4. RESETAR FILTRO DO HISTÓRICO
        window.resetFiltroHistorico = function() {
            document.getElementById('filtro-historico-mes').value = ''; 
            document.getElementById('filtro-historico-cliente').value = '';
            renderizarHistorico();
        }
        
        // ----------------------------------------------------------------------------------
        // CONTROLE DE LOGIN/LOGOUT
        // ----------------------------------------------------------------------------------
        function showLogin() {
            document.getElementById('app-container').style.display = 'none';
            document.getElementById('login-container').style.display = 'flex';
        }
        
        function showApp() {
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('app-container').style.display = 'flex';
            // Carrega os dados iniciais do app
            showSection('agenda-section');
        }


        // ----------------------------------------------------------------------------------
        // INICIALIZAÇÃO
        // ----------------------------------------------------------------------------------
        document.addEventListener('DOMContentLoaded', () => {
            
            // CORREÇÃO ESSENCIAL: Movendo os listeners de login/logout para dentro de DOMContentLoaded
            // para garantir que o formulário e o botão existam antes de tentar adicionar o evento.
            document.getElementById('login-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const senha = document.getElementById('loginSenha').value;
                
                if (senha === senhaAcesso) {
                     showApp();
                     showNotification('Login realizado com sucesso!', 'success'); // Notificação restaurada
                     carregarTodosOsDados();
                } else {
                     showNotification('Senha incorreta. Tente novamente.', 'error'); // Notificação restaurada
                }
            });

            document.getElementById('logout-button').addEventListener('click', () => {
                showLogin();
                showNotification('Sessão encerrada.', 'info');
            });
            
             // Mostra a tela de login ao carregar a página
            showLogin();
        });
    </script>
</body>
</html>

