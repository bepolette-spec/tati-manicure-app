<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tati Manicure - Gerenciamento de Agendamentos</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <style>
        :root {
            --primary-color: #ff8c6b; /* Cor de Destaque (Salmão/Coral) */
            --secondary-color: #6c757d; /* Cinza para secundários */
            --background-color: #f4f7f6; /* Fundo Suave */
            --sidebar-bg: #ffffff;
            --sidebar-hover-bg: #fff0eb; /* Fundo mais claro para hover */
            --text-color: #343a40; /* Texto Principal (Escuro) */
            --success-color: #28a745;
            --info-color: #17a2b8;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --border-color: #e9ecef;
            --shadow-color: rgba(0, 0, 0, 0.05);
        }

        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            min-height: 100vh;
        }

        /* Estrutura do App */
        #login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            background-color: var(--primary-color);
            min-height: 100vh;
        }

        .login-card {
            background: var(--sidebar-bg);
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 15px var(--shadow-color);
            text-align: center;
            width: 100%;
            max-width: 400px;
        }

        .login-card h1 {
            color: var(--primary-color);
            margin-bottom: 30px;
            font-size: 1.8rem;
        }

        #app-container {
            display: none; /* Escondido por padrão, mostrado após o login */
            width: 100%;
            /* display: flex; REMOVIDO PARA SER ATIVADO PELO JS */
        }

        /* Barra Lateral (Sidebar) */
        .sidebar {
            width: 250px;
            background-color: var(--sidebar-bg);
            box-shadow: 2px 0 5px var(--shadow-color);
            display: flex;
            flex-direction: column;
            padding: 20px 0;
            flex-shrink: 0;
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
            color: var(--primary-color);
            font-size: 1.6rem;
            font-weight: bold;
        }

        .sidebar ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar ul li a {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            text-decoration: none;
            color: var(--text-color);
            transition: background-color 0.2s, color 0.2s;
            font-weight: 500;
        }

        .sidebar ul li a:hover,
        .sidebar ul li a.active {
            background-color: var(--sidebar-hover-bg);
            color: var(--primary-color);
        }

        .sidebar ul li a .material-icons {
            margin-right: 10px;
            font-size: 20px;
        }

        .user-info {
            margin-top: auto;
            padding: 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .user-info p {
            margin: 0 0 10px 0;
            font-weight: bold;
        }

        /* Conteúdo Principal */
        .main-content {
            flex-grow: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .content-section {
            display: none;
            padding: 20px;
        }

        .content-section.active {
            display: block;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .section-header h2 {
            margin: 0;
            color: var(--text-color);
            font-size: 1.5rem;
        }
        
        /* Novas cores para Status de Pacote e Histórico */
        .status-package-paid {
             color: var(--success-color);
             font-weight: bold;
        }
        .status-package-pending {
            color: var(--warning-color);
            font-weight: bold;
        }
        .status-package-active {
            color: var(--primary-color);
            font-weight: bold;
        }
        .status-package-finalized {
            color: var(--danger-color);
            font-weight: bold;
        }

        /* Cartão (Card) */
        .card {
            background: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 4px var(--shadow-color);
            margin-bottom: 20px;
        }
        
        /* NOVO V6: Abas dentro de uma seção */
        .tab-menu {
             display: flex;
             border-bottom: 2px solid var(--border-color);
             margin-bottom: 20px;
        }
        .tab-menu button {
             padding: 10px 20px;
             border: none;
             background: transparent;
             cursor: pointer;
             font-size: 1rem;
             color: var(--secondary-color);
             border-bottom: 2px solid transparent;
             transition: border-color 0.2s, color 0.2s;
             font-weight: bold;
        }
        .tab-menu button.active {
             color: var(--primary-color);
             border-bottom: 2px solid var(--primary-color);
        }
        .tab-content {
             padding-top: 10px;
        }
        .tab-pane {
             display: none;
        }
        .tab-pane.active {
             display: block;
        }

        /* Formulários */
        .form-group {
            margin-bottom: 15px;
        }

        .form-row {
            display: flex;
            gap: 20px;
        }

        .form-row > div {
            flex: 1;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 0.95rem;
        }

        input[type="text"],
        input[type="number"],
        input[type="email"],
        input[type="tel"],
        input[type="date"],
        input[type="time"],
        textarea,
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        /* Datalist input */
        input[list] {
            /* Estilo para garantir que o input datalist se pareça com um campo normal */
            background-image: none;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="email"]:focus,
        input[type="tel"]:focus,
        input[type="date"]:focus,
        input[type="time"]:focus,
        textarea:focus,
        select:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        textarea {
            resize: vertical;
        }

        /* Botões */
        button, .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: background-color 0.2s, opacity 0.2s;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #e57a5e;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #218838;
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: var(--text-color);
        }

        .btn-warning:hover {
            background-color: #ffb547;
        }


        /* Tabelas */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table thead tr {
            background-color: var(--primary-color);
            color: white;
            text-align: left;
        }

        .data-table th, .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table tbody tr:hover {
            background-color: var(--sidebar-hover-bg);
        }

        .data-table td.action-buttons button {
            margin-right: 5px;
            padding: 6px 8px;
        }

        /* CORREÇÃO: Aumenta o espaço para os botões para evitar quebras de linha em telas maiores */
        .data-table td.action-buttons {
            white-space: nowrap;
            width: 280px; /* Garante espaço suficiente */
        }

        /* Notificação */
        #notification-bar {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s, transform 0.3s;
            transform: translateY(-20px);
            z-index: 1000;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            font-weight: bold;
        }

        #notification-bar.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        #notification-bar.success { background-color: var(--success-color); }
        #notification-bar.error { background-color: var(--danger-color); }
        #notification-bar.info { background-color: var(--info-color); }

        /* Utilitários */
        .flex-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .input-group {
            display: flex;
            gap: 10px;
        }
        
        .input-group input, .input-group select {
            flex-grow: 1;
        }

        .filter-row {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            margin-bottom: 20px;
        }
        .filter-row > div {
            flex: 1;
        }
        .filter-row button {
            flex-grow: 0;
            flex-shrink: 0;
            padding: 9px 15px; /* Ajuste para alinhar com o input */
        }
        
        /* NOVO V6: Estilos para a Tabela de Visão Diária */
        .table-responsive {
             overflow-x: auto;
        }
        #tabela-visao-diaria {
             border: 1px solid var(--border-color);
             margin-top: 0;
        }
        #tabela-visao-diaria thead tr {
             background-color: var(--secondary-color);
        }
        #tabela-visao-diaria td {
             height: 40px; /* Altura padrão para cada intervalo de 30 min */
             font-size: 0.9rem;
             vertical-align: top;
        }
        .horario-celula {
             width: 80px;
             font-weight: bold;
             background-color: var(--sidebar-hover-bg);
             color: var(--text-color);
             text-align: center;
             vertical-align: middle !important;
             border-right: 1px solid var(--border-color);
        }
        .agendamento-vago {
             background-color: #f7fff7; /* Verde clarinho */
             color: var(--success-color);
             font-weight: bold;
             font-style: italic;
             text-align: center;
             line-height: 40px;
        }
        .agendamento-ocupado {
             background-color: #fff0eb; /* Fundo do hover de sidebar, suave */
             color: var(--text-color);
             font-weight: 500;
             padding: 5px 10px !important;
             vertical-align: middle !important;
             line-height: 1.2;
             border-left: 5px solid var(--primary-color);
             cursor: pointer;
        }
        .agendamento-ocupado strong {
             color: var(--primary-color);
             font-weight: bold;
        }
        
        /* --------------------------------------------------- */
        /* RESPONSIVIDADE MOBILE (Mobile First - Portrait Mode)*/
        /* --------------------------------------------------- */
        @media (max-width: 768px) {
            
            /* Estrutura Principal */
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
                box-shadow: 0 0 5px var(--shadow-color);
            }

            .main-content {
                padding: 15px;
            }

            #app-container {
                flex-direction: column;
            }

            /* Navegação Horizontal */
            .sidebar ul {
                display: flex;
                flex-wrap: nowrap; /* Tenta manter em uma linha, mas permite rolagem */
                overflow-x: auto;
                justify-content: flex-start;
                border-bottom: 1px solid var(--border-color);
            }

            .sidebar ul li {
                flex-shrink: 0; /* Impede que os itens encolham */
                text-align: center;
            }

            .sidebar ul li a {
                justify-content: center;
                padding: 10px;
                flex-direction: column;
                font-size: 0.75rem;
                white-space: nowrap;
            }

            .sidebar ul li a .material-icons {
                margin-right: 0;
                margin-bottom: 5px;
                font-size: 20px;
            }

            /* FIX: Botão Sair visível no celular */
            .user-info {
                display: block;
                padding: 10px 15px;
                border-top: none; 
                text-align: center; 
            }

            .user-info p {
                display: none; /* Esconde o texto "Olá, Tati!" para economizar espaço */
            }

            .user-info button {
                width: 100%;
                margin-top: 10px; 
                font-size: 0.9rem;
            }
            
            /* 1. Correção de Formulários e Filtros (Empilhamento) */
            .form-row, .filter-row {
                flex-direction: column;
                gap: 0; /* Remove gap quando empilha */
            }

            .form-row > div, 
            .filter-row > div {
                flex: 0 0 100% !important; /* Força largura total */
                width: 100%;
            }
            
            /* Ajusta margem para inputs empilhados */
            .form-group, .filter-row > div {
                margin-bottom: 10px;
            }
            
            .filter-row button {
                width: 100%;
                margin-top: 5px; 
                padding: 10px 15px !important;
            }
            
            /* V6: Ajuste para a Tabela de Visão Diária */
            #tabela-visao-diaria {
                 width: 100%;
                 min-width: 300px; /* Garante que não fique muito esmagada */
            }
            #tabela-visao-diaria td {
                 padding: 5px 10px !important;
            }

            /* 2. Correção de Tabelas (Cartão-like View) */
            .data-table, .data-table tbody, .data-table td, .data-table tr {
                display: block; /* Força elementos da tabela a empilhar */
            }

            .data-table thead {
                display: none; /* Esconde o cabeçalho original */
            }

            .data-table tr {
                border: 1px solid var(--border-color);
                margin-bottom: 15px;
                border-radius: 8px;
                box-shadow: 0 1px 3px var(--shadow-color);
                padding: 10px;
            }

            .data-table td {
                border: none;
                position: relative;
                padding-left: 50% !important; /* Espaço para o rótulo */
                text-align: right; /* Alinha o valor à direita */
                white-space: normal; /* Permite quebras de linha */
                min-height: 40px;
            }

            /* Rótulo customizado (que usa o data-label do JS) */
            .data-table td::before {
                content: attr(data-label);
                position: absolute;
                left: 10px;
                width: 45%; 
                padding-right: 10px;
                white-space: nowrap;
                text-align: left;
                font-weight: bold;
                color: var(--primary-color);
            }
            
            /* FIX V6: Organização dos botões de ação em mobile */
            /* Garante que o rótulo "Ações" não sobreponha o primeiro botão */
            .data-table td.action-buttons {
                text-align: left;
                padding-left: 10px !important;
                display: flex; 
                flex-direction: column; /* Empilha os botões */
                gap: 5px;
                width: 100% !important; /* Garante que ocupe a largura total no mobile */
            }
            
            .data-table td.action-buttons::before {
                content: "Ações";
                width: 100%; 
                margin-bottom: 5px;
                display: block;
            }
            
            .data-table td.action-buttons button {
                margin: 0;
                width: 100%; /* Ocupa a largura toda */
                max-width: 100%;
                box-sizing: border-box;
                font-size: 0.9rem; 
                padding: 8px 5px;
            }
        }
    </style>
</head>
<body>

    <div id="notification-bar"></div>

    <div id="login-container">
        <div class="login-card">
            <h1>Tati Manicure - Acesso</h1>
            <form id="login-form">
                <div class="form-group">
                    <label for="loginSenha">Senha de Acesso</label>
                    <input type="password" id="loginSenha" required>
                </div>
                <button type="submit" class="btn-primary" style="width: 100%; margin-top: 10px;">
                    <span class="material-icons">login</span> Entrar
                </button>
            </form>
        </div>
    </div>

    <datalist id="clientes-datalist"></datalist>

    <div id="app-container">
        
        <aside class="sidebar">
            <div class="logo">TATI MANICURE APP</div>
            
            <ul>
                <li><a href="#" data-section="agenda" class="active"><span class="material-icons">calendar_today</span> Agenda</a></li>
                <li><a href="#" data-section="clientes"><span class="material-icons">people</span> Clientes</a></li>
                <li><a href="#" data-section="servicos"><span class="material-icons">local_offer</span> Serviços</a></li>
                <li><a href="#" data-section="historico"><span class="material-icons">history</span> Histórico/Lucros</a></li>
            </ul>

            
            
            <div class="user-info">
                <p id="userInfo">Olá, Tati!</p>
                <button id="logout-button" class="btn-danger" style="width: 100%;">
                    <span class="material-icons">logout</span> Sair
                </button>
            </div>
        </aside>

        <main class="main-content">

            <div id="agenda-section" class="content-section active">
                
                <div class="tab-menu">
                    <button class="tab-button active" onclick="showAgendaTab('pacotes-ativos')">Pacotes Ativos</button>
                    <button class="tab-button" onclick="showAgendaTab('novo-agendamento')">Novo Agendamento</button>
                    <button class="tab-button" onclick="showAgendaTab('lista-agendamentos')">Próx. Agendamentos</button>
                    <button class="tab-button" onclick="showAgendaTab('visao-diaria')">Visão Diária</button>
                </div>
                
                <div class="tab-content">
                    
                    <div id="pacotes-ativos-pane" class="tab-pane active">
                        <div class="section-header"><h2>Gerenciamento de Pacotes Ativos</h2></div>
                        <div class="card">
                            <form id="pacote-inicio-form">
                                <h3>Iniciar Novo Pacote de Serviços</h3>
                                <div class="form-row">
                                    <div class="form-group" style="flex: 2;">
                                        <label for="pacote-cliente-id">Cliente</label>
                                        <select id="pacote-cliente-id" required></select>
                                    </div>
                                    <div class="form-group" style="flex: 2;">
                                        <label for="pacote-servico-id">Pacote (Serviços marcados como Pacote)</label>
                                        <select id="pacote-servico-id" required></select>
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label for="pacote-data-inicio">Data Início (Geralmente Hoje)</label>
                                        <input type="date" id="pacote-data-inicio" required>
                                    </div>
                                </div>
                                <div class="flex-container">
                                    <button type="submit" class="btn-primary">
                                        <span class="material-icons">add_box</span> Iniciar/Vender Pacote
                                    </button>
                                </div>
                            </form>
                            
                            <hr style="margin: 20px 0;">

                            <h3>Pacotes Ativos e Utilização</h3>
                            <div style="max-height: 500px; overflow-y: auto;">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 20%;">Cliente</th>
                                            <th style="width: 25%;">Pacote (Total/Usado)</th>
                                            <th style="width: 15%;">Pagamento</th>
                                            <th style="width: 15%;">Vencimento</th>
                                            <th style="width: 280px;">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="lista-pacotes-ativos">
                                        <tr><td colspan="5" style="text-align: center;">Carregando pacotes ativos...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div id="pacote-utilizacao-modal" class="card" style="display: none; margin-top: 20px;">
                            <h3>Utilizar Serviço de Pacote</h3>
                            <form id="pacote-utilizacao-form">
                                <input type="hidden" id="utilizacao-pacote-id">
                                <div class="form-row">
                                    <div class="form-group" style="flex: 2;">
                                        <label for="utilizacao-servico-id">Serviço do Pacote</label>
                                        <select id="utilizacao-servico-id" required></select>
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label for="utilizacao-data">Data</label>
                                        <input type="date" id="utilizacao-data" required>
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label for="utilizacao-hora">Hora Início</label>
                                        <input type="time" id="utilizacao-hora" required>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group" style="flex: 1;">
                                        <label for="utilizacao-hora-fim">Hora Fim</label>
                                        <input type="time" id="utilizacao-hora-fim" required>
                                    </div>
                                    <div class="form-group" style="flex: 3;">
                                        <label for="utilizacao-observacoes">Observações (Opcional)</label>
                                        <input type="text" id="utilizacao-observacoes">
                                    </div>
                                </div>
                                <div class="flex-container">
                                    <div>
                                        <button type="submit" class="btn-warning">
                                            <span class="material-icons">check_circle</span> Utilizar Serviço do Pacote
                                        </button>
                                        <button type="button" class="btn-secondary" onclick="hidePacoteUtilizacao()">
                                            <span class="material-icons">close</span> Cancelar
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div id="novo-agendamento-pane" class="tab-pane">
                        <div class="section-header"><h2>Agendamento de Serviços Individuais (Não-Pacote)</h2></div>
                        <div class="card">
                            <form id="agendamento-form">
                                <input type="hidden" id="agendamento-id">
                                <div class="form-row">
                                    <div class="form-group" style="flex: 2;">
                                        <label for="agenda-cliente-id">Cliente</label>
                                        <select id="agenda-cliente-id" required></select>
                                    </div>
                                    <div class="form-group" style="flex: 2;">
                                        <label for="agenda-servico-id">Serviço Individual/Promoção</label>
                                        <select id="agenda-servico-id" required></select>
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label for="agenda-data">Data</label>
                                        <input type="date" id="agenda-data" required>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group" style="flex: 1;">
                                        <label for="agenda-hora">Hora Início</label>
                                        <input type="time" id="agenda-hora" required>
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label for="agenda-hora-fim">Hora Fim</label>
                                        <input type="time" id="agenda-hora-fim" required>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="agenda-observacoes">Observações</label>
                                    <textarea id="agenda-observacoes" rows="2"></textarea>
                                </div>
                                <div class="flex-container">
                                    <div>
                                        <button type="submit" class="btn-success" id="btn-salvar-agendamento">
                                            <span class="material-icons">save</span> Salvar Agendamento
                                        </button>
                                        <button type="button" class="btn-secondary" onclick="resetAgendamentoForm()">
                                            <span class="material-icons">refresh</span> Limpar
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div id="lista-agendamentos-pane" class="tab-pane">
                        <div class="section-header">
                            <h3>Próximos Agendamentos (Serviços Individuais e Pacotes Agendados)</h3>
                        </div>
                        <div class="card">
                            <div class="filter-row">
                                <div style="flex-grow: 1.5;">
                                    <label for="filtro-agenda-data">Filtrar por Data</label>
                                    <input type="date" id="filtro-agenda-data" onchange="carregarAgendamentos()">
                                </div>
                                <div style="flex-grow: 3;">
                                    <label for="filtro-agenda-cliente">Filtrar por Cliente (Digite ou Selecione)</label>
                                    <input type="text" id="filtro-agenda-cliente" list="clientes-datalist" placeholder="Digite o nome do cliente..." onkeyup="filtrarAgendamentos()">
                                </div>
                                <button class="btn-secondary" onclick="resetFiltroAgenda()"><span class="material-icons">refresh</span> Resetar Filtro</button>
                            </div>
                            <div style="max-height: 500px; overflow-y: auto;">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 15%;">Data/Hora</th>
                                            <th style="width: 25%;">Cliente</th>
                                            <th style="width: 25%;">Serviço</th>
                                            <th>Status</th>
                                            <th style="width: 280px;">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="lista-agendamentos">
                                        <tr><td colspan="5" style="text-align: center;">Carregando agendamentos...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div id="visao-diaria-pane" class="tab-pane">
                        <div class="section-header">
                            <h2>Visão Diária da Agenda</h2>
                        </div>
                        <div class="card">
                            <div class="filter-row">
                                <div style="flex-grow: 1;">
                                    <label for="filtro-visao-diaria-data">Selecione a Data</label>
                                    <input type="date" id="filtro-visao-diaria-data" onchange="renderizarVisaoDiaria()">
                                </div>
                                <button class="btn-secondary" onclick="renderizarVisaoDiaria(today)"><span class="material-icons">today</span> Ver Hoje</button>
                            </div>
                            <div class="table-responsive">
                                <table class="data-table" id="tabela-visao-diaria">
                                    <thead>
                                        <tr>
                                            <th style="width: 100px;">Horário</th>
                                            <th>Detalhes do Agendamento</th>
                                        </tr>
                                    </thead>
                                    <tbody id="lista-visao-diaria">
                                        <tr><td colspan="2" style="text-align: center;">Selecione uma data para visualizar.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                </div>

            </div>

            <div id="clientes-section" class="content-section">
                <div class="section-header"><h2>Cadastro de Clientes</h2></div>
                <div class="card">
                    <form id="cliente-form">
                        <input type="hidden" id="cliente-id">
                        <div class="form-row">
                            <div class="form-group" style="flex: 2;">
                                <label for="cliente-nome">Nome Completo</label>
                                <input type="text" id="cliente-nome" required>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label for="cliente-telefone">Telefone (Whatsapp)</label>
                                <input type="tel" id="cliente-telefone">
                            </div>
                        </div>
                        <div class="form-group" style="display: none;">
                            <label for="cliente-email">E-mail (Opcional)</label>
                            <input type="email" id="cliente-email">
                        </div>
                        <div class="form-group">
                            <label for="cliente-endereco">Endereço (Opcional)</label>
                            <input type="text" id="cliente-endereco">
                        </div>
                        <div class="form-group">
                            <label for="cliente-observacoes">Observações (Alergias, Preferências)</label>
                            <textarea id="cliente-observacoes" rows="2"></textarea>
                        </div>
                        <div class="flex-container">
                            <div>
                                <button type="submit" class="btn-success" id="btn-salvar-cliente">
                                    <span class="material-icons">save</span> Salvar Cliente
                                </button>
                                <button type="button" class="btn-secondary" onclick="resetClienteForm()">
                                    <span class="material-icons">refresh</span> Limpar
                                </button>
                            </div>
                        </div>
                    </form>
                </div>

                <div class="section-header">
                    <h3>Lista de Clientes Cadastrados</h3>
                    <div class="input-group" style="width: 300px;">
                        <input type="text" id="filtro-clientes" list="clientes-datalist" placeholder="Filtrar por nome, tel ou email..." onkeyup="filtrarClientes()">
                    </div>
                </div>
                <div class="card">
                    <div style="max-height: 500px; overflow-y: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th style="width: 30%;">Nome</th>
                                    <th style="width: 20%;">Telefone</th>
                                    <th style="width: 30%;">Endereço</th>
                                    <th style="width: 150px;">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="lista-clientes">
                                <tr><td colspan="4" style="text-align: center;">Carregando clientes...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="servicos-section" class="content-section">
                <div class="section-header"><h2>Cadastro de Serviços/Pacotes</h2></div>
                <div class="card">
                    <form id="servico-form">
                        <input type="hidden" id="servico-id">
                        <div class="form-row">
                            <div class="form-group" style="flex: 2;">
                                <label for="servico-nome">Nome do Serviço</label>
                                <input type="text" id="servico-nome" required>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label for="servico-preco">Preço (R$)</label>
                                <input type="number" id="servico-preco" step="0.01" min="0" required value="0.00">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <label>
                                    <input type="checkbox" id="servico-isPacote"> É um **Pacote Mensal**?
                                </label>
                            </div>
                            <div class="form-group" id="group-quantidade-total" style="flex: 1; display: none;">
                                <label for="servico-quantidade-total">Quantidade Total de Usos</label>
                                <input type="number" id="servico-quantidade-total" min="1" step="1" value="4">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="servico-observacoes">Descrição/Observações</label>
                            <textarea id="servico-observacoes" rows="2"></textarea>
                        </div>
                        <div class="flex-container">
                            <div>
                                <button type="submit" class="btn-success" id="btn-salvar-servico">
                                    <span class="material-icons">save</span> Salvar Serviço
                                </button>
                                <button type="button" class="btn-secondary" onclick="resetServicoForm()">
                                    <span class="material-icons">refresh</span> Limpar
                                </button>
                            </div>
                        </div>
                    </form>
                </div>

                <div class="section-header">
                    <h3>Lista de Serviços Cadastrados</h3>
                    <div class="input-group" style="width: 300px;">
                        <input type="text" id="filtro-servicos" placeholder="Filtrar por nome..." onkeyup="filtrarServicos()">
                    </div>
                </div>
                <div class="card">
                    <div style="max-height: 500px; overflow-y: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th style="width: 30%;">Nome</th>
                                    <th style="width: 15%;">Preço</th>
                                    <th style="width: 15%;">Tipo</th>
                                    <th style="width: 300px;">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="lista-servicos">
                                <tr><td colspan="4" style="text-align: center;">Carregando serviços...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="historico-section" class="content-section">
                <div class="section-header">
                    <h2>Histórico de Agendamentos e Lucros</h2>
                </div>
                <div class="card">
                    <div class="filter-row">
                        <div style="flex-grow: 1;">
                            <label for="filtro-historico-mes">Filtrar por Mês/Ano</label>
                            <input type="month" id="filtro-historico-mes" onchange="carregarHistorico()">
                        </div>
                        <div style="flex-grow: 1;">
                            <label for="filtro-historico-cliente">Filtrar por Cliente</label>
                            <input type="text" id="filtro-historico-cliente" list="clientes-datalist" placeholder="Nome do cliente..." onkeyup="filtrarHistorico()">
                        </div>
                        <button class="btn-secondary" onclick="resetFiltroHistorico()"><span class="material-icons">refresh</span> Resetar Filtro</button>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <p><strong>Filtro Atual:</strong> <span id="historico-mes-ano">Todos os Registros</span> | <strong>Lucro Total:</strong> <span id="lucro-total-span" class="status-package-paid">R$ 0,00</span></p>
                    </div>

                    <div style="max-height: 500px; overflow-y: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th style="width: 15%;">Data</th>
                                    <th style="width: 25%;">Cliente</th>
                                    <th style="width: 25%;">Serviço</th>
                                    <th style="width: 15%;">Valor (R$)</th>
                                    <th style="width: 200px;">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="lista-historico">
                                <tr><td colspan="5" style="text-align: center;">Carregando histórico...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>


        </main>
    </div>

    <script>
        // ----------------------------------------------------------------------------------
        // CONFIGURAÇÃO DO FIREBASE
        // ----------------------------------------------------------------------------------
        // Dados de configuração do Firebase fornecidos pelo usuário.
        // O código utiliza o SDK Namespaced (v8.10.0), compatível com esta estrutura.
        const firebaseConfig = {
            apiKey: "AIzaSyBatp6e1NzevurpB2yS8eGErgSYC_t2-Nc",
            authDomain: "tati-manicure.firebaseapp.com",
            projectId: "tati-manicure",
            storageBucket: "tati-manicure.firebasestorage.app",
            messagingSenderId: "1061777323027",
            appId: "1:1061777323027:web:7b54e5fdbb7f06ee293be6"
        };

        // Inicializa o Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // ----------------------------------------------------------------------------------
        // VARIÁVEIS DE CONFIGURAÇÃO DO APP
        // ----------------------------------------------------------------------------------
        const senhaAcesso = 'tati123'; // Senha de acesso corrigida conforme sua solicitação
        const hoje = new Date().toISOString().split('T')[0];
        const today = hoje; // Alias

        let allClientes = [];
        let allServicos = [];
        let allPacotesAtivos = [];
        let allAgendamentos = [];
        let allHistorico = []; // Inclui agendamentos concluídos e usos de pacote

        // ----------------------------------------------------------------------------------
        // UTILS
        // ----------------------------------------------------------------------------------

        /**
         * Exibe uma notificação temporária.
         * @param {string} message A mensagem a ser exibida.
         * @param {('success'|'error'|'info')} type O tipo de notificação (para cor).
         */
        function showNotification(message, type) {
            const bar = document.getElementById('notification-bar');
            bar.textContent = message;
            bar.className = 'show ' + type;
            setTimeout(() => {
                bar.className = '';
            }, 3000);
        }

        /**
         * Formata um valor numérico para o formato monetário brasileiro (R$).
         * @param {number} value O valor a ser formatado.
         * @returns {string} O valor formatado.
         */
        function formatCurrency(value) {
            if (typeof value !== 'number') return 'R$ 0,00';
            return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        /**
         * Formata uma string de data (YYYY-MM-DD) para DD/MM/YYYY.
         * @param {string} dateString A string de data.
         * @returns {string} A data formatada.
         */
        function formatDate(dateString) {
            if (!dateString) return '';
            try {
                // Tenta criar a data a partir do formato YYYY-MM-DD
                const [year, month, day] = dateString.split('-');
                if (year && month && day) {
                    return `${day}/${month}/${year}`;
                }
                // Se não for YYYY-MM-DD, tenta formatar como data completa (timestamp)
                const date = new Date(dateString);
                if (!isNaN(date)) {
                    return date.toLocaleDateString('pt-BR');
                }
                return dateString;
            } catch (e) {
                return dateString;
            }
        }

        /**
         * Obtém o nome do cliente pelo ID.
         * @param {string} clienteId O ID do cliente.
         * @returns {string} O nome do cliente ou "Cliente Desconhecido".
         */
        function getClienteName(clienteId) {
            const cliente = allClientes.find(c => c.id === clienteId);
            return cliente ? cliente.nome : 'Cliente Desconhecido';
        }

        /**
         * Obtém o nome/detalhe do serviço pelo ID.
         * @param {string} servicoId O ID do serviço.
         * @returns {object} O objeto serviço ou null.
         */
        function getServico(servicoId) {
            return allServicos.find(s => s.id === servicoId);
        }

        // ----------------------------------------------------------------------------------
        // NAVEGAÇÃO E TELA
        // ----------------------------------------------------------------------------------

        /**
         * Exibe uma seção principal do aplicativo e carrega seus dados.
         * @param {string} sectionId O ID da seção.
         */
        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
            
            document.querySelectorAll('.sidebar ul li a').forEach(link => {
                 link.classList.remove('active');
            });
            document.querySelector(`a[data-section="${sectionId.replace('-section', '')}"]`).classList.add('active');


            // Carregar dados específicos da seção
            if (sectionId === 'agenda-section') {
                document.getElementById('filtro-agenda-data').value = today; // Define filtro para hoje
                document.getElementById('filtro-visao-diaria-data').value = today; // Define filtro para hoje
                carregarListasDependentes(true);
            } else if (sectionId === 'clientes-section') {
                carregarClientes();
            } else if (sectionId === 'servicos-section') {
                carregarServicos();
            } else if (sectionId === 'historico-section') {
                carregarHistorico();
            }
        }
        
        /**
         * Alterna entre as abas dentro da seção Agenda.
         * @param {string} tabName O nome da aba ('pacotes-ativos', 'novo-agendamento', 'lista-agendamentos', 'visao-diaria').
         */
        function showAgendaTab(tabName) {
            document.querySelectorAll('#agenda-section .tab-pane').forEach(pane => {
                 pane.classList.remove('active');
            });
            document.querySelectorAll('#agenda-section .tab-button').forEach(button => {
                 button.classList.remove('active');
            });

            document.getElementById(`${tabName}-pane`).classList.add('active');
            document.querySelector(`.tab-button[onclick*='${tabName}']`).classList.add('active');
            
            // Ações específicas ao abrir a aba
            if (tabName === 'pacotes-ativos') {
                 carregarPacotesAtivos();
            } else if (tabName === 'lista-agendamentos') {
                 carregarAgendamentos();
            } else if (tabName === 'visao-diaria') {
                 renderizarVisaoDiaria();
            } else if (tabName === 'novo-agendamento') {
                 // Certifica-se de que o formulário está limpo ao entrar
                 resetAgendamentoForm();
            }
        }

        // ----------------------------------------------------------------------------------
        // CRUD GERAL (CLIENTES E SERVIÇOS)
        // ----------------------------------------------------------------------------------

        // ================= CLIENTES =================

        /**
         * Carrega todos os clientes do Firestore e preenche a tabela e datalists.
         */
        async function carregarClientes() {
            const tbody = document.getElementById('lista-clientes');
            tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">Carregando clientes...</td></tr>';
            try {
                const snapshot = await db.collection('clientes').orderBy('nome').get();
                allClientes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Preenche a datalist para filtros e formulários de agendamento/pacote
                preencherClientesDatalist(allClientes);

                filtrarClientes(); // Chama o filtro para renderizar a lista
            } catch (e) {
                showNotification('Erro ao carregar clientes: ' + e.message, 'error');
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">Erro ao carregar clientes.</td></tr>';
            }
        }

        /**
         * Preenche a datalist de clientes para inputs com autocomplete.
         * @param {Array} clientes A lista de clientes.
         */
        function preencherClientesDatalist(clientes) {
            const datalist = document.getElementById('clientes-datalist');
            datalist.innerHTML = '';
            clientes.forEach(cliente => {
                const option = document.createElement('option');
                option.value = cliente.nome; // Nome visível no input
                // O ID real será recuperado pelo formulário posteriormente se necessário
                datalist.appendChild(option);
            });
        }
        
        /**
         * Encontra o ID do cliente a partir do nome digitado no input datalist.
         * @param {string} nome O nome completo do cliente.
         * @returns {string|null} O ID do cliente ou null.
         */
        function getClienteIdByName(nome) {
            const cliente = allClientes.find(c => c.nome.trim().toLowerCase() === nome.trim().toLowerCase());
            return cliente ? cliente.id : null;
        }

        /**
         * Aplica o filtro na lista de clientes e renderiza a tabela.
         */
        function filtrarClientes() {
            const filtro = document.getElementById('filtro-clientes').value.toLowerCase();
            const tbody = document.getElementById('lista-clientes');
            
            const clientesFiltrados = allClientes.filter(c => 
                 c.nome.toLowerCase().includes(filtro) ||
                 (c.telefone && c.telefone.includes(filtro)) ||
                 (c.email && c.email.toLowerCase().includes(filtro))
            );

            tbody.innerHTML = '';
            if (clientesFiltrados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">Nenhum cliente encontrado.</td></tr>';
                return;
            }

            clientesFiltrados.forEach(cliente => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td data-label="Nome">${cliente.nome}</td>
                    <td data-label="Telefone">${cliente.telefone || '-'}</td>
                    <td data-label="Endereço">${cliente.endereco || '-'}</td>
                    <td data-label="Ações" class="action-buttons">
                        <button class="btn-warning" onclick="editarCliente('${cliente.id}')">
                            <span class="material-icons">edit</span> Editar
                        </button>
                        <button class="btn-danger" onclick="excluirCliente('${cliente.id}')">
                            <span class="material-icons">delete</span> Excluir
                        </button>
                    </td>
                `;
            });
        }

        /**
         * Edita um cliente preenchendo o formulário.
         * @param {string} id O ID do cliente.
         */
        function editarCliente(id) {
            const cliente = allClientes.find(c => c.id === id);
            if (cliente) {
                document.getElementById('cliente-id').value = cliente.id;
                document.getElementById('cliente-nome').value = cliente.nome;
                document.getElementById('cliente-telefone').value = cliente.telefone || '';
                document.getElementById('cliente-email').value = cliente.email || '';
                document.getElementById('cliente-endereco').value = cliente.endereco || '';
                document.getElementById('cliente-observacoes').value = cliente.observacoes || '';
                document.getElementById('btn-salvar-cliente').innerHTML = '<span class="material-icons">update</span> Atualizar Cliente';
            }
        }
        
        /**
         * Exclui um cliente (com confirmação).
         * @param {string} id O ID do cliente.
         */
        function excluirCliente(id) {
            if (confirm('Tem certeza que deseja excluir este cliente?')) {
                db.collection('clientes').doc(id).delete()
                    .then(() => {
                        showNotification('Cliente excluído com sucesso!', 'success');
                        carregarClientes();
                    })
                    .catch(e => {
                        showNotification('Erro ao excluir cliente: ' + e.message, 'error');
                    });
            }
        }

        /**
         * Limpa o formulário de cliente.
         */
        function resetClienteForm() {
            document.getElementById('cliente-form').reset();
            document.getElementById('cliente-id').value = '';
            document.getElementById('btn-salvar-cliente').innerHTML = '<span class="material-icons">save</span> Salvar Cliente';
        }

        // Listener do formulário de cliente
        document.getElementById('cliente-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('cliente-id').value;
            const data = {
                nome: document.getElementById('cliente-nome').value,
                telefone: document.getElementById('cliente-telefone').value,
                email: document.getElementById('cliente-email').value,
                endereco: document.getElementById('cliente-endereco').value,
                observacoes: document.getElementById('cliente-observacoes').value,
                dataCriacao: firebase.firestore.FieldValue.serverTimestamp() // Apenas para novos
            };

            try {
                if (id) {
                    await db.collection('clientes').doc(id).update(data);
                    showNotification('Cliente atualizado com sucesso!', 'success');
                } else {
                    await db.collection('clientes').add(data);
                    showNotification('Cliente cadastrado com sucesso!', 'success');
                }
                resetClienteForm();
                carregarClientes();
            } catch (e) {
                showNotification('Erro ao salvar cliente: ' + e.message, 'error');
            }
        });

        // ================= SERVIÇOS =================
        
        /**
         * Alterna a visibilidade do campo "Quantidade Total de Usos"
         */
        function togglePacoteQuantity() {
            const isPacote = document.getElementById('servico-isPacote').checked;
            document.getElementById('group-quantidade-total').style.display = isPacote ? 'block' : 'none';
        }
        
        document.getElementById('servico-isPacote').addEventListener('change', togglePacoteQuantity);


        /**
         * Carrega todos os serviços do Firestore e preenche a tabela.
         */
        async function carregarServicos() {
            const tbody = document.getElementById('lista-servicos');
            tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">Carregando serviços...</td></tr>';
            try {
                const snapshot = await db.collection('servicos').orderBy('nome').get();
                allServicos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                filtrarServicos(); // Chama o filtro para renderizar a lista
            } catch (e) {
                showNotification('Erro ao carregar serviços: ' + e.message, 'error');
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">Erro ao carregar serviços.</td></tr>';
            }
        }

        /**
         * Aplica o filtro na lista de serviços e renderiza a tabela.
         */
        function filtrarServicos() {
            const filtro = document.getElementById('filtro-servicos').value.toLowerCase();
            const tbody = document.getElementById('lista-servicos');
            
            const servicosFiltrados = allServicos.filter(s => 
                 s.nome.toLowerCase().includes(filtro) ||
                 (s.observacoes && s.observacoes.toLowerCase().includes(filtro))
            );

            tbody.innerHTML = '';
            if (servicosFiltrados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">Nenhum serviço encontrado.</td></tr>';
                return;
            }

            servicosFiltrados.forEach(servico => {
                const tipo = servico.isPacote ? 
                    `<span class="status-package-active">Pacote (${servico.quantidadeTotal})</span>` : 
                    `<span class="status-package-pending">Individual</span>`;
                    
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td data-label="Nome">${servico.nome}</td>
                    <td data-label="Preço">${formatCurrency(servico.preco)}</td>
                    <td data-label="Tipo">${tipo}</td>
                    <td data-label="Ações" class="action-buttons">
                        <button class="btn-warning" onclick="editarServico('${servico.id}')">
                            <span class="material-icons">edit</span> Editar
                        </button>
                        <button class="btn-danger" onclick="excluirServico('${servico.id}')">
                            <span class="material-icons">delete</span> Excluir
                        </button>
                    </td>
                `;
            });
        }

        /**
         * Edita um serviço preenchendo o formulário.
         * @param {string} id O ID do serviço.
         */
        function editarServico(id) {
            const servico = allServicos.find(s => s.id === id);
            if (servico) {
                document.getElementById('servico-id').value = servico.id;
                document.getElementById('servico-nome').value = servico.nome;
                document.getElementById('servico-preco').value = servico.preco;
                document.getElementById('servico-isPacote').checked = servico.isPacote || false;
                document.getElementById('servico-quantidade-total').value = servico.quantidadeTotal || 4;
                document.getElementById('servico-observacoes').value = servico.observacoes || '';
                
                togglePacoteQuantity(); // Atualiza a visibilidade
                
                document.getElementById('btn-salvar-servico').innerHTML = '<span class="material-icons">update</span> Atualizar Serviço';
            }
        }
        
        /**
         * Exclui um serviço (com confirmação).
         * @param {string} id O ID do serviço.
         */
        function excluirServico(id) {
            if (confirm('Tem certeza que deseja excluir este serviço?')) {
                db.collection('servicos').doc(id).delete()
                    .then(() => {
                        showNotification('Serviço excluído com sucesso!', 'success');
                        carregarServicos();
                    })
                    .catch(e => {
                        showNotification('Erro ao excluir serviço: ' + e.message, 'error');
                    });
            }
        }

        /**
         * Limpa o formulário de serviço.
         */
        function resetServicoForm() {
            document.getElementById('servico-form').reset();
            document.getElementById('servico-id').value = '';
            document.getElementById('servico-preco').value = '0.00';
            document.getElementById('servico-quantidade-total').value = '4';
            document.getElementById('servico-isPacote').checked = false;
            togglePacoteQuantity();
            document.getElementById('btn-salvar-servico').innerHTML = '<span class="material-icons">save</span> Salvar Serviço';
        }

        // Listener do formulário de serviço
        document.getElementById('servico-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('servico-id').value;
            const isPacote = document.getElementById('servico-isPacote').checked;
            
            const data = {
                nome: document.getElementById('servico-nome').value,
                preco: parseFloat(document.getElementById('servico-preco').value) || 0,
                isPacote: isPacote,
                quantidadeTotal: isPacote ? parseInt(document.getElementById('servico-quantidade-total').value) : 1,
                observacoes: document.getElementById('servico-observacoes').value,
                dataCriacao: firebase.firestore.FieldValue.serverTimestamp() // Apenas para novos
            };

            try {
                if (id) {
                    await db.collection('servicos').doc(id).update(data);
                    showNotification('Serviço atualizado com sucesso!', 'success');
                } else {
                    await db.collection('servicos').add(data);
                    showNotification('Serviço cadastrado com sucesso!', 'success');
                }
                resetServicoForm();
                carregarServicos();
            } catch (e) {
                showNotification('Erro ao salvar serviço: ' + e.message, 'error');
            }
        });


        // ----------------------------------------------------------------------------------
        // AGENDAMENTOS E PACOTES
        // ----------------------------------------------------------------------------------

        /**
         * Carrega listas de Clientes e Serviços para preencher os <select> de agendamento/pacote.
         * @param {boolean} loadAgendaData Indica se deve carregar os dados de agendamento/pacote em seguida.
         */
        async function carregarListasDependentes(loadAgendaData = false) {
            try {
                // 1. Clientes
                const clientesSnapshot = await db.collection('clientes').orderBy('nome').get();
                allClientes = clientesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Preenche a datalist para filtros
                preencherClientesDatalist(allClientes);

                // Preenche o <select> de Clientes nos formulários
                const clienteSelects = document.querySelectorAll('#pacote-cliente-id, #agenda-cliente-id');
                clienteSelects.forEach(select => {
                    select.innerHTML = '<option value="">Selecione um cliente...</option>';
                    allClientes.forEach(cliente => {
                        select.innerHTML += `<option value="${cliente.id}">${cliente.nome}</option>`;
                    });
                });

                // 2. Serviços
                const servicosSnapshot = await db.collection('servicos').orderBy('nome').get();
                allServicos = servicosSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Preenche o <select> de Pacotes
                const pacoteServicos = allServicos.filter(s => s.isPacote);
                const pacoteSelect = document.getElementById('pacote-servico-id');
                pacoteSelect.innerHTML = '<option value="">Selecione um pacote...</option>';
                pacoteServicos.forEach(servico => {
                    pacoteSelect.innerHTML += `<option value="${servico.id}">${servico.nome} (${servico.quantidadeTotal} usos)</option>`;
                });

                // Preenche o <select> de Serviços Individuais/Promoção
                const individualServicos = allServicos.filter(s => !s.isPacote);
                const agendaSelect = document.getElementById('agenda-servico-id');
                agendaSelect.innerHTML = '<option value="">Selecione um serviço...</option>';
                individualServicos.forEach(servico => {
                    agendaSelect.innerHTML += `<option value="${servico.id}">${servico.nome} (${formatCurrency(servico.preco)})</option>`;
                });
                
                // 3. Carregar dados de Agenda se necessário
                if (loadAgendaData) {
                    // Carrega Pacotes Ativos (que é o primeiro painel ativo)
                    carregarPacotesAtivos();
                }


            } catch (e) {
                showNotification('Erro ao carregar listas dependentes: ' + e.message, 'error');
            }
        }

        // ================= PACOTES ATIVOS =================

        /**
         * Carrega todos os pacotes ativos (pacotes vendidos/iniciados).
         */
        async function carregarPacotesAtivos() {
            const tbody = document.getElementById('lista-pacotes-ativos');
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Carregando pacotes ativos...</td></tr>';
            try {
                // Busca pacotes que ainda não foram finalizados (status != 'finalizado')
                const snapshot = await db.collection('pacotesAtivos')
                    .where('status', '!=', 'finalizado')
                    .orderBy('status')
                    .orderBy('dataVencimento')
                    .get();
                    
                allPacotesAtivos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                tbody.innerHTML = '';
                if (allPacotesAtivos.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nenhum pacote ativo encontrado.</td></tr>';
                    return;
                }
                
                allPacotesAtivos.forEach(pacote => {
                    const clienteNome = getClienteName(pacote.clienteId);
                    const servico = getServico(pacote.servicoId);
                    
                    if (!servico) return; // Pular se o serviço não existir

                    const totalUsos = pacote.usos.length;
                    const restante = servico.quantidadeTotal - totalUsos;
                    
                    let statusClass = '';
                    let statusText = '';
                    
                    if (restante <= 0) {
                        statusText = 'Usos Esgotados';
                        statusClass = 'status-package-finalized';
                    } else if (pacote.status === 'pago') {
                        statusText = 'Pago';
                        statusClass = 'status-package-paid';
                    } else if (pacote.status === 'pendente') {
                        statusText = 'Pendente';
                        statusClass = 'status-package-pending';
                    } else {
                         statusText = pacote.status;
                         statusClass = '';
                    }

                    // Verifica vencimento
                    const dataVencimento = formatDate(pacote.dataVencimento);
                    const vencido = new Date(pacote.dataVencimento) < new Date(today);
                    const vencimentoText = vencido ? 
                        `<span class="status-package-finalized">${dataVencimento} (Vencido)</span>` : 
                        dataVencimento;

                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td data-label="Cliente">${clienteNome}</td>
                        <td data-label="Pacote">${servico.nome} (${servico.quantidadeTotal}/${totalUsos})</td>
                        <td data-label="Pagamento"><span class="${statusClass}">${statusText}</span></td>
                        <td data-label="Vencimento">${vencimentoText}</td>
                        <td data-label="Ações" class="action-buttons">
                            ${restante > 0 && !vencido ? 
                                `<button class="btn-warning" onclick="showPacoteUtilizacao('${pacote.id}')">
                                    <span class="material-icons">add_circle</span> Utilizar (${restante})
                                </button>` : ''}
                            <button class="btn-primary" onclick="visualizarUsosPacote('${pacote.id}')">
                                <span class="material-icons">visibility</span> Ver Usos
                            </button>
                            <button class="btn-success" onclick="finalizarPacote('${pacote.id}')">
                                <span class="material-icons">check</span> Finalizar
                            </button>
                        </td>
                    `;
                });
                
            } catch (e) {
                showNotification('Erro ao carregar pacotes ativos: ' + e.message, 'error');
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Erro ao carregar pacotes ativos.</td></tr>';
            }
        }
        
        /**
         * Listener do formulário para iniciar um novo pacote.
         */
        document.getElementById('pacote-inicio-form').addEventListener('submit', async (e) => {
             e.preventDefault();
             
             const clienteId = document.getElementById('pacote-cliente-id').value;
             const servicoId = document.getElementById('pacote-servico-id').value;
             const dataInicio = document.getElementById('pacote-data-inicio').value;
             
             if (!clienteId || !servicoId || !dataInicio) {
                 showNotification('Preencha todos os campos obrigatórios.', 'error');
                 return;
             }

             const servico = getServico(servicoId);
             if (!servico || !servico.isPacote) {
                 showNotification('Serviço inválido ou não é um pacote.', 'error');
                 return;
             }

             // Calcula data de vencimento (30 dias após data início)
             const dataVencimento = new Date(dataInicio);
             dataVencimento.setDate(dataVencimento.getDate() + 30);
             const dataVencimentoString = dataVencimento.toISOString().split('T')[0];
             
             const novoPacote = {
                 clienteId: clienteId,
                 servicoId: servicoId,
                 dataInicio: dataInicio,
                 dataVencimento: dataVencimentoString,
                 quantidadeTotal: servico.quantidadeTotal,
                 usos: [], // Array de usos (agendamentos)
                 valorTotal: servico.preco,
                 status: 'pendente', // Pode ser 'pendente', 'pago'
                 dataCriacao: firebase.firestore.FieldValue.serverTimestamp()
             };
             
             try {
                 await db.collection('pacotesAtivos').add(novoPacote);
                 showNotification('Pacote iniciado e vendido com sucesso!', 'success');
                 document.getElementById('pacote-inicio-form').reset();
                 document.getElementById('pacote-data-inicio').value = hoje;
                 carregarPacotesAtivos(); // Atualiza a lista
             } catch (e) {
                 showNotification('Erro ao iniciar pacote: ' + e.message, 'error');
             }
        });
        
        /**
         * Exibe o formulário para utilizar um serviço do pacote.
         * @param {string} pacoteId O ID do pacote ativo.
         */
        function showPacoteUtilizacao(pacoteId) {
             const pacote = allPacotesAtivos.find(p => p.id === pacoteId);
             const servicoPacote = getServico(pacote.servicoId);
             
             if (!pacote || !servicoPacote) {
                 showNotification('Pacote ou serviço não encontrado.', 'error');
                 return;
             }
             
             document.getElementById('utilizacao-pacote-id').value = pacoteId;
             
             // Preenche o select de utilização apenas com o serviço do pacote
             const select = document.getElementById('utilizacao-servico-id');
             select.innerHTML = `<option value="${servicoPacote.id}" selected>${servicoPacote.nome} - R$ ${servicoPacote.preco}</option>`;
             select.disabled = true; // Não permite mudar o serviço principal do pacote
             
             // Preenche a data e hora atual
             document.getElementById('utilizacao-data').value = today;
             document.getElementById('utilizacao-hora').value = new Date().toTimeString().substring(0, 5);
             document.getElementById('utilizacao-hora-fim').value = ''; // Deixa em branco ou calcula duração

             document.getElementById('pacote-utilizacao-modal').style.display = 'block';
        }
        
        /**
         * Esconde o formulário de utilização de pacote.
         */
        function hidePacoteUtilizacao() {
             document.getElementById('pacote-utilizacao-modal').style.display = 'none';
             document.getElementById('pacote-utilizacao-form').reset();
             document.getElementById('utilizacao-servico-id').disabled = false;
        }

        /**
         * Listener do formulário para registrar o uso de um serviço do pacote.
         */
        document.getElementById('pacote-utilizacao-form').addEventListener('submit', async (e) => {
             e.preventDefault();
             
             const pacoteId = document.getElementById('utilizacao-pacote-id').value;
             const data = document.getElementById('utilizacao-data').value;
             const hora = document.getElementById('utilizacao-hora').value;
             const horaFim = document.getElementById('utilizacao-hora-fim').value;
             const observacoes = document.getElementById('utilizacao-observacoes').value;
             
             const pacote = allPacotesAtivos.find(p => p.id === pacoteId);
             const servicoPacote = getServico(pacote.servicoId);

             if (!pacote || !servicoPacote) return;
             
             const novoUso = {
                 data: data,
                 hora: hora,
                 horaFim: horaFim,
                 servicoId: servicoPacote.id, // O serviço é o do pacote
                 valor: 0, // Valor é 0, pois já foi pago no pacote
                 tipo: 'usoPacote', // Indica que é um uso de pacote
                 observacoes: observacoes,
                 dataRegistro: firebase.firestore.FieldValue.serverTimestamp()
             };
             
             try {
                 // 1. Adiciona o uso no array 'usos' do pacote
                 const novosUsos = [...pacote.usos, novoUso];
                 
                 await db.collection('pacotesAtivos').doc(pacoteId).update({
                     usos: novosUsos
                 });
                 
                 // 2. Adiciona o registro no histórico para fins de visualização (opcional)
                 const registroHistorico = {
                      clienteId: pacote.clienteId,
                      servicoId: servicoPacote.id,
                      tipoRegistro: 'usoPacote',
                      valor: 0,
                      data: data,
                      hora: hora,
                      observacoes: `Uso do Pacote: ${servicoPacote.nome}. ${observacoes}`,
                      dataCriacao: firebase.firestore.FieldValue.serverTimestamp()
                 };
                 await db.collection('historico').add(registroHistorico);
                 
                 showNotification('Uso do serviço registrado com sucesso!', 'success');
                 hidePacoteUtilizacao();
                 carregarPacotesAtivos(); // Atualiza lista de pacotes

             } catch (e) {
                 showNotification('Erro ao registrar uso de pacote: ' + e.message, 'error');
             }
        });
        
        /**
         * Finaliza um pacote ativo (muda o status para 'finalizado').
         * @param {string} id O ID do pacote.
         */
        function finalizarPacote(id) {
            if (confirm('Tem certeza que deseja FINALIZAR este pacote? Ele será movido para o histórico.')) {
                db.collection('pacotesAtivos').doc(id).update({
                    status: 'finalizado',
                    dataFinalizacao: hoje
                })
                    .then(() => {
                        showNotification('Pacote finalizado com sucesso!', 'success');
                        carregarPacotesAtivos();
                    })
                    .catch(e => {
                        showNotification('Erro ao finalizar pacote: ' + e.message, 'error');
                    });
            }
        }
        
        /**
         * Implementação simples para visualizar usos do pacote (pode ser um alert ou modal mais completo).
         * @param {string} id O ID do pacote.
         */
        function visualizarUsosPacote(id) {
            const pacote = allPacotesAtivos.find(p => p.id === id);
            if (!pacote) return;
            
            const servico = getServico(pacote.servicoId);
            const clienteNome = getClienteName(pacote.clienteId);
            
            let message = `Detalhes do Pacote: ${servico.nome} (Cliente: ${clienteNome})\n`;
            message += `Início: ${formatDate(pacote.dataInicio)}, Vencimento: ${formatDate(pacote.dataVencimento)}\n`;
            message += `Total de Usos: ${servico.quantidadeTotal}, Usos Registrados: ${pacote.usos.length}\n\n`;
            
            if (pacote.usos.length === 0) {
                 message += 'Nenhum uso registrado ainda.';
            } else {
                 pacote.usos.forEach((uso, index) => {
                     message += `Uso ${index + 1}: Data: ${formatDate(uso.data)} às ${uso.hora} - ${uso.horaFim || ''}\n`;
                     if (uso.observacoes) message += `   Obs: ${uso.observacoes}\n`;
                 });
            }
            
            alert(message);
        }

        // ================= AGENDAMENTOS INDIVIDUAIS =================

        /**
         * Carrega agendamentos futuros (incluindo usos de pacote agendados)
         */
        async function carregarAgendamentos() {
            const tbody = document.getElementById('lista-agendamentos');
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Carregando agendamentos...</td></tr>';
            try {
                // Busca agendamentos individuais futuros (status: agendado)
                const dataFiltro = document.getElementById('filtro-agenda-data').value || today;
                
                let query = db.collection('agendamentos')
                    .where('data', '>=', dataFiltro)
                    .where('status', '==', 'agendado') // Apenas agendados (não cancelados/concluídos)
                    .orderBy('data')
                    .orderBy('hora');
                
                const snapshot = await query.get();
                
                // Inclui usos de pacote que ainda não foram concluídos/cancelados (simplesmente busca todos agendados por hora)
                // Implementação simplificada: no nosso caso, pacotesAtivos não geram "agendamentos" em uma coleção separada, 
                // mas sim no array "usos". Para simplificar, vou filtrar a lista que geramos no histórico (que é o que está sendo usado no final do agendamento)
                
                allAgendamentos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), tipo: 'individual' }));

                filtrarAgendamentos();
                
            } catch (e) {
                showNotification('Erro ao carregar agendamentos: ' + e.message, 'error');
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Erro ao carregar agendamentos.</td></tr>';
            }
        }
        
        /**
         * Aplica o filtro de cliente na lista de agendamentos e renderiza a tabela.
         */
        function filtrarAgendamentos() {
            const filtroClienteNome = document.getElementById('filtro-agenda-cliente').value.toLowerCase();
            const tbody = document.getElementById('lista-agendamentos');
            
            const agendamentosFiltrados = allAgendamentos.filter(a => {
                if (!filtroClienteNome) return true; // Sem filtro de cliente

                const clienteNome = getClienteName(a.clienteId).toLowerCase();
                return clienteNome.includes(filtroClienteNome);
            });

            tbody.innerHTML = '';
            if (agendamentosFiltrados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nenhum agendamento encontrado para o filtro.</td></tr>';
                return;
            }

            agendamentosFiltrados.forEach(agendamento => {
                const clienteNome = getClienteName(agendamento.clienteId);
                const servico = getServico(agendamento.servicoId);
                
                let statusClass = 'status-package-active';
                let statusText = 'Agendado';
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td data-label="Data/Hora">${formatDate(agendamento.data)} às ${agendamento.hora}</td>
                    <td data-label="Cliente">${clienteNome}</td>
                    <td data-label="Serviço">${servico ? servico.nome : 'Serviço Excluído'}</td>
                    <td data-label="Status"><span class="${statusClass}">${statusText}</span></td>
                    <td data-label="Ações" class="action-buttons">
                        <button class="btn-warning" onclick="editarAgendamento('${agendamento.id}')">
                            <span class="material-icons">edit</span> Editar
                        </button>
                        <button class="btn-success" onclick="concluirAgendamento('${agendamento.id}')">
                            <span class="material-icons">check</span> Concluir
                        </button>
                        <button class="btn-danger" onclick="cancelarAgendamento('${agendamento.id}')">
                            <span class="material-icons">cancel</span> Cancelar
                        </button>
                    </td>
                `;
            });
        }
        
        /**
         * Reseta os filtros da agenda e recarrega os agendamentos.
         */
        function resetFiltroAgenda() {
            document.getElementById('filtro-agenda-data').value = today;
            document.getElementById('filtro-agenda-cliente').value = '';
            carregarAgendamentos();
        }

        /**
         * Edita um agendamento preenchendo o formulário.
         * @param {string} id O ID do agendamento.
         */
        function editarAgendamento(id) {
            const agendamento = allAgendamentos.find(a => a.id === id);
            if (agendamento) {
                document.getElementById('agendamento-id').value = agendamento.id;
                document.getElementById('agenda-cliente-id').value = agendamento.clienteId;
                document.getElementById('agenda-servico-id').value = agendamento.servicoId;
                document.getElementById('agenda-data').value = agendamento.data;
                document.getElementById('agenda-hora').value = agendamento.hora;
                document.getElementById('agenda-hora-fim').value = agendamento.horaFim || '';
                document.getElementById('agenda-observacoes').value = agendamento.observacoes || '';
                
                document.getElementById('btn-salvar-agendamento').innerHTML = '<span class="material-icons">update</span> Atualizar Agendamento';
                
                showAgendaTab('novo-agendamento'); // Vai para a aba de edição
            }
        }
        
        /**
         * Limpa o formulário de agendamento.
         */
        function resetAgendamentoForm() {
            document.getElementById('agendamento-form').reset();
            document.getElementById('agendamento-id').value = '';
            document.getElementById('agenda-data').value = today;
            document.getElementById('btn-salvar-agendamento').innerHTML = '<span class="material-icons">save</span> Salvar Agendamento';
        }

        /**
         * Listener do formulário de agendamento individual.
         */
        document.getElementById('agendamento-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('agendamento-id').value;
            
            const clienteId = document.getElementById('agenda-cliente-id').value;
            const servicoId = document.getElementById('agenda-servico-id').value;
            const servico = getServico(servicoId);

            if (!servico) {
                showNotification('Selecione um serviço válido.', 'error');
                return;
            }

            const data = {
                clienteId: clienteId,
                servicoId: servicoId,
                data: document.getElementById('agenda-data').value,
                hora: document.getElementById('agenda-hora').value,
                horaFim: document.getElementById('agenda-hora-fim').value,
                observacoes: document.getElementById('agenda-observacoes').value,
                valor: servico.preco, // O valor é o preço do serviço
                status: 'agendado',
                tipo: 'individual',
                dataCriacao: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                if (id) {
                    await db.collection('agendamentos').doc(id).update(data);
                    showNotification('Agendamento atualizado com sucesso!', 'success');
                } else {
                    await db.collection('agendamentos').add(data);
                    showNotification('Agendamento salvo com sucesso!', 'success');
                }
                resetAgendamentoForm();
                // Volta para a lista de agendamentos
                showAgendaTab('lista-agendamentos'); 
            } catch (e) {
                showNotification('Erro ao salvar agendamento: ' + e.message, 'error');
            }
        });

        /**
         * Conclui um agendamento individual e o move para o histórico.
         * @param {string} id O ID do agendamento.
         */
        function concluirAgendamento(id) {
            if (confirm('Marcar este agendamento como CONCLUÍDO e movê-lo para o Histórico?')) {
                const agendamento = allAgendamentos.find(a => a.id === id);
                if (!agendamento) return;
                
                // Remove o agendamento da lista ativa
                db.collection('agendamentos').doc(id).delete()
                    .then(async () => {
                        // Adiciona no histórico
                        const registroHistorico = {
                             clienteId: agendamento.clienteId,
                             servicoId: agendamento.servicoId,
                             tipoRegistro: 'agendamentoConcluido',
                             valor: agendamento.valor,
                             data: agendamento.data,
                             hora: agendamento.hora,
                             observacoes: agendamento.observacoes || 'Agendamento concluído.',
                             dataCriacao: firebase.firestore.FieldValue.serverTimestamp()
                        };
                        await db.collection('historico').add(registroHistorico);
                        
                        showNotification('Agendamento concluído e registrado no histórico!', 'success');
                        carregarAgendamentos();
                    })
                    .catch(e => {
                        showNotification('Erro ao concluir agendamento: ' + e.message, 'error');
                    });
            }
        }
        
        /**
         * Cancela um agendamento (apenas remove da lista ativa).
         * @param {string} id O ID do agendamento.
         */
        function cancelarAgendamento(id) {
            if (confirm('Tem certeza que deseja CANCELAR este agendamento?')) {
                db.collection('agendamentos').doc(id).delete()
                    .then(() => {
                        showNotification('Agendamento cancelado!', 'info');
                        carregarAgendamentos();
                    })
                    .catch(e => {
                        showNotification('Erro ao cancelar agendamento: ' + e.message, 'error');
                    });
            }
        }

        // ================= VISÃO DIÁRIA =================

        /**
         * Gera a lista de horários e a tabela da visão diária.
         */
        async function renderizarVisaoDiaria(dataParam = null) {
            const dataSelecionada = dataParam || document.getElementById('filtro-visao-diaria-data').value || today;
            document.getElementById('filtro-visao-diaria-data').value = dataSelecionada; // Garante que o input reflita
            
            const tbody = document.getElementById('lista-visao-diaria');
            tbody.innerHTML = '<tr><td colspan="2" style="text-align: center;">Carregando visão diária...</td></tr>';
            
            // 1. Obter agendamentos para a data selecionada
            const agendamentosDia = await getAgendamentosPorData(dataSelecionada);
            
            // 2. Obter usos de pacote para a data selecionada (simplesmente filtra o array local de pacotes ativos)
            const usosPacoteDia = getUsosPacotePorData(dataSelecionada);

            // Combina agendamentos e usos de pacote em uma única lista de eventos
            const todosEventos = [
                ...agendamentosDia.map(a => ({
                    id: a.id,
                    hora: a.hora,
                    horaFim: a.horaFim || '',
                    clienteId: a.clienteId,
                    servicoId: a.servicoId,
                    observacoes: a.observacoes || '',
                    tipo: a.tipo, // 'individual'
                    docRef: 'agendamentos',
                    valor: a.valor
                })),
                ...usosPacoteDia.map(u => {
                    const pacote = allPacotesAtivos.find(p => p.usos.includes(u));
                    const servico = getServico(u.servicoId);
                    return {
                        id: pacote.id,
                        hora: u.hora,
                        horaFim: u.horaFim || '',
                        clienteId: pacote.clienteId,
                        servicoId: u.servicoId,
                        observacoes: u.observacoes || '',
                        tipo: 'usoPacote',
                        docRef: 'pacotesAtivos',
                        valor: servico.preco
                    };
                })
            ].sort((a, b) => a.hora.localeCompare(b.hora)); // Ordena por hora
            
            // 3. Gerar a tabela
            const horas = gerarIntervalosDeTempo(7, 22, 30); // De 7:00 a 22:00, intervalos de 30 minutos

            tbody.innerHTML = '';
            horas.forEach(hora => {
                const row = tbody.insertRow();
                row.innerHTML = `<td class="horario-celula">${hora}</td><td class="agendamento-vago">VAGO</td>`;
                
                // Verifica se há algum evento que começa ou está em andamento neste intervalo
                const evento = todosEventos.find(e => 
                    e.hora === hora || (e.hora < hora && e.horaFim > hora)
                );

                if (evento) {
                    const servico = getServico(evento.servicoId);
                    const clienteNome = getClienteName(evento.clienteId);
                    const servicoNome = servico ? servico.nome : 'Serviço Excluído';
                    
                    const cell = row.cells[1];
                    cell.className = 'agendamento-ocupado';
                    cell.innerHTML = `
                        <strong>${clienteNome}</strong> - ${servicoNome}
                        <br>
                        ${evento.hora} - ${evento.horaFim} ${evento.tipo === 'usoPacote' ? '(Pacote)' : ''}
                        ${evento.observacoes ? `<br>Obs: ${evento.observacoes}` : ''}
                    `;
                    cell.onclick = () => {
                         if (evento.tipo === 'individual') {
                              editarAgendamento(evento.id);
                         } else if (evento.tipo === 'usoPacote') {
                              visualizarUsosPacote(evento.id);
                         }
                    };
                }
            });
            
            if (horas.length === 0) {
                 tbody.innerHTML = '<tr><td colspan="2" style="text-align: center;">Não foi possível gerar a agenda.</td></tr>';
            }
        }
        
        /**
         * Busca agendamentos individuais para uma data específica.
         * @param {string} dataString A data YYYY-MM-DD.
         */
        async function getAgendamentosPorData(dataString) {
             try {
                  const snapshot = await db.collection('agendamentos')
                     .where('data', '==', dataString)
                     .where('status', '==', 'agendado')
                     .get();
                  return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
             } catch (e) {
                  console.error('Erro ao buscar agendamentos por data:', e);
                  return [];
             }
        }
        
        /**
         * Filtra usos de pacote para uma data específica.
         * @param {string} dataString A data YYYY-MM-DD.
         */
        function getUsosPacotePorData(dataString) {
            let usosDoDia = [];
            allPacotesAtivos.forEach(pacote => {
                pacote.usos.forEach(uso => {
                    if (uso.data === dataString) {
                        usosDoDia.push(uso);
                    }
                });
            });
            return usosDoDia;
        }

        /**
         * Gera uma lista de strings de tempo (ex: "07:00", "07:30").
         * @param {number} startHour Hora de início (0 a 23).
         * @param {number} endHour Hora de fim (0 a 23).
         * @param {number} intervalMinutes Intervalo em minutos (ex: 30).
         * @returns {Array<string>} Lista de horários.
         */
        function gerarIntervalosDeTempo(startHour, endHour, intervalMinutes) {
            const times = [];
            let current = new Date();
            current.setHours(startHour, 0, 0, 0);
            
            const end = new Date();
            end.setHours(endHour, 0, 0, 0);

            while (current <= end) {
                const hour = String(current.getHours()).padStart(2, '0');
                const minute = String(current.getMinutes()).padStart(2, '0');
                times.push(`${hour}:${minute}`);
                current.setMinutes(current.getMinutes() + intervalMinutes);
            }
            return times;
        }


        // ----------------------------------------------------------------------------------
        // HISTÓRICO
        // ----------------------------------------------------------------------------------

        /**
         * Carrega todos os registros do histórico (agendamentos concluídos e pacotes finalizados/usos).
         */
        async function carregarHistorico() {
            const tbody = document.getElementById('lista-historico');
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Carregando histórico...</td></tr>';
            try {
                // Busca todos os registros de histórico
                let query = db.collection('historico').orderBy('data', 'desc').limit(200); // Limita para performance
                
                const snapshot = await query.get();
                allHistorico = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Inclui todos os pacotes finalizados (apenas para fins de histórico de vendas)
                const pacotesFinalizadosSnapshot = await db.collection('pacotesAtivos')
                    .where('status', '==', 'finalizado')
                    .get();
                
                pacotesFinalizadosSnapshot.docs.forEach(doc => {
                    const pacote = doc.data();
                    const servico = getServico(pacote.servicoId);
                    
                    // Adiciona o registro de venda do pacote (se não já estiver no histórico)
                    const isAlreadyInHistory = allHistorico.some(h => 
                         h.tipoRegistro === 'vendaPacote' && h.dataCriacao && 
                         h.dataCriacao.seconds === pacote.dataCriacao.seconds // Simples checagem de duplicidade
                    );
                    
                    if (!isAlreadyInHistory && servico) {
                         allHistorico.push({
                              id: doc.id,
                              clienteId: pacote.clienteId,
                              servicoId: pacote.servicoId,
                              tipoRegistro: 'vendaPacote',
                              valor: pacote.valorTotal,
                              data: pacote.dataInicio,
                              hora: '00:00',
                              observacoes: `Venda do Pacote: ${servico.nome} - Finalizado em ${formatDate(pacote.dataFinalizacao)}`,
                              dataCriacao: pacote.dataCriacao
                         });
                    }
                });


                filtrarHistorico(); // Chama o filtro para renderizar a lista
            } catch (e) {
                showNotification('Erro ao carregar histórico: ' + e.message, 'error');
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Erro ao carregar histórico.</td></tr>';
            }
        }
        
        /**
         * Aplica o filtro na lista de histórico e renderiza a tabela.
         */
        function filtrarHistorico() {
            const filtroMesAno = document.getElementById('filtro-historico-mes').value; // YYYY-MM
            const filtroClienteNome = document.getElementById('filtro-historico-cliente').value.toLowerCase();
            const tbody = document.getElementById('lista-historico');
            let lucroTotal = 0;
            
            // Atualiza o texto do filtro
            if (filtroMesAno) {
                const [year, month] = filtroMesAno.split('-');
                document.getElementById('historico-mes-ano').textContent = `${month}/${year}`;
            } else {
                 document.getElementById('historico-mes-ano').textContent = 'Todos os Registros';
            }

            const historicoFiltrado = allHistorico.filter(h => {
                const dataRegistro = h.data; // YYYY-MM-DD
                
                // Filtro por Mês/Ano
                if (filtroMesAno && !dataRegistro.startsWith(filtroMesAno)) {
                    return false;
                }
                
                // Filtro por Cliente
                if (filtroClienteNome) {
                    const clienteNome = getClienteName(h.clienteId).toLowerCase();
                    if (!clienteNome.includes(filtroClienteNome)) {
                        return false;
                    }
                }
                
                return true;
            }).sort((a, b) => b.data.localeCompare(a.data)); // Ordena por data decrescente

            tbody.innerHTML = '';
            if (historicoFiltrado.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nenhum registro encontrado para o filtro.</td></tr>';
                document.getElementById('lucro-total-span').textContent = formatCurrency(0);
                return;
            }
            
            historicoFiltrado.forEach(registro => {
                const clienteNome = getClienteName(registro.clienteId);
                const servico = getServico(registro.servicoId);
                
                let tipoLabel = '';
                let valor = registro.valor || 0;
                
                if (registro.tipoRegistro === 'usoPacote') {
                    tipoLabel = `<span class="status-package-pending">Uso de Pacote (${servico ? servico.nome : 'Serviço Excluído'})</span>`;
                    valor = 0;
                } else if (registro.tipoRegistro === 'vendaPacote') {
                    tipoLabel = `<span class="status-package-paid">Venda de Pacote (${servico ? servico.nome : 'Serviço Excluído'})</span>`;
                    lucroTotal += valor;
                } else if (registro.tipoRegistro === 'agendamentoConcluido') {
                    tipoLabel = `<span class="status-package-active">Serviço Individual (${servico ? servico.nome : 'Serviço Excluído'})</span>`;
                    lucroTotal += valor;
                }
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td data-label="Data">${formatDate(registro.data)} ${registro.hora}</td>
                    <td data-label="Cliente">${clienteNome}</td>
                    <td data-label="Serviço">${tipoLabel}</td>
                    <td data-label="Valor">${formatCurrency(valor)}</td>
                    <td data-label="Ações" class="action-buttons">
                        <button class="btn-danger" onclick="excluirRegistroHistorico('${registro.id}', '${registro.tipoRegistro}')">
                            <span class="material-icons">delete</span> Excluir
                        </button>
                    </td>
                `;
            });
            
            document.getElementById('lucro-total-span').textContent = formatCurrency(lucroTotal);
        }
        
        /**
         * Reseta os filtros do histórico e recarrega.
         */
        function resetFiltroHistorico() {
            document.getElementById('filtro-historico-mes').value = '';
            document.getElementById('filtro-historico-cliente').value = '';
            carregarHistorico();
        }
        
        /**
         * Exclui um registro do histórico (com confirmação).
         * @param {string} id O ID do documento no histórico.
         * @param {string} tipo O tipo de registro (para informação).
         */
        function excluirRegistroHistorico(id, tipo) {
            if (confirm(`Tem certeza que deseja EXCLUIR este registro de ${tipo}?`)) {
                db.collection('historico').doc(id).delete()
                    .then(() => {
                        showNotification('Registro excluído do histórico!', 'success');
                        carregarHistorico();
                    })
                    .catch(e => {
                        showNotification('Erro ao excluir registro: ' + e.message, 'error');
                    });
            }
        }


        // ----------------------------------------------------------------------------------
        // LOGIN/LOGOUT
        // ----------------------------------------------------------------------------------

        function showLogin() {
            document.getElementById('app-container').style.display = 'none';
            document.getElementById('login-container').style.display = 'flex';
        }
        
        function showApp() {
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('app-container').style.display = 'flex';
            // Carrega os dados iniciais do app
            showSection('agenda-section');
        }
        
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const senha = document.getElementById('loginSenha').value;
            
            if (senha === senhaAcesso) {
                 showApp();
                 showNotification('Login realizado com sucesso!', 'success');
            } else {
                 showNotification('Senha incorreta. Tente novamente.', 'error');
            }
        });
        
        document.getElementById('logout-button').addEventListener('click', () => {
            showLogin();
            showNotification('Sessão encerrada.', 'info');
        });


        // ----------------------------------------------------------------------------------
        // INICIALIZAÇÃO
        // ----------------------------------------------------------------------------------
        document.addEventListener('DOMContentLoaded', () => {
             // Configura os listeners de navegação
             document.querySelectorAll('.sidebar ul li a').forEach(link => {
                 link.addEventListener('click', (e) => {
                      e.preventDefault();
                      showSection(e.target.closest('a').dataset.section + '-section');
                 });
             });
             
             // Define a data de hoje nos inputs de data padrão
             document.getElementById('pacote-data-inicio').value = hoje;
             document.getElementById('agenda-data').value = hoje;
             document.getElementById('utilizacao-data').value = hoje;
             
             // Mostra a tela de login ao carregar a página
            showLogin();
        });
    </script>
</body>
</html>
